<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Canlı Kayıp Takibi</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="icon" type="image/png" sizes="192x192" href="/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'], mono: ['"JetBrains Mono"', 'monospace'] },
                extend: { 
                    colors: { brand: { 500: '#ef4444' } },
                    animation: { 'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: white; -webkit-tap-highlight-color: transparent; }
        .glass-dark { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .counter-glow { text-shadow: 0 0 30px rgba(239, 68, 68, 0.6); }
        .counter-stopped { color: #64748b; text-shadow: none; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden relative">

    <div class="z-10 px-6 pt-8 pb-4 flex justify-between items-start">
        <div>
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i data-lucide="zap" class="w-5 h-5 text-red-500 fill-red-500"></i> Optimizi
            </h1>
            <p id="clientName" class="text-xs text-slate-400 mt-1">Yükleniyor...</p>
        </div>
        
        <div id="statusBadge" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-800 border border-slate-700">
            <span class="relative flex h-2 w-2">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-500 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
            </span>
            <span class="text-[10px] font-bold text-slate-300">CANLI</span>
        </div>
    </div>

    <div class="flex-1 flex flex-col items-center justify-center text-center px-4 z-10 -mt-10">
        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em] mb-4">TOPLAM OPERASYONEL KAYIP</p>
        
        <div class="relative">
            <div id="counter" class="text-[14vw] leading-none font-mono font-bold text-white tracking-tight tabular-nums counter-glow">
                0.0000
            </div>
            <div class="absolute -right-6 top-0 text-xl font-bold text-red-500 translate-x-full">TL</div>
        </div>

        <div class="mt-8 flex items-center gap-3 px-4 py-2 rounded-xl bg-white/5 border border-white/5 backdrop-blur-sm">
            <div class="bg-red-500/10 p-1.5 rounded-lg"><i data-lucide="gauge" class="w-4 h-4 text-red-500"></i></div>
            <div class="text-left">
                <p class="text-[9px] text-slate-400 uppercase font-bold">Kayıp Hızı</p>
                <p class="text-sm font-bold text-white"><span id="perMinute">0.00</span> TL / Dk</p>
            </div>
        </div>
    </div>

    <div class="p-4 pb-8 z-10">
        <div class="glass-dark rounded-2xl p-5 space-y-4">
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p class="text-[9px] text-slate-500 uppercase font-bold mb-0.5">Yakıt Tipi</p>
                    <p id="fuelDisplay" class="text-xs font-bold text-slate-200">...</p>
                </div>
                <div class="text-right">
                    <p class="text-[9px] text-slate-500 uppercase font-bold mb-0.5">Yıllık Kota</p>
                    <p id="hoursDisplay" class="text-xs font-bold text-slate-200">... Saat</p>
                </div>
            </div>

            <div>
                <div class="flex justify-between text-[9px] text-slate-500 font-bold mb-1">
                    <span>KOTA DOLULUĞU</span>
                    <span id="percentText">0%</span>
                </div>
                <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                    <div id="progressBar" class="h-full bg-red-600 w-0 transition-all duration-1000"></div>
                </div>
            </div>

            <div class="flex gap-2 text-[10px] text-slate-400 bg-slate-900/50 p-3 rounded-lg border border-white/5 leading-relaxed">
                <i data-lucide="info" class="w-3 h-3 text-blue-500 mt-0.5 shrink-0"></i>
                <p>
                    <strong>Sistem Durumu:</strong> Sayaç 7/24 aktif çalışma prensibine göre işler. 
                    Tanımlanan yıllık <span id="infoLimit" class="text-white font-bold">...</span> saatlik kota dolduğunda 
                    otomatik olarak duracaktır.
                </p>
            </div>
        </div>
    </div>

    <div id="loader" class="fixed inset-0 z-50 bg-[#0f172a] flex items-center justify-center">
        <div class="w-10 h-10 border-4 border-red-500/20 border-t-red-500 rounded-full animate-spin"></div>
    </div>

    <script>
        lucide.createIcons();

        // SUPABASE
        const SUPABASE_URL = 'https://gktvludkrsxnpigydqml.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdHZsdWRrcnN4bnBpZ3lkcW1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTI5OTQsImV4cCI6MjA4NjEyODk5NH0.GE9KbO7dx_W7BYihAzvJl744R317xEA8Ars98UW-VWo';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let totalSecondsLimit = 0;
        let burnPerSecond = 0;
        let startTimestamp = 0;

        async function init() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');

            if (!id) return;

            const { data, error } = await supabase.from('simulations').select('*').eq('id', id).single();
            if (error || !data) return;

            // UI Doldurma
            document.getElementById('clientName').innerText = data.client_name;
            
            const fuels = { 'gas': 'Doğalgaz', 'elec': 'Elektrik', 'lng': 'LNG', 'fueloil': 'Fuel Oil', 'coal_imp': 'İthal Kömür', 'coal_loc': 'Yerli Kömür', 'manual': data.fuel_label || 'Özel' };
            document.getElementById('fuelDisplay').innerText = fuels[data.fuel_type] || data.fuel_type;
            
            document.getElementById('hoursDisplay').innerText = data.work_hours.toLocaleString() + ' Saat';
            document.getElementById('infoLimit').innerText = data.work_hours.toLocaleString();

            // Hesaplama Temeli
            totalSecondsLimit = data.work_hours * 3600; // Saati saniyeye çevir (Kota)
            burnPerSecond = data.total_annual_loss / totalSecondsLimit;
            startTimestamp = new Date(data.start_date).getTime();

            // Dakikalık Hız
            document.getElementById('perMinute').innerText = (burnPerSecond * 60).toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2});

            // Başlat
            document.getElementById('loader').style.display = 'none';
            loop();
        }

        function loop() {
            const now = Date.now();
            let elapsed = (now - startTimestamp) / 1000;

            // KOTA KONTROLÜ (DURMA NOKTASI)
            if (elapsed >= totalSecondsLimit) {
                elapsed = totalSecondsLimit; // Max sınıra sabitle
                showStoppedState();
            } else {
                requestAnimationFrame(loop);
            }

            if(elapsed < 0) elapsed = 0;

            // Ekrana Yaz
            const currentVal = elapsed * burnPerSecond;
            document.getElementById('counter').innerText = currentVal.toLocaleString('tr-TR', {
                minimumFractionDigits: 4, maximumFractionDigits: 4
            });

            // Progress
            const percent = (elapsed / totalSecondsLimit) * 100;
            document.getElementById('progressBar').style.width = Math.min(percent, 100) + '%';
            document.getElementById('percentText').innerText = Math.min(percent, 100).toFixed(1) + '%';
        }

        function showStoppedState() {
            const badge = document.getElementById('statusBadge');
            badge.className = "flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-700 border border-slate-600";
            badge.innerHTML = '<div class="w-2 h-2 bg-slate-400 rounded-full"></div><span class="text-[10px] font-bold text-slate-300">SAYAÇ DURDU</span>';
            
            const ctr = document.getElementById('counter');
            ctr.classList.remove('counter-glow');
            ctr.classList.add('counter-stopped');
        }

        init();
    </script>
</body>
</html>
