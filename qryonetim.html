<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimizi QR Yönetimi</title>
    <link rel="icon" href="favicon.png" type="image/png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                fontFamily: { sans: ['"Inter"', 'sans-serif'], mono: ['"JetBrains Mono"', 'monospace'] },
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a', 950: '#020617' },
                        brand: { 500: '#ef4444', 600: '#dc2626' } // Optimizi Kırmızısı
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #020617; 
            color: #e2e8f0;
            background-image: 
                radial-gradient(circle at 50% 0%, #1e293b 0%, transparent 70%),
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px), 
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            min-height: 100vh;
        }
        
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .input-dark {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.2s ease;
        }
        .input-dark:focus {
            background: rgba(30, 41, 59, 0.8);
            border-color: #ef4444;
            outline: none;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
        }
        
        /* Animasyon */
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.4s ease-out forwards; }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <div class="w-full max-w-xl animate-slide-up">
        
        <div class="flex items-center justify-between mb-6 px-2">
            <div>
                <h1 class="text-xl font-bold tracking-tight text-white">Optimizi<span class="text-brand-500">.QR Yönetimi</span></h1>
                <p class="text-[10px] font-medium text-slate-500 uppercase tracking-widest mt-0.5">Link Tabanlı Sistem</p>
            </div>
            <div class="bg-slate-800/50 p-2 rounded-xl border border-white/5">
                <i data-lucide="link" class="w-5 h-5 text-brand-500"></i>
            </div>
        </div>

        <div class="glass-panel rounded-3xl p-6 sm:p-8 relative overflow-hidden">
            
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-brand-500 to-transparent opacity-50"></div>

            <div class="space-y-5">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 block ml-1">Müşteri</label>
                        <input type="text" id="client" placeholder="ABC Tesisleri" 
                            class="input-dark w-full rounded-xl px-3 py-2.5 text-xs font-bold placeholder-slate-600">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 block ml-1">Rapor No</label>
                        <input type="text" id="serial" value="LSS-001" 
                            class="input-dark w-full rounded-xl px-3 py-2.5 text-xs font-bold placeholder-slate-600">
                    </div>
                </div>

                <div class="bg-slate-800/40 rounded-2xl p-5 border border-slate-700/50 group focus-within:border-brand-500/30 transition-colors">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="trending-down" class="w-4 h-4 text-brand-500"></i>
                        <label class="text-[10px] font-bold text-brand-500 uppercase tracking-wider">Toplam Yıllık Kayıp</label>
                    </div>
                    <div class="relative">
                        <input type="text" id="totalValue" oninput="calculatePreview()" placeholder="500000"
                            class="w-full bg-transparent border-none p-0 text-3xl font-mono font-bold text-white placeholder-slate-700 focus:ring-0 outline-none">
                        <span class="absolute right-0 top-1/2 -translate-y-1/2 text-xs font-bold text-slate-500 bg-slate-900/50 px-2 py-1 rounded">TL/Yıl</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 block ml-1">Yıllık Kota (Saat)</label>
                        <input type="number" id="workHours" oninput="calculatePreview()" value="4800"
                            class="input-dark w-full rounded-xl px-3 py-2.5 text-sm font-bold font-mono">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 block ml-1">Birim Fiyat</label>
                        <input type="number" id="unitPrice" placeholder="16.00" step="0.01"
                            class="input-dark w-full rounded-xl px-3 py-2.5 text-sm font-bold font-mono">
                    </div>
                </div>

                <div id="previewCard" class="hidden flex items-center justify-between p-3 bg-brand-500/10 rounded-xl border border-brand-500/20 transition-all">
                    <div>
                        <p class="text-[9px] font-bold text-brand-500 uppercase tracking-wide">CANLI KAYIP HIZI</p>
                        <div class="flex items-baseline gap-1">
                            <span id="previewMin" class="text-lg font-bold text-white font-mono">0.00</span>
                            <span class="text-[10px] font-medium text-slate-400">TL / Dk</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">Saatlik</p>
                        <span id="previewHour" class="text-xs font-bold text-slate-300 font-mono">0.00 TL</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 block ml-1">Yakıt Tipi</label>
                        <select id="fuel" onchange="toggleManualFuel()" 
                            class="input-dark w-full rounded-xl px-3 py-2.5 text-xs font-bold cursor-pointer appearance-none">
                            <option value="gas">Doğalgaz (m³)</option>
                            <option value="elec">Elektrik (kWh)</option>
                            <option value="lng">LNG (kg)</option>
                            <option value="fueloil">Fuel Oil (kg)</option>
                            <option value="coal_imp">İthal Kömür</option>
                            <option value="coal_loc">Yerli Kömür</option>
                            <option value="manual" class="text-brand-500">⚡ Manuel / Özel</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 block ml-1">Başlangıç Tarihi</label>
                        <input type="date" id="installDate" 
                            class="input-dark w-full rounded-xl px-2 py-2.5 text-xs font-bold text-center">
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 block ml-1">Başlangıç Saati</label>
                    <input type="time" id="installTime" 
                        class="input-dark w-full rounded-xl px-2 py-2.5 text-xs font-bold text-center">
                </div>

                <div id="manualFuelFields" class="hidden bg-slate-800/50 p-3 rounded-xl border border-dashed border-slate-700 grid grid-cols-2 gap-2">
                    <div class="col-span-2">
                        <label class="text-[9px] font-bold text-slate-400 uppercase">Özel Yakıt Adı</label>
                        <input type="text" id="customFuelLabel" placeholder="Örn: Paçal Kömür" class="input-dark w-full rounded-lg px-2 py-1.5 text-xs">
                    </div>
                    <div>
                        <label class="text-[9px] font-bold text-slate-400 uppercase">Kalori</label>
                        <input type="number" id="customFuelLhv" placeholder="4500" class="input-dark w-full rounded-lg px-2 py-1.5 text-xs">
                    </div>
                    <div>
                        <label class="text-[9px] font-bold text-slate-400 uppercase">CO2</label>
                        <input type="number" id="customFuelCo2" placeholder="0.36" step="0.001" class="input-dark w-full rounded-lg px-2 py-1.5 text-xs">
                    </div>
                    <input type="hidden" id="customFuelUnit" value="kg">
                </div>

                <button onclick="generateQR()" class="w-full bg-brand-600 hover:bg-brand-500 text-white p-4 rounded-xl font-bold text-sm shadow-lg shadow-brand-900/20 transition-all transform active:scale-[0.98] flex items-center justify-center gap-2 mt-4 group">
                    <i data-lucide="qr-code" class="w-4 h-4 transition group-hover:scale-110"></i>
                    QR Link Oluştur
                </button>

            </div>
        </div>

        <div id="resultCard" class="hidden mt-6 glass-panel rounded-3xl p-6 text-center animate-slide-up border-t-2 border-brand-500/50">
            <p class="text-xs font-bold text-slate-400 uppercase mb-4">Takip Sistemi Hazır</p>
            
            <div class="bg-white p-3 rounded-xl inline-block shadow-xl mb-4">
                <div id="qrcode"></div>
            </div>
            
            <div class="bg-slate-900/50 p-3 rounded-xl mb-4 border border-white/5">
                <code id="linkText" class="text-[9px] text-slate-400 break-all font-mono select-all">...</code>
            </div>
            
            <a id="downloadBtn" download="optimizi_qr.png" href="#" class="inline-flex items-center gap-2 bg-white text-slate-900 px-5 py-2.5 rounded-xl text-xs font-bold hover:bg-slate-200 transition">
                <i data-lucide="download" class="w-3 h-3"></i> QR İndir
            </a>
        </div>

    </div>

    <script>
        lucide.createIcons();
        const now = new Date();
        document.getElementById('installDate').valueAsDate = now;
        
        const hh = String(now.getHours()).padStart(2, '0');
        const mm = String(now.getMinutes()).padStart(2, '0');
        document.getElementById('installTime').value = `${hh}:${mm}`;

        // --- MATEMATİK & MANTIK (Aynen Korundu) ---
        function calculatePreview() {
            let rawVal = document.getElementById('totalValue').value;
            rawVal = rawVal.replace(/\./g, '').replace(',', '.');
            const totalVal = parseFloat(rawVal);
            const wHours = parseFloat(document.getElementById('workHours').value);
            const previewCard = document.getElementById('previewCard');

            if (totalVal > 0 && wHours > 0) {
                const hourlyLoss = totalVal / wHours;
                const minutelyLoss = hourlyLoss / 60;
                
                document.getElementById('previewHour').innerText = hourlyLoss.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' TL';
                document.getElementById('previewMin').innerText = minutelyLoss.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                
                previewCard.classList.remove('hidden');
            } else {
                previewCard.classList.add('hidden');
            }
        }

        function toggleManualFuel() {
            const fuelSelect = document.getElementById('fuel').value;
            const manualFields = document.getElementById('manualFuelFields');
            if(fuelSelect === 'manual') {
                manualFields.classList.remove('hidden');
                document.getElementById('customFuelLabel').value = "Paçal Kömür";
                document.getElementById('customFuelCo2').value = "0.36";
                document.getElementById('customFuelLhv').value = ""; 
            } else {
                manualFields.classList.add('hidden');
            }
        }

        function generateQR() {
            const client = document.getElementById('client').value.trim();
            const serial = document.getElementById('serial').value.trim();
            let rawVal = document.getElementById('totalValue').value;
            const uPrice = document.getElementById('unitPrice').value;
            const wHours = document.getElementById('workHours').value;
            const fuel = document.getElementById('fuel').value;
            
            const dateStr = document.getElementById('installDate').value; 
            const timeStr = document.getElementById('installTime').value; 
            
            // Tarih formatlama (Linkteki sistemin aynısı)
            const fullDateTime = `${dateStr}-${timeStr.replace(':', '-')}`; 

            rawVal = rawVal.replace(/\./g, '').replace(',', '.');
            const totalVal = parseFloat(rawVal);

            if(!totalVal || !uPrice) { alert("Lütfen kayıp tutarını ve birim fiyatı giriniz."); return; }

            // Ön Hesaplama: Saniyelik Yanma Hızı (Burn Per Second)
            // Takip sistemi bunu kullanırsa 8760 saat yerine gerçek çalışma saatini baz alır.
            const secondsInWorkYear = wHours * 3600;
            const burnPerSecond = totalVal / secondsInWorkYear;

            const baseUrl = "https://optimizi.app/track.html";
            // bps (Burn Per Second) parametresi eklendi.
            let finalUrl = `${baseUrl}?c=${encodeURIComponent(client)}&s=${encodeURIComponent(serial)}&v=${totalVal}&up=${uPrice}&wh=${wHours}&f=${fuel}&d=${fullDateTime}&bps=${burnPerSecond.toFixed(6)}`;

            if(fuel === 'manual') {
                let cLabel = document.getElementById('customFuelLabel').value || 'Paçal Kömür';
                const cUnit = document.getElementById('customFuelUnit').value || 'kg';
                const cCo2 = document.getElementById('customFuelCo2').value || '0.36';
                const cLhv = document.getElementById('customFuelLhv').value;

                if(cLhv) { cLabel += ` (${cLhv} kcal)`; }
                
                finalUrl += `&fl=${encodeURIComponent(cLabel)}&fu=${encodeURIComponent(cUnit)}&fc=${encodeURIComponent(cCo2)}`;
            }

            const resultCard = document.getElementById('resultCard');
            resultCard.classList.remove('hidden');

            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';

            // QR Kodun görünür olduğundan emin ol ve çiz
            new QRCode(qrContainer, { 
                text: finalUrl, 
                width: 160, 
                height: 160, 
                colorDark : "#0f172a", 
                colorLight : "#ffffff", 
                correctLevel : QRCode.CorrectLevel.M 
            });

            document.getElementById('linkText').innerText = finalUrl;
            
            setTimeout(() => { 
                const img = qrContainer.querySelector("img");
                if(img) document.getElementById('downloadBtn').href = img.src; 
            }, 150);
            
            // Sonuca kaydır
            resultCard.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
