<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimizi QR Yönetimi</title>
    <link rel="icon" href="favicon.png" type="image/png">

 <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/auth-guard.js"></script>
    
    <style>
      body:not(.auth-checked) {
        opacity: 0;
        visibility: hidden;
      }
      body.auth-checked {
        opacity: 1;
        visibility: visible;
        transition: opacity 0.3s ease;
      }
    </style>
    <script>
      setTimeout(function(){ if(document.body) document.body.classList.add('auth-checked'); }, 500);
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="/auth-guard.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a', 950: '#020617' },
                        brand: { 50: '#fef2f2', 100: '#fee2e2', 500: '#ef4444', 600: '#dc2626', 900: '#7f1d1d' }
                    },
                    animation: { 'scale-in': 'scaleIn 0.3s ease-out' },
                    keyframes: { scaleIn: { '0%': { transform: 'scale(0.9)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } } }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #020617; 
            color: #e2e8f0;
            background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, transparent 70%), linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            min-height: 100vh;
        }
        
        .glass-panel {
            background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* Modern Input - XP Görünümü Yok */
        .input-dark {
            background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(255, 255, 255, 0.1); color: white; transition: all 0.2s ease;
            color-scheme: dark; outline: none;
        }
        .input-dark:focus { background: rgba(30, 41, 59, 0.9); border-color: #ef4444; box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.15); }
        
        /* Modal Backdrop */
        .modal-backdrop { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <div class="w-full max-w-xl animate-[scale-in_0.4s_ease-out]">
        
        <div class="flex items-center justify-between mb-6 px-2">
            <div>
                <h1 class="text-2xl font-black tracking-tight text-white">Optimizi<span class="text-brand-500">.QR</span></h1>
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em] mt-0.5">Yönetim Paneli</p>
            </div>
            <div class="bg-slate-800/80 p-2.5 rounded-xl border border-white/5 shadow-lg">
                <i data-lucide="qr-code" class="w-5 h-5 text-brand-500"></i>
            </div>
        </div>

        <div class="glass-panel rounded-3xl p-6 sm:p-8 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-brand-500 to-transparent opacity-50"></div>

            <div class="space-y-5">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block ml-1">Müşteri</label>
                        <input type="text" id="client" placeholder="Firma Adı" class="input-dark w-full rounded-xl px-3 py-3 text-xs font-bold placeholder-slate-600">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block ml-1">Rapor No</label>
                        <input type="text" id="serial" value="LSS-001" class="input-dark w-full rounded-xl px-3 py-3 text-xs font-bold placeholder-slate-600">
                    </div>
                </div>

                <div class="bg-slate-900/60 rounded-2xl p-5 border border-slate-700/50 group focus-within:border-brand-500/50 transition-colors relative">
                    <div class="absolute right-4 top-4 opacity-10"><i data-lucide="trending-down" class="w-8 h-8 text-brand-500"></i></div>
                    <label class="text-[10px] font-bold text-brand-500 uppercase tracking-wider mb-1 block">Toplam Yıllık Kayıp</label>
                    <div class="relative">
                        <input type="text" id="totalValue" oninput="calculatePreview()" placeholder="0" class="w-full bg-transparent border-none p-0 text-3xl font-mono font-bold text-white placeholder-slate-700 focus:ring-0 outline-none">
                        <span class="absolute right-0 bottom-1 text-xs font-bold text-slate-500">TL/Yıl</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block ml-1">Yıllık Kota (Saat)</label>
                        <input type="number" id="workHours" oninput="calculatePreview()" value="4800" class="input-dark w-full rounded-xl px-3 py-3 text-sm font-bold font-mono">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block ml-1">Birim Fiyat</label>
                        <input type="number" id="unitPrice" placeholder="0.00" step="0.01" class="input-dark w-full rounded-xl px-3 py-3 text-sm font-bold font-mono">
                    </div>
                </div>

                <div id="previewCard" class="hidden flex items-center justify-between p-3 bg-brand-500/10 rounded-xl border border-brand-500/20 transition-all">
                    <div>
                        <p class="text-[9px] font-bold text-brand-500 uppercase tracking-wide">CANLI KAYIP HIZI</p>
                        <div class="flex items-baseline gap-1">
                            <span id="previewMin" class="text-lg font-bold text-white font-mono">0.00</span>
                            <span class="text-[10px] font-medium text-slate-400">TL / Dk</span>
                        </div>
                    </div>
                    <div class="text-right opacity-60">
                        <p class="text-[9px] font-bold text-slate-500 uppercase">Saatlik</p>
                        <span id="previewHour" class="text-xs font-bold text-slate-300 font-mono">0.00 TL</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block ml-1">Yakıt Tipi</label>
                        <select id="fuel" onchange="toggleManualFuel()" class="input-dark w-full rounded-xl px-3 py-3 text-xs font-bold cursor-pointer appearance-none">
                            <option value="gas">Doğalgaz (m³)</option>
                            <option value="elec">Elektrik (kWh)</option>
                            <option value="lng">LNG (kg)</option>
                            <option value="fueloil">Fuel Oil (kg)</option>
                            <option value="coal_imp">İthal Kömür</option>
                            <option value="coal_loc">Yerli Kömür</option>
                            <option value="manual" class="text-brand-500 font-bold">⚡ Manuel / Özel</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block ml-1">Başlangıç Tarihi</label>
                        <input type="date" id="installDate" class="input-dark w-full rounded-xl px-3 py-3 text-xs font-bold text-center cursor-pointer">
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block ml-1">Başlangıç Saati</label>
                    <input type="time" id="installTime" class="input-dark w-full rounded-xl px-3 py-3 text-xs font-bold text-center tracking-widest cursor-pointer">
                </div>

                <div id="manualFuelFields" class="hidden bg-slate-900/40 p-4 rounded-xl border border-dashed border-slate-700 grid grid-cols-2 gap-3">
                    <div class="col-span-2">
                        <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Özel Yakıt Adı</label>
                        <input type="text" id="customFuelLabel" placeholder="Örn: Paçal Kömür" class="input-dark w-full rounded-lg px-3 py-2 text-xs">
                    </div>
                    <div>
                        <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Kalori</label>
                        <input type="number" id="customFuelLhv" placeholder="4500" class="input-dark w-full rounded-lg px-3 py-2 text-xs">
                    </div>
                    <div>
                        <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">CO2</label>
                        <input type="number" id="customFuelCo2" placeholder="0.36" step="0.001" class="input-dark w-full rounded-lg px-3 py-2 text-xs">
                    </div>
                    <input type="hidden" id="customFuelUnit" value="kg">
                </div>

                <button onclick="generateQR()" class="w-full bg-brand-600 hover:bg-brand-500 text-white p-4 rounded-xl font-bold text-sm shadow-lg shadow-brand-500/20 transition-all transform active:scale-[0.98] flex items-center justify-center gap-2 mt-2 group">
                    <i data-lucide="qr-code" class="w-4 h-4 transition group-hover:scale-110"></i>
                    Bağlantıyı Oluştur
                </button>

            </div>
        </div>

        <div id="resultCard" class="hidden mt-6 glass-panel rounded-3xl p-8 text-center animate-[scale-in_0.3s_ease-out] border-t-2 border-brand-500/50">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-6">Müşteri Takip Kodu Hazır</p>
            
            <div class="relative inline-block group">
                <div class="absolute -inset-1 bg-gradient-to-r from-brand-500 to-orange-500 rounded-2xl blur opacity-20 group-hover:opacity-40 transition duration-1000"></div>
                <div class="relative bg-white p-4 rounded-2xl shadow-2xl">
                    <div id="qrcode" class="relative">
                        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-lg border-2 border-slate-100 z-10">
                            <i data-lucide="flame" class="w-5 h-5 text-brand-500 fill-brand-500"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 bg-slate-900/50 p-3 rounded-xl border border-white/5 flex items-center justify-between gap-2">
                <code id="linkText" class="text-[10px] text-slate-400 truncate font-mono select-all w-full text-left">...</code>
                <button onclick="copyLink()" class="p-1.5 hover:bg-white/10 rounded-lg transition"><i data-lucide="copy" class="w-3 h-3 text-brand-500"></i></button>
            </div>
            
            <a id="downloadBtn" download="optimizi_qr.png" href="#" class="mt-4 w-full flex items-center justify-center gap-2 bg-white text-slate-900 px-4 py-3 rounded-xl text-xs font-bold hover:bg-slate-200 transition">
                <i data-lucide="download" class="w-4 h-4"></i> QR Görselini İndir
            </a>
        </div>

    </div>

    <div id="customModal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="absolute inset-0 modal-backdrop" onclick="closeModal()"></div>
        <div class="bg-slate-900 border border-slate-700 p-6 rounded-2xl relative z-10 w-80 text-center shadow-2xl transform scale-95 transition-all" id="modalContent">
            <div class="w-12 h-12 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="alert-circle" class="w-6 h-6 text-brand-500"></i>
            </div>
            <h3 class="text-white font-bold text-lg mb-2">Eksik Bilgi</h3>
            <p id="modalMessage" class="text-slate-400 text-sm mb-6">Lütfen tüm alanları doldurunuz.</p>
            <button onclick="closeModal()" class="w-full bg-slate-800 hover:bg-slate-700 text-white py-2.5 rounded-xl text-sm font-bold transition">Tamam</button>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const now = new Date();
        document.getElementById('installDate').valueAsDate = now;
        const hh = String(now.getHours()).padStart(2, '0');
        const mm = String(now.getMinutes()).padStart(2, '0');
        document.getElementById('installTime').value = `${hh}:${mm}`;

        function calculatePreview() {
            let rawVal = document.getElementById('totalValue').value.replace(/\./g, '').replace(',', '.');
            const totalVal = parseFloat(rawVal);
            const wHours = parseFloat(document.getElementById('workHours').value);
            const previewCard = document.getElementById('previewCard');

            if (totalVal > 0 && wHours > 0) {
                const hourlyLoss = totalVal / wHours;
                const minutelyLoss = hourlyLoss / 60;
                document.getElementById('previewHour').innerText = hourlyLoss.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' TL';
                document.getElementById('previewMin').innerText = minutelyLoss.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                previewCard.classList.remove('hidden');
            } else {
                previewCard.classList.add('hidden');
            }
        }

        function toggleManualFuel() {
            const fuelSelect = document.getElementById('fuel').value;
            const manualFields = document.getElementById('manualFuelFields');
            if(fuelSelect === 'manual') manualFields.classList.remove('hidden');
            else manualFields.classList.add('hidden');
        }

        function generateQR() {
            const client = document.getElementById('client').value.trim();
            const serial = document.getElementById('serial').value.trim();
            let rawVal = document.getElementById('totalValue').value.replace(/\./g, '').replace(',', '.');
            const totalVal = parseFloat(rawVal);
            const uPrice = document.getElementById('unitPrice').value;
            const wHours = document.getElementById('workHours').value;
            const fuel = document.getElementById('fuel').value;
            
            const dateStr = document.getElementById('installDate').value; 
            const timeStr = document.getElementById('installTime').value; 
            const fullDateTime = `${dateStr}-${timeStr.replace(':', '-')}`; 

            if(!totalVal || !uPrice) { showModal("Lütfen kayıp tutarını ve birim fiyatı giriniz."); return; }

            const secondsInWorkYear = wHours * 3600;
            const burnPerSecond = totalVal / secondsInWorkYear;

            // *** YÖNLENDİRME DÜZELTİLDİ: qrtakip.html ***
            const baseUrl = "https://optimizi.app/qrtakip.html";
            
            let finalUrl = `${baseUrl}?c=${encodeURIComponent(client)}&s=${encodeURIComponent(serial)}&v=${totalVal}&up=${uPrice}&wh=${wHours}&f=${fuel}&d=${fullDateTime}&bps=${burnPerSecond.toFixed(6)}`;

            if(fuel === 'manual') {
                let cLabel = document.getElementById('customFuelLabel').value || 'Paçal Kömür';
                const cUnit = document.getElementById('customFuelUnit').value || 'kg';
                const cCo2 = document.getElementById('customFuelCo2').value || '0.36';
                const cLhv = document.getElementById('customFuelLhv').value;
                if(cLhv) { cLabel += ` (${cLhv} kcal)`; }
                finalUrl += `&fl=${encodeURIComponent(cLabel)}&fu=${encodeURIComponent(cUnit)}&fc=${encodeURIComponent(cCo2)}`;
            }

            const resultCard = document.getElementById('resultCard');
            resultCard.classList.remove('hidden');

            const qrContainer = document.getElementById('qrcode');
            // Logoyu koruyarak temizle
            qrContainer.innerHTML = '<div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-lg border-2 border-slate-100 z-10"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="#dc2626" stroke="#dc2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-flame"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg></div>';

            new QRCode(qrContainer, { 
                text: finalUrl, 
                width: 160, 
                height: 160, 
                colorDark : "#0f172a", 
                colorLight : "#ffffff", 
                correctLevel : QRCode.CorrectLevel.H
            });

            document.getElementById('linkText').innerText = finalUrl;
            
            setTimeout(() => { 
                const canvas = qrContainer.querySelector("canvas");
                if(canvas) document.getElementById('downloadBtn').href = canvas.toDataURL("image/png");
                resultCard.scrollIntoView({ behavior: 'smooth' });
            }, 300);
        }

        // --- POPUP FONKSİYONLARI ---
        function showModal(msg) {
            document.getElementById('modalMessage').innerText = msg;
            const modal = document.getElementById('customModal');
            const content = document.getElementById('modalContent');
            modal.classList.remove('hidden');
            setTimeout(() => { content.classList.remove('scale-95'); content.classList.add('scale-100'); }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('customModal');
            const content = document.getElementById('modalContent');
            content.classList.remove('scale-100'); content.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 200);
        }

        function copyLink() {
            const text = document.getElementById('linkText').innerText;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector('button[onclick="copyLink()"]');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i data-lucide="check" class="w-3 h-3 text-green-500"></i>';
                lucide.createIcons();
                setTimeout(() => { btn.innerHTML = originalHtml; lucide.createIcons(); }, 1500);
            });
        }
    </script>
</body>
</html>
