<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Optimizi | Fiyat Teklif AracÄ±</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&display=swap');

:root {
    /* DARK THEME */
    --bg-main: #020617;
    --bg-pane: #0f172a;
    --bg-card: #1e293b;
    --bg-inp: rgba(0, 0, 0, 0.4);
    --bg-th: #0f172a;
    
    --brd: #334155;
    --brd-td: #1e293b;
    
    --tx-main: #f8fafc;
    --tx-mut: #94a3b8;
    
    --ac: #818cf8; /* Light Indigo */
    --cy: #22d3ee; /* Light Cyan */
    --gn: #34d399; /* Light Emerald */
    --rd: #fb7185; /* Light Rose */
    --am: #fbbf24; /* Light Amber */
    
    --sW: 260px;
}

[data-theme="light"] {
    /* LIGHT THEME */
    --bg-main: #f1f5f9;
    --bg-pane: #ffffff;
    --bg-card: #ffffff;
    --bg-inp: #f8fafc;
    --bg-th: #f1f5f9;
    
    --brd: #cbd5e1;
    --brd-td: #e2e8f0;
    
    --tx-main: #0f172a;
    --tx-mut: #64748b;
    
    --ac: #4f46e5; /* Dark Indigo */
    --cy: #0891b2; /* Dark Cyan */
    --gn: #059669; /* Dark Emerald */
    --rd: #e11d48; /* Dark Rose */
    --am: #d97706; /* Dark Amber */
}

/* EVERYTHING IS PLUS JAKARTA SANS */
* { margin:0; padding:0; box-sizing:border-box; font-family:'Plus Jakarta Sans', sans-serif !important; }
body { background:var(--bg-main); color:var(--tx-main); height:100vh; overflow:hidden; display:flex; transition: 0.3s; }

::-webkit-scrollbar { width:6px; height:6px; }
::-webkit-scrollbar-thumb { background:var(--brd); border-radius:4px; }

/* SIDEBAR */
.snav { width:var(--sW); min-width:var(--sW); height:100vh; background:var(--bg-pane); border-right:1px solid var(--brd); display:flex; flex-direction:column; z-index:20; transition:0.3s; }
.snav.collapsed { width:70px; min-width:70px; }
.snav.collapsed .nav-label, .snav.collapsed .logo-texts, .snav.collapsed .nav-group-title { display: none; }
.snav .logo { padding:24px 20px; display:flex; align-items:center; justify-content:center; border-bottom:1px solid var(--brd); position:relative; }
.snav .links { flex:1; padding:16px; display:flex; flex-direction:column; gap:4px; overflow-y:auto; }
.slink { display:flex; align-items:center; gap:12px; padding:12px 16px; border-radius:10px; cursor:pointer; font-size:.85rem; font-weight:700; color:var(--tx-mut); transition:.2s; border:1px solid transparent; width:100%; text-align:left; }
.snav.collapsed .slink { padding:12px; justify-content:center; }
.slink:hover { color:var(--tx-main); background:var(--bg-card); }
.slink.on { background:rgba(99,102,241,.1); color:var(--ac); border-color:rgba(99,102,241,.2); }

/* RIGHT SIDEBAR (Ayarlar) */
.rsnav { position: fixed; right: 0; top: 0; bottom: 0; width: 340px; background: var(--bg-pane); border-left: 1px solid var(--brd); transform: translateX(100%); transition: transform 0.3s ease; z-index: 50; padding: 24px; box-shadow: -10px 0 30px rgba(0,0,0,0.3); }
.rsnav.open { transform: translateX(0); }

/* MAIN */
.mn { flex:1; display:flex; flex-direction:column; overflow:hidden; position:relative; background:var(--bg-main); }
.tbar { height:64px; display:flex; align-items:center; justify-content:space-between; padding:0 24px; border-bottom:1px solid var(--brd); background:var(--bg-pane); flex-shrink:0; z-index:10; }
.pane { display:none; flex:1; overflow:auto; padding:24px; }
.pane.on { display:flex; flex-direction:column; animation:fadeIn 0.3s ease; }
@keyframes fadeIn { from{opacity:0; transform:translateY(5px)} to{opacity:1; transform:translateY(0)} }

/* SPREADSHEET (TABLES) */
.ss-con { flex:1; overflow:auto; border-radius:12px; border:1px solid var(--brd); background:var(--bg-pane); }
.ss { width:100%; border-collapse:separate; border-spacing:0; font-size:.76rem; }
.ss th { background:var(--bg-th); color:var(--ac); font-size:.65rem; font-weight:800; text-transform:uppercase; letter-spacing:.5px; text-align:center; border-bottom:1px solid var(--brd); border-right:1px solid var(--brd-td); position:sticky; top:0; z-index:2; white-space:nowrap; }
.ss th .resizer { resize:horizontal; overflow:hidden; min-width:40px; display:inline-flex; align-items:center; justify-content:center; padding:10px; width:100%; }
.ss td { padding:0; border-bottom:1px solid var(--brd-td); border-right:1px solid var(--brd-td); height:36px; white-space:nowrap; transition:0.2s; }
.ss tr:hover td { background:var(--bg-inp); }
.ss input, .ss select { width:100%; height:100%; border:none; background:transparent; color:var(--tx-main); font-size:.76rem; padding:4px 8px; outline:none; font-weight:600; }
.ss select option { background: var(--bg-pane); color: var(--tx-main); }
.ss input:focus, .ss select:focus { background:rgba(99,102,241,.1); box-shadow:inset 0 0 0 1px var(--ac); }
.ss input[type=number] { text-align:right; }
.ss .c { font-weight:700; text-align:right; padding:4px 10px; }
.ss .lb { font-weight:800; padding:4px 12px; color:var(--tx-mut); }
.col-hidden { display:none !important; }

/* UI ELEMENTS */
.cd { background:var(--bg-card); border:1px solid var(--brd); border-radius:12px; padding:16px; transition:0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
.st { display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:8px; font-weight:800; font-size:.85rem; margin-bottom:12px; }
.st.i { background:rgba(99,102,241,.1); color:var(--ac); } .st.c { background:rgba(6,182,212,.1); color:var(--cy); } .st.a { background:rgba(245,158,11,.1); color:var(--am); } .st.e { background:rgba(16,185,129,.1); color:var(--gn); }
.kpi { text-align:center; padding:20px; display:flex; flex-direction:column; justify-content:center; border:1px solid var(--brd); border-radius:12px; background:var(--bg-card); }
.kpi .v { font-size:1.6rem; font-weight:800; letter-spacing:-0.5px; } .kpi .k { font-size:.65rem; font-weight:800; color:var(--tx-mut); text-transform:uppercase; letter-spacing:1px; margin-top:6px; }

.bt { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:8px 16px; border-radius:8px; font-weight:800; font-size:.8rem; cursor:pointer; border:none; transition:.2s; }
.bt1 { background:var(--ac); color:#fff; box-shadow:0 4px 12px rgba(99,102,241,.3); } .bt1:hover { filter:brightness(1.1); transform:translateY(-1px); }
.bt2 { background:rgba(244,63,94,.1); color:var(--rd); border:1px solid rgba(244,63,94,.2); } .bt2:hover { background:rgba(244,63,94,.2); }
.bt3 { background:rgba(16,185,129,.1); color:var(--gn); border:1px solid rgba(16,185,129,.2); } .bt3:hover { background:rgba(16,185,129,.2); }
.bt4 { background:var(--bg-card); color:var(--tx-main); border:1px solid var(--brd); } .bt4:hover { border-color:var(--ac); color:var(--ac); }
.bt4.on { background:var(--ac); color:#fff; border-color:var(--ac); }

.pr { display:flex; align-items:center; padding:4px 0; }
.pr .l { flex:1; font-size:.8rem; font-weight:700; color:var(--tx-mut); padding-left:4px; }
.pr input, .pr select { width:100px; background:var(--bg-inp); border:1px solid var(--brd); padding:6px 10px; border-radius:6px; color:var(--tx-main); text-align:right; outline:none; transition:.2s; font-weight:700;}
.pr input:focus { border-color:var(--ac); } .pr input:disabled { opacity: 0.5; cursor: not-allowed; }
.pr .u { font-size:.7rem; color:var(--tx-mut); width:35px; text-align:left; padding-left:8px; font-weight:700;}
.ps { background:var(--bg-inp); border:1px solid var(--brd); padding:6px 10px; border-radius:6px; color:var(--tx-main); font-size:.8rem; outline:none; width:100%; transition:.2s; font-weight:700;}
.ps:focus { border-color:var(--ac); }

.tg { display:inline-flex; gap:2px; background:var(--bg-inp); border-radius:8px; padding:4px; border:1px solid var(--brd); }
.tg button { padding:6px 14px; border-radius:6px; font-size:.75rem; font-weight:800; border:none; cursor:pointer; color:var(--tx-mut); background:transparent; transition:0.2s; }
.tg button.on { background:var(--ac); color:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.2); }

/* CUSTOM MODALS */
.opt-modal-bg { position:fixed; inset:0; z-index:1000; background:rgba(0,0,0,0.7); backdrop-filter:blur(4px); display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:0.2s; }
.opt-modal-bg.show { opacity:1; pointer-events:auto; }
.opt-modal { background:var(--bg-pane); border:1px solid var(--brd); border-radius:16px; padding:28px; width:480px; max-width:95vw; max-height:90vh; overflow-y:auto; box-shadow:0 25px 50px -12px rgba(0,0,0,0.5); transform:scale(0.95); transition:0.2s; color:var(--tx-main); }
.opt-modal-bg.show .opt-modal { transform:scale(1); }
.opt-modal h3 { font-size:1.2rem; font-weight:900; margin-bottom:16px; display:flex; align-items:center; gap:8px; }
.opt-modal label { display:block; font-size:.75rem; font-weight:800; color:var(--tx-mut); text-transform:uppercase; margin:12px 0 4px; }

/* TOASTS */
.toast-container { position:fixed; bottom:24px; right:24px; z-index:2000; display:flex; flex-direction:column; gap:10px; }
.toast { background:var(--bg-card); color:var(--tx-main); border:1px solid var(--brd); padding:12px 16px; border-radius:10px; display:flex; align-items:center; gap:12px; font-size:.85rem; font-weight:700; box-shadow:0 10px 25px rgba(0,0,0,0.2); animation:slideIn 0.3s cubic-bezier(0.175,0.885,0.32,1.275) forwards; }
@keyframes slideIn { from{transform:translateX(100%);opacity:0} to{transform:translateX(0);opacity:1} }
.toast.ok i { color:var(--gn); } .toast.er i { color:var(--rd); } .toast.in i { color:var(--cy); }

/* CEKET HESAPLAMA SPECIFIC */
#p-ch { padding: 0 !important; overflow: hidden !important; position: absolute !important; inset: 64px 0 0 0 !important; height: auto !important; flex: unset !important; z-index: 5; background:var(--bg-main); }
</style>
</head>
<body>

<nav class="snav" id="sidebar">
 <div class="logo">
  <div class="logo-texts w-full text-center">
   <div class="text-2xl font-black tracking-tighter text-[var(--tx-main)]">Optimizi.App</div>
   <div class="text-[9px] text-[var(--cy)] font-bold uppercase tracking-widest mt-1">Fiyat Teklif AracÄ±</div>
  </div>
  <button onclick="toggleSidebar()" class="absolute -right-3 top-6 bg-[var(--ac)] rounded-full p-1 shadow-lg text-white"><i data-lucide="chevron-left" class="w-3 h-3" id="collapseIcon"></i></button>
 </div>
 <div class="links">
  <button class="slink on" onclick="go('pd',this)" title="ÃœrÃ¼n Detay"><i data-lucide="layout-grid"></i><span class="nav-label">ÃœrÃ¼n Detay</span></button>
  <button class="slink" onclick="go('pl',this)" title="Fiyat Listesi"><i data-lucide="file-spreadsheet"></i><span class="nav-label">Fiyat Listesi</span></button>
  <button class="slink" onclick="go('ms',this)" title="Genel Ã–zet"><i data-lucide="pie-chart"></i><span class="nav-label">Genel Ã–zet</span></button>
  <button class="slink" onclick="go('pm',this)" title="Personel Maliyetleri"><i data-lucide="users"></i><span class="nav-label">Personel Maliyeti</span></button>
  <div class="px-4 py-3 mt-2 text-[9px] font-bold text-[var(--tx-mut)] uppercase tracking-widest nav-group-title">Hesaplama & Ar-Ge</div>
  <button class="slink" onclick="go('ch',this)" title="Ceket Hesaplama Motoru"><i data-lucide="calculator"></i><span class="nav-label">Ceket KalÄ±p & Ã–lÃ§Ã¼</span></button>
  <div class="px-4 py-3 mt-2 text-[9px] font-bold text-[var(--tx-mut)] uppercase tracking-widest nav-group-title">VeritabanÄ±</div>
  <button class="slink" onclick="go('mf',this)" title="Malzeme FiyatlarÄ±"><i data-lucide="database"></i><span class="nav-label">Malzeme FiyatlarÄ±</span></button>
  <button class="slink" onclick="go('pr',this)" title="Parametreler"><i data-lucide="sliders-horizontal"></i><span class="nav-label">Parametreler</span></button>
 </div>
 <div class="p-3 border-t border-[var(--brd)] text-center">
    <button class="bt bt4 w-full justify-center text-xs" onclick="document.getElementById('rightSidebar').classList.add('open')"><i data-lucide="settings"></i> <span class="nav-label">Ayarlar</span></button>
 </div>
</nav>

<div class="rsnav" id="rightSidebar">
  <div class="flex items-center justify-between mb-6 border-b border-[var(--brd)] pb-4">
    <h2 class="font-bold text-lg flex items-center gap-2 text-[var(--tx-main)]"><i data-lucide="settings-2" class="text-[var(--cy)]"></i> Genel Ayarlar</h2>
    <button onclick="document.getElementById('rightSidebar').classList.remove('open')" class="text-[var(--rd)] hover:text-white"><i data-lucide="x"></i></button>
  </div>
  <div class="mb-4">
    <label class="block text-xs font-bold text-[var(--tx-mut)] uppercase mb-2">ÃœrÃ¼n Kodu Ã–n Eki (Prefix)</label>
    <input type="text" id="prefInput" class="ps font-bold text-[var(--tx-main)]" placeholder="Ã–rn: INSJACK" onchange="updatePrefix(this.value)">
    <p class="text-[10px] text-[var(--tx-mut)] mt-2 leading-relaxed">VarsayÄ±lan olarak eklenen bu ibareyi silebilir veya dilediÄŸiniz gibi deÄŸiÅŸtirebilirsiniz.</p>
  </div>
  <div class="mt-8">
    <label class="block text-xs font-bold text-[var(--tx-mut)] uppercase mb-2">DÃ¶viz API Durumu</label>
    <div id="apiStatusBadge" class="bg-[rgba(16,185,129,0.1)] border border-[var(--gn)] text-[var(--gn)] px-3 py-2 rounded-lg font-bold text-xs flex items-center gap-2">
      <i data-lucide="refresh-cw" class="w-4 h-4 animate-spin"></i> YÃ¼kleniyor...
    </div>
  </div>
</div>

<div class="mn">
<div class="tbar">
 <div class="flex gap-4 text-xs font-bold items-center">
  <div class="cd py-1.5 px-4 flex items-center gap-2"><span class="text-[10px] text-[var(--tx-mut)] uppercase">Kalem</span><span id="sI" class="text-[var(--cy)] font-bold text-sm">0</span></div>
  <div class="cd py-1.5 px-4 flex items-center gap-2"><span class="text-[10px] text-[var(--tx-mut)] uppercase">Ceket</span><span id="sJ" class="text-[var(--ac)] font-bold text-sm">0</span></div>
 </div>
 <div class="flex gap-3 items-center">
  <button onclick="toggleTheme()" class="bt bt4 px-2" id="themeBtn" title="Tema DeÄŸiÅŸtir"><i data-lucide="sun" class="w-4 h-4"></i></button>
  <button onclick="saveData()" class="bt bt1"><i data-lucide="save" class="w-4 h-4"></i>Kaydet</button>
  <button onclick="openPdfModal()" class="bt bt4"><i data-lucide="file-down" class="w-4 h-4"></i>PDF Ä°ndir</button>
 </div>
</div>

<div id="p-pd" class="pane on">
 <div class="flex items-center gap-3 mb-4 flex-wrap bg-[var(--bg-card)] p-4 rounded-xl border border-[var(--brd)] shadow-sm">
  <select id="aType" class="ps" style="width:170px" onchange="updDN()">
   <option value="">Ekipman Tipi...</option>
   <option value="gate">Gate Vana</option>
   <option value="globe">Globe Vana</option>
   <option value="butterfly">Kelebek Vana</option>
   <option value="yfilter">Pislik Tutucu</option>
   <option value="check_clv">Ã‡ekvalf (CLV-50)</option>
   <option value="ball_2">2 PrÃ§ KÃ¼resel</option>
   <option value="ball_3">3 PrÃ§ KÃ¼resel</option>
   <option value="3way">ÃœÃ§ Yollu Vana</option>
   <option value="trap">Kondenstop</option>
   <option value="elbow">Dirsek (90Â°)</option>
   <option value="flange">FlanÅŸ</option>
   <option value="manual_pad">Manuel YastÄ±k</option>
  </select>
  <select id="aDN" class="ps" style="width:90px"><option value="">DN</option></select>
  <select id="aCls" class="ps" style="width:100px"><option value="150">PN16/150</option><option value="300">PN25/300</option><option value="400">PN40/400</option><option value="600">600</option></select>
  <input type="number" id="aQty" class="ps font-bold" style="width:70px;text-align:center" value="1" min="1" title="Adet">
  <button onclick="addItem()" class="bt bt1 px-4"><i data-lucide="plus" class="w-4 h-4"></i>Ekle</button>
  
  <div class="ml-auto flex items-center gap-3">
   <button onclick="document.getElementById('colModal').classList.add('show')" class="bt bt4 px-3 text-xs shadow-sm"><i data-lucide="columns" class="w-4 h-4 text-[var(--cy)]"></i> SÃ¼tun AyarlarÄ±</button>
   <button onclick="openGlobalMatModal()" class="bt bt4 px-3 text-xs shadow-sm"><i data-lucide="layers" class="w-4 h-4 text-[var(--am)]"></i> Toplu Malzeme</button>
   <div class="h-6 w-px bg-[var(--brd)] mx-1"></div>
   <span class="text-xs font-bold text-[var(--tx-mut)] uppercase">Para Birimi:</span>
   <select id="pdCur" class="ps font-bold" style="width:80px" onchange="recalcAll()"><option value="TL">TL</option><option value="USD">USD</option><option value="EUR">EUR</option></select>
   <button onclick="optConfirm('Listeyi temizlemek istediÄŸinize emin misiniz?', ()=>{IT=[];RN=1;recalcAll()})" class="bt bt2 px-3" title="Listeyi Temizle"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
  </div>
 </div>

 <div class="ss-con" style="height:65vh">
  <table class="ss" id="tPD">
   <thead>
    <tr>
     <th data-col="ref"><div class="resizer">REF</div></th>
     <th data-col="tip"><div class="resizer">Tip</div></th>
     <th data-col="parca"><div class="resizer">ParÃ§a</div></th>
     <th data-col="dn"><div class="resizer">DN</div></th>
     <th data-col="cls"><div class="resizer">Cls</div></th>
     <th data-col="adet"><div class="resizer">Adet</div></th>
     <th data-col="zorluk" class="text-[var(--ac)]"><div class="resizer">Zorluk</div></th>
     <th data-col="altk"><div class="resizer">Alt KumaÅŸ</div></th>
     <th data-col="ustk"><div class="resizer">Ãœst KumaÅŸ</div></th>
     <th data-col="dolgu"><div class="resizer">Dolgu</div></th>
     <th data-col="izol" style="color:var(--am)"><div class="resizer">Ä°zolasyon</div></th>
     <th data-col="fcap"><div class="resizer">F.Ã‡ap</div></th>
     <th data-col="s"><div class="resizer">S (Ã‡evre)</div></th>
     <th data-col="t"><div class="resizer">T (Boy)</div></th>
     <th data-col="mkumas" style="color:var(--cy)"><div class="resizer">KumaÅŸ MÂ²</div></th>
     <th data-col="mdolgu" style="color:var(--cy)"><div class="resizer">Dolgu MÂ²</div></th>
     <th data-col="mdikis" style="color:var(--cy)"><div class="resizer">DikiÅŸ Ä°pi</div></th>
     <th data-col="mbogma" style="color:var(--cy)"><div class="resizer">BoÄŸma Ä°pi</div></th>
     <th data-col="mcirt" style="color:var(--cy)"><div class="resizer">CÄ±rt Bant</div></th>
     <th data-col="magraf" style="color:var(--cy)"><div class="resizer">Agraf</div></th>
     <th data-col="mpul" style="color:var(--cy)"><div class="resizer">Pul</div></th>
     <th data-col="mlz" style="color:var(--ac)"><div class="resizer">Mlz Mly</div></th>
     <th data-col="isc" style="color:var(--ac)"><div class="resizer">Ä°ÅŸÃ§ Mly</div></th>
     <th data-col="bmly" style="color:var(--gn)"><div class="resizer">B.Mly</div></th>
     <th data-col="bsat" style="color:var(--gn)"><div class="resizer">B.SatÄ±ÅŸ</div></th>
     <th data-col="toplam" style="color:var(--gn)"><div class="resizer">Toplam</div></th>
     <th data-col="sil"></th>
    </tr>
   </thead>
   <tbody id="pdBody"></tbody><tfoot id="pdFoot"></tfoot>
  </table>
 </div>
</div>

<div id="p-pl" class="pane">
 <div class="flex items-center justify-between mb-4">
  <h2 class="text-xl font-bold flex items-center gap-2"><i data-lucide="file-spreadsheet" class="text-[var(--ac)]"></i> MÃ¼ÅŸteri Fiyat Listesi</h2>
  <div class="tg" id="curToggle"></div>
 </div>
 <div class="ss-con" style="height:75vh">
  <table class="ss" id="tPL"><thead id="plHead"></thead><tbody id="plBody"></tbody><tfoot><tr id="plFoot"></tr></tfoot></table>
 </div>
</div>

<div id="p-ms" class="pane">
<div class="grid grid-cols-2 lg:grid-cols-5 gap-5 mb-6">
 <div class="kpi"><div class="v text-[var(--cy)]" id="kC">â‚º0</div><div class="k">Toplam Maliyet</div></div>
 <div class="kpi"><div class="v text-[var(--gn)]" id="kS">â‚º0</div><div class="k">SatÄ±ÅŸ Bedeli</div></div>
 <div class="kpi"><div class="v text-[var(--am)]" id="kP">â‚º0</div><div class="k">KÃ¢r</div></div>
 <div class="kpi"><div class="v text-[var(--ac)]" id="kM">%0</div><div class="k">KÃ¢r MarjÄ±</div></div>
 <div class="kpi"><div class="v text-[var(--rd)]" id="kJ">0</div><div class="k">Ceket</div></div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
 <div class="cd flex flex-col">
  <div class="st e"><i data-lucide="calculator" class="w-4 h-4"></i>Maliyet KÄ±rÄ±lÄ±mÄ±</div>
  <div class="rounded-xl overflow-hidden border border-[var(--brd)] flex-1 bg-[var(--bg-pane)]"><table class="ss" id="tMC" style="height:100%"></table></div>
 </div>
 <div class="cd flex flex-col">
  <div class="st c"><i data-lucide="package" class="w-4 h-4"></i>Malzeme ToplamlarÄ±</div>
  <div class="rounded-xl overflow-hidden border border-[var(--brd)] flex-1 overflow-y-auto bg-[var(--bg-pane)]"><table class="ss" id="tMM" style="height:100%"></table></div>
 </div>
 <div class="cd flex flex-col">
  <div class="st a"><i data-lucide="briefcase" class="w-4 h-4"></i>Hizmet Bedelleri</div>
  <div class="space-y-3 mt-2 flex-1" id="msServices"></div>
  <div class="mt-4 pt-4 border-t border-[var(--brd)] flex justify-between items-center"><span class="font-extrabold text-sm text-[var(--tx-main)]">Toplam Hizmet</span><span class="font-extrabold text-[var(--am)] font-bold text-lg" id="msSvcTotal">â‚º0</span></div>
 </div>
</div>

<div class="cd w-full">
 <div class="st i"><i data-lucide="globe" class="w-4 h-4"></i>DÃ¶viz & KÃ¢r Analizi</div>
 <div class="rounded-xl overflow-hidden border border-[var(--brd)] mb-4 bg-[var(--bg-pane)]"><table class="ss" id="tMS"></table></div>
 <div class="grid grid-cols-3 gap-4">
  <div class="bg-[var(--bg-inp)] rounded-lg kpi" style="padding:16px; border:none"><div class="v text-[1.2rem] text-[var(--tx-main)] font-mono" id="msAH">0</div><div class="k">AdamÃ—Saat</div></div>
  <div class="bg-[var(--bg-inp)] rounded-lg kpi" style="padding:16px; border:none"><div class="v text-[1.2rem] text-[var(--tx-main)] font-mono" id="msAD">0</div><div class="k">Adam GÃ¼n</div></div>
  <div class="bg-[var(--bg-inp)] rounded-lg kpi" style="padding:16px; border:none"><div class="v text-[1.2rem] text-[var(--tx-main)] font-mono" id="msJC">0</div><div class="k">Ceket</div></div>
 </div>
</div>
</div>

<div id="p-mf" class="pane">
<div class="flex items-center justify-between mb-4"><div class="tg" id="mfBtns"></div><button onclick="openMatModal()" class="bt bt3"><i data-lucide="plus" class="w-4 h-4"></i>Yeni Malzeme</button></div>
<div class="ss-con" style="height:75vh"><table class="ss"><thead><tr><th>#</th><th>TÃ¼r</th><th>Alt Tip</th><th style="min-width:180px">Malzeme Cinsi</th><th>Birim</th><th>Fiyat</th><th>DÃ¶viz</th><th style="color:var(--gn)">TL Fiyat</th><th>KalÄ±nlÄ±k</th><th></th></tr></thead><tbody id="mBody"></tbody></table></div>
</div>

<div id="p-pm" class="pane">
<div class="grid grid-cols-1 lg:grid-cols-4 gap-5 mb-5">
 <div class="kpi"><div class="v text-[var(--cy)]" id="pmAvg">â‚º0</div><div class="k">Ort. Saat Maliyeti</div></div>
 <div class="kpi"><div class="v text-[var(--ac)]" id="pmCnt">0</div><div class="k">Personel SayÄ±sÄ±</div></div>
 <div class="kpi"><div class="v text-[var(--gn)]" id="pmTot">â‚º0</div><div class="k">YÄ±llÄ±k Toplam Maliyet</div></div>
 <div class="kpi"><div class="v text-[var(--am)]" id="pmDay">â‚º0</div><div class="k">GÃ¼nlÃ¼k Toplam</div></div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-4 gap-5 mb-5">
 <div class="cd"><div class="st a"><i data-lucide="settings" class="w-4 h-4"></i>Ortak Parametreler</div><div id="pmParams"></div></div>
 <div class="lg:col-span-3 flex flex-col">
  <div class="flex items-center justify-between mb-3"><div class="text-xs text-[var(--tx-mut)] font-bold"><i data-lucide="info" class="w-3 h-3 inline relative -top-0.5"></i> Hesaplanan saat maliyeti sistemin ana iÅŸÃ§ilik gideri olarak otomatik senkronize edilir.</div><button onclick="openPersModal()" class="bt bt3"><i data-lucide="user-plus" class="w-4 h-4"></i>Personel Ekle</button></div>
  <div class="ss-con" style="height:55vh"><table class="ss"><thead><tr><th>#</th><th>GÃ¶rev</th><th style="min-width:140px">Ad Soyad</th><th>AylÄ±k Net</th><th style="color:var(--cy)">YÄ±llÄ±k BrÃ¼t</th><th style="color:var(--cy)">KÄ±dem</th><th style="color:var(--cy)">Ä°zin</th><th>Servis</th><th>Yemek</th><th>KKD</th><th style="color:var(--am)">Fazla Ã‡.</th><th style="color:var(--ac)">YÄ±llÄ±k Top.</th><th style="color:var(--gn)">Saat Mly</th><th></th></tr></thead><tbody id="pmBody"></tbody><tfoot><tr><td colspan="10" class="lb text-right font-extrabold text-[var(--tx-main)]">ORTALAMA / TOPLAM</td><td class="c font-bold text-[var(--am)] font-mono" id="pmFcTot"></td><td class="c text-[var(--ac)] font-bold font-mono" id="pmNTot"></td><td class="c font-bold text-[var(--gn)] text-[1rem] font-mono" id="pmOTot"></td><td></td></tr></tfoot></table></div>
 </div>
</div>
</div>

<div id="p-pr" class="pane">
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
 <div class="cd"><div class="st c"><i data-lucide="coins" class="w-4 h-4"></i>DÃ¶viz & Ä°ÅŸÃ§ilik</div><div id="pDov" class="space-y-1"></div></div>
 <div class="cd"><div class="st a"><i data-lucide="ruler" class="w-4 h-4"></i>Fire & Geometri</div><div id="pFir" class="space-y-1"></div></div>
 <div class="cd"><div class="st e"><i data-lucide="hard-hat" class="w-4 h-4"></i>Ä°ÅŸÃ§ilik Sabitleri</div><div id="pLab" class="space-y-1"></div></div>
</div>

<div class="bg-[rgba(99,102,241,0.1)] border border-[rgba(99,102,241,0.2)] p-4 rounded-xl mt-6">
  <h3 class="font-bold text-[var(--ac)] flex items-center gap-2 mb-2"><i data-lucide="cpu" class="w-4 h-4"></i> Yapay Zeka Extrapolasyon Aktif</h3>
  <p class="text-xs text-[var(--tx-mut)]">Eksik (bÃ¼yÃ¼k) Ã§aplar DN15-1000 bandÄ±nda tam kapsayÄ±cÄ±lÄ±k saÄŸlamak adÄ±na otomatik olarak hesaplanarak dolduruldu.</p>
</div>

<div class="cd mt-4"><div class="st i"><i data-lucide="circle" class="w-4 h-4"></i>FlanÅŸ Ã‡ap Tablosu (mm) [Dolduruldu]</div><div class="overflow-auto max-h-[42vh] rounded-lg border border-[var(--brd)] bg-[var(--bg-pane)]"><table class="ss" id="tFl"></table></div></div>
<div class="cd mt-6"><div class="st c"><i data-lucide="move-horizontal" class="w-4 h-4"></i>GÃ¶vde Uzunluk (L1 / L2) [Dolduruldu]</div>
 <div class="flex gap-2 mb-3"><button onclick="slt('gate')" class="bt bt4 on" id="bl-gate">Gate</button><button onclick="slt('globe')" class="bt bt4" id="bl-globe">Globe</button><button onclick="slt('butterfly')" class="bt bt4" id="bl-butterfly">Kelebek</button></div>
 <div class="overflow-auto max-h-[42vh] rounded-lg border border-[var(--brd)] bg-[var(--bg-pane)]"><table class="ss" id="tLn"></table></div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
 <div class="cd"><div class="st c"><i data-lucide="gauge" class="w-4 h-4"></i>Vana Referans Ã–lÃ§Ã¼leri (PDF)</div>
  <div class="flex gap-2 mb-3"><select id="vRefSel" class="ps font-bold" style="width:260px" onchange="rVRef()"><option value="PV-16">Pistonlu Vana PN16</option><option value="GV-16K">Glob Vana PN16 (Pik DÃ¶kÃ¼m)</option><option value="GV-25Z">Glob Vana PN25 (Sfero DÃ¶kÃ¼m)</option><option value="GV-40K">Glob Vana PN40 (Ã‡elik DÃ¶kÃ¼m)</option><option value="MK-16">KÃ¶rÃ¼klÃ¼ Vana PN16 (Pik DÃ¶kÃ¼m)</option><option value="MK-25">KÃ¶rÃ¼klÃ¼ Vana PN25 (Sfero DÃ¶kÃ¼m)</option><option value="MK-40">KÃ¶rÃ¼klÃ¼ Vana PN40 (Ã‡elik DÃ¶kÃ¼m)</option><option value="GTK-18">SÃ¼rgÃ¼lÃ¼ Vana PN16 (GGG-50)</option></select></div>
  <div class="overflow-auto max-h-[35vh] rounded-lg border border-[var(--brd)] bg-[var(--bg-pane)]"><table class="ss" id="tVRef"></table></div>
 </div>
 <div class="cd"><div class="st a"><i data-lucide="circle-dot" class="w-4 h-4"></i>Agraf & Pul (TÃ¼mÃ¼ Extrapolated)</div><div class="overflow-auto max-h-[35vh] rounded-lg border border-[var(--brd)] bg-[var(--bg-pane)]"><table class="ss" id="tAg"></table></div></div>
</div>
</div>

<div id="p-ch" class="pane" style="padding:0; position:absolute; inset:64px 0 0 0;">
  <div style="flex-shrink:0;display:flex;align-items:center;justify-content:space-between;padding:12px 24px;background:var(--bg-pane);border-bottom:1px solid var(--brd);gap:12px;flex-wrap:wrap;">
    <div style="display:flex;gap:3px;background:var(--bg-inp);border-radius:8px;padding:3px;border:1px solid var(--brd)">
      <button id="chTabV" onclick="chMode('vana')" style="padding:8px 20px;border-radius:6px;font-size:.8rem;font-weight:800;border:none;cursor:pointer;background:var(--ac);color:#fff;box-shadow:0 2px 8px rgba(0,0,0,.2);transition:.2s;">âŠ™ Vana Ceketi</button>
      <button id="chTabP" onclick="chMode('pad')"  style="padding:8px 20px;border-radius:6px;font-size:.8rem;font-weight:800;border:none;cursor:pointer;background:transparent;color:var(--tx-mut);transition:.2s;">â–­ DÃ¼z YastÄ±k</button>
    </div>
    <div id="chSecDB" style="display:flex;align-items:center;gap:8px">
      <span style="font-size:.7rem;color:var(--tx-mut);font-weight:800;text-transform:uppercase;">VeritabanÄ±:</span>
      <select id="chVT" class="ps" style="width:185px;font-size:.8rem" onchange="chUpdDN()"><option value="">â€” Vana Tipi â€”</option></select>
      <select id="chVDN" class="ps" style="width:90px;font-size:.8rem" onchange="chAutoFill()"><option value="">â€” DN â€”</option></select>
      <div id="chFillOk" style="font-size:.7rem;color:var(--gn);font-weight:800;display:none"><i data-lucide="check" class="inline w-3 h-3"></i> Dolduruldu</div>
    </div>
    <div style="display:flex;align-items:center;gap:6px">
      <span style="font-size:.7rem;color:var(--tx-mut);font-weight:800;text-transform:uppercase;">Adet:</span>
      <input type="number" id="chVQ" value="1" min="1" class="ps font-mono" style="width:60px;font-size:.85rem;text-align:center">
    </div>
    <div style="display:flex;gap:8px;margin-left:auto">
      <button onclick="chHesapla()" class="bt bt1" style="padding:10px 24px;font-size:.85rem;"><i data-lucide="calculator" class="w-4 h-4"></i> Hesapla</button>
      <button onclick="chGonderFiyatListesi()" id="chGonderBtn" class="bt bt3" style="padding:10px 24px;font-size:.85rem;opacity:.4;cursor:not-allowed" disabled><i data-lucide="send" class="w-4 h-4"></i> Listeye Ekle</button>
    </div>
  </div>
  <div style="flex:1;display:grid;grid-template-columns:290px 300px 1fr;overflow:hidden;height:100%;background:var(--bg-main);">
    <div style="overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px;border-right:1px solid var(--brd);background:var(--bg-pane);">
      <div id="chSecVD" class="cd" style="padding:0; overflow:hidden;">
        <div style="padding:10px 16px;font-size:.65rem;font-weight:800;letter-spacing:1px;text-transform:uppercase;color:var(--ac);background:rgba(99,102,241,.1);border-bottom:1px solid var(--brd)">ğŸ“ Vana BoyutlarÄ±</div>
        <div style="padding:12px 16px;display:flex;flex-direction:column;gap:4px">
          <div class="pr"><span class="l">D â€” FlanÅŸ Ã‡apÄ±</span><input type="number" id="chD" value="185" min="10" oninput="chLive()"><span class="u">mm</span></div>
          <div class="pr"><span class="l">L â€” FlanÅŸ ArasÄ±</span><input type="number" id="chL" value="290" min="10" oninput="chLive()"><span class="u">mm</span></div>
          <div class="pr"><span class="l">H â€” YÃ¼kseklik</span><input type="number" id="chH" value="200" min="0" oninput="chLive()"><span class="u">mm</span></div>
          <div class="pr"><span class="l" style="font-size:.71rem">Boyun Ã‡apÄ± <small style="color:var(--tx-mut)">(0=DÃ—0.5)</small></span><input type="number" id="chDB" value="0" min="0" oninput="chLive()"><span class="u">mm</span></div>
        </div>
      </div>
      <div id="chSecPD" class="cd" style="padding:0; overflow:hidden; display:none;">
        <div style="padding:10px 16px;font-size:.65rem;font-weight:800;letter-spacing:1px;text-transform:uppercase;color:var(--am);background:rgba(245,158,11,.1);border-bottom:1px solid var(--brd)">ğŸ“ YastÄ±k BoyutlarÄ±</div>
        <div style="padding:12px 16px;display:flex;flex-direction:column;gap:6px">
          <div class="pr"><span class="l">W â€” GeniÅŸlik</span><input type="number" id="chPW" value="500" min="10" oninput="chLive()"><span class="u">mm</span></div>
          <div class="pr"><span class="l">H â€” YÃ¼kseklik</span><input type="number" id="chPH" value="400" min="10" oninput="chLive()"><span class="u">mm</span></div>
          <div class="pr"><span class="l">Adet</span><input type="number" id="chPQ" value="1" min="1"><span class="u">ad</span></div>
          <div style="padding:8px 0 4px">
            <div style="font-size:.7rem;color:var(--tx-mut);font-weight:800;margin-bottom:6px">Kenar Tipi</div>
            <div style="display:flex;gap:4px;background:var(--bg-inp);border-radius:8px;padding:4px; border:1px solid var(--brd);">
              <button id="chBKS" onclick="chSetK('kenarsiz')" style="flex:1;padding:8px 0;border-radius:6px;font-size:.75rem;font-weight:800;border:none;cursor:pointer;background:var(--ac);color:#fff;transition:.2s">â–­ KenarsÄ±z</button>
              <button id="chBKL" onclick="chSetK('kenarli')"  style="flex:1;padding:8px 0;border-radius:6px;font-size:.75rem;font-weight:800;border:none;cursor:pointer;background:transparent;color:var(--tx-mut);transition:.2s">âŠ¡ KenarlÄ±</button>
            </div>
            <div id="chKD" style="font-size:.65rem;color:var(--tx-mut);margin-top:6px;font-weight:600;">Dolgu iki kumaÅŸ arasÄ±na, kenarlar aÃ§Ä±k/bantlÄ±</div>
          </div>
        </div>
      </div>
      <div class="cd" style="padding:0; overflow:hidden;">
        <div style="padding:10px 16px;font-size:.65rem;font-weight:800;letter-spacing:1px;text-transform:uppercase;color:var(--cy);background:rgba(6,182,212,.1);border-bottom:1px solid var(--brd)">ğŸ”© Ä°zolasyon & Paylar</div>
        <div style="padding:12px 16px;display:flex;flex-direction:column;gap:4px">
          <div class="pr"><span class="l">KalÄ±nlÄ±k (I)</span><input type="number" id="chI" value="50" min="0" oninput="chLive()"><span class="u">mm</span></div>
          <div id="chPayV">
            <div class="pr"><span class="l">CÄ±rt PayÄ±</span><input type="number" id="chPC" value="50" min="0"><span class="u">mm</span></div>
            <div class="pr"><span class="l">Yan Pay (tek)</span><input type="number" id="chPY" value="50" min="0"><span class="u">mm</span></div>
            <div class="pr"><span class="l">BoÄŸma FazlalÄ±k</span><input type="number" id="chPR" value="150" min="0"><span class="u">mm</span></div>
          </div>
          <div id="chPayP" style="display:none"><div class="pr"><span class="l">DikiÅŸ PayÄ±</span><input type="number" id="chPSM" value="15" min="0"><span class="u">mm</span></div></div>
        </div>
      </div>
      <div class="cd" style="padding:0; overflow:hidden;">
        <div style="padding:10px 16px;font-size:.65rem;font-weight:800;letter-spacing:1px;text-transform:uppercase;color:var(--rd);background:rgba(244,63,94,.1);border-bottom:1px solid var(--brd)">ğŸ’¼ Ä°ÅŸÃ§ilik & SatÄ±ÅŸ</div>
        <div style="padding:12px 16px;display:flex;flex-direction:column;gap:4px">
          <div class="pr"><span class="l">SÃ¼re (sa/mÂ²)</span><input type="number" id="chLBX" value="0.30" step="0.01" min="0" class="font-mono"><span class="u">sa</span></div>
          <div class="pr"><span class="l">Saat Ãœcreti</span><input type="number" id="chHC" value="250" min="0" class="font-mono" disabled title="Parametrelerden Ã‡ekilir"><span class="u">â‚º</span></div>
          <div class="pr"><span class="l">SatÄ±ÅŸ Ã‡arpanÄ±</span><input type="number" id="chMUL" value="2.5" step="0.1" min="1" class="font-mono" disabled title="Parametrelerden Ã‡ekilir"><span class="u">Ã—</span></div>
          <div id="chDFSec">
            <div style="font-size:.7rem;color:var(--tx-mut);margin:10px 0 6px;font-weight:800;">Zorluk Ã‡arpanÄ± (df)</div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:4px">
              <button class="bt bt4" data-df="1.0" onclick="chSetDf(this)" style="font-size:.65rem;padding:6px 2px;">KÃ¼resel<br><span style="color:var(--gn)">Ã—1.0</span></button>
              <button class="bt bt4 on" data-df="1.2" onclick="chSetDf(this)" style="font-size:.65rem;padding:6px 2px;">Glob<br><span>Ã—1.2</span></button>
              <button class="bt bt4" data-df="1.3" onclick="chSetDf(this)" style="font-size:.65rem;padding:6px 2px;">KÃ¶rÃ¼klÃ¼<br><span>Ã—1.3</span></button>
              <button class="bt bt4" data-df="1.5" onclick="chSetDf(this)" style="font-size:.65rem;padding:6px 2px;">Pislik<br><span style="color:var(--am)">Ã—1.5</span></button>
              <button class="bt bt4" data-df="1.8" onclick="chSetDf(this)" style="font-size:.65rem;padding:6px 2px;">3 Yollu<br><span style="color:var(--am)">Ã—1.8</span></button>
              <button class="bt bt4" data-df="2.0" onclick="chSetDf(this)" style="font-size:.65rem;padding:6px 2px;">Ã–zel<br><span style="color:var(--rd)">Ã—2.0</span></button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div style="overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px;border-right:1px solid var(--brd);background:var(--bg-main);">
      <div class="cd" style="padding:0; overflow:hidden;">
        <div style="padding:10px 16px;font-size:.65rem;font-weight:800;letter-spacing:1px;text-transform:uppercase;color:var(--gn);background:rgba(16,185,129,.1);border-bottom:1px solid var(--brd);display:flex;justify-content:space-between;align-items:center">
          <span>ğŸ§µ ReÃ§ete (VeritabanÄ±)</span><button onclick="chRefreshMats()" style="color:var(--tx-main);background:none;border:none;cursor:pointer;"><i data-lucide="refresh-cw" class="w-3 h-3"></i></button>
        </div>
        <div style="padding:12px 16px;display:flex;flex-direction:column;gap:4px">
          <div class="pr"><span class="l">Alt KumaÅŸ</span><select id="chMFB" class="ps font-bold" style="width:140px;font-size:.7rem"></select></div>
          <div class="pr"><span class="l">Ãœst KumaÅŸ</span><select id="chMFT" class="ps font-bold" style="width:140px;font-size:.7rem"></select></div>
          <div class="pr"><span class="l">Dolgu</span><select id="chMFL" class="ps font-bold" style="width:140px;font-size:.7rem"></select></div>
          <div id="chRowCirt" class="pr"><span class="l">CÄ±rt Bant</span><select id="chMVL" class="ps font-bold" style="width:140px;font-size:.7rem"></select></div>
          <div id="chRowBogma" class="pr"><span class="l">BoÄŸma Ä°pi</span><select id="chMDS" class="ps font-bold" style="width:140px;font-size:.7rem"></select></div>
          <div class="pr"><span class="l">DikiÅŸ Ä°pi</span><select id="chMST" class="ps font-bold" style="width:140px;font-size:.7rem"></select></div>
          <div class="pr"><span class="l">Agraf</span><select id="chMSP" class="ps font-bold" style="width:140px;font-size:.7rem"></select></div>
          <div class="pr"><span class="l">Pul</span><select id="chMND" class="ps font-bold" style="width:140px;font-size:.7rem"></select></div>
          <div class="pr"><span class="l">Toka</span><select id="chMBK" class="ps font-bold" style="width:140px;font-size:.7rem"></select></div>
        </div>
      </div>
      <div class="cd" style="padding:0; overflow:hidden;">
        <div style="padding:10px 16px;font-size:.65rem;font-weight:800;letter-spacing:1px;text-transform:uppercase;color:var(--tx-mut);background:var(--bg-inp);border-bottom:1px solid var(--brd)">â— KalÄ±p Ã–nizleme</div>
        <div style="padding:16px;display:flex;flex-direction:column;align-items:center;gap:12px">
          <svg id="chSVG" width="240" height="190" viewBox="0 0 240 190"></svg>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;width:100%">
            <div style="background:var(--bg-inp);border:1px solid var(--brd);border-radius:8px;padding:8px;text-align:center"><div id="chGA" style="font-size:.9rem;font-weight:900;color:var(--cy)">â€”</div><div style="font-size:.6rem;font-weight:700;color:var(--tx-mut);text-transform:uppercase;">Alan (mÂ²)</div></div>
            <div style="background:var(--bg-inp);border:1px solid var(--brd);border-radius:8px;padding:8px;text-align:center"><div id="chGS1" style="font-size:.9rem;font-weight:900;color:var(--ac)">â€”</div><div style="font-size:.6rem;font-weight:700;color:var(--tx-mut);text-transform:uppercase;">Sâ‚ Eni</div></div>
            <div style="background:var(--bg-inp);border:1px solid var(--brd);border-radius:8px;padding:8px;text-align:center"><div id="chGT1" style="font-size:.9rem;font-weight:900;color:var(--ac)">â€”</div><div style="font-size:.6rem;font-weight:700;color:var(--tx-mut);text-transform:uppercase;">Tâ‚ Boyu</div></div>
            <div style="background:var(--bg-inp);border:1px solid var(--brd);border-radius:8px;padding:8px;text-align:center"><div id="chGS2" style="font-size:.9rem;font-weight:900;color:var(--am)">â€”</div><div id="chGS2L" style="font-size:.6rem;font-weight:700;color:var(--tx-mut);text-transform:uppercase;">Sâ‚‚ Eni</div></div>
          </div>
          <div id="chFBox" style="width:100%;padding:10px;background:var(--bg-inp);border:1px solid var(--brd);border-radius:8px;font-size:.65rem;color:var(--tx-mut);line-height:1.6;font-weight:700;">Hesaplama Bekleniyor...</div>
        </div>
      </div>
    </div>
    <div style="overflow-y:auto;padding:24px;display:flex;flex-direction:column;gap:16px;background:var(--bg-pane);">
      <div id="chResults">
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;padding:100px 40px;text-align:center;color:var(--tx-mut)"><i data-lucide="calculator" style="width:64px;height:64px;opacity:0.2"></i><div><p style="font-size:1.1rem;font-weight:800;color:var(--tx-main);margin-bottom:8px">SonuÃ§lar Burada GÃ¶rÃ¼necek</p><p style="font-size:.85rem;max-width:300px;line-height:1.6">Sol panelden parametreleri girin, veritabanÄ±ndan vana seÃ§in ve <strong style="color:var(--ac)">Hesapla</strong> butonuna tÄ±klayÄ±n.</p></div></div>
      </div>
    </div>
  </div>
</div>
</div><div class="opt-modal-bg" id="colModal"><div class="opt-modal" style="width:380px;">
 <div class="flex items-center justify-between mb-4 border-b border-[var(--brd)] pb-3">
  <h3><i data-lucide="columns" class="w-5 h-5 text-[var(--cy)]"></i> SÃ¼tun AyarlarÄ±</h3>
  <button onclick="document.getElementById('colModal').classList.remove('show')" class="text-[var(--tx-mut)] hover:text-[var(--tx-main)]"><i data-lucide="x"></i></button>
 </div>
 <div id="colToggles" class="space-y-3 text-sm grid grid-cols-2 text-[var(--tx-main)] font-bold"></div>
 <div class="mt-6 pt-4 border-t border-[var(--brd)]"><button onclick="document.getElementById('colModal').classList.remove('show')" class="bt bt1 w-full py-3">Uygula ve Kapat</button></div>
</div></div>

<div class="opt-modal-bg" id="globalMatModal"><div class="opt-modal" style="width:500px;">
 <div class="flex items-center justify-between mb-4 border-b border-[var(--brd)] pb-3">
  <h3><i data-lucide="layers" class="w-5 h-5 text-[var(--am)]"></i> Toplu Malzeme Ata</h3>
  <button onclick="document.getElementById('globalMatModal').classList.remove('show')" class="text-[var(--tx-mut)] hover:text-[var(--tx-main)]"><i data-lucide="x"></i></button>
 </div>
 <p class="text-xs text-[var(--tx-mut)] mb-4 font-bold">Buradan seÃ§eceÄŸiniz malzemeler, ÃœrÃ¼n Detay listesindeki "Global" olarak ayarlanmÄ±ÅŸ tÃ¼m parÃ§alara aynÄ± anda uygulanÄ±r.</p>
 <div class="grid grid-cols-2 gap-4" id="globalMatContent"></div>
 <div class="mt-6 pt-4 border-t border-[var(--brd)]"><button onclick="document.getElementById('globalMatModal').classList.remove('show')" class="bt bt1 w-full py-3">Tamam</button></div>
</div></div>

<div class="opt-modal-bg" id="printModal"><div class="opt-modal" style="width:800px; max-width:90vw; border-radius:8px; padding:20px;">
 <div class="flex items-center justify-between mb-4 border-b border-[var(--brd)] pb-3">
  <h3><i data-lucide="printer" class="w-5 h-5 text-[var(--cy)]"></i> Teklif Ã–nizleme</h3>
  <button onclick="document.getElementById('printModal').classList.remove('show')" class="text-[var(--tx-mut)]"><i data-lucide="x"></i></button>
 </div>
 <div id="printArea" style="background:#fff; color:#000; padding:32px; border-radius:4px; min-height:400px; text-align:left;"></div>
 <div class="flex gap-3 mt-6"><button onclick="window.print()" class="bt bt1 flex-1 py-3 text-lg"><i data-lucide="printer"></i> PDF YazdÄ±r / Kaydet</button></div>
</div></div>

<div class="opt-modal-bg" id="modalMat"><div class="opt-modal">
 <h3><i data-lucide="plus-circle" class="w-5 h-5 text-[var(--gn)]"></i>Yeni Malzeme Ekle</h3>
 <label>TÃ¼r</label><select id="nmType" class="ps"><option>KumaÅŸ</option><option>Dolgu</option><option>YardÄ±mcÄ±</option><option>IsÄ±tÄ±cÄ±</option></select>
 <label>Alt Tip</label><input id="nmSub" class="ps" placeholder="Ã¶rn: Cam Elyaf, TaÅŸ YÃ¼nÃ¼...">
 <label>Malzeme Cinsi</label><input id="nmName" class="ps" placeholder="Ã¶rn: 1 SÄ° - 0.5 mm - Gri">
 <label>Birim</label><input id="nmUnit" class="ps" value="MÂ²">
 <div class="grid grid-cols-2 gap-3 mt-1">
  <div><label>Fiyat</label><input type="number" id="nmPrice" class="ps font-mono" step=".001" value="0"></div>
  <div><label>DÃ¶viz</label><select id="nmCur" class="ps"><option>TL</option><option>USD</option><option>EUR</option></select></div>
 </div>
 <label>KalÄ±nlÄ±k Sabiti (mm)</label><input type="number" id="nmThick" class="ps font-mono" placeholder="opsiyonel">
 <div class="flex gap-3 mt-6"><button onclick="submitMat()" class="bt bt1 flex-1 py-3">Ekle</button><button onclick="document.getElementById('modalMat').classList.remove('show')" class="bt bt4 flex-1 py-3">Ä°ptal</button></div>
</div></div>

<div class="opt-modal-bg" id="qtyModal"><div class="opt-modal" style="width:400px">
 <h3><i data-lucide="alert-triangle" class="w-5 h-5 text-[var(--am)]"></i>Adet UyarÄ±sÄ±</h3>
 <p class="text-sm text-[var(--tx-mut)] mb-4 leading-relaxed">Fiyat Listesi'ndeki adet ile ÃœrÃ¼n Detay'daki adet <strong class="text-[var(--am)]">birbiriyle Ã§arpÄ±lÄ±r</strong>.</p>
 <p class="text-sm mb-4 font-bold text-[var(--tx-main)]">Mevcut Ã‡arpan: <span id="qmCur" class="text-[var(--ac)] font-bold text-lg ml-2">1</span></p>
 <label>Yeni Adet</label><input type="number" id="qmVal" class="ps font-bold text-lg" min="1" value="1">
 <div class="flex gap-3 mt-6"><button onclick="submitQty()" class="bt bt1 flex-1 py-3">Uygula</button><button onclick="document.getElementById('qtyModal').classList.remove('show')" class="bt bt4 flex-1 py-3">Ä°ptal</button></div>
</div></div>

<div class="opt-modal-bg" id="persModal"><div class="opt-modal">
 <h3><i data-lucide="user-plus" class="w-5 h-5 text-[var(--cy)]"></i>Personel Ekle</h3>
 <label>GÃ¶rev</label><select id="npGorev" class="ps"><option>USTABAÅI</option><option>ORTACI</option><option selected>DÄ°KÄ°ÅÃ‡Ä°</option><option>DOLUMCU</option><option>KALÄ°TE</option><option>DÄ°ÄER</option></select>
 <label>Ad Soyad</label><input id="npAd" class="ps" placeholder="Ad Soyad">
 <label>AylÄ±k Net Ãœcret (â‚º)</label><input type="number" id="npNet" class="ps font-bold text-lg" step="100" value="48000">
 <div class="grid grid-cols-2 gap-3 mt-1">
  <div><label>KÄ±dem Birikimi Var mÄ±?</label><select id="npKidem" class="ps"><option value="1">Evet (formÃ¼lle)</option><option value="0">HayÄ±r</option></select></div>
  <div><label>Servis Gideri (â‚º/ay)</label><input type="number" id="npServis" class="ps font-bold" value="2750"></div>
 </div>
 <div class="flex gap-3 mt-6"><button onclick="submitPers()" class="bt bt1 flex-1 py-3">Ekle</button><button onclick="document.getElementById('persModal').classList.remove('show')" class="bt bt4 flex-1 py-3">Ä°ptal</button></div>
</div></div>

<div class="opt-modal-bg" id="optConfirmBg"><div class="opt-modal" style="width:400px">
 <h3 class="text-[var(--am)]"><i data-lucide="alert-circle"></i> Onay Gerekli</h3>
 <p class="text-sm text-[var(--tx-mut)] mb-6 mt-2" id="optConfirmMsg"></p>
 <div class="flex gap-3"><button id="optConfirmYes" class="bt bt2 flex-1 py-3">Evet</button><button onclick="document.getElementById('optConfirmBg').classList.remove('show')" class="bt bt4 flex-1 py-3">Ä°ptal</button></div>
</div></div>

<div class="toast-container" id="toastBox"></div>

<script>
// ====== SÃœTUN AYARLARI RENDER ======
function rColSettings() {
    const box = document.getElementById('colToggles');
    let html = '';
    const labels = {ref:'REF', tip:'Tip', parca:'ParÃ§a', dn:'DN', cls:'Class', adet:'Adet', zorluk:'Zorluk', altk:'Alt KumaÅŸ', ustk:'Ãœst KumaÅŸ', dolgu:'Dolgu', izol:'Ä°zolasyon', fcap:'F.Ã‡ap', s:'S (Ã‡evre)', t:'T (Boy)', mkumas:'M.KumaÅŸ', mdolgu:'M.Dolgu', mdikis:'M.DikiÅŸ', mbogma:'M.BoÄŸma', mcirt:'M.CÄ±rt', magraf:'M.Agraf', mpul:'M.Pul', mlz:'Malzeme Fyt', isc:'Ä°ÅŸÃ§ilik Fyt', bmly:'B.Maliyet', bsat:'B.SatÄ±ÅŸ', toplam:'Toplam', sil:'Sil'};
    Object.keys(colVis).forEach(k => {
        html += `<label class="flex items-center gap-2 cursor-pointer text-[var(--tx-main)]"><input type="checkbox" ${colVis[k]?'checked':''} onchange="colVis['${k}']=this.checked; applyColVis(); rProd(); saveData();" style="accent-color:var(--ac);width:16px;height:16px;"> ${labels[k]}</label>`;
    });
    box.innerHTML = html;
}
function applyColVis() {
    Object.keys(colVis).forEach(key => {
        const th = document.querySelector(`th[data-col="${key}"]`);
        if(th) { if(!colVis[key]) th.classList.add('col-hidden'); else th.classList.remove('col-hidden'); }
    });
}
function openGlobalMatModal(){
 document.getElementById('globalMatModal').classList.add('show');
 const fab=M.filter(m=>m.t==='KumaÅŸ'), fil=M.filter(m=>m.t==='Dolgu'), hlp=M.filter(m=>m.t==='YardÄ±mcÄ±');
 function gs(lb,k,list,cur){return`<div><label class="text-[10px] font-bold text-[var(--tx-mut)] uppercase">${lb}</label><select class="ps mt-1 font-bold" data-k="${k}" onchange="P[this.dataset.k]=this.value;recalcAll()">${list.map(m=>`<option value="${m.n}"${m.n===cur?' selected':''}>${m.n}</option>`).join('')}</select></div>`}
 const el = document.getElementById('globalMatContent');
 if(el){
     el.innerHTML=
      gs('Alt KumaÅŸ','gFB',fab,P.gFB)+gs('Ãœst KumaÅŸ','gFT',fab,P.gFT)+gs('Dolgu Malzemesi','gFL',fil,P.gFL)+
      gs('DikiÅŸ Ä°pi','gST',hlp.filter(m=>m.s==='DikiÅŸ Ä°pi'),P.gST)+gs('BoÄŸma Ä°pi','gDS',hlp.filter(m=>m.s==='BoÄŸma Ä°pi'),P.gDS)+
      gs('CÄ±rt Bant','gVL',hlp.filter(m=>m.s==='CÄ±rtbant'),P.gVL)+
      gs('Agraf','gSP',hlp.filter(m=>m.s==='ZÄ±mba Set'),P.gSP)+gs('Ã‡.Pul','gND',hlp.filter(m=>m.s==='Ã‡.Pul Set'),P.gND)+
      gs('Toka','gBK',hlp.filter(m=>m.s==='Toka'),P.gBK)+gs('Etiket','gLB',hlp.filter(m=>m.s==='Etiket'),P.gLB);
 }
}

// ====== CEKET HESAPLAMA (SVG) ======
let _chMode   = 'vana';   
let _chDf     = 1.2;      
let _chKenar  = 'kenarsiz';
const $v = id => parseFloat(document.getElementById(id)?.value) || 0;
const $s = id => document.getElementById(id)?.value || '';
function chMpByName(name){ const m=M.find(x=>x.n===name); return m?mp(m):0; }
function chFmt(v,d=2){ return Number(v).toLocaleString('tr-TR',{minimumFractionDigits:d,maximumFractionDigits:d}); }

function chOnOpen(){
  chPopVTypes(); chRefreshMats();
  document.getElementById('chHC').value  = parseFloat(P.hc)||250;
  document.getElementById('chMUL').value = parseFloat(P.mul)||2.5;
  document.getElementById('chLBX').value = parseFloat(P.lbx)||0.30;
  chLive();
}

function chMode(m){
  _chMode = m; const v = m==='vana';
  const btn=(id,on)=>{const e=document.getElementById(id);if(!e)return;e.style.background=on?'var(--ac)':'transparent';e.style.color=on?'#fff':'var(--tx-mut)';e.style.boxShadow=on?'0 2px 8px rgba(0,0,0,.2)':'none'};
  btn('chTabV',v); btn('chTabP',!v);
  const db=document.getElementById('chSecDB');if(db)db.style.display=v?'flex':'none';
  ['chSecVD','chPayV','chRowCirt','chRowBogma','chDFSec'].forEach(id=>{const e=document.getElementById(id);if(e)e.style.display=v?'':'none'});
  ['chSecPD','chPayP'].forEach(id=>{const e=document.getElementById(id);if(e)e.style.display=!v?'':'none'});
  document.getElementById('chGS2L').textContent = v?'Sâ‚‚ Eni':'Kenar AlanÄ±';
  document.getElementById('chResults').innerHTML=`<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;padding:100px 40px;text-align:center;color:var(--tx-mut)"><i data-lucide="calculator" style="width:64px;height:64px;opacity:0.2"></i><div><p style="font-size:1.1rem;font-weight:800;color:var(--tx-main);margin-bottom:8px">SonuÃ§lar Burada GÃ¶rÃ¼necek</p><p style="font-size:.85rem;max-width:300px;line-height:1.6">Sol panelden parametreleri girin, veritabanÄ±ndan vana seÃ§in ve <strong style="color:var(--ac)">Hesapla</strong> butonuna tÄ±klayÄ±n.</p></div></div>`;
  const gb=document.getElementById('chGonderBtn');if(gb){gb.disabled=true;gb.style.opacity='.4';gb.style.cursor='not-allowed';}
  window._chLastResult=null; chLive(); lucide.createIcons();
}

function chSetDf(btn){
  document.querySelectorAll('#p-ch [data-df]').forEach(b=>b.className='bt bt4');
  btn.className='bt bt4 on'; _chDf=parseFloat(btn.dataset.df);
}

function chSetK(k){
  _chKenar=k; const isK=k==='kenarli';
  const ks=document.getElementById('chBKS'); const kl=document.getElementById('chBKL');
  if(ks){ks.style.background=isK?'transparent':'var(--ac)';ks.style.color=isK?'var(--tx-mut)':'#fff';}
  if(kl){kl.style.background=isK?'var(--ac)':'transparent';kl.style.color=isK?'#fff':'var(--tx-mut)';}
  document.getElementById('chKD').textContent=isK?'Dolgunun 4 kenarÄ± kumaÅŸ ÅŸeritle kapatÄ±lÄ±r':'Dolgu iki kumaÅŸ arasÄ±na, kenarlar aÃ§Ä±k/bantlÄ±';
  chLive();
}

function chPopVTypes(){
  const sel=document.getElementById('chVT'); if(!sel)return;
  sel.innerHTML='<option value="">â€” SeÃ§in â€”</option>';
  Object.entries(VALVE_DATA).forEach(([k,v])=>{ sel.innerHTML+=`<option value="${k}">${v.desc}</option>`; });
}
function chUpdDN(){
  const ty=document.getElementById('chVT').value;
  const sel=document.getElementById('chVDN'); sel.innerHTML='<option value="">â€” DN â€”</option>';
  if(!ty)return;
  const vd=VALVE_DATA[ty]; if(!vd||!vd.dims)return;
  Object.keys(vd.dims).map(Number).sort((a,b)=>a-b).forEach(dn=>{ sel.innerHTML+=`<option value="${dn}">DN${dn}</option>`; });
}
function chAutoFill(){
  const ty=document.getElementById('chVT').value; const dn=parseInt(document.getElementById('chVDN').value);
  if(!ty||isNaN(dn))return;
  const vd=VALVE_DATA[ty]; if(!vd||!vd.dims||!vd.dims[dn])return;
  const d=vd.dims[dn];
  if(d.D)document.getElementById('chD').value=d.D;
  if(d.L)document.getElementById('chL').value=d.L;
  if(d.H)document.getElementById('chH').value=d.H; else document.getElementById('chH').value=Math.round((d.D||100)*0.8);
  document.getElementById('chDB').value=d.Dk||0;
  
  const dfMap={globe:1.2,gate:1.0,butterfly:1.0,yfilter:1.5,'3way':1.8};
  const sugDf=vd.difficulty||dfMap[vd.type]||1.2;
  document.querySelectorAll('#p-ch [data-df]').forEach(b=>{
    const on=parseFloat(b.dataset.df)===sugDf; b.className=on?'bt bt4 on':'bt bt4'; if(on)_chDf=sugDf;
  });
  const ok=document.getElementById('chFillOk'); if(ok){ok.style.display='inline-flex';setTimeout(()=>ok.style.display='none',3000);}
  chLive(); toast(`${vd.desc} DN${dn} Ã¶lÃ§Ã¼leri dolduruldu`,'in');
}

function chRefreshMats(){
  if(!M||!M.length){ setTimeout(chRefreshMats,300); return; }
  const fab=M.filter(m=>m.t==='KumaÅŸ'), fil=M.filter(m=>m.t==='Dolgu'), hlp=M.filter(m=>m.t==='YardÄ±mcÄ±');
  const cirt=hlp.filter(m=>m.s==='CÄ±rtbant'), bogma=hlp.filter(m=>m.s==='BoÄŸma Ä°pi'||m.s==='BaÄŸlama Ä°pi');
  const dikis=hlp.filter(m=>m.s==='DikiÅŸ Ä°pi'), agraf=hlp.filter(m=>m.s==='ZÄ±mba Set'||m.n.toLowerCase().includes('agraf'));
  const pul=hlp.filter(m=>m.s==='Ã‡.Pul Set'||m.n.toLowerCase().includes('pul')), toka=hlp.filter(m=>m.s.toLowerCase().includes('toka')||m.n.toLowerCase().includes('toka'));

  function fill(id,list,defVal){
    const el=document.getElementById(id); if(!el)return;
    el.innerHTML=list.map(m=>`<option value="${m.n}"${m.n===defVal?' selected':''}>${m.n} â€” â‚º${chFmt(mp(m))}</option>`).join('');
    if(!el.value&&list.length)el.value=list[0].n;
  }
  fill('chMFB',fab,P.gFB); fill('chMFT',fab,P.gFT); fill('chMFL',fil,P.gFL);
  fill('chMVL',cirt,P.gVL); fill('chMDS',bogma,P.gDS); fill('chMST',dikis,P.gST);
  fill('chMSP',agraf,P.gSP); fill('chMND',pul,P.gND);
  const tokaAll=toka.length?toka:hlp; fill('chMBK',tokaAll,P.gBK||'');
}

function chLive(){
  if(_chMode==='vana'){
    const D=$v('chD'),L=$v('chL'),H=$v('chH'),I=$v('chI'),pc=$v('chPC'),py=$v('chPY');
    const Db_ham=$v('chDB')>0?$v('chDB'):D*0.5;
    const D1=D+2*I, Db=Db_ham+2*I;
    const S1=D1*Math.PI+pc, T1=L+2*py, S2=Db*Math.PI+pc, T2=H;
    chDrawV({S1,T1,S2,T2,D1,Db});
    const A=(S1*T1+S2*T2)/1e6;
    const $n=(id,v)=>{const e=document.getElementById(id);if(e)e.textContent=v};
    $n('chGA',chFmt(A,4)); $n('chGS1',S1>0?S1.toFixed(1):'â€”');
    $n('chGT1',T1>0?T1:'â€”'); $n('chGS2',S2>0?S2.toFixed(1):'â€”');
    if(S1>0&&T1>0)document.getElementById('chFBox').innerHTML=`<span style="color:var(--tx-mut)">D_yeni=</span><span style="color:var(--cy)">${D1.toFixed(1)}</span>mm &nbsp;|&nbsp; <span style="color:var(--tx-mut)">Sâ‚=</span><span style="color:var(--cy)">${S1.toFixed(1)}</span>mm &nbsp;|&nbsp; <span style="color:var(--tx-mut)">Tâ‚=</span><span style="color:var(--cy)">${T1}</span>mm<br><span style="color:var(--tx-mut)">D_boyun=</span><span style="color:var(--am)">${Db.toFixed(1)}</span>mm &nbsp;|&nbsp; <span style="color:var(--tx-mut)">Sâ‚‚=</span><span style="color:var(--am)">${S2.toFixed(1)}</span>mm &nbsp;|&nbsp; <span style="color:var(--tx-mut)">Tâ‚‚=</span><span style="color:var(--am)">${T2}</span>mm`;
  } else {
    const W=$v('chPW'),H_p=$v('chPH'),I=$v('chI'),sm=$v('chPSM');
    const We=W+2*sm, He=H_p+2*sm;
    chDrawP({W,H_pad:H_p,W_eff:We,H_eff:He,kenarli:_chKenar==='kenarli',I});
    const alan_yuz=We*He/1e6; const alan_kenar=_chKenar==='kenarli'?(2*We*I+2*He*I)/1e6:0;
    const A=alan_yuz*2+alan_kenar;
    const $n=(id,v)=>{const e=document.getElementById(id);if(e)e.textContent=v};
    $n('chGA',chFmt(A,4)); $n('chGS1',We); $n('chGT1',He);
    $n('chGS2',_chKenar==='kenarli'?chFmt(alan_kenar,5):'â€”');
    document.getElementById('chFBox').innerHTML=`<span style="color:var(--tx-mut)">W_eff=</span><span style="color:var(--cy)">${We}</span>mm &nbsp;|&nbsp; <span style="color:var(--tx-mut)">H_eff=</span><span style="color:var(--cy)">${He}</span>mm<br><span style="color:var(--tx-mut)">Kenar=</span><span style="color:var(--am)">${_chKenar==='kenarli'?'KenarlÄ± âœ“ +'+chFmt(alan_kenar,4)+'mÂ²':'KenarsÄ±z'}</span>`;
  }
}

function chDrawV(g){
  const svg=document.getElementById('chSVG'); if(!svg||!g.S1)return;
  const W=240,H=190,pad=20;
  const sc=Math.min((W-2*pad)/g.S1,(H-2*pad-4)/(g.T1+(g.T2||50)))*0.78;
  const bW=g.S1*sc,bH=g.T1*sc,nW=g.S2*sc,nH=(g.T2||50)*sc;
  const bX=W/2-bW/2,bY=H-pad-bH,nX=W/2-nW/2,nY=bY-nH;
  svg.innerHTML=`<defs><pattern id="cg" width="8" height="8" patternUnits="userSpaceOnUse"><path d="M8,0 L0,0 L0,8" fill="none" stroke="rgba(99,102,241,.1)" stroke-width=".5"/></pattern></defs><rect width="${W}" height="${H}" fill="url(#cg)"/><rect x="${nX}" y="${nY}" width="${nW}" height="${nH}" fill="rgba(244,63,94,.15)" stroke="var(--rd)" stroke-width="1.5" rx="3"/><text x="${W/2}" y="${nY+nH/2+3}" text-anchor="middle" fill="var(--rd)" font-size="8" font-weight="800">BOYUN Sâ‚‚Ã—Tâ‚‚</text><rect x="${bX}" y="${bY}" width="${bW}" height="${bH}" fill="rgba(99,102,241,.15)" stroke="var(--ac)" stroke-width="1.5" rx="3"/><text x="${W/2}" y="${bY+bH/2+3}" text-anchor="middle" fill="var(--ac)" font-size="8" font-weight="800">GÃ–VDE Sâ‚Ã—Tâ‚</text><line x1="${bX+2}" y1="${H-4}" x2="${bX+bW-2}" y2="${H-4}" stroke="var(--ac)" stroke-width="1"/><text x="${W/2}" y="${H+1}" text-anchor="middle" fill="var(--ac)" font-size="7" font-weight="800">${g.S1.toFixed(0)}</text><line x1="${nX+2}" y1="${nY-4}" x2="${nX+nW-2}" y2="${nY-4}" stroke="var(--rd)" stroke-width="1"/><text x="${W/2}" y="${nY-6}" text-anchor="middle" fill="var(--rd)" font-size="7" font-weight="800">${g.S2.toFixed(0)}</text>`;
}

function chDrawP(g){
  const svg=document.getElementById('chSVG'); if(!svg||!g.W_eff)return;
  const W=240,H=190,pad=24;
  const sc=Math.min((W-2*pad)/g.W_eff,(H-2*pad)/g.H_eff)*0.82;
  const rW=g.W_eff*sc,rH=g.H_eff*sc,rx=W/2-rW/2,ry=H/2-rH/2;
  const ip=g.kenarli?Math.max(6,g.I*sc):0;
  svg.innerHTML=`<defs><pattern id="cg2" width="8" height="8" patternUnits="userSpaceOnUse"><path d="M8,0 L0,0 L0,8" fill="none" stroke="rgba(245,158,11,.1)" stroke-width=".5"/></pattern></defs><rect width="${W}" height="${H}" fill="url(#cg2)"/><rect x="${rx}" y="${ry}" width="${rW}" height="${rH}" fill="rgba(245,158,11,.15)" stroke="var(--am)" stroke-width="1.5" rx="3"/>${g.kenarli?`<rect x="${rx}" y="${ry-ip}" width="${rW}" height="${ip}" fill="rgba(16,185,129,.2)" stroke="var(--gn)" stroke-width="1" rx="1"/><rect x="${rx}" y="${ry+rH}" width="${rW}" height="${ip}" fill="rgba(16,185,129,.2)" stroke="var(--gn)" stroke-width="1" rx="1"/><rect x="${rx-ip}" y="${ry}" width="${ip}" height="${rH}" fill="rgba(16,185,129,.2)" stroke="var(--gn)" stroke-width="1" rx="1"/><rect x="${rx+rW}" y="${ry}" width="${ip}" height="${rH}" fill="rgba(16,185,129,.2)" stroke="var(--gn)" stroke-width="1" rx="1"/>`:''}<text x="${W/2}" y="${ry+rH/2}" text-anchor="middle" fill="var(--am)" font-size="8" font-weight="800">YASTIK ${g.W}Ã—${g.H_pad}mm</text><text x="${W/2}" y="${ry+rH/2+14}" text-anchor="middle" fill="var(--am)" opacity="0.8" font-size="7" font-weight="700">${g.kenarli?'KenarlÄ±':'KenarsÄ±z'}</text>`;
}

function chHesapla(){
  if(_chMode==='vana') chHesaplaVana(); else chHesaplaPad();
  setTimeout(()=>{const gb=document.getElementById('chGonderBtn');if(gb&&window._chLastResult){gb.disabled=false;gb.style.opacity='1';gb.style.cursor='pointer';}},100);
}

function chGonderFiyatListesi(){
  const r=window._chLastResult; if(!r){toast('Ã–nce hesaplama yapÄ±n','er');return;}
  const qt = r.tip==='vana' ? (parseInt(document.getElementById('chVQ')?.value)||1) : (r.adet||1);
  const dn = r.tip==='vana' ? (r.D||0) : 0;
  const vty= r.tip==='vana' ? (document.getElementById('chVT')?.value||'manuel') : 'pad';
  const desc= r.tip==='vana' ? (VALVE_DATA[vty]?.desc||'Ã–zel KalÄ±p Vana')+' DN'+dn : `DÃ¼z YastÄ±k ${r.W||'?'}Ã—${r.H_p||'?'}mm${r.kenarli?' (KenarlÄ±)':''}`;

  const item = {
    ref: RN++, ty: vty || 'pad', vref: vty || 'pad', dn: dn, cl: VALVE_DATA[vty]?.pn||16, qt: qt, df: _chDf,
    parts: [{nm: r.tip==='vana'?'Ceket':'YastÄ±k', ov:{}, calc:{
      mc: r.mc?.malzeme||0, lc: r.mc?.iscilik||0, uc: r.mc?.toplam||0, us: r.mc?.satis||0, tS: (r.mc?.satis||0)*qt,
      fab: r.altK||r.dolgu||0, fil: r.dolgu||0, sew: r.dikis||r.dikis_m||0, vlc: r.cirt||0, drw: r.bogm||0,
      ag: r.agAd||0, pl: r.pulAd||0, S: r.S1||r.We||0, T: r.T1||r.He||0
    }, matOv:{}}],
    mh: desc,
    calc: { mc: r.mc?.malzeme||0, lc: r.mc?.iscilik||0, uc: r.mc?.toplam||0, us: r.mc?.satis||0, tS: (r.mc?.satis||0)*qt },
    _fromCalc: true,
  };
  IT.push(item); recalcAll(); toast(`"${desc}" fiyat listesine eklendi âœ“`,'ok');
  const plBtn=document.querySelector('button.slink[onclick*="\'pl\'"]');
  if(plBtn) setTimeout(()=>go('pl',plBtn),400);
}

function chHesaplaVana(){
  const D=$v('chD'),L=$v('chL'),H=$v('chH'); const Db_ham=$v('chDB')>0?$v('chDB'):D*0.5;
  const I=$v('chI'), pc=$v('chPC'), py=$v('chPY'), pr=$v('chPR');
  const lbx=$v('chLBX'), hc=parseFloat(P.hc)||250, mul=parseFloat(P.mul)||2.5; const df=_chDf;
  const fw=parseFloat(P.fw)||0.05, iw=parseFloat(P.iw)||0.05, sw=parseFloat(P.sw)||0.10;

  const pAlt=chMpByName($s('chMFB')), pUst=chMpByName($s('chMFT'));
  const pFil=chMpByName($s('chMFL')), pCirt=chMpByName($s('chMVL'));
  const pBog=chMpByName($s('chMDS')), pDik=chMpByName($s('chMST'));
  const pAgr=chMpByName($s('chMSP')), pPul=chMpByName($s('chMND')), pTok=chMpByName($s('chMBK'));

  const D1=D+2*I, Db=Db_ham+2*I;
  const S1=D1*Math.PI+pc, T1=L+2*py, S2=Db*Math.PI+pc, T2=H;
  const A1=S1*T1, A2=S2*T2, A_m2=(A1+A2)/1e6;

  const altK=A_m2*(1+fw), ustK=A_m2*(1+fw), dolgu=A_m2*(1+iw);
  const cirt=(2*T1+2*T2)/1000;
  const bgG=(D1*Math.PI+pr)/1000, bgB=(Db*Math.PI+pr)/1000;
  const bogAdet=H>100?4:3, bogm=bgG*2+(H>100?bgB*2:bgB);
  const cevG=2*S1+2*T1, cevB=2*T2+S2, kap=S1-S2, dikis=((cevG+cevB+kap)/1000)*(1+sw);
  const agAd=Math.max(2,Math.round(D/60)), pulAd=agAd*2, tokAd=Math.max(1,Math.round(Db*Math.PI/200));

  const mc={ altK:altK*pAlt, ustK:ustK*pUst, dolgu:dolgu*pFil, cirt:cirt*pCirt, bogm:bogm*pBog, dikis:dikis*pDik, agraf:agAd*pAgr, pul:pulAd*pPul, toka:tokAd*pTok };
  mc.malzeme=Object.values(mc).reduce((a,b)=>a+b,0);
  const is_sa=A_m2*lbx*df; mc.iscilik=is_sa*hc; mc.toplam=mc.malzeme+mc.iscilik; mc.satis=mc.toplam*mul;

  chRenderVana({D,L,H,Db_ham,I,pc,py,D1,Db,S1,T1,S2,T2,A_m2,altK,ustK,dolgu,cirt,bogm,bogAdet,dikis,agAd,pulAd,tokAd},{mc,is_sa,lbx,df,hc,mul},{pAlt,pUst,pFil,pCirt,pBog,pDik,pAgr,pPul,pTok});
  window._chLastResult={tip:'vana',D,L,H,D1,Db,S1,T1,S2,T2,A_m2,altK,ustK,dolgu,cirt,bogm,bogAdet,dikis,agAd,pulAd,tokAd,mc};
}

function chHesaplaPad(){
  const W=$v('chPW'),H_p=$v('chPH'),adet=$v('chPQ')||1;
  const I=$v('chI'),sm=$v('chPSM');
  const lbx=$v('chLBX'),hc=parseFloat(P.hc)||250,mul=parseFloat(P.mul)||2.5; const kenarli=_chKenar==='kenarli';
  const fw=parseFloat(P.fw)||0.05,iw=parseFloat(P.iw)||0.05,sw=parseFloat(P.sw)||0.10;

  const pAlt=chMpByName($s('chMFB')),pUst=chMpByName($s('chMFT'));
  const pFil=chMpByName($s('chMFL')),pDik=chMpByName($s('chMST'));
  const pAgr=chMpByName($s('chMSP')),pPul=chMpByName($s('chMND')),pTok=chMpByName($s('chMBK'));

  const We=W+2*sm,He=H_p+2*sm;
  const a_yuz=We*He/1e6; const a_kenar=kenarli?(2*We*I+2*He*I)/1e6:0;
  const A=a_yuz*2+a_kenar;

  const altK=(a_yuz+a_kenar/2)*(1+fw), ustK=(a_yuz+a_kenar/2)*(1+fw), dolgu=a_yuz*(1+iw);
  const dikis_m=((2*(We+He))/1000)*(1+sw);
  const agAd=Math.max(2,Math.round(2*(W+H_p)/300)), pulAd=agAd*2, tokAd=(W>600||H_p>600)?4:2;

  const mc_b={ altK:altK*pAlt,ustK:ustK*pUst,dolgu:dolgu*pFil,dikis:dikis_m*pDik,agraf:agAd*pAgr,pul:pulAd*pPul,toka:tokAd*pTok };
  mc_b.malzeme=Object.values(mc_b).reduce((a,b)=>a+b,0);
  const is_sa=A*lbx; mc_b.iscilik=is_sa*hc; mc_b.toplam=mc_b.malzeme+mc_b.iscilik; mc_b.satis=mc_b.toplam*mul;
  const mc_t={malzeme:mc_b.malzeme*adet,iscilik:mc_b.iscilik*adet,toplam:mc_b.toplam*adet,satis:mc_b.satis*adet};

  chRenderPad({W,H_p,We,He,a_yuz,a_kenar,A,kenarli,altK,ustK,dolgu,dikis_m,agAd,pulAd,tokAd,adet},{mc_b,mc_t,is_sa,lbx,hc,mul},{pAlt,pUst,pFil,pDik,pAgr,pPul,pTok});
  window._chLastResult={tip:'pad',W,H_p:H_p,We,He,a_yuz,a_kenar,A,kenarli,altK,ustK,dolgu,dikis_m,agAd,pulAd,tokAd,adet,mc:mc_t};
}

function chRenderVana(g,c,p){
  const {mc,is_sa,lbx,df,hc,mul}=c;
  const kpi=(v,l,s,col)=>`<div class="cd" style="padding:14px;text-align:center; border:1px solid ${col}; background:var(--bg-pane);"><div style="font-size:1.15rem;font-weight:900;color:${col}">${v}</div><div style="font-size:.65rem;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--tx-main);margin-top:6px">${l}</div><div style="font-size:.6rem;color:var(--tx-mut);margin-top:2px;font-weight:700">${s}</div></div>`;
  const row=(lbl,q,bp,tot)=>`<tr><td style="padding:8px 16px;font-size:.75rem;font-weight:700;color:var(--tx-main);border-bottom:1px solid var(--brd)">${lbl}</td><td style="padding:8px 16px;text-align:right;font-size:.72rem;font-weight:800;color:var(--cy);border-bottom:1px solid var(--brd)">${q}</td><td style="padding:8px 16px;text-align:right;font-size:.66rem;font-weight:700;color:var(--tx-mut);border-bottom:1px solid var(--brd)">${bp}</td><td style="padding:8px 16px;text-align:right;font-weight:800;font-size:.75rem;color:var(--gn);border-bottom:1px solid var(--brd)">â‚º${chFmt(tot)}</td></tr>`;
  const grp=lbl=>`<tr><td colspan="4" style="padding:6px 16px;font-size:.6rem;font-weight:900;letter-spacing:1.2px;text-transform:uppercase;color:var(--ac);background:rgba(99,102,241,.06);border-bottom:1px solid var(--brd)">${lbl}</td></tr>`;
  const sec=(label)=>{const e=document.getElementById('chVT');return e&&e.value?`${VALVE_DATA[e.value]?.desc||''} â€” DN${document.getElementById('chVDN')?.value||'Manuel'}`:label};

  document.getElementById('chResults').innerHTML=`
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:20px">
      ${kpi(chFmt(g.A_m2,4)+' mÂ²','Toplam Alan','T-KalÄ±p','var(--cy)')}
      ${kpi('â‚º'+chFmt(mc.malzeme),'Malzeme','9 kalem','var(--rd)')}
      ${kpi('â‚º'+chFmt(mc.iscilik),'Ä°ÅŸÃ§ilik',chFmt(is_sa,3)+' sa Ã— df'+df,'var(--am)')}
      ${kpi('â‚º'+chFmt(mc.satis),'SatÄ±ÅŸ FiyatÄ±','Ã—'+mul,'var(--gn)')}
    </div>
    <div class="cd" style="padding:0;overflow:hidden;margin-bottom:14px;background:var(--bg-pane)">
      <div style="background:var(--bg-card);padding:14px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--brd)">
        <span style="font-weight:900;font-size:.85rem;color:var(--tx-main)">Malzeme ReÃ§etesi & Maliyet</span>
        <span style="font-size:.7rem;font-weight:700;color:var(--tx-mut)">${sec('Vana Ceketi')} Â· ${chFmt(g.A_m2,5)} mÂ²</span>
      </div>
      <table style="width:100%;border-collapse:collapse">
        <thead><tr style="background:var(--bg-inp)">
          <th style="padding:8px 16px;font-size:.65rem;font-weight:900;text-transform:uppercase;color:var(--tx-mut);text-align:left;border-bottom:1px solid var(--brd)">Kalem</th>
          <th style="padding:8px 16px;font-size:.65rem;text-align:right;color:var(--tx-mut);border-bottom:1px solid var(--brd)">Miktar</th>
          <th style="padding:8px 16px;font-size:.65rem;text-align:right;color:var(--tx-mut);border-bottom:1px solid var(--brd)">Birim Fiyat</th>
          <th style="padding:8px 16px;font-size:.65rem;text-align:right;color:var(--tx-mut);border-bottom:1px solid var(--brd)">Tutar</th>
        </tr></thead>
        <tbody>
          ${grp('KUMAÅLAR')}
          ${row('Alt KumaÅŸ (iÃ§ yÃ¼zey)',chFmt(g.altK,4)+' mÂ²','â‚º'+chFmt(p.pAlt)+'/mÂ²',mc.altK)}
          ${row('Ãœst KumaÅŸ (dÄ±ÅŸ yÃ¼zey)',chFmt(g.ustK,4)+' mÂ²','â‚º'+chFmt(p.pUst)+'/mÂ²',mc.ustK)}
          ${grp('DOLGU')}
          ${row('Ä°zolasyon Malzeme',chFmt(g.dolgu,4)+' mÂ²','â‚º'+chFmt(p.pFil)+'/mÂ²',mc.dolgu)}
          ${grp('BAÄLANTI & DÄ°KÄ°Å')}
          ${row('CÄ±rt Bant',chFmt(g.cirt,3)+' m','â‚º'+chFmt(p.pCirt)+'/m',mc.cirt)}
          ${row(`BoÄŸma Ä°pi (${g.bogAdet} boÄŸaz)`,chFmt(g.bogm,3)+' m','â‚º'+chFmt(p.pBog)+'/m',mc.bogm)}
          ${row('DikiÅŸ Ä°pi',chFmt(g.dikis,3)+' m','â‚º'+chFmt(p.pDik)+'/m',mc.dikis)}
          ${grp('AGRAF Â· PUL Â· TOKA')}
          ${row('Agraf Seti',g.agAd+' takÄ±m','â‚º'+chFmt(p.pAgr)+'/ad',mc.agraf)}
          ${row('Pul',g.pulAd+' adet','â‚º'+chFmt(p.pPul)+'/ad',mc.pul)}
          ${row('Toka',g.tokAd+' adet','â‚º'+chFmt(p.pTok)+'/ad',mc.toka)}
        </tbody>
        <tfoot>
          <tr style="background:rgba(245,158,11,.07)"><td colspan="3" style="padding:10px 16px;font-weight:800;font-size:.75rem;color:var(--tx-main)">TOPLAM MALZEME</td><td style="padding:10px 16px;text-align:right;color:var(--am);font-weight:900;font-size:.8rem">â‚º${chFmt(mc.malzeme)}</td></tr>
          <tr style="background:rgba(6,182,212,.07)"><td colspan="3" style="padding:10px 16px;font-weight:800;font-size:.75rem;color:var(--tx-main)">Ä°ÅÃ‡Ä°LÄ°K (${chFmt(is_sa,3)} sa Ã— â‚º${chFmt(hc)} Ã— df${df})</td><td style="padding:10px 16px;text-align:right;color:var(--cy);font-weight:900;font-size:.8rem">â‚º${chFmt(mc.iscilik)}</td></tr>
          <tr style="background:rgba(99,102,241,.1)"><td colspan="3" style="padding:12px 16px;font-weight:900;font-size:.85rem;color:var(--tx-main)">TOPLAM MALÄ°YET</td><td style="padding:12px 16px;text-align:right;color:var(--ac);font-weight:900;font-size:.95rem">â‚º${chFmt(mc.toplam)}</td></tr>
          <tr style="background:rgba(16,185,129,.15)"><td colspan="3" style="padding:14px 16px;font-weight:900;font-size:.9rem;color:var(--tx-main)">SATIÅ FÄ°YATI Ã—${mul}</td><td style="padding:14px 16px;text-align:right;color:var(--gn);font-weight:900;font-size:1.15rem">â‚º${chFmt(mc.satis)}</td></tr>
        </tfoot>
      </table>
    </div>`;
  lucide.createIcons();
}

function chRenderPad(g,c,p){
  const {mc_b,mc_t,is_sa,lbx,hc,mul}=c;
  const kpi=(v,l,s,col)=>`<div class="cd" style="padding:14px;text-align:center; border:1px solid ${col}; background:var(--bg-pane);"><div style="font-size:1.15rem;font-weight:900;color:${col}">${v}</div><div style="font-size:.65rem;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--tx-main);margin-top:6px">${l}</div><div style="font-size:.6rem;color:var(--tx-mut);margin-top:2px;font-weight:700">${s}</div></div>`;
  const row=(lbl,q,bp,tot)=>`<tr><td style="padding:8px 16px;font-size:.75rem;font-weight:700;color:var(--tx-main);border-bottom:1px solid var(--brd)">${lbl}</td><td style="padding:8px 16px;text-align:right;font-size:.72rem;font-weight:800;color:var(--cy);border-bottom:1px solid var(--brd)">${q}</td><td style="padding:8px 16px;text-align:right;font-size:.66rem;font-weight:700;color:var(--tx-mut);border-bottom:1px solid var(--brd)">${bp}</td><td style="padding:8px 16px;text-align:right;font-weight:800;font-size:.75rem;color:var(--gn);border-bottom:1px solid var(--brd)">â‚º${chFmt(tot)}</td></tr>`;
  const ktag=g.kenarli?'KenarlÄ± âŠ¡':'KenarsÄ±z â–­';

  document.getElementById('chResults').innerHTML=`
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:20px">
      ${kpi(chFmt(g.A,4)+' mÂ²','Alan (birim)',ktag,'var(--cy)')}
      ${kpi('â‚º'+chFmt(mc_b.malzeme),'Malzeme (birim)','Ã—'+g.adet+' = â‚º'+chFmt(mc_t.malzeme),'var(--rd)')}
      ${kpi('â‚º'+chFmt(mc_b.iscilik),'Ä°ÅŸÃ§ilik (birim)',chFmt(is_sa,3)+' sa','var(--am)')}
      ${kpi('â‚º'+chFmt(mc_t.satis),'Toplam SatÄ±ÅŸ',g.adet+' ad Ã— â‚º'+chFmt(mc_b.satis),'var(--gn)')}
    </div>
    <div class="cd" style="padding:0;overflow:hidden;background:var(--bg-pane)">
      <div style="background:var(--bg-card);padding:14px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--brd)">
        <span style="font-weight:900;font-size:.85rem;color:var(--tx-main)">YastÄ±k ReÃ§etesi â€” ${ktag}</span>
        <span style="font-size:.7rem;font-weight:700;color:var(--tx-mut)">${g.adet} adet Â· ${g.W}Ã—${g.H_p}mm</span>
      </div>
      <table style="width:100%;border-collapse:collapse">
        <thead><tr style="background:var(--bg-inp)">
          <th style="padding:8px 16px;font-size:.65rem;font-weight:900;text-transform:uppercase;color:var(--tx-mut);text-align:left;border-bottom:1px solid var(--brd)">Kalem</th>
          <th style="padding:8px 16px;font-size:.65rem;text-align:right;color:var(--tx-mut);border-bottom:1px solid var(--brd)">Miktar</th>
          <th style="padding:8px 16px;font-size:.65rem;text-align:right;color:var(--tx-mut);border-bottom:1px solid var(--brd)">Birim Fiyat</th>
          <th style="padding:8px 16px;font-size:.65rem;text-align:right;color:var(--tx-mut);border-bottom:1px solid var(--brd)">Birim Tutar</th>
        </tr></thead>
        <tbody>
          ${g.kenarli?`<tr style="background:rgba(16,185,129,.06)"><td colspan="3" style="padding:6px 16px;font-size:.65rem;font-weight:800;color:var(--gn)">+ Kenar ÅŸerit (${chFmt(g.a_kenar,5)} mÂ²)</td><td style="padding:6px 16px;text-align:right;color:var(--gn);font-size:.65rem;font-weight:800;">eklendi âœ“</td></tr>`:''}
          ${row('Alt KumaÅŸ',chFmt(g.altK,4)+' mÂ²','â‚º'+chFmt(p.pAlt)+'/mÂ²',mc_b.altK)}
          ${row('Ãœst KumaÅŸ',chFmt(g.ustK,4)+' mÂ²','â‚º'+chFmt(p.pUst)+'/mÂ²',mc_b.ustK)}
          ${row('Dolgu',chFmt(g.dolgu,4)+' mÂ²','â‚º'+chFmt(p.pFil)+'/mÂ²',mc_b.dolgu)}
          ${row('DikiÅŸ Ä°pi',chFmt(g.dikis_m,3)+' m','â‚º'+chFmt(p.pDik)+'/m',mc_b.dikis)}
          ${row('Agraf',g.agAd+' takÄ±m','â‚º'+chFmt(p.pAgr)+'/ad',mc_b.agraf)}
          ${row('Pul',g.pulAd+' adet','â‚º'+chFmt(p.pPul)+'/ad',mc_b.pul)}
          ${row('Toka',g.tokAd+' adet','â‚º'+chFmt(p.pTok)+'/ad',mc_b.toka)}
        </tbody>
        <tfoot>
          <tr style="background:rgba(245,158,11,.07)"><td colspan="3" style="padding:10px 16px;font-weight:800;font-size:.75rem;color:var(--tx-main)">BÄ°RÄ°M MALZEME</td><td style="padding:10px 16px;text-align:right;color:var(--am);font-weight:900;font-size:.8rem">â‚º${chFmt(mc_b.malzeme)}</td></tr>
          <tr style="background:rgba(6,182,212,.07)"><td colspan="3" style="padding:10px 16px;font-weight:800;font-size:.75rem;color:var(--tx-main)">BÄ°RÄ°M Ä°ÅÃ‡Ä°LÄ°K</td><td style="padding:10px 16px;text-align:right;color:var(--cy);font-weight:900;font-size:.8rem">â‚º${chFmt(mc_b.iscilik)}</td></tr>
          <tr style="background:rgba(99,102,241,.1)"><td colspan="3" style="padding:10px 16px;font-weight:800;font-size:.75rem;color:var(--tx-main)">BÄ°RÄ°M MALÄ°YET</td><td style="padding:10px 16px;text-align:right;color:var(--ac);font-weight:900;font-size:.8rem">â‚º${chFmt(mc_b.toplam)}</td></tr>
          <tr style="background:rgba(99,102,241,.15)"><td colspan="3" style="padding:12px 16px;font-weight:900;font-size:.85rem;color:var(--tx-main)">TOPLAM (${g.adet} adet)</td><td style="padding:12px 16px;text-align:right;color:var(--ac);font-weight:900;font-size:.95rem">â‚º${chFmt(mc_t.toplam)}</td></tr>
          <tr style="background:rgba(16,185,129,.15)"><td colspan="3" style="padding:14px 16px;font-weight:900;font-size:.9rem;color:var(--tx-main)">TOPLAM SATIÅ Ã—${mul}</td><td style="padding:14px 16px;text-align:right;color:var(--gn);font-weight:900;font-size:1.15rem">â‚º${chFmt(mc_t.satis)}</td></tr>
        </tfoot>
      </table>
    </div>`;
  lucide.createIcons();
}

// ====== DB & INIT ======
function updatePrefix(val) { P.prefix = val; document.getElementById('setPrefix').value=val; rPL(); rProd(); toast('Ã–n ek gÃ¼ncellendi', 'in'); saveData(); }

function extrapolateValue(dict, targetX) {
    let keys = Object.keys(dict).map(Number).filter(k => !isNaN(dict[k]) && dict[k] !== null).sort((a,b)=>a-b);
    if(keys.length === 0) return 0;
    if(keys.length === 1) return dict[keys[0]];
    if(keys.includes(targetX)) return dict[targetX];

    let lower = keys[0], upper = keys[keys.length-1];
    if (targetX <= lower) { lower = keys[0]; upper = keys[1]; } 
    else if (targetX >= upper) { lower = keys[keys.length-2]; upper = keys[keys.length-1]; }
    else {
        for(let i=0; i<keys.length; i++) {
            if(keys[i] < targetX) lower = keys[i];
            if(keys[i] > targetX) { upper = keys[i]; break; }
        }
    }
    if (lower === upper) return dict[lower];
    let y1 = dict[lower], y2 = dict[upper];
    let slope = (y2 - y1) / (upper - lower);
    let res = y1 + slope * (targetX - lower);
    return res > 0 ? res : 0; 
}

function initExtrapolation() {
    DN_LIST.forEach(dn => {
        if(!FD[dn]) FD[dn] = {};
        CLS.forEach(cl => {
            if(!FD[dn][cl]) {
                let classDict = {};
                Object.keys(FD).forEach(k => { if (k != dn && FD[k] && FD[k][cl]) classDict[k] = FD[k][cl]; });
                FD[dn][cl] = extrapolateValue(classDict, dn);
            }
        });
    });

    ['gate', 'globe', 'butterfly'].forEach(ty => {
        if(!BL[ty]) BL[ty] = {};
        DN_LIST.forEach(dn => {
            if(!BL[ty][dn]) BL[ty][dn] = {};
            CLS.forEach(cl => {
                if(!BL[ty][dn][cl]) {
                    ['L1', 'L1p', 'L2'].forEach(dim => {
                        let dimDict = {};
                        Object.keys(BL[ty]).forEach(k => {
                            if (k != dn && BL[ty][k] && BL[ty][k][cl] && typeof BL[ty][k][cl][dim] === 'number') dimDict[k] = BL[ty][k][cl][dim];
                        });
                        if(!BL[ty][dn][cl]) BL[ty][dn][cl] = {};
                        BL[ty][dn][cl][dim] = extrapolateValue(dimDict, dn);
                    });
                }
            });
        });
    });

    DN_LIST.forEach(dn => {
        let inch = DN_INCH[dn];
        if (inch && !AP[String(inch)]) {
            let aDict = {}, pDict = {};
            Object.keys(AP).forEach(k => {
                if (k != inch && AP[k]) { aDict[k] = AP[k].a; pDict[k] = AP[k].p; }
            });
            AP[String(inch)] = { a: Math.round(extrapolateValue(aDict, inch)), p: Math.round(extrapolateValue(pDict, inch)) };
        }
    });
}

window.onload=()=>{
 document.getElementById('themeBtn').innerHTML = `<i data-lucide="${currentTheme === 'dark' ? 'sun' : 'moon'}" class="w-4 h-4"></i>`;
 
 const D=EXCEL_DATA; P.usd=D.fx.USD; P.eur=D.fx.EUR;
 M=D.mat.map(m=>({...m})); M.forEach(m=>{if(m.k)TK[m.n]=m.k});
 FD={};for(const[dn,cls] of Object.entries(D.fd)){FD[parseInt(dn)]={};for(const[c,v] of Object.entries(cls))FD[parseInt(dn)][parseInt(c)]=v}
 
 // THE FATAL BUG FIX (#VALUE! CLEANSING)
 BL={};
 for(const[ty,tbl] of Object.entries(D.bl)){
   BL[ty]={};
   for(const[dn,cls] of Object.entries(tbl)){
     BL[ty][parseInt(dn)]={};
     for(const[c,v] of Object.entries(cls)){
       let obj = {};
       if(v && typeof v === 'object') {
           for(const [dim, val] of Object.entries(v)) {
               obj[dim] = (val === "#VALUE!" || isNaN(val)) ? null : parseFloat(val);
           }
       }
       BL[ty][parseInt(dn)][parseInt(c)] = obj;
     }
   }
 }
 AP=D.ap;
 
 try{const sv=JSON.parse(localStorage.getItem('optimizi_insjack_v5'));if(sv&&sv.IT){Object.assign(P,sv.P||{});M=sv.M||M;IT=sv.IT||[];FD=sv.FD||FD;BL=sv.BL||BL;AP=sv.AP||AP;TK=sv.TK||TK;SVC=sv.SVC||SVC;plQty=sv.plQty||{};curShow=sv.curShow||curShow;if(sv.PERS)PERS=sv.PERS;if(sv.PP)PP=sv.PP;RN=sv.RN||(Math.max(...IT.map(i=>i.ref),0)+1);if(sv.colVis)colVis=sv.colVis;}}catch(e){}
 
 try { initExtrapolation(); } catch(e) { console.error('Extrapolate Error', e) }
 try { rPers(); } catch(e) { console.error('Pers Error', e) }
 
 document.getElementById('setPrefix').value = P.prefix;
 document.getElementById('prefInput').value = P.prefix;
 
 try { 
   rPar(); rMat(); rGlobal(); updDN(); recalcAll(); rVRef(); applyColVis(); rColSettings(); 
 } catch(e) { 
   console.error("Render Error:", e);
 }
 
 fetchKur(); 
 lucide.createIcons();
}

function saveData(){localStorage.setItem('optimizi_insjack_v5',JSON.stringify({P,M,IT,FD,BL,AP,TK,SVC,plQty,curShow,PERS,PP,RN,colVis}));toast('Sistem veritabanÄ± yedeÄŸi alÄ±ndÄ±');}

</script>
</body>
</html>
