<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Endüstriyel İzolasyon Yatırımı Amortisman Hesaplama</title>
<meta name="description" content="ISO 12241 standardına göre boru, vana ve tank yüzeylerinden ısı kaybını hesaplayın.">

<link rel="icon" type="image/png" href="favicon.png">
  <!-- AUTH GUARD - Sayfa Koruma -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/auth-guard.js"></script>
    
    <!-- Flash Problemi Çözümü -->
    <style>
      body {
        opacity: 0;
        visibility: hidden;
      }
      body.auth-checked {
        opacity: 1;
        visibility: visible;
        transition: opacity 0.3s ease;
      }
    </style>
</head>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- Supabase JS Library -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Authentication Guard -->
<script src="/auth-guard.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
      extend: {
        colors: { slate: { 850: '#151e2e', 900: '#0f172a', 950: '#020617' } },
        animation: { 'float-slow': 'float 8s ease-in-out infinite', 'blob': 'blob 20s infinite', },
        keyframes: {
            float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' }, },
            blob: { '0%': { transform: 'translate(0px, 0px) scale(1)' }, '33%': { transform: 'translate(30px, -50px) scale(1.1)' }, '66%': { transform: 'translate(-20px, 20px) scale(0.9)' }, '100%': { transform: 'translate(0px, 0px) scale(1)' }, }
        }
      }
    }
  }
</script>
<style>
  :root {
      --bg-color: #f1f5f9; 
      --glass-bg: #ffffff;
      --glass-border: rgba(148, 163, 184, 0.4);
      --input-bg: #f8fafc;
      --input-border: #cbd5e1;
      --text-main: #0f172a; 
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --grid-color: rgba(0, 0, 0, 0.05);
  }

  .dark {
      --bg-color: #0f172a;
      --glass-bg: rgba(30, 41, 59, 0.4);
      --glass-border: rgba(255, 255, 255, 0.08);
      --input-bg: rgba(15, 23, 42, 0.6);
      --input-border: rgba(255, 255, 255, 0.1);
      --text-main: #f1f5f9;
      --card-shadow: none;
      --grid-color: rgba(255, 255, 255, 0.03);
  }

  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #64748b; }
  
  html { scroll-behavior: smooth; }
  
  body { 
      background-color: var(--bg-color); 
      color: var(--text-main); 
      overflow-x: hidden; 
      transition: background-color 0.3s ease, color 0.3s ease;
  }
  
  .app-container { max-width: 1600px; margin: 0 auto; width: 100%; }

  .glass-card { 
      transition: all 0.3s ease; 
      background-color: var(--glass-bg); 
      backdrop-filter: blur(16px); 
      border: 1px solid var(--glass-border); 
      box-shadow: var(--card-shadow);
  }
  
  .glass-input { 
      transition: all 0.2s; 
      border-radius: 0.5rem; 
      padding: 0.6rem 0.75rem; 
      width: 100%; 
      background-color: var(--input-bg); 
      border: 1px solid var(--input-border); 
      color: var(--text-main); 
  }
  .glass-input:focus { outline: none; border-color: #ef4444; box-shadow: 0 0 0 2px rgba(239,68,68,0.1); }
  .glass-input:disabled { opacity: 0.5; cursor: not-allowed; }

  .bg-grid { 
      background-size: 40px 40px; 
      background-image: 
          linear-gradient(to right, var(--grid-color) 1px, transparent 1px), 
          linear-gradient(to bottom, var(--grid-color) 1px, transparent 1px); 
      mask-image: radial-gradient(circle at center, black 70%, transparent 100%); 
      pointer-events: none; 
  }

  html:not(.dark) .blob-bg { display: none; }
  
  html.dark body {
      background: radial-gradient(ellipse at top, #1e1b4b 0%, #0f172a 40%, #020617 100%);
      background-attachment: fixed;
  }

  .grid-input {
      background: transparent;
      border: 1px solid transparent;
      border-radius: 4px;
      padding: 4px;
      width: 100%;
      text-align: center;
      transition: all 0.2s;
      font-weight: bold;
  }
  .grid-input:hover { border-color: #cbd5e1; background-color: rgba(255,255,255,0.1); }
  .grid-input:focus { border-color: #ef4444; background-color: rgba(255,255,255,0.2); outline: none; }

  html:not(.dark) .blob-bg { display: none; }
  
  html.dark body {
      background: radial-gradient(ellipse at top, #1e1b4b 0%, #0f172a 40%, #020617 100%);
      background-attachment: fixed;
  }

  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #64748b; }
  
  html { scroll-behavior: smooth; }
  
  body { 
      background-color: var(--bg-color); 
      color: var(--text-main); 
      overflow-x: hidden; 
      transition: background-color 0.3s ease, color 0.3s ease;
  }
  
  .table-container {
      max-height: 650px;
      overflow-y: auto;
      position: relative;
  }
  .table-sticky-header th {
      position: sticky;
      top: 0;
      z-index: 10;
  }
  html:not(.dark) .table-sticky-header th {
      background-color: #f1f5f9;
  }
  html.dark .table-sticky-header th {
      background-color: #1e293b;
  }

  /* Print Styles */
  @media print {
    @page { margin: 0; size: A4; }
    
    /* Dark mode'u print'te tamamen devre dışı bırak */
    html.dark, html.dark *, html.dark *::before, html.dark *::after { 
        background: white !important; 
        color: black !important; 
        border-color: #e5e7eb !important;
    }
    
    html, body { width: 210mm; height: 297mm; margin: 0 !important; padding: 0 !important; background: white !important; color: black !important; overflow: visible !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    #app-layer, nav, .glass-card, button, input, select { display: none !important; }
    #print-area { display: block !important; }
    .print-page { width: 210mm; height: 296mm; position: relative; page-break-after: always; overflow: hidden; background: white !important; }
    .print-page:last-child { page-break-after: auto; }
    
    .cover-bg { background-color: white !important; color: #1e293b !important; }
    
    .audit-table th { background-color: #f8fafc !important; color: #475569 !important; font-weight: 700; text-transform: uppercase; font-size: 7px; padding: 4px; border-bottom: 2px solid #0f172a !important; }
    .audit-table td { border-bottom: 1px solid #e2e8f0 !important; padding: 4px; font-size: 8px; color: #334155 !important; vertical-align: middle; }
    .audit-table tr:nth-child(even) { background-color: #f8fafc; }
  }
  #print-area { display: none; }
</style>
<script>
    // Dark mode kontrolü - sayfa render edilmeden önce çalışır (flickering önleme)
    (function() {
        const isDark = localStorage.getItem('darkMode') === 'true';
        if (isDark) {
            document.documentElement.classList.add('dark');
        }
    })();
</script>
</head>
<body class="antialiased selection:bg-red-500/30 selection:text-red-600" onload="initApp()">

<div class="fixed inset-0 z-0 pointer-events-none overflow-hidden">
    <div class="absolute inset-0 bg-grid"></div>
    <div class="blob-bg absolute top-20 left-20 w-96 h-96 bg-indigo-500/20 dark:bg-red-500/20 rounded-full filter blur-3xl animate-blob"></div>
    <div class="blob-bg absolute top-40 right-20 w-80 h-80 bg-purple-500/20 rounded-full filter blur-3xl animate-blob animation-delay-2000"></div>
    <div class="blob-bg absolute bottom-20 left-1/3 w-96 h-96 bg-pink-500/20 rounded-full filter blur-3xl animate-blob animation-delay-4000"></div>
</div>

<div id="app-layer" class="relative z-10 flex flex-col min-h-screen">
    <nav class="sticky top-0 z-50 glass-card !bg-white dark:bg-slate-800/50/90 dark:!bg-slate-900/40 !border-x-0 !border-t-0 !rounded-none border-b border-slate-200 dark:border-slate-700/50 backdrop-blur-xl">
      <div class="app-container px-6 h-16 flex items-center justify-between">
          <a href="#" class="flex items-center gap-3 group">
              <div><h1 class="text-lg font-bold text-slate-800 dark:text-slate-100 dark:text-slate-100 tracking-wide">Optimizi<span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 to-orange-500">.App</span></h1></div>
          </a>
          <div class="flex items-center gap-3">
              <div class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 text-xs text-slate-500 dark:text-slate-400">
                  <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                  <span id="fxVal" class="font-bold text-slate-800 dark:text-slate-100 dark:text-slate-200">...</span> <span class="text-[10px] opacity-70">TL/USD</span>
                  <button onclick="getFx()"><i data-lucide="refresh-cw" class="w-3 h-3 ml-1 hover:animate-spin text-slate-400 hover:text-indigo-500 dark:text-red-500 dark:hover:text-red-400 cursor-pointer"></i></button>
              </div>
              
              <label class="flex items-center gap-2 cursor-pointer bg-slate-100 dark:bg-slate-800/50 px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-700 hover:border-green-500 dark:hover:border-green-400 transition select-none">
                  <i data-lucide="qr-code" class="w-4 h-4 text-slate-500 dark:text-slate-400"></i>
                  <span class="text-[10px] font-bold text-slate-500 dark:text-slate-400">QR Göster</span>
                  <input type="checkbox" id="toggleQrInput" checked class="w-4 h-4 accent-green-500 cursor-pointer" onchange="toggleQrVisibility()">
              </label>

              <button onclick="toggleDarkMode()" class="flex items-center gap-2 cursor-pointer bg-slate-100 dark:bg-slate-800/50 px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-700 hover:border-indigo-500 dark:hover:border-red-500 transition">
                  <i data-lucide="sun" class="w-4 h-4 text-amber-500 dark:hidden"></i>
                  <i data-lucide="moon" class="w-4 h-4 text-indigo-400 hidden dark:block"></i>
                  <span class="text-[10px] font-bold text-slate-500 dark:text-slate-400 hidden md:inline">Tema</span>
              </button>

              <button onclick="printRep()" class="flex items-center gap-2 bg-indigo-600 dark:bg-red-600 hover:bg-indigo-500 dark:hover:bg-red-500 text-white px-4 py-2 rounded-lg text-xs font-bold transition shadow-lg shadow-indigo-600/20 dark:shadow-red-600/20 active:scale-95 ml-2 cursor-pointer">
                  <i data-lucide="printer" class="w-4 h-4"></i> Rapor Al
              </button>
          </div>
      </div>
    </nav>

    <main class="flex-1 app-container p-6 lg:p-8">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="glass-card p-6 relative overflow-hidden group rounded-2xl">
               <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition transform group-hover:scale-110"><i data-lucide="timer" class="w-24 h-24 text-indigo-500 dark:text-red-500 dark:text-red-500"></i></div>
               <div class="text-slate-500 dark:text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-2">Ort. Amortisman</div>
               <div class="text-4xl font-bold text-slate-800 dark:text-slate-100 dark:text-slate-100 tracking-tight" id="dashRoi">---</div>
               <div class="mt-4 h-1 w-full bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden"><div id="barRoi" class="h-full bg-indigo-500/20 dark:bg-red-500 w-0 transition-all duration-1000 shadow-[0_0_10px_rgba(99,102,241,0.5)] dark:shadow-[0_0_10px_rgba(239,68,68,0.5)]"></div></div>
            </div>
            <div class="glass-card p-6 relative overflow-hidden group rounded-2xl">
               <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition"><i data-lucide="wallet" class="w-24 h-24 text-green-500 dark:text-emerald-500"></i></div>
               <div class="text-slate-500 dark:text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-2">Yıllık Kazanç</div>
               <div class="text-3xl font-bold text-green-600 dark:text-emerald-400 tracking-tight" id="dashSave">0</div>
            </div>
            <div class="glass-card p-6 relative overflow-hidden rounded-2xl">
               <div class="text-slate-500 dark:text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-2">Toplam Yatırım</div>
               <div class="flex items-center gap-2">
                   <input type="number" id="manualTotalInv" class="text-2xl font-bold text-slate-800 dark:text-slate-100 dark:text-slate-100 tracking-tight bg-transparent border-b-2 border-slate-300 dark:border-slate-600 dark:border-slate-600 focus:border-indigo-500 dark:border-red-500 dark:focus:border-red-500 outline-none w-full" placeholder="Toplam Yatırım Girin" step="0.01" oninput="updateTotalInvestment()">
                   <select id="manualInvCurr" class="text-sm font-medium bg-slate-100 dark:bg-slate-800 dark:text-slate-200 border border-slate-300 dark:border-slate-600 dark:border-slate-600 rounded px-2 py-1" onchange="updateTotalInvestment()">
                       <option value="TL">₺</option>
                       <option value="USD">$</option>
                       <option value="EUR">€</option>
                   </select>
               </div>
               <div class="text-xs text-slate-500 dark:text-slate-400 mt-2">Otomatik: <span id="dashInv" class="font-bold">0</span></div>
            </div>
            <div class="glass-card p-6 !bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-800/40 dark:to-slate-900/40 border-orange-500/20 dark:border-orange-500/30 rounded-2xl">
               <div class="flex items-center justify-between">
                  <div>
                      <div class="text-orange-500 dark:text-orange-400 text-[10px] font-bold uppercase tracking-wider mb-1">CO2 Azaltım</div>
                      <div class="text-3xl font-bold text-slate-800 dark:text-slate-100 dark:text-slate-100" id="dashCo2">0 <span class="text-sm font-normal text-slate-500 dark:text-slate-400">Ton</span></div>
                  </div>
                  <div class="p-3 bg-orange-500/10 dark:bg-orange-500/20 rounded-xl text-orange-600 dark:text-orange-400 border border-orange-500/20 dark:border-orange-500/30"><i data-lucide="leaf" class="w-6 h-6"></i></div>
               </div>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-12 gap-8 items-start">
            <div class="xl:col-span-3 space-y-6 max-h-[calc(100vh-180px)] overflow-y-auto pr-2">
                <div class="glass-card p-6 rounded-2xl">
                   <h3 class="text-indigo-500 dark:text-red-500 dark:text-red-500 text-xs font-bold uppercase mb-4 flex items-center gap-2"><i data-lucide="briefcase" class="w-4 h-4"></i> Proje Detayları</h3>
                   <div class="space-y-4">
                       <div><label class="text-[10px] uppercase text-slate-500 dark:text-slate-400 font-bold mb-1 block">Hazırlayan</label><div class="grid gap-2"><input type="text" id="pName" class="glass-input text-xs" placeholder="Firma Adı"><input type="text" id="pEng" class="glass-input text-xs" placeholder="Mühendis Adı"></div></div>
                       <div>
                           <label class="text-[10px] uppercase text-slate-500 dark:text-slate-400 font-bold mb-1 block">Saha Denetim Tarihi</label>
                           <input type="date" id="auditDate" class="glass-input text-xs text-slate-600 dark:text-slate-300 dark:text-slate-300">
                       </div>
                       <div class="h-px bg-slate-200 dark:bg-slate-700 my-3"></div>
                       <div><label class="text-[10px] uppercase text-slate-500 dark:text-slate-400 font-bold mb-1 block">Firma Bilgileri</label><div class="grid gap-2"><input type="text" id="cName" class="glass-input text-xs" placeholder="Firma Adı"><input type="text" id="cEng" class="glass-input text-xs" placeholder="Yetkili Kişi / Ünvan"></div></div>
                   </div>
                </div>

                <div class="glass-card p-6 rounded-2xl">
                    <h3 class="text-orange-500 dark:text-orange-400 text-xs font-bold uppercase mb-4 flex items-center gap-2"><i data-lucide="flame" class="w-4 h-4"></i> Ortam & Enerji</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">Ortam Sıc. (°C)</label><input type="number" id="tAmb" class="glass-input text-xs" value="25"></div>
                        <div><label class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">Rüzgar (m/s)</label><input type="number" id="vWind" class="glass-input text-xs" value="0" step="0.5"></div>
                    </div>
                    
                    <div class="mt-4">
                        <label class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">Yakıt Tipi</label>
                        <select id="fuel" onchange="toggleFuelMode()" class="glass-input text-xs">
                             <option value="gas">Doğalgaz (8250 kcal/m³)</option>
                             <option value="elec">Elektrik (860 kcal/kWh)</option>
                             <option value="lng">LNG (11500 kcal/kg)</option>
                             <option value="fueloil">Fuel Oil (9600 kcal/kg)</option>
                             <option value="coal_imp">İthal Kömür (6000 kcal/kg)</option>
                             <option value="coal_loc">Yerli Kömür (3500 kcal/kg)</option>
                             <option value="manual" class="font-bold text-indigo-500 dark:text-red-500 dark:text-red-500">⚡ Manuel Giriş</option>
                        </select>
                    </div>

                    <div id="manualFuelBox" class="hidden mt-3 p-3 rounded-lg bg-slate-50 dark:bg-slate-900 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700">
                         <div class="grid grid-cols-2 gap-3">
                             <div>
                                 <label class="text-[9px] text-indigo-500 dark:text-red-500 dark:text-red-500 font-bold mb-1 block">LHV (kcal)</label>
                                 <input type="number" id="fuelLhv" class="glass-input text-xs" placeholder="Örn: 8250">
                             </div>
                             <div>
                                 <label class="text-[9px] text-indigo-500 dark:text-red-500 font-bold mb-1 block">Birim</label>
                                 <select id="fuelUnit" class="glass-input text-xs">
                                     <option value="m3">kcal/m³</option>
                                     <option value="kg">kcal/kg</option>
                                     <option value="kwh">kcal/kWh</option>
                                 </select>
                             </div>
                         </div>
                    </div>
                    
                    <div class="mt-4">
                        <label class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">Kazan Verimi %</label>
                        <input type="number" id="eff" class="glass-input text-center text-xs" value="85">
                    </div>

                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div>
                            <label class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">Birim Fiyat</label>
                            <div class="flex gap-1"><input type="number" id="price" class="glass-input text-xs" value="0.15"><select id="energyCurr" class="glass-input !px-1 w-14 text-center text-xs"><option value="TL" selected>₺</option><option value="USD">$</option><option value="EUR">€</option></select></div>
                        </div>
                        <div><label class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">Yıllık Saat</label><input type="number" id="hours" class="glass-input text-xs" value="8000"></div>
                    </div>
                </div>

                <div id="packagePanel" class="hidden glass-card p-6 rounded-2xl border-2 border-indigo-500 dark:border-red-500/50 bg-indigo-50/50">
                    <div class="flex justify-between items-start mb-4">
                         <h3 class="text-indigo-600 dark:text-red-600 text-sm font-bold uppercase flex items-center gap-2">
                             <i data-lucide="package" class="w-5 h-5"></i> Paket Oluşturucu
                         </h3>
                         <div class="bg-indigo-200 text-indigo-700 text-[10px] font-bold px-2 py-1 rounded">MOD AKTİF</div>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="bg-white dark:bg-slate-800/50 rounded-lg p-3 max-h-40 overflow-y-auto border border-slate-200 dark:border-slate-700">
                            <ul id="pkgList" class="space-y-2 text-xs">
                                <li class="text-slate-400 text-center italic py-2">Henüz sepete ürün eklenmedi.</li>
                            </ul>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 text-[10px]">
                            <div class="text-slate-500 dark:text-slate-400">Sepet Toplamı:</div>
                            <div class="text-right font-bold text-slate-800 dark:text-slate-100" id="pkgTotalQty">0 Parça</div>
                            <div class="text-slate-500 dark:text-slate-400">Potansiyel Kazanç:</div>
                            <div class="text-right font-bold text-green-600" id="pkgTotalSave">0 ₺</div>
                        </div>

                        <div class="pt-3 border-t border-indigo-200">
                            <label class="text-[10px] text-indigo-600 dark:text-red-600 font-bold block mb-1">Paket Adı</label>
                            <input type="text" id="pkgName" class="glass-input text-xs mb-2" placeholder="Örn: Kazan Dairesi Seti">
                            
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div>
                                    <label class="text-[10px] text-indigo-600 dark:text-red-600 font-bold block mb-1">Paket Adedi</label>
                                    <input type="number" id="pkgQty" class="glass-input text-center text-xs font-bold" value="1" placeholder="Adet">
                                </div>
                                <div>
                                    <label class="text-[10px] text-indigo-600 dark:text-red-600 font-bold block mb-1">Paket Foto</label>
                                    <input type="file" id="pkgImgInp" class="hidden" accept="image/*" onchange="readPkgImg(this)">
                                    <button onclick="document.getElementById('pkgImgInp').click()" class="w-full h-[34px] glass-input text-xs flex items-center justify-center gap-2 hover:bg-slate-100 dark:bg-slate-800 transition"><i data-lucide="camera" class="w-3 h-3"></i> Seç</button>
                                </div>
                            </div>
                            <img id="pkgPrevImg" class="hidden w-full h-16 object-cover rounded-lg mb-2 border border-indigo-200">

                            <label class="text-[10px] text-indigo-600 dark:text-red-600 font-bold block mb-1">Paket (Birim) Yatırım Bedeli</label>
                            <div class="flex gap-1 mb-3">
                                <input type="number" id="pkgInv" class="glass-input text-xs" placeholder="Birim Set Tutar">
                                <select id="pkgInvCurr" class="glass-input !px-1 w-14 text-center text-xs">
                                    <option value="TL">₺</option>
                                    <option value="USD">$</option>
                                    <option value="EUR">€</option>
                                </select>
                            </div>
                            
                            <button onclick="commitPackage()" class="w-full bg-indigo-600 dark:bg-red-600 hover:bg-indigo-500 dark:hover:bg-red-500 text-white font-bold py-2 rounded-lg text-xs shadow transition active:scale-95">Paketi Tamamla & Listeye Ekle</button>
                        </div>
                    </div>
                </div>
                <div class="glass-card p-6 border-indigo-500 dark:border-red-500/30 shadow-[0_0_20px_rgba(99,102,241,0.1)] rounded-2xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-indigo-500/20 dark:bg-red-500/10 rounded-full blur-2xl -mr-16 -mt-16 pointer-events-none"></div>
                    
                    <div class="flex justify-between items-center mb-4 relative z-10">
                        <h3 class="text-slate-800 dark:text-slate-100 text-sm font-bold uppercase flex items-center gap-2"><i data-lucide="plus-circle" class="w-4 h-4 text-indigo-500 dark:text-red-500"></i> Yeni Ölçüm Ekle</h3>
                        <button onclick="togglePackageMode()" id="btnTogglePkg" class="text-[10px] bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-3 py-1 rounded-full hover:bg-indigo-100 dark:hover:bg-red-900/30 hover:text-indigo-600 dark:hover:text-red-400 transition font-bold flex items-center gap-1"><i data-lucide="box" class="w-3 h-3"></i> Paket Modunu Aç</button>
                    </div>
                    
                    <div class="flex bg-slate-100 dark:bg-slate-800 rounded-lg p-1 mb-4 border border-slate-200 dark:border-slate-700 relative z-10">
                        <button onclick="setType('valve')" id="btn-valve" class="flex-1 py-1.5 text-xs font-medium rounded text-white bg-slate-700 shadow transition-all">Armatür</button>
                        <button onclick="setType('pipe')" id="btn-pipe" class="flex-1 py-1.5 text-xs font-medium rounded text-slate-500 dark:text-slate-400 hover:text-slate-900 transition-all">Boru</button>
                        <button onclick="setType('tank')" id="btn-tank" class="flex-1 py-1.5 text-xs font-medium rounded text-slate-500 dark:text-slate-400 hover:text-slate-900 transition-all">Tank/Düz</button>
                    </div>
                    <select id="type" class="hidden"><option value="valve">Valve</option><option value="pipe">Pipe</option><option value="tank">Flat</option></select>
                    
                    <div id="g-valve" class="space-y-3 relative z-10">
                        <select id="valveType" class="glass-input text-xs">
                            <optgroup label="Vanalar">
                                <option value="gate">Sürgülü Vana</option>
                                <option value="globe">Glob Vana</option>
                                <option value="ball">Küresel Vana</option>
                                <option value="butterfly">Kelebek Vana</option>
                                <option value="check">Çekvalf</option>
                                <option value="strainer">Pislik Tutucu</option>
                                <option value="separator">Buhar Seperatörü</option>
                            </optgroup>
                            <optgroup label="Bağlantı Elemanları">
                                <option value="flange">Flanş Çifti (Takım)</option>
                                <option value="elbow">Dirsek (90°)</option>
                            </optgroup>
                            <optgroup label="Kondenstoplar">
                                <option value="trap_float">Şamandıralı</option>
                                <option value="trap_thermo">Termodinamik</option>
                                <option value="trap_bimetal">Bimetalik</option>
                                <option value="trap_bucket">Ters Kovalı</option>
                            </optgroup>
                        </select>
                        <select id="vDN" class="glass-input text-xs"></select>
                    </div>
                    <div id="g-pipe" class="hidden grid grid-cols-2 gap-3 relative z-10"><select id="pDN" class="glass-input text-xs"></select><input type="number" id="pLen" class="glass-input text-xs" placeholder="Boru Uzunluğu (m)" value="1"></div>
                    
                    <div id="g-tank" class="hidden relative z-10">
                        <div class="bg-slate-50 dark:bg-slate-900 p-3 rounded-lg border border-slate-200 dark:border-slate-700 mb-3">
                            <label class="text-[10px] text-slate-500 dark:text-slate-400 mb-2 block font-bold">1. Seçenek: Dikdörtgen Yüzey</label>
                            <div class="flex gap-2 mb-2">
                                <input type="number" id="surfW" class="glass-input text-xs" placeholder="En (cm)">
                                <input type="number" id="surfH" class="glass-input text-xs" placeholder="Boy (cm)">
                                <button onclick="addSurface('rect')" class="bg-indigo-500/20 dark:bg-red-500 hover:bg-indigo-600 dark:bg-red-600 text-white rounded-lg px-3 flex items-center justify-center transition"><i data-lucide="plus" class="w-4 h-4"></i></button>
                            </div>

                            <label class="text-[10px] text-slate-500 dark:text-slate-400 mb-2 block font-bold border-t border-slate-200 dark:border-slate-700 pt-2 mt-2">2. Seçenek: Daire Yüzey</label>
                            <div class="flex gap-2 mb-2">
                                <input type="number" id="surfD" class="glass-input text-xs" placeholder="Çap (cm)">
                                <button onclick="addSurface('circle')" class="bg-indigo-500/20 dark:bg-red-500 hover:bg-indigo-600 dark:bg-red-600 text-white rounded-lg px-3 flex items-center justify-center transition"><i data-lucide="circle" class="w-4 h-4"></i></button>
                            </div>

                            <div id="surfaceList" class="space-y-1 mb-2 max-h-24 overflow-y-auto mt-2">
                                </div>
                            <div class="text-right text-[10px] text-slate-500 dark:text-slate-400 border-t border-slate-200 dark:border-slate-700 pt-2">
                                Toplam Alan: <span id="totalSurfArea" class="font-bold text-slate-800 dark:text-slate-100 text-xs">0.00</span> m²
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mt-4 relative z-10">
                        <div><label class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">İşletme Sıc. (°C)</label><div class="relative"><input type="number" id="tProc" class="glass-input pl-8 text-xs" value="160"><i data-lucide="thermometer" class="w-3 h-3 text-red-500 absolute left-2.5 top-2.5"></i></div></div>
                        <div><label id="lblQty" class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">Adet</label><input type="number" id="qty" class="glass-input text-center font-bold text-xs" value="1"></div>
                    </div>
                    
                    <div class="mt-4 relative z-10">
                         <label class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">Mahal / Lokasyon</label>
                         <input type="text" id="location" class="glass-input text-xs" placeholder="Örn: Kazan Dairesi">
                    </div>

                    <div class="mt-4 relative z-10">
                        <input type="file" id="imgInp" class="hidden" accept="image/*" onchange="readImg(this)">
                        <div onclick="document.getElementById('imgInp').click()" class="border border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-3 text-center cursor-pointer hover:border-indigo-500 dark:border-red-500 hover:bg-slate-100 dark:bg-slate-800 transition group"><i data-lucide="camera" class="w-4 h-4 text-slate-400 mx-auto group-hover:text-indigo-500 dark:text-red-500 mb-1"></i><span class="text-[10px] text-slate-400 block">Termal Foto Seç</span></div>
                        <img id="prevImg" class="hidden w-full h-24 object-cover rounded-lg mt-2 border border-slate-300 dark:border-slate-600">
                    </div>

                    <div class="mt-4 relative z-10">
                        <input type="file" id="qrInp" class="hidden" accept="image/*" onchange="readQr(this)">
                        <div onclick="document.getElementById('qrInp').click()" class="border border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-3 text-center cursor-pointer hover:border-green-500 hover:bg-slate-100 dark:bg-slate-800 transition group"><i data-lucide="qr-code" class="w-4 h-4 text-slate-400 mx-auto group-hover:text-green-500 mb-1"></i><span class="text-[10px] text-slate-400 block">Rapor QR'ı Yükle</span></div>
                    </div>

                    <div class="bg-slate-100 dark:bg-slate-800 rounded-lg p-3 mt-4 border border-slate-200 dark:border-slate-700 relative z-10">
                        <label class="text-[10px] text-green-600 font-bold uppercase mb-2 block">İzolasyon Özellikleri</label>
                        <div class="mb-2"><select id="calcStd" class="glass-input text-[10px] !py-1 !h-7 text-slate-500 dark:text-slate-400"><option value="iso">ISO 12241 (Standard)</option><option value="astm">ASTM C680 (USA)</option><option value="vdi">VDI 2055 (German)</option></select></div>
                        
                        <div class="text-[9px] text-slate-400 uppercase font-bold mb-1">1. Katman</div>
                        <select id="matSelect" class="glass-input text-xs mb-2">
                            <option value="rockwool">Taş Yünü (Sanayi)</option>
                            <option value="glasswool">İğnelenmiş Cam Elyaf</option> 
                            <option value="rubber">Elastomerik Kauçuk</option>
                            <option value="aerogel">Aerogel</option>
                            <option value="ceramic">Seramik Yünü</option>
                            <option value="bare" class="font-bold text-red-500">⚠️ Yalıtımsız (Çıplak)</option>
                        </select>
                        <div class="grid grid-cols-2 gap-2 mt-2 mb-2">
                            <input type="number" id="thk" class="glass-input text-xs" value="50" placeholder="Kalınlık (mm)">
                            <div id="singleInvBox">
                                <!-- Yatırım alanı kaldırıldı - Toplam Yatırım Bedeli bölümünden girilecek -->
                                <input type="hidden" id="inv" value="0">
                                <select id="invCurr" class="hidden">
                                    <option value="TL">₺</option>
                                    <option value="USD">$</option>
                                    <option value="EUR">€</option>
                                </select>
                            </div>
                        </div>

                        <div class="mt-2 pt-2 border-t border-slate-300 dark:border-slate-600">
                            <label class="flex items-center gap-2 cursor-pointer mb-2">
                                <input type="checkbox" id="useL2" onchange="toggleL2()" class="w-3 h-3 rounded border-slate-400 text-indigo-500 dark:text-red-500">
                                <span class="text-[10px] text-slate-500 dark:text-slate-400 font-bold">2. Katman Ekle (Kompozit)</span>
                            </label>
                            <div id="layer2Box" class="hidden">
                                <select id="matSelect2" class="glass-input text-xs mb-2">
                                    <option value="rubber" selected>Elastomerik Kauçuk</option>
                                    <option value="rockwool">Taş Yünü (Sanayi)</option>
                                    <option value="glasswool">İğnelenmiş Cam Elyaf</option>
                                    <option value="aerogel">Aerogel</option>
                                    <option value="ceramic">Seramik Yünü</option>
                                </select>
                                <input type="number" id="thk2" class="glass-input text-xs" value="19" placeholder="Kalınlık (mm)">
                            </div>
                        </div>

                        <div class="mt-3 text-right">
                            <label class="text-[9px] text-slate-500 dark:text-slate-400 mr-2 uppercase font-bold">Rapor Para Birimi:</label>
                            <select id="curr" class="glass-input text-[10px] !w-20 inline-block !py-1 !h-7" onchange="render()"><option value="TL" selected>₺ TL</option><option value="USD">$ USD</option><option value="EUR">€ EUR</option></select>
                        </div>
                    </div>

                    <div id="btn-group" class="mt-4 relative z-10">
                        <button id="btnAdd" onclick="calc()" class="w-full bg-indigo-600 dark:bg-red-600 hover:bg-indigo-500 dark:hover:bg-red-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-600/20 transition active:scale-95 flex items-center justify-center gap-2 text-sm cursor-pointer"><i data-lucide="plus" class="w-4 h-4"></i> <span id="btnAddText">Hesapla & Ekle</span></button>
                        <button id="btnUpdate" onclick="finishUpdate()" class="hidden w-full bg-orange-500 hover:bg-orange-400 text-white font-bold py-3 rounded-xl shadow-lg shadow-orange-500/20 transition active:scale-95 flex items-center justify-center gap-2 text-sm cursor-pointer"><i data-lucide="check" class="w-4 h-4"></i> Güncellemeyi Bitir</button>
                    </div>
                </div>
            </div>

            <div class="xl:col-span-9">
                <div class="glass-card p-0 overflow-hidden flex flex-col rounded-2xl h-[calc(100vh-100px)]">
                    <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900 shrink-0">
                        <h3 class="font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2"><i data-lucide="list" class="w-4 h-4 text-green-500"></i> Hesaplama Listesi</h3>
                        
                        <div class="flex gap-2">
                             <input type="file" id="csvInput" class="hidden" accept=".csv" onchange="importCSV(this)">
                             <button onclick="document.getElementById('csvInput').click()" class="flex items-center gap-1 text-[10px] bg-emerald-100 dark:bg-emerald-900/30 hover:bg-emerald-200 dark:hover:bg-emerald-900/50 text-emerald-700 dark:text-emerald-400 px-2 py-1 rounded transition cursor-pointer"><i data-lucide="upload" class="w-3 h-3"></i> Excel Yükle</button>
                             <button onclick="exportCSV()" class="flex items-center gap-1 text-[10px] bg-blue-100 dark:bg-blue-900/30 hover:bg-blue-200 dark:hover:bg-blue-900/50 text-blue-700 dark:text-blue-400 px-2 py-1 rounded transition cursor-pointer"><i data-lucide="download" class="w-3 h-3"></i> Excel İndir</button>
                             <div class="w-px h-4 bg-slate-300 dark:bg-slate-600 mx-1"></div>
                             <button onclick="clearAll()" class="text-xs text-red-500 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 transition cursor-pointer">Temizle</button>
                        </div>
                    </div>
                    <div class="overflow-auto flex-1 table-container">
                        <table class="w-full text-left text-sm" id="grid">
                        <thead class="table-sticky-header bg-slate-100 dark:bg-slate-800 text-[10px] uppercase text-slate-500 dark:text-slate-400 font-semibold shadow-sm">
                            <tr>
                            <th class="px-6 py-3 text-slate-600 dark:text-slate-300">Görsel</th>
                            <th class="px-6 py-3 text-slate-600 dark:text-slate-300">Ekipman</th>
                            <th class="px-6 py-3 text-slate-600 dark:text-slate-300">Detay</th>
                            <th class="px-6 py-3 text-center w-24 text-slate-600 dark:text-slate-300">Miktar</th>
                            <th class="px-6 py-3 text-center text-red-500 dark:text-red-400">Çıplak Yüzey Sıc.<br><span class="text-[9px]">(Kayıp kWh)</span></th>
                            <th class="px-6 py-3 text-center text-orange-500 dark:text-orange-400">İzolasyonlu Yüzey Sıc.<br><span class="text-[9px]">(Kayıp kWh)</span></th>
                            <th class="px-6 py-3 text-center text-green-600 dark:text-emerald-400">Kazanç<br><span class="text-[9px]">(Fark kWh)</span></th>
                            <th class="px-6 py-3 text-right w-32 text-slate-600 dark:text-slate-300">Yatırım</th><th class="px-6 py-3 text-right text-green-600 dark:text-emerald-400">Kazanç (Tutar)</th>
                            <th class="px-6 py-3 text-right text-slate-600 dark:text-slate-300">ROI</th><th class="px-6 py-3 text-right text-slate-600 dark:text-slate-300">İşlem</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200 dark:divide-slate-700" id="gridBody">
                            <tr><td colspan="11" class="px-6 py-20 text-center text-slate-500 dark:text-slate-400"><i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 opacity-20"></i><span id="emptyMsg">Henüz hesaplama eklenmedi.</span></td></tr>
                        </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="print-area">
    <div id="p-cover" class="print-page cover-bg relative overflow-hidden flex">
        <div class="w-1/3 bg-slate-900 text-white p-12 flex flex-col justify-between relative overflow-hidden">
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
            <div class="absolute top-0 right-0 w-64 h-64 bg-green-500 rounded-full blur-[100px] opacity-20 -mr-32 -mt-32"></div>
            
            <div class="relative z-10">
                <div class="text-3xl font-black tracking-tighter mb-1">Optimizi<span class="text-green-500">.App</span></div>
                <div class="text-[10px] uppercase tracking-[4px] text-slate-400">Engineering Solutions</div>
                
                <div class="mt-20 space-y-8">
                    <div>
                        <div class="text-[10px] uppercase text-slate-500 dark:text-slate-400 font-bold mb-1">Firma / Müşteri</div>
                        <div class="text-2xl font-bold text-white leading-tight" id="covClient">FİRMA ADI</div>
                        <div class="text-sm text-slate-400 mt-1" id="covContact">Yetkili Kişi</div>
                    </div>
                    <div>
                        <div class="text-[10px] uppercase text-slate-500 dark:text-slate-400 font-bold mb-1">Tedarikçi / Hazırlayan</div>
                        <div class="text-xl font-bold text-white" id="covProv">TEDARİKÇİ</div>
                    </div>
                    <div>
                        <div class="text-[10px] uppercase text-slate-500 dark:text-slate-400 font-bold mb-1">Rapor Tarihi</div>
                        <div class="text-xl font-bold text-white font-mono" id="covDate">...</div>
                    </div>
                </div>
            </div>

            <div class="relative z-10">
                <div class="p-4 bg-white dark:bg-slate-800/50/5 rounded-xl border border-white/10 backdrop-blur-sm">
                    <img id="covQrCode" src="" class="w-24 h-24 object-contain opacity-50 mb-2 mix-blend-screen" alt="QR">
                    <div class="text-[9px] text-slate-400 leading-tight">Mevcut ısı kayıplarının tesisinize anlık maliyetini takip etmek için kodu taratın.</div>
                </div>
            </div>
        </div>

        <div class="w-2/3 p-12 bg-white dark:bg-slate-800/50 flex flex-col relative">
             <div class="absolute top-0 right-0 p-12 opacity-5"><i data-lucide="activity" class="w-64 h-64 text-slate-900"></i></div>

             <div class="flex-1 flex flex-col justify-center relative z-10">
                <div class="inline-block bg-green-100 text-green-700 px-3 py-1 rounded text-[10px] font-bold uppercase tracking-wider w-max mb-4">ISO 12241 Temelli Isı Kaybı Kaynaklı Kayıp Simülasyonu</div>
                <h1 class="text-6xl font-black text-slate-900 leading-none mb-6">ENDÜSTRİYEL <br><span class="text-transparent bg-clip-text bg-gradient-to-r from-green-600 to-emerald-800">YALITIM</span> ANALİZİ</h1>
                
                <p class="text-sm text-slate-500 dark:text-slate-400 leading-relaxed mb-6 max-w-lg text-justify">
                    <span id="covIntroDate" class="font-bold text-slate-900">...</span> tarihinde tesisinizde gerçekleştirilen termal denetimler sonucunda; yalıtımsız ekipmanlardan kaynaklanan ısı kayıpları, finansal maliyetler ve karbon ayak izi hesaplanmıştır. Aşağıdaki veriler mevcut durumun özetidir.
                </p>

                <div class="flex flex-col gap-3 mb-6">
                    <div class="p-3 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-100 flex items-center justify-between">
                         <div class="text-xs font-bold text-slate-400 uppercase tracking-wide w-24">GÜNLÜK</div>
                         <div class="text-xl font-black text-slate-700 dark:text-slate-200 text-right flex-1" id="covFuelDay">0</div>
                         <div class="text-[10px] text-slate-400 fuel-unit-label ml-2 w-12">...</div>
                         <div class="bg-slate-200 rounded px-2 py-1 ml-4 w-24 text-center">
                             <div class="text-[10px] font-bold text-slate-600 dark:text-slate-300"><span id="covKwhDay">0</span> kWh</div>
                         </div>
                    </div>
                    <div class="p-3 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-100 flex items-center justify-between">
                         <div class="text-xs font-bold text-slate-400 uppercase tracking-wide w-24">HAFTALIK</div>
                         <div class="text-xl font-black text-slate-700 dark:text-slate-200 text-right flex-1" id="covFuelWeek">0</div>
                         <div class="text-[10px] text-slate-400 fuel-unit-label ml-2 w-12">...</div>
                         <div class="bg-slate-200 rounded px-2 py-1 ml-4 w-24 text-center">
                             <div class="text-[10px] font-bold text-slate-600 dark:text-slate-300"><span id="covKwhWeek">0</span> kWh</div>
                         </div>
                    </div>
                    <div class="p-3 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-100 flex items-center justify-between">
                         <div class="text-xs font-bold text-slate-400 uppercase tracking-wide w-24">AYLIK</div>
                         <div class="text-xl font-black text-slate-700 dark:text-slate-200 text-right flex-1" id="covFuelMonth">0</div>
                         <div class="text-[10px] text-slate-400 fuel-unit-label ml-2 w-12">...</div>
                         <div class="bg-slate-200 rounded px-2 py-1 ml-4 w-24 text-center">
                             <div class="text-[10px] font-bold text-slate-600 dark:text-slate-300"><span id="covKwhMonth">0</span> kWh</div>
                         </div>
                    </div>
                    <div class="p-3 bg-red-50 rounded-xl border border-red-100 flex items-center justify-between relative overflow-hidden">
                         <div class="text-xs font-bold text-red-400 uppercase tracking-wide w-24">YILLIK</div>
                         <div class="text-2xl font-black text-red-600 text-right flex-1" id="covFuelYear">0</div>
                         <div class="text-[10px] text-red-400 fuel-unit-label ml-2 w-12">...</div>
                         <div class="bg-red-100 rounded px-2 py-1 ml-4 w-24 text-center">
                             <div class="text-[10px] font-bold text-red-700"><span id="covKwhYear">0</span> kWh</div>
                         </div>
                    </div>
                </div>
             </div>

             <div class="mt-auto border-t-2 border-slate-900 pt-6 flex justify-between items-end">
                <div class="text-[10px] text-slate-500 dark:text-slate-400 w-2/3 leading-relaxed" id="covNarrative">...</div>
                <div class="text-right">
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Amortisman (ROI)</div>
                    <div class="text-7xl font-black text-slate-900 leading-none" id="covRoiBig">---</div>
                    <div class="text-sm font-bold text-slate-400 mt-1 uppercase">AY</div>
                </div>
             </div>
        </div>
    </div>
    
    <div id="p-table" class="print-page p-12">
        <div class="flex justify-between items-center border-b-2 border-slate-900 pb-4 mb-8"><h2 class="text-xl font-black text-slate-900 uppercase">Detaylı Analiz Dökümü</h2><div class="text-xs text-slate-500 dark:text-slate-400" id="rDate">...</div></div>
        <table class="w-full audit-table mb-8"><thead><tr id="rep_table_head"></tr></thead><tbody id="rTable"></tbody></table>
        <div class="page-num mt-auto pt-8 border-t border-slate-200 dark:border-slate-700 text-center text-[10px] text-slate-400">Page 2 / 3</div>
    </div>
    
    <div id="p-summary" class="print-page p-12 flex flex-col h-full">
        <h2 class="text-2xl font-black text-slate-900 uppercase mb-8 border-b-2 border-slate-900 pb-4">Yönetici Özeti</h2>
        
        <div class="flex flex-col mb-12">
            <div class="py-6 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center group">
                <div>
                    <div class="text-sm text-red-500 font-bold uppercase tracking-widest flex items-center gap-2"><i data-lucide="flame" class="w-4 h-4"></i> Mevcut Yıllık Kayıp</div>
                    <div class="text-xs text-slate-400 mt-1 font-medium" id="sumFuelLost">...</div>
                </div>
                <div class="text-5xl font-black text-red-600" id="sumLoss">0</div>
            </div>

            <div class="py-6 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center group">
                <div>
                    <div class="text-sm text-slate-500 dark:text-slate-400 font-bold uppercase tracking-widest flex items-center gap-2"><i data-lucide="wallet" class="w-4 h-4"></i> Toplam Yatırım Bedeli</div>
                    <div class="text-xs text-slate-400 mt-1">Malzeme ve İşçilik Dahil</div>
                </div>
                <div class="text-5xl font-black text-slate-800 dark:text-slate-100" id="sumInvSummary">0</div>
            </div>

            <div class="py-6 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center group">
                <div>
                    <div class="text-sm text-green-600 font-bold uppercase tracking-widest flex items-center gap-2"><i data-lucide="sprout" class="w-4 h-4"></i> Yıllık Net Kazanç</div>
                    <div class="text-xs text-slate-400 mt-1">Enerji Tasarrufu Sonrası</div>
                </div>
                <div class="text-5xl font-black text-green-600" id="sumNetSaveSummary">0</div>
            </div>

            <div class="py-6 border-b border-slate-900 flex justify-between items-center group">
                <div>
                    <div class="text-sm text-indigo-600 dark:text-red-600 font-bold uppercase tracking-widest flex items-center gap-2"><i data-lucide="timer" class="w-4 h-4"></i> Geri Dönüş Süresi (ROI)</div>
                    <div class="text-xs text-slate-400 mt-1">Amortisman</div>
                </div>
                <div class="text-5xl font-black text-indigo-600 dark:text-red-600" id="sumRoiSummary">---</div>
            </div>
        </div>

        <div class="mb-8"><h3 class="text-sm font-bold text-slate-900 uppercase mb-4 flex items-center gap-2"><i data-lucide="bar-chart-3" class="w-4 h-4"></i> Finansal Projeksiyon (5 Yıl)</h3><table class="w-full text-xs text-right border-collapse"><thead><tr class="bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400"><th class="p-2 text-left">Senaryo</th><th class="p-2">Yıl 1</th><th class="p-2">Yıl 2</th><th class="p-2">Yıl 3</th><th class="p-2">Yıl 4</th><th class="p-2">Yıl 5</th><th class="p-2 font-black">TOPLAM</th></tr></thead><tbody class="font-mono" id="projTable"></tbody></table></div>
        
        <div class="flex gap-8 mb-4">
             <div class="flex-1 bg-emerald-900 rounded-xl p-6 text-white flex items-center justify-between relative overflow-hidden h-full">
                  <div class="absolute right-0 bottom-0 opacity-10 pointer-events-none translate-x-4 translate-y-4"><i data-lucide="sprout" class="w-48 h-48 text-white"></i></div>
                 <div class="z-10"><div class="text-sm text-emerald-300 font-bold uppercase tracking-widest">KARBON AYAK İZİ AZALTIMI</div><div class="text-5xl font-black mt-2"><span id="sumCo2">0</span> <span class="text-2xl font-normal text-emerald-400">Ton/Yıl</span></div></div>
                 <div class="text-right z-10 border-l border-emerald-700 pl-8"><div class="text-5xl font-black"><span id="sumTrees">0</span></div><div class="text-sm text-emerald-400 mt-1">Ağaç Eşdeğeri</div></div>
             </div>
         </div>

        <div class="border-t-2 border-slate-100 pt-4 mt-auto">
            <p class="text-[10px] text-slate-400 text-center font-medium leading-relaxed">Hesaplamalar ISO 12241 mühendislik standartlarına göre simüle edilmiştir. Garanti niteliği taşımaz.</p>
        </div>
    </div>
</div>

<script>
    function toggleQrVisibility() {
        const isChecked = document.getElementById('toggleQrInput').checked;
        const body = document.body;
        if (!isChecked) {
            body.classList.add('hide-qr-section');
        } else {
            body.classList.remove('hide-qr-section');
        }
    }
    
    // Manuel toplam yatırım bedeli güncelleme fonksiyonu
    function updateTotalInvestment() {
        const inputVal = parseFloat(document.getElementById('manualTotalInv').value);
        const currVal = document.getElementById('manualInvCurr').value;
        
        if (inputVal && inputVal > 0) {
            // Girilen değeri TL'ye çevir
            const rateToTL = FX[currVal] || 1;
            manualTotalInvestment = inputVal * rateToTL;
        } else {
            manualTotalInvestment = null;
        }
        
        render(); // Tabloyu yeniden render et
    }
    
    function toggleL2() {
        const box = document.getElementById('layer2Box');
        if(document.getElementById('useL2').checked) box.classList.remove('hidden'); else box.classList.add('hidden');
    }
    
    function toggleFuelMode() {
        const fuel = document.getElementById('fuel').value;
        const box = document.getElementById('manualFuelBox');
        if(fuel === 'manual') box.classList.remove('hidden'); else box.classList.add('hidden');
    }

    function initApp(){ 
        init();
        // Dark mode durumunu localStorage'dan yükle
        const isDark = localStorage.getItem('darkMode') === 'true';
        if (!isDark) {
            document.documentElement.classList.remove('dark');
        }
    }
    
    // Dark mode toggle fonksiyonu
    function toggleDarkMode() {
        const html = document.documentElement;
        const isDark = html.classList.toggle('dark');
        localStorage.setItem('darkMode', isDark);
        
        // Icon'ları güncelle
        setTimeout(() => {
            lucide.createIcons();
        }, 50);
    }
    
    // FORMATTER
    function fmt(n){ return n.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
    
    function setType(t){
        ['valve','pipe','tank'].forEach(x=>{document.getElementById('g-'+x).classList.add('hidden');});
        document.getElementById('g-'+t).classList.remove('hidden');
        document.getElementById('type').value=t;
        const buttons={valve:document.getElementById('btn-valve'),pipe:document.getElementById('btn-pipe'),tank:document.getElementById('btn-tank')};
        const activeClass="bg-white dark:bg-slate-800/50 text-slate-900 shadow";
        const inactiveClass="text-slate-500 dark:text-slate-400 hover:text-slate-900";
        
        Object.values(buttons).forEach(btn=>{btn.className="flex-1 py-1.5 text-xs font-medium rounded transition-all "+inactiveClass;});
        buttons[t].className="flex-1 py-1.5 text-xs font-medium rounded transition-all "+activeClass;
        
        const qtyInput = document.getElementById('qty');
        qtyInput.disabled = false;
        qtyInput.value = 1;
    }

    const PIPES={15:21.3,20:26.7,25:33.4,32:42.2,40:48.3,50:60.3,65:73.0,80:88.9,100:114.3,125:141.3,150:168.3,200:219.1,250:273.0,300:323.9,350:355.6,400:406.4,500:508.0};
    const SEPARATORS = {15:0.15, 20:0.18, 25:0.22, 32:0.28, 40:0.35, 50:0.45, 65:0.60, 80:0.75, 100:1.10, 125:1.45, 150:1.90, 200:2.80};

    const MATS={rockwool:{a:0.035,b:0.00017,c:0},glasswool:{a:0.025,b:0.00015,c:0},ceramic:{a:0.025,b:0.00012,c:1.2e-7},aerogel:{a:0.019,b:0.00004,c:5e-8},rubber:{a:0.034,b:0.000075,c:0},bare:{a:25,b:0,c:0}};
    const VALVE_FACTORS={
        gate:1.2,globe:1.4,butterfly:0.6,ball:1.0,strainer:1.5,check:0.9,
        trap_float: 1.6, trap_thermo: 0.8, trap_bimetal: 1.0, trap_bucket: 1.5,
        flange: 0.35
    };
    
    // YENİ YAKIT VERİ YAPISI: LHV (kcal) + CO2 (kg/kWh Fuel Input)
    const FUEL_PARAMS = {
        gas: { lhv: 8250, co2: 0.202 }, 
        elec: { lhv: 860, co2: 0.478 }, 
        lng: { lhv: 11500, co2: 0.22 }, 
        fueloil: { lhv: 9600, co2: 0.27 }, 
        coal_imp: { lhv: 6000, co2: 0.34 }, 
        coal_loc: { lhv: 3500, co2: 0.38 }
    };
    
    let LIST=[], PACKAGE_BASKET=[], isPackageMode=false;
    let FX={USD:34.50,EUR:36.50,TL:1.0},currImg=null,userQrImg=null,currPkgImg=null,editingIndex=null;
    let manualTotalInvestment = null; // Manuel toplam yatırım bedeli
    
    let currentSurfaces = []; 

    function addSurface(type){
        if (type === 'rect') {
            const w = parseFloat(document.getElementById('surfW').value);
            const h = parseFloat(document.getElementById('surfH').value);
            if(!w || !h){ alert("Lütfen En ve Boy giriniz."); return; }
            currentSurfaces.push({type: 'rect', w: w, h: h});
            document.getElementById('surfW').value = '';
            document.getElementById('surfH').value = '';
        } else if (type === 'circle') {
            const d = parseFloat(document.getElementById('surfD').value);
            if(!d){ alert("Lütfen Çap giriniz."); return; }
            currentSurfaces.push({type: 'circle', d: d});
            document.getElementById('surfD').value = '';
        }
        renderSurfaces();
    }
    
    function removeSurface(idx){
        currentSurfaces.splice(idx,1);
        renderSurfaces();
    }
    
    function renderSurfaces(){
        const listEl = document.getElementById('surfaceList');
        const totalEl = document.getElementById('totalSurfArea');
        listEl.innerHTML = '';
        let totalAreaM2 = 0;
        
        currentSurfaces.forEach((s, idx) => {
            let m2 = 0;
            let label = "";
            
            if(s.type === 'circle') {
                // Pi * r^2. r = d/2. d cm -> m için 100'e böl. r = d/200.
                m2 = Math.PI * Math.pow((s.d / 200), 2);
                label = `Ø ${s.d} cm Daire`;
            } else {
                // Default Rect (veya eski veri)
                const w = s.w; 
                const h = s.h;
                m2 = (w * h) / 10000;
                label = `${w} x ${h} cm`;
            }

            totalAreaM2 += m2;
            const div = document.createElement('div');
            div.className = "flex justify-between items-center bg-white dark:bg-slate-800/50 p-1.5 rounded border border-slate-200 dark:border-slate-700";
            div.innerHTML = `<span>${label}</span> <button onclick="removeSurface(${idx})" class="text-red-500 hover:text-red-700"><i data-lucide="x" class="w-3 h-3"></i></button>`;
            listEl.appendChild(div);
        });
        
        totalEl.innerText = totalAreaM2.toFixed(3);
        lucide.createIcons();
    }

    // PAKET MODU FONKSİYONLARI
    function togglePackageMode(){
        isPackageMode = !isPackageMode;
        const panel = document.getElementById('packagePanel');
        const btnToggle = document.getElementById('btnTogglePkg');
        const btnAdd = document.getElementById('btnAddText');
        const invBox = document.getElementById('singleInvBox');
        const invInput = document.getElementById('inv');
        const invCurr = document.getElementById('invCurr');

        if(isPackageMode){
            panel.classList.remove('hidden');
            btnToggle.classList.replace('bg-slate-200', 'bg-indigo-600');
            btnToggle.classList.replace('text-slate-600', 'text-white');
            btnToggle.innerHTML = `<i data-lucide="box" class="w-3 h-3"></i> Paket Modunu Kapat`;
            btnAdd.innerText = "Sepete Ekle";
            
            // Tekil yatırım girişini kapat
            invInput.disabled = true;
            invCurr.disabled = true;
            invBox.classList.add('opacity-30');
        } else {
            panel.classList.add('hidden');
            btnToggle.classList.replace('bg-indigo-600', 'bg-slate-200');
            btnToggle.classList.replace('text-white', 'text-slate-600');
            btnToggle.innerHTML = `<i data-lucide="box" class="w-3 h-3"></i> Paket Modunu Aç`;
            btnAdd.innerText = "Hesapla & Ekle";
            
            // Tekil yatırım girişini aç
            invInput.disabled = false;
            invCurr.disabled = false;
            invBox.classList.remove('opacity-30');
        }
        lucide.createIcons();
    }

    function addToPackageBasket(){
        const res = getCalculationResult(true); 
        PACKAGE_BASKET.push(res);
        renderPackageBasket();
        resetForm();
    }

    function renderPackageBasket(){
        const ul = document.getElementById('pkgList');
        ul.innerHTML = '';
        let totalSave = 0;
        let totalQty = 0;

        const currSymVal=document.getElementById('curr')?document.getElementById('curr').value:'TL';
        const reportRate = FX[currSymVal] || 1; 

        PACKAGE_BASKET.forEach((item, idx) => {
            const li = document.createElement('li');
            li.className = "flex justify-between items-center border-b border-slate-100 pb-1 last:border-0";
            li.innerHTML = `<span>${item.qty} ${item.unit} ${item.name}</span> <button onclick="removeFromBasket(${idx})" class="text-red-400 hover:text-red-600"><i data-lucide="x" class="w-3 h-3"></i></button>`;
            ul.appendChild(li);
            
            totalSave += item.saveTL;
            totalQty++;
        });

        if(PACKAGE_BASKET.length === 0) ul.innerHTML = '<li class="text-slate-400 text-center italic py-2">Henüz sepete ürün eklenmedi.</li>';
        
        document.getElementById('pkgTotalQty').innerText = totalQty + " Kalem";
        document.getElementById('pkgTotalSave').innerText = fmt(totalSave / reportRate) + " " + currSymVal;
        lucide.createIcons();
    }

    function removeFromBasket(idx){
        PACKAGE_BASKET.splice(idx,1);
        renderPackageBasket();
    }

    function readPkgImg(i){if(i.files&&i.files[0]){const r=new FileReader();r.onload=e=>{currPkgImg=e.target.result;document.getElementById('pkgPrevImg').src=currPkgImg;document.getElementById('pkgPrevImg').classList.remove('hidden');};r.readAsDataURL(i.files[0]);}}

    // PAKET OLUŞTURMA VE RESTORE İÇİN ORTAK YARDIMCI FONKSİYON
    function buildPackageItem(basket, pkgName, pkgQty, pkgInvRaw, pkgInvCurr) {
        const pkgInvRate = FX[pkgInvCurr] || 1;
        const pkgUnitInvTL = pkgInvRaw * pkgInvRate; // Paket Birim Yatırımı TL
        const pkgTotalInvTL = pkgUnitInvTL * pkgQty; // Toplam Yatırım

        // Agrege Veriler
        let totalSaveTL = 0;
        let totalLossTL = 0;
        let totalLossBareTL = 0;
        let totalFuelSaved = 0;
        let totalFuelLost = 0;
        let totalCo2 = 0;
        let totalKwhBare = 0;
        let totalKwhIns = 0;
        let totalKwhSave = 0;
        let itemsDesc = [];
        let fuelUnit = basket.length > 0 ? basket[0].fuelUnit : ""; 

        // PAKET İÇİNDE EN YÜKSEK YÜZEY SICAKLIĞINI BULMA (ISG Uyarısı İçin)
        let maxTemp = -9999;
        let displayTs = "-";
        let displayTins = "-";

        basket.forEach(item => {
            totalSaveTL += item.saveTL;
            totalLossTL += item.lossTL;
            totalLossBareTL += item.lossBareTL;
            totalFuelSaved += item.fuelSaved;
            totalFuelLost += item.fuelLost;
            totalCo2 += item.co2;
            
            totalKwhBare += parseFloat(item.kwhBare.replace(/\./g,'').replace(',','.'));
            totalKwhIns += parseFloat(item.kwhIns.replace(/\./g,'').replace(',','.'));
            totalKwhSave += parseFloat(item.kwhSave.replace(/\./g,'').replace(',','.'));
            
            itemsDesc.push(`${item.qty}x ${item.name}`);

            // YÜZEY SICAKLIĞI KONTROLÜ
            let tVal = parseFloat(item.Ts);
            if(!isNaN(tVal) && tVal > maxTemp){
                maxTemp = tVal;
                displayTs = item.Ts;
                displayTins = item.Tins;
            }
        });

        // TÜM DEĞERLERİ PAKET ADEDİ İLE ÇARP
        totalSaveTL *= pkgQty;
        totalLossTL *= pkgQty;
        totalLossBareTL *= pkgQty;
        totalFuelSaved *= pkgQty;
        totalFuelLost *= pkgQty;
        totalCo2 *= pkgQty;
        totalKwhBare *= pkgQty;
        totalKwhIns *= pkgQty;
        totalKwhSave *= pkgQty;

        // ROI Hesabı
        let roiCalc = 0;
        if(totalSaveTL > 0.01) { roiCalc = (pkgTotalInvTL / totalSaveTL * 12); }

        return {
            name: `📦 PAKET: ${pkgName}`,
            desc: `(${pkgQty} SET) - ${basket.length} Kalem İçerir: ` + itemsDesc.join(', '), 
            location: basket.length > 0 ? (basket[0].location || "Muhtelif") : "Muhtelif",
            qty: pkgQty,
            unit: "Set",
            invTL: pkgTotalInvTL,
            saveTL: totalSaveTL,
            lossTL: totalLossTL,
            lossBareTL: totalLossBareTL,
            fuelSaved: totalFuelSaved,
            fuelLost: totalFuelLost,
            fuelUnit: fuelUnit,
            kwhBare: Math.round(totalKwhBare).toLocaleString('tr-TR'),
            kwhIns: Math.round(totalKwhIns).toLocaleString('tr-TR'),
            kwhSave: Math.round(totalKwhSave).toLocaleString('tr-TR'),
            co2: totalCo2,
            Ts: displayTs, 
            Tins: displayTins,
            img: currPkgImg, 
            roi: roiCalc,
            inputs: {
                type: 'package',
                matKey: 'mixed', 
                inv: pkgInvRaw,
                invCurr: pkgInvCurr,
                isLumpSum: true,
                subItems: JSON.parse(JSON.stringify(basket)), // Deep copy
                vWind: 0 
            }
        };
    }

    function commitPackage(){
        if(PACKAGE_BASKET.length === 0) { alert("Sepet boş!"); return; }
        
        const pkgName = document.getElementById('pkgName').value || "İsimsiz Paket";
        const pkgQty = parseFloat(document.getElementById('pkgQty').value) || 1;
        const pkgInvRaw = parseFloat(document.getElementById('pkgInv').value) || 0;
        const pkgInvCurr = document.getElementById('pkgInvCurr').value;

        const compositeItem = buildPackageItem(PACKAGE_BASKET, pkgName, pkgQty, pkgInvRaw, pkgInvCurr);

        LIST.push(compositeItem);
        
        // Temizlik
        PACKAGE_BASKET = [];
        document.getElementById('pkgName').value = '';
        document.getElementById('pkgInv').value = '';
        document.getElementById('pkgQty').value = '1';
        currPkgImg = null;
        document.getElementById('pkgPrevImg').src = '';
        document.getElementById('pkgPrevImg').classList.add('hidden');
        
        renderPackageBasket();
        render(); 
        alert("Paket başarıyla oluşturuldu ve listeye eklendi!");
    }


    function getK(matKey,T){if(!MATS[matKey])return 0.04;const m=MATS[matKey];return m.a+(m.b*T)+((m.c||0)*T*T);}
    
    // --- GÜNCELLENEN RÜZGAR/KONVEKSİYON MOTORU (ANLIK KAYIP ARACI İLE EŞİTLENDİ) ---
    function getSurfaceCoeff(std, vWind, Ts, Ta, D_out, isFlat) {
        const dT = Math.abs(Ts - Ta);
        const sigma = 5.67e-8, eps = 0.9;

        // Radyasyon
        let h_rad = eps * sigma * (Math.pow(Ts + 273.15, 4) - Math.pow(Ta + 273.15, 4)) / (dT || 1);
        if (dT < 0.1) h_rad = 5;

        let h_cv = 0;

        // Rüzgar ve Konveksiyon Hesabı
        if (vWind < 0.1) {
            // Durgun Hava (Doğal Konveksiyon)
            if (isFlat) h_cv = 1.95 * Math.pow(dT, 0.25);
            else h_cv = 1.32 * Math.pow(dT / (D_out || 1), 0.25);
        } else {
            // Rüzgarlı Hava (Zorlanmış Konveksiyon)
            // Borular için genel ISO formülü
            h_cv = 10.0 * Math.pow(vWind, 0.6) / Math.pow((D_out || 1), 0.4);
            
            // Düz yüzeyler için
            if (isFlat) h_cv = 5.8 + 3.8 * vWind;
        }

        if (h_cv < 1) h_cv = 1;
        return h_rad + h_cv;
    }

    // ignoreInvestment: Paket modunda ekleme yaparken yatırım sıfır alınsın diye
    function getCalculationResult(ignoreInvestment = false){
        const qty=parseFloat(document.getElementById('qty').value)||1;
        const type=document.getElementById('type').value;
        const location=document.getElementById('location').value||"";
        const tProc=parseFloat(document.getElementById('tProc').value)||0;
        const tAmb=parseFloat(document.getElementById('tAmb').value)||25;
        
        // --- RÜZGAR DÜZELTMESİ (User Fix) ---
        const vWindInput = document.getElementById('vWind').value;
        const vWind = (vWindInput === "") ? 0 : parseFloat(vWindInput);
        
        const matKey=document.getElementById('matSelect').value;
        const thk=parseFloat(document.getElementById('thk').value)||0;
        
        const useL2 = document.getElementById('useL2').checked;
        const matKey2 = useL2 ? document.getElementById('matSelect2').value : null;
        const thk2 = useL2 ? (parseFloat(document.getElementById('thk2').value)||0) : 0;
        
        const standard=document.getElementById('calcStd').value;
        const pLen = parseFloat(document.getElementById('pLen').value)||1; 
        
        let multiplier=1; 
        if(type==='pipe'){ multiplier = pLen * qty; }

        let invTotalTL = 0;
        let invRaw = 0;
        let invCurrencyCode = 'TL';

        if(!ignoreInvestment) {
            invRaw=parseFloat(document.getElementById('inv').value)||0;
            invCurrencyCode = document.getElementById('invCurr').value; 
            const invRate = FX[invCurrencyCode] || 1; 
            
            let invUnitTL = invRaw * invRate;
            
            // --- BORU FİYAT MANTIĞI GÜNCELLEMESİ ---
            // Eski: invTotalTL = invUnitTL * multiplier; (Metreyle çarpıyordu)
            // Yeni: Girdiği fiyat = O parçanın fiyatı. Sadece adetle çarpıyoruz.
            invTotalTL = invUnitTL * qty; 
            // ----------------------------------------
        }
        
        const eff=(parseFloat(document.getElementById('eff').value)||85)/100;
        const priceRaw=parseFloat(document.getElementById('price').value)||0;
        
        const energyCurrencyCode = document.getElementById('energyCurr').value;
        const energyRate = FX[energyCurrencyCode] || 1;
        const priceTL = priceRaw * energyRate; 

        const hours=parseFloat(document.getElementById('hours').value)||8000;
        
        let isFlat=(type==='tank');
        let dPipe=0,D_ext=0,Name="",unitLabel="Adet";

        if(isFlat){
            if(currentSurfaces.length === 0) {
                multiplier = 1;
                Name = `Tank/Düz (Ölçüsüz)`;
                unitLabel = "Set";
            } else {
                let totalArea = 0;
                let dims = [];
                currentSurfaces.forEach(s => {
                    if(s.type === 'circle'){
                        let m2 = Math.PI * Math.pow((s.d / 200), 2);
                        totalArea += m2;
                        dims.push(`Ø${s.d}`);
                    } else {
                        // RECT Default
                        totalArea += (s.w * s.h) / 10000;
                        dims.push(`${s.w}x${s.h}`);
                    }
                });
                multiplier = totalArea;
                Name = `Yüzey (${dims.join(' + ')})`;
                unitLabel = "Set";
            }
            dPipe=1.0; D_ext=1.0; 
        } else {
            const dn=(type==='valve')?document.getElementById('vDN').value:document.getElementById('pDN').value;
            const mm=parseFloat(dn)||100;
            dPipe=mm/1000; D_ext=dPipe;
            
            if(type==='valve'){
                const vType=document.getElementById('valveType').value;
                if(vType === 'separator'){
                     const sepArea = SEPARATORS[Object.keys(PIPES).find(k=>PIPES[k]==mm)] || 0.5;
                     multiplier = sepArea; 
                     Name=`Buhar Separatörü (DN${Object.keys(PIPES).find(k=>PIPES[k]==mm)})`;
                } else if(vType === 'elbow') {
                    multiplier = 2.36 * dPipe; 
                    Name=`Dirsek 90° (DN${Object.keys(PIPES).find(k=>PIPES[k]==mm)})`;
                } else {
                     multiplier=1; 
                     const sel = document.getElementById('valveType');
                     const txt = sel.options[sel.selectedIndex].text;
                     Name=`${txt} (DN${Object.keys(PIPES).find(k=>PIPES[k]==mm)})`;
                }
                unitLabel="Adet";
            } else {
                Name=`Boru (DN${Object.keys(PIPES).find(k=>PIPES[k]==mm)})`;
                unitLabel="m";
            }
        }
        
        const thkM=thk/1000;
        const thkM2=thk2/1000;
        let minTs=tAmb,maxTs=tProc,Ts=(minTs+maxTs)/2;
        
        if(matKey==='bare'){
            for(let i=0;i<100;i++){let D_out=isFlat?1.0:dPipe;const h_total=getSurfaceCoeff(standard,vWind,tProc,tAmb,D_out,isFlat);Ts=tProc;break;}
        }else{
            for(let i=0;i<100;i++){
                const Tm=(tProc+Ts)/2;
                const k1=getK(matKey,Tm);
                
                let R1 = 0, R2 = 0;
                
                if(isFlat) {
                    R1 = thkM / k1;
                    if(useL2) {
                         const Tm2 = (Tm + Ts)/2 - 10; 
                         const k2 = getK(matKey2, Tm2);
                         R2 = thkM2 / k2;
                    }
                } else {
                    R1 = Math.log((dPipe + 2*thkM)/dPipe) / (2*Math.PI*k1);
                    if(useL2) {
                        const Tm2 = (Tm + Ts)/2 - 10;
                        const k2 = getK(matKey2, Tm2);
                        R2 = Math.log((dPipe + 2*thkM + 2*thkM2) / (dPipe + 2*thkM)) / (2*Math.PI*k2);
                    }
                }
                
                const R_total = R1 + R2;
                const Q_cond=(tProc-Ts)/R_total;
                let D_out = isFlat ? 1.0 : dPipe + 2*(thkM + thkM2);
                const h_total=getSurfaceCoeff(standard,vWind,Ts,tAmb,D_out,isFlat);
                let A_surf=isFlat?1:2*Math.PI*(D_out/2);
                const Q_conv=h_total*A_surf*(Ts-tAmb);
                
                if(Q_cond>Q_conv)minTs=Ts;else maxTs=Ts;Ts=(minTs+maxTs)/2;
            }
        }
        
        const finalTs=Ts;
        let D_out_final = isFlat ? 1.0 : dPipe + (matKey==='bare' ? 0 : 2*(thkM + thkM2));
        const h_final=getSurfaceCoeff(standard,vWind,finalTs,tAmb,D_out_final,isFlat);
        let A_outer_unit=isFlat?1:Math.PI*D_out_final;
        const Q_unit=h_final*A_outer_unit*(finalTs-tAmb); 
        
        let Q_total_watts=0;
        const vType=document.getElementById('valveType').value;
        if(type==='valve'){
             if(vType === 'separator'){ Q_total_watts = Q_unit * (multiplier*3) * qty; } 
             else if(vType === 'elbow') { Q_total_watts = Q_unit * multiplier * qty; } 
             else { const factor=VALVE_FACTORS[vType]||1.2; Q_total_watts=Q_unit*factor*qty; }
        } else if(type==='pipe'){ Q_total_watts=Q_unit*multiplier; } 
        else { Q_total_watts=Q_unit*multiplier*qty; }
        
        let h_bare=getSurfaceCoeff(standard,vWind,tProc,tAmb,dPipe,isFlat);
        let A_bare_unit=isFlat?1:Math.PI*dPipe;
        let Q_bare_unit=h_bare*A_bare_unit*(tProc-tAmb);
        let Q_bare_total=0;
        
        if(type==='valve'){
            if(vType==='separator'){ Q_bare_total = Q_bare_unit * (multiplier*3) * qty; } 
            else if (vType === 'elbow') { Q_bare_total = Q_bare_unit * multiplier * qty; } 
            else { const factor=VALVE_FACTORS[vType]||1.2; Q_bare_total=Q_bare_unit*factor*qty; }
        } else if(type==='pipe'){ Q_bare_total=Q_bare_unit*multiplier; } 
        else { Q_bare_total=Q_bare_unit*multiplier*qty; }

        const fuelType = document.getElementById('fuel').value;
        let LHV_Val = 8250;
        let co2Factor = 0.202; // Default Gas
        let LHV_Unit = "m3";

        if(fuelType === 'manual') {
            LHV_Val = parseFloat(document.getElementById('fuelLhv').value) || 0;
            LHV_Unit = document.getElementById('fuelUnit').value;
            if(LHV_Unit === 'm3') co2Factor = 0.202; 
            else if(LHV_Unit === 'kwh') co2Factor = 0.478; 
            else co2Factor = 0.3; 
        } else {
            LHV_Val = FUEL_PARAMS[fuelType].lhv;
            co2Factor = FUEL_PARAMS[fuelType].co2;
            
            if(fuelType === 'gas') LHV_Unit = 'm3';
            else if(fuelType === 'elec') LHV_Unit = 'kwh';
            else LHV_Unit = 'kg';
        }
        
        const energyLostIns_kWh = (Q_total_watts * hours) / 1000;
        const energyLostBare_kWh = (Q_bare_total * hours) / 1000;
        const energySaved_kWh = energyLostBare_kWh - energyLostIns_kWh;
        
        const energySaved_kcal = energySaved_kWh * 860;
        const energyLostBare_kcal = energyLostBare_kWh * 860;

        const fuelSavedAmount = energySaved_kcal / (LHV_Val * eff);
        const fuelLostAmount = energyLostBare_kcal / (LHV_Val * eff);

        const fuelEnergyInputSaved_kWh = energySaved_kWh / eff; 
        const co2SavedTotal = (matKey==='bare') ? 0 : (fuelEnergyInputSaved_kWh * co2Factor) / 1000; // Ton

        const loss_money_insulated_TL = (energyLostIns_kWh * 860 / (LHV_Val * eff)) * priceTL;
        const loss_money_bare_TL = (energyLostBare_kcal / (LHV_Val * eff)) * priceTL;
        
        const save_money_TL = (matKey==='bare') ? 0 : (loss_money_bare_TL - loss_money_insulated_TL);
        const annual_loss_TL = (matKey==='bare') ? loss_money_bare_TL : loss_money_insulated_TL;
        
        let roiCalc = 0;
        if(save_money_TL > 0.01 && !ignoreInvestment) { roiCalc = (invTotalTL / save_money_TL * 12); }

        const savedSurfaces = JSON.parse(JSON.stringify(currentSurfaces));

        const inputs={
            type,qty,pLen,location,
            tProc,tAmb,matKey,thk,
            useL2, matKey2, thk2,
            inv:invRaw,
            standard,
            vDN:document.getElementById('vDN').value,
            pDN:document.getElementById('pDN').value,
            valveType: document.getElementById('valveType').value,
            surfaces: savedSurfaces,
            img:currImg,
            invCurr: invCurrencyCode,
            energyCurr: energyCurrencyCode,
            fuelType: fuelType,
            fuelLhv: LHV_Val,
            fuelUnit: LHV_Unit,
            vWind: vWind // KAYDETTİK
        };
        
        const matName1=document.getElementById('matSelect').options[document.getElementById('matSelect').selectedIndex].text;
        let descStr = "";
        if(matKey==='bare') {
            descStr = "Yalıtımsız";
        } else {
            descStr = `${thk}mm ${matName1}`;
            if(useL2) {
                const matName2 = document.getElementById('matSelect2').options[document.getElementById('matSelect2').selectedIndex].text;
                descStr += ` + ${thk2}mm ${matName2}`;
            }
        }
        
        const realBareTemp = (matKey === 'bare') ? finalTs : tProc; 
        const realInsTemp = (matKey === 'bare') ? "-" : finalTs;

        return{
            name:Name,
            desc:descStr,
            location: location,
            qty: (type==='pipe' ? multiplier : qty),
            unit: unitLabel,
            invTL: invTotalTL, 
            saveTL: save_money_TL, 
            lossTL: annual_loss_TL, 
            lossBareTL: loss_money_bare_TL, 
            fuelSaved: (matKey==='bare') ? 0 : fuelSavedAmount,
            fuelLost: fuelLostAmount, 
            fuelUnit: LHV_Unit,
            kwhBare: Math.round(energyLostBare_kWh).toLocaleString('tr-TR'),
            kwhIns: Math.round(energyLostIns_kWh).toLocaleString('tr-TR'),
            kwhSave: Math.round(energySaved_kWh).toLocaleString('tr-TR'),
            co2: co2SavedTotal, // ARTIK YAKIT TÜRÜNE GÖRE
            Ts: realBareTemp.toFixed(1), // DÜZELTİLEN SATIR
            Tins: (matKey === 'bare') ? "-" : realInsTemp.toFixed(1), // DÜZELTİLEN SATIR
            qBare:Q_bare_unit,
            qIns:Q_unit,
            img:currImg,
            roi: roiCalc,
            inputs
        };
    }

    function init(){fillDN('vDN');fillDN('pDN');getFx();lucide.createIcons(); setType('valve');}
    function fillDN(id){const el=document.getElementById(id);el.innerHTML='';for(const[k,v]of Object.entries(PIPES)){let o=document.createElement('option');o.value=v;o.text=`DN ${k}`;el.add(o);}if(id==='vDN')el.value=60.3;if(id==='pDN')el.value=88.9;}
    
    function readImg(i){if(i.files&&i.files[0]){const r=new FileReader();r.onload=e=>{currImg=e.target.result;document.getElementById('prevImg').src=currImg;document.getElementById('prevImg').classList.remove('hidden');};r.readAsDataURL(i.files[0]);}}
    function readQr(i){if(i.files&&i.files[0]){const r=new FileReader();r.onload=e=>{userQrImg=e.target.result;alert("QR Kod yüklendi! Raporun son sayfasında görünecek.");};r.readAsDataURL(i.files[0]);}}

    async function getFx(){try{const r=await fetch('https://api.frankfurter.app/latest?from=USD&to=TRY');const d=await r.json();FX.USD=d.rates.TRY;const r2=await fetch('https://api.frankfurter.app/latest?from=EUR&to=TRY');const d2=await r2.json();FX.EUR=d2.rates.TRY;document.getElementById('fxVal').innerText=FX.USD.toFixed(2);}catch(e){}}
    
    function calc(){
        if(isPackageMode) {
            addToPackageBasket();
        } else {
            LIST.push(getCalculationResult());
            resetForm();
            render();
        }
    }

    function finishUpdate(){if(editingIndex!==null)LIST[editingIndex]=getCalculationResult();editingIndex=null;document.getElementById('btnAdd').classList.remove('hidden');document.getElementById('btnUpdate').classList.add('hidden');resetForm();render();}
    
    function edit(i){
        editingIndex=i;
        const d=LIST[i].inputs;

        if(d.type === 'package') {
            alert("Paketler şu an düzenlenemez, silip tekrar oluşturunuz.");
            editingIndex = null;
            return;
        }

        if(isPackageMode) togglePackageMode();

        setType(d.type);
        document.getElementById('tProc').value = d.tProc;
        document.getElementById('matSelect').value = d.matKey;
        document.getElementById('thk').value = d.thk;
        document.getElementById('inv').value = d.inv;
        document.getElementById('qty').value = d.qty;
        document.getElementById('calcStd').value = d.standard;
        document.getElementById('location').value = d.location || ""; 
        document.getElementById('useL2').checked = d.useL2 || false;
        
        document.getElementById('vWind').value = (d.vWind !== undefined && d.vWind !== null) ? d.vWind : 1; 
        
        toggleL2();
        if(d.useL2) {
            document.getElementById('matSelect2').value = d.matKey2;
            document.getElementById('thk2').value = d.thk2;
        }

        if(d.invCurr) document.getElementById('invCurr').value = d.invCurr;
        if(d.energyCurr) document.getElementById('energyCurr').value = d.energyCurr;
        
        document.getElementById('fuel').value = d.fuelType || 'gas';
        toggleFuelMode();
        if(d.fuelType === 'manual') {
            document.getElementById('fuelLhv').value = d.fuelLhv;
            document.getElementById('fuelUnit').value = d.fuelUnit;
        }

        if(d.img){ currImg=d.img; document.getElementById('prevImg').src=currImg; document.getElementById('prevImg').classList.remove('hidden'); }
        if(d.type === 'valve'){
            document.getElementById('valveType').value = d.valveType || 'gate';
            document.getElementById('vDN').value = d.vDN;
        } else if (d.type === 'pipe'){
            document.getElementById('pDN').value = d.pDN;
            document.getElementById('pLen').value = d.pLen || 1;
        } else if (d.type === 'tank'){
            currentSurfaces = d.surfaces || [];
            renderSurfaces();
        }
        document.getElementById('btnAdd').classList.add('hidden');
        document.getElementById('btnUpdate').classList.remove('hidden');
    }

    function del(i){if(confirm('Silmek istediğine emin misin?')){LIST.splice(i,1);render();}}
    
    function resetForm(){
        currImg=null;
        document.getElementById('prevImg').classList.add('hidden');
        document.getElementById('inv').value='';
        document.getElementById('location').value='';
        document.getElementById('vWind').value = 0; 
        
        currentSurfaces = [];
        renderSurfaces();
    } 

    function clearAll(){if(confirm('Tüm listeyi temizle?')){LIST=[];render();}}
    
    function exportCSV(){
        if(LIST.length===0){alert("Liste boş!");return;}
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; 
        csvContent += "Type,Qty,PipeLen,Temp_Proc,Temp_Amb,Material,Thickness,Invest,Standard,Valve_DN,Pipe_DN,Valve_Type,Surfaces,Invest_Curr,Energy_Curr,Location,UseL2,Mat2,Thk2,FuelType,FuelLHV,FuelUnit,PackageName,SubItemsCount,WindSpeed,SubItemsDump\n";
        
        LIST.forEach(row => {
            const i = row.inputs;
            let surfStr = "";
            if(i.surfaces && i.surfaces.length > 0){
                // EĞER CIRCLE İSE C:50, DEĞİLSE 100x50
                surfStr = i.surfaces.map(s => {
                    if(s.type === 'circle') return `C:${s.d}`;
                    return `${s.w}x${s.h}`;
                }).join('|');
            }
            
            const pkgName = i.type === 'package' ? row.name.replace("📦 PAKET: ", "") : "";
            const subCount = i.type === 'package' ? i.subItems.length : 0;
            
            const subItemsDump = i.type === 'package' ? btoa(unescape(encodeURIComponent(JSON.stringify(i.subItems)))) : "";

            const r = [
                i.type, row.qty, i.pLen, i.tProc || 0, i.tAmb || 0, i.matKey, i.thk || 0, i.inv, i.standard || "", i.vDN || "", i.pDN || "", i.valveType || "", surfStr, i.invCurr, i.energyCurr, 
                `"${row.location}"`, i.useL2, i.matKey2, i.thk2, i.fuelType, i.fuelLhv, i.fuelUnit, `"${pkgName}"`, subCount, i.vWind || 1, subItemsDump
            ];
            csvContent += r.join(",") + "\n";
        });
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "izolasyon_data.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function importCSV(input){
        const file = input.files[0];
        if(!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e){
            const text = e.target.result;
            const rows = text.split('\n');
            rows.shift();
            
            let addedCount = 0;

            const el = {
                type: document.getElementById('type'),
                qty: document.getElementById('qty'),
                pLen: document.getElementById('pLen'),
                tProc: document.getElementById('tProc'),
                tAmb: document.getElementById('tAmb'),
                matKey: document.getElementById('matSelect'),
                thk: document.getElementById('thk'),
                inv: document.getElementById('inv'),
                calcStd: document.getElementById('calcStd'),
                vDN: document.getElementById('vDN'),
                pDN: document.getElementById('pDN'),
                valveType: document.getElementById('valveType'),
                invCurr: document.getElementById('invCurr'),
                energyCurr: document.getElementById('energyCurr'),
                location: document.getElementById('location'),
                useL2: document.getElementById('useL2'),
                matSelect2: document.getElementById('matSelect2'),
                thk2: document.getElementById('thk2'),
                fuel: document.getElementById('fuel'),
                fuelLhv: document.getElementById('fuelLhv'),
                fuelUnit: document.getElementById('fuelUnit'),
                vWind: document.getElementById('vWind')
            };

            if(isPackageMode) togglePackageMode();

            rows.forEach(row => {
                if(!row.trim()) return;
                
                let cols = row.split(',');
                if(cols.length < 5) cols = row.split(';');

                if(cols.length < 10) return;

                try {
                    const type = cols[0];

                    if (type === 'package' && cols[25] && cols[25].length > 5) {
                        try {
                            const subItemsJson = decodeURIComponent(escape(window.atob(cols[25])));
                            const basket = JSON.parse(subItemsJson);
                            
                            const pkgName = cols[22] ? cols[22].replace(/^"|"$/g, '') : "Paket";
                            const pkgQty = parseFloat(cols[1]) || 1;
                            const pkgInv = parseFloat(cols[7]) || 0;
                            const pkgInvCurr = cols[13] || "TL";

                            const compositeItem = buildPackageItem(basket, pkgName, pkgQty, pkgInv, pkgInvCurr);
                            LIST.push(compositeItem);
                            addedCount++;
                            return; 
                        } catch (pkgErr) {
                            console.error("Paket parse hatası:", pkgErr);
                            return; 
                        }
                    }

                    setType(type);

                    el.qty.value = cols[1];
                    el.pLen.value = cols[2];
                    el.tProc.value = cols[3];
                    el.tAmb.value = cols[4];
                    el.matKey.value = cols[5];
                    el.thk.value = cols[6];
                    el.inv.value = cols[7];
                    el.calcStd.value = cols[8]; 
                    
                    if(type === 'valve') {
                        el.vDN.value = cols[9] || ""; 
                        el.valveType.value = cols[11] || "gate";
                    } else if (type === 'pipe') {
                        el.pDN.value = cols[10] || ""; 
                    } 
                    
                    if(type === 'tank' && cols[12] && cols[12].length > 2) {
                        currentSurfaces = []; 
                        const sList = cols[12].split('|');
                        sList.forEach(s => {
                            if(s.startsWith('C:')){
                                const dVal = parseFloat(s.split(':')[1]);
                                currentSurfaces.push({type: 'circle', d: dVal});
                            } else {
                                const dims = s.split('x');
                                if(dims.length===2) currentSurfaces.push({type: 'rect', w: parseFloat(dims[0]), h: parseFloat(dims[1])});
                            }
                        });
                    }

                    el.invCurr.value = cols[13] || "TL";
                    el.energyCurr.value = cols[14] || "TL";
                    
                    let locRaw = cols[15] || "";
                    el.location.value = locRaw.replace(/^"|"$/g, '');

                    const isL2 = (cols[16] === 'true');
                    el.useL2.checked = isL2;
                    toggleL2(); 
                    if(isL2){
                        el.matSelect2.value = cols[17];
                        el.thk2.value = cols[18];
                    }

                    el.fuel.value = cols[19] || 'gas';
                    toggleFuelMode();
                    if(cols[19] === 'manual'){
                        el.fuelLhv.value = cols[20];
                        el.fuelUnit.value = cols[21];
                    }

                    if(cols[24] !== undefined) {
                        el.vWind.value = cols[24];
                    }

                    const resultObj = getCalculationResult();
                    LIST.push(resultObj);
                    addedCount++;

                } catch(err) {
                    console.error("Satır işleme hatası:", err, row);
                }
            });

            resetForm();
            render();
            input.value = ''; 
            
            if(addedCount > 0) {
                alert(`${addedCount} kalem başarıyla içe aktarıldı!`);
            } else {
                alert("İçe aktarılacak veri bulunamadı.");
            }
        };
        reader.readAsText(file);
    }
    
    function render(){
        const tb=document.getElementById('gridBody');tb.innerHTML='';let gInv=0,gSave=0,gCo2=0;
        
        const currSymVal=document.getElementById('curr')?document.getElementById('curr').value:'TL';
        const reportRate = FX[currSymVal] || 1; 
        const currSymMap={'USD':'$','EUR':'€','TL':'₺'};
        const currSym=currSymMap[currSymVal]||'';

        LIST.forEach((i,x)=>{
            const invDisp = i.invTL / reportRate;
            const saveDisp = i.saveTL / reportRate;

            if(i.inputs.matKey!=='bare'){gInv+=invDisp;gSave+=saveDisp;gCo2+=i.co2;}
            
            const roiSuffix="Ay";
            const roi=i.roi > 0 ? i.roi.toFixed(1)+" "+roiSuffix : "-";
            const imgTag=i.img?`<img src="${i.img}" class="w-10 h-10 object-cover rounded">`:`<div class="w-10 h-10 bg-slate-200 rounded flex items-center justify-center text-xs text-slate-500 dark:text-slate-400">${i.inputs.type==='package'?'PKG':'-'}</div>`;
            const locTag = i.location ? `<div class="text-[9px] text-indigo-500 dark:text-red-500 font-bold mt-1 uppercase"><i data-lucide="map-pin" class="w-3 h-3 inline"></i> ${i.location}</div>` : '';

            const rowClass = i.inputs.type === 'package' ? "bg-indigo-50/50 dark:bg-red-900/10 border-l-4 border-l-indigo-500 dark:border-l-red-500" : "";

            const qtyInput = `<input type="number" class="grid-input font-bold text-slate-800 dark:text-slate-100" value="${i.qty}" onchange="quickUpdate(${x}, 'qty', this.value)">`;
            const invInput = `<div class="flex items-center gap-1 justify-end text-xs"><span class="text-slate-400">${currSym}</span><input type="number" class="grid-input text-right text-slate-600 dark:text-slate-300 w-20" value="${invDisp.toFixed(2)}" onchange="quickUpdate(${x}, 'inv', this.value)"></div>`;

            tb.insertAdjacentHTML('beforeend',`<tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition border-b border-slate-200 dark:border-slate-700 ${x===editingIndex?'bg-indigo-50 dark:bg-red-900/20':''} ${rowClass}">
            <td class="px-6 py-4">${imgTag}</td>
            <td class="px-6 py-4 font-bold text-slate-800 dark:text-slate-100">${i.name} ${locTag}</td>
            <td class="px-6 py-4 text-slate-500 dark:text-slate-400 text-xs">${i.desc}</td>
            <td class="px-6 py-4 text-center">${qtyInput} <span class="text-[9px] text-slate-400 block">${i.unit}</span></td>
            <td class="px-6 py-4 text-center"><div class="font-bold text-slate-700 dark:text-slate-200">${i.Ts}</div><div class="text-[10px] font-bold text-red-500">${i.kwhBare} kWh</div></td>
            <td class="px-6 py-4 text-center"><div class="font-bold text-slate-700 dark:text-slate-200">${i.Tins}</div><div class="text-[10px] font-bold text-orange-500">${i.kwhIns} kWh</div></td>
            <td class="px-6 py-4 text-center"><div class="font-bold text-green-600">+${i.kwhSave} kWh</div></td>
            <td class="px-6 py-4 text-right">${invInput}</td>
            <td class="px-6 py-4 text-right text-green-600 font-bold">${i.inputs.matKey!=='bare'?'+'+currSym+fmt(saveDisp):'-'}</td><td class="px-6 py-4 text-right font-bold text-indigo-500 dark:text-red-500">${roi}</td><td class="px-6 py-4 text-right"><button onclick="edit(${x})" class="text-indigo-500 dark:text-red-500 mr-2 hover:text-slate-900"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="del(${x})" class="text-red-500 hover:text-slate-900"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`);
        });
        if(LIST.length===0)tb.innerHTML=`<tr><td colspan="11" class="px-6 py-20 text-center text-slate-500 dark:text-slate-400"><i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 opacity-20"></i><span id="emptyMsg">Henüz hesaplama eklenmedi.</span></td></tr>`;
        
        // Manuel yatırım bedeli girilmişse onu kullan, yoksa otomatik toplamı kullan
        const finalInv = (manualTotalInvestment !== null && manualTotalInvestment > 0) 
            ? (manualTotalInvestment / reportRate) 
            : gInv;
        
        document.getElementById('dashInv').innerText=currSym+fmt(finalInv);
        document.getElementById('dashSave').innerText=currSym+fmt(gSave);
        document.getElementById('dashCo2').innerHTML=gCo2.toFixed(1)+' Ton';
        const totalRoi=gSave>0?(finalInv/gSave*12):0;
        document.getElementById('dashRoi').innerHTML=totalRoi>0?totalRoi.toFixed(1)+` <span class="text-lg text-slate-500 dark:text-slate-400 font-normal">Ay</span>`:'---';
        document.getElementById('barRoi').style.width=totalRoi>0?Math.min((totalRoi/24)*100,100)+'%':'0%';
        lucide.createIcons();
    }

    function quickUpdate(i, field, val) {
        if(LIST[i].inputs.type === 'package' && field === 'qty') {
             if(confirm("Paketlerin adedini değiştirmek için paketi silip yeniden oluşturmalısınız.")) {
                 render(); 
                 return;
             }
        }
        
        const oldInputs = LIST[i].inputs;
        if(oldInputs.type === 'package') return;

        setType(oldInputs.type);
        document.getElementById('tProc').value = oldInputs.tProc;
        document.getElementById('tAmb').value = oldInputs.tAmb;
        document.getElementById('matSelect').value = oldInputs.matKey;
        document.getElementById('thk').value = oldInputs.thk;
        document.getElementById('calcStd').value = oldInputs.standard;
        document.getElementById('location').value = oldInputs.location || "";
        document.getElementById('vWind').value = oldInputs.vWind || 0; 
        
        if(oldInputs.type==='pipe') {
             document.getElementById('pDN').value = oldInputs.pDN;
             document.getElementById('pLen').value = oldInputs.pLen;
        } else if(oldInputs.type==='valve'){
             document.getElementById('vDN').value = oldInputs.vDN;
             document.getElementById('valveType').value = oldInputs.valveType;
        }
        
        if(field === 'qty') document.getElementById('qty').value = val;
        else document.getElementById('qty').value = oldInputs.qty; 
        
        if(field === 'inv') {
            document.getElementById('inv').value = val;
            document.getElementById('invCurr').value = document.getElementById('curr').value; 
        } else {
            document.getElementById('inv').value = oldInputs.inv;
            document.getElementById('invCurr').value = oldInputs.invCurr;
        }
        
        LIST[i] = getCalculationResult(false);
        resetForm();
        render();
    }

    let printTemplateCache = null;

    function printRep(){
        try{
            const printArea = document.getElementById('print-area');
            if(!printTemplateCache){
                printTemplateCache = printArea.innerHTML;
            }
            printArea.innerHTML = printTemplateCache;
            
            const today = new Date().toLocaleDateString('tr-TR');
            const auditInput = document.getElementById('auditDate').value;
            let auditDateStr = today; 
            if(auditInput){
                const parts = auditInput.split('-'); 
                auditDateStr = `${parts[2]}.${parts[1]}.${parts[0]}`;
            }
            
            const currSymVal = document.getElementById('curr').value;
            const reportRate = FX[currSymVal] || 1;
            const currSymMap = {'USD':'$','EUR':'€','TL':'₺'};
            const currSym = currSymMap[currSymVal]||'';

            let gInv=0, gSave=0, gCo2=0, gLoss=0, gFuelLost=0;
            let gTotalKwh = 0; 
            let lastFuelUnit = "";
            let maxTempDetected = 0; 

            let allWinds = [];

            LIST.forEach(i => {
                const invDisp = i.invTL / reportRate;
                const saveDisp = i.saveTL / reportRate;
                const lossDisp = i.lossTL / reportRate;
                const lossBareDisp = i.lossBareTL / reportRate;
                
                const itemTs = parseFloat(i.Ts) || 0;
                if(itemTs > maxTempDetected) maxTempDetected = itemTs;

                if(i.inputs.type !== 'package') {
                    allWinds.push(i.inputs.vWind || 1);
                }

                const rawKwh = parseFloat(i.kwhBare.replace(/\./g,'').replace(',','.'));
                gTotalKwh += rawKwh;

                if(i.inputs.matKey!=='bare'){
                    gInv += invDisp;
                    gSave += saveDisp;
                    gCo2 += i.co2;
                    gLoss += lossBareDisp; 
                    gFuelLost += i.fuelLost;
                } else {
                    gLoss += lossDisp;
                    gFuelLost += i.fuelLost;
                }
                lastFuelUnit = i.inputs.fuelUnit || "";
            });

            let uniqueWinds = new Set(allWinds);
            let windNarrativeBit = "";

            if(uniqueWinds.size > 1 || LIST.some(x=>x.inputs.type==='package')) {
                windNarrativeBit = "tesis içi farklı lokasyonların rüzgar şartlarına uygun olarak";
            } else {
                let val = allWinds.length > 0 ? allWinds[0] : document.getElementById('vWind').value;
                windNarrativeBit = `<strong>${val} m/s</strong> rüzgar hızı koşullarında`;
            }

            const ghostContainer = document.createElement('div');
            ghostContainer.style.width = '210mm'; 
            ghostContainer.style.padding = '40px'; 
            ghostContainer.style.position = 'absolute';
            ghostContainer.style.top = '-9999px';
            ghostContainer.style.left = '-9999px';
            ghostContainer.style.visibility = 'hidden';
            document.body.appendChild(ghostContainer);

            const tableHeaderHTML = `
                <th class="w-6">#</th>
                <th class="w-20 text-center">Görsel</th>
                <th class="text-left w-48">Ekipman</th>
                <th class="text-center w-20 text-xs text-red-500">Çıplak<br><span class="text-[8px] font-normal">(Kayıp kWh)</span></th>
                <th class="text-center w-20 text-xs text-blue-500">İzolasyon<br><span class="text-[8px] font-normal">(Kayıp kWh)</span></th>
                <th class="text-center w-20 text-xs text-green-500">Kazanç<br><span class="text-[8px] font-normal">(Fark kWh)</span></th>
                <th class="text-center w-8">Adet</th>
                <th class="text-right text-slate-700 dark:text-slate-200">Yatırım</th>
                <th class="text-right text-green-600 font-black">Net Kazanç</th>
                <th class="text-right w-10">ROI</th>`;

            const PAGE_SAFE_HEIGHT = 880; 

            const pages = [];
            let currentPage = [];
            let currentHeight = 0;

            let tempTable = document.createElement('table');
            tempTable.className = 'w-full text-sm'; 
            ghostContainer.appendChild(tempTable);
            let tempTbody = document.createElement('tbody');
            tempTable.appendChild(tempTbody);

            LIST.forEach((i, idx) => {
                const globalIndex = idx + 1;
                const iInv = i.invTL / reportRate;
                const iSave = i.saveTL / reportRate;
                const roi = i.roi > 0 ? i.roi.toFixed(1) : "-";
                const imgTag = i.img ? `<img src="${i.img}" class="w-16 h-16 object-cover rounded mx-auto border border-slate-200 dark:border-slate-700">` : `<div class="w-8 h-8 bg-slate-100 dark:bg-slate-800 rounded mx-auto flex items-center justify-center text-[8px]">${i.inputs.type==='package'?'PKG':'-'}</div>`;
                const locText = i.location ? `<div class="text-[8px] uppercase text-slate-400 mt-1 font-bold">📍 ${i.location}</div>` : '';

                const trHTML = `
                    <td class="text-center font-bold text-slate-400 border-b border-slate-100">${globalIndex}</td>
                    <td class="text-center border-b border-slate-100 p-1">${imgTag}</td>
                    <td class="font-bold text-slate-800 dark:text-slate-100 border-b border-slate-100 text-[10px]">${i.name} ${locText}<div class="text-[8px] text-slate-500 dark:text-slate-400 font-normal mt-0.5">${i.desc}</div></td>
                    <td class="text-center border-b border-slate-100"><div class="font-bold text-slate-700 dark:text-slate-200">${i.Ts}</div><div class="text-[9px] font-bold text-red-500">${i.kwhBare} kWh</div></td>
                    <td class="text-center border-b border-slate-100"><div class="font-bold text-slate-700 dark:text-slate-200">${i.Tins}</div><div class="text-[9px] font-bold text-orange-500">${i.kwhIns} kWh</div></td>
                    <td class="text-center border-b border-slate-100"><div class="font-bold text-green-600">+${i.kwhSave} kWh</div></td>
                    <td class="text-center border-b border-slate-100 text-[10px]">${i.qty} ${i.unit}</td>
                    <td class="text-right font-mono text-[10px] text-slate-700 dark:text-slate-200 border-b border-slate-100">${currSym}${fmt(iInv)}</td>
                    <td class="text-right font-mono text-[10px] text-green-600 font-bold border-b border-slate-100">${i.inputs.matKey!=='bare'?'+'+currSym+fmt(iSave):'-'}</td>
                    <td class="text-right font-bold text-blue-600 text-[10px] border-b border-slate-100">${roi}</td>
                `;

                const tr = document.createElement('tr');
                tr.innerHTML = trHTML;
                tempTbody.appendChild(tr);
                
                const rowHeight = tr.offsetHeight;

                if (currentHeight + rowHeight > PAGE_SAFE_HEIGHT) {
                    pages.push(currentPage); 
                    currentPage = []; 
                    currentHeight = 0;
                    tempTbody.innerHTML = ''; 
                    
                    tempTbody.appendChild(tr); 
                }

                currentPage.push({ html: trHTML });
                currentHeight += rowHeight;
            });

            if (currentPage.length > 0) pages.push(currentPage);

            document.body.removeChild(ghostContainer);

            const tablePageTemplate = document.getElementById('p-table');
            const summaryPage = document.getElementById('p-summary');
            tablePageTemplate.remove(); 
            
            const totalPages = 1 + pages.length + 1; 

            pages.forEach((pageRows, index) => {
                const newPage = tablePageTemplate.cloneNode(true);
                newPage.id = '';
                const titleEl = newPage.querySelector('h2');
                titleEl.innerText = "Detaylı Analiz Dökümü";
                if(index > 0) { titleEl.innerHTML += ` <span class="text-sm text-slate-400 font-normal">(${index+1})</span>`; }
                newPage.querySelector('#rDate').innerText = today; 
                newPage.querySelector('thead tr').innerHTML = tableHeaderHTML;
                const pageNum = index + 2; 
                newPage.querySelector('.page-num').innerText = `Sayfa ${pageNum} / ${totalPages}`;
                const tbody = newPage.querySelector('tbody');
                tbody.innerHTML = ''; 
                
                pageRows.forEach(row => {
                    tbody.innerHTML += `<tr>${row.html}</tr>`;
                });

                document.getElementById('print-area').insertBefore(newPage, summaryPage);
            });

            // KAPAK VERİLERİ (GÜNCEL)
            // Manuel yatırım bedeli varsa onu kullan
            const finalInvForReport = (manualTotalInvestment !== null && manualTotalInvestment > 0) 
                ? (manualTotalInvestment / reportRate) 
                : gInv;
            const totalRoi = gSave>0 ? (finalInvForReport/gSave*12) : 0;
            
            document.getElementById('covClient').innerText = document.getElementById('cName').value || "FİRMA ADI";
            document.getElementById('covContact').innerText = document.getElementById('cEng').value || "";
            document.getElementById('covProv').innerText = document.getElementById('pName').value || "TEDARİKÇİ";
            document.getElementById('covDate').innerText = today; 
            document.getElementById('covIntroDate').innerText = auditDateStr; 
            
            // ROI YENİ YERİNDE
            document.getElementById('covRoiBig').innerText = totalRoi>0 ? totalRoi.toFixed(1) : "---";
            
            // --- YENİ EKLENEN DAILY/WEEKLY/MONTHLY HESAPLAMALAR ---
            const fuelYearly = gFuelLost;
            const fuelMonthly = gFuelLost / 12;
            const fuelWeekly = gFuelLost / 52;
            const fuelDaily = gFuelLost / 365;

            document.getElementById('covFuelYear').innerText = Math.round(fuelYearly).toLocaleString();
            document.getElementById('covFuelMonth').innerText = Math.round(fuelMonthly).toLocaleString();
            document.getElementById('covFuelWeek').innerText = Math.round(fuelWeekly).toLocaleString();
            document.getElementById('covFuelDay').innerText = Math.round(fuelDaily).toLocaleString();
            
            const kwhYearly = gTotalKwh;
            const kwhMonthly = gTotalKwh / 12;
            const kwhWeekly = gTotalKwh / 52;
            const kwhDaily = gTotalKwh / 365;

            document.getElementById('covKwhYear').innerText = Math.round(kwhYearly).toLocaleString();
            document.getElementById('covKwhMonth').innerText = Math.round(kwhMonthly).toLocaleString();
            document.getElementById('covKwhWeek').innerText = Math.round(kwhWeekly).toLocaleString();
            document.getElementById('covKwhDay').innerText = Math.round(kwhDaily).toLocaleString();
            // --------------------------------------------------------

            const fuelLabels = document.querySelectorAll('.fuel-unit-label');
            fuelLabels.forEach(el => el.innerText = lastFuelUnit);
            
            const tAmb = document.getElementById('tAmb').value;
            const eff = document.getElementById('eff').value;
            const price = document.getElementById('price').value;
            const hours = document.getElementById('hours').value;
            const energyCurr = document.getElementById('energyCurr').value;
            
            const narrative = `Simülasyonlar; <strong>${tAmb}°C</strong> ortam sıcaklığı, ${windNarrativeBit}, <strong>%${eff}</strong> sistem verimi ve yıllık <strong>${hours} saat</strong> çalışma süresi baz alınarak hesaplanmıştır. Enerji birim maliyeti <strong>${price} ${energyCurr}</strong> olarak kabul edilmiştir.`;
            document.getElementById('covNarrative').innerHTML = narrative;

            const qrImgEl = document.getElementById('covQrCode');
            if (userQrImg) { qrImgEl.src = userQrImg; qrImgEl.classList.remove('opacity-20'); } 
            else { qrImgEl.src = ""; qrImgEl.classList.add('opacity-50'); }

            document.getElementById('sumLoss').innerText = currSym + fmt(gLoss);
            document.getElementById('sumFuelLost').innerText = `(${Math.round(gFuelLost).toLocaleString()} ${lastFuelUnit})`;
            
            document.getElementById('sumCo2').innerText = gCo2.toFixed(1);
            document.getElementById('sumTrees').innerText = Math.round(gCo2*40).toLocaleString();

            // YÖNETİCİ ÖZETİ SAYFASINDAKİ YENİ ALANLARI DOLDUR
            document.getElementById('sumInvSummary').innerText = currSym + fmt(finalInvForReport);
            document.getElementById('sumNetSaveSummary').innerText = currSym + fmt(gSave);
            document.getElementById('sumRoiSummary').innerText = totalRoi>0 ? totalRoi.toFixed(1) + " AY" : "---";

            const pt = document.getElementById('projTable');
            pt.innerHTML = '';
            let rowL = `<tr class="border-b border-slate-200 dark:border-slate-700"><td class="p-2 text-left font-bold text-red-600">Mevcut Durum (Kümülatif Kayıp)</td>`;
            let tL=0;
            for(let y=1; y<=5; y++){ tL += gLoss; rowL += `<td class="p-2 text-red-500">-${currSym}${fmt(tL)}</td>`; }
            rowL += `<td class="p-2 font-black text-red-700">-${currSym}${fmt(tL)}</td></tr>`;
            let rowG = `<tr><td class="p-2 text-left font-bold text-green-600">Yatırım Sonrası (Kümülatif Kazanç)</td>`;
            let tG = -finalInvForReport;
            for(let y=1; y<=5; y++){ tG += gSave; rowG += `<td class="p-2 ${tG>=0?'text-green-600':'text-red-400'}">${currSym}${fmt(tG)}</td>`; }
            rowG += `<td class="p-2 font-black ${tG>=0?'text-green-700':'text-red-700'}">${tG>0?'+':''}${currSym}${fmt(tG)}</td></tr>`;
            pt.innerHTML = rowL + rowG;

            setTimeout(()=>{ lucide.createIcons(); window.print(); }, 100);

        }catch(e){ alert('Rapor oluşturulurken hata oluştu: ' + e.message); console.error(e); }
    }
</script>
  <script src="guard.js?v=2"></script>
</body>
</html>


