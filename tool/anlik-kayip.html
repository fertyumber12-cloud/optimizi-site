<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Enerji KayÄ±p ve KaÃ§ak Analizi</title>
 <style>
  /* Auth kontrolÃ¼ yapÄ±lana kadar sayfa gizli */
  body:not(.auth-checked) {
    opacity: 0;
    pointer-events: none;
  }
  
  body.auth-checked {
    opacity: 1;
    transition: opacity 0.3s ease;
  }
</style>
<meta name="description" content="Ä°ÅŸletmenizdeki yalÄ±tÄ±msÄ±z yÃ¼zeylerden kaynaklanan yÄ±llÄ±k finansal kaybÄ± hesaplayÄ±n.">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
 
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="../auth.js"></script>
  
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="icon" href="../favicon.png" type="image/png">
    
</head>
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
      extend: {
        colors: { slate: { 850: '#151e2e', 900: '#0f172a', 950: '#020617' } },
        animation: { 'float-slow': 'float 8s ease-in-out infinite', 'blob': 'blob 20s infinite', },
        keyframes: {
            float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' }, },
            blob: { '0%': { transform: 'translate(0px, 0px) scale(1)' }, '33%': { transform: 'translate(30px, -50px) scale(1.1)' }, '66%': { transform: 'translate(-20px, 20px) scale(0.9)' }, '100%': { transform: 'translate(0px, 0px) scale(1)' }, }
        }
      }
    }
  }
</script>
<style>
  :root {
      --bg-color: #f1f5f9; 
      --glass-bg: #ffffff;
      --glass-border: rgba(148, 163, 184, 0.4);
      --input-bg: #f8fafc;
      --input-border: #cbd5e1;
      --text-main: #0f172a; 
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --grid-color: rgba(0, 0, 0, 0.05);
  }

  .dark {
      --bg-color: #0f172a;
      --glass-bg: rgba(30, 41, 59, 0.4);
      --glass-border: rgba(255, 255, 255, 0.08);
      --input-bg: rgba(15, 23, 42, 0.6);
      --input-border: rgba(255, 255, 255, 0.1);
      --text-main: #f1f5f9;
      --card-shadow: none;
      --grid-color: rgba(255, 255, 255, 0.03);
  }

  .grid-input {
      background: transparent;
      border: 1px solid transparent;
      border-radius: 4px;
      padding: 4px;
      width: 100%;
      text-align: center;
      transition: all 0.2s;
      font-weight: bold;
  }
  .grid-input:hover { border-color: #cbd5e1; background-color: rgba(255,255,255,0.1); }
  .grid-input:focus { border-color: #ef4444; background-color: rgba(255,255,255,0.2); outline: none; }

  html:not(.dark) .blob-bg { display: none; }
  
  html.dark body {
      background: radial-gradient(ellipse at top, #1e1b4b 0%, #0f172a 40%, #020617 100%);
      background-attachment: fixed;
  }

  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #64748b; }
  
  html { scroll-behavior: smooth; }
  
  body { 
      background-color: var(--bg-color); 
      color: var(--text-main); 
      overflow-x: hidden; 
      transition: background-color 0.3s ease, color 0.3s ease;
  }
  
  .app-container { max-width: 1440px; margin: 0 auto; width: 100%; }

  .glass-card { 
      transition: all 0.3s ease; 
      background-color: var(--glass-bg); 
      backdrop-filter: blur(16px); 
      border: 1px solid var(--glass-border); 
      box-shadow: var(--card-shadow);
  }
  
  .glass-input { 
      transition: all 0.2s; 
      border-radius: 0.5rem; 
      padding: 0.6rem 0.75rem; 
      width: 100%; 
      background-color: var(--input-bg); 
      border: 1px solid var(--input-border); 
      color: var(--text-main); 
  }
  .glass-input:focus { outline: none; border-color: #ef4444; box-shadow: 0 0 0 2px rgba(239,68,68,0.1); }
  
  .bg-grid { 
      background-size: 40px 40px; 
      background-image: 
          linear-gradient(to right, var(--grid-color) 1px, transparent 1px), 
          linear-gradient(to bottom, var(--grid-color) 1px, transparent 1px); 
      mask-image: radial-gradient(circle at center, black 70%, transparent 100%); 
      pointer-events: none; 
  }

  /* --- PRINT STYLES --- */
  @media print {
    @page { margin: 0; size: A4; }
    html, body { width: 210mm; height: 297mm; margin: 0 !important; padding: 0 !important; background: white !important; color: black !important; overflow: visible !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    #app-layer, .bg-grid, .blob-bg, nav, .glass-card, button, input { display: none !important; }
    #print-area { display: block !important; }
    .print-page { width: 210mm; height: 296mm; position: relative; page-break-after: always; overflow: hidden; background: white; }
    .print-page:last-child { page-break-after: auto; }
    
    .cover-bg { background-color: white !important; color: #1e293b !important; }
    /* Table Styles */
    .audit-table th { background-color: #fef2f2; color: #991b1b; font-weight: 700; text-transform: uppercase; font-size: 7px; padding: 4px; border-bottom: 2px solid #ef4444; }
    .audit-table td { border-bottom: 1px solid #e2e8f0; padding: 4px; font-size: 8px; color: #334155; vertical-align: middle; }
    .audit-table tr:nth-child(even) { background-color: #fef2f2; }
  }
  #print-area { display: none; }
  #qr-generator-dump { display: none; }
</style>
</head>
<body class="antialiased selection:bg-red-500/30 selection:text-red-600" onload="initApp()">

<div class="fixed inset-0 z-0 pointer-events-none overflow-hidden">
    <div class="absolute inset-0 bg-grid"></div>
    <div class="blob-bg absolute top-0 -left-1/4 w-[900px] h-[900px] bg-red-500/10 rounded-full blur-[120px] animate-blob mix-blend-multiply dark:mix-blend-screen"></div>
    <div class="blob-bg absolute bottom-0 -right-1/4 w-[900px] h-[900px] bg-orange-500/10 rounded-full blur-[120px] animate-blob mix-blend-multiply dark:mix-blend-screen" style="animation-delay: 5s;"></div>
</div>

<div id="app-layer" class="relative z-10 flex flex-col min-h-screen">
    <nav class="sticky top-0 z-50 glass-card !bg-white/90 dark:!bg-slate-900/80 !border-x-0 !border-t-0 !rounded-none border-b border-slate-200 dark:border-white/10 backdrop-blur-xl">
      <div class="app-container px-6 h-16 flex items-center justify-between">
          <a href="../dashboard.html" class="flex items-center gap-3 group cursor-pointer hover:opacity-80 transition">
              <div><h1 class="text-lg font-bold text-slate-800 dark:text-white tracking-wide">Optimizi<span class="text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-orange-500">.AnlÄ±k KayÄ±p</span></h1></div>
          </a>
          <div class="flex items-center gap-3">
              <div class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700/50 text-xs text-slate-500 dark:text-slate-300">
                  <span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span>
                  <span id="fxVal" class="font-bold text-slate-800 dark:text-white">...</span> <span class="text-[10px] opacity-70">TL/USD</span>
                  <button onclick="getFx()"><i data-lucide="refresh-cw" class="w-3 h-3 ml-1 hover:animate-spin text-slate-400 hover:text-red-500 dark:hover:text-white cursor-pointer"></i></button>
              </div>
              
              <button onclick="toggleTheme()" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-white/5 text-slate-400 hover:text-red-600 dark:hover:text-white transition cursor-pointer">
                  <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                  <i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i>
              </button>
              
              <button onclick="saveData()" class="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg text-xs font-bold transition shadow-lg shadow-emerald-600/20 active:scale-95 cursor-pointer">
                  <i data-lucide="save" class="w-4 h-4"></i> Kaydet
              </button>
              
              <button onclick="showReportLangPopup()" class="flex items-center gap-2 bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded-lg text-xs font-bold transition shadow-lg shadow-red-600/20 active:scale-95 ml-2 cursor-pointer">
                  <i data-lucide="file-warning" class="w-4 h-4"></i> KayÄ±p Raporu
              </button>
          </div>
      </div>
    </nav>

    <main class="flex-1 app-container p-6 lg:p-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="glass-card p-6 relative overflow-hidden group rounded-2xl border-red-500/20">
               <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition transform group-hover:scale-110"><i data-lucide="flame" class="w-24 h-24 text-red-500"></i></div>
               <div class="text-red-500 dark:text-red-400 text-[10px] font-bold uppercase tracking-wider mb-2">Toplam YÄ±llÄ±k KayÄ±p</div>
               <div class="text-4xl font-black text-red-600 dark:text-red-500 tracking-tight" id="dashLossMoney">0</div>
               <div class="mt-2 text-xs text-slate-500">Ä°ÅŸletmenizin havaya savurduÄŸu tutar.</div>
            </div>
            <div class="glass-card p-6 relative overflow-hidden group rounded-2xl">
               <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition"><i data-lucide="zap-off" class="w-24 h-24 text-orange-500"></i></div>
               <div class="text-slate-500 dark:text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-2">BoÅŸa Harcanan Enerji</div>
               <div class="text-3xl font-bold text-orange-600 dark:text-orange-400 tracking-tight" id="dashLossKwh">0</div>
               <div class="mt-2 text-xs text-slate-500">kWh/YÄ±l</div>
            </div>
            <div class="glass-card p-6 relative overflow-hidden rounded-2xl">
               <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition"><i data-lucide="factory" class="w-24 h-24 text-slate-500"></i></div>
               <div class="text-slate-500 dark:text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-2">Gereksiz Emisyon</div>
               <div class="text-3xl font-bold text-slate-800 dark:text-white tracking-tight" id="dashCo2">0 <span class="text-sm font-normal text-slate-500">Ton</span></div>
               <div class="mt-2 text-xs text-slate-500">CO2 SalÄ±mÄ±</div>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-12 gap-8 items-start">
            <div class="xl:col-span-4 space-y-6 max-h-[calc(100vh-120px)] overflow-y-auto pr-2">
                <div class="glass-card p-6 rounded-2xl">
                   <h3 class="text-red-500 dark:text-red-400 text-xs font-bold uppercase mb-4 flex items-center gap-2"><i data-lucide="briefcase" class="w-4 h-4"></i> Firma & Proje</h3>
                   <div class="space-y-4">
                       <div><label class="text-[10px] uppercase text-slate-500 font-bold mb-1 block">HazÄ±rlayan</label><div class="grid gap-2"><input type="text" id="pName" class="glass-input text-xs" placeholder="Firma AdÄ±"><input type="text" id="pEng" class="glass-input text-xs" placeholder="MÃ¼hendis AdÄ±"></div></div>
                       <div class="h-px bg-slate-200 dark:bg-white/5 my-3"></div>
                       <div><label class="text-[10px] uppercase text-slate-500 font-bold mb-1 block">Firma Bilgileri</label><div class="grid gap-2"><input type="text" id="cName" class="glass-input text-xs" placeholder="Firma AdÄ±"><input type="text" id="cEng" class="glass-input text-xs" placeholder="Yetkili KiÅŸi / Ãœnvan"></div></div>
                   </div>
                </div>

                <div class="glass-card p-6 rounded-2xl">
                    <h3 class="text-orange-500 dark:text-orange-400 text-xs font-bold uppercase mb-4 flex items-center gap-2"><i data-lucide="flame" class="w-4 h-4"></i> Ortam & YakÄ±t</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">Ortam SÄ±c. (Â°C)</label><input type="number" id="tAmb" class="glass-input text-xs" value="25"></div>
                        <div><label class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">RÃ¼zgar (m/s)</label><input type="number" id="vWind" class="glass-input text-xs" value="0" step="0.5"></div>
                    </div>
                    
                    <div class="mt-4">
                        <label class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">YakÄ±t Tipi</label>
                        <select id="fuel" onchange="toggleFuelMode(); updateGlobalFinancials()" class="glass-input text-xs">
                             <option value="gas">DoÄŸalgaz (8250 kcal/mÂ³)</option>
                             <option value="elec">Elektrik (860 kcal/kWh)</option>
                             <option value="lng">LNG (11500 kcal/kg)</option>
                             <option value="fueloil">Fuel Oil (9600 kcal/kg)</option>
                             <option value="coal_imp">Ä°thal KÃ¶mÃ¼r (6000 kcal/kg)</option>
                             <option value="coal_loc">Yerli KÃ¶mÃ¼r (3500 kcal/kg)</option>
                             <option value="manual" class="font-bold text-red-500">âš¡ Manuel GiriÅŸ</option>
                        </select>
                    </div>

                    <div id="manualFuelBox" class="hidden mt-3 p-3 rounded-lg bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-white/10">
                         <div class="grid grid-cols-2 gap-3">
                             <div>
                                 <label class="text-[9px] text-slate-500 font-bold mb-1 block">LHV (kcal)</label>
                                 <input type="number" id="fuelLhv" onchange="updateGlobalFinancials()" class="glass-input text-xs" placeholder="Ã–rn: 8250">
                             </div>
                             <div>
                                 <label class="text-[9px] text-slate-500 font-bold mb-1 block">Birim</label>
                                 <select id="fuelUnit" onchange="updateGlobalFinancials()" class="glass-input text-xs">
                                     <option value="m3">kcal/mÂ³</option>
                                     <option value="kg">kcal/kg</option>
                                     <option value="kwh">kcal/kWh</option>
                                 </select>
                             </div>
                         </div>
                    </div>
                    
                    <div class="mt-4">
                        <label class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">Kazan Verimi %</label>
                        <input type="number" id="eff" onchange="updateGlobalFinancials()" class="glass-input text-center text-xs" value="85">
                    </div>

                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div>
                            <label class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">Birim Fiyat</label>
                            <div class="flex gap-1"><input type="number" id="price" onchange="updateGlobalFinancials()" class="glass-input text-xs" value="0.15"><select id="energyCurr" onchange="updateGlobalFinancials()" class="glass-input !px-1 w-14 text-center text-xs"><option value="TL" selected>â‚º</option><option value="USD">$</option><option value="EUR">â‚¬</option><option value="GBP">Â£</option></select></div>
                        </div>
                        <div><label class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">YÄ±llÄ±k Saat</label><input type="number" id="hours" onchange="updateGlobalFinancials()" class="glass-input text-xs" value="8000"></div>
                    </div>
                </div>

                <div class="glass-card p-6 border-red-500/30 shadow-[0_0_20px_rgba(239,68,68,0.1)] rounded-2xl relative overflow-hidden">
                    <h3 class="text-slate-800 dark:text-white text-sm font-bold uppercase mb-4 flex items-center gap-2 relative z-10"><i data-lucide="plus-circle" class="w-4 h-4 text-red-500"></i> KayÄ±p NoktasÄ± Ekle</h3>
                    
                    <div class="flex bg-slate-100 dark:bg-slate-900/50 rounded-lg p-1 mb-4 border border-slate-200 dark:border-white/5 relative z-10">
                        <button onclick="setType('valve')" id="btn-valve" class="flex-1 py-1.5 text-xs font-medium rounded text-white bg-slate-700 shadow transition-all">ArmatÃ¼r</button>
                        <button onclick="setType('pipe')" id="btn-pipe" class="flex-1 py-1.5 text-xs font-medium rounded text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-all">Boru</button>
                        <button onclick="setType('tank')" id="btn-tank" class="flex-1 py-1.5 text-xs font-medium rounded text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-all">Tank/DÃ¼z</button>
                    </div>
                    <select id="type" class="hidden"><option value="valve">Valve</option><option value="pipe">Pipe</option><option value="tank">Flat</option></select>
                    
                    <div id="g-valve" class="space-y-3 relative z-10">
                        <select id="valveType" class="glass-input text-xs">
                            <optgroup label="Vanalar">
                                <option value="gate">SÃ¼rgÃ¼lÃ¼ Vana</option>
                                <option value="globe">Glob Vana</option>
                                <option value="ball">KÃ¼resel Vana</option>
                                <option value="butterfly">Kelebek Vana</option>
                                <option value="check">Ã‡ekvalf</option>
                                <option value="strainer">Pislik Tutucu</option>
                                <option value="separator">Buhar SeperatÃ¶rÃ¼</option>
                            </optgroup>
                            <optgroup label="BaÄŸlantÄ± ElemanlarÄ±">
                                <option value="flange">FlanÅŸ Ã‡ifti (TakÄ±m)</option>
                                <option value="elbow">Dirsek (90Â°)</option>
                            </optgroup>
                            <optgroup label="Kondenstoplar">
                                <option value="trap_float">ÅžamandÄ±ralÄ±</option>
                                <option value="trap_thermo">Termodinamik</option>
                                <option value="trap_bimetal">Bimetalik</option>
                                <option value="trap_bucket">Ters KovalÄ±</option>
                            </optgroup>
                        </select>
                        <select id="vDN" class="glass-input text-xs"></select>
                    </div>
                    <div id="g-pipe" class="hidden grid grid-cols-2 gap-3 relative z-10"><select id="pDN" class="glass-input text-xs"></select><input type="number" id="pLen" class="glass-input text-xs" placeholder="Boru UzunluÄŸu (m)" value="1"></div>
                    
                    <div id="g-tank" class="hidden relative z-10">
                        <div class="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg border border-slate-200 dark:border-white/5 mb-3">
                            <label class="text-[10px] text-slate-500 dark:text-slate-400 mb-2 block font-bold">YÃ¼zey Ã–lÃ§Ã¼leri Ekle (cm)</label>
                            <div class="flex gap-2 mb-2">
                                <input type="number" id="surfW" class="glass-input text-xs" placeholder="En (cm)">
                                <input type="number" id="surfH" class="glass-input text-xs" placeholder="Boy (cm)">
                                <button onclick="addSurface()" class="bg-red-500 hover:bg-red-600 text-white rounded-lg px-3 flex items-center justify-center transition"><i data-lucide="plus" class="w-4 h-4"></i></button>
                            </div>
                            <div id="surfaceList" class="space-y-1 mb-2 max-h-24 overflow-y-auto"></div>
                            <div class="text-right text-[10px] text-slate-500 dark:text-slate-400 border-t border-slate-200 dark:border-white/5 pt-2">
                                Toplam Alan: <span id="totalSurfArea" class="font-bold text-slate-800 dark:text-white text-xs">0.00</span> mÂ²
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mt-4 relative z-10">
                        <div><label class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">Ã–lÃ§Ã¼len YÃ¼zey SÄ±c. (Â°C)</label><div class="relative"><input type="number" id="tProc" class="glass-input pl-8 text-xs font-bold text-red-600" value="150"><i data-lucide="thermometer" class="w-3 h-3 text-red-500 absolute left-2.5 top-2.5"></i></div></div>
                        <div><label id="lblQty" class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">Adet</label><input type="number" id="qty" class="glass-input text-center font-bold text-xs" value="1"></div>
                    </div>
                    
                    <div class="mt-4 relative z-10">
                         <label class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">Mahal / Lokasyon</label>
                         <input type="text" id="location" class="glass-input text-xs" placeholder="Ã–rn: Kazan Dairesi">
                    </div>

                    <div class="mt-4 relative z-10">
                        <input type="file" id="imgInp" class="hidden" accept="image/*" onchange="readImg(this)">
                        <div onclick="document.getElementById('imgInp').click()" class="border border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-3 text-center cursor-pointer hover:border-red-500 hover:bg-slate-100 dark:hover:bg-slate-800/50 transition group"><i data-lucide="camera" class="w-4 h-4 text-slate-400 dark:text-slate-500 mx-auto group-hover:text-red-500 dark:group-hover:text-red-400 mb-1"></i><span class="text-[10px] text-slate-400 block">Termal Foto SeÃ§</span></div>
                        <img id="prevImg" class="hidden w-full h-24 object-cover rounded-lg mt-2 border border-slate-300 dark:border-slate-600">
                    </div>

                    <div class="bg-slate-100 dark:bg-slate-900/50 rounded-lg p-3 mt-4 border border-slate-200 dark:border-white/5 relative z-10">
                        <label class="text-[10px] text-slate-500 font-bold uppercase mb-2 block flex items-center gap-1">Potansiyel Tasarruf HesabÄ± Ä°Ã§in:</label>
                        <div class="mb-2"><select id="calcStd" class="glass-input text-[10px] !py-1 !h-7 text-slate-500 dark:text-slate-300"><option value="iso">ISO 12241 (Standard)</option><option value="astm">ASTM C680 (USA)</option><option value="vdi">VDI 2055 (German)</option></select></div>
                        <select id="matSelect" class="glass-input text-xs mb-2">
                            <option value="rockwool">TaÅŸ YÃ¼nÃ¼ (Sanayi)</option>
                            <option value="glasswool">Ä°ÄŸnelenmiÅŸ Cam Elyaf</option> 
                            <option value="rubber">Elastomerik KauÃ§uk</option>
                            <option value="aerogel">Aerogel</option>
                            <option value="ceramic">Seramik YÃ¼nÃ¼</option>
                        </select>
                        <div class="grid grid-cols-2 gap-2 mt-2 mb-2">
                            <input type="number" id="thk" class="glass-input text-xs" value="50" placeholder="Ref. KalÄ±nlÄ±k (mm)">
                            <div class="flex items-center text-[10px] text-slate-400 pl-1">
                                (Bu kalÄ±nlÄ±kta yalÄ±tÄ±m yapÄ±lsa ne kadar kurtarÄ±rÄ±z?)
                            </div>
                        </div>
                        
                        <div class="mt-2 pt-2 border-t border-slate-300 dark:border-white/10">
                            <label class="flex items-center gap-2 cursor-pointer mb-2">
                                <input type="checkbox" id="useL2" onchange="toggleL2()" class="w-3 h-3 rounded border-slate-400 text-red-500">
                                <span class="text-[10px] text-slate-500 dark:text-slate-400 font-bold">2. Katman (Kompozit)</span>
                            </label>
                            <div id="layer2Box" class="hidden">
                                <select id="matSelect2" class="glass-input text-xs mb-2">
                                    <option value="rubber" selected>Elastomerik KauÃ§uk</option>
                                    <option value="rockwool">TaÅŸ YÃ¼nÃ¼</option>
                                    <option value="glasswool">Cam Elyaf</option>
                                    <option value="aerogel">Aerogel</option>
                                    <option value="ceramic">Seramik YÃ¼nÃ¼</option>
                                </select>
                                <input type="number" id="thk2" class="glass-input text-xs" value="19" placeholder="KalÄ±nlÄ±k (mm)">
                            </div>
                        </div>

                        <div class="mt-3 text-right">
                            <label class="text-[9px] text-slate-500 mr-2 uppercase font-bold">Rapor Para Birimi:</label>
                            <select id="curr" class="glass-input text-[10px] !w-20 inline-block !py-1 !h-7"><option value="TL" selected>â‚º TL</option><option value="USD">$ USD</option><option value="EUR">â‚¬ EUR</option><option value="GBP">Â£ GBP</option></select>
                        </div>
                    </div>

                    <div id="btn-group" class="mt-4 relative z-10">
                        <button id="btnAdd" onclick="calc()" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-red-600/20 transition active:scale-95 flex items-center justify-center gap-2 text-sm cursor-pointer"><i data-lucide="plus" class="w-4 h-4"></i> Hesapla & Listeye Ekle</button>
                        <button id="btnUpdate" onclick="finishUpdate()" class="hidden w-full bg-orange-500 hover:bg-orange-400 text-white font-bold py-3 rounded-xl shadow-lg shadow-orange-500/20 transition active:scale-95 flex items-center justify-center gap-2 text-sm cursor-pointer"><i data-lucide="check" class="w-4 h-4"></i> GÃ¼ncellemeyi Bitir</button>
                    </div>
                </div>
            </div>

            <div class="xl:col-span-8">
                <div class="glass-card p-0 overflow-hidden min-h-[600px] flex flex-col rounded-2xl">
                    <div class="p-4 border-b border-slate-200 dark:border-white/5 flex justify-between items-center bg-slate-50 dark:bg-slate-900/30">
                        <h3 class="font-bold text-slate-800 dark:text-white flex items-center gap-2"><i data-lucide="list" class="w-4 h-4 text-red-500"></i> KaÃ§ak NoktasÄ± Listesi</h3>
                        <div class="flex gap-2">
                             <button onclick="clearAll()" class="text-xs text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 transition cursor-pointer">Temizle</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto overflow-y-auto max-h-[500px] flex-1">
                        <table class="w-full text-left text-sm" id="grid">
                        <thead class="bg-slate-100 dark:bg-slate-900/80 text-[10px] uppercase text-slate-500 dark:text-slate-400 font-semibold sticky top-0 backdrop-blur-md">
                            <tr>
                            <th class="px-6 py-3">GÃ¶rsel</th>
                            <th class="px-6 py-3">BileÅŸen</th>
                            <th class="px-6 py-3 text-center">Adet</th>
                            
                            <th class="px-6 py-3 text-center text-red-500">Ã‡Ä±plak KayÄ±p<br><span class="text-[9px]">(kWh/YÄ±l)</span></th>
                            <th class="px-6 py-3 text-center text-orange-500">YalÄ±tÄ±mlÄ± KayÄ±p<br><span class="text-[9px]">(kWh/YÄ±l)</span></th>
                            <th class="px-6 py-3 text-center text-green-600">KazanÃ§<br><span class="text-[9px]">(Fark kWh)</span></th>
                            
                            <th class="px-6 py-3 text-right text-red-600 dark:text-red-400">YÄ±llÄ±k Finansal KarÅŸÄ±lÄ±ÄŸÄ±</th>
                            <th class="px-6 py-3 text-right">Ä°ÅŸlem</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200 dark:divide-slate-700/50" id="gridBody">
                            <tr><td colspan="8" class="px-6 py-20 text-center text-slate-500"><i data-lucide="search" class="w-12 h-12 mx-auto mb-3 opacity-20"></i><span id="emptyMsg">HenÃ¼z kayÄ±p noktasÄ± eklenmedi.</span></td></tr>
                        </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="print-area">
    <div id="p-cover" class="print-page cover-bg relative overflow-hidden flex flex-col bg-white">
        <div class="flex-1 flex flex-col relative p-12 pb-4">
            <div class="absolute top-0 right-0 p-8 opacity-[0.03]"><i data-lucide="flame" class="w-64 h-64 text-slate-900"></i></div>
            
            <div class="flex justify-between items-start mb-4 relative z-10">
                <div>
                    <div class="text-4xl font-black tracking-tighter text-slate-900">Optimizi<span class="text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-orange-500">.App</span></div>
                    <div class="text-[9px] uppercase tracking-[4px] text-slate-400 mt-0.5">Energy Loss Detection</div>
                </div>
                <div class="inline-block bg-red-100 text-red-700 px-3 py-1 rounded text-[9px] font-bold uppercase tracking-wider" id="covIsoLabel">ISO 12241</div>
            </div>

            <div class="relative z-10 mb-4 mt-8">
                <h1 class="text-5xl font-black text-slate-900 leading-none mb-3" id="covMainTitle">TERMAL <br><span class="text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-orange-600">KAYIP</span> ANALÄ°ZÄ°</h1>
                <p class="text-xs text-slate-500 leading-relaxed max-w-lg" id="covIntro">
                    Tesisinizde gerÃ§ekleÅŸtirilen termal denetimler sonucunda; yalÄ±tÄ±msÄ±z ekipmanlardan kaynaklanan Ä±sÄ± kayÄ±plarÄ± ve finansal maliyetler hesaplanmÄ±ÅŸtÄ±r.
                </p>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-4 relative z-10">
                <div class="border border-slate-200 rounded-xl p-3">
                    <div class="text-[9px] uppercase text-slate-400 font-bold mb-1" id="covClientLabel">Firma / MÃ¼ÅŸteri</div>
                    <div class="text-base font-bold text-slate-900 leading-tight" id="covClient">FÄ°RMA ADI</div>
                    <div class="text-xs text-slate-400 mt-0.5" id="covContact">Yetkili KiÅŸi</div>
                </div>
                <div class="border border-slate-200 rounded-xl p-3">
                    <div class="text-[9px] uppercase text-slate-400 font-bold mb-1" id="covProvLabel">TedarikÃ§i / HazÄ±rlayan</div>
                    <div class="text-base font-bold text-slate-900" id="covProv">TEDARÄ°KÃ‡Ä°</div>
                    <div class="text-xs text-slate-400 mt-0.5" id="covDate">...</div>
                </div>
            </div>

            <div class="bg-slate-50 rounded-xl border border-slate-200 p-4 mb-4 relative z-10">
                <div class="text-[9px] uppercase text-slate-400 font-bold mb-2 tracking-wider">SimÃ¼lasyon Parametreleri</div>
                <div class="text-xs text-slate-600 leading-relaxed" id="covNarrative">...</div>
            </div>

            <div class="flex flex-col gap-1.5 relative z-10">
                <div class="p-2 bg-slate-50 rounded-lg border border-slate-100 flex items-center justify-between">
                     <div class="text-xs font-bold text-slate-400 uppercase tracking-wide w-24" id="covDailyLabel">GÃœNLÃœK</div>
                     <div class="text-base font-black text-slate-700 text-right flex-1" id="covMoneyDay">0</div>
                </div>
                <div class="p-2 bg-slate-50 rounded-lg border border-slate-100 flex items-center justify-between">
                     <div class="text-xs font-bold text-slate-400 uppercase tracking-wide w-24" id="covWeeklyLabel">HAFTALIK</div>
                     <div class="text-base font-black text-slate-700 text-right flex-1" id="covMoneyWeek">0</div>
                </div>
                <div class="p-2 bg-slate-50 rounded-lg border border-slate-100 flex items-center justify-between">
                     <div class="text-xs font-bold text-slate-400 uppercase tracking-wide w-24" id="covMonthlyLabel">AYLIK</div>
                     <div class="text-base font-black text-slate-700 text-right flex-1" id="covMoneyMonth">0</div>
                </div>
                <div class="p-2 bg-red-50 rounded-lg border border-red-100 flex items-center justify-between">
                     <div class="text-xs font-bold text-red-400 uppercase tracking-wide w-24" id="covYearlyLabel">YILLIK</div>
                     <div class="text-lg font-black text-red-600 text-right flex-1" id="covMoneyYear">0</div>
                </div>
            </div>
        </div>

        <div class="border-t-2 border-slate-900 mx-12 pt-3 pb-5 flex justify-between items-end relative z-10">
            <div class="qr-report-section">
                <img id="covQrCode" src="" class="w-32 h-32 object-contain" alt="QR">
            </div>
            <div class="text-right">
                <div class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1" id="covEnergyLabel">Toplam Enerji Ä°srafÄ±</div>
                <div class="text-7xl font-black text-slate-900 leading-none"><span id="covKwhTotal">0</span></div>
                <div class="text-sm font-bold text-slate-400 mt-1 uppercase">kWh</div>
            </div>
        </div>
    </div>
    
    <div id="p-table" class="print-page p-12 hidden">
        <div class="flex justify-between items-center border-b-2 border-slate-900 pb-4 mb-8"><h2 class="text-xl font-black text-slate-900 uppercase">Tespit Edilen KaÃ§ak NoktalarÄ±</h2><div class="text-xs text-slate-500" id="rDate">...</div></div>
        <table class="w-full audit-table mb-8"><thead><tr id="rep_table_head"></tr></thead><tbody id="rTable"></tbody></table>
        <div class="page-num mt-auto pt-8 border-t border-slate-200 text-center text-[10px] text-slate-400"></div>
    </div>
    
    <div id="p-summary" class="print-page p-12 flex flex-col h-full hidden">
        <h2 class="text-2xl font-black text-slate-900 uppercase mb-8 border-b-2 border-slate-900 pb-4" id="sumTitle">YÃ¶netici Ã–zeti</h2>
        
        <div class="flex flex-col mb-12">
            <div class="py-6 border-b border-slate-200 flex justify-between items-center group">
                <div>
                    <div class="text-sm text-red-500 font-bold uppercase tracking-widest flex items-center gap-2"><i data-lucide="flame" class="w-4 h-4"></i> <span id="sumLossLabel">Mevcut YÄ±llÄ±k KayÄ±p</span></div>
                    <div class="text-xs text-slate-400 mt-1 font-medium"><span id="sumFuelLost">...</span> <span id="sumFuelUnitLabel">Birim</span></div>
                </div>
                <div class="text-5xl font-black text-red-600" id="sumLoss">0</div>
            </div>

            <div class="py-6 border-b border-slate-200 flex justify-between items-center group">
                <div>
                    <div class="text-sm text-orange-500 font-bold uppercase tracking-widest flex items-center gap-2"><i data-lucide="zap-off" class="w-4 h-4"></i> <span id="sumEnergyLabel">Enerji Ä°srafÄ±</span></div>
                    <div class="text-xs text-slate-400 mt-1">YÄ±llÄ±k Toplam</div>
                </div>
                <div class="text-5xl font-black text-orange-600" id="sumEnergy">0</div>
            </div>

            <div class="py-6 border-b border-slate-900 flex justify-between items-center group">
                <div>
                    <div class="text-sm text-slate-500 font-bold uppercase tracking-widest flex items-center gap-2"><i data-lucide="factory" class="w-4 h-4"></i> <span id="sumCo2Label">Karbon Ayak Ä°zi</span></div>
                    <div class="text-xs text-slate-400 mt-1">COâ‚‚ Emisyonu</div>
                </div>
                <div class="text-5xl font-black text-slate-800"><span id="sumCo2">0</span> <span class="text-2xl font-normal text-slate-500">Ton</span></div>
            </div>
        </div>

        <div class="mb-8">
            <h3 class="text-sm font-bold text-slate-900 uppercase mb-4 flex items-center gap-2"><i data-lucide="bar-chart-3" class="w-4 h-4"></i> <span id="sum5YearLabel">Finansal Projeksiyon (5 YÄ±l)</span></h3>
            <table class="w-full text-xs text-right border-collapse">
                <thead>
                    <tr class="bg-slate-100 text-slate-500">
                        <th class="p-2 text-left" id="sumScenarioLabel">Senaryo</th>
                        <th class="p-2" id="sumYear1Label">YÄ±l 1</th>
                        <th class="p-2" id="sumYear2Label">YÄ±l 2</th>
                        <th class="p-2" id="sumYear3Label">YÄ±l 3</th>
                        <th class="p-2" id="sumYear4Label">YÄ±l 4</th>
                        <th class="p-2" id="sumYear5Label">YÄ±l 5</th>
                        <th class="p-2 font-black" id="sumTotalLabel">TOPLAM</th>
                    </tr>
                </thead>
                <tbody class="font-mono" id="projTable"></tbody>
            </table>
        </div>
        
        <div class="flex gap-8 mb-4">
             <div class="flex-1 rounded-xl p-6 flex items-center justify-between relative overflow-hidden h-full border-2 border-red-200" style="background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%); color: white;">
                  <div class="absolute right-0 bottom-0 opacity-10 pointer-events-none translate-x-4 translate-y-4"><i data-lucide="flame" class="w-48 h-48 text-white"></i></div>
                 <div class="z-10">
                     <div class="text-sm font-bold uppercase tracking-widest" style="color: #fca5a5;" id="sumCumulativeLabel">5 YILLIK KÃœMÃœLATÄ°F ZARAR</div>
                     <div class="text-5xl font-black mt-2" id="sumCumulativeLoss">0</div>
                 </div>
                 <div class="text-right z-10 pl-8" style="border-left: 1px solid #991b1b;">
                     <div class="text-5xl font-black" id="sumCumulativePercent">500%</div>
                     <div class="text-sm mt-1" style="color: #fca5a5;">ArtÄ±ÅŸ OranÄ±</div>
                 </div>
             </div>
         </div>

        <div class="border-t-2 border-slate-100 pt-4 mt-auto">
            <p class="text-[10px] text-slate-400 text-center font-medium leading-relaxed" id="sumNote">Bu raporda yer alan tÃ¼m hesaplamalar ISO 12241 mÃ¼hendislik standartlarÄ±na gÃ¶re, Ã¶lÃ§Ã¼len yÃ¼zey sÄ±caklÄ±klarÄ± ve verilen parametreler baz alÄ±narak bilgisayar simÃ¼lasyonu ile yapÄ±lmÄ±ÅŸtÄ±r. SonuÃ§lar teorik deÄŸerleri yansÄ±tmakta olup, fiili koÅŸullardaki sapmalara baÄŸlÄ± olarak deÄŸiÅŸiklik gÃ¶sterebilir.</p>
        </div>
    </div>
</div>

<div id="reportLangPopup" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/50 backdrop-blur-sm" style="display:none;">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-sm w-full mx-4 transform transition-all scale-95 opacity-0" id="reportLangPopupInner">
        <div class="text-center mb-6">
            <div class="w-14 h-14 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-3">
                <i data-lucide="languages" class="w-7 h-7 text-red-600 dark:text-red-500"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-800 dark:text-slate-100">Rapor Dili SeÃ§in</h3>
            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Raporun tÃ¼m iÃ§eriÄŸi seÃ§tiÄŸiniz dilde oluÅŸturulacaktÄ±r.</p>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-4">
            <button onclick="generateReport('tr')" class="flex flex-col items-center gap-2 p-4 rounded-xl border-2 border-slate-200 dark:border-slate-600 hover:border-red-500 dark:hover:border-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition cursor-pointer group">
                <span class="text-3xl">ðŸ‡¹ðŸ‡·</span>
                <span class="text-sm font-bold text-slate-700 dark:text-slate-200 group-hover:text-red-600 dark:group-hover:text-red-400">TÃ¼rkÃ§e</span>
            </button>
            <button onclick="generateReport('en')" class="flex flex-col items-center gap-2 p-4 rounded-xl border-2 border-slate-200 dark:border-slate-600 hover:border-red-500 dark:hover:border-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition cursor-pointer group">
                <span class="text-3xl">ðŸ‡¬ðŸ‡§</span>
                <span class="text-sm font-bold text-slate-700 dark:text-slate-200 group-hover:text-red-600 dark:group-hover:text-red-400">English</span>
            </button>
        </div>
        <button onclick="closeReportLangPopup()" class="w-full text-sm text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition py-2 cursor-pointer">Ä°ptal</button>
    </div>
</div>

<div id="deleteConfirmPopup" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/50 backdrop-blur-sm" style="display:none;">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-sm w-full mx-4 transform transition-all" id="deleteConfirmInner">
        <div class="text-center mb-6">
            <div class="w-14 h-14 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-3">
                <i data-lucide="trash-2" class="w-7 h-7 text-red-600"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-800 dark:text-slate-100">Silme OnayÄ±</h3>
            <p class="text-sm text-slate-500 dark:text-slate-400 mt-2" id="deleteConfirmMsg">Bu kalemi silmek istediÄŸinize emin misiniz?</p>
        </div>
        <div class="grid grid-cols-2 gap-3">
            <button onclick="closeDeletePopup()" class="py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-300 font-bold text-sm hover:bg-slate-50 dark:hover:bg-slate-700 transition cursor-pointer">Ä°ptal</button>
            <button onclick="confirmDelete()" class="py-2.5 rounded-xl bg-red-600 hover:bg-red-500 text-white font-bold text-sm transition cursor-pointer shadow-lg shadow-red-600/20">Sil</button>
        </div>
    </div>
</div>

<div id="customAlertPopup" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/50 backdrop-blur-sm" style="display:none;">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-sm w-full mx-4 transform transition-all" id="customAlertInner">
        <div class="text-center mb-6">
            <div class="w-14 h-14 bg-amber-100 dark:bg-amber-900/30 rounded-full flex items-center justify-center mx-auto mb-3">
                <i data-lucide="alert-triangle" class="w-7 h-7 text-amber-600"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-800 dark:text-slate-100" id="customAlertTitle">UyarÄ±</h3>
            <p class="text-sm text-slate-500 dark:text-slate-400 mt-2" id="customAlertMsg">Mesaj</p>
        </div>
        <button onclick="closeCustomAlert()" class="w-full py-2.5 rounded-xl bg-amber-500 hover:bg-amber-400 text-white font-bold text-sm transition cursor-pointer shadow-lg shadow-amber-500/20">Tamam</button>
    </div>
</div>

<div id="customConfirmPopup" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/50 backdrop-blur-sm" style="display:none;">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-sm w-full mx-4 transform transition-all" id="customConfirmInner">
        <div class="text-center mb-6">
            <div class="w-14 h-14 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-3">
                <i data-lucide="help-circle" class="w-7 h-7 text-blue-600"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-800 dark:text-slate-100" id="customConfirmTitle">Onay</h3>
            <p class="text-sm text-slate-500 dark:text-slate-400 mt-2" id="customConfirmMsg">Mesaj</p>
        </div>
        <div class="grid grid-cols-2 gap-3">
            <button onclick="closeCustomConfirm(false)" class="py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-300 font-bold text-sm hover:bg-slate-50 dark:hover:bg-slate-700 transition cursor-pointer">Ä°ptal</button>
            <button onclick="closeCustomConfirm(true)" class="py-2.5 rounded-xl bg-blue-600 hover:bg-blue-500 text-white font-bold text-sm transition cursor-pointer shadow-lg shadow-blue-600/20">Tamam</button>
        </div>
    </div>
</div>

<div id="qr-generator-dump"></div>

<script>
    function toggleTheme() { document.documentElement.classList.toggle('dark'); }
    function toggleL2() {
        const box = document.getElementById('layer2Box');
        if(document.getElementById('useL2').checked) box.classList.remove('hidden'); else box.classList.add('hidden');
    }
    function toggleFuelMode() {
        const fuel = document.getElementById('fuel').value;
        const box = document.getElementById('manualFuelBox');
        if(fuel === 'manual') box.classList.remove('hidden'); else box.classList.add('hidden');
    }

    function initApp(){ init(); }
    
    function setType(t){
        ['valve','pipe','tank'].forEach(x=>{document.getElementById('g-'+x).classList.add('hidden');});
        document.getElementById('g-'+t).classList.remove('hidden');
        document.getElementById('type').value=t;
        const buttons={valve:document.getElementById('btn-valve'),pipe:document.getElementById('btn-pipe'),tank:document.getElementById('btn-tank')};
        const activeClass="bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow";
        const inactiveClass="text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white";
        Object.values(buttons).forEach(btn=>{btn.className="flex-1 py-1.5 text-xs font-medium rounded transition-all "+inactiveClass;});
        buttons[t].className="flex-1 py-1.5 text-xs font-medium rounded transition-all "+activeClass;
        document.getElementById('qty').disabled = false;
        document.getElementById('qty').value = 1;
    }

    const PIPES={15:21.3,20:26.7,25:33.4,32:42.2,40:48.3,50:60.3,65:73.0,80:88.9,100:114.3,125:141.3,150:168.3,200:219.1,250:273.0,300:323.9,350:355.6,400:406.4,500:508.0};
    const SEPARATORS = {15:0.15, 20:0.18, 25:0.22, 32:0.28, 40:0.35, 50:0.45, 65:0.60, 80:0.75, 100:1.10, 125:1.45, 150:1.90, 200:2.80};
    const VALVE_FACTORS={gate:1.2,globe:1.4,butterfly:0.6,ball:1.0,strainer:1.5,check:0.9,trap_float: 1.6, trap_thermo: 0.8, trap_bimetal: 1.0, trap_bucket: 1.5, flange: 0.35};
    const FUELS={gas: 8250, elec: 860, lng: 11500, fueloil: 9600, coal_imp: 6000, coal_loc: 3500};
    const CO2_FACTORS={gas: 0.202, elec: 0.440, lng: 0.226, fueloil: 0.279, coal_imp: 0.340, coal_loc: 0.380, manual: 0.300};

    let LIST=[],FX={USD:34.50,EUR:36.50,GBP:43.20,TL:1.0},currImg=null,userQrImg=null,editingIndex=null;
    let currentSurfaces = []; 

    function addSurface(){
        const w = parseFloat(document.getElementById('surfW').value);
        const h = parseFloat(document.getElementById('surfH').value);
        if(!w || !h){ alert("LÃ¼tfen En ve Boy giriniz."); return; }
        currentSurfaces.push({w: w, h: h});
        document.getElementById('surfW').value = '';
        document.getElementById('surfH').value = '';
        renderSurfaces();
    }
    function removeSurface(idx){ currentSurfaces.splice(idx,1); renderSurfaces(); }
    function renderSurfaces(){
        const listEl = document.getElementById('surfaceList');
        const totalEl = document.getElementById('totalSurfArea');
        listEl.innerHTML = '';
        let totalAreaM2 = 0;
        currentSurfaces.forEach((s, idx) => {
            const m2 = (s.w * s.h) / 10000;
            totalAreaM2 += m2;
            const div = document.createElement('div');
            div.className = "flex justify-between items-center bg-white dark:bg-white/10 p-1.5 rounded border border-slate-200 dark:border-white/5";
            div.innerHTML = `<span>${s.w} x ${s.h} cm</span> <button onclick="removeSurface(${idx})" class="text-red-500 hover:text-red-700"><i data-lucide="x" class="w-3 h-3"></i></button>`;
            listEl.appendChild(div);
        });
        totalEl.innerText = totalAreaM2.toFixed(3);
        lucide.createIcons();
    }

    // KURYE FONKSÄ°YON (MatematiÄŸi Vercel'e yollar)
    async function getCalculationResult(){
        const qty=parseFloat(document.getElementById('qty').value)||1;
        const type=document.getElementById('type').value;
        const location=document.getElementById('location').value||"";
        const tProc=parseFloat(document.getElementById('tProc').value)||0;
        const tAmb=parseFloat(document.getElementById('tAmb').value)||25;
        const vWindInput = document.getElementById('vWind').value;
        const vWind = (vWindInput === "") ? 0 : parseFloat(vWindInput);
        
        const matKey=document.getElementById('matSelect').value;
        const thk=parseFloat(document.getElementById('thk').value)||0;
        const useL2 = document.getElementById('useL2').checked;
        const matKey2 = useL2 ? document.getElementById('matSelect2').value : null;
        const thk2 = useL2 ? (parseFloat(document.getElementById('thk2').value)||0) : 0;
        const standard=document.getElementById('calcStd').value;
        const pLen = parseFloat(document.getElementById('pLen').value)||1; 
        
        const reportCurrencyCode = document.getElementById('curr').value;
        const reportRate = FX[reportCurrencyCode] || 1; 
        const eff=(parseFloat(document.getElementById('eff').value)||85)/100;
        const priceRaw=parseFloat(document.getElementById('price').value)||0;
        const energyCurrencyCode = document.getElementById('energyCurr').value;
        const energyRate = FX[energyCurrencyCode] || 1;
        const priceInReportCurr = priceRaw * (energyRate / reportRate);
        const hours=parseFloat(document.getElementById('hours').value)||8000;
        
        const vDN = document.getElementById('vDN').value;
        const pDN = document.getElementById('pDN').value;
        const valveType = document.getElementById('valveType').value;
        const selValve = document.getElementById('valveType');
        const valveTypeName = selValve.options[selValve.selectedIndex].text;

        const fuelType = document.getElementById('fuel').value;
        let LHV_Val = 8250; let LHV_Unit = "m3";
        if(fuelType === 'manual') { LHV_Val = parseFloat(document.getElementById('fuelLhv').value) || 0; LHV_Unit = document.getElementById('fuelUnit').value; } else { LHV_Val = FUELS[fuelType]; if(fuelType === 'gas') LHV_Unit = 'm3'; else if(fuelType === 'elec') LHV_Unit = 'kwh'; else LHV_Unit = 'kg'; }
        
        const savedSurfaces = JSON.parse(JSON.stringify(currentSurfaces));

        const payload = {
            qty, type, tProc, tAmb, vWind, matKey, thk, useL2, matKey2, thk2,
            standard, pLen, eff, priceInReportCurr, hours, vDN, pDN, valveType,
            fuelType, LHV_Val, LHV_Unit, currentSurfaces: savedSurfaces, valveTypeName
        };

        let btnEl = document.getElementById('btnAdd');
        if(btnEl.classList.contains('hidden')) btnEl = document.getElementById('btnUpdate');
        const originalText = btnEl ? btnEl.innerHTML : "Hesapla";
        if(btnEl) btnEl.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Ä°ÅŸleniyor...';
        lucide.createIcons();

        try {
            const response = await fetch('/api/anlik-kayip', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error("API HatasÄ±");
            const data = await response.json(); 
            if(btnEl) btnEl.innerHTML = originalText;
            lucide.createIcons();

            const inputs={
                type,qty,pLen,location,
                tProc,tAmb,matKey,thk,
                useL2, matKey2, thk2,
                vDN, pDN, valveType,
                surfaces: savedSurfaces,
                img:currImg,
                energyCurr: energyCurrencyCode,
                fuelType: fuelType,
                fuelLhv: LHV_Val,
                fuelUnit: LHV_Unit,
                vWind: vWind 
            };
            
            return {
                name: data.Name,
                desc: `Ã–lÃ§Ã¼len: ${tProc}Â°C`,
                location: location,
                qty: data.qty,
                unit: data.unitLabel,
                moneyLoss: data.moneyLostBare, 
                potentialSave: data.potentialSaveMoney, 
                fuelLost: data.fuelLostBare,
                fuelUnit: LHV_Unit,
                kwhBare: Math.round(data.energyLostBare_kWh).toLocaleString('tr-TR'), 
                kwhIns: Math.round(data.energyLostIns_kWh).toLocaleString('tr-TR'),   
                kwhSave: Math.round(data.potentialSaveKwh).toLocaleString('tr-TR'),   
                rawKwhLoss: data.energyLostBare_kWh,
                rawKwhIns: data.energyLostIns_kWh, 
                co2: data.co2,
                tSurf: typeof data.Ts === 'number' ? data.Ts.toFixed(1) : data.Ts,
                img:currImg,
                inputs
            };
        } catch(error) {
            console.error(error);
            if(btnEl) btnEl.innerHTML = originalText;
            lucide.createIcons();
            customAlert("Sunucuya baÄŸlanÄ±lamadÄ±. LÃ¼tfen internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.");
            return null;
        }
    }

    // --- YENÄ° FONKSÄ°YON: GLOBAL PARAMETRELERÄ° GÃœNCELLE ---
    function updateGlobalFinancials(){
        const eff = (parseFloat(document.getElementById('eff').value)||85)/100;
        const priceRaw = parseFloat(document.getElementById('price').value)||0;
        const hours = parseFloat(document.getElementById('hours').value)||8000;
        const reportCurrencyCode = document.getElementById('curr').value;
        const reportRate = FX[reportCurrencyCode] || 1; 
        const energyCurrencyCode = document.getElementById('energyCurr').value;
        const energyRate = FX[energyCurrencyCode] || 1;
        const priceInReportCurr = priceRaw * (energyRate / reportRate);
        
        const fuelType = document.getElementById('fuel').value;
        let LHV_Val = 8250; let LHV_Unit = "m3";
        if(fuelType === 'manual') { LHV_Val = parseFloat(document.getElementById('fuelLhv').value) || 0; LHV_Unit = document.getElementById('fuelUnit').value; } else { LHV_Val = FUELS[fuelType]; if(fuelType === 'gas') LHV_Unit = 'm3'; else if(fuelType === 'elec') LHV_Unit = 'kwh'; else LHV_Unit = 'kg'; }
        
        const selectedCo2Factor = CO2_FACTORS[fuelType] || 0.3;

        LIST.forEach(item => {
            const energyLostBare_kWh = item.rawKwhLoss; 
            const fuelLostBare = (energyLostBare_kWh * 860) / (LHV_Val * eff);
            item.moneyLoss = fuelLostBare * priceInReportCurr;
            
            const energyLostIns_kWh = item.rawKwhIns || 0;
            const fuelLostIns = (energyLostIns_kWh * 860) / (LHV_Val * eff);
            const moneyLostIns = fuelLostIns * priceInReportCurr;
            
            item.potentialSave = item.moneyLoss - moneyLostIns;
            item.fuelLost = fuelLostBare;
            item.fuelUnit = LHV_Unit;
            item.co2 = (energyLostBare_kWh / eff) * selectedCo2Factor / 1000;
            
            item.inputs.fuelType = fuelType;
            item.inputs.fuelLhv = LHV_Val;
            item.inputs.fuelUnit = LHV_Unit;
            item.inputs.energyCurr = energyCurrencyCode;
        });

        render();
    }

    function init(){fillDN('vDN');fillDN('pDN');getFx();lucide.createIcons(); setType('valve');}
    function fillDN(id){const el=document.getElementById(id);el.innerHTML='';for(const[k,v]of Object.entries(PIPES)){let o=document.createElement('option');o.value=v;o.text=`DN ${k}`;el.add(o);}if(id==='vDN')el.value=60.3;if(id==='pDN')el.value=88.9;}
    function readImg(i){if(i.files&&i.files[0]){const r=new FileReader();r.onload=e=>{currImg=e.target.result;document.getElementById('prevImg').src=currImg;document.getElementById('prevImg').classList.remove('hidden');};r.readAsDataURL(i.files[0]);}}
    async function getFx(){try{const r=await fetch('https://api.frankfurter.app/latest?from=USD&to=TRY');const d=await r.json();FX.USD=d.rates.TRY;const r2=await fetch('https://api.frankfurter.app/latest?from=EUR&to=TRY');const d2=await r2.json();FX.EUR=d2.rates.TRY;const r3=await fetch('https://api.frankfurter.app/latest?from=GBP&to=TRY');const d3=await r3.json();FX.GBP=d3.rates.TRY;document.getElementById('fxVal').innerText=FX.USD.toFixed(2);}catch(e){}}
    
    async function calc(){
        const res = await getCalculationResult();
        if(res){ LIST.push(res); resetForm(); render(); }
    }
    
    async function finishUpdate(){
        if(editingIndex!==null) {
            const res = await getCalculationResult();
            if(res) LIST[editingIndex] = res;
        }
        editingIndex=null;
        document.getElementById('btnAdd').classList.remove('hidden');
        document.getElementById('btnUpdate').classList.add('hidden');
        resetForm();
        render();
    }
    
    let pendingDeleteIndex = null;

    function edit(i){
        editingIndex=i; const d=LIST[i].inputs;
        setType(d.type);
        document.getElementById('tProc').value = d.tProc;
        document.getElementById('matSelect').value = d.matKey;
        document.getElementById('thk').value = d.thk;
        document.getElementById('qty').value = d.qty;
        document.getElementById('location').value = d.location || ""; 
        document.getElementById('useL2').checked = d.useL2 || false; toggleL2();
        if(d.useL2) { document.getElementById('matSelect2').value = d.matKey2; document.getElementById('thk2').value = d.thk2; }
        if(d.energyCurr) document.getElementById('energyCurr').value = d.energyCurr;
        document.getElementById('fuel').value = d.fuelType || 'gas'; toggleFuelMode();
        if(d.fuelType === 'manual') { document.getElementById('fuelLhv').value = d.fuelLhv; document.getElementById('fuelUnit').value = d.fuelUnit; }
        
        document.getElementById('vWind').value = (d.vWind !== undefined) ? d.vWind : 0;

        if(d.img){ currImg=d.img; document.getElementById('prevImg').src=currImg; document.getElementById('prevImg').classList.remove('hidden'); }
        if(d.type === 'valve'){ document.getElementById('valveType').value = d.valveType; document.getElementById('vDN').value = d.vDN; } 
        else if (d.type === 'pipe'){ document.getElementById('pDN').value = d.pDN; document.getElementById('pLen').value = d.pLen || 1; } 
        else if (d.type === 'tank'){ currentSurfaces = d.surfaces || []; renderSurfaces(); }
        document.getElementById('btnAdd').classList.add('hidden'); document.getElementById('btnUpdate').classList.remove('hidden');
    }

    function showDeletePopup(idx) {
        pendingDeleteIndex = idx;
        const popup = document.getElementById('deleteConfirmPopup');
        const inner = document.getElementById('deleteConfirmInner');
        popup.style.display = 'flex';
        setTimeout(() => {
            popup.classList.remove('hidden');
            inner.style.transform = 'scale(1)';
            inner.style.opacity = '1';
        }, 10);
        lucide.createIcons();
    }

    function closeDeletePopup() {
        pendingDeleteIndex = null;
        const popup = document.getElementById('deleteConfirmPopup');
        const inner = document.getElementById('deleteConfirmInner');
        inner.style.transform = 'scale(0.95)';
        inner.style.opacity = '0';
        setTimeout(() => {
            popup.classList.add('hidden');
            popup.style.display = 'none';
        }, 200);
    }

    function confirmDelete() {
        if (pendingDeleteIndex !== null) {
            LIST.splice(pendingDeleteIndex, 1);
            render();
        }
        closeDeletePopup();
    }

    function del(i){ showDeletePopup(i); }
    function resetForm(){ currImg=null; document.getElementById('prevImg').classList.add('hidden'); document.getElementById('location').value=''; document.getElementById('vWind').value=0; currentSurfaces = []; renderSurfaces(); } 
    function clearAll(){
        customConfirm("TÃ¼m listeyi temizlemek istediÄŸinize emin misiniz?", "Listeyi Temizle").then(res => {
            if(res){ LIST=[]; render(); }
        });
    }
    
    // Custom Alert ve Confirm FonksiyonlarÄ±
    function customAlert(message, title = 'UyarÄ±') {
        document.getElementById('customAlertTitle').innerText = title;
        document.getElementById('customAlertMsg').innerText = message;
        const popup = document.getElementById('customAlertPopup');
        const inner = document.getElementById('customAlertInner');
        popup.style.display = 'flex';
        setTimeout(() => {
            popup.classList.remove('hidden');
            inner.style.transform = 'scale(1)';
            inner.style.opacity = '1';
        }, 10);
        lucide.createIcons();
    }

    function closeCustomAlert() {
        const popup = document.getElementById('customAlertPopup');
        const inner = document.getElementById('customAlertInner');
        inner.style.transform = 'scale(0.95)';
        inner.style.opacity = '0';
        setTimeout(() => {
            popup.classList.add('hidden');
            popup.style.display = 'none';
        }, 200);
    }

    let confirmCallback = null;
    function customConfirm(message, title = 'Onay') {
        return new Promise((resolve) => {
            confirmCallback = resolve;
            document.getElementById('customConfirmTitle').innerText = title;
            document.getElementById('customConfirmMsg').innerText = message;
            const popup = document.getElementById('customConfirmPopup');
            const inner = document.getElementById('customConfirmInner');
            popup.style.display = 'flex';
            setTimeout(() => {
                popup.classList.remove('hidden');
                inner.style.transform = 'scale(1)';
                inner.style.opacity = '1';
            }, 10);
            lucide.createIcons();
        });
    }

    function closeCustomConfirm(result) {
        const popup = document.getElementById('customConfirmPopup');
        const inner = document.getElementById('customConfirmInner');
        inner.style.transform = 'scale(0.95)';
        inner.style.opacity = '0';
        setTimeout(() => {
            popup.classList.add('hidden');
            popup.style.display = 'none';
            if (confirmCallback) {
                confirmCallback(result);
                confirmCallback = null;
            }
        }, 200);
    }
    
    
    function exportCSV(){
        if(LIST.length===0){customAlert("Liste boÅŸ!");return;}
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; 
        csvContent += "Type,Qty,PipeLen,Temp_Measured,Temp_Amb,RefMat,RefThk,Valve_DN,Pipe_DN,Valve_Type,Surfaces,Energy_Curr,Location,FuelType,FuelLHV,FuelUnit,Wind\n";
        LIST.forEach(row => { const i = row.inputs; let surfStr = ""; if(i.surfaces && i.surfaces.length > 0){ surfStr = i.surfaces.map(s => `${s.w}x${s.h}`).join('|'); }
            const r = [ i.type, i.qty, i.pLen, i.tProc, i.tAmb, i.matKey, i.thk, i.vDN, i.pDN, i.valveType, surfStr, i.energyCurr, `"${i.location}"`, i.fuelType, i.fuelLhv, i.fuelUnit, i.vWind ];
            csvContent += r.join(",") + "\n"; });
        const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", "kayip_analizi.csv"); document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    async function importCSV(input){
        const file = input.files[0]; if(!file) return; const reader = new FileReader();
        reader.onload = async function(e){ 
            const text = e.target.result; const rows = text.split("\n");
            for(let i=1; i<rows.length; i++){ const row = rows[i].trim(); if(row){ const cols = row.split(","); if(cols.length >= 8){ 
                        document.getElementById('type').value = cols[0]; setType(cols[0]); 
                        document.getElementById('qty').value = cols[1]; document.getElementById('pLen').value = cols[2]; document.getElementById('tProc').value = cols[3]; document.getElementById('tAmb').value = cols[4]; document.getElementById('matSelect').value = cols[5]; document.getElementById('thk').value = cols[6];
                        if(cols[7]) document.getElementById('vDN').value = cols[7]; if(cols[8]) document.getElementById('pDN').value = cols[8]; if(cols[9]) document.getElementById('valveType').value = cols[9];
                        if(cols[10] && cols[10].trim() !== ""){ const parts = cols[10].split('|'); currentSurfaces = parts.map(p => { const d = p.split('x'); return {w: parseFloat(d[0]), h: parseFloat(d[1])}; }); } else { currentSurfaces = []; } renderSurfaces();
                        if(cols[11]) document.getElementById('energyCurr').value = cols[11]; if(cols[12]) document.getElementById('location').value = cols[12].replace(/"/g, "");
                        if(cols[13]) { document.getElementById('fuel').value = cols[13]; toggleFuelMode(); } if(cols[14]) document.getElementById('fuelLhv').value = cols[14]; if(cols[15]) document.getElementById('fuelUnit').value = cols[15];
                        if(cols[16]) document.getElementById('vWind').value = cols[16];
                        const res = await getCalculationResult();
                        if(res) LIST.push(res); 
                        } } }
            render(); resetForm(); customAlert(rows.length - 2 + " satÄ±r yÃ¼klendi!", "BaÅŸarÄ±lÄ±"); }; reader.readAsText(file); input.value = ''; 
    }
    
    async function quickUpdate(i, field, val) {
        const oldInputs = LIST[i].inputs;
        setType(oldInputs.type);
        document.getElementById('tProc').value = oldInputs.tProc; document.getElementById('tAmb').value = oldInputs.tAmb; document.getElementById('matSelect').value = oldInputs.matKey; document.getElementById('thk').value = oldInputs.thk; document.getElementById('calcStd').value = oldInputs.standard || 'iso'; document.getElementById('location').value = oldInputs.location || ""; 
        document.getElementById('vWind').value = (oldInputs.vWind !== undefined) ? oldInputs.vWind : 0;
        if(oldInputs.type==='pipe') { document.getElementById('pDN').value = oldInputs.pDN; document.getElementById('pLen').value = oldInputs.pLen; } else if(oldInputs.type==='valve'){ document.getElementById('vDN').value = oldInputs.vDN; document.getElementById('valveType').value = oldInputs.valveType; }
        
        if(field === 'qty') document.getElementById('qty').value = val; else document.getElementById('qty').value = oldInputs.qty; 
        
        const res = await getCalculationResult();
        if(res) LIST[i] = res; 
        resetForm(); render();
    }

    function render(){
        const tb=document.getElementById('gridBody');tb.innerHTML='';let gLoss=0,gEnergy=0,gCo2=0;
        const currSymVal=document.getElementById('curr')?document.getElementById('curr').value:'TL';
        const currSymMap={'USD':'$','EUR':'â‚¬','GBP':'Â£','TL':'â‚º'};
        const currSym=currSymMap[currSymVal]||'';

        LIST.forEach((i,x)=>{
            gLoss+=i.moneyLoss; gEnergy+=i.rawKwhLoss; gCo2+=i.co2;
            const imgTag=i.img?`<img src="${i.img}" class="w-10 h-10 object-cover rounded">`:`<div class="w-10 h-10 bg-slate-200 dark:bg-slate-800 rounded flex items-center justify-center text-xs text-slate-500">-</div>`;
            const locTag = i.location ? `<div class="text-[9px] text-red-500 font-bold mt-1 uppercase"><i data-lucide="map-pin" class="w-3 h-3 inline"></i> ${i.location}</div>` : '';
            const qtyInput = `<input type="number" class="grid-input text-slate-600 dark:text-slate-300" value="${i.qty}" onchange="quickUpdate(${x}, 'qty', this.value)">`;

            tb.insertAdjacentHTML('beforeend',`
            <tr class="hover:bg-slate-100 dark:hover:bg-slate-800/30 transition border-b border-slate-200 dark:border-slate-700/50 ${x===editingIndex?'bg-red-50 dark:bg-red-900/20':''}">
                <td class="px-6 py-4">${imgTag}</td>
                <td class="px-6 py-4 font-bold text-slate-800 dark:text-white">${i.name} ${locTag}</td>
                <td class="px-6 py-4 text-center font-bold text-slate-600 dark:text-slate-300">${qtyInput} <span class="text-[9px] text-slate-400 block">${i.unit}</span></td>
                
                <td class="px-6 py-4 text-center">
                    <div class="font-bold text-red-600">${i.kwhBare} kWh</div>
                </td>
                
                <td class="px-6 py-4 text-center">
                    <div class="font-bold text-orange-500 dark:text-orange-400">${i.kwhIns} kWh</div>
                </td>
                
                <td class="px-6 py-4 text-center">
                    <div class="font-bold text-emerald-600 dark:text-green-400">+${i.kwhSave} kWh</div>
                </td>
                
                <td class="px-6 py-4 text-right font-black text-red-600 dark:text-red-400">${currSym}${Math.round(i.moneyLoss).toLocaleString()}</td>
                <td class="px-6 py-4 text-right">
                    <div class="flex items-center justify-end gap-1">
                        <button onclick="edit(${x})" class="p-1.5 rounded-lg bg-red-50 dark:bg-red-900/30 hover:bg-red-100 dark:hover:bg-red-900/50 text-red-600 dark:text-red-400 transition" title="DÃ¼zenle">
                            <i data-lucide="pencil" class="w-3.5 h-3.5"></i>
                        </button>
                        <button onclick="del(${x})" class="p-1.5 rounded-lg bg-red-50 dark:bg-red-900/30 hover:bg-red-100 dark:hover:bg-red-900/50 text-red-600 dark:text-red-400 transition" title="Sil">
                            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>
                </td>
            </tr>`);
        });
        if(LIST.length===0)tb.innerHTML=`<tr><td colspan="8" class="px-6 py-20 text-center text-slate-500"><i data-lucide="search" class="w-12 h-12 mx-auto mb-3 opacity-20"></i><span id="emptyMsg">HenÃ¼z kayÄ±p noktasÄ± eklenmedi.</span></td></tr>`;
        
        document.getElementById('dashLossMoney').innerText=currSym+Math.round(gLoss).toLocaleString();
        document.getElementById('dashLossKwh').innerText=Math.round(gEnergy).toLocaleString();
        document.getElementById('dashCo2').innerHTML=gCo2.toFixed(1)+' Ton';
        lucide.createIcons();
    }

    // Rapor Dili SeÃ§im Popup
    function showReportLangPopup() {
        if(LIST.length === 0) {
            customAlert('Rapor oluÅŸturmak iÃ§in en az bir kaÃ§ak noktasÄ± eklemelisiniz.');
            return;
        }
        const popup = document.getElementById('reportLangPopup');
        const inner = document.getElementById('reportLangPopupInner');
        popup.style.display = 'flex';
        setTimeout(() => {
            popup.classList.remove('hidden');
            inner.style.transform = 'scale(1)';
            inner.style.opacity = '1';
        }, 10);
        lucide.createIcons();
    }

    function closeReportLangPopup() {
        const popup = document.getElementById('reportLangPopup');
        const inner = document.getElementById('reportLangPopupInner');
        inner.style.transform = 'scale(0.95)';
        inner.style.opacity = '0';
        setTimeout(() => {
            popup.classList.add('hidden');
            popup.style.display = 'none';
        }, 200);
    }

    function generateReport(lang) {
        closeReportLangPopup();
        setTimeout(() => printRep(lang), 300);
    }

    let printTemplateCache = null;
    
    // Ã‡eviri sistemi
    const translations = {
        tr: {
            // Cover Page
            clientLabel: 'Firma / MÃ¼ÅŸteri',
            providerLabel: 'Denetleyen / HazÄ±rlayan',
            reportDateLabel: 'Rapor Tarihi',
            isoLabel: 'ISO 12241 StandartlarÄ±na GÃ¶re',
            mainTitle: 'TERMAL <br><span class="text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-orange-600">KAYIP</span> ANALÄ°ZÄ°',
            introText: 'Tesisinizde gerÃ§ekleÅŸtirilen termal denetimler sonucunda; yalÄ±tÄ±msÄ±z ekipmanlardan kaynaklanan Ä±sÄ± kayÄ±plarÄ± ve finansal maliyetler hesaplanmÄ±ÅŸtÄ±r. AÅŸaÄŸÄ±daki veriler mevcut durumun Ã¶zetidir.',
            daily: 'GÃœNLÃœK',
            weekly: 'HAFTALIK',
            monthly: 'AYLIK',
            yearly: 'YILLIK',
            totalEnergyLabel: 'Toplam Enerji Ä°srafÄ±',
            qrNote: 'Bu karekodu okutarak kayÄ±p maliyetini canlÄ± sayaÃ§ Ã¼zerinde anlÄ±k olarak takip edebilirsiniz.',
            // Table
            reportTitle: 'TERMAL KAYIP ANALÄ°ZÄ°',
            reportSubtitle: 'KAYIP',
            isoStandard: 'ISO 12241 StandartlarÄ±na GÃ¶re',
            reportIntro: 'Tesisinizde gerÃ§ekleÅŸtirilen termal denetimler sonucunda; yalÄ±tÄ±msÄ±z ekipmanlardan kaynaklanan Ä±sÄ± kayÄ±plarÄ± ve finansal maliyetler hesaplanmÄ±ÅŸtÄ±r. AÅŸaÄŸÄ±daki veriler mevcut durumun Ã¶zetidir.',
            totalEnergyWaste: 'Toplam Enerji Ä°srafÄ±',
            leakPoints: 'Tespit Edilen KaÃ§ak NoktalarÄ±',
            image: 'GÃ¶rsel',
            leakSource: 'KaÃ§ak KaynaÄŸÄ±',
            temperature: 'SÄ±caklÄ±k',
            quantity: 'Miktar',
            bareLoss: 'Ã‡Ä±plak<br>KayÄ±p (kWh)',
            insulatedLoss: 'YalÄ±tÄ±mlÄ±<br>KayÄ±p (kWh)',
            saving: 'KazanÃ§<br>(kWh)',
            financialLoss: 'FÄ°NANSAL KAYIP',
            page: 'Sayfa',
            // Summary
            managementSummary: 'YÃ¶netici Ã–zeti',
            totalFinancialLoss: 'TOPLAM FÄ°NANSAL KAYIP',
            perYear: '/ YÄ±l',
            lossNote: 'Bu tutar, yalÄ±tÄ±m yapÄ±lmadÄ±ÄŸÄ± sÃ¼rece her yÄ±l iÅŸletme gideri olarak kaybedilmektedir.',
            energyWaste: 'ENERJÄ° Ä°SRAFI',
            fuelWaste: 'YAKIT Ä°SRAFI',
            unit: 'Birim',
            environmentalImpact: 'Ã‡evresel Etki',
            carbonFootprint: 'KARBON AYAK Ä°ZÄ°',
            ton: 'Ton',
            carbonNote: 'Atmosfere salÄ±nan fazladan COâ‚‚',
            fiveYearProjection: '5 YÄ±llÄ±k KÃ¼mÃ¼latif Zarar Projeksiyonu',
            atEndOfFiveYears: '5 YIL SONUNDA',
            totalLoss: 'TOPLAM ZARAR',
            year: 'YÄ±l',
            yearLoss: '. YÄ±l ZararÄ±',
            cumulative: 'KÃ¼mÃ¼latif',
            total: 'TOPLAM',
            calculationNote: 'Hesaplamalar ISO 12241 mÃ¼hendislik standartlarÄ±na gÃ¶re, Ã¶lÃ§Ã¼len yÃ¼zey sÄ±caklÄ±klarÄ± baz alÄ±narak yapÄ±lmÄ±ÅŸtÄ±r.',
            narrative: 'Bu analiz, <strong>{{temp}}Â°C</strong> ortam sÄ±caklÄ±ÄŸÄ±, <strong>{{wind}} m/s</strong> rÃ¼zgar hÄ±zÄ± ve <strong>%{{eff}}</strong> sistem verimliliÄŸi varsayÄ±mlarÄ±yla hesaplanmÄ±ÅŸtÄ±r. Tesisin yÄ±llÄ±k <strong>{{hours}} saat</strong> aktif Ã§alÄ±ÅŸtÄ±ÄŸÄ± Ã¶ngÃ¶rÃ¼lmÃ¼ÅŸtÃ¼r.'
        },
        en: {
            // Cover Page
            clientLabel: 'Client / Customer',
            providerLabel: 'Inspector / Prepared By',
            reportDateLabel: 'Report Date',
            isoLabel: 'According to ISO 12241 Standards',
            mainTitle: 'THERMAL <br><span class="text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-orange-600">LOSS</span> ANALYSIS',
            introText: 'Following thermal inspections conducted at your facility, heat losses and financial costs from uninsulated equipment have been calculated. The data below summarizes the current situation.',
            daily: 'DAILY',
            weekly: 'WEEKLY',
            monthly: 'MONTHLY',
            yearly: 'YEARLY',
            totalEnergyLabel: 'Total Energy Waste',
            qrNote: 'Scan this QR code to track the loss cost in real-time on the live counter.',
            // Table
            reportTitle: 'THERMAL LOSS ANALYSIS',
            reportSubtitle: 'LOSS',
            isoStandard: 'According to ISO 12241 Standards',
            reportIntro: 'Following thermal inspections conducted at your facility, heat losses and financial costs from uninsulated equipment have been calculated. The data below summarizes the current situation.',
            totalEnergyWaste: 'Total Energy Waste',
            leakPoints: 'Identified Leak Points',
            image: 'Image',
            leakSource: 'Leak Source',
            temperature: 'Temperature',
            quantity: 'Quantity',
            bareLoss: 'Bare<br>Loss (kWh)',
            insulatedLoss: 'Insulated<br>Loss (kWh)',
            saving: 'Savings<br>(kWh)',
            financialLoss: 'FINANCIAL LOSS',
            page: 'Page',
            // Summary
            managementSummary: 'Executive Summary',
            totalFinancialLoss: 'TOTAL FINANCIAL LOSS',
            perYear: '/ Year',
            lossNote: 'This amount is lost as operating expense every year as long as insulation is not installed.',
            energyWaste: 'ENERGY WASTE',
            fuelWaste: 'FUEL WASTE',
            unit: 'Unit',
            environmentalImpact: 'Environmental Impact',
            carbonFootprint: 'CARBON FOOTPRINT',
            ton: 'Tons',
            carbonNote: 'Additional COâ‚‚ released into atmosphere',
            fiveYearProjection: '5-Year Cumulative Loss Projection',
            atEndOfFiveYears: 'AT END OF 5 YEARS',
            totalLoss: 'TOTAL LOSS',
            year: 'Year',
            yearLoss: ' Year Loss',
            cumulative: 'Cumulative',
            total: 'TOTAL',
            calculationNote: 'Calculations are based on ISO 12241 engineering standards and measured surface temperatures.',
            narrative: 'This analysis is calculated with assumptions of <strong>{{temp}}Â°C</strong> ambient temperature, <strong>{{wind}} m/s</strong> wind speed, and <strong>{{eff}}%</strong> system efficiency. The facility is projected to operate <strong>{{hours}} hours</strong> annually.'
        }
    };

    function printRep(lang = 'tr'){
        try{
            const t = translations[lang]; // Ã‡eviri objesi
            const printArea = document.getElementById('print-area');
            if(!printTemplateCache){ printTemplateCache = printArea.innerHTML; }
            printArea.innerHTML = printTemplateCache;
            const d = new Date().toLocaleDateString('tr-TR');
            
            let gLoss=0, gEnergy=0, gCo2=0, gFuelLost=0; let lastFuelUnit=""; 
            const currSymVal = document.getElementById('curr').value;
            const currSymMap = {'USD':'$','EUR':'â‚¬','GBP':'Â£','TL':'â‚º'};
            const currSym = currSymMap[currSymVal]||'';

            LIST.forEach(i => { gLoss += i.moneyLoss; gEnergy += i.rawKwhLoss; gCo2 += i.co2; gFuelLost += i.fuelLost; lastFuelUnit = i.fuelUnit; });

            const qrContainer = document.getElementById('qr-generator-dump');
            // QR containerÄ± temizle ve gÃ¶rÃ¼nÃ¼r yap
            qrContainer.innerHTML = '';
            qrContainer.style.position = 'relative';
            qrContainer.style.width = '200px';
            qrContainer.style.height = '200px';
            
            // QR YÃ–NETÄ°M Ä°LE AYNI ÅžEKÄ°LDE
            const clientName = document.getElementById('cName').value || 'MÃ¼ÅŸteri';
            const serialNo = 'LOSS-' + Math.floor(Math.random() * 10000);
            const totalVal = gLoss;  // Hesaplanan toplam kayÄ±p (sayÄ± olarak)
            const uPrice = document.getElementById('price').value;  // String olarak bÄ±rak
            const wHours = document.getElementById('hours').value;  // String olarak bÄ±rak
            const fuel = document.getElementById('fuel').value;
            
            // Tarih formatÄ± QR yÃ¶netim ile aynÄ±
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];  // YYYY-MM-DD
            const hh = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            const timeStr = `${hh}:${min}`;
            const fullDateTime = `${dateStr}-${timeStr.replace(':', '-')}`; // YYYY-MM-DD-HH-MM
            
            // Hesaplama QR yÃ¶netim ile aynÄ±
            const secondsInWorkYear = wHours * 3600;
            const burnPerSecond = totalVal / secondsInWorkYear;

            // URL oluÅŸturma QR yÃ¶netim ile TAM AYNI
            const baseUrl = "https://optimizi.app/qrtakip.html";
            let trackUrl = `${baseUrl}?c=${encodeURIComponent(clientName)}&s=${encodeURIComponent(serialNo)}&v=${totalVal}&up=${uPrice}&wh=${wHours}&f=${fuel}&d=${fullDateTime}&bps=${burnPerSecond.toFixed(6)}`;
            
            if(fuel === 'manual'){
                let cLabel = document.getElementById('fuelLabel').value || 'Ã–zel YakÄ±t';
                const cUnit = document.getElementById('fuelUnit').value || 'kg';
                const cCo2 = document.getElementById('fuelCo2').value || '0.36';
                const cLhv = document.getElementById('fuelLhv').value;
                if(cLhv) { cLabel += ` (${cLhv} kcal)`; }
                trackUrl += `&fl=${encodeURIComponent(cLabel)}&fu=${encodeURIComponent(cUnit)}&fc=${encodeURIComponent(cCo2)}`;
            }
            
            // DEBUG - Konsola yazdÄ±r
            console.log('QR URL Parametreleri:', {
                client: clientName,
                serial: serialNo,
                totalValue: totalVal,
                unitPrice: uPrice,
                workHours: wHours,
                fuel: fuel,
                date: fullDateTime,
                burnPerSecond: burnPerSecond.toFixed(6),
                url: trackUrl
            });

            new QRCode(qrContainer, { 
                text: trackUrl, 
                width: 200, 
                height: 200, 
                colorDark: "#0f172a", 
                colorLight: "#ffffff", 
                correctLevel: QRCode.CorrectLevel.H 
            });
            
            setTimeout(() => {
                const canvas = qrContainer.querySelector("canvas");
                if(canvas) {
                    // Canvas'tan QR kodunu al
                    const qrDataUrl = canvas.toDataURL("image/png");
                    
                    // Yeni bir canvas oluÅŸtur (QR + Alev simgesi iÃ§in)
                    const finalCanvas = document.createElement('canvas');
                    finalCanvas.width = 200;
                    finalCanvas.height = 200;
                    const ctx = finalCanvas.getContext('2d');
                    
                    // QR kodunu Ã§iz
                    const qrImg = new Image();
                    qrImg.onload = function() {
                        ctx.drawImage(qrImg, 0, 0, 200, 200);
                        
                        // Ortaya beyaz daire Ã§iz
                        ctx.fillStyle = '#ffffff';
                        ctx.beginPath();
                        ctx.arc(100, 100, 20, 0, 2 * Math.PI);
                        ctx.fill();
                        
                        // Daire etrafÄ±na border
                        ctx.strokeStyle = '#e2e8f0';
                        ctx.lineWidth = 4;
                        ctx.beginPath();
                        ctx.arc(100, 100, 20, 0, 2 * Math.PI);
                        ctx.stroke();
                        
                        // Alev simgesi SVG path'ini Ã§iz
                        const flamePath = new Path2D('M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z');
                        
                        // Alev simgesini ortala ve Ã¶lÃ§eklendir
                        ctx.save();
                        ctx.translate(100, 100); // Merkeze taÅŸÄ±
                        ctx.scale(1.2, 1.2); // Ã–lÃ§eklendir
                        ctx.translate(-12, -12); // SVG merkezini ayarla (24x24 icon iÃ§in)
                        
                        // Alev dolgusunu Ã§iz
                        ctx.fillStyle = '#dc2626';
                        ctx.fill(flamePath);
                        
                        // Alev konturunu Ã§iz
                        ctx.strokeStyle = '#dc2626';
                        ctx.lineWidth = 1.5;
                        ctx.stroke(flamePath);
                        
                        ctx.restore();
                        
                        // Final gÃ¶rÃ¼ntÃ¼yÃ¼ rapor cover'a aktar
                        const finalDataUrl = finalCanvas.toDataURL("image/png");
                        document.getElementById('covQrCode').src = finalDataUrl;
                        document.getElementById('covQrCode').classList.remove('opacity-50');
                    };
                    qrImg.src = qrDataUrl;
                }
            }, 100);

            const ROWS_PER_PAGE = 20; 
            const chunks = []; 
            for (let i = 0; i < LIST.length; i += ROWS_PER_PAGE) { chunks.push(LIST.slice(i, i + ROWS_PER_PAGE)); } if(chunks.length === 0) chunks.push([]);
            
            const coverPage = document.getElementById('p-cover'); 
            const tablePageTemplate = document.getElementById('p-table'); 
            const summaryPage = document.getElementById('p-summary');
            
            if(tablePageTemplate) tablePageTemplate.remove();
            
            summaryPage.classList.remove('hidden'); 
            
            const totalPages = 1 + chunks.length + 1; 

            // RAPOR TABLOSU: SÃœTUNLAR REVIZE EDÄ°LDÄ°
            const tableHeaderHTML = `
                <th class="w-6">#</th>
                <th class="w-20 text-center">${t.image}</th>
                <th class="text-left w-48">${t.leakSource}</th>
                <th class="text-center w-20">${t.temperature}</th>
                <th class="text-center w-20">${t.quantity}</th>
                <th class="text-right text-red-500 text-[9px]">${t.bareLoss}</th>
                <th class="text-right text-orange-500 text-[9px]">${t.insulatedLoss}</th>
                <th class="text-right text-emerald-600 font-bold">${t.saving}</th> 
                <th class="text-right text-red-600 font-black">${t.financialLoss}</th>`;

            chunks.forEach((chunk, index) => {
                const newPage = tablePageTemplate ? tablePageTemplate.cloneNode(true) : document.createElement('div');
                newPage.id = '';
                newPage.classList.remove('hidden'); 
                
                const titleEl = newPage.querySelector('h2'); 
                if(titleEl) {
                    titleEl.innerText = t.leakPoints;
                    if(index > 0) { titleEl.innerHTML += ` <span class="text-sm text-slate-400 font-normal">(${index+1})</span>`; }
                }
                
                const dateEl = newPage.querySelector('#rDate'); if(dateEl) dateEl.innerText = d;
                const theadTr = newPage.querySelector('thead tr'); if(theadTr) theadTr.innerHTML = tableHeaderHTML;
                const pageNumEl = newPage.querySelector('.page-num'); if(pageNumEl) pageNumEl.innerText = `${t.page} ${index + 2} / ${totalPages}`;
                
                const tbody = newPage.querySelector('tbody'); 
                if(tbody) {
                    tbody.innerHTML = '';
                    chunk.forEach((i, subIndex) => {
                        const globalIndex = (index * ROWS_PER_PAGE) + subIndex + 1;
                        const imgTag = i.img ? `<img src="${i.img}" class="w-16 h-16 object-cover rounded mx-auto border border-slate-200">` : `<div class="w-8 h-8 bg-slate-100 rounded mx-auto flex items-center justify-center text-[8px]">-</div>`;
                        const locText = i.location ? `<div class="text-[8px] uppercase text-red-400 mt-1 font-bold">ðŸ“ ${i.location}</div>` : '';

                        tbody.innerHTML += `<tr>
                            <td class="text-center font-bold text-slate-400 border-b border-slate-100">${globalIndex}</td>
                            <td class="text-center border-b border-slate-100 p-1">${imgTag}</td>
                            <td class="font-bold text-slate-800 border-b border-slate-100 text-[10px]">${i.name} ${locText}</td>
                            <td class="text-center border-b border-slate-100 font-bold text-red-600">${i.tSurf}Â°C</td>
                            <td class="text-center border-b border-slate-100 text-[10px]">${i.qty} ${i.unit}</td>
                            
                            <td class="text-right font-mono text-[10px] text-red-500 border-b border-slate-100">${i.kwhBare}</td>
                            <td class="text-right font-mono text-[10px] text-orange-500 border-b border-slate-100">${i.kwhIns}</td>
                            <td class="text-right font-bold text-emerald-600 text-[10px] border-b border-slate-100">+${i.kwhSave}</td>
                            
                            <td class="text-right font-bold text-red-600 text-[10px] border-b border-slate-100">${currSym}${Math.round(i.moneyLoss).toLocaleString()}</td>
                        </tr>`;
                    });
                }
                printArea.insertBefore(newPage, summaryPage);
            });

            // COVER PAGE METINLER - DÄ°LE GÃ–RE
            document.getElementById('covClientLabel').innerText = t.clientLabel;
            document.getElementById('covProvLabel').innerText = t.providerLabel;
            document.getElementById('covIsoLabel').innerText = t.isoLabel;
            document.getElementById('covMainTitle').innerHTML = t.mainTitle;
            document.getElementById('covIntro').innerText = t.introText;
            document.getElementById('covDailyLabel').innerText = t.daily;
            document.getElementById('covWeeklyLabel').innerText = t.weekly;
            document.getElementById('covMonthlyLabel').innerText = t.monthly;
            document.getElementById('covYearlyLabel').innerText = t.yearly;
            document.getElementById('covEnergyLabel').innerText = t.totalEnergyLabel;

            document.getElementById('covClient').innerText = document.getElementById('cName').value || "FÄ°RMA ADI";
            document.getElementById('covContact').innerText = document.getElementById('cEng').value || "";
            document.getElementById('covProv').innerText = document.getElementById('pName').value || "TEDARÄ°KÃ‡Ä°";
            document.getElementById('covDate').innerText = d;
            
            const lossYear = gLoss;
            const lossMonth = gLoss / 12;
            const lossWeek = gLoss / 52;
            const lossDay = gLoss / 365;
            
            document.getElementById('covMoneyYear').innerText = currSym + Math.round(lossYear).toLocaleString();
            document.getElementById('covMoneyMonth').innerText = currSym + Math.round(lossMonth).toLocaleString();
            document.getElementById('covMoneyWeek').innerText = currSym + Math.round(lossWeek).toLocaleString();
            document.getElementById('covMoneyDay').innerText = currSym + Math.round(lossDay).toLocaleString();
            document.getElementById('covKwhTotal').innerText = Math.round(gEnergy).toLocaleString();

            const tAmb = document.getElementById('tAmb').value;
            const vWind = document.getElementById('vWind').value;
            const eff = document.getElementById('eff').value;
            const narrative = t.narrative
                .replace('{{temp}}', tAmb)
                .replace('{{wind}}', vWind)
                .replace('{{eff}}', eff)
                .replace('{{hours}}', wHours);
            document.getElementById('covNarrative').innerHTML = narrative;

            document.getElementById('sumLoss').innerText = currSym + Math.round(gLoss).toLocaleString();
            document.getElementById('sumFuelLost').innerText = Math.round(gFuelLost).toLocaleString();
            document.getElementById('sumFuelUnitLabel').innerText = lastFuelUnit;
            document.getElementById('sumEnergy').innerText = Math.round(gEnergy).toLocaleString() + ' kWh';
            document.getElementById('sumCo2').innerText = gCo2.toFixed(1);

            // 5 YÄ±llÄ±k Projeksiyon Tablosu
            const projTable = document.getElementById('projTable');
            const totalProj = gLoss * 5;
            
            projTable.innerHTML = `
                <tr class="border-b border-slate-100">
                    <td class="p-2 text-left font-bold text-slate-700">KayÄ±p Devam Ederse</td>
                    <td class="p-2 text-red-600 font-bold">${currSym}${Math.round(gLoss).toLocaleString()}</td>
                    <td class="p-2 text-red-600 font-bold">${currSym}${Math.round(gLoss*2).toLocaleString()}</td>
                    <td class="p-2 text-red-600 font-bold">${currSym}${Math.round(gLoss*3).toLocaleString()}</td>
                    <td class="p-2 text-red-600 font-bold">${currSym}${Math.round(gLoss*4).toLocaleString()}</td>
                    <td class="p-2 text-red-600 font-bold">${currSym}${Math.round(gLoss*5).toLocaleString()}</td>
                    <td class="p-2 text-red-700 font-black">${currSym}${Math.round(totalProj).toLocaleString()}</td>
                </tr>
            `;
            
            // KÃ¼mÃ¼latif zarar kartÄ±
            document.getElementById('sumCumulativeLoss').innerText = currSym + Math.round(totalProj).toLocaleString();
            document.getElementById('sumCumulativePercent').innerText = '500%';

            setTimeout(()=>{ lucide.createIcons(); window.print(); }, 250); 
        }catch(e){ customAlert('Rapor hatasÄ±: ' + e.message, 'Hata'); console.error(e); }
    }

    // KAYDET FONKSÄ°YONU - VeritabanÄ±na kaydetme
    async function saveData() {
        if(LIST.length === 0) {
            customAlert('KayÄ±t yapÄ±lacak veri bulunmuyor. LÃ¼tfen Ã¶nce kaÃ§ak noktalarÄ± ekleyin.');
            return;
        }
        
        // Supabase client kontrolÃ¼
        const activeSupabase = window.supabaseClient || window.supabase;
        if(!activeSupabase) { customAlert('VeritabanÄ± baÄŸlantÄ±sÄ± bulunamadÄ±.', 'Hata'); return; }
        
        // KullanÄ±cÄ± kontrolÃ¼
        const { data: { session } } = await activeSupabase.auth.getSession();
        if(!session) {
            customAlert('LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n.', 'Hata');
            setTimeout(() => { window.location.href = '/login'; }, 2000);
            return;
        }
        
        // Ã–zet verileri hesapla
        const reportCurr = document.getElementById('curr').value;
        const reportRate = FX[reportCurr] || 1;
        
        let gLoss = 0, gEnergy = 0, gCo2 = 0;
        LIST.forEach(i => {
            gLoss += i.moneyLoss;
            gEnergy += i.rawKwhLoss;
            gCo2 += i.co2;
        });
        
        try {
            const calcData = {
                    user_id: session.user.id,
                    project_name: document.getElementById('pName').value || "Ä°simsiz Proje",
                    client_name: document.getElementById('cName').value || "",
                    client_contact: document.getElementById('cEng').value || "",
                    provider_name: document.getElementById('pName').value || "",
                    provider_engineer: document.getElementById('pEng').value || "",
                    calculation_type: 'anlik-kayip',
                    items: LIST,
                    total_investment: 0,
                    total_savings: 0,
                    total_loss: gLoss,
                    total_co2: gCo2,
                    roi_months: 0,
                    currency: reportCurr,
                    ambient_temp: parseFloat(document.getElementById('tAmb').value),
                    wind_speed: parseFloat(document.getElementById('vWind').value),
                    fuel_type: document.getElementById('fuel').value,
                    boiler_efficiency: parseFloat(document.getElementById('eff').value),
                    energy_price: parseFloat(document.getElementById('price').value),
                    annual_hours: parseInt(document.getElementById('hours').value)
            };

            let data, error;
            if (window.loadedCalcId) {
                ({ data, error } = await activeSupabase.from('calculations').update(calcData).eq('id', window.loadedCalcId).select());
            } else {
                ({ data, error } = await activeSupabase.from('calculations').insert(calcData).select());
            }
            
            if(error) {
                console.error('KayÄ±t hatasÄ±:', error);
                customAlert('Kaydetme sÄ±rasÄ±nda hata oluÅŸtu: ' + error.message, 'Hata');
            } else {
                const isUpdate = !!window.loadedCalcId;
                const saveName = document.getElementById('cName').value || document.getElementById('pName').value || 'Proje';
                if (!isUpdate && data && data[0]) {
                    window.loadedCalcId = data[0].id;
                    window.history.replaceState({}, '', window.location.pathname + '?load_id=' + data[0].id);
                }
                customAlert(`"${saveName}" ${isUpdate ? 'gÃ¼ncellendi' : 'kaydedildi'}! Dashboard'dan gÃ¶rÃ¼ntÃ¼leyebilirsiniz.`, 'BaÅŸarÄ±lÄ± ðŸŽ‰');
            }
        } catch(err) {
            console.error('Beklenmeyen hata:', err);
            customAlert('Bir hata oluÅŸtu: ' + err.message, 'Hata');
        }
    }
</script>
<script>
    window.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const loadId = urlParams.get('load_id');
        window.loadedCalcId = loadId || null;
        if (!loadId) return;

        console.log('AnlÄ±k KayÄ±p proje yÃ¼kleniyor ID:', loadId);
        const activeSupabase = window.supabaseClient || window.supabase;
        if (!activeSupabase) { console.error('Supabase baÄŸlantÄ±sÄ± bulunamadÄ±!'); return; }

        const { data, error } = await activeSupabase
            .from('calculations')
            .select('*')
            .eq('id', loadId)
            .single();

        if (error) { console.error('Veri Ã§ekme hatasÄ±:', error); return; }

        if (data) {
            if(data.project_name) document.getElementById('pName').value = data.project_name;
            if(data.client_name) document.getElementById('cName').value = data.client_name;
            if(data.client_contact) document.getElementById('cEng').value = data.client_contact;
            if(data.provider_engineer) document.getElementById('pEng').value = data.provider_engineer;
            if(data.ambient_temp) document.getElementById('tAmb').value = data.ambient_temp;
            if(data.wind_speed !== null && data.wind_speed !== undefined) document.getElementById('vWind').value = data.wind_speed;
            if(data.boiler_efficiency) document.getElementById('eff').value = data.boiler_efficiency;
            if(data.energy_price) document.getElementById('price').value = data.energy_price;
            if(data.annual_hours) document.getElementById('hours').value = data.annual_hours;
            
            if(data.fuel_type) {
                document.getElementById('fuel').value = data.fuel_type;
                if(typeof toggleFuelMode === 'function') toggleFuelMode();
            }

            if (data.items && Array.isArray(data.items)) {
                LIST = data.items;
                if(typeof updateGlobalFinancials === 'function') updateGlobalFinancials();
                if(typeof render === 'function') render();
                console.log("AnlÄ±k KayÄ±p projesi baÅŸarÄ±yla yÃ¼klendi:", data.project_name);
            }
        }
    });
</script>
</body>
</html>
