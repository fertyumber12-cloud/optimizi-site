<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Enerji KayÄ±p ve KaÃ§ak Analizi</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* ... (Stillerin aynÄ± kaldÄ±ÄŸÄ±nÄ± varsayÄ±yoruz) ... */
</style>
</head>
<body class="antialiased" onload="initApp()">
<script>
    // âš ï¸ GÃœVENLÄ°K AYARLARI
   // GÃ¼venlik Bilgileri (MaskelenmiÅŸ)
const _0x4a2b = ["b251cmd1bmVyMTk5OQ==", "aHR0cHM6Ly9zY3JpcHQuZ29vZ2xlLmNvbS9tYWNyb3Mvcy9BS2Z5Y2J5OE5LLW9BN1pXcnNmeUVwVzdOUUJvOEg3cHdxSWNrbmJwMGJhZnFiRFYwY19IWXpRMTQwLUhpdEdLSFFUcjZjRS9leGVj"];
const OZEL_ANAHTAR = atob(_0x4a2b[0]); 
const API_URL = atob(_0x4a2b[1]);

    let LIST=[],FX={USD:34.50,EUR:36.50,GBP:43.20,TL:1.0},currImg=null,editingIndex=null;
    let currentSurfaces = []; 
    const PIPES={15:21.3,20:26.7,25:33.4,32:42.2,40:48.3,50:60.3,65:73.0,80:88.9,100:114.3,125:141.3,150:168.3,200:219.1,250:273.0,300:323.9,350:355.6,400:406.4,500:508.0};

    // --- KRÄ°TÄ°K HESAPLAMA Ä°STEÄÄ° (BACKEND BAÄLANTISI) ---
    async function getCalculationResult(customInputs = null){
        // EÄŸer hÄ±zlÄ± gÃ¼ncelleme gelirse customInputs kullan, yoksa formdan Ã§ek
        const d = customInputs || {
            type: document.getElementById('type').value,
            qty: parseFloat(document.getElementById('qty').value)||1,
            pLen: parseFloat(document.getElementById('pLen').value)||1,
            tProc: parseFloat(document.getElementById('tProc').value)||0,
            tAmb: parseFloat(document.getElementById('tAmb').value)||25,
            vWind: parseFloat(document.getElementById('vWind').value)||0,
            matKey: document.getElementById('matSelect').value,
            thk: parseFloat(document.getElementById('thk').value)||0,
            useL2: document.getElementById('useL2').checked,
            matKey2: document.getElementById('matSelect2').value,
            thk2: parseFloat(document.getElementById('thk2').value)||0,
            vDN: document.getElementById('vDN').value,
            pDN: document.getElementById('pDN').value,
            valveType: document.getElementById('valveType').value,
            surfaces: JSON.parse(JSON.stringify(currentSurfaces)),
            eff: (parseFloat(document.getElementById('eff').value)||85)/100,
            hours: parseFloat(document.getElementById('hours').value)||8000,
            fuelType: document.getElementById('fuel').value,
            standard: document.getElementById('calcStd').value
        };

        // Finansal Ã§evrimler
        const reportCurrencyCode = document.getElementById('curr').value;
        const reportRate = FX[reportCurrencyCode] || 1; 
        const energyRate = FX[document.getElementById('energyCurr').value] || 1;
        const priceInReportCurr = (parseFloat(document.getElementById('price').value)||0) * (energyRate / reportRate);

        // API'ye gÃ¶nderilecek veri paketi
        const apiParams = {
            apiKey: OZEL_ANAHTAR, // GÃ¼venlik AnahtarÄ±
            ...d,
            priceInReportCurr: priceInReportCurr
        };

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(apiParams),
                redirect: 'follow'
            });

            const apiResult = await response.json();
            if (apiResult.error) throw new Error(apiResult.error);

            // GÃ¶rÃ¼ntÃ¼leme isimlerini ayarla
            let Name = d.type === 'tank' ? "DÃ¼z YÃ¼zey" : (d.type === 'valve' ? "ArmatÃ¼r" : "Boru");
            let unitLabel = d.type === 'pipe' ? "m" : "Adet";

            return {
                name: Name,
                location: document.getElementById('location').value,
                qty: d.type === 'pipe' ? (d.pLen * d.qty) : d.qty,
                unit: unitLabel,
                moneyLoss: apiResult.moneyLoss,
                potentialSave: apiResult.potentialSave,
                kwhBare: apiResult.kwhBare.toLocaleString(),
                kwhIns: apiResult.kwhIns.toLocaleString(),
                kwhSave: apiResult.kwhSave.toLocaleString(),
                rawKwhLoss: apiResult.rawKwhLoss,
                rawKwhIns: apiResult.rawKwhIns,
                co2: apiResult.co2,
                tSurf: d.tProc,
                img: currImg,
                inputs: d // Veriyi sakla ki sonra adet gÃ¼ncellerken kullanabilelim
            };
        } catch (error) {
            alert("Hata: " + error.message);
            throw error;
        }
    }

    // --- ADET DEÄÄ°ÅÄ°NCE OTOMATÄ°K GÃœNCELLEME (HIZLI VE GÃœVENLÄ°) ---
    async function quickUpdate(index, field, val) {
        if (field === 'qty') {
            // 1. Ã–nce listedeki input deÄŸerini gÃ¼ncelle
            LIST[index].inputs.qty = parseFloat(val) || 1;
            
            // 2. Tabloya "HesaplanÄ±yor..." efekti ver (Opsiyonel)
            const row = document.querySelectorAll('#gridBody tr')[index];
            row.style.opacity = "0.5";

            try {
                // 3. Google'dan yeni veriyi al (SakladÄ±ÄŸÄ±mÄ±z inputs ile)
                const updated = await getCalculationResult(LIST[index].inputs);
                LIST[index] = updated;
                render(); // Tabloyu tazele
            } catch (e) {
                console.error("GÃ¼ncelleme baÅŸarÄ±sÄ±z", e);
            } finally {
                row.style.opacity = "1";
            }
        }
    }

    // ... (render, init, addSurface ve diÄŸer yardÄ±mcÄ± fonksiyonlarÄ±n devamÄ±) ...
    function render(){
        const tb=document.getElementById('gridBody'); tb.innerHTML='';
        let gLoss=0, gEnergy=0, gCo2=0;
        const currSym = {'USD':'$','EUR':'â‚¬','GBP':'Â£','TL':'â‚º'}[document.getElementById('curr').value] || 'â‚º';

        LIST.forEach((i, x) => {
            gLoss += i.moneyLoss; gEnergy += i.rawKwhLoss; gCo2 += i.co2;
            const imgTag = i.img ? `<img src="${i.img}" class="w-10 h-10 object-cover rounded">` : `<div class="w-10 h-10 bg-slate-800 rounded flex items-center justify-center text-xs">-</div>`;
            
            tb.insertAdjacentHTML('beforeend', `
                <tr class="border-b border-slate-700/50">
                    <td class="px-6 py-4">${imgTag}</td>
                    <td class="px-6 py-4 font-bold">${i.name}</td>
                    <td class="px-6 py-4 text-center">
                        <input type="number" class="grid-input" value="${i.inputs.qty}" onchange="quickUpdate(${x}, 'qty', this.value)">
                        <span class="text-[9px] block opacity-50">${i.unit}</span>
                    </td>
                    <td class="px-6 py-4 text-center text-red-500 font-bold">${i.kwhBare} kWh</td>
                    <td class="px-6 py-4 text-center text-orange-400">${i.kwhIns} kWh</td>
                    <td class="px-6 py-4 text-center text-green-400">+${i.kwhSave} kWh</td>
                    <td class="px-6 py-4 text-right font-black text-red-500">${currSym}${Math.round(i.moneyLoss).toLocaleString()}</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="edit(${x})" class="text-blue-400 mr-2">âœï¸</button>
                        <button onclick="del(${x})" class="text-red-500">ğŸ—‘ï¸</button>
                    </td>
                </tr>
            `);
        });

        document.getElementById('dashLossMoney').innerText = currSym + Math.round(gLoss).toLocaleString();
        document.getElementById('dashLossKwh').innerText = Math.round(gEnergy).toLocaleString();
        document.getElementById('dashCo2').innerHTML = gCo2.toFixed(1) + ' Ton';
        lucide.createIcons();
    }
    
    // DiÄŸer fonksiyonlar (initApp, setType vb.) olduÄŸu gibi kalabilir.
</script>
</body>
</html>

