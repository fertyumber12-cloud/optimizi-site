<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yalıtım Performans & Enerji Sınıfı Analizi</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" href="../favicon.png" type="image/png">

<script>
  tailwind.config = {
    theme: {
      fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'], mono: ['"JetBrains Mono"', 'monospace'] },
      extend: {
        colors: { slate: { 850: '#151e2e', 900: '#0f172a', 950: '#020617' } },
        animation: { 'float-slow': 'float 8s ease-in-out infinite' },
        keyframes: {
            float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } }
        }
      }
    }
  }
</script>

<style>
  :root {
    /* MÜHENDİSLİK KAĞIDI (AYDINLIK TEMA) */
    --bg-color: #fdfdfd; 
    --grid-line: rgba(99, 102, 241, 0.06); 
    --glass-bg: rgba(255, 255, 255, 0.85);
    --glass-border: rgba(99, 102, 241, 0.15);
    --input-bg: #ffffff;
    --input-border: #e0e7ff;
    --text-main: #1e293b; 
    --card-shadow: 0 4px 20px -4px rgba(99, 102, 241, 0.1);

    /* EiiF COLORS */
    --c-A: #348d00; --c-B: #6bb600; --c-C: #b4d600;
    --c-D: #ffd600; --c-E: #ffaa00; --c-F: #ff5500; --c-G: #d40000;
  }

  body { 
      background-color: var(--bg-color);
      background-image: 
          linear-gradient(var(--grid-line) 1px, transparent 1px),
          linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
      background-size: 20px 20px;
      color: var(--text-main); 
      overflow-x: hidden; 
  }

  .glass-card { 
      background-color: var(--glass-bg); 
      backdrop-filter: blur(12px); 
      border: 1px solid var(--glass-border); 
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
  }

  .glass-input { 
      transition: all 0.2s; border-radius: 0.5rem; padding: 0.6rem 0.8rem; width: 100%; 
      background-color: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-main);
      font-size: 0.85rem;
  }
  .glass-input:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }

  /* EiiF Chart Styles */
  .eiif-row { display: flex; align-items: center; margin-bottom: 6px; height: 28px; }
  .eiif-label { width: 30px; font-weight: 800; font-size: 11px; color: #64748b; text-align: right; margin-right: 10px; }
  .eiif-bar-container { flex: 1; height: 100%; position: relative; display: flex; align-items: center; }
  .eiif-bar { 
      height: 100%; 
      clip-path: polygon(0% 0%, 94% 0%, 100% 50%, 94% 100%, 0% 100%);
      opacity: 0.3; transition: all 0.4s ease;
      display: flex; align-items: center; padding-left: 12px;
      color: white; font-weight: 900; font-size: 12px; text-shadow: 0 1px 2px rgba(0,0,0,0.4);
  }
  .eiif-row.active .eiif-bar { opacity: 1; transform: scale(1.02); filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
  .eiif-val { width: 70px; text-align: right; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #64748b; margin-left: 10px; }

  .w-a { width: 35%; background: var(--c-A); } .w-b { width: 45%; background: var(--c-B); }
  .w-c { width: 55%; background: var(--c-C); } .w-d { width: 65%; background: var(--c-D); }
  .w-e { width: 75%; background: var(--c-E); } .w-f { width: 85%; background: var(--c-F); }
  .w-g { width: 100%; background: var(--c-G); }
  
  /* Standart Seçim Butonları */
  .std-btn {
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      padding: 0.5rem;
      text-align: center;
      font-size: 10px;
      font-weight: 700;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s;
      background-color: #fff;
  }
  .std-btn:hover { border-color: #a5b4fc; color: #4f46e5; }
  .std-btn.active { background-color: #eef2ff; border-color: #6366f1; color: #4338ca; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
</style>
</head>
<body class="antialiased selection:bg-indigo-500/30 selection:text-indigo-700" onload="initApp()">

<div class="relative z-10 flex flex-col min-h-screen">
    <nav class="sticky top-0 z-50 glass-card !bg-white/90 !border-x-0 !border-t-0 !rounded-none border-b border-indigo-100 backdrop-blur-xl">
      <div class="app-container px-6 h-16 flex items-center justify-between">
          <a href="../index.html" class="flex items-center gap-3 group">
              <div><h1 class="text-lg font-bold text-slate-800 tracking-wide">Optimizi<span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 to-purple-600">.Thickness</span></h1></div>
          </a>
          <div class="flex items-center gap-2">
             <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest bg-slate-50 px-2 py-1 rounded border border-slate-200" id="stdBadge">
                TS EN ISO 12241
             </div>
          </div>
      </div>
    </nav>

    <main class="flex-1 container mx-auto p-6 lg:p-8 max-w-[1300px]">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            
            <div class="lg:col-span-5 space-y-6">
                
                <div class="glass-card p-6 rounded-2xl relative overflow-hidden">
                    <h3 class="text-indigo-600 text-xs font-bold uppercase mb-4 flex items-center gap-2"><i data-lucide="sliders-horizontal" class="w-4 h-4"></i> Hesaplama Girdileri</h3>
                    
                    <div class="space-y-4">
                        <div class="flex bg-slate-50 p-1 rounded-lg border border-slate-200">
                            <button onclick="setType('pipe')" id="btn-pipe" class="flex-1 py-1.5 text-[10px] font-bold rounded transition-all text-white bg-indigo-600 shadow">Boru</button>
                            <button onclick="setType('valve')" id="btn-valve" class="flex-1 py-1.5 text-[10px] font-bold rounded transition-all text-slate-500 hover:text-slate-800">Vana</button>
                            <button onclick="setType('flange')" id="btn-flange" class="flex-1 py-1.5 text-[10px] font-bold rounded transition-all text-slate-500 hover:text-slate-800">Flanş</button>
                            <button onclick="setType('flat')" id="btn-flat" class="flex-1 py-1.5 text-[10px] font-bold rounded transition-all text-slate-500 hover:text-slate-800">Düz</button>
                        </div>
                        <input type="hidden" id="type" value="pipe">

                        <div id="row-dn" class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] text-slate-500 font-bold uppercase mb-1 block">Çap (DN)</label>
                                <select id="dn" class="glass-input text-xs" onchange="calc()"></select>
                            </div>
                            <div id="box-valve" class="hidden">
                                <label class="text-[10px] text-slate-500 font-bold uppercase mb-1 block">Vana Tipi</label>
                                <select id="valveType" class="glass-input text-xs" onchange="calc()">
                                    <option value="gate">Sürgülü Vana</option>
                                    <option value="globe">Glob Vana</option>
                                    <option value="ball">Küresel Vana</option>
                                    <option value="check">Çekvalf</option>
                                    <option value="strainer">Pislik Tutucu</option>
                                </select>
                            </div>
                            <div id="box-qty">
                                <label class="text-[10px] text-slate-500 font-bold uppercase mb-1 block" id="lblQty">Metraj (m)</label>
                                <input type="number" id="qty" value="1" class="glass-input text-xs" oninput="calc()">
                            </div>
                        </div>
                        
                        <div id="row-dims" class="hidden grid grid-cols-2 gap-4">
                            <div><label class="text-[10px] text-slate-500 font-bold uppercase mb-1 block">Genişlik (m)</label><input type="number" id="dimW" value="1" class="glass-input text-xs" oninput="calc()"></div>
                            <div><label class="text-[10px] text-slate-500 font-bold uppercase mb-1 block">Yükseklik (m)</label><input type="number" id="dimH" value="1" class="glass-input text-xs" oninput="calc()"></div>
                        </div>

                        <div class="grid grid-cols-3 gap-3">
                            <div class="col-span-1">
                                <label class="text-[10px] text-slate-500 font-bold uppercase mb-1 block">İç Sıc. (°C)</label>
                                <div class="relative">
                                    <input type="number" id="tProc" value="150" class="glass-input text-xs pl-7 font-bold text-indigo-600" oninput="calc()">
                                    <i data-lucide="thermometer" class="w-3 h-3 text-indigo-400 absolute left-2.5 top-2.5"></i>
                                </div>
                            </div>
                            <div class="col-span-1">
                                <label class="text-[10px] text-slate-500 font-bold uppercase mb-1 block">Ortam (°C)</label>
                                <input type="number" id="tAmb" value="25" class="glass-input text-xs" oninput="calc()">
                            </div>
                            <div class="col-span-1">
                                <label class="text-[10px] text-slate-500 font-bold uppercase mb-1 block">Rüzgar (m/s)</label>
                                <input type="number" id="vWind" value="1" step="0.5" class="glass-input text-xs" oninput="calc()">
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 pt-4 border-t border-slate-100">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-[10px] font-bold text-indigo-700 uppercase bg-indigo-50 px-2 py-0.5 rounded">1. Katman</h4>
                            <span class="text-[9px] text-slate-400 font-mono" id="kVal1"></span>
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="col-span-2">
                                <select id="mat1" class="glass-input text-xs" onchange="calc()">
                                    <option value="rockwool" selected>Taş Yünü (Sanayi)</option>
                                    <option value="needlemat">İğnelenmiş Cam Elyaf (650°C)</option>
                                    <option value="ceramic">Seramik Yünü (1260°C)</option>
                                    <option value="aerogel">Aerogel (Pyrogel XT)</option>
                                    <option value="rubber">Elastomerik Kauçuk</option>
                                    <option value="pu">Poliüretan (PU)</option>
                                </select>
                            </div>
                            <div>
                                <input type="number" id="thk1" value="50" class="glass-input text-xs" placeholder="mm" oninput="calc()">
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 pt-2 border-t border-dashed border-slate-200">
                        <label class="flex items-center gap-3 cursor-pointer mb-2 group">
                            <input type="checkbox" id="useL2" onchange="toggleL2()" class="w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="text-[10px] font-bold text-slate-500 group-hover:text-indigo-600 transition">2. Katman Ekle (Kompozit)</span>
                        </label>
                        <div id="layer2Box" class="hidden mt-3">
                             <div class="flex items-center justify-between mb-2">
                                <h4 class="text-[10px] font-bold text-indigo-700 uppercase bg-indigo-50 px-2 py-0.5 rounded">2. Katman</h4>
                             </div>
                             <div class="grid grid-cols-3 gap-3">
                                <div class="col-span-2">
                                    <select id="mat2" class="glass-input text-xs" onchange="calc()">
                                        <option value="rubber">Elastomerik Kauçuk</option>
                                        <option value="aerogel">Aerogel (Pyrogel XT)</option>
                                        <option value="needlemat">İğnelenmiş Cam Elyaf</option>
                                        <option value="rockwool">Taş Yünü</option>
                                        <option value="ceramic">Seramik Yünü</option>
                                    </select>
                                </div>
                                <div>
                                    <input type="number" id="thk2" value="19" class="glass-input text-xs" placeholder="mm" oninput="calc()">
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="glass-card p-4 rounded-xl border-l-4 border-l-purple-500">
                     <h3 class="text-slate-800 text-xs font-bold uppercase mb-3 flex items-center gap-2">
                         <i data-lucide="book-open" class="w-4 h-4 text-purple-500"></i> Hesaplama Standardı
                     </h3>
                     <div class="grid grid-cols-3 gap-2">
                         <div onclick="setStd('iso')" id="std-iso" class="std-btn active">ISO 12241</div>
                         <div onclick="setStd('astm')" id="std-astm" class="std-btn">ASTM C680</div>
                         <div onclick="setStd('vdi')" id="std-vdi" class="std-btn">VDI 2055</div>
                     </div>
                     <input type="hidden" id="calcStd" value="iso">
                </div>

            </div>

            <div class="lg:col-span-7">
                <div class="glass-card p-8 rounded-2xl h-full flex flex-col justify-between relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-500/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/3 pointer-events-none"></div>

                    <div class="flex items-start justify-between mb-8 relative z-10">
                        <div>
                            <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">Dış Yüzey Sıcaklığı</div>
                            <div class="flex items-baseline gap-2">
                                <div class="text-6xl font-black text-slate-800 tracking-tighter" id="resTs">--</div>
                                <div class="text-xl text-slate-400 font-medium">°C</div>
                            </div>
                            <div class="mt-2" id="badgeContainer">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-700 border border-green-200">GÜVENLİ</span>
                            </div>
                        </div>
                        <div class="text-right">
                             <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">Birim Isı Kaybı</div>
                             <div class="flex items-baseline justify-end gap-1">
                                <div class="text-5xl font-black text-indigo-600" id="resQUnitVal">--</div>
                                <div class="text-lg font-bold text-indigo-400" id="resQUnitLabel">W/m</div>
                             </div>
                             <div class="text-[10px] text-slate-500 mt-1">Toplam: <span id="resQTotal" class="text-slate-800 font-bold">--</span> W</div>
                        </div>
                    </div>
                    
                    <div id="alertBox" class="hidden mb-6 p-4 bg-red-50 border-l-4 border-red-500 rounded-r-xl flex items-start gap-3">
                        <i data-lucide="alert-octagon" class="w-5 h-5 text-red-500 shrink-0 mt-0.5"></i>
                        <div>
                            <h4 class="text-xs font-bold text-red-600 uppercase mb-1">KRİTİK UYARI</h4>
                            <p class="text-[10px] text-red-600/80 leading-relaxed" id="alertMsg">...</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 border border-slate-200 relative z-10 mb-6 shadow-sm">
                         <div class="flex justify-between items-end mb-4 border-b border-slate-100 pb-2">
                             <h4 class="text-xs font-black text-slate-700 uppercase flex items-center gap-2"><i data-lucide="bar-chart-3" class="w-4 h-4 text-indigo-500"></i> Enerji Verimlilik Sınıfı</h4>
                             <span class="text-[9px] text-slate-400">EN 17956 / VDI 2055 Referans</span>
                         </div>
                         <div id="eiifChart"></div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 relative z-10">
                         <div class="p-4 rounded-xl border border-slate-200 bg-slate-50">
                             <div class="text-[9px] text-slate-500 font-bold uppercase mb-1">Hesaplanan Alan</div>
                             <div class="text-xl font-bold text-slate-800 font-mono" id="resArea">-- m²</div>
                         </div>
                         <div class="p-4 rounded-xl border border-indigo-100 bg-indigo-50 hidden" id="rowInter">
                             <div class="text-[9px] text-indigo-400 font-bold uppercase mb-1 flex items-center gap-1">
                                 <i data-lucide="layers" class="w-3 h-3"></i> Ara Yüzey Sıcaklığı
                             </div>
                             <div class="text-xl font-bold text-indigo-900 font-mono" id="resTInter">-- °C</div>
                             <div class="text-[8px] text-indigo-400 mt-0.5">Katman 1 ve 2 arası</div>
                         </div>
                    </div>

                </div>
            </div>

        </div>
    </main>
</div>

<script>
    function initApp(){ 
        fillDN('dn');
        setType('pipe');
        lucide.createIcons();
        calc();
    }
    
    function setStd(val){
        document.getElementById('calcStd').value = val;
        const btns = document.querySelectorAll('.std-btn');
        btns.forEach(btn => btn.classList.remove('active'));
        document.getElementById('std-'+val).classList.add('active');
        const names = {iso:'TS EN ISO 12241', astm:'ASTM C680', vdi:'VDI 2055'};
        document.getElementById('stdBadge').innerText = names[val];
        calc();
    }

    const PIPES={15:21.3,20:26.7,25:33.4,32:42.2,40:48.3,50:60.3,65:73.0,80:88.9,100:114.3,125:141.3,150:168.3,200:219.1,250:273.0,300:323.9,350:355.6,400:406.4,500:508.0};
    
    // GÜNCELLENEN MATERYAL LİSTESİ
    const MATS={
        rockwool:{a:0.035,b:0.00017,c:0, limit:650},
        needlemat:{a:0.033,b:0.00015,c:0, limit:650, name:"İğnelenmiş Cam Elyaf"}, // YENİ
        ceramic:{a:0.025,b:0.00012,c:1.2e-7, limit:1200},
        aerogel:{a:0.019,b:0.00004,c:5e-8, limit:650},
        rubber:{a:0.034,b:0.000075,c:0, limit:105},
        pu:{a:0.024,b:0.000075,c:0, limit:100}
    };
    const VALVE_FACTORS={gate:1.2,globe:1.4,butterfly:0.6,ball:1.0,strainer:1.5,check:0.9};

    function fillDN(id){
        const el=document.getElementById(id); el.innerHTML='';
        for(const[k,v]of Object.entries(PIPES)){
            let o=document.createElement('option'); o.value=k; o.text=`DN ${k} (${v}mm)`; el.add(o);
        }
        el.value='100';
    }

    function setType(t){
        document.getElementById('type').value = t;
        const btns = {pipe:'btn-pipe', valve:'btn-valve', flange:'btn-flange', flat:'btn-flat'};
        Object.keys(btns).forEach(k => {
             document.getElementById(btns[k]).className = "flex-1 py-1.5 text-[10px] font-bold rounded text-slate-500 hover:text-slate-800 transition-all";
        });
        document.getElementById(btns[t]).className = "flex-1 py-1.5 text-[10px] font-bold rounded bg-indigo-600 text-white shadow transition-all";

        const boxValve = document.getElementById('box-valve');
        const rowDn = document.getElementById('row-dn');
        const rowDims = document.getElementById('row-dims');
        const boxQty = document.getElementById('box-qty');
        const lblQty = document.getElementById('lblQty');
        
        if(t === 'flat'){
            rowDn.classList.add('hidden');
            rowDims.classList.remove('hidden');
        } else {
            rowDn.classList.remove('hidden');
            rowDims.classList.add('hidden');
            if(t === 'valve') {
                boxValve.classList.remove('hidden');
                boxQty.classList.remove('hidden');
                lblQty.innerText = "Adet";
            } else if (t === 'flange') {
                boxValve.classList.add('hidden');
                boxQty.classList.remove('hidden');
                lblQty.innerText = "Adet";
            } else {
                boxValve.classList.add('hidden');
                boxQty.classList.remove('hidden');
                lblQty.innerText = "Metraj (m)";
            }
        }
        calc();
    }

    function toggleL2(){
        const chk = document.getElementById('useL2').checked;
        const box = document.getElementById('layer2Box');
        const boxRes = document.getElementById('rowInter');
        if(chk){ box.classList.remove('hidden'); boxRes.classList.remove('hidden'); }
        else { box.classList.add('hidden'); boxRes.classList.add('hidden'); }
        calc();
    }

    function getK(matKey, T){ return MATS[matKey].a + (MATS[matKey].b * T) + (MATS[matKey].c * T * T); }
    
    function getH(vWind, Ts, Ta, D_out, isFlat){
        const std = document.getElementById('calcStd').value;
        const dT = Math.abs(Ts - Ta);
        const eps = 0.8; 
        let h_rad = eps * 5.67e-8 * (Math.pow(Ts+273.15,4) - Math.pow(Ta+273.15,4)) / (dT || 1);
        if(dT < 0.1) h_rad = 5; 

        let h_cv = 0;
        if(std === 'astm'){
             if(vWind < 0.1){
                 h_cv = isFlat ? 1.95 * Math.pow(dT, 0.25) : 1.32 * Math.pow(dT/D_out, 0.25);
             } else {
                 h_cv = 10.0 * Math.pow(vWind, 0.6) / Math.pow(D_out, 0.4);
             }
        } else if (std === 'vdi'){
             if(vWind < 0.1) h_cv = 3.5 + 0.05 * dT;
             else h_cv = 3.9 * Math.pow(vWind, 0.7) / Math.pow(D_out, 0.3);
        } else {
             if(vWind < 0.1){
                  h_cv = isFlat ? 2.2 * Math.pow(dT, 0.25) : 1.4 * Math.pow(dT/D_out, 0.25);
             } else {
                  h_cv = 4 + 4 * vWind; 
             }
        }
        if(h_cv < 1) h_cv = 1;
        return (h_rad + h_cv) || 10;
    }

    function getEiifLimits(dnVal, tProc, tAmb) { 
        const dT = Math.abs(tProc - tAmb); 
        const dn = parseFloat(dnVal); 
        let baseLimit = (0.25 * dn + 10) * (dT / 50); 
        return { A: baseLimit*0.5, B: baseLimit*0.7, C: baseLimit*1.0, D: baseLimit*1.3, E: baseLimit*1.8, F: baseLimit*2.5, G: baseLimit*3.5 }; 
    }

    function calc(){
        const type = document.getElementById('type').value;
        const tProc = parseFloat(document.getElementById('tProc').value) || 0;
        const tAmb = parseFloat(document.getElementById('tAmb').value) || 25;
        const vWind = parseFloat(document.getElementById('vWind').value) || 0;
        const qty = parseFloat(document.getElementById('qty').value) || 1;
        
        let dnVal = 100;
        let dPipe = 0.114;
        let isFlat = (type === 'flat');
        let multiplier = 1; 

        if(!isFlat){
            dnVal = document.getElementById('dn').value;
            dPipe = PIPES[dnVal] / 1000;
            if(type === 'pipe'){
                multiplier = qty; 
            } else if (type === 'valve'){
                const factor = VALVE_FACTORS[document.getElementById('valveType').value] || 1.5;
                multiplier = (dPipe * 6 * factor) * qty; 
            } else if (type === 'flange'){
                multiplier = (dPipe * 2.5) * qty;
            }
        } else {
             const dimW = parseFloat(document.getElementById('dimW').value)||1;
             const dimH = parseFloat(document.getElementById('dimH').value)||1;
             multiplier = dimW * dimH; 
             dPipe = 1.0; 
        }
        
        const mat1Key = document.getElementById('mat1').value;
        const thk1 = parseFloat(document.getElementById('thk1').value) / 1000;
        const useL2 = document.getElementById('useL2').checked;
        const mat2Key = document.getElementById('mat2').value;
        const thk2 = parseFloat(document.getElementById('thk2').value) / 1000;

        let minTs = tAmb, maxTs = tProc, Ts = (minTs + maxTs)/2;
        let T_inter = 0;
        let Q_unit = 0;

        for(let i=0; i<50; i++){
            const Tm1 = (tProc + (useL2 ? (tProc+Ts)/2 : Ts))/2; 
            const k1 = getK(mat1Key, Tm1);
            let R1 = 0;
            if(isFlat) R1 = thk1 / k1;
            else R1 = Math.log((dPipe + 2*thk1)/dPipe) / (2*Math.PI*k1);

            let R2 = 0;
            if(useL2){
                const Tm2 = ((tProc+Ts)/2 + Ts)/2;
                const k2 = getK(mat2Key, Tm2);
                if(isFlat) R2 = thk2 / k2;
                else R2 = Math.log((dPipe + 2*thk1 + 2*thk2)/(dPipe + 2*thk1)) / (2*Math.PI*k2);
            }

            const R_ins = R1 + R2;
            const Q_cond = (tProc - Ts) / R_ins;
            const D_surf = isFlat ? 1.0 : (dPipe + 2*(thk1+thk2));
            const h = getH(vWind, Ts, tAmb, D_surf, isFlat);
            let A_surf_unit = isFlat ? 1.0 : (Math.PI * D_surf);
            const Q_conv = h * A_surf_unit * (Ts - tAmb);

            if(Q_cond > Q_conv) minTs = Ts; else maxTs = Ts;
            Ts = (minTs + maxTs)/2;
            
            if(i === 49) {
                Q_unit = Q_conv;
                if(useL2) T_inter = tProc - (Q_cond * R1);
            }
        }

        const Q_total = Q_unit * multiplier; 
        
        let alerts = [];
        if(mat1Key === 'rubber' && tProc > 105){
            alerts.push(`DİKKAT: İç sıcaklık (${tProc}°C), 1. kattaki Kauçuk limitini (105°C) aşıyor!`);
        }
        if(useL2 && mat2Key === 'rubber' && T_inter > 105){
            alerts.push(`DİKKAT: Ara yüzey sıcaklığı (${T_inter.toFixed(1)}°C), 2. kattaki Kauçuk limitini (105°C) aşıyor!`);
        }

        const alertBox = document.getElementById('alertBox');
        if(alerts.length > 0){
            alertBox.classList.remove('hidden');
            document.getElementById('alertMsg').innerHTML = alerts.join("<br>");
        } else {
            alertBox.classList.add('hidden');
        }

        document.getElementById('resTs').innerText = Ts.toFixed(1);
        document.getElementById('resQTotal').innerText = Math.round(Q_total).toLocaleString();
        document.getElementById('resQUnitVal').innerText = Q_unit.toFixed(1);
        document.getElementById('resQUnitLabel').innerText = isFlat ? "W/m²" : "W/m";
        document.getElementById('resArea').innerText = (isFlat ? multiplier : (multiplier * Math.PI * (dPipe + 2*(thk1+thk2)))).toFixed(2) + " m²";
        
        if(useL2) {
            document.getElementById('resTInter').innerText = T_inter.toFixed(1) + " °C";
            document.getElementById('rowInter').classList.remove('hidden');
        } else {
            document.getElementById('rowInter').classList.add('hidden');
        }

        const badgeDiv = document.getElementById('badgeContainer');
        if(Ts > 55){
            badgeDiv.innerHTML = `<span class="inline-flex items-center px-2.5 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-700 border border-red-200"><i data-lucide="flame" class="w-3 h-3 mr-1"></i> YANIK RİSKİ</span>`;
        } else {
            badgeDiv.innerHTML = `<span class="inline-flex items-center px-2.5 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-700 border border-green-200"><i data-lucide="shield-check" class="w-3 h-3 mr-1"></i> GÜVENLİ TEMAS</span>`;
        }
        lucide.createIcons();

        renderEnergyClass(Q_unit, dnVal, tProc, tAmb, isFlat);
    }

    function renderEnergyClass(qVal, dn, tP, tA, isFlat){
        const container = document.getElementById('eiifChart');
        container.innerHTML = '';
        
        if(isFlat) {
            container.innerHTML = `<div class="text-center text-xs text-slate-400 py-4 border border-dashed border-slate-200 rounded-lg">Düz yüzeyler için enerji sınıfı standardı (EN 17956) tanımlı değildir.</div>`;
            return;
        }

        const limits = getEiifLimits(dn, tP, tA);
        const classes = ['A','B','C','D','E','F','G'];
        
        let myClass = 'G';
        if(qVal <= limits.F) myClass = 'F';
        if(qVal <= limits.E) myClass = 'E';
        if(qVal <= limits.D) myClass = 'D';
        if(qVal <= limits.C) myClass = 'C';
        if(qVal <= limits.B) myClass = 'B';
        if(qVal <= limits.A) myClass = 'A';

        classes.forEach(cls => {
            const isActive = (cls === myClass);
            const wClass = `w-${cls.toLowerCase()}`; 
            const limitVal = Math.round(limits[cls] || (limits.G * 1.5)); 
            
            const html = `
            <div class="eiif-row ${isActive ? 'active' : ''}">
                <div class="eiif-label">${cls}</div>
                <div class="eiif-bar-container">
                    <div class="eiif-bar ${wClass}">
                       ${isActive ? `<span class="ml-auto mr-2 bg-white text-slate-900 px-1.5 py-0.5 rounded text-[9px] shadow font-bold">SİZİN</span>` : ''}
                    </div>
                </div>
                <div class="eiif-val">&lt; ${limitVal}</div>
            </div>`;
            container.innerHTML += html;
        });
    }
</script>
</body>
</html>
