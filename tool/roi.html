<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>End√ºstriyel ƒ∞zolasyon Yatƒ±rƒ±mƒ± Amortisman Hesaplama</title>
  <style>
  /* Auth kontrol√º yapƒ±lana kadar sayfa gizli */
  body:not(.auth-checked) {
    opacity: 0;
    pointer-events: none;
  }
  
  body.auth-checked {
    opacity: 1;
    transition: opacity 0.3s ease;
  }
</style>
<meta name="description" content="ISO 12241 standardƒ±na g√∂re boru, vana ve tank y√ºzeylerinden ƒ±sƒ± kaybƒ±nƒ± hesaplayƒ±n.">

  <link rel="icon" type="image/png" sizes="192x192" href="/favicon.png">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../auth.js"></script>
    
    <style>
      body:not(.auth-checked) {
        opacity: 0;
        visibility: hidden;
      }
      body.auth-checked {
        opacity: 1;
        visibility: visible;
        transition: opacity 0.3s ease;
      }
    </style>
    <script>
      setTimeout(function(){ if(document.body) document.body.classList.add('auth-checked'); }, 500);
    </script>
</head>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
      extend: {
        colors: { slate: { 850: '#151e2e', 900: '#0f172a', 950: '#020617' } },
        animation: { 'float-slow': 'float 8s ease-in-out infinite', 'blob': 'blob 20s infinite', },
        keyframes: {
            float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' }, },
            blob: { '0%': { transform: 'translate(0px, 0px) scale(1)' }, '33%': { transform: 'translate(30px, -50px) scale(1.1)' }, '66%': { transform: 'translate(-20px, 20px) scale(0.9)' }, '100%': { transform: 'translate(0px, 0px) scale(1)' }, }
        }
      }
    }
  }
</script>
<style>
  :root {
      --bg-color: #f1f5f9; 
      --glass-bg: #ffffff;
      --glass-border: rgba(148, 163, 184, 0.4);
      --input-bg: #f8fafc;
      --input-border: #cbd5e1;
      --text-main: #0f172a; 
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --grid-color: rgba(0, 0, 0, 0.05);
  }

  .dark {
      --bg-color: #0f172a;
      --glass-bg: rgba(30, 41, 59, 0.4);
      --glass-border: rgba(255, 255, 255, 0.08);
      --input-bg: rgba(15, 23, 42, 0.6);
      --input-border: rgba(255, 255, 255, 0.1);
      --text-main: #f1f5f9;
      --card-shadow: none;
      --grid-color: rgba(255, 255, 255, 0.03);
  }

  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #64748b; }
  
  html { scroll-behavior: smooth; }
  
  body { 
      background-color: var(--bg-color); 
      color: var(--text-main); 
      overflow-x: hidden; 
      transition: background-color 0.3s ease, color 0.3s ease;
  }
  
  .app-container { max-width: 1600px; margin: 0 auto; width: 100%; }

  .glass-card { 
      transition: all 0.3s ease; 
      background-color: var(--glass-bg); 
      backdrop-filter: blur(16px); 
      border: 1px solid var(--glass-border); 
      box-shadow: var(--card-shadow);
  }
  
  .glass-input { 
      transition: all 0.2s; 
      border-radius: 0.5rem; 
      padding: 0.6rem 0.75rem; 
      width: 100%; 
      background-color: var(--input-bg); 
      border: 1px solid var(--input-border); 
      color: var(--text-main); 
  }
  .glass-input:focus { outline: none; border-color: #ef4444; box-shadow: 0 0 0 2px rgba(239,68,68,0.1); }
  .glass-input:disabled { opacity: 0.5; cursor: not-allowed; }

  .bg-grid { 
      background-size: 40px 40px; 
      background-image: 
          linear-gradient(to right, var(--grid-color) 1px, transparent 1px), 
          linear-gradient(to bottom, var(--grid-color) 1px, transparent 1px); 
      mask-image: radial-gradient(circle at center, black 70%, transparent 100%); 
      pointer-events: none; 
  }

  html:not(.dark) .blob-bg { display: none; }
  
  html.dark body {
      background: radial-gradient(ellipse at top, #1e1b4b 0%, #0f172a 40%, #020617 100%);
      background-attachment: fixed;
  }

  .grid-input {
      background: transparent;
      border: 1px solid transparent;
      border-radius: 4px;
      padding: 4px;
      width: 100%;
      text-align: center;
      transition: all 0.2s;
      font-weight: bold;
  }
  .grid-input:hover { border-color: #cbd5e1; background-color: rgba(255,255,255,0.1); }
  .grid-input:focus { border-color: #ef4444; background-color: rgba(255,255,255,0.2); outline: none; }

  .table-container {
      max-height: 650px;
      overflow-y: auto;
      position: relative;
  }
  .table-sticky-header th {
      position: sticky;
      top: 0;
      z-index: 10;
  }
  html:not(.dark) .table-sticky-header th {
      background-color: #f1f5f9;
  }
  html.dark .table-sticky-header th {
      background-color: #1e293b;
  }

  /* Print Styles */
  @media print {
    @page { margin: 0; size: A4; }
    
    html, body { width: 210mm; height: 297mm; margin: 0 !important; padding: 0 !important; background: white !important; color: black !important; overflow: visible !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    #app-layer, nav, .glass-card, button, input, select { display: none !important; }
    #print-area { display: block !important; }
    .print-page { width: 210mm; height: 296mm; position: relative; page-break-after: always; overflow: hidden; background: white !important; color: #0f172a !important; }
    .print-page:last-child { page-break-after: auto; }
    
    .cover-bg { background-color: white !important; color: #1e293b !important; }
    
    .print-page, .print-page * {
        --tw-text-opacity: 1 !important;
    }
    .print-page .dark\:text-slate-100,
    .print-page .dark\:text-slate-200,
    .print-page .dark\:text-slate-300 { color: inherit !important; }
    .print-page .dark\:bg-slate-800\/50,
    .print-page .dark\:bg-slate-900,
    .print-page .dark\:bg-slate-800 { background-color: transparent !important; }
    .print-page .dark\:border-slate-700,
    .print-page .dark\:border-slate-600 { border-color: #e2e8f0 !important; }
    
    .print-page .text-slate-900 { color: #0f172a !important; }
    .print-page .text-slate-800 { color: #1e293b !important; }
    .print-page .text-slate-700 { color: #334155 !important; }
    .print-page .text-slate-600 { color: #475569 !important; }
    .print-page .text-slate-500 { color: #64748b !important; }
    .print-page .text-slate-400 { color: #94a3b8 !important; }
    .print-page .bg-slate-50 { background-color: #f8fafc !important; }
    .print-page .bg-slate-100 { background-color: #f1f5f9 !important; }
    .print-page .bg-white { background-color: #ffffff !important; }
    .print-page .border-slate-100 { border-color: #f1f5f9 !important; }
    .print-page .border-slate-200 { border-color: #e2e8f0 !important; }
    .print-page .border-slate-900 { border-color: #0f172a !important; }
    
    .audit-table th { background-color: #f8fafc !important; color: #475569 !important; font-weight: 700; text-transform: uppercase; font-size: 7px; padding: 4px; border-bottom: 2px solid #0f172a !important; }
    .audit-table td { border-bottom: 1px solid #e2e8f0 !important; padding: 4px; font-size: 8px; color: #334155 !important; vertical-align: middle; }
    .audit-table tr:nth-child(even) { background-color: #f8fafc; }
    
    #covQrCode { mix-blend-mode: normal !important; }
    #covQrCode[src]:not([src=""]) { opacity: 1 !important; }
    
    body.hide-qr-section .qr-report-section { display: none !important; }
  }
  #print-area { display: none; }
  
  .force-light-print .print-page .text-slate-500.dark\:text-slate-400 { color: #64748b !important; }
  .force-light-print .print-page .text-slate-800.dark\:text-slate-100 { color: #1e293b !important; }
  .force-light-print .print-page .text-indigo-600.dark\:text-red-600 { color: #4f46e5 !important; }
  .force-light-print .print-page .bg-white.dark\:bg-slate-800\/50 { background-color: #ffffff !important; }
</style>
<script>
    (function() {
        const isDark = localStorage.getItem('darkMode') === 'true';
        if (isDark) {
            document.documentElement.classList.add('dark');
        }
    })();
</script>
</head>
<body class="antialiased selection:bg-red-500/30 selection:text-red-600" onload="initApp()">

<div class="fixed inset-0 z-0 pointer-events-none overflow-hidden">
    <div class="absolute inset-0 bg-grid"></div>
    <div class="blob-bg absolute top-20 left-20 w-96 h-96 bg-indigo-500/20 dark:bg-red-500/20 rounded-full filter blur-3xl animate-blob"></div>
    <div class="blob-bg absolute top-40 right-20 w-80 h-80 bg-purple-500/20 rounded-full filter blur-3xl animate-blob animation-delay-2000"></div>
    <div class="blob-bg absolute bottom-20 left-1/3 w-96 h-96 bg-pink-500/20 rounded-full filter blur-3xl animate-blob animation-delay-4000"></div>
</div>

<div id="app-layer" class="relative z-10 flex flex-col min-h-screen">
    <nav class="sticky top-0 z-50 glass-card !bg-white dark:bg-slate-800/50/90 dark:!bg-slate-900/40 !border-x-0 !border-t-0 !rounded-none border-b border-slate-200 dark:border-slate-700/50 backdrop-blur-xl">
      <div class="app-container px-6 h-16 flex items-center justify-between">
          <a href="../dashboard.html" class="flex items-center gap-3 group">
              <div><h1 class="text-lg font-bold text-slate-800 dark:text-slate-100 tracking-wide">Optimizi<span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 to-orange-500">.Roi</span></h1></div>
          </a>
          <div class="flex items-center gap-3">
              <div class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 text-xs text-slate-500 dark:text-slate-400">
                  <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                  <span id="fxVal" class="font-bold text-slate-800 dark:text-slate-100">...</span> <span class="text-[10px] opacity-70">TL/USD</span>
                  <button onclick="getFx()"><i data-lucide="refresh-cw" class="w-3 h-3 ml-1 hover:animate-spin text-slate-400 hover:text-indigo-500 dark:text-red-500 cursor-pointer"></i></button>
              </div>
              
              <label class="flex items-center gap-2 cursor-pointer bg-slate-100 dark:bg-slate-800/50 px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-700 hover:border-green-500 transition select-none">
                  <i data-lucide="qr-code" class="w-4 h-4 text-slate-500 dark:text-slate-400"></i>
                  <span class="text-[10px] font-bold text-slate-500 dark:text-slate-400">QR G√∂ster</span>
                  <div class="relative inline-block w-9 h-5 cursor-pointer" onclick="event.preventDefault(); var cb=document.getElementById('toggleQrInput'); cb.checked=!cb.checked; toggleQrVisibility();">
                      <input type="checkbox" id="toggleQrInput" checked class="sr-only peer">
                      <div class="w-9 h-5 bg-slate-300 peer-checked:bg-green-500 rounded-full transition-colors duration-200"></div>
                      <div class="absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full shadow transition-transform duration-200 peer-checked:translate-x-4"></div>
                  </div>
              </label>

              <input type="file" id="qrInp" class="hidden" accept="image/*" onchange="readQr(this)">
              <button onclick="document.getElementById('qrInp').click()" id="navQrBtn" class="flex items-center gap-2 cursor-pointer bg-slate-100 dark:bg-slate-800/50 px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-700 hover:border-green-500 transition">
                  <i data-lucide="upload" class="w-4 h-4 text-green-500"></i>
                  <span id="navQrLabel" class="text-[10px] font-bold text-slate-500 dark:text-slate-400 hidden md:inline">QR Y√ºkle</span>
              </button>

              <button onclick="toggleDarkMode()" class="flex items-center gap-2 cursor-pointer bg-slate-100 dark:bg-slate-800/50 px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-700 hover:border-indigo-500 dark:hover:border-red-500 transition">
                  <i data-lucide="sun" class="w-4 h-4 text-amber-500 dark:hidden"></i>
                  <i data-lucide="moon" class="w-4 h-4 text-indigo-400 hidden dark:block"></i>
                  <span class="text-[10px] font-bold text-slate-500 dark:text-slate-400 hidden md:inline">Tema</span>
              </button>

              <button onclick="saveCalculation()" class="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg text-xs font-bold transition shadow-lg shadow-emerald-600/20 active:scale-95 ml-2 cursor-pointer">
                  <i data-lucide="save" class="w-4 h-4"></i> <span class="hidden md:inline">Kaydet</span>
              </button>

              <button onclick="showReportLangPopup()" class="flex items-center gap-2 bg-indigo-600 dark:bg-red-600 hover:bg-indigo-500 dark:hover:bg-red-500 text-white px-4 py-2 rounded-lg text-xs font-bold transition shadow-lg shadow-indigo-600/20 active:scale-95 ml-2 cursor-pointer">
                  <i data-lucide="printer" class="w-4 h-4"></i> Rapor Al
              </button>
          </div>
      </div>
    </nav>

    <main class="flex-1 app-container p-6 lg:p-8">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="glass-card p-6 relative overflow-hidden group rounded-2xl">
               <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition transform group-hover:scale-110"><i data-lucide="timer" class="w-24 h-24 text-indigo-500 dark:text-red-500"></i></div>
               <div class="text-slate-500 dark:text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-2">Ort. Amortisman</div>
               <div class="text-4xl font-bold text-slate-800 dark:text-slate-100 tracking-tight" id="dashRoi">---</div>
               <div class="mt-4 h-1 w-full bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden"><div id="barRoi" class="h-full bg-indigo-500/20 dark:bg-red-500 w-0 transition-all duration-1000 shadow-[0_0_10px_rgba(99,102,241,0.5)] dark:shadow-[0_0_10px_rgba(239,68,68,0.5)]"></div></div>
            </div>
            <div class="glass-card p-6 relative overflow-hidden group rounded-2xl">
               <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition"><i data-lucide="wallet" class="w-24 h-24 text-green-500 dark:text-emerald-500"></i></div>
               <div class="text-slate-500 dark:text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-2">Yƒ±llƒ±k Kazan√ß</div>
               <div class="text-3xl font-bold text-green-600 dark:text-emerald-400 tracking-tight" id="dashSave">0</div>
            </div>
            <div class="glass-card p-6 relative overflow-hidden rounded-2xl">
               <div class="text-slate-500 dark:text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-2">Toplam Yatƒ±rƒ±m</div>
               <div class="flex items-center gap-2">
                   <input type="number" id="manualTotalInv" class="text-2xl font-bold text-slate-800 dark:text-slate-100 tracking-tight bg-transparent border-b-2 border-slate-300 dark:border-slate-600 focus:border-indigo-500 dark:focus:border-red-500 outline-none w-full" placeholder="Toplam Yatƒ±rƒ±m Girin" step="0.01" oninput="updateTotalInvestment()">
                   <select id="manualInvCurr" class="text-sm font-medium bg-slate-100 dark:bg-slate-800 dark:text-slate-200 border border-slate-300 dark:border-slate-600 rounded px-2 py-1" onchange="updateTotalInvestment()">
                       <option value="TL">‚Ç∫</option>
                       <option value="USD">$</option>
                       <option value="EUR">‚Ç¨</option>
                   </select>
               </div>
               <div class="text-xs text-slate-500 dark:text-slate-400 mt-2">Otomatik: <span id="dashInv" class="font-bold">0</span></div>
            </div>
            <div class="glass-card p-6 !bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-800/40 dark:to-slate-900/40 border-orange-500/20 dark:border-orange-500/30 rounded-2xl">
               <div class="flex items-center justify-between">
                  <div>
                      <div class="text-orange-500 dark:text-orange-400 text-[10px] font-bold uppercase tracking-wider mb-1">CO2 Azaltƒ±m</div>
                      <div class="text-3xl font-bold text-slate-800 dark:text-slate-100" id="dashCo2">0 <span class="text-sm font-normal text-slate-500 dark:text-slate-400">Ton</span></div>
                  </div>
                  <div class="p-3 bg-orange-500/10 dark:bg-orange-500/20 rounded-xl text-orange-600 dark:text-orange-400 border border-orange-500/20 dark:border-orange-500/30"><i data-lucide="leaf" class="w-6 h-6"></i></div>
               </div>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-12 gap-8 items-start">
            <div class="xl:col-span-3 space-y-6 max-h-[calc(100vh-180px)] overflow-y-auto pr-2">
                <div class="glass-card p-6 rounded-2xl">
                   <h3 class="text-indigo-500 dark:text-red-500 text-xs font-bold uppercase mb-4 flex items-center gap-2"><i data-lucide="briefcase" class="w-4 h-4"></i> Proje Detaylarƒ±</h3>
                   <div class="space-y-4">
                       <div><label class="text-[10px] uppercase text-slate-500 dark:text-slate-400 font-bold mb-1 block">Hazƒ±rlayan</label><div class="grid gap-2"><input type="text" id="pName" class="glass-input text-xs" placeholder="Firma Adƒ±"><input type="text" id="pEng" class="glass-input text-xs" placeholder="M√ºhendis Adƒ±"></div></div>
                       <div>
                           <label class="text-[10px] uppercase text-slate-500 dark:text-slate-400 font-bold mb-1 block">Saha Denetim Tarihi</label>
                           <input type="date" id="auditDate" class="glass-input text-xs text-slate-600 dark:text-slate-300">
                       </div>
                       <div class="h-px bg-slate-200 dark:bg-slate-700 my-3"></div>
                       <div><label class="text-[10px] uppercase text-slate-500 dark:text-slate-400 font-bold mb-1 block">Firma Bilgileri</label><div class="grid gap-2"><input type="text" id="cName" class="glass-input text-xs" placeholder="Firma Adƒ±"><input type="text" id="cEng" class="glass-input text-xs" placeholder="Yetkili Ki≈üi / √únvan"></div></div>
                   </div>
                </div>

                <div class="glass-card p-6 rounded-2xl">
                    <h3 class="text-orange-500 dark:text-orange-400 text-xs font-bold uppercase mb-4 flex items-center gap-2"><i data-lucide="flame" class="w-4 h-4"></i> Ortam & Enerji</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">Ortam Sƒ±c. (¬∞C)</label><input type="number" id="tAmb" class="glass-input text-xs" value="25"></div>
                        <div><label class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">R√ºzgar (m/s)</label><input type="number" id="vWind" class="glass-input text-xs" value="0" step="0.5"></div>
                    </div>
                    
                    <div class="mt-4">
                        <label class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">Yakƒ±t Tipi</label>
                        <select id="fuel" onchange="toggleFuelMode()" class="glass-input text-xs">
                             <option value="gas">Doƒüalgaz (8250 kcal/m¬≥)</option>
                             <option value="elec">Elektrik (860 kcal/kWh)</option>
                             <option value="lng">LNG (11500 kcal/kg)</option>
                             <option value="fueloil">Fuel Oil (9600 kcal/kg)</option>
                             <option value="coal_imp">ƒ∞thal K√∂m√ºr (6000 kcal/kg)</option>
                             <option value="coal_loc">Yerli K√∂m√ºr (3500 kcal/kg)</option>
                             <option value="manual" class="font-bold text-indigo-500 dark:text-red-500">‚ö° Manuel Giri≈ü</option>
                        </select>
                    </div>

                    <div id="manualFuelBox" class="hidden mt-3 p-3 rounded-lg bg-slate-50 dark:bg-slate-800/80 border border-slate-200 dark:border-slate-700">
                         <div class="grid grid-cols-2 gap-3">
                             <div>
                                 <label class="text-[9px] text-indigo-500 dark:text-red-500 font-bold mb-1 block">LHV (kcal)</label>
                                 <input type="number" id="fuelLhv" class="glass-input text-xs" placeholder="√ñrn: 8250">
                             </div>
                             <div>
                                 <label class="text-[9px] text-indigo-500 dark:text-red-500 font-bold mb-1 block">Birim</label>
                                 <select id="fuelUnit" class="glass-input text-xs">
                                     <option value="m3">kcal/m¬≥</option>
                                     <option value="kg">kcal/kg</option>
                                     <option value="kwh">kcal/kWh</option>
                                 </select>
                             </div>
                         </div>
                    </div>
                    
                    <div class="mt-4">
                        <label class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">Kazan Verimi %</label>
                        <input type="number" id="eff" class="glass-input text-center text-xs" value="85">
                    </div>

                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div>
                            <label class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">Birim Fiyat</label>
                            <div class="flex gap-1"><input type="number" id="price" class="glass-input text-xs" value="0.15"><select id="energyCurr" class="glass-input !px-1 w-14 text-center text-xs"><option value="TL" selected>‚Ç∫</option><option value="USD">$</option><option value="EUR">‚Ç¨</option></select></div>
                        </div>
                        <div><label class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">Yƒ±llƒ±k Saat</label><input type="number" id="hours" class="glass-input text-xs" value="8000"></div>
                    </div>
                </div>

                <div id="packagePanel" class="hidden glass-card p-6 rounded-2xl border-2 border-indigo-500 dark:border-red-500/50 bg-indigo-50/50 dark:bg-slate-800/80">
                    <div class="flex justify-between items-start mb-4">
                         <h3 class="text-indigo-600 dark:text-red-400 text-sm font-bold uppercase flex items-center gap-2">
                             <i data-lucide="package" class="w-5 h-5"></i> Paket Olu≈üturucu
                         </h3>
                         <div class="bg-indigo-200 dark:bg-red-900/50 text-indigo-700 dark:text-red-300 text-[10px] font-bold px-2 py-1 rounded">MOD AKTƒ∞F</div>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="bg-white dark:bg-slate-800/50 rounded-lg p-3 max-h-40 overflow-y-auto border border-slate-200 dark:border-slate-700">
                            <ul id="pkgList" class="space-y-2 text-xs">
                                <li class="text-slate-400 text-center italic py-2">Hen√ºz sepete √ºr√ºn eklenmedi.</li>
                            </ul>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 text-[10px]">
                            <div class="text-slate-500 dark:text-slate-400">Sepet Toplamƒ±:</div>
                            <div class="text-right font-bold text-slate-800 dark:text-slate-100" id="pkgTotalQty">0 Par√ßa</div>
                            <div class="text-slate-500 dark:text-slate-400">Potansiyel Kazan√ß:</div>
                            <div class="text-right font-bold text-green-600" id="pkgTotalSave">0 ‚Ç∫</div>
                        </div>

                        <div class="pt-3 border-t border-indigo-200">
                            <label class="text-[10px] text-indigo-600 dark:text-red-600 font-bold block mb-1">Paket Adƒ±</label>
                            <input type="text" id="pkgName" class="glass-input text-xs mb-2" placeholder="√ñrn: Kazan Dairesi Seti">
                            
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div>
                                    <label class="text-[10px] text-indigo-600 dark:text-red-600 font-bold block mb-1">Paket Adedi</label>
                                    <input type="number" id="pkgQty" class="glass-input text-center text-xs font-bold" value="1" placeholder="Adet">
                                </div>
                                <div>
                                    <label class="text-[10px] text-indigo-600 dark:text-red-600 font-bold block mb-1">Paket Foto</label>
                                    <input type="file" id="pkgImgInp" class="hidden" accept="image/*" onchange="readPkgImg(this)">
                                    <button onclick="document.getElementById('pkgImgInp').click()" class="w-full h-[34px] glass-input text-xs flex items-center justify-center gap-2 hover:bg-slate-100 dark:bg-slate-800 transition"><i data-lucide="camera" class="w-3 h-3"></i> Se√ß</button>
                                </div>
                            </div>
                            <img id="pkgPrevImg" class="hidden w-full h-16 object-cover rounded-lg mb-2 border border-indigo-200">

                            <label class="text-[10px] text-indigo-600 dark:text-red-600 font-bold block mb-1">Paket (Birim) Yatƒ±rƒ±m Bedeli</label>
                            <div class="flex gap-1 mb-3">
                                <input type="number" id="pkgInv" class="glass-input text-xs" placeholder="Birim Set Tutar">
                                <select id="pkgInvCurr" class="glass-input !px-1 w-14 text-center text-xs">
                                    <option value="TL">‚Ç∫</option>
                                    <option value="USD">$</option>
                                    <option value="EUR">‚Ç¨</option>
                                </select>
                            </div>
                            
                            <button onclick="commitPackage()" class="w-full bg-indigo-600 dark:bg-red-600 hover:bg-indigo-500 dark:hover:bg-red-500 text-white font-bold py-2 rounded-lg text-xs shadow transition active:scale-95">Paketi Tamamla & Listeye Ekle</button>
                        </div>
                    </div>
                </div>
                <div class="glass-card p-6 border-indigo-500 dark:border-red-500/30 shadow-[0_0_20px_rgba(99,102,241,0.1)] rounded-2xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-indigo-500/20 dark:bg-red-500/10 rounded-full blur-2xl -mr-16 -mt-16 pointer-events-none"></div>
                    
                    <div class="flex justify-between items-center mb-4 relative z-10">
                        <h3 class="text-slate-800 dark:text-slate-100 text-sm font-bold uppercase flex items-center gap-2"><i data-lucide="plus-circle" class="w-4 h-4 text-indigo-500 dark:text-red-500"></i> Yeni √ñl√ß√ºm Ekle</h3>
                        <button onclick="togglePackageMode()" id="btnTogglePkg" class="text-[10px] bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-3 py-1 rounded-full hover:bg-indigo-100 dark:hover:bg-red-900/30 hover:text-indigo-600 dark:hover:text-red-400 transition font-bold flex items-center gap-1"><i data-lucide="box" class="w-3 h-3"></i> Paket Modunu A√ß</button>
                    </div>
                    
                    <div class="flex bg-slate-100 dark:bg-slate-800 rounded-lg p-1 mb-4 border border-slate-200 dark:border-slate-700 relative z-10">
                        <button onclick="setType('valve')" id="btn-valve" class="flex-1 py-1.5 text-xs font-medium rounded text-white bg-slate-700 dark:bg-slate-600 shadow transition-all">Armat√ºr</button>
                        <button onclick="setType('pipe')" id="btn-pipe" class="flex-1 py-1.5 text-xs font-medium rounded text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-all">Boru</button>
                        <button onclick="setType('tank')" id="btn-tank" class="flex-1 py-1.5 text-xs font-medium rounded text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-all">Tank/D√ºz</button>
                    </div>
                    <select id="type" class="hidden"><option value="valve">Valve</option><option value="pipe">Pipe</option><option value="tank">Flat</option></select>
                    
                    <div id="g-valve" class="space-y-3 relative z-10">
                        <select id="valveType" class="glass-input text-xs">
                            <optgroup label="Vanalar">
                                <option value="gate">S√ºrg√ºl√º Vana</option>
                                <option value="globe">Glob Vana</option>
                                <option value="ball">K√ºresel Vana</option>
                                <option value="butterfly">Kelebek Vana</option>
                                <option value="check">√áekvalf</option>
                                <option value="strainer">Pislik Tutucu</option>
                                <option value="separator">Buhar Seperat√∂r√º</option>
                            </optgroup>
                            <optgroup label="Baƒülantƒ± Elemanlarƒ±">
                                <option value="flange">Flan≈ü √áifti (Takƒ±m)</option>
                                <option value="elbow">Dirsek (90¬∞)</option>
                            </optgroup>
                            <optgroup label="Kondenstoplar">
                                <option value="trap_float">≈ûamandƒ±ralƒ±</option>
                                <option value="trap_thermo">Termodinamik</option>
                                <option value="trap_bimetal">Bimetalik</option>
                                <option value="trap_bucket">Ters Kovalƒ±</option>
                            </optgroup>
                        </select>
                        <select id="vDN" class="glass-input text-xs"></select>
                    </div>
                    <div id="g-pipe" class="hidden grid grid-cols-2 gap-3 relative z-10"><select id="pDN" class="glass-input text-xs"></select><input type="number" id="pLen" class="glass-input text-xs" placeholder="Boru Uzunluƒüu (m)" value="1"></div>
                    
                    <div id="g-tank" class="hidden relative z-10">
                        <div class="bg-slate-50 dark:bg-slate-800/80 p-3 rounded-lg border border-slate-200 dark:border-slate-700 mb-3">
                            <label class="text-[10px] text-slate-500 dark:text-slate-400 mb-2 block font-bold">1. Se√ßenek: Dikd√∂rtgen Y√ºzey (mm)</label>
                            <div class="flex gap-2 mb-2">
                                <input type="number" id="surfW" class="glass-input text-xs" placeholder="En (mm)">
                                <input type="number" id="surfH" class="glass-input text-xs" placeholder="Boy (mm)">
                                <button onclick="addSurface('rect')" class="bg-indigo-500/20 dark:bg-red-500 hover:bg-indigo-600 dark:bg-red-600 text-white rounded-lg px-3 flex items-center justify-center transition"><i data-lucide="plus" class="w-4 h-4"></i></button>
                            </div>

                            <label class="text-[10px] text-slate-500 dark:text-slate-400 mb-2 block font-bold border-t border-slate-200 dark:border-slate-700 pt-2 mt-2">2. Se√ßenek: Daire Y√ºzey (mm)</label>
                            <div class="flex gap-2 mb-2">
                                <input type="number" id="surfD" class="glass-input text-xs" placeholder="√áap (mm)">
                                <button onclick="addSurface('circle')" class="bg-indigo-500/20 dark:bg-red-500 hover:bg-indigo-600 dark:bg-red-600 text-white rounded-lg px-3 flex items-center justify-center transition"><i data-lucide="circle" class="w-4 h-4"></i></button>
                            </div>

                            <div id="surfaceList" class="space-y-1 mb-2 max-h-24 overflow-y-auto mt-2">
                                </div>
                            <div class="text-right text-[10px] text-slate-500 dark:text-slate-400 border-t border-slate-200 dark:border-slate-700 pt-2">
                                Toplam Alan: <span id="totalSurfArea" class="font-bold text-slate-800 dark:text-slate-100 text-xs">0.00</span> m¬≤
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mt-4 relative z-10">
                        <div><label class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">ƒ∞≈ületme Sƒ±c. (¬∞C)</label><div class="relative"><input type="number" id="tProc" class="glass-input pl-8 text-xs" value="160"><i data-lucide="thermometer" class="w-3 h-3 text-red-500 absolute left-2.5 top-2.5"></i></div></div>
                        <div><label id="lblQty" class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">Adet</label><input type="number" id="qty" class="glass-input text-center font-bold text-xs" value="1"></div>
                    </div>
                    
                    <div class="mt-4 relative z-10">
                         <label class="text-[10px] text-slate-500 dark:text-slate-400 mb-1 block">Mahal / Lokasyon</label>
                         <input type="text" id="location" class="glass-input text-xs" placeholder="√ñrn: Kazan Dairesi">
                    </div>

                    <div class="mt-4 relative z-10">
                        <input type="file" id="imgInp" class="hidden" accept="image/*" onchange="readImg(this)">
                        <div onclick="document.getElementById('imgInp').click()" class="border border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-3 text-center cursor-pointer hover:border-indigo-500 dark:border-red-500 hover:bg-slate-100 dark:bg-slate-800 transition group"><i data-lucide="camera" class="w-4 h-4 text-slate-400 mx-auto group-hover:text-indigo-500 dark:text-red-500 mb-1"></i><span class="text-[10px] text-slate-400 block">Termal Foto Se√ß</span></div>
                        <img id="prevImg" class="hidden w-full h-24 object-cover rounded-lg mt-2 border border-slate-300 dark:border-slate-600">
                    </div>

                    <div class="bg-slate-100 dark:bg-slate-800/80 rounded-lg p-3 mt-4 border border-slate-200 dark:border-slate-700 relative z-10">
                        <label class="text-[10px] text-green-600 font-bold uppercase mb-2 block">ƒ∞zolasyon √ñzellikleri</label>
                        <div class="mb-2"><select id="calcStd" class="glass-input text-[10px] !py-1 !h-7 text-slate-500 dark:text-slate-400"><option value="iso">ISO 12241 (Standard)</option><option value="astm">ASTM C680 (USA)</option><option value="vdi">VDI 2055 (German)</option></select></div>
                        
                        <div class="text-[9px] text-slate-400 uppercase font-bold mb-1">1. Katman</div>
                        <select id="matSelect" class="glass-input text-xs mb-2">
                            <option value="rockwool">Ta≈ü Y√ºn√º (Sanayi)</option>
                            <option value="glasswool">ƒ∞ƒünelenmi≈ü Cam Elyaf</option> 
                            <option value="rubber">Elastomerik Kau√ßuk</option>
                            <option value="aerogel">Aerogel</option>
                            <option value="ceramic">Seramik Y√ºn√º</option>
                            <option value="bare" class="font-bold text-red-500">‚ö†Ô∏è Yalƒ±tƒ±msƒ±z (√áƒ±plak)</option>
                        </select>
                        <div class="grid grid-cols-2 gap-2 mt-2 mb-2">
                            <input type="number" id="thk" class="glass-input text-xs" value="50" placeholder="Kalƒ±nlƒ±k (mm)">
                            <div id="singleInvBox">
                                <input type="hidden" id="inv" value="0">
                                <select id="invCurr" class="hidden">
                                    <option value="TL">‚Ç∫</option>
                                    <option value="USD">$</option>
                                    <option value="EUR">‚Ç¨</option>
                                </select>
                            </div>
                        </div>

                        <div class="mt-2 pt-2 border-t border-slate-300 dark:border-slate-600">
                            <label class="flex items-center gap-2 cursor-pointer mb-2">
                                <input type="checkbox" id="useL2" onchange="toggleL2()" class="w-3 h-3 rounded border-slate-400 text-indigo-500 dark:text-red-500">
                                <span class="text-[10px] text-slate-500 dark:text-slate-400 font-bold">2. Katman Ekle (Kompozit)</span>
                            </label>
                            <div id="layer2Box" class="hidden">
                                <select id="matSelect2" class="glass-input text-xs mb-2">
                                    <option value="rubber" selected>Elastomerik Kau√ßuk</option>
                                    <option value="rockwool">Ta≈ü Y√ºn√º (Sanayi)</option>
                                    <option value="glasswool">ƒ∞ƒünelenmi≈ü Cam Elyaf</option>
                                    <option value="aerogel">Aerogel</option>
                                    <option value="ceramic">Seramik Y√ºn√º</option>
                                </select>
                                <input type="number" id="thk2" class="glass-input text-xs" value="19" placeholder="Kalƒ±nlƒ±k (mm)">
                            </div>
                        </div>

                        <div class="mt-3 text-right">
                            <label class="text-[9px] text-slate-500 dark:text-slate-400 mr-2 uppercase font-bold">Rapor Para Birimi:</label>
                            <select id="curr" class="glass-input text-[10px] !w-20 inline-block !py-1 !h-7" onchange="render()"><option value="TL" selected>‚Ç∫ TL</option><option value="USD">$ USD</option><option value="EUR">‚Ç¨ EUR</option></select>
                        </div>
                    </div>

                    <div id="btn-group" class="mt-4 relative z-10">
                        <button id="btnAdd" onclick="calc()" class="w-full bg-indigo-600 dark:bg-red-600 hover:bg-indigo-500 dark:hover:bg-red-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-600/20 transition active:scale-95 flex items-center justify-center gap-2 text-sm cursor-pointer"><i data-lucide="plus" class="w-4 h-4"></i> <span id="btnAddText">Hesapla & Ekle</span></button>
                        <button id="btnUpdate" onclick="finishUpdate()" class="hidden w-full bg-orange-500 hover:bg-orange-400 text-white font-bold py-3 rounded-xl shadow-lg shadow-orange-500/20 transition active:scale-95 flex items-center justify-center gap-2 text-sm cursor-pointer"><i data-lucide="check" class="w-4 h-4"></i> G√ºncellemeyi Bitir</button>
                    </div>
                </div>
            </div>

            <div class="xl:col-span-9">
                <div class="glass-card p-0 overflow-hidden flex flex-col rounded-2xl h-[calc(100vh-100px)]">
                    <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900 shrink-0">
                        <h3 class="font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2"><i data-lucide="list" class="w-4 h-4 text-green-500"></i> Hesaplama Listesi</h3>
                        
                        <div class="flex gap-2">
                             <button onclick="clearAll()" class="text-xs text-red-500 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 transition cursor-pointer">Temizle</button>
                        </div>
                    </div>
                    <div class="overflow-auto flex-1 table-container">
                        <table class="w-full text-left text-sm" id="grid">
                        <thead class="table-sticky-header bg-slate-100 dark:bg-slate-800 text-[10px] uppercase text-slate-500 dark:text-slate-400 font-semibold shadow-sm">
                            <tr>
                            <th class="px-6 py-3 text-slate-600 dark:text-slate-300">G√∂rsel</th>
                            <th class="px-6 py-3 text-slate-600 dark:text-slate-300">Ekipman</th>
                            <th class="px-6 py-3 text-slate-600 dark:text-slate-300">Detay</th>
                            <th class="px-6 py-3 text-center w-24 text-slate-600 dark:text-slate-300">Miktar</th>
                            <th class="px-6 py-3 text-center text-red-500 dark:text-red-400">√áƒ±plak Y√ºzey Sƒ±c.<br><span class="text-[9px]">(Kayƒ±p kWh)</span></th>
                            <th class="px-6 py-3 text-center text-orange-500 dark:text-orange-400">ƒ∞zolasyonlu Y√ºzey Sƒ±c.<br><span class="text-[9px]">(Kayƒ±p kWh)</span></th>
                            <th class="px-6 py-3 text-center text-green-600 dark:text-emerald-400">Kazan√ß<br><span class="text-[9px]">(Fark kWh)</span></th>
                            <th class="px-6 py-3 text-right text-green-600 dark:text-emerald-400">Kazan√ß (Tutar)</th>
                            <th class="px-6 py-3 text-right text-slate-600 dark:text-slate-300">ƒ∞≈ülem</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200 dark:divide-slate-700" id="gridBody">
                            <tr><td colspan="9" class="px-6 py-20 text-center text-slate-500 dark:text-slate-400"><i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 opacity-20"></i><span id="emptyMsg">Hen√ºz hesaplama eklenmedi.</span></td></tr>
                        </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="reportLangPopup" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/50 backdrop-blur-sm" style="display:none;">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-sm w-full mx-4 transform transition-all scale-95 opacity-0" id="reportLangPopupInner">
        <div class="text-center mb-6">
            <div class="w-14 h-14 bg-indigo-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-3">
                <i data-lucide="languages" class="w-7 h-7 text-indigo-600 dark:text-red-500"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-800 dark:text-slate-100">Rapor Dili Se√ßin</h3>
            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Raporun t√ºm i√ßeriƒüi se√ßtiƒüiniz dilde olu≈üturulacaktƒ±r.</p>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-4">
            <button onclick="generateReport('tr')" class="flex flex-col items-center gap-2 p-4 rounded-xl border-2 border-slate-200 dark:border-slate-600 hover:border-indigo-500 dark:hover:border-red-500 hover:bg-indigo-50 dark:hover:bg-red-900/20 transition cursor-pointer group">
                <span class="text-3xl">üáπüá∑</span>
                <span class="text-sm font-bold text-slate-700 dark:text-slate-200 group-hover:text-indigo-600 dark:group-hover:text-red-400">T√ºrk√ße</span>
            </button>
            <button onclick="generateReport('en')" class="flex flex-col items-center gap-2 p-4 rounded-xl border-2 border-slate-200 dark:border-slate-600 hover:border-indigo-500 dark:hover:border-red-500 hover:bg-indigo-50 dark:hover:bg-red-900/20 transition cursor-pointer group">
                <span class="text-3xl">üá¨üáß</span>
                <span class="text-sm font-bold text-slate-700 dark:text-slate-200 group-hover:text-indigo-600 dark:group-hover:text-red-400">English</span>
            </button>
        </div>
        <button onclick="closeReportLangPopup()" class="w-full text-sm text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition py-2 cursor-pointer">ƒ∞ptal</button>
    </div>
</div>

<div id="deleteConfirmPopup" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/50 backdrop-blur-sm" style="display:none;">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-sm w-full mx-4 transform transition-all" id="deleteConfirmInner">
        <div class="text-center mb-6">
            <div class="w-14 h-14 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-3">
                <i data-lucide="trash-2" class="w-7 h-7 text-red-600"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-800 dark:text-slate-100">Silme Onayƒ±</h3>
            <p class="text-sm text-slate-500 dark:text-slate-400 mt-2" id="deleteConfirmMsg">Bu kalemi silmek istediƒüinize emin misiniz?</p>
        </div>
        <div class="grid grid-cols-2 gap-3">
            <button onclick="closeDeletePopup()" class="py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-300 font-bold text-sm hover:bg-slate-50 dark:hover:bg-slate-700 transition cursor-pointer">ƒ∞ptal</button>
            <button onclick="confirmDelete()" class="py-2.5 rounded-xl bg-red-600 hover:bg-red-500 text-white font-bold text-sm transition cursor-pointer shadow-lg shadow-red-600/20">Sil</button>
        </div>
    </div>
</div>

<div id="savePopup" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/50 backdrop-blur-sm" style="display:none;">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all" id="savePopupInner">
        <div class="text-center mb-6">
            <div class="w-14 h-14 bg-emerald-100 dark:bg-emerald-900/30 rounded-full flex items-center justify-center mx-auto mb-3">
                <i data-lucide="check-circle" class="w-7 h-7 text-emerald-600"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-800 dark:text-slate-100" id="savePopupTitle">Hesaplama Kaydedildi</h3>
            <p class="text-sm text-slate-500 dark:text-slate-400 mt-2" id="savePopupMsg">Veriler ba≈üarƒ±yla kaydedildi.</p>
        </div>
        <button onclick="closeSavePopup()" class="w-full py-2.5 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white font-bold text-sm transition cursor-pointer shadow-lg shadow-emerald-600/20">Tamam</button>
    </div>
</div>


<div id="customAlertPopup" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/50 backdrop-blur-sm" style="display:none;">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-sm w-full mx-4 transform transition-all" id="customAlertInner">
        <div class="text-center mb-6">
            <div class="w-14 h-14 bg-amber-100 dark:bg-amber-900/30 rounded-full flex items-center justify-center mx-auto mb-3">
                <i data-lucide="alert-triangle" class="w-7 h-7 text-amber-600"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-800 dark:text-slate-100" id="customAlertTitle">Uyarƒ±</h3>
            <p class="text-sm text-slate-500 dark:text-slate-400 mt-2" id="customAlertMsg">Mesaj</p>
        </div>
        <button onclick="closeCustomAlert()" class="w-full py-2.5 rounded-xl bg-amber-500 hover:bg-amber-400 text-white font-bold text-sm transition cursor-pointer shadow-lg shadow-amber-500/20">Tamam</button>
    </div>
</div>

<div id="print-area">
    <div id="p-cover" class="print-page cover-bg relative overflow-hidden flex flex-col bg-white">
        <div class="flex-1 flex flex-col relative p-12 pb-4">
            <div class="absolute top-0 right-0 p-8 opacity-[0.03]"><i data-lucide="activity" class="w-64 h-64 text-slate-900"></i></div>
            
            <div class="flex justify-between items-start mb-6 relative z-10">
                <div>
                    <div class="text-4xl font-black tracking-tighter text-slate-900">Optimizi<span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 to-orange-500">.App</span></div>
                    <div class="text-[9px] uppercase tracking-[4px] text-slate-400 mt-0.5">Engineering Solutions</div>
                </div>
                <div class="inline-block bg-green-100 text-green-700 px-3 py-1 rounded text-[9px] font-bold uppercase tracking-wider">ISO 12241</div>
            </div>

            <div class="relative z-10 mb-5">
                <h1 class="text-5xl font-black text-slate-900 leading-none mb-3">END√úSTRƒ∞YEL <br><span class="text-transparent bg-clip-text bg-gradient-to-r from-green-600 to-emerald-800">YALITIM</span> ANALƒ∞Zƒ∞</h1>
                <p class="text-xs text-slate-500 leading-relaxed max-w-lg">
                    <span id="covIntroDate" class="font-bold text-slate-900">...</span> tarihinde tesisinizde ger√ßekle≈ütirilen termal denetimler sonucunda; yalƒ±tƒ±msƒ±z ekipmanlardan kaynaklanan ƒ±sƒ± kayƒ±plarƒ±, finansal maliyetler ve karbon ayak izi hesaplanmƒ±≈ütƒ±r.
                </p>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-5 relative z-10">
                <div class="border border-slate-200 rounded-xl p-3">
                    <div class="text-[9px] uppercase text-slate-400 font-bold mb-1" id="covClientLabel">Firma / M√º≈üteri</div>
                    <div class="text-base font-bold text-slate-900 leading-tight" id="covClient">Fƒ∞RMA ADI</div>
                    <div class="text-xs text-slate-400 mt-0.5" id="covContact">Yetkili Ki≈üi</div>
                </div>
                <div class="border border-slate-200 rounded-xl p-3">
                    <div class="text-[9px] uppercase text-slate-400 font-bold mb-1" id="covProvLabel">Tedarik√ßi / Hazƒ±rlayan</div>
                    <div class="text-base font-bold text-slate-900" id="covProv">TEDARƒ∞K√áƒ∞</div>
                    <div class="text-xs text-slate-400 mt-0.5" id="covDate">...</div>
                </div>
            </div>

            <div class="bg-slate-50 rounded-xl border border-slate-200 p-4 mb-5 relative z-10">
                <div class="text-[9px] uppercase text-slate-400 font-bold mb-2 tracking-wider" id="covParamsLabel">Sim√ºlasyon Parametreleri</div>
                <div class="text-xs text-slate-600 leading-relaxed" id="covNarrative">...</div>
                <div class="flex items-center gap-3 mt-2">
                    <span id="covFuelTypeLabel" class="text-[9px] bg-slate-200 px-2 py-0.5 rounded font-bold text-slate-600"></span>
                    <span id="covWorkHoursLabel" class="text-[9px] bg-slate-200 px-2 py-0.5 rounded font-bold text-slate-600"></span>
                </div>
            </div>

            <div class="flex flex-col gap-1.5 relative z-10">
                <div class="p-2 bg-slate-50 rounded-lg border border-slate-100 flex items-center justify-between">
                     <div class="text-xs font-bold text-slate-400 uppercase tracking-wide w-24">G√úNL√úK</div>
                     <div class="text-base font-black text-slate-700 text-right flex-1" id="covFuelDay">0</div>
                     <div class="text-[10px] text-slate-400 fuel-unit-label ml-2 w-12">...</div>
                     <div class="bg-slate-200 rounded px-2 py-0.5 ml-3 w-24 text-center">
                         <div class="text-[10px] font-bold text-slate-600"><span id="covKwhDay">0</span> kWh</div>
                     </div>
                </div>
                <div class="p-2 bg-slate-50 rounded-lg border border-slate-100 flex items-center justify-between">
                     <div class="text-xs font-bold text-slate-400 uppercase tracking-wide w-24">HAFTALIK</div>
                     <div class="text-base font-black text-slate-700 text-right flex-1" id="covFuelWeek">0</div>
                     <div class="text-[10px] text-slate-400 fuel-unit-label ml-2 w-12">...</div>
                     <div class="bg-slate-200 rounded px-2 py-0.5 ml-3 w-24 text-center">
                         <div class="text-[10px] font-bold text-slate-600"><span id="covKwhWeek">0</span> kWh</div>
                     </div>
                </div>
                <div class="p-2 bg-slate-50 rounded-lg border border-slate-100 flex items-center justify-between">
                     <div class="text-xs font-bold text-slate-400 uppercase tracking-wide w-24">AYLIK</div>
                     <div class="text-base font-black text-slate-700 text-right flex-1" id="covFuelMonth">0</div>
                     <div class="text-[10px] text-slate-400 fuel-unit-label ml-2 w-12">...</div>
                     <div class="bg-slate-200 rounded px-2 py-0.5 ml-3 w-24 text-center">
                         <div class="text-[10px] font-bold text-slate-600"><span id="covKwhMonth">0</span> kWh</div>
                     </div>
                </div>
                <div class="p-2 bg-red-50 rounded-lg border border-red-100 flex items-center justify-between">
                     <div class="text-xs font-bold text-red-400 uppercase tracking-wide w-24">YILLIK</div>
                     <div class="text-lg font-black text-red-600 text-right flex-1" id="covFuelYear">0</div>
                     <div class="text-[10px] text-red-400 fuel-unit-label ml-2 w-12">...</div>
                     <div class="bg-red-100 rounded px-2 py-0.5 ml-3 w-24 text-center">
                         <div class="text-[10px] font-bold text-red-700"><span id="covKwhYear">0</span> kWh</div>
                     </div>
                </div>
            </div>
        </div>

        <div class="border-t-2 border-slate-900 mx-12 pt-3 pb-5 flex justify-between items-end relative z-10">
            <div class="qr-report-section">
                <img id="covQrCode" src="" class="w-16 h-16 object-contain opacity-50" alt="QR">
            </div>
            <div class="text-right">
                <div class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1" id="covRoiLabel">Amortisman (ROI)</div>
                <div class="text-7xl font-black text-slate-900 leading-none" id="covRoiBig">---</div>
                <div class="text-sm font-bold text-slate-400 mt-1 uppercase" id="covRoiUnit">AY</div>
            </div>
        </div>
    </div>
    
    <div id="p-table" class="print-page p-12">
        <div class="flex justify-between items-center border-b-2 border-slate-900 pb-4 mb-8"><h2 class="text-xl font-black text-slate-900 uppercase">Detaylƒ± Analiz D√∂k√ºm√º</h2><div class="text-xs text-slate-500 dark:text-slate-400" id="rDate">...</div></div>
        <table class="w-full audit-table mb-8"><thead><tr id="rep_table_head"></tr></thead><tbody id="rTable"></tbody></table>
        <div class="page-num mt-auto pt-8 border-t border-slate-200 dark:border-slate-700 text-center text-[10px] text-slate-400">Page 2 / 3</div>
    </div>
    
    <div id="p-summary" class="print-page p-12 flex flex-col h-full">
        <h2 class="text-2xl font-black text-slate-900 uppercase mb-8 border-b-2 border-slate-900 pb-4">Y√∂netici √ñzeti</h2>
        
        <div class="flex flex-col mb-12">
            <div class="py-6 border-b border-slate-200 flex justify-between items-center group">
                <div>
                    <div class="text-sm text-red-500 font-bold uppercase tracking-widest flex items-center gap-2"><i data-lucide="flame" class="w-4 h-4"></i> Mevcut Yƒ±llƒ±k Kayƒ±p</div>
                    <div class="text-xs text-slate-400 mt-1 font-medium" id="sumFuelLost">...</div>
                </div>
                <div class="text-5xl font-black text-red-600" id="sumLoss">0</div>
            </div>

            <div class="py-6 border-b border-slate-200 flex justify-between items-center group">
                <div>
                    <div class="text-sm text-slate-500 font-bold uppercase tracking-widest flex items-center gap-2"><i data-lucide="wallet" class="w-4 h-4"></i> Toplam Yatƒ±rƒ±m Bedeli</div>
                    <div class="text-xs text-slate-400 mt-1">Malzeme ve ƒ∞≈ü√ßilik Dahil</div>
                </div>
                <div class="text-5xl font-black text-slate-800" id="sumInvSummary">0</div>
            </div>

            <div class="py-6 border-b border-slate-200 flex justify-between items-center group">
                <div>
                    <div class="text-sm text-green-600 font-bold uppercase tracking-widest flex items-center gap-2"><i data-lucide="sprout" class="w-4 h-4"></i> Yƒ±llƒ±k Net Kazan√ß</div>
                    <div class="text-xs text-slate-400 mt-1">Enerji Tasarrufu Sonrasƒ±</div>
                </div>
                <div class="text-5xl font-black text-green-600" id="sumNetSaveSummary">0</div>
            </div>

            <div class="py-6 border-b border-slate-900 flex justify-between items-center group">
                <div>
                    <div class="text-sm text-indigo-600 font-bold uppercase tracking-widest flex items-center gap-2"><i data-lucide="timer" class="w-4 h-4"></i> Geri D√∂n√º≈ü S√ºresi (ROI)</div>
                    <div class="text-xs text-slate-400 mt-1">Amortisman</div>
                </div>
                <div class="text-5xl font-black text-indigo-600" id="sumRoiSummary">---</div>
            </div>
        </div>

        <div class="mb-8"><h3 class="text-sm font-bold text-slate-900 uppercase mb-4 flex items-center gap-2"><i data-lucide="bar-chart-3" class="w-4 h-4"></i> Finansal Projeksiyon (5 Yƒ±l)</h3><table class="w-full text-xs text-right border-collapse"><thead><tr class="bg-slate-100 text-slate-500"><th class="p-2 text-left">Senaryo</th><th class="p-2">Yƒ±l 1</th><th class="p-2">Yƒ±l 2</th><th class="p-2">Yƒ±l 3</th><th class="p-2">Yƒ±l 4</th><th class="p-2">Yƒ±l 5</th><th class="p-2 font-black">TOPLAM</th></tr></thead><tbody class="font-mono" id="projTable"></tbody></table></div>
        
        <div class="flex gap-8 mb-4">
             <div class="flex-1 rounded-xl p-6 flex items-center justify-between relative overflow-hidden h-full border-2 border-emerald-200" style="background-color: #064e3b; color: white;">
                  <div class="absolute right-0 bottom-0 opacity-10 pointer-events-none translate-x-4 translate-y-4"><i data-lucide="sprout" class="w-48 h-48 text-white"></i></div>
                 <div class="z-10"><div class="text-sm font-bold uppercase tracking-widest" style="color: #6ee7b7;">KARBON AYAK ƒ∞Zƒ∞ AZALTIMI</div><div class="text-5xl font-black mt-2"><span id="sumCo2">0</span> <span class="text-2xl font-normal" style="color: #34d399;">Ton/Yƒ±l</span></div></div>
                 <div class="text-right z-10 pl-8" style="border-left: 1px solid #047857;"><div class="text-5xl font-black"><span id="sumTrees">0</span></div><div class="text-sm mt-1" style="color: #34d399;">Aƒüa√ß E≈üdeƒüeri</div></div>
             </div>
         </div>

        <div class="border-t-2 border-slate-100 pt-4 mt-auto">
            <p class="text-[10px] text-slate-400 text-center font-medium leading-relaxed">Hesaplamalar ISO 12241 m√ºhendislik standartlarƒ±na g√∂re sim√ºle edilmi≈ütir. Garanti niteliƒüi ta≈üƒ±maz.</p>
        </div>
    </div>

    <div id="p-methodology" class="print-page p-12 flex flex-col">
        <h2 class="text-2xl font-black text-slate-900 uppercase mb-5 border-b-2 border-slate-900 pb-3" id="methTitle">Hesaplama Metotlarƒ± ve Farkƒ±ndalƒ±k</h2>
        
        <div class="mb-4">
            <h3 class="text-xs font-bold text-slate-700 uppercase mb-2 flex items-center gap-2 tracking-wider">
                <span class="meth-calc-title">Hesaplama Temelleri</span>
            </h3>
            <p class="text-[10px] text-slate-600 leading-relaxed mb-2" id="methCalcP1">
                Bu raporda sunulan t√ºm ƒ±sƒ± kaybƒ± hesaplamalarƒ±, uluslararasƒ± kabul g√∂rm√º≈ü <strong>ISO 12241 ‚Äì Termal Yalƒ±tƒ±m Hesaplama Standartlarƒ±</strong> temelinde ger√ßekle≈ütirilmi≈ütir. ISO 12241, silindirik (boru) ve d√ºz y√ºzeylerden meydana gelen ƒ±sƒ± transferini; iletim (kond√ºksiyon), ta≈üƒ±nƒ±m (konveksiyon) ve ƒ±≈üƒ±nƒ±m (radyasyon) mekanizmalarƒ±nƒ± dikkate alarak modellemektedir.
            </p>
            <p class="text-[10px] text-slate-600 leading-relaxed mb-2" id="methCalcP2">
                Hesaplamalar iteratif bir y√∂ntemle y√ºr√ºt√ºl√ºr: izolasyon malzemesinin termal iletkenlik katsayƒ±sƒ± (Œª), ortalama sƒ±caklƒ±ƒüa baƒülƒ± olarak dinamik bi√ßimde hesaplanƒ±r. Dƒ±≈ü y√ºzey ƒ±sƒ± transfer katsayƒ±sƒ± (h<sub>s</sub>), doƒüal ve zorlanmƒ±≈ü konveksiyon ile radyasyon bile≈üenlerinin toplamƒ± olarak bulunur.
            </p>
            <p class="text-[10px] text-slate-500 leading-relaxed mb-3 italic" id="methRadiatorNote">
                Tƒ±pkƒ± evlerimizde radyat√∂r panellerinin bir odayƒ± nasƒ±l ƒ±sƒ±ttƒ±ƒüƒ±nƒ± d√º≈ü√ºn√ºn: Yalƒ±tƒ±msƒ±z her sƒ±cak boru, vana veya tank y√ºzeyi ‚Äì aslƒ±nda birer "a√ßƒ±k radyat√∂r" gibi √ßalƒ±≈üarak √ßevresindeki havayƒ± s√ºrekli olarak ƒ±sƒ±tmaktadƒ±r. Bu, tesisinizde fark edilmeden devam eden ve doƒürudan yakƒ±t t√ºketiminize yansƒ±yan ger√ßek bir enerji kaybƒ±dƒ±r.
            </p>
        </div>

        <div class="grid grid-cols-3 gap-2 mb-3">
            <div class="rounded border border-slate-300 p-3">
                <div class="text-[9px] font-bold text-slate-700 uppercase mb-1.5 tracking-wider" id="methFormula1Title">Kond√ºksiyon (ƒ∞letim)</div>
                <div class="text-center text-[11px] font-mono text-slate-800 leading-relaxed mb-1.5 bg-slate-50 rounded p-2 border border-slate-200">
                    Q = 2œÄŒªL(T‚ÇÅ‚àíT‚ÇÇ) / ln(r‚ÇÇ/r‚ÇÅ)
                </div>
                <div class="text-[8px] text-slate-500 leading-relaxed" id="methFormula1Desc">Silindirik y√ºzeylerde iletimle ƒ±sƒ± transferi. Œª = iletkenlik katsayƒ±sƒ± (W/mK), r = yarƒ±√ßap deƒüerleri</div>
            </div>
            <div class="rounded border border-slate-300 p-3">
                <div class="text-[9px] font-bold text-slate-700 uppercase mb-1.5 tracking-wider" id="methFormula2Title">Konveksiyon (Ta≈üƒ±nƒ±m)</div>
                <div class="text-center text-[11px] font-mono text-slate-800 leading-relaxed mb-1.5 bg-slate-50 rounded p-2 border border-slate-200">
                    Q<sub>cv</sub> = h<sub>c</sub> √ó A √ó (T<sub>s</sub> ‚àí T<sub>‚àû</sub>)
                </div>
                <div class="text-[8px] text-slate-500 leading-relaxed" id="methFormula2Desc">Y√ºzeyden havaya ta≈üƒ±nƒ±m kayƒ±plarƒ±. h<sub>c</sub> = konveksiyon katsayƒ±sƒ±, A = y√ºzey alanƒ±</div>
            </div>
            <div class="rounded border border-slate-300 p-3">
                <div class="text-[9px] font-bold text-slate-700 uppercase mb-1.5 tracking-wider" id="methFormula3Title">I≈üƒ±nƒ±m (Radyasyon)</div>
                <div class="text-center text-[11px] font-mono text-slate-800 leading-relaxed mb-1.5 bg-slate-50 rounded p-2 border border-slate-200">
                    Q<sub>r</sub> = ŒµœÉA(T<sub>s</sub>‚Å¥ ‚àí T<sub>‚àû</sub>‚Å¥)
                </div>
                <div class="text-[8px] text-slate-500 leading-relaxed" id="methFormula3Desc">Stefan-Boltzmann ƒ±≈üƒ±nƒ±m kaybƒ±. Œµ = emisivite, œÉ = 5.67√ó10‚Åª‚Å∏ W/m¬≤K‚Å¥</div>
            </div>
        </div>

        <div class="rounded border border-slate-300 p-3 mb-4">
            <div class="text-[9px] font-bold text-slate-700 uppercase mb-1 tracking-wider" id="methFormulaTitle">kWh Kayƒ±p & Maliyet Hesabƒ±</div>
            <div class="text-center text-[11px] font-mono text-slate-800 leading-relaxed bg-slate-50 rounded p-2 border border-slate-200 mb-1.5">
                Kayƒ±p (kWh) = Q<sub>toplam</sub> √ó √áalƒ±≈üma Saati / 1000 &nbsp;‚Üí&nbsp; Maliyet = (Kayƒ±p √ó 860) / (LHV √ó Œ∑) √ó Birim Fiyat
            </div>
            <div class="text-[8px] text-slate-500 text-center" id="methFormulaDesc">Q<sub>toplam</sub> = konveksiyon + ƒ±≈üƒ±nƒ±m (W), LHV = yakƒ±t alt ƒ±sƒ±l deƒüeri, Œ∑ = kazan verimi</div>
        </div>

        <div class="mb-4">
            <h3 class="text-xs font-bold text-slate-700 uppercase mb-2 flex items-center gap-2 tracking-wider">
                <span class="meth-tesla-title">Enerji Farkƒ±ndalƒ±ƒüƒ± ‚Äì Tesla √ñrneƒüi</span>
            </h3>
            <div class="bg-slate-900 rounded-lg p-4 text-white mb-3 relative overflow-hidden">
                <div class="absolute right-4 top-4 opacity-10"><i data-lucide="car" class="w-20 h-20"></i></div>
                <div class="relative z-10">
                    <div class="text-[9px] text-slate-400 font-bold uppercase tracking-wider mb-1" id="methTeslaSubtitle">En Y√ºksek Kayƒ±plƒ± Kaleminiz</div>
                    <div class="text-base font-bold mb-1" id="methTeslaItem">-</div>
                    <div class="grid grid-cols-3 gap-3 mt-2">
                        <div>
                            <div class="text-[9px] text-slate-400" id="methTeslaKwhLabel">Yƒ±llƒ±k Enerji Kaybƒ±</div>
                            <div class="text-lg font-black text-slate-200" id="methTeslaKwh">0 kWh</div>
                        </div>
                        <div>
                            <div class="text-[9px] text-slate-400" id="methTeslaChargeLabel">Tesla ≈ûarj Sayƒ±sƒ±</div>
                            <div class="text-lg font-black text-slate-200" id="methTeslaCharges">0</div>
                        </div>
                        <div>
                            <div class="text-[9px] text-slate-400" id="methTeslaKmLabel">Toplam Mesafe</div>
                            <div class="text-lg font-black text-slate-200" id="methTeslaKm">0 km</div>
                        </div>
                    </div>
                    <div class="text-[8px] text-slate-500 mt-2 leading-relaxed" id="methTeslaNote">
                        * Tesla Model 3 batarya kapasitesi ‚âà 60 kWh, ortalama menzil ‚âà 490 km baz alƒ±nmƒ±≈ütƒ±r. Termal enerji %40 termodinamik verimle elektrik enerjisine d√∂n√º≈üt√ºr√ºlm√º≈üt√ºr. (Kaynak: EiiF ‚Äì TIPCHECK Programƒ±)
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-3">
            <h3 class="text-xs font-bold text-slate-700 uppercase mb-2 flex items-center gap-2 tracking-wider">
                <span class="meth-awareness-title">ƒ∞zolasyonun √ñnemi</span>
            </h3>
            <div class="grid grid-cols-2 gap-2">
                <div class="rounded border border-slate-300 p-2.5">
                    <div class="text-[10px] font-bold text-slate-700 mb-1" id="methAware1Title">üî• Enerji ƒ∞srafƒ±</div>
                    <p class="text-[9px] text-slate-600 leading-relaxed" id="methAware1Desc">End√ºstriyel tesislerde yalƒ±tƒ±msƒ±z ekipmanlar, toplam enerji t√ºketiminin %5-10'una varan kayƒ±plara neden olabilir. Bu kayƒ±plar doƒürudan i≈ületme maliyetlerini artƒ±rƒ±r.</p>
                </div>
                <div class="rounded border border-slate-300 p-2.5">
                    <div class="text-[10px] font-bold text-slate-700 mb-1" id="methAware2Title">üåø √áevresel Etki</div>
                    <p class="text-[9px] text-slate-600 leading-relaxed" id="methAware2Desc">Her 1.000 kWh ƒ±sƒ± enerjisi tasarrufu, yakla≈üƒ±k 200-250 kg CO‚ÇÇ emisyon azaltƒ±mƒ±na e≈üdeƒüerdir. ƒ∞zolasyon yatƒ±rƒ±mlarƒ±, karbon ayak izini azaltmanƒ±n en maliyet etkin yollarƒ±ndan biridir.</p>
                </div>
                <div class="rounded border border-slate-300 p-2.5">
                    <div class="text-[10px] font-bold text-slate-700 mb-1" id="methAware3Title">üë∑ ƒ∞SG ve G√ºvenlik</div>
                    <p class="text-[9px] text-slate-600 leading-relaxed" id="methAware3Desc">60¬∞C √ºzerindeki y√ºzeyler ciddi yanƒ±k riski ta≈üƒ±r. Uygun izolasyon, y√ºzey sƒ±caklƒ±klarƒ±nƒ± g√ºvenli seviyelere d√º≈ü√ºrerek i≈ü g√ºvenliƒüi standartlarƒ±na uyumu saƒülar.</p>
                </div>
                <div class="rounded border border-slate-300 p-2.5">
                    <div class="text-[10px] font-bold text-slate-700 mb-1" id="methAware4Title">üí∞ Hƒ±zlƒ± Geri D√∂n√º≈ü</div>
                    <p class="text-[9px] text-slate-600 leading-relaxed" id="methAware4Desc">End√ºstriyel izolasyon yatƒ±rƒ±mlarƒ±nƒ±n geri d√∂n√º≈ü s√ºresi tipik olarak 6-18 ay arasƒ±ndadƒ±r. Bu, sanayideki en kƒ±sa amortisman s√ºresine sahip enerji verimliliƒüi √∂nlemlerinden biridir.</p>
                </div>
            </div>
        </div>

        <div class="border-t border-slate-300 pt-2 mt-auto">
            <p class="text-[9px] text-slate-400 text-center font-medium leading-relaxed" id="methFooter">Bu sayfa ≈üeffaflƒ±k ve profesyonellik ilkesi gereƒüi hesaplama metodolojisi hakkƒ±nda bilgi vermek amacƒ±yla hazƒ±rlanmƒ±≈ütƒ±r.</p>
        </div>
        <div class="page-num mt-1 text-center text-[10px] text-slate-400" id="methPageNum">Sayfa X / Y</div>
    </div>

    <div id="p-logo" class="print-page flex flex-col items-center justify-center relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-br from-slate-50 to-slate-100"></div>
        <div class="absolute top-20 left-20 w-96 h-96 bg-indigo-100 rounded-full blur-3xl opacity-50"></div>
        <div class="absolute bottom-20 right-20 w-80 h-80 bg-emerald-100 rounded-full blur-3xl opacity-50"></div>
        
        <div class="relative z-10 text-center">
            <div class="text-7xl font-black text-slate-900 tracking-tighter mb-3">
                Optimizi<span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 to-orange-500">.App</span>
            </div>
            <div class="text-lg font-bold text-slate-400 uppercase tracking-[8px] mb-8" id="logoSubtitle">Enerji Verimliliƒüi Hesaplama Ara√ßlarƒ±</div>
            <div class="w-24 h-0.5 bg-gradient-to-r from-indigo-500 to-orange-500 mx-auto mb-8 rounded-full"></div>
            <div class="text-sm text-slate-400 font-medium" id="logoTagline">Engineering Solutions</div>
        </div>
        <div class="page-num absolute bottom-8 text-center text-[10px] text-slate-400 w-full" id="logoPageNum">Sayfa X / Y</div>
    </div>
</div>

<script>
    function showCustomAlert(title, msg) {
        document.getElementById('customAlertTitle').innerText = title;
        document.getElementById('customAlertMsg').innerHTML = msg;
        document.getElementById('customAlertPopup').style.display = 'flex';
        document.getElementById('customAlertPopup').classList.remove('hidden');
        lucide.createIcons();
    }
    function closeCustomAlert() { document.getElementById('customAlertPopup').style.display = 'none'; }
    function toggleQrVisibility() { const isChecked = document.getElementById('toggleQrInput').checked; const body = document.body; if (!isChecked) { body.classList.add('hide-qr-section'); } else { body.classList.remove('hide-qr-section'); } }
    function updateTotalInvestment() { const inputVal = parseFloat(document.getElementById('manualTotalInv').value); const currVal = document.getElementById('manualInvCurr').value; if (inputVal && inputVal > 0) { const rateToTL = FX[currVal] || 1; manualTotalInvestment = inputVal * rateToTL; } else { manualTotalInvestment = null; } render(); }
    function toggleL2() { const box = document.getElementById('layer2Box'); if(document.getElementById('useL2').checked) box.classList.remove('hidden'); else box.classList.add('hidden'); }
    function toggleFuelMode() { const fuel = document.getElementById('fuel').value; const box = document.getElementById('manualFuelBox'); if(fuel === 'manual') box.classList.remove('hidden'); else box.classList.add('hidden'); }

    function initApp(){ 
        init();
        const isDark = localStorage.getItem('darkMode') === 'true';
        if (!isDark) { document.documentElement.classList.remove('dark'); }
    }
    
    function toggleDarkMode() {
        const html = document.documentElement;
        const isDark = html.classList.toggle('dark');
        localStorage.setItem('darkMode', isDark);
        setTimeout(() => { lucide.createIcons(); }, 50);
    }
    
    function fmt(n){ return n.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
    
    function setType(t){
        ['valve','pipe','tank'].forEach(x=>{document.getElementById('g-'+x).classList.add('hidden');});
        document.getElementById('g-'+t).classList.remove('hidden');
        document.getElementById('type').value=t;
        const buttons={valve:document.getElementById('btn-valve'),pipe:document.getElementById('btn-pipe'),tank:document.getElementById('btn-tank')};
        const activeClass="bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow";
        const inactiveClass="text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white";
        Object.values(buttons).forEach(btn=>{btn.className="flex-1 py-1.5 text-xs font-medium rounded transition-all "+inactiveClass;});
        buttons[t].className="flex-1 py-1.5 text-xs font-medium rounded transition-all "+activeClass;
        const qtyInput = document.getElementById('qty'); qtyInput.disabled = false; qtyInput.value = 1;
    }

    // Sabitleri sadece UI / Dropdown beslemesi i√ßin burada tutuyoruz, matematik backendde!
    const PIPES={15:21.3,20:26.7,25:33.4,32:42.2,40:48.3,50:60.3,65:73.0,80:88.9,100:114.3,125:141.3,150:168.3,200:219.1,250:273.0,300:323.9,350:355.6,400:406.4,500:508.0};
    const SEPARATORS = {15:0.15, 20:0.18, 25:0.22, 32:0.28, 40:0.35, 50:0.45, 65:0.60, 80:0.75, 100:1.10, 125:1.45, 150:1.90, 200:2.80};
    const MATS={rockwool:{a:0.035,b:0.00017,c:0},glasswool:{a:0.025,b:0.00015,c:0},ceramic:{a:0.025,b:0.00012,c:1.2e-7},aerogel:{a:0.019,b:0.00004,c:5e-8},rubber:{a:0.034,b:0.000075,c:0},bare:{a:25,b:0,c:0}};
    const VALVE_FACTORS={gate:1.2,globe:1.4,butterfly:0.6,ball:1.0,strainer:1.5,check:0.9,trap_float: 1.6, trap_thermo: 0.8, trap_bimetal: 1.0, trap_bucket: 1.5,flange: 0.35};
    const FUEL_PARAMS = {gas: { lhv: 8250, co2: 0.202 }, elec: { lhv: 860, co2: 0.478 }, lng: { lhv: 11500, co2: 0.22 }, fueloil: { lhv: 9600, co2: 0.27 }, coal_imp: { lhv: 6000, co2: 0.34 }, coal_loc: { lhv: 3500, co2: 0.38 }};
    
    let LIST=[], PACKAGE_BASKET=[], isPackageMode=false;
    let FX={USD:34.50,EUR:36.50,TL:1.0},currImg=null,userQrImg=null,currPkgImg=null,editingIndex=null;
    let manualTotalInvestment = null; 
    let currentSurfaces = []; 

    function addSurface(type){
        if (type === 'rect') {
            const w = parseFloat(document.getElementById('surfW').value);
            const h = parseFloat(document.getElementById('surfH').value);
            if(!w || !h){ showCustomAlert("Eksik Veri","L√ºtfen En ve Boy deƒüerlerini giriniz."); return; }
            currentSurfaces.push({type: 'rect', w: w, h: h});
            document.getElementById('surfW').value = ''; document.getElementById('surfH').value = '';
        } else if (type === 'circle') {
            const d = parseFloat(document.getElementById('surfD').value);
            if(!d){ showCustomAlert("Eksik Veri","L√ºtfen √áap deƒüerini giriniz."); return; }
            currentSurfaces.push({type: 'circle', d: d});
            document.getElementById('surfD').value = '';
        }
        renderSurfaces();
    }
    
    function removeSurface(idx){ currentSurfaces.splice(idx,1); renderSurfaces(); }
    
    function renderSurfaces(){
        const listEl = document.getElementById('surfaceList');
        const totalEl = document.getElementById('totalSurfArea');
        listEl.innerHTML = '';
        let totalAreaM2 = 0;
        
        currentSurfaces.forEach((s, idx) => {
            let m2 = 0; let label = "";
            if(s.type === 'circle') { m2 = Math.PI * Math.pow((s.d / 2000), 2); label = `√ò ${s.d} mm Daire`; } 
            else { const w = s.w; const h = s.h; m2 = (w * h) / 1000000; label = `${w} x ${h} mm`; }
            totalAreaM2 += m2;
            const div = document.createElement('div');
            div.className = "flex justify-between items-center bg-white dark:bg-slate-800/50 p-1.5 rounded border border-slate-200 dark:border-slate-700";
            div.innerHTML = `<span>${label}</span> <button onclick="removeSurface(${idx})" class="text-red-500 hover:text-red-700"><i data-lucide="x" class="w-3 h-3"></i></button>`;
            listEl.appendChild(div);
        });
        totalEl.innerText = totalAreaM2.toFixed(3);
        lucide.createIcons();
    }

    function togglePackageMode(){
        isPackageMode = !isPackageMode;
        const panel = document.getElementById('packagePanel');
        const btnToggle = document.getElementById('btnTogglePkg');
        const btnAdd = document.getElementById('btnAddText');
        const invBox = document.getElementById('singleInvBox');
        const invInput = document.getElementById('inv');
        const invCurr = document.getElementById('invCurr');
        const locationInput = document.getElementById('location');
        const thermalArea = document.querySelector('[onclick="document.getElementById(\'imgInp\').click()"]');

        if(isPackageMode){
            panel.classList.remove('hidden');
            btnToggle.classList.replace('bg-slate-200', 'bg-indigo-600');
            btnToggle.classList.replace('dark:bg-slate-700', 'dark:bg-red-600');
            btnToggle.classList.replace('text-slate-600', 'text-white');
            btnToggle.classList.replace('dark:text-slate-300', 'dark:text-white');
            btnToggle.innerHTML = `<i data-lucide="box" class="w-3 h-3"></i> Paket Modunu Kapat`;
            btnAdd.innerText = "Sepete Ekle";
            invInput.disabled = true; invCurr.disabled = true; invBox.classList.add('opacity-30');
            locationInput.disabled = true; locationInput.classList.add('opacity-30', 'cursor-not-allowed');
            if(thermalArea) { thermalArea.classList.add('opacity-30', 'pointer-events-none'); }
        } else {
            panel.classList.add('hidden');
            btnToggle.classList.replace('bg-indigo-600', 'bg-slate-200');
            btnToggle.classList.replace('dark:bg-red-600', 'dark:bg-slate-700');
            btnToggle.classList.replace('text-white', 'text-slate-600');
            btnToggle.classList.replace('dark:text-white', 'dark:text-slate-300');
            btnToggle.innerHTML = `<i data-lucide="box" class="w-3 h-3"></i> Paket Modunu A√ß`;
            btnAdd.innerText = "Hesapla & Ekle";
            invInput.disabled = false; invCurr.disabled = false; invBox.classList.remove('opacity-30');
            locationInput.disabled = false; locationInput.classList.remove('opacity-30', 'cursor-not-allowed');
            if(thermalArea) { thermalArea.classList.remove('opacity-30', 'pointer-events-none'); }
        }
        lucide.createIcons();
    }

    // ==========================================
    // API ENTEGRASYONU (ASENKRON FONKSƒ∞YONLAR)
    // ==========================================
    
    async function addToPackageBasket(){
        const res = await getCalculationResult(true); 
        if(res) {
            PACKAGE_BASKET.push(res);
            renderPackageBasket();
            resetForm();
        }
    }

    function renderPackageBasket(){
        const ul = document.getElementById('pkgList');
        ul.innerHTML = ''; let totalSave = 0; let totalQty = 0;
        const currSymVal=document.getElementById('curr')?document.getElementById('curr').value:'TL';
        const reportRate = FX[currSymVal] || 1; 

        PACKAGE_BASKET.forEach((item, idx) => {
            const li = document.createElement('li');
            li.className = "flex justify-between items-center border-b border-slate-100 pb-1 last:border-0";
            li.innerHTML = `<span>${item.qty} ${item.unit} ${item.name}</span> <button onclick="removeFromBasket(${idx})" class="text-red-400 hover:text-red-600"><i data-lucide="x" class="w-3 h-3"></i></button>`;
            ul.appendChild(li);
            totalSave += item.saveTL; totalQty++;
        });

        if(PACKAGE_BASKET.length === 0) ul.innerHTML = '<li class="text-slate-400 text-center italic py-2">Hen√ºz sepete √ºr√ºn eklenmedi.</li>';
        document.getElementById('pkgTotalQty').innerText = totalQty + " Kalem";
        document.getElementById('pkgTotalSave').innerText = fmt(totalSave / reportRate) + " " + currSymVal;
        lucide.createIcons();
    }

    function removeFromBasket(idx){ PACKAGE_BASKET.splice(idx,1); renderPackageBasket(); }
    function readPkgImg(i){if(i.files&&i.files[0]){const r=new FileReader();r.onload=e=>{currPkgImg=e.target.result;document.getElementById('pkgPrevImg').src=currPkgImg;document.getElementById('pkgPrevImg').classList.remove('hidden');};r.readAsDataURL(i.files[0]);}}

    function buildPackageItem(basket, pkgName, pkgQty, pkgInvRaw, pkgInvCurr) {
        const pkgInvRate = FX[pkgInvCurr] || 1;
        const pkgUnitInvTL = pkgInvRaw * pkgInvRate; 
        const pkgTotalInvTL = pkgUnitInvTL * pkgQty; 
        let totalSaveTL = 0, totalLossTL = 0, totalLossBareTL = 0, totalFuelSaved = 0, totalFuelLost = 0, totalCo2 = 0;
        let totalKwhBare = 0, totalKwhIns = 0, totalKwhSave = 0, itemsDesc = [];
        let fuelUnit = basket.length > 0 ? basket[0].fuelUnit : ""; 
        let maxTemp = -9999, displayTs = "-", displayTins = "-";

        basket.forEach(item => {
            totalSaveTL += item.saveTL; totalLossTL += item.lossTL; totalLossBareTL += item.lossBareTL;
            totalFuelSaved += item.fuelSaved; totalFuelLost += item.fuelLost; totalCo2 += item.co2;
            totalKwhBare += parseFloat(item.kwhBare.replace(/\./g,'').replace(',','.'));
            totalKwhIns += parseFloat(item.kwhIns.replace(/\./g,'').replace(',','.'));
            totalKwhSave += parseFloat(item.kwhSave.replace(/\./g,'').replace(',','.'));
            itemsDesc.push(`${item.qty}x ${item.name}`);
            let tVal = parseFloat(item.Ts);
            if(!isNaN(tVal) && tVal > maxTemp){ maxTemp = tVal; displayTs = item.Ts; displayTins = item.Tins; }
        });

        totalSaveTL *= pkgQty; totalLossTL *= pkgQty; totalLossBareTL *= pkgQty;
        totalFuelSaved *= pkgQty; totalFuelLost *= pkgQty; totalCo2 *= pkgQty;
        totalKwhBare *= pkgQty; totalKwhIns *= pkgQty; totalKwhSave *= pkgQty;

        let roiCalc = 0; if(totalSaveTL > 0.01) { roiCalc = (pkgTotalInvTL / totalSaveTL * 12); }

        return {
            name: `üì¶ PAKET: ${pkgName}`, desc: `(${pkgQty} SET) - ${basket.length} Kalem ƒ∞√ßerir: ` + itemsDesc.join(', '), 
            location: basket.length > 0 ? (basket[0].location || "Muhtelif") : "Muhtelif", qty: pkgQty, unit: "Set",
            invTL: pkgTotalInvTL, saveTL: totalSaveTL, lossTL: totalLossTL, lossBareTL: totalLossBareTL,
            fuelSaved: totalFuelSaved, fuelLost: totalFuelLost, fuelUnit: fuelUnit,
            kwhBare: Math.round(totalKwhBare).toLocaleString('tr-TR'), kwhIns: Math.round(totalKwhIns).toLocaleString('tr-TR'), kwhSave: Math.round(totalKwhSave).toLocaleString('tr-TR'),
            co2: totalCo2, Ts: displayTs, Tins: displayTins, img: currPkgImg, roi: roiCalc,
            inputs: { type: 'package', matKey: 'mixed', inv: pkgInvRaw, invCurr: pkgInvCurr, isLumpSum: true, subItems: JSON.parse(JSON.stringify(basket)), vWind: 0 }
        };
    }

    function commitPackage(){
        if(PACKAGE_BASKET.length === 0) { showCustomAlert("Sepet Bo≈ü","Paketi olu≈üturmak i√ßin sepete en az bir √ºr√ºn ekleyin."); return; }
        const pkgName = document.getElementById('pkgName').value || "ƒ∞simsiz Paket";
        const pkgQty = parseFloat(document.getElementById('pkgQty').value) || 1;
        const pkgInvRaw = parseFloat(document.getElementById('pkgInv').value) || 0;
        const pkgInvCurr = document.getElementById('pkgInvCurr').value;

        const compositeItem = buildPackageItem(PACKAGE_BASKET, pkgName, pkgQty, pkgInvRaw, pkgInvCurr);
        LIST.push(compositeItem);
        PACKAGE_BASKET = [];
        document.getElementById('pkgName').value = ''; document.getElementById('pkgInv').value = ''; document.getElementById('pkgQty').value = '1';
        currPkgImg = null; document.getElementById('pkgPrevImg').src = ''; document.getElementById('pkgPrevImg').classList.add('hidden');
        renderPackageBasket(); render(); 
        showSavePopup("Paket Olu≈üturuldu", `<strong>"${pkgName}"</strong> paketi ba≈üarƒ±yla olu≈üturuldu ve listeye eklendi!`);
    }

    // KURYE FONKSƒ∞YON (Matematiƒüi Vercel'e yollar, sonucu alƒ±r)
    async function getCalculationResult(ignoreInvestment = false) {
        const qty = parseFloat(document.getElementById('qty').value) || 1;
        const type = document.getElementById('type').value;
        const location = document.getElementById('location').value || "";
        const tProc = parseFloat(document.getElementById('tProc').value) || 0;
        const tAmb = parseFloat(document.getElementById('tAmb').value) || 25;
        const vWindInput = document.getElementById('vWind').value;
        const vWind = (vWindInput === "") ? 0 : parseFloat(vWindInput);
        const matKey = document.getElementById('matSelect').value;
        const thk = parseFloat(document.getElementById('thk').value) || 0;
        const useL2 = document.getElementById('useL2').checked;
        const matKey2 = useL2 ? document.getElementById('matSelect2').value : null;
        const thk2 = useL2 ? (parseFloat(document.getElementById('thk2').value) || 0) : 0;
        const standard = document.getElementById('calcStd').value;
        const pLen = parseFloat(document.getElementById('pLen').value) || 1;
        
        let invRaw = 0; let invCurrencyCode = 'TL'; let invRate = 1;
        if(!ignoreInvestment) {
            invRaw = parseFloat(document.getElementById('inv').value) || 0;
            invCurrencyCode = document.getElementById('invCurr').value; 
            invRate = FX[invCurrencyCode] || 1; 
        }

        const eff = (parseFloat(document.getElementById('eff').value) || 85) / 100;
        const priceRaw = parseFloat(document.getElementById('price').value) || 0;
        const energyCurrencyCode = document.getElementById('energyCurr').value;
        const energyRate = FX[energyCurrencyCode] || 1;
        const priceTL = priceRaw * energyRate; 
        const hours = parseFloat(document.getElementById('hours').value) || 8000;

        const vDN = document.getElementById('vDN').value;
        const pDN = document.getElementById('pDN').value;
        const selValve = document.getElementById('valveType');
        const valveType = selValve.value;
        const valveTypeName = selValve.options[selValve.selectedIndex].text;

        const fuelType = document.getElementById('fuel').value;
        let LHV_Val = 8250; let co2Factor = 0.202; let LHV_Unit = "m3";
        if(fuelType === 'manual') {
            LHV_Val = parseFloat(document.getElementById('fuelLhv').value) || 0;
            LHV_Unit = document.getElementById('fuelUnit').value;
            if(LHV_Unit === 'm3') co2Factor = 0.202; else if(LHV_Unit === 'kwh') co2Factor = 0.478; else co2Factor = 0.3; 
        } else {
            if(FUEL_PARAMS[fuelType]) { LHV_Val = FUEL_PARAMS[fuelType].lhv; co2Factor = FUEL_PARAMS[fuelType].co2; LHV_Unit = (fuelType==='gas')?'m3':(fuelType==='elec')?'kwh':'kg'; }
        }

        const savedSurfaces = JSON.parse(JSON.stringify(currentSurfaces));

        const payload = {
            type, qty, tProc, tAmb, vWind, matKey, thk, useL2, matKey2, thk2, 
            standard, pLen, invRaw, invRate, eff, priceTL, hours, 
            currentSurfaces: savedSurfaces, vDN, pDN, valveType, fuelType, 
            LHV_Val, co2Factor, valveTypeName
        };

        const btnEl = document.getElementById('btnAddText');
        const originalText = btnEl ? btnEl.innerText : "Hesapla";
        if(btnEl) btnEl.innerText = "Hesaplanƒ±yor...";

        try {
            const response = await fetch('/api/hesapla', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error("API Hatasƒ±");
            const data = await response.json(); 
            if(btnEl) btnEl.innerText = originalText;

            const matName1 = document.getElementById('matSelect').options[document.getElementById('matSelect').selectedIndex].text;
            let descStr = "";
            if(matKey === 'bare') { descStr = "Yalƒ±tƒ±msƒ±z"; } 
            else {
                descStr = `${thk}mm ${matName1}`;
                if(useL2) { const matName2 = document.getElementById('matSelect2').options[document.getElementById('matSelect2').selectedIndex].text; descStr += ` + ${thk2}mm ${matName2}`; }
            }

            return {
                name: data.Name, desc: descStr, location: location, qty: data.qty, unit: data.unit,
                invTL: data.invTotalTL, saveTL: data.save_money_TL, lossTL: data.annual_loss_TL, lossBareTL: data.loss_money_bare_TL, 
                fuelSaved: data.fuelSavedAmount, fuelLost: data.fuelLostAmount, fuelUnit: LHV_Unit,
                kwhBare: Math.round(data.energyLostBare_kWh).toLocaleString('tr-TR'), kwhIns: Math.round(data.energyLostIns_kWh).toLocaleString('tr-TR'), kwhSave: Math.round(data.energySaved_kWh).toLocaleString('tr-TR'),
                co2: data.co2SavedTotal, Ts: typeof data.realBareTemp === 'number' ? data.realBareTemp.toFixed(1) : data.realBareTemp, Tins: typeof data.realInsTemp === 'number' ? data.realInsTemp.toFixed(1) : data.realInsTemp, 
                qBare: data.Q_bare_unit, qIns: data.Q_unit, img: currImg, roi: data.roiCalc,
                inputs: { type,qty,pLen,location,tProc,tAmb,matKey,thk,useL2, matKey2, thk2,inv:invRaw, standard,vDN, pDN, valveType,surfaces: savedSurfaces,img:currImg, invCurr: invCurrencyCode,energyCurr: energyCurrencyCode,fuelType, fuelLhv: LHV_Val,fuelUnit: LHV_Unit,vWind }
            };
        } catch(error) {
            console.error(error);
            if(btnEl) btnEl.innerText = originalText;
            showCustomAlert("Baƒülantƒ± Hatasƒ±", "Sunucuya baƒülanƒ±lamadƒ±. L√ºtfen internet baƒülantƒ±nƒ±zƒ± kontrol edin.");
            return null;
        }
    }

    function init(){fillDN('vDN');fillDN('pDN');getFx();lucide.createIcons(); setType('valve');}
    function fillDN(id){const el=document.getElementById(id);el.innerHTML='';for(const[k,v]of Object.entries(PIPES)){let o=document.createElement('option');o.value=v;o.text=`DN ${k}`;el.add(o);}if(id==='vDN')el.value=60.3;if(id==='pDN')el.value=88.9;}
    function readImg(i){if(i.files&&i.files[0]){const r=new FileReader();r.onload=e=>{currImg=e.target.result;document.getElementById('prevImg').src=currImg;document.getElementById('prevImg').classList.remove('hidden');};r.readAsDataURL(i.files[0]);}i.value='';}
    function readQr(i){if(i.files&&i.files[0]){const r=new FileReader();r.onload=e=>{userQrImg=e.target.result;const btn=document.getElementById('navQrBtn');btn.classList.remove('border-slate-200','dark:border-slate-700');btn.classList.add('border-green-500','dark:border-green-500','bg-green-50','dark:bg-green-900/20');const lbl=document.getElementById('navQrLabel');if(lbl)lbl.innerText='QR Y√ºklendi ‚úì';};r.readAsDataURL(i.files[0]);}}
    async function getFx(){try{const r=await fetch('https://api.frankfurter.app/latest?from=USD&to=TRY');const d=await r.json();FX.USD=d.rates.TRY;const r2=await fetch('https://api.frankfurter.app/latest?from=EUR&to=TRY');const d2=await r2.json();FX.EUR=d2.rates.TRY;document.getElementById('fxVal').innerText=FX.USD.toFixed(2);}catch(e){}}
    
    async function calc(){
        if(isPackageMode) {
            await addToPackageBasket();
        } else {
            const result = await getCalculationResult();
            if(result) {
                LIST.push(result);
                resetForm();
                render();
            }
        }
    }

    async function finishUpdate(){
        if(editingIndex!==null) {
            const res = await getCalculationResult();
            if(res) LIST[editingIndex] = res;
        }
        editingIndex=null;
        document.getElementById('btnAdd').classList.remove('hidden');
        document.getElementById('btnUpdate').classList.add('hidden');
        resetForm();
        render();
    }
    
    function edit(i){
        editingIndex=i;
        const d=LIST[i].inputs;
        if(d.type === 'package') {
            if(!isPackageMode) togglePackageMode();
            PACKAGE_BASKET = d.subItems ? JSON.parse(JSON.stringify(d.subItems)) : [];
            document.getElementById('pkgName').value = LIST[i].name.replace("üì¶ PAKET: ", "");
            document.getElementById('pkgQty').value = LIST[i].qty || 1;
            document.getElementById('pkgInv').value = d.inv || 0;
            document.getElementById('pkgInvCurr').value = d.invCurr || "TL";
            if(LIST[i].img) { currPkgImg = LIST[i].img; document.getElementById('pkgPrevImg').src = currPkgImg; document.getElementById('pkgPrevImg').classList.remove('hidden'); }
            renderPackageBasket();
            LIST.splice(i, 1);
            editingIndex = null;
            render();
            return;
        }
        if(isPackageMode) togglePackageMode();
        setType(d.type);
        document.getElementById('tProc').value = d.tProc;
        document.getElementById('matSelect').value = d.matKey;
        document.getElementById('thk').value = d.thk;
        document.getElementById('inv').value = d.inv;
        document.getElementById('qty').value = d.qty;
        document.getElementById('calcStd').value = d.standard;
        document.getElementById('location').value = d.location || ""; 
        document.getElementById('useL2').checked = d.useL2 || false;
        document.getElementById('vWind').value = (d.vWind !== undefined && d.vWind !== null) ? d.vWind : 1; 
        toggleL2();
        if(d.useL2) { document.getElementById('matSelect2').value = d.matKey2; document.getElementById('thk2').value = d.thk2; }
        if(d.invCurr) document.getElementById('invCurr').value = d.invCurr;
        if(d.energyCurr) document.getElementById('energyCurr').value = d.energyCurr;
        document.getElementById('fuel').value = d.fuelType || 'gas';
        toggleFuelMode();
        if(d.fuelType === 'manual') { document.getElementById('fuelLhv').value = d.fuelLhv; document.getElementById('fuelUnit').value = d.fuelUnit; }
        if(d.img){ currImg=d.img; document.getElementById('prevImg').src=currImg; document.getElementById('prevImg').classList.remove('hidden'); }
        if(d.type === 'valve'){ document.getElementById('valveType').value = d.valveType || 'gate'; document.getElementById('vDN').value = d.vDN; } 
        else if (d.type === 'pipe'){ document.getElementById('pDN').value = d.pDN; document.getElementById('pLen').value = d.pLen || 1; } 
        else if (d.type === 'tank'){ currentSurfaces = d.surfaces || []; renderSurfaces(); }
        document.getElementById('btnAdd').classList.add('hidden');
        document.getElementById('btnUpdate').classList.remove('hidden');
    }
    
    function resetForm(){ currImg=null; document.getElementById('prevImg').classList.add('hidden'); document.getElementById('inv').value=''; document.getElementById('location').value=''; document.getElementById('vWind').value = 0; currentSurfaces = []; renderSurfaces(); } 
    
    function render(){
        const tb=document.getElementById('gridBody');tb.innerHTML='';let gInv=0,gSave=0,gCo2=0;
        const currSymVal=document.getElementById('curr')?document.getElementById('curr').value:'TL';
        const reportRate = FX[currSymVal] || 1; 
        const currSymMap={'USD':'$','EUR':'‚Ç¨','TL':'‚Ç∫'};
        const currSym=currSymMap[currSymVal]||'';

        LIST.forEach((i,x)=>{
            const invDisp = i.invTL / reportRate;
            const saveDisp = i.saveTL / reportRate;
            if(i.inputs.matKey!=='bare'){gInv+=invDisp;gSave+=saveDisp;gCo2+=i.co2;}
            const roiSuffix="Ay"; const roi=i.roi > 0 ? i.roi.toFixed(1)+" "+roiSuffix : "-";
            const imgTag=i.img?`<img src="${i.img}" class="w-10 h-10 object-cover rounded">`:`<div class="w-10 h-10 bg-slate-200 rounded flex items-center justify-center text-xs text-slate-500 dark:text-slate-400">${i.inputs.type==='package'?'PKG':'-'}</div>`;
            const locTag = i.location ? `<div class="text-[9px] text-indigo-500 dark:text-red-500 font-bold mt-1 uppercase"><i data-lucide="map-pin" class="w-3 h-3 inline"></i> ${i.location}</div>` : '';
            const rowClass = i.inputs.type === 'package' ? "bg-indigo-50/50 dark:bg-red-900/10 border-l-4 border-l-indigo-500 dark:border-l-red-500" : "";
            const qtyInput = `<input type="number" class="grid-input font-bold text-slate-800 dark:text-slate-100" value="${i.qty}" onchange="quickUpdate(${x}, 'qty', this.value)">`;

            tb.insertAdjacentHTML('beforeend',`<tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition border-b border-slate-200 dark:border-slate-700 ${x===editingIndex?'bg-indigo-50 dark:bg-red-900/20':''} ${rowClass}">
            <td class="px-6 py-4">${imgTag}</td><td class="px-6 py-4 font-bold text-slate-800 dark:text-slate-100">${i.name} ${locTag}</td><td class="px-6 py-4 text-slate-500 dark:text-slate-400 text-xs">${i.desc}</td><td class="px-6 py-4 text-center">${qtyInput} <span class="text-[9px] text-slate-400 block">${i.unit}</span></td><td class="px-6 py-4 text-center"><div class="font-bold text-slate-700 dark:text-slate-200">${i.Ts}</div><div class="text-[10px] font-bold text-red-500">${i.kwhBare} kWh</div></td><td class="px-6 py-4 text-center"><div class="font-bold text-slate-700 dark:text-slate-200">${i.Tins}</div><div class="text-[10px] font-bold text-orange-500">${i.kwhIns} kWh</div></td><td class="px-6 py-4 text-center"><div class="font-bold text-green-600">+${i.kwhSave} kWh</div></td><td class="px-6 py-4 text-right text-green-600 font-bold">${i.inputs.matKey!=='bare'?'+'+currSym+fmt(saveDisp):'-'}</td><td class="px-6 py-4 text-right"><div class="flex items-center justify-end gap-1"><button onclick="edit(${x})" class="p-1.5 rounded-lg bg-indigo-50 dark:bg-indigo-900/30 hover:bg-indigo-100 dark:hover:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400 transition" title="D√ºzenle"><i data-lucide="pencil" class="w-3.5 h-3.5"></i></button><button onclick="del(${x})" class="p-1.5 rounded-lg bg-red-50 dark:bg-red-900/30 hover:bg-red-100 dark:hover:bg-red-900/50 text-red-600 dark:text-red-400 transition" title="Sil"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button></div></td></tr>`);
        });
        if(LIST.length===0)tb.innerHTML=`<tr><td colspan="9" class="px-6 py-20 text-center text-slate-500 dark:text-slate-400"><i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 opacity-20"></i><span id="emptyMsg">Hen√ºz hesaplama eklenmedi.</span></td></tr>`;
        
        const finalInv = (manualTotalInvestment !== null && manualTotalInvestment > 0) ? (manualTotalInvestment / reportRate) : gInv;
        document.getElementById('dashInv').innerText=currSym+fmt(finalInv);
        document.getElementById('dashSave').innerText=currSym+fmt(gSave);
        document.getElementById('dashCo2').innerHTML=gCo2.toFixed(1)+' Ton';
        const totalRoi=gSave>0?(finalInv/gSave*12):0;
        document.getElementById('dashRoi').innerHTML=totalRoi>0?totalRoi.toFixed(1)+` <span class="text-lg text-slate-500 dark:text-slate-400 font-normal">Ay</span>`:'---';
        document.getElementById('barRoi').style.width=totalRoi>0?Math.min((totalRoi/24)*100,100)+'%':'0%';
        lucide.createIcons();
    }

    async function quickUpdate(i, field, val) {
        if(LIST[i].inputs.type === 'package' && field === 'qty') {
             if(confirm("Paketlerin adedini deƒüi≈ütirmek i√ßin paketi silip yeniden olu≈üturmalƒ±sƒ±nƒ±z.")) { render(); return; }
        }
        const oldInputs = LIST[i].inputs;
        if(oldInputs.type === 'package') return;

        setType(oldInputs.type);
        document.getElementById('tProc').value = oldInputs.tProc;
        document.getElementById('tAmb').value = oldInputs.tAmb;
        document.getElementById('matSelect').value = oldInputs.matKey;
        document.getElementById('thk').value = oldInputs.thk;
        document.getElementById('calcStd').value = oldInputs.standard;
        document.getElementById('location').value = oldInputs.location || "";
        document.getElementById('vWind').value = oldInputs.vWind || 0; 
        
        if(oldInputs.type==='pipe') { document.getElementById('pDN').value = oldInputs.pDN; document.getElementById('pLen').value = oldInputs.pLen; } 
        else if(oldInputs.type==='valve'){ document.getElementById('vDN').value = oldInputs.vDN; document.getElementById('valveType').value = oldInputs.valveType; }
        
        if(field === 'qty') document.getElementById('qty').value = val;
        else document.getElementById('qty').value = oldInputs.qty; 
        
        if(field === 'inv') { document.getElementById('inv').value = val; document.getElementById('invCurr').value = document.getElementById('curr').value; } 
        else { document.getElementById('inv').value = oldInputs.inv; document.getElementById('invCurr').value = oldInputs.invCurr; }
        
        const savedImg = LIST[i].img;
        const res = await getCalculationResult(false);
        if(res) { LIST[i] = res; LIST[i].img = savedImg; LIST[i].inputs.img = savedImg; }
        resetForm(); render();
    }

    // ===== I18N STRINGS VE Dƒ∞ƒûER YARDIMCI METOTLAR =====
    const I18N = {
        tr: {
            detailedAnalysis: "Detaylƒ± Analiz D√∂k√ºm√º", executiveSummary: "Y√∂netici √ñzeti", currentAnnualLoss: "Mevcut Yƒ±llƒ±k Kayƒ±p", totalInvestment: "Toplam Yatƒ±rƒ±m Bedeli", materialAndLabor: "Malzeme ve ƒ∞≈ü√ßilik Dahil", annualNetGain: "Yƒ±llƒ±k Net Kazan√ß", afterEnergySaving: "Enerji Tasarrufu Sonrasƒ±", roiPeriod: "Geri D√∂n√º≈ü S√ºresi (ROI)", depreciation: "Amortisman", financialProjection: "Finansal Projeksiyon (5 Yƒ±l)", scenario: "Senaryo", year: "Yƒ±l", total: "TOPLAM", currentStatus: "Mevcut Durum (K√ºm√ºlatif Kayƒ±p)", afterInvestment: "Yatƒ±rƒ±m Sonrasƒ± (K√ºm√ºlatif Kazan√ß)", carbonFootprint: "KARBON AYAK ƒ∞Zƒ∞ AZALTIMI", treeEquivalent: "Aƒüa√ß E≈üdeƒüeri", isoDisclaimer: "Hesaplamalar ISO 12241 m√ºhendislik standartlarƒ±na g√∂re sim√ºle edilmi≈ütir. Garanti niteliƒüi ta≈üƒ±maz.", page: "Sayfa", month: "AY", daily: "G√úNL√úK", weekly: "HAFTALIK", monthly: "AYLIK", yearly: "YILLIK", company: "Firma / M√º≈üteri", supplier: "Tedarik√ßi / Hazƒ±rlayan", reportDate: "Rapor Tarihi", authPerson: "Yetkili Ki≈üi", isoLabel: "ISO 12241 Temelli Isƒ± Kaybƒ± Kaynaklƒ± Kayƒ±p Sim√ºlasyonu", industrialTitle: "END√úSTRƒ∞YEL", insulationTitle: "YALITIM", analysisTitle: "ANALƒ∞Zƒ∞", coverIntro: "tarihinde tesisinizde ger√ßekle≈ütirilen termal denetimler sonucunda; yalƒ±tƒ±msƒ±z ekipmanlardan kaynaklanan ƒ±sƒ± kayƒ±plarƒ±, finansal maliyetler ve karbon ayak izi hesaplanmƒ±≈ütƒ±r. A≈üaƒüƒ±daki veriler mevcut durumun √∂zetidir.", roi: "Amortisman (ROI)", narrative: (tAmb, windBit, eff, hours, price, curr) => `Sim√ºlasyonlar; <strong>${tAmb}¬∞C</strong> ortam sƒ±caklƒ±ƒüƒ±, ${windBit}, <strong>%${eff}</strong> sistem verimi ve yƒ±llƒ±k <strong>${hours} saat</strong> √ßalƒ±≈üma s√ºresi baz alƒ±narak hesaplanmƒ±≈ütƒ±r. Enerji birim maliyeti <strong>${price} ${curr}</strong> olarak kabul edilmi≈ütir.`, qrText: "Mevcut ƒ±sƒ± kayƒ±plarƒ±nƒ±n tesisinize anlƒ±k maliyetini takip etmek i√ßin kodu taratƒ±n.", thBare: "√áƒ±plak", thBareKwh: "(Kayƒ±p kWh)", thInsulated: "ƒ∞zolasyon", thInsKwh: "(Kayƒ±p kWh)", thGain: "Kazan√ß", thGainKwh: "(Fark kWh)", thQty: "Adet", thInvestment: "Yatƒ±rƒ±m", thNetGain: "Net Kazan√ß", thRoi: "ROI", thEquipment: "Ekipman", thVisual: "G√∂rsel", windNarMulti: "tesis i√ßi farklƒ± lokasyonlarƒ±n r√ºzgar ≈üartlarƒ±na uygun olarak", windNarSingle: (v) => `<strong>${v} m/s</strong> r√ºzgar hƒ±zƒ± ko≈üullarƒ±nda`, methTitle: "Hesaplama Metotlarƒ± ve Farkƒ±ndalƒ±k", methCalcTitle: "Hesaplama Temelleri", methCalcP1: 'Bu raporda sunulan t√ºm ƒ±sƒ± kaybƒ± hesaplamalarƒ±, uluslararasƒ± kabul g√∂rm√º≈ü <strong>ISO 12241 ‚Äì Termal Yalƒ±tƒ±m Hesaplama Standartlarƒ±</strong> temelinde ger√ßekle≈ütirilmi≈ütir.', methCalcP2: 'Hesaplamalar iteratif bir y√∂ntemle y√ºr√ºt√ºl√ºr: izolasyon malzemesinin termal iletkenlik katsayƒ±sƒ± (Œª), ortalama sƒ±caklƒ±ƒüa baƒülƒ± olarak dinamik bi√ßimde hesaplanƒ±r.', methFormulaTitle: "Temel Form√ºl (Silindirik Y√ºzey)", methFormulaDesc: "Q = ƒ±sƒ± kaybƒ± (W), T<sub>proc</sub> = proses sƒ±caklƒ±ƒüƒ±, T<sub>s</sub> = y√ºzey sƒ±caklƒ±ƒüƒ±", methTeslaTitle: "Enerji Farkƒ±ndalƒ±ƒüƒ± ‚Äì Tesla √ñrneƒüi", methTeslaSubtitle: "En Y√ºksek Kayƒ±plƒ± Kaleminiz", methTeslaKwhLabel: "Yƒ±llƒ±k Enerji Kaybƒ±", methTeslaChargeLabel: "Tesla ≈ûarj Sayƒ±sƒ±", methTeslaKmLabel: "Toplam Mesafe", methTeslaNote: "* Tesla Model 3 batarya kapasitesi ‚âà 60 kWh, ortalama menzil ‚âà 490 km. Termal enerji %40 termodinamik verimle elektrik enerjisine d√∂n√º≈üt√ºr√ºlm√º≈üt√ºr. (Kaynak: EiiF ‚Äì TIPCHECK)", methAwarenessTitle: "ƒ∞zolasyonun √ñnemi", methAware1Title: "üî• Enerji ƒ∞srafƒ±", methAware1Desc: "End√ºstriyel tesislerde yalƒ±tƒ±msƒ±z ekipmanlar, toplam enerji t√ºketiminin %5-10'una varan kayƒ±plara neden olabilir.", methAware2Title: "üåø √áevresel Etki", methAware2Desc: "Her 1.000 kWh tasarruf, yakla≈üƒ±k 200-250 kg CO‚ÇÇ azaltƒ±mƒ±na e≈üdeƒüerdir.", methAware3Title: "üë∑ ƒ∞SG ve G√ºvenlik", methAware3Desc: "60¬∞C √ºzerindeki y√ºzeyler ciddi yanƒ±k riski ta≈üƒ±r. Uygun izolasyon g√ºvenliƒüi saƒülar.", methAware4Title: "üí∞ Hƒ±zlƒ± Geri D√∂n√º≈ü", methAware4Desc: "ƒ∞zolasyon yatƒ±rƒ±mlarƒ±nƒ±n geri d√∂n√º≈ü s√ºresi tipik olarak 6-18 aydƒ±r.", methFooter: "Bu sayfa ≈üeffaflƒ±k ve profesyonellik ilkesi gereƒüi hesaplama metodolojisi hakkƒ±nda bilgi vermek amacƒ±yla hazƒ±rlanmƒ±≈ütƒ±r.", logoSubtitle: "Enerji Verimliliƒüi Hesaplama Ara√ßlarƒ±", covClientLabel: "Firma / M√º≈üteri", covProvLabel: "Tedarik√ßi / Hazƒ±rlayan", covParamsLabel: "Sim√ºlasyon Parametreleri", covRoiLabel: "Amortisman (ROI)", covRoiUnit: "AY", fuelPrefix: "Yakƒ±t: ", hoursPrefix: "Yƒ±llƒ±k √áalƒ±≈üma: ", hoursSuffix: " saat", methRadiatorNote: 'Tƒ±pkƒ± evlerimizde radyat√∂r panellerinin bir odayƒ± nasƒ±l ƒ±sƒ±ttƒ±ƒüƒ±nƒ± d√º≈ü√ºn√ºn: Yalƒ±tƒ±msƒ±z her sƒ±cak boru, vana veya tank y√ºzeyi ‚Äì aslƒ±nda birer "a√ßƒ±k radyat√∂r" gibi √ßalƒ±≈üarak √ßevresindeki havayƒ± s√ºrekli olarak ƒ±sƒ±tmaktadƒ±r. Bu, tesisinizde fark edilmeden devam eden ve doƒürudan yakƒ±t t√ºketiminize yansƒ±yan ger√ßek bir enerji kaybƒ±dƒ±r.', methFormula1Title: "Kond√ºksiyon (ƒ∞letim)", methFormula1Desc: "Silindirik y√ºzeylerde iletimle ƒ±sƒ± transferi. Œª = iletkenlik katsayƒ±sƒ± (W/mK), r = yarƒ±√ßap deƒüerleri", methFormula2Title: "Konveksiyon (Ta≈üƒ±nƒ±m)", methFormula2Desc: "Y√ºzeyden havaya ta≈üƒ±nƒ±m kayƒ±plarƒ±. h<sub>c</sub> = konveksiyon katsayƒ±sƒ±, A = y√ºzey alanƒ±", methFormula3Title: "I≈üƒ±nƒ±m (Radyasyon)", methFormula3Desc: "Stefan-Boltzmann ƒ±≈üƒ±nƒ±m kaybƒ±. Œµ = emisivite, œÉ = 5.67√ó10‚Åª‚Å∏ W/m¬≤K‚Å¥", sumCurrentLoss: "Mevcut Yƒ±llƒ±k Kayƒ±p", sumTotalInv: "Toplam Yatƒ±rƒ±m Bedeli", sumMatLabor: "Malzeme ve ƒ∞≈ü√ßilik Dahil", sumNetGain: "Yƒ±llƒ±k Net Kazan√ß", sumAfterSaving: "Enerji Tasarrufu Sonrasƒ±", sumRoiPeriod: "Geri D√∂n√º≈ü S√ºresi (ROI)", sumDepreciation: "Amortisman", sumProjTitle: "Finansal Projeksiyon (5 Yƒ±l)", sumScenario: "Senaryo",
        },
        en: {
            detailedAnalysis: "Detailed Analysis Report", executiveSummary: "Executive Summary", currentAnnualLoss: "Current Annual Loss", totalInvestment: "Total Investment Cost", materialAndLabor: "Including Material and Labor", annualNetGain: "Annual Net Savings", afterEnergySaving: "After Energy Savings", roiPeriod: "Payback Period (ROI)", depreciation: "Return on Investment", financialProjection: "Financial Projection (5 Years)", scenario: "Scenario", year: "Year", total: "TOTAL", currentStatus: "Current State (Cumulative Loss)", afterInvestment: "After Investment (Cumulative Gain)", carbonFootprint: "CARBON FOOTPRINT REDUCTION", treeEquivalent: "Tree Equivalent", isoDisclaimer: "Calculations are simulated according to ISO 12241 engineering standards. Not a guarantee.", page: "Page", month: "MONTHS", daily: "DAILY", weekly: "WEEKLY", monthly: "MONTHLY", yearly: "ANNUAL", company: "Client / Company", supplier: "Supplier / Prepared By", reportDate: "Report Date", authPerson: "Contact Person", isoLabel: "ISO 12241 Based Heat Loss Simulation", industrialTitle: "INDUSTRIAL", insulationTitle: "INSULATION", analysisTitle: "ANALYSIS", coverIntro: "following the thermal audits conducted at your facility; heat losses from uninsulated equipment, financial costs and carbon footprint have been calculated. The data below is a summary of the current situation.", roi: "Return on Investment (ROI)", narrative: (tAmb, windBit, eff, hours, price, curr) => `Simulations based on <strong>${tAmb}¬∞C</strong> ambient temperature, ${windBit}, <strong>${eff}%</strong> system efficiency and <strong>${hours} hours</strong> annual operation. Unit energy cost: <strong>${price} ${curr}</strong>.`, qrText: "Scan the code to track the real-time cost of current heat losses at your facility.", thBare: "Bare", thBareKwh: "(Loss kWh)", thInsulated: "Insulated", thInsKwh: "(Loss kWh)", thGain: "Savings", thGainKwh: "(Diff kWh)", thQty: "Qty", thInvestment: "Investment", thNetGain: "Net Savings", thRoi: "ROI", thEquipment: "Equipment", thVisual: "Image", windNarMulti: "adjusted for different wind conditions at various facility locations", windNarSingle: (v) => `under <strong>${v} m/s</strong> wind speed conditions`, methTitle: "Calculation Methods and Awareness", methCalcTitle: "Calculation Fundamentals", methCalcP1: 'All heat loss calculations are based on internationally recognized <strong>ISO 12241 ‚Äì Thermal Insulation Calculation Standards</strong>.', methCalcP2: 'Calculations use an iterative method: thermal conductivity (Œª) is dynamically calculated based on average temperature.', methFormulaTitle: "Basic Formula (Cylindrical Surface)", methFormulaDesc: "Q = heat loss (W), T<sub>proc</sub> = process temperature, T<sub>s</sub> = surface temperature", methTeslaTitle: "Energy Awareness ‚Äì Tesla Example", methTeslaSubtitle: "Your Highest Loss Item", methTeslaKwhLabel: "Annual Energy Loss", methTeslaChargeLabel: "Tesla Charges", methTeslaKmLabel: "Total Distance", methTeslaNote: "* Tesla Model 3 battery ‚âà 60 kWh, range ‚âà 490 km. Thermal energy converted at 40% thermodynamic efficiency. (Source: EiiF ‚Äì TIPCHECK)", methAwarenessTitle: "The Importance of Insulation", methAware1Title: "üî• Energy Waste", methAware1Desc: "Uninsulated equipment can cause losses of up to 5-10% of total energy consumption.", methAware2Title: "üåø Environmental Impact", methAware2Desc: "Every 1,000 kWh savings equals approximately 200-250 kg CO‚ÇÇ reduction.", methAware3Title: "üë∑ OHS and Safety", methAware3Desc: "Surfaces above 60¬∞C pose serious burn risks. Proper insulation ensures safety compliance.", methAware4Title: "üí∞ Quick Payback", methAware4Desc: "Industrial insulation payback periods are typically 6-18 months.", methFooter: "This page provides information about the calculation methodology for transparency and professionalism.", logoSubtitle: "Energy Efficiency Calculation Tools", covClientLabel: "Client / Company", covProvLabel: "Supplier / Prepared By", covParamsLabel: "Simulation Parameters", covRoiLabel: "Payback Period (ROI)", covRoiUnit: "MONTHS", fuelPrefix: "Fuel: ", hoursPrefix: "Annual Operation: ", hoursSuffix: " hours", methRadiatorNote: 'Think of how radiator panels heat a room in our homes: Every uninsulated hot pipe, valve, or tank surface effectively works as an "open radiator", continuously heating the surrounding air. This is a real energy loss that goes unnoticed at your facility and directly impacts your fuel consumption.', methFormula1Title: "Conduction", methFormula1Desc: "Heat transfer by conduction in cylindrical surfaces. Œª = thermal conductivity (W/mK), r = radius values", methFormula2Title: "Convection", methFormula2Desc: "Convective heat losses from surface to air. h<sub>c</sub> = convection coefficient, A = surface area", methFormula3Title: "Radiation", methFormula3Desc: "Stefan-Boltzmann radiation loss. Œµ = emissivity, œÉ = 5.67√ó10‚Åª‚Å∏ W/m¬≤K‚Å¥", sumCurrentLoss: "Current Annual Loss", sumTotalInv: "Total Investment Cost", sumMatLabor: "Including Material and Labor", sumNetGain: "Annual Net Savings", sumAfterSaving: "After Energy Savings", sumRoiPeriod: "Payback Period (ROI)", sumDepreciation: "Return on Investment", sumProjTitle: "Financial Projection (5 Years)", sumScenario: "Scenario",
        }
    };

    let reportLang = 'tr'; let pendingDeleteIndex = null; let printTemplateCache = null;

    function showReportLangPopup() { if(LIST.length === 0) { showCustomAlert("Liste Bo≈ü", "Rapor almak i√ßin √∂nce hesaplama listesine en az bir kalem eklemelisiniz."); return; } const popup = document.getElementById('reportLangPopup'); popup.style.display = 'flex'; popup.classList.remove('hidden'); setTimeout(() => { const inner = document.getElementById('reportLangPopupInner'); inner.classList.remove('scale-95','opacity-0'); inner.classList.add('scale-100','opacity-100'); }, 10); lucide.createIcons(); }
    function closeReportLangPopup() { const inner = document.getElementById('reportLangPopupInner'); inner.classList.add('scale-95','opacity-0'); inner.classList.remove('scale-100','opacity-100'); setTimeout(() => { document.getElementById('reportLangPopup').style.display='none'; }, 200); }
    function generateReport(lang) { reportLang = lang; closeReportLangPopup(); setTimeout(() => printRep(), 300); }

    let _clearAllMode = false;
    function showDeletePopup(idx) { pendingDeleteIndex = idx; _clearAllMode = false; const item = LIST[idx]; document.getElementById('deleteConfirmMsg').innerHTML = `<strong>"${item.name}"</strong> kalemini silmek istediƒüinize emin misiniz?`; document.getElementById('deleteConfirmPopup').style.display = 'flex'; document.getElementById('deleteConfirmPopup').classList.remove('hidden'); lucide.createIcons(); }
    function closeDeletePopup() { pendingDeleteIndex = null; _clearAllMode = false; document.getElementById('deleteConfirmPopup').style.display = 'none'; }
    function confirmDelete() { if(_clearAllMode) { LIST = []; render(); } else if(pendingDeleteIndex !== null) { LIST.splice(pendingDeleteIndex, 1); render(); } closeDeletePopup(); }
    function del(i) { showDeletePopup(i); }
    function clearAll() { if(LIST.length === 0) return; _clearAllMode = true; document.getElementById('deleteConfirmMsg').innerHTML = `T√ºm listeyi (<strong>${LIST.length} kalem</strong>) temizlemek istediƒüinize emin misiniz?`; document.getElementById('deleteConfirmPopup').style.display = 'flex'; document.getElementById('deleteConfirmPopup').classList.remove('hidden'); lucide.createIcons(); }

async function saveCalculation() {
    if(LIST.length === 0) { showSavePopup("Uyarƒ±", "Kaydedilecek hesaplama bulunamadƒ±."); return; }
    const { data: { session } } = await supabaseClient.auth.getSession();
    if(!session) { showSavePopup("Hata", "L√ºtfen √∂nce giri≈ü yapƒ±n."); setTimeout(() => { window.location.href = '/login.html'; }, 2000); return; }
    
    const currVal = document.getElementById('curr').value;
    const reportRate = FX[currVal] || 1;
    let gInv = 0, gSave = 0, gCo2 = 0, gLoss = 0;
    LIST.forEach(i => { const invDisp = i.invTL / reportRate; const saveDisp = i.saveTL / reportRate; const lossDisp = i.lossTL / reportRate; if(i.inputs.matKey !== 'bare') { gInv += invDisp; gSave += saveDisp; gCo2 += i.co2; } gLoss += lossDisp; });
    const finalInv = (manualTotalInvestment !== null && manualTotalInvestment > 0) ? (manualTotalInvestment / reportRate) : gInv;
    const totalRoi = gSave > 0 ? (finalInv / gSave * 12) : 0;
    
    try {
        const calcData = { user_id: session.user.id, project_name: document.getElementById('pName').value || "ƒ∞simsiz Proje", client_name: document.getElementById('cName').value || "", client_contact: document.getElementById('cEng').value || "", provider_name: document.getElementById('pName').value || "", provider_engineer: document.getElementById('pEng').value || "", audit_date: document.getElementById('auditDate').value || null, calculation_type: 'roi', items: LIST, total_investment: finalInv, total_savings: gSave, total_loss: gLoss, total_co2: gCo2, roi_months: totalRoi, currency: currVal, ambient_temp: parseFloat(document.getElementById('tAmb').value), wind_speed: parseFloat(document.getElementById('vWind').value), fuel_type: document.getElementById('fuel').value, boiler_efficiency: parseFloat(document.getElementById('eff').value), energy_price: parseFloat(document.getElementById('price').value), annual_hours: parseInt(document.getElementById('hours').value) };
        let data, error;

        if (window.loadedCalcId) { ({ data, error } = await supabaseClient.from('calculations').update(calcData).eq('id', window.loadedCalcId).select()); } 
        else { ({ data, error } = await supabaseClient.from('calculations').insert(calcData).select()); }
        
        if(error) { showSavePopup("Hata", "Kaydetme sƒ±rasƒ±nda hata olu≈ütu: " + error.message); } 
        else {
            const isUpdate = !!window.loadedCalcId;
            const saveName = document.getElementById('cName').value || document.getElementById('pName').value || 'Proje';
            if (!isUpdate && data && data[0]) { window.loadedCalcId = data[0].id; const newUrl = window.location.pathname + '?load_id=' + data[0].id; window.history.replaceState({}, '', newUrl); }
            showSavePopup("Ba≈üarƒ±lƒ±! üéâ", `<strong>"${saveName}"</strong> ${isUpdate ? 'g√ºncellendi' : 'kaydedildi'}!<br><br><span class="text-xs text-slate-500">Dashboard'dan g√∂r√ºnt√ºleyebilirsiniz.</span>`);
        }
    } catch(err) { showSavePopup("Hata", "Bir hata olu≈ütu: " + err.message); }
}
    function showSavePopup(title, msg) { document.getElementById('savePopupTitle').innerText = title; document.getElementById('savePopupMsg').innerHTML = msg; document.getElementById('savePopup').style.display = 'flex'; document.getElementById('savePopup').classList.remove('hidden'); lucide.createIcons(); }
    function closeSavePopup() { document.getElementById('savePopup').style.display = 'none'; }

    function calculateTeslaEquivalent() { let maxKwh = 0, maxItem = null; LIST.forEach(item => { const kwh = parseFloat(item.kwhBare.replace(/\./g,'').replace(',','.')) || 0; if(kwh > maxKwh) { maxKwh = kwh; maxItem = item; } }); if(!maxItem) return { itemName: '-', kwh: 0, charges: 0, km: 0 }; const electricKwh = maxKwh * 0.40; const teslaCharges = Math.floor(electricKwh / 60); const teslaKm = Math.round(teslaCharges * 490); return { itemName: maxItem.name, kwh: Math.round(maxKwh), charges: teslaCharges, km: teslaKm }; }

    function printRep(){
        try{
            const L = I18N[reportLang] || I18N.tr;
            const printArea = document.getElementById('print-area');
            if(!printTemplateCache) printTemplateCache = printArea.innerHTML;
            printArea.innerHTML = printTemplateCache;
            
            const today = new Date().toLocaleDateString(reportLang==='en'?'en-GB':'tr-TR');
            const auditInput = document.getElementById('auditDate').value;
            let auditDateStr = today; 
            if(auditInput){ const parts=auditInput.split('-'); auditDateStr=`${parts[2]}.${parts[1]}.${parts[0]}`; }
            
            const currSymVal=document.getElementById('curr').value;
            const reportRate=FX[currSymVal]||1;
            const currSymMap={'USD':'$','EUR':'‚Ç¨','TL':'‚Ç∫'};
            const currSym=currSymMap[currSymVal]||'';
            let gInv=0,gSave=0,gCo2=0,gLoss=0,gFuelLost=0,gTotalKwh=0;
            let lastFuelUnit="",maxTempDetected=0,allWinds=[];

            LIST.forEach(i => {
                const invDisp=i.invTL/reportRate, saveDisp=i.saveTL/reportRate, lossDisp=i.lossTL/reportRate, lossBareDisp=i.lossBareTL/reportRate;
                const itemTs=parseFloat(i.Ts)||0;
                if(itemTs>maxTempDetected) maxTempDetected=itemTs;
                if(i.inputs.type!=='package') allWinds.push(i.inputs.vWind||1);
                const rawKwh=parseFloat(i.kwhBare.replace(/\./g,'').replace(',','.'));
                gTotalKwh+=rawKwh;
                if(i.inputs.matKey!=='bare'){ gInv+=invDisp; gSave+=saveDisp; gCo2+=i.co2; gLoss+=lossBareDisp; gFuelLost+=i.fuelLost; }
                else { gLoss+=lossDisp; gFuelLost+=i.fuelLost; }
                lastFuelUnit=i.inputs.fuelUnit||"";
            });

            let uniqueWinds=new Set(allWinds);
            let windNarrativeBit = (uniqueWinds.size>1||LIST.some(x=>x.inputs.type==='package')) ? L.windNarMulti : L.windNarSingle(allWinds.length>0?allWinds[0]:document.getElementById('vWind').value);

            const ghostContainer=document.createElement('div');
            ghostContainer.style.cssText='width:210mm;padding:40px;position:absolute;top:-9999px;left:-9999px;visibility:hidden;';
            document.body.appendChild(ghostContainer);

            const tableHeaderHTML = `<th class="w-6">#</th><th class="w-20 text-center">${L.thVisual}</th><th class="text-left w-48">${L.thEquipment}</th><th class="text-center w-20 text-xs text-red-500">${L.thBare}<br><span class="text-[8px] font-normal">${L.thBareKwh}</span></th><th class="text-center w-20 text-xs text-blue-500">${L.thInsulated}<br><span class="text-[8px] font-normal">${L.thInsKwh}</span></th><th class="text-center w-20 text-xs text-green-500">${L.thGain}<br><span class="text-[8px] font-normal">${L.thGainKwh}</span></th><th class="text-center w-8">${L.thQty}</th><th class="text-right text-slate-700">${L.thInvestment}</th><th class="text-right text-green-600 font-black">${L.thNetGain}</th>`;

            const PAGE_SAFE_HEIGHT=880;
            const pages=[]; let currentPage=[],currentHeight=0;
            let tempTable=document.createElement('table');
            tempTable.className='w-full text-sm';
            ghostContainer.appendChild(tempTable);
            let tempTbody=document.createElement('tbody');
            tempTable.appendChild(tempTbody);

            LIST.forEach((i,idx)=>{
                const globalIndex=idx+1, iInv=i.invTL/reportRate, iSave=i.saveTL/reportRate;
                const roi=i.roi>0?i.roi.toFixed(1):"-";
                const imgTag=i.img?`<img src="${i.img}" class="w-16 h-16 object-cover rounded mx-auto border border-slate-200">`:`<div class="w-8 h-8 bg-slate-100 rounded mx-auto flex items-center justify-center text-[8px]">${i.inputs.type==='package'?'PKG':'-'}</div>`;
                const locText=i.location?`<div class="text-[8px] uppercase text-slate-400 mt-1 font-bold">üìç ${i.location}</div>`:'';
                const trHTML=`<td class="text-center font-bold text-slate-400 border-b border-slate-100">${globalIndex}</td><td class="text-center border-b border-slate-100 p-1">${imgTag}</td><td class="font-bold text-slate-800 border-b border-slate-100 text-[10px]">${i.name} ${locText}<div class="text-[8px] text-slate-500 font-normal mt-0.5">${i.desc}</div></td><td class="text-center border-b border-slate-100"><div class="font-bold text-slate-700">${i.Ts}</div><div class="text-[9px] font-bold text-red-500">${i.kwhBare} kWh</div></td><td class="text-center border-b border-slate-100"><div class="font-bold text-slate-700">${i.Tins}</div><div class="text-[9px] font-bold text-orange-500">${i.kwhIns} kWh</div></td><td class="text-center border-b border-slate-100"><div class="font-bold text-green-600">+${i.kwhSave} kWh</div></td><td class="text-center border-b border-slate-100 text-[10px]">${i.qty} ${i.unit}</td><td class="text-right font-mono text-[10px] text-slate-700 border-b border-slate-100">${currSym}${fmt(iInv)}</td><td class="text-right font-mono text-[10px] text-green-600 font-bold border-b border-slate-100">${i.inputs.matKey!=='bare'?'+'+currSym+fmt(iSave):'-'}</td>`;
                const tr=document.createElement('tr'); tr.innerHTML=trHTML; tempTbody.appendChild(tr);
                const rowHeight=tr.offsetHeight;
                if(currentHeight+rowHeight>PAGE_SAFE_HEIGHT){pages.push(currentPage);currentPage=[];currentHeight=0;tempTbody.innerHTML='';tempTbody.appendChild(tr);}
                currentPage.push({html:trHTML}); currentHeight+=rowHeight;
            });
            if(currentPage.length>0) pages.push(currentPage);
            document.body.removeChild(ghostContainer);

            const tablePageTemplate=document.getElementById('p-table');
            const summaryPage=document.getElementById('p-summary');
            tablePageTemplate.remove();
            const totalPages=1+pages.length+1+1+1; 

            pages.forEach((pageRows,index)=>{
                const newPage=tablePageTemplate.cloneNode(true); newPage.id='';
                const titleEl=newPage.querySelector('h2');
                titleEl.innerText=L.detailedAnalysis;
                if(index>0) titleEl.innerHTML+=` <span class="text-sm text-slate-400 font-normal">(${index+1})</span>`;
                newPage.querySelector('#rDate').innerText=today;
                newPage.querySelector('thead tr').innerHTML=tableHeaderHTML;
                newPage.querySelector('.page-num').innerText=`${L.page} ${index+2} / ${totalPages}`;
                const tbody=newPage.querySelector('tbody'); tbody.innerHTML='';
                pageRows.forEach(row=>{ tbody.innerHTML+=`<tr>${row.html}</tr>`; });
                document.getElementById('print-area').insertBefore(newPage,summaryPage);
            });

            const finalInvForReport=(manualTotalInvestment!==null&&manualTotalInvestment>0)?(manualTotalInvestment/reportRate):gInv;
            const totalRoi=gSave>0?(finalInvForReport/gSave*12):0;
            
            document.getElementById('covClient').innerText=document.getElementById('cName').value||(reportLang==='en'?"COMPANY NAME":"Fƒ∞RMA ADI");
            document.getElementById('covContact').innerText=document.getElementById('cEng').value||"";
            document.getElementById('covProv').innerText=document.getElementById('pName').value||(reportLang==='en'?"SUPPLIER":"TEDARƒ∞K√áƒ∞");
            document.getElementById('covDate').innerText=today;
            document.getElementById('covIntroDate').innerText=auditDateStr;
            document.getElementById('covRoiBig').innerText=totalRoi>0?totalRoi.toFixed(1):"---";

            const coverIntroP=document.querySelector('#p-cover p.text-xs.text-slate-500');
            if(coverIntroP) coverIntroP.innerHTML=`<span class="font-bold text-slate-900">${auditDateStr}</span> ${L.coverIntro}`;

            const timeLabels=document.querySelectorAll('#p-cover .text-xs.font-bold.uppercase.tracking-wide.w-24');
            [L.daily,L.weekly,L.monthly,L.yearly].forEach((t,i)=>{ if(timeLabels[i]) timeLabels[i].innerText=t; });

            const isoLabelEl=document.querySelector('#p-cover .bg-green-100.text-green-700');
            if(isoLabelEl) isoLabelEl.innerText=L.isoLabel;

            const mainTitleH1=document.querySelector('#p-cover h1');
            if(mainTitleH1) mainTitleH1.innerHTML=`${L.industrialTitle} <br><span class="text-transparent bg-clip-text bg-gradient-to-r from-green-600 to-emerald-800">${L.insulationTitle}</span> ${L.analysisTitle}`;

            const qrTextEl=document.querySelector('.qr-report-section .text-\\[9px\\]');
            if(qrTextEl) qrTextEl.innerText=L.qrText;

            document.getElementById('covFuelYear').innerText=Math.round(gFuelLost).toLocaleString();
            document.getElementById('covFuelMonth').innerText=Math.round(gFuelLost/12).toLocaleString();
            document.getElementById('covFuelWeek').innerText=Math.round(gFuelLost/52).toLocaleString();
            document.getElementById('covFuelDay').innerText=Math.round(gFuelLost/365).toLocaleString();
            document.getElementById('covKwhYear').innerText=Math.round(gTotalKwh).toLocaleString();
            document.getElementById('covKwhMonth').innerText=Math.round(gTotalKwh/12).toLocaleString();
            document.getElementById('covKwhWeek').innerText=Math.round(gTotalKwh/52).toLocaleString();
            document.getElementById('covKwhDay').innerText=Math.round(gTotalKwh/365).toLocaleString();
            document.querySelectorAll('.fuel-unit-label').forEach(el=>el.innerText=lastFuelUnit);
            
            const tAmb=document.getElementById('tAmb').value, eff=document.getElementById('eff').value;
            const price=document.getElementById('price').value, hours=document.getElementById('hours').value;
            const energyCurr=document.getElementById('energyCurr').value;
            document.getElementById('covNarrative').innerHTML=L.narrative(tAmb,windNarrativeBit,eff,hours,price,energyCurr);
            
            const fuelNamesTR={gas:'Doƒüalgaz',elec:'Elektrik',lng:'LNG',fueloil:'Fuel Oil',coal_imp:'ƒ∞thal K√∂m√ºr',coal_loc:'Yerli K√∂m√ºr',manual:'Manuel'};
            const fuelNamesEN={gas:'Natural Gas',elec:'Electricity',lng:'LNG',fueloil:'Fuel Oil',coal_imp:'Imported Coal',coal_loc:'Local Coal',manual:'Manual'};
            const fuelNamesMap = reportLang==='en' ? fuelNamesEN : fuelNamesTR;
            const fuelLabelEl=document.getElementById('covFuelTypeLabel');
            const hoursLabelEl=document.getElementById('covWorkHoursLabel');
            if(fuelLabelEl) fuelLabelEl.innerText=L.fuelPrefix+(fuelNamesMap[document.getElementById('fuel').value]||'');
            if(hoursLabelEl) hoursLabelEl.innerText=L.hoursPrefix+hours+L.hoursSuffix;
            
            const covClientLbl=document.getElementById('covClientLabel');
            const covProvLbl=document.getElementById('covProvLabel');
            const covParamsLbl=document.getElementById('covParamsLabel');
            const covRoiLbl=document.getElementById('covRoiLabel');
            const covRoiUn=document.getElementById('covRoiUnit');
            if(covClientLbl) covClientLbl.innerText=L.covClientLabel;
            if(covProvLbl) covProvLbl.innerText=L.covProvLabel;
            if(covParamsLbl) covParamsLbl.innerText=L.covParamsLabel;
            if(covRoiLbl) covRoiLbl.innerText=L.covRoiLabel;
            if(covRoiUn) covRoiUn.innerText=L.covRoiUnit;

            const qrImgEl=document.getElementById('covQrCode');
            if(userQrImg){qrImgEl.src=userQrImg;qrImgEl.style.opacity='1';} else {qrImgEl.src="";qrImgEl.style.opacity='0.5';}

            const sumPage=document.getElementById('p-summary');
            sumPage.querySelector('h2').innerText=L.executiveSummary;
            const sumLabels=sumPage.querySelectorAll('.text-sm.font-bold.uppercase');
            if(sumLabels[0]) sumLabels[0].innerHTML='<i data-lucide="flame" class="w-4 h-4"></i> '+L.sumCurrentLoss;
            if(sumLabels[1]) sumLabels[1].innerHTML='<i data-lucide="wallet" class="w-4 h-4"></i> '+L.sumTotalInv;
            if(sumLabels[2]) sumLabels[2].innerHTML='<i data-lucide="sprout" class="w-4 h-4"></i> '+L.sumNetGain;
            if(sumLabels[3]) sumLabels[3].innerHTML='<i data-lucide="timer" class="w-4 h-4"></i> '+L.sumRoiPeriod;
            const sumSubs=sumPage.querySelectorAll('.text-xs.text-slate-400.mt-1');
            if(sumSubs[1]) sumSubs[1].innerText=L.sumMatLabor;
            if(sumSubs[2]) sumSubs[2].innerText=L.sumAfterSaving;
            if(sumSubs[3]) sumSubs[3].innerText=L.sumDepreciation;
            const projTitle=sumPage.querySelector('h3');
            if(projTitle) projTitle.innerHTML='<i data-lucide="bar-chart-3" class="w-4 h-4"></i> '+L.sumProjTitle;
            const projScenario=sumPage.querySelector('th.text-left');
            if(projScenario) projScenario.innerText=L.sumScenario;
            const projYearHeaders=sumPage.querySelectorAll('th.p-2:not(.text-left):not(.font-black)');
            projYearHeaders.forEach((th,idx)=>{if(idx<5) th.innerText=L.year+' '+(idx+1);});
            const projTotalHeader=sumPage.querySelector('th.font-black');
            if(projTotalHeader) projTotalHeader.innerText=L.total;
            document.getElementById('sumLoss').innerText=currSym+fmt(gLoss);
            document.getElementById('sumFuelLost').innerText=`(${Math.round(gFuelLost).toLocaleString()} ${lastFuelUnit})`;
            document.getElementById('sumCo2').innerText=gCo2.toFixed(1);
            document.getElementById('sumTrees').innerText=Math.round(gCo2*40).toLocaleString();
            document.getElementById('sumInvSummary').innerText=currSym+fmt(finalInvForReport);
            document.getElementById('sumNetSaveSummary').innerText=currSym+fmt(gSave);
            document.getElementById('sumRoiSummary').innerText=totalRoi>0?totalRoi.toFixed(1)+` ${L.month}`:"---";

            const carbonTitle=sumPage.querySelector('.text-emerald-300');
            if(carbonTitle) carbonTitle.innerText=L.carbonFootprint;
            const treeLabel=sumPage.querySelector('.text-emerald-400.mt-1');
            if(treeLabel) treeLabel.innerText=L.treeEquivalent;

            const disclaimer=sumPage.querySelector('.border-t-2.border-slate-100 p');
            if(disclaimer) disclaimer.innerText=L.isoDisclaimer;

            const pt=document.getElementById('projTable'); pt.innerHTML='';
            let rowL=`<tr class="border-b border-slate-200"><td class="p-2 text-left font-bold text-red-600">${L.currentStatus}</td>`;
            let tL=0;
            for(let y=1;y<=5;y++){tL+=gLoss;rowL+=`<td class="p-2 text-red-500">-${currSym}${fmt(tL)}</td>`;}
            rowL+=`<td class="p-2 font-black text-red-700">-${currSym}${fmt(tL)}</td></tr>`;
            let rowG=`<tr><td class="p-2 text-left font-bold text-green-600">${L.afterInvestment}</td>`;
            let tG=-finalInvForReport;
            for(let y=1;y<=5;y++){tG+=gSave;rowG+=`<td class="p-2 ${tG>=0?'text-green-600':'text-red-400'}">${currSym}${fmt(tG)}</td>`;}
            rowG+=`<td class="p-2 font-black ${tG>=0?'text-green-700':'text-red-700'}">${tG>0?'+':''}${currSym}${fmt(tG)}</td></tr>`;
            pt.innerHTML=rowL+rowG;

            const methPage=document.getElementById('p-methodology');
            if(methPage){
                methPage.querySelector('#methTitle').innerText=L.methTitle;
                methPage.querySelector('.meth-calc-title').innerText=L.methCalcTitle;
                methPage.querySelector('#methCalcP1').innerHTML=L.methCalcP1;
                methPage.querySelector('#methCalcP2').innerHTML=L.methCalcP2;
                const radNote=methPage.querySelector('#methRadiatorNote');
                if(radNote) radNote.innerText=L.methRadiatorNote;
                const f1t=methPage.querySelector('#methFormula1Title');if(f1t)f1t.innerText=L.methFormula1Title;
                const f1d=methPage.querySelector('#methFormula1Desc');if(f1d)f1d.innerHTML=L.methFormula1Desc;
                const f2t=methPage.querySelector('#methFormula2Title');if(f2t)f2t.innerText=L.methFormula2Title;
                const f2d=methPage.querySelector('#methFormula2Desc');if(f2d)f2d.innerHTML=L.methFormula2Desc;
                const f3t=methPage.querySelector('#methFormula3Title');if(f3t)f3t.innerText=L.methFormula3Title;
                const f3d=methPage.querySelector('#methFormula3Desc');if(f3d)f3d.innerHTML=L.methFormula3Desc;
                methPage.querySelector('#methFormulaTitle').innerText=L.methFormulaTitle;
                methPage.querySelector('#methFormulaDesc').innerHTML=L.methFormulaDesc;
                methPage.querySelector('.meth-tesla-title').innerText=L.methTeslaTitle;
                methPage.querySelector('#methTeslaSubtitle').innerText=L.methTeslaSubtitle;
                methPage.querySelector('#methTeslaKwhLabel').innerText=L.methTeslaKwhLabel;
                methPage.querySelector('#methTeslaChargeLabel').innerText=L.methTeslaChargeLabel;
                methPage.querySelector('#methTeslaKmLabel').innerText=L.methTeslaKmLabel;
                methPage.querySelector('#methTeslaNote').innerText=L.methTeslaNote;
                methPage.querySelector('.meth-awareness-title').innerText=L.methAwarenessTitle;
                methPage.querySelector('#methAware1Title').innerText=L.methAware1Title;
                methPage.querySelector('#methAware1Desc').innerText=L.methAware1Desc;
                methPage.querySelector('#methAware2Title').innerText=L.methAware2Title;
                methPage.querySelector('#methAware2Desc').innerText=L.methAware2Desc;
                methPage.querySelector('#methAware3Title').innerText=L.methAware3Title;
                methPage.querySelector('#methAware3Desc').innerText=L.methAware3Desc;
                methPage.querySelector('#methAware4Title').innerText=L.methAware4Title;
                methPage.querySelector('#methAware4Desc').innerText=L.methAware4Desc;
                methPage.querySelector('#methFooter').innerText=L.methFooter;
                const tesla=calculateTeslaEquivalent();
                methPage.querySelector('#methTeslaItem').innerText=tesla.itemName;
                methPage.querySelector('#methTeslaKwh').innerText=tesla.kwh.toLocaleString()+" kWh";
                methPage.querySelector('#methTeslaCharges').innerText=tesla.charges.toLocaleString();
                methPage.querySelector('#methTeslaKm').innerText=tesla.km.toLocaleString()+" km";
                methPage.querySelector('#methPageNum').innerText=`${L.page} ${1+pages.length+1+1} / ${totalPages}`;
            }

            const logoPage=document.getElementById('p-logo');
            if(logoPage){
                logoPage.querySelector('#logoSubtitle').innerText=L.logoSubtitle;
                logoPage.querySelector('#logoPageNum').innerText=`${L.page} ${totalPages} / ${totalPages}`;
            }

            setTimeout(()=>{
                const printArea = document.getElementById('print-area');
                printArea.classList.add('force-light-print');
                lucide.createIcons(); 
                window.print(); 
            }, 100);
        }catch(e){ alert('Rapor olu≈üturulurken hata olu≈ütu: '+e.message); console.error(e); }
    }
</script>
<script>
    window.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const loadId = urlParams.get('load_id');
        window.loadedCalcId = loadId || null;
        if (!loadId) return;

        const activeSupabase = window.supabaseClient || window.supabase;
        if (!activeSupabase) { console.error('HATA: Supabase baƒülantƒ±sƒ± bulunamadƒ±!'); return; }

        const { data, error } = await activeSupabase.from('calculations').select('*').eq('id', loadId).single();
        if (error) { console.error('Veri √ßekme hatasƒ±:', error); return; }

        if (data) {
            if(data.project_name) document.getElementById('pName').value = data.project_name;
            if(data.client_name) document.getElementById('cName').value = data.client_name;
            if(data.client_contact) document.getElementById('cEng').value = data.client_contact;
            if(data.provider_engineer) document.getElementById('pEng').value = data.provider_engineer;
            if(data.audit_date) document.getElementById('auditDate').value = data.audit_date;
            if(data.ambient_temp) document.getElementById('tAmb').value = data.ambient_temp;
            if(data.wind_speed !== null) document.getElementById('vWind').value = data.wind_speed;
            if(data.boiler_efficiency) document.getElementById('eff').value = data.boiler_efficiency;
            if(data.energy_price) document.getElementById('price').value = data.energy_price;
            if(data.annual_hours) document.getElementById('hours').value = data.annual_hours;
            if(data.currency) document.getElementById('curr').value = data.currency;
            if(data.fuel_type) { document.getElementById('fuel').value = data.fuel_type; if(typeof toggleFuelMode === 'function') toggleFuelMode(); }

            if (data.items && Array.isArray(data.items)) {
                LIST = data.items;
                if(typeof render === 'function') render();
            }
        }
    });
</script>
</body>
</html>
