<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chiller Sistemleri Amortisman Hesaplama</title>
<meta name="description" content="Chiller ve soğutma hatları yalıtım karlılık analizi.">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- Supabase JS Library -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Authentication Guard -->
<script src="auth.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="icon" href="https://optimizi.app/favicon.png" type="image/png">
    
    <!-- Flash Problemi Çözümü -->
    <style>
      body {
        opacity: 0;
        visibility: hidden;
      }
      body.auth-checked {
        opacity: 1;
        visibility: visible;
        transition: opacity 0.3s ease;
      }
    </style>
</head>
<script>
  tailwind.config = {
    theme: {
      fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
      extend: {
        colors: { slate: { 850: '#151e2e', 900: '#0f172a', 950: '#020617' } },
        screens: { 'print': {'raw': 'print'} }
      }
    }
  }
</script>
<style>
  :root {
      --bg-color: #f8fafc;
      --grid-line: rgba(6, 182, 212, 0.05);
      --glass-bg: rgba(255, 255, 255, 0.95);
      --glass-border: rgba(6, 182, 212, 0.15);
      --text-main: #0f172a;
  }
  
  html { scroll-behavior: smooth; }
  body {
      background-color: var(--bg-color);
      background-image: radial-gradient(var(--grid-line) 1px, transparent 1px);
      background-size: 24px 24px;
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
  }
  
  .glass-card {
      background-color: var(--glass-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      box-shadow: 0 4px 20px -5px rgba(6, 182, 212, 0.1);
  }
  
  .glass-input {
      transition: all 0.2s;
      border-radius: 0.5rem;
      padding: 0.6rem 0.75rem;
      width: 100%;
      background-color: #fff;
      border: 1px solid #e2e8f0;
      color: var(--text-main);
      font-size: 0.85rem;
  }
  .glass-input:focus { outline: none; border-color: #06b6d4; box-shadow: 0 0 0 3px rgba(6,182,212,0.1); }

  /* PRINT STYLES */
  @media print {
    @page { margin: 0; size: A4; }
    html, body { width: 210mm; height: 297mm; margin: 0 !important; padding: 0 !important; background: white !important; overflow: visible !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    #app-layer, button, input, nav, select, .no-print { display: none !important; }
    #print-area { display: block !important; }
    .print-page { width: 210mm; height: 296mm; position: relative; page-break-after: always; background: white; overflow: hidden; }
    .print-page:last-child { page-break-after: auto; }
    .cover-bg { background-color: #0f172a !important; color: white !important; }
    .cover-pattern { position: absolute; inset: 0; opacity: 0.05; background-image: linear-gradient(45deg, #06b6d4 25%, transparent 25%, transparent 75%, #06b6d4 75%, #06b6d4); background-size: 60px 60px; }
    .audit-table th { background-color: #f1f5f9 !important; color: #475569 !important; font-weight: 800; text-transform: uppercase; font-size: 8px; padding: 6px; border-bottom: 2px solid #cbd5e1; }
    .audit-table td { border-bottom: 1px solid #e2e8f0; padding: 6px; font-size: 9px; color: #334155; vertical-align: middle; }
    .audit-table tr:nth-child(even) { background-color: #f8fafc !important; }
  }
  #print-area { display: none; }
  #qrcode-gen { display: none; }
</style>
</head>
<body class="selection:bg-cyan-500/30 selection:text-cyan-700" onload="initApp()">

<div id="app-layer" class="relative z-10 flex flex-col min-h-screen">
    <nav class="sticky top-0 z-50 glass-card !bg-white/90 !border-x-0 !border-t-0 !rounded-none border-b border-cyan-100 backdrop-blur-xl">
      <div class="max-w-[1440px] mx-auto px-6 h-16 flex items-center justify-between">
          <div class="flex items-center gap-3">
              <h1 class="text-xl font-black text-slate-800 tracking-tight">Optimizi<span class="text-cyan-600">.Chiller</span></h1>
          </div>
          <div class="flex items-center gap-3">
              <label class="flex items-center gap-2 cursor-pointer bg-slate-50 px-3 py-1.5 rounded-full border border-slate-200 hover:border-cyan-500 transition select-none mr-2">
                  <span class="text-[10px] font-bold text-slate-500" data-t="lbl_incl_qr">QR Ekle</span>
                  <input type="checkbox" id="toggleQrInput" checked class="w-4 h-4 accent-cyan-600 cursor-pointer">
              </label>

              <button onclick="toggleLang()" class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-slate-100 hover:bg-slate-200 transition text-xs font-bold text-slate-600">
                  <i data-lucide="languages" class="w-3.5 h-3.5"></i> <span id="langDisplay">TR</span>
              </button>
              
              <div class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-50 border border-slate-200 text-xs text-slate-500">
                  <span class="w-1.5 h-1.5 rounded-full bg-cyan-500 animate-pulse"></span>
                  <span id="fxVal" class="font-bold text-slate-800">34.50</span>
              </div>
              
              <button onclick="printRep()" class="flex items-center gap-2 bg-slate-800 hover:bg-slate-900 text-white px-5 py-2 rounded-lg text-xs font-bold transition shadow-lg shadow-slate-900/20 active:scale-95 ml-2 cursor-pointer">
                  <i data-lucide="printer" class="w-4 h-4"></i> <span data-t="btn_report">Rapor Al</span>
              </button>
          </div>
      </div>
    </nav>

    <main class="flex-1 max-w-[1440px] mx-auto w-full p-6 lg:p-8">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="glass-card p-6 rounded-2xl border-l-4 border-cyan-500">
               <div class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-1" data-t="dash_roi">Ort. Amortisman</div>
               <div class="text-4xl font-black text-slate-800 tracking-tight" id="dashRoi">---</div>
               <div class="mt-3 text-[10px] text-slate-400 flex items-center gap-1"><i data-lucide="info" class="w-3 h-3"></i> ROI</div>
            </div>
            <div class="glass-card p-6 rounded-2xl border-l-4 border-green-500">
               <div class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-1" data-t="dash_save">Yıllık Kazanç</div>
               <div class="text-3xl font-bold text-green-600 tracking-tight" id="dashSave">0</div>
            </div>
            <div class="glass-card p-6 rounded-2xl">
               <div class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-1" data-t="dash_inv">Toplam Yatırım</div>
               <div class="text-3xl font-bold text-slate-800 tracking-tight" id="dashInv">0</div>
            </div>
            <div class="glass-card p-6 bg-gradient-to-br from-cyan-50 to-white border-cyan-100 rounded-2xl">
               <div class="flex items-center justify-between">
                  <div>
                      <div class="text-cyan-600 text-[10px] font-bold uppercase tracking-wider mb-1" data-t="dash_co2">CO2 Azaltım</div>
                      <div class="text-3xl font-bold text-slate-800" id="dashCo2">0 <span class="text-sm font-normal text-slate-500">Ton</span></div>
                  </div>
                  <div class="p-3 bg-cyan-100 rounded-xl text-cyan-600 border border-cyan-200"><i data-lucide="leaf" class="w-6 h-6"></i></div>
               </div>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-12 gap-8 items-start">
            <div class="xl:col-span-4 space-y-6">
                <div class="glass-card p-6 rounded-2xl">
                   <h3 class="text-slate-800 text-xs font-black uppercase mb-4 flex items-center gap-2 tracking-wider"><i data-lucide="briefcase" class="w-4 h-4 text-cyan-600"></i> <span data-t="sec_project">Firma & Proje</span></h3>
                   <div class="space-y-4">
                       <div><label class="text-[10px] uppercase text-slate-500 font-bold mb-1 block" data-t="lbl_prepared">Hazırlayan</label><div class="grid gap-2"><input type="text" id="pName" class="glass-input text-xs" placeholder="..."><input type="text" id="pEng" class="glass-input text-xs" placeholder="..."></div></div>
                       <div class="h-px bg-slate-100 my-3"></div>
                       <div><label class="text-[10px] uppercase text-slate-500 font-bold mb-1 block" data-t="lbl_client">Müşteri Bilgileri</label><div class="grid gap-2"><input type="text" id="cName" class="glass-input text-xs" placeholder="..."><input type="text" id="cEng" class="glass-input text-xs" placeholder="..."></div></div>
                   </div>
                </div>

                <div class="glass-card p-6 rounded-2xl">
                    <h3 class="text-slate-800 text-xs font-black uppercase mb-4 flex items-center gap-2 tracking-wider"><i data-lucide="settings" class="w-4 h-4 text-cyan-600"></i> <span data-t="sec_params">Parametreler</span></h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[10px] text-slate-500 mb-1 block" data-t="lbl_tamb">Ortam Sıc. (°C)</label><input type="number" id="tAmb" class="glass-input text-xs" value="30"></div>
                        <div><label class="text-[10px] text-slate-500 mb-1 block" data-t="lbl_wind">Rüzgar (m/s)</label><input type="number" id="vWind" class="glass-input text-xs" value="0"></div>
                    </div>
                    
                    <div class="mt-4 grid grid-cols-2 gap-4"> 
                        <div>
                             <label class="text-[10px] text-slate-500 mb-1 block font-bold text-cyan-600">Chiller COP</label>
                             <input type="number" id="cop" class="glass-input text-xs font-bold" value="3.5" step="0.1">
                         </div>
                         <div><label class="text-[10px] text-slate-500 mb-1 block" data-t="lbl_hours">Yıllık Saat</label><input type="number" id="hours" class="glass-input text-xs" value="5000"></div>
                    </div>

                    <div class="mt-4">
                        <label class="text-[10px] text-slate-500 mb-1 block" data-t="lbl_price">Enerji Birim Fiyatı</label>
                        <div class="flex gap-1"><input type="number" id="price" class="glass-input text-xs" value="4.50"><select id="energyCurr" class="glass-input !px-1 w-16 text-center text-xs font-bold bg-slate-50"><option value="TL" selected>₺ TL</option><option value="USD">$ USD</option><option value="EUR">€ EUR</option></select></div>
                    </div>
                </div>

                <div class="glass-card p-6 border-cyan-500/30 shadow-[0_0_40px_-10px_rgba(6,182,212,0.2)] rounded-2xl relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-400 to-blue-600"></div>
                    <h3 class="text-slate-900 text-sm font-black uppercase mb-4 flex items-center gap-2 relative z-10"><i data-lucide="plus-circle" class="w-5 h-5 text-cyan-600"></i> <span data-t="sec_add">Yeni Ölçüm Ekle</span></h3>
                    
                    <div class="flex bg-slate-100/50 p-1 rounded-lg mb-4 relative z-10">
                        <button onclick="setType('valve')" id="btn-valve" class="flex-1 py-1.5 text-[10px] font-bold rounded transition-all" data-t="tab_valve">Vana</button>
                        <button onclick="setType('pipe')" id="btn-pipe" class="flex-1 py-1.5 text-[10px] font-bold rounded transition-all" data-t="tab_pipe">Boru</button>
                        <button onclick="setType('tank')" id="btn-tank" class="flex-1 py-1.5 text-[10px] font-bold rounded transition-all" data-t="tab_flat">Düz / Eşanjör</button>
                    </div>
                    <select id="type" class="hidden"><option value="valve">Valve</option><option value="pipe">Pipe</option><option value="tank">Flat</option></select>
                    
                    <div id="g-valve" class="space-y-3 relative z-10">
                        <select id="valveType" class="glass-input text-xs"></select>
                        <select id="vDN" class="glass-input text-xs font-mono"></select>
                    </div>
                    <div id="g-pipe" class="hidden grid grid-cols-2 gap-3 relative z-10">
                        <select id="pDN" class="glass-input text-xs font-mono"></select>
                        <input type="number" id="pLen" class="glass-input text-xs" placeholder="...">
                    </div>
                    
                    <div id="g-tank" class="hidden relative z-10">
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 mb-3">
                            <label class="text-[10px] text-slate-500 mb-2 block font-bold" data-t="lbl_dims">Yüzey Ölçüleri (cm)</label>
                            <div class="flex gap-2 mb-2">
                                <input type="number" id="surfW" class="glass-input text-xs" placeholder="W">
                                <input type="number" id="surfH" class="glass-input text-xs" placeholder="H">
                                <button onclick="addSurface()" class="bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg px-3 flex items-center justify-center transition"><i data-lucide="plus" class="w-4 h-4"></i></button>
                            </div>
                            <div id="surfaceList" class="space-y-1 mb-2 max-h-24 overflow-y-auto"></div>
                            <div class="text-right text-[10px] text-slate-500 border-t border-slate-200 pt-2">
                                <span data-t="lbl_area">Toplam Alan:</span> <span id="totalSurfArea" class="font-bold text-slate-800 text-xs">0.00</span> m²
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mt-4 relative z-10">
                        <div><label class="text-[10px] text-slate-500 mb-1 block" data-t="lbl_tproc">Akışkan Sıc. (°C)</label><div class="relative"><input type="number" id="tProc" class="glass-input pl-8 text-xs font-bold text-cyan-600" value="7"><i data-lucide="snowflake" class="w-3 h-3 text-cyan-500 absolute left-2.5 top-2.5"></i></div></div>
                        <div><label class="text-[10px] text-slate-500 mb-1 block" data-t="lbl_qty">Adet</label><input type="number" id="qty" class="glass-input text-center font-bold text-xs" value="1"></div>
                    </div>
                    
                    <div class="mt-4 relative z-10">
                         <label class="text-[10px] text-slate-500 mb-1 block" data-t="lbl_loc">Mahal / Lokasyon</label>
                         <input type="text" id="location" class="glass-input text-xs" placeholder="...">
                    </div>

                    <div class="mt-4 relative z-10 grid grid-cols-2 gap-2">
                        <div>
                             <input type="file" id="imgInp" class="hidden" accept="image/*" onchange="readImg(this)">
                             <div onclick="document.getElementById('imgInp').click()" class="border border-dashed border-slate-300 rounded-lg p-3 text-center cursor-pointer hover:border-cyan-500 hover:bg-slate-50 transition h-full flex flex-col justify-center items-center"><i data-lucide="camera" class="w-4 h-4 text-slate-400 mb-1"></i><span class="text-[9px] text-slate-400 block" data-t="btn_photo">Fotoğraf</span></div>
                        </div>
                        <img id="prevImg" class="hidden w-full h-16 object-cover rounded-lg border border-slate-300">
                    </div>

                    <div class="bg-slate-50 rounded-lg p-3 mt-4 border border-slate-200 relative z-10">
                        <label class="text-[10px] text-cyan-700 font-bold uppercase mb-2 block" data-t="lbl_ins">İzolasyon Ceketi</label>
                        <select id="matSelect" class="glass-input text-xs mb-2 bg-white"></select>
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <input type="number" id="thk" class="glass-input text-xs" value="19" placeholder="mm">
                            <div class="flex gap-1">
                                <input type="number" id="inv" class="glass-input text-xs" placeholder="Fiyat">
                                <select id="invCurr" class="glass-input !px-1 w-12 text-center text-xs">
                                    <option value="TL">₺</option><option value="USD">$</option><option value="EUR">€</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="btn-group" class="mt-4 relative z-10">
                        <button id="btnAdd" onclick="calc()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-xl shadow-lg shadow-slate-900/10 transition active:scale-95 flex items-center justify-center gap-2 text-sm cursor-pointer"><i data-lucide="plus" class="w-4 h-4"></i> <span data-t="btn_add">Listeye Ekle</span></button>
                        <button id="btnUpdate" onclick="finishUpdate()" class="hidden w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-orange-500/20 transition active:scale-95 flex items-center justify-center gap-2 text-sm cursor-pointer"><i data-lucide="check" class="w-4 h-4"></i> <span data-t="btn_update">Güncelle</span></button>
                    </div>
                </div>
            </div>

            <div class="xl:col-span-8">
                <div class="glass-card p-0 overflow-hidden min-h-[600px] flex flex-col rounded-2xl">
                    <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50/50">
                        <div class="flex items-center gap-4">
                            <h3 class="font-bold text-slate-800 flex items-center gap-2"><i data-lucide="list" class="w-4 h-4 text-cyan-600"></i> <span data-t="sec_list">Hesaplama Listesi</span></h3>
                        </div>
                        <div class="flex items-center gap-2"> 
                            <div class="flex items-center bg-white border border-slate-200 rounded-lg px-2 py-1 gap-2">
                                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-wider">VIEW:</span>
                                <select id="curr" class="text-[11px] font-bold text-slate-800 bg-transparent border-none outline-none cursor-pointer" onchange="render()">
                                    <option value="TL" selected>₺ TL</option>
                                    <option value="USD">$ USD</option>
                                    <option value="EUR">€ EUR</option>
                                </select>
                            </div>
                            <div class="w-px h-4 bg-slate-300 mx-1"></div>
                            <button onclick="clearAll()" class="text-[10px] text-red-500 hover:text-red-700 transition cursor-pointer font-bold px-3 py-1 bg-red-50 rounded hover:bg-red-100" data-t="btn_clear">Temizle</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto flex-1">
                        <table class="w-full text-left text-sm" id="grid">
                        <thead class="bg-slate-100 text-[10px] uppercase text-slate-500 font-semibold sticky top-0 backdrop-blur-md z-10">
                            <tr>
                            <th class="px-4 py-3 text-center" data-t="th_img">Görsel</th>
                            <th class="px-4 py-3" data-t="th_eq">Ekipman</th>
                            <th class="px-4 py-3 text-center" data-t="th_qty">Adet</th>
                            <th class="px-4 py-3 text-center text-red-500" data-t="th_bare">Çıplak<br><span class="text-[9px] opacity-70">(kWh)</span></th>
                            <th class="px-4 py-3 text-center text-cyan-600" data-t="th_ins">Yalıtımlı<br><span class="text-[9px] opacity-70">(kWh)</span></th>
                            <th class="px-4 py-3 text-right" data-t="th_inv">Yatırım</th>
                            <th class="px-4 py-3 text-right text-green-600" data-t="th_save">Kazanç</th>
                            <th class="px-4 py-3 text-right" data-t="th_roi">ROI</th>
                            <th class="px-4 py-3 text-right" data-t="th_act">İşlem</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200" id="gridBody">
                            <tr><td colspan="10" class="px-6 py-24 text-center text-slate-400"><i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 opacity-20"></i><span data-t="msg_empty">Henüz hesaplama eklenmedi.</span></td></tr>
                        </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="qrcode-gen"></div>

<div id="print-area">
    <div id="p-cover" class="print-page cover-bg flex flex-col justify-between p-0 relative overflow-hidden">
        <div class="cover-pattern"></div>
        <div class="p-16 relative z-10">
            <div class="flex items-center justify-between mb-12">
                <div class="flex items-center gap-4 opacity-80">
                    <div class="w-12 h-1 bg-cyan-500"></div>
                    <div class="text-xs tracking-[4px] uppercase font-bold text-cyan-400">Energy Efficiency Audit</div>
                </div>
                <div id="cover-qr-container" class="hidden flex items-center gap-4 bg-white/10 backdrop-blur-md p-3 rounded-xl border border-white/10">
                    <div class="text-right">
                        <div class="text-[9px] font-bold text-cyan-400 uppercase tracking-widest mb-1">VAKİT NAKİTTİR</div>
                        <p class="text-[7px] text-slate-300 leading-tight w-32" data-t="qr_cta">Bu yatırımın yapılmadığı her saniye fazladan harcanan enerjiyi canlı takip edin.</p>
                    </div>
                    <img id="repQrImage" src="" class="w-16 h-16 bg-white rounded p-1">
                </div>
            </div>

            <h1 class="text-7xl font-black leading-tight text-white mb-6">CHILLER <br><span class="text-cyan-400">INSULATION</span> <br>REPORT</h1>
            <p class="text-slate-400 text-lg max-w-lg leading-relaxed" data-t="cov_subtitle">Termal kayıp analizi, yatırım geri dönüş simülasyonu ve karbon ayak izi raporlaması.</p>
        </div>
        <div class="flex-1 flex items-center justify-center relative z-10 w-full px-16">
            <div class="w-full bg-slate-800/50 backdrop-blur-sm border border-slate-700 p-8 rounded-none border-l-4 border-l-cyan-500">
                <div class="grid grid-cols-2 gap-12">
                     <div>
                        <div class="text-xs uppercase text-slate-400 mb-1 font-bold tracking-wider" data-t="print_roi_lbl">TAHMİNİ GERİ DÖNÜŞ</div>
                        <div class="text-6xl font-black text-white" id="covRoi">---</div>
                        <div class="text-sm text-cyan-400 font-bold uppercase tracking-widest mt-1" data-t="print_months">AY</div>
                     </div>
                     <div class="flex flex-col justify-end">
                        <div class="text-xs uppercase text-slate-400 mb-1 font-bold tracking-wider" data-t="print_save_lbl">YILLIK TASARRUF</div>
                        <div class="text-4xl font-bold text-emerald-400" id="covSave">0</div>
                     </div>
                </div>
            </div>
        </div>
        <div class="bg-white text-slate-900 p-16 relative z-10">
             <div class="grid grid-cols-2 gap-12">
                 <div>
                     <h3 class="text-xs font-black uppercase text-slate-400 mb-4 tracking-widest" data-t="lbl_client">MÜŞTERİ</h3>
                     <div class="text-2xl font-bold text-slate-900 mb-1" id="covClient">FİRMA ADI</div>
                     <div class="text-sm text-slate-500 font-medium" id="covContact">Yetkili</div>
                 </div>
                 <div>
                     <h3 class="text-xs font-black uppercase text-slate-400 mb-4 tracking-widest" data-t="lbl_prepared">HAZIRLAYAN</h3>
                     <div class="text-xl font-bold text-slate-900 mb-1" id="covProv">OPTIMIZI</div>
                     <div class="text-sm text-slate-500 font-medium" id="covDate">...</div>
                 </div>
             </div>
             <div class="mt-12 pt-6 border-t border-slate-200 grid grid-cols-4 gap-6 text-[10px] text-slate-500 uppercase font-bold tracking-wider">
                 <div><span class="block text-slate-300">T. AMB</span> <span id="covTemp" class="text-slate-800 text-sm">30</span>°C</div>
                 <div><span class="block text-slate-300">WIND</span> <span id="covWind" class="text-slate-800 text-sm">0</span> m/s</div>
                 <div><span class="block text-slate-300">COP</span> <span id="covCop" class="text-slate-800 text-sm">3.5</span></div>
                 <div><span class="block text-slate-300">PRICE</span> <span id="covPrice" class="text-slate-800 text-sm">4.5</span></div>
             </div>
        </div>
    </div>
    <div id="p-table" class="print-page p-12 hidden">
        <div class="flex justify-between items-center border-b-2 border-slate-900 pb-4 mb-8">
            <h2 class="text-2xl font-black text-slate-900 uppercase" data-t="print_detail_title">DETAYLI ANALİZ DÖKÜMÜ</h2>
            <div class="text-xs font-bold text-slate-400">OPTIMIZI.CHILLER</div>
        </div>
        <table class="w-full audit-table mb-8"><thead><tr id="rep_table_head"></tr></thead><tbody id="rTable"></tbody></table>
    </div>
    <div id="p-summary" class="print-page p-12 flex flex-col h-full hidden">
        <h2 class="text-3xl font-black text-slate-900 uppercase mb-8 border-b-4 border-cyan-500 pb-2 inline-block" data-t="print_exec_sum">YÖNETİCİ ÖZETİ</h2>
        <div class="grid grid-cols-3 gap-6 mb-10">
            <div class="p-6 bg-red-50 border border-red-100 rounded-none">
                <div class="text-[10px] font-black text-red-400 uppercase tracking-widest mb-2" data-t="print_loss_lbl">MEVCUT YILLIK KAYIP</div>
                <div class="text-4xl font-black text-red-600 tracking-tight leading-none" id="sumLoss">0</div>
            </div>
            <div class="p-6 bg-slate-50 border border-slate-100 rounded-none">
                <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2" data-t="dash_inv">TOPLAM YATIRIM</div>
                <div class="text-4xl font-black text-slate-800 tracking-tight leading-none" id="tabInv">0</div>
            </div>
            <div class="p-6 bg-emerald-50 border border-emerald-100 rounded-none">
                <div class="text-[10px] font-black text-emerald-400 uppercase tracking-widest mb-2" data-t="print_net_save">NET KAZANÇ (YILLIK)</div>
                <div class="text-4xl font-black text-emerald-600 tracking-tight leading-none" id="sumSave">0</div>
            </div>
        </div>
        <div class="mb-10 flex-1">
            <h3 class="text-sm font-bold text-slate-900 uppercase mb-4 flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-4 h-4 text-cyan-600"></i> <span data-t="print_chart_title">5 Yıllık Projeksiyon</span></h3>
            <div id="rep_proj_section" class="bg-white border-b border-l border-slate-200 p-6 h-64 relative flex items-end justify-between gap-4"></div>
        </div>
        <div class="grid grid-cols-2 gap-8 mt-auto">
             <div class="bg-slate-900 text-white p-6 relative overflow-hidden">
                 <div class="relative z-10">
                    <div class="text-[10px] font-bold text-cyan-400 uppercase tracking-widest mb-2" data-t="lbl_env_impact">ÇEVRESEL ETKİ</div>
                    <div class="flex gap-8">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-400"><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v4"/><path d="M14 2v6h6"/><path d="M10 20v-5.5"/><path d="M10 18.5a3.5 3.5 0 0 0 3.5-3.5v-1a3.5 3.5 0 0 0-7 0v1A3.5 3.5 0 0 0 10 18.5Z"/></svg>
                                <span class="text-3xl font-black" id="sumCo2">0</span> <span class="text-sm font-normal text-slate-400">Ton</span>
                            </div>
                            <div class="text-[9px] text-slate-400 uppercase" data-t="dash_co2">CO2 Azaltım</div>
                        </div>
                        <div class="w-px bg-slate-700"></div>
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-emerald-400"><path d="M10 10v.2A3 3 0 0 1 8.9 16v0H5v0h0a3 3 0 0 1-1-5.8V10a3 3 0 0 1 5.3-2.1"/><path d="M7 16v6"/><path d="M13 16v-2.3a2.9 2.9 0 0 0-1.7-4.9V8.8a2.8 2.8 0 0 0-2.8-2.8c-1.5 0-2.8 1.2-2.8 2.8V9"/><path d="M13 8v.2c0 .5-.1 1-.3 1.4"/><path d="M13 19v3"/><path d="M17.3 19.8C19.8 19 22 17.5 22 14c0-3.3-2.5-6-5-6-1.9 0-3.6 1-4.4 2.5"/></svg>
                                <span class="text-3xl font-black text-emerald-400" id="dispTreeCount">0</span>
                            </div>
                            <div class="text-[9px] text-slate-400 uppercase" data-t="print_trees">Ağaç Eşleniği</div>
                        </div>
                    </div>
                 </div>
             </div>
             <div class="p-6 border border-slate-200 flex flex-col justify-center">
                <div class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-2">NOTES</div>
                <p class="text-[8px] text-slate-500 leading-relaxed text-justify" data-t="print_disclaimer">
                    Bu rapor, ISO 12241 standartlarına dayalı simülasyon verileri içerir. Soğutma hatlarında yalıtım, sadece enerji tasarrufu sağlamakla kalmaz, aynı zamanda yoğuşma kaynaklı korozyonu önleyerek ekipman ömrünü uzatır.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
    const LANG_DATA = {
        tr: {
            btn_report: "Rapor Al", dash_roi: "Ort. Amortisman", dash_save: "Yıllık Kazanç", dash_inv: "Toplam Yatırım", dash_co2: "CO2 Azaltım",
            sec_project: "Firma & Proje", lbl_prepared: "Hazırlayan", lbl_client: "Firma Bilgileri",
            sec_params: "Parametreler", lbl_tamb: "Ortam Sıc. (°C)", lbl_wind: "Rüzgar (m/s)", lbl_hours: "Yıllık Saat", lbl_price: "Enerji Birim Fiyatı",
            sec_add: "Yeni Ölçüm Ekle", tab_valve: "Vana", tab_pipe: "Boru", tab_flat: "Düz / Eşanjör",
            lbl_dims: "Yüzey Ölçüleri (cm)", lbl_area: "Toplam Alan:", lbl_tproc: "Akışkan Sıc. (°C)", lbl_qty: "Adet", lbl_loc: "Mahal / Lokasyon", btn_photo: "Fotoğraf Ekle",
            lbl_ins: "İzolasyon Ceketi", btn_add: "Listeye Ekle", btn_update: "Güncelle", lbl_repcurr: "Rapor Kuru:", lbl_incl_qr: "QR Ekle",
            sec_list: "Hesaplama Listesi", btn_clear: "Temizle", msg_empty: "Henüz hesaplama eklenmedi.",
            th_img: "Görsel", th_eq: "Ekipman", th_qty: "Adet", th_bare: "Çıplak", th_ins: "Yalıtımlı", th_inv: "Yatırım", th_save: "Kazanç", th_roi: "ROI", th_act: "İşlem",
            print_roi_lbl: "TAHMİNİ GERİ DÖNÜŞ", print_months: "AY", print_save_lbl: "YILLIK TASARRUF",
            print_detail_title: "DETAYLI ANALİZ DÖKÜMÜ", print_exec_sum: "YÖNETİCİ ÖZETİ", 
            print_loss_lbl: "MEVCUT YILLIK KAYIP", print_net_save: "NET KAZANÇ (YILLIK)",
            print_chart_title: "5 Yıllık Projeksiyon", print_trees: "Ağaç Eşleniği", lbl_env_impact: "ÇEVRESEL ETKİ", cov_subtitle: "Termal kayıp analizi, yatırım geri dönüş simülasyonu ve karbon ayak izi raporlaması.",
            print_disclaimer: "Bu rapor, ISO 12241 standartlarına dayalı simülasyon verileri içerir. Soğutma hatlarında yalıtım, enerji tasarrufu sağlamanın yanı sıra yoğuşma ve korozyonu önler.", qr_cta: "Bu yatırımın yapılmadığı her saniye fazladan harcanan enerjiyi canlı takip edin.",
            mats: { rubber: "Elastomerik Kauçuk", aerogel: "Aerogel", glasswool: "Cam Yünü", pu: "Poliüretan", bare: "Yalıtımsız" },
            valves: { gate: "Sürgülü Vana", globe: "Glob Vana", ball: "Küresel Vana", butterfly: "Kelebek Vana", check: "Çekvalf", strainer: "Pislik Tutucu", flange: "Flanş Çifti", elbow: "Dirsek (90°)" },
            flat: "Düz Alan / Eşanjör", pipe: "Boru", uninsulated: "Yalıtımsız"
        },
        en: {
            btn_report: "Print Report", dash_roi: "Avg. ROI", dash_save: "Annual Savings", dash_inv: "Total Investment", dash_co2: "CO2 Reduction",
            sec_project: "Company & Project", lbl_prepared: "Prepared By", lbl_client: "Client Info",
            sec_params: "Parameters", lbl_tamb: "Amb. Temp (°C)", lbl_wind: "Wind (m/s)", lbl_hours: "Annual Hours", lbl_price: "Energy Unit Price",
            sec_add: "Add New Item", tab_valve: "Valve", tab_pipe: "Pipe", tab_flat: "Flat / Exch.",
            lbl_dims: "Dimensions (cm)", lbl_area: "Total Area:", lbl_tproc: "Fluid Temp (°C)", lbl_qty: "Qty", lbl_loc: "Location", btn_photo: "Add Photo",
            lbl_ins: "Insulation Jacket", btn_add: "Add to List", btn_update: "Update", lbl_repcurr: "Report Currency:", lbl_incl_qr: "Include QR",
            sec_list: "Calculation List", btn_clear: "Clear All", msg_empty: "No items added yet.",
            th_img: "Image", th_eq: "Equipment", th_qty: "Qty", th_bare: "Bare", th_ins: "Insulated", th_inv: "Invest.", th_save: "Saving", th_roi: "ROI", th_act: "Action",
            print_roi_lbl: "ESTIMATED ROI", print_months: "MONTHS", print_save_lbl: "ANNUAL SAVINGS",
            print_detail_title: "DETAILED AUDIT ANALYSIS", print_exec_sum: "EXECUTIVE SUMMARY", 
            print_loss_lbl: "CURRENT ANNUAL LOSS", print_net_save: "NET SAVINGS (YEARLY)",
            print_chart_title: "5-Year Projection", print_trees: "Tree Equivalent", lbl_env_impact: "ENVIRONMENTAL IMPACT", cov_subtitle: "Thermal loss analysis, ROI simulation and carbon footprint reporting.",
            print_disclaimer: "This report is based on ISO 12241 standards. Insulation on cooling lines not only saves energy but also prevents condensation and corrosion.", qr_cta: "Scan to track real-time energy waste wasted every second this investment is delayed.",
            mats: { rubber: "Elastomeric Rubber", aerogel: "Aerogel", glasswool: "Glass Wool", pu: "Polyurethane", bare: "Uninsulated" },
            valves: { gate: "Gate Valve", globe: "Globe Valve", ball: "Ball Valve", butterfly: "Butterfly Valve", check: "Check Valve", strainer: "Strainer", flange: "Flange Pair", elbow: "Elbow (90°)" },
            flat: "Flat Surface / HEX", pipe: "Pipe", uninsulated: "Uninsulated"
        }
    };

    let CUR_LANG = 'tr';
    function t(key){ return LANG_DATA[CUR_LANG][key] || key; }
    
    function toggleLang(){
        CUR_LANG = CUR_LANG === 'tr' ? 'en' : 'tr';
        document.getElementById('langDisplay').innerText = CUR_LANG.toUpperCase();
        applyLang();
    }
    function applyLang(){
        document.querySelectorAll('[data-t]').forEach(el => { el.innerText = t(el.getAttribute('data-t')); });
        fillValveList(); fillMatList(); render();
    }

    const PIPES={15:21.3,20:26.7,25:33.4,32:42.2,40:48.3,50:60.3,65:73.0,80:88.9,100:114.3,125:141.3,150:168.3,200:219.1,250:273.0,300:323.9,350:355.6,400:406.4,500:508.0};
    const MAT_DATA={ rubber:{k:0.034}, aerogel:{k:0.019}, glasswool:{k:0.032}, pu:{k:0.024}, bare:{k:25} };
    const VALVE_FACTORS={gate:1.2,globe:1.4,butterfly:0.6,ball:1.0,strainer:1.5,check:0.9,flange:0.4,elbow:0.3};
    
    // INITIAL FX WITH FALLBACKS
    let LIST=[], FX={USD:34.50, EUR:36.50, TL:1.0}, currImg=null, editingIndex=null, currentSurfaces=[];

    function initApp(){ 
        fillDN('vDN'); fillDN('pDN'); fillValveList(); fillMatList(); setType('valve');
        setTimeout(lucide.createIcons, 500); getFxSafe();
    }
    
    function fillValveList(){
        const sel = document.getElementById('valveType'); const oldVal = sel.value; sel.innerHTML = '';
        const dict = LANG_DATA[CUR_LANG].valves;
        for(const [k,v] of Object.entries(dict)){ let o = document.createElement('option'); o.value = k; o.text = v; sel.add(o); }
        if(oldVal) sel.value = oldVal;
    }
    function fillMatList(){
        const sel = document.getElementById('matSelect'); const oldVal = sel.value; sel.innerHTML = '';
        const dict = LANG_DATA[CUR_LANG].mats;
        for(const [k,v] of Object.entries(dict)){ let o = document.createElement('option'); o.value = k; o.text = v; if(k==='bare') o.classList.add('text-red-500','font-bold'); sel.add(o); }
        if(oldVal) sel.value = oldVal; else sel.value = 'rubber';
    }
    function fillDN(id){
        const el=document.getElementById(id); if(!el) return; el.innerHTML='';
        for(const[k,v]of Object.entries(PIPES)){ let o=document.createElement('option'); o.value=k; o.text=`DN ${k} (${v}mm)`; el.add(o); }
        if(id==='vDN') el.value='50'; if(id==='pDN') el.value='80'; 
    }
    function setType(t){
        ['valve','pipe','tank'].forEach(x=>{document.getElementById('g-'+x).classList.add('hidden');});
        document.getElementById('g-'+t).classList.remove('hidden'); document.getElementById('type').value=t;
        const btns = {valve: 'btn-valve', pipe: 'btn-pipe', tank: 'btn-tank'};
        Object.keys(btns).forEach(k => {
             const btn = document.getElementById(btns[k]);
             if(k === t) btn.className = "flex-1 py-1.5 text-[10px] font-bold rounded transition-all bg-white text-cyan-600 shadow border-cyan-200";
             else btn.className = "flex-1 py-1.5 text-[10px] font-bold rounded transition-all text-slate-500 hover:text-slate-900";
        });
        document.getElementById('qty').value = 1;
    }
    function addSurface(){
        const w = parseFloat(document.getElementById('surfW').value); const h = parseFloat(document.getElementById('surfH').value);
        if(!w || !h) return; currentSurfaces.push({w: w, h: h});
        document.getElementById('surfW').value = ''; document.getElementById('surfH').value = ''; renderSurfaces();
    }
    function removeSurface(idx){ currentSurfaces.splice(idx,1); renderSurfaces(); }
    function renderSurfaces(){
        const listEl = document.getElementById('surfaceList'); const totalEl = document.getElementById('totalSurfArea');
        listEl.innerHTML = ''; let totalAreaM2 = 0;
        currentSurfaces.forEach((s, idx) => {
            const m2 = (s.w * s.h) / 10000; totalAreaM2 += m2;
            const div = document.createElement('div');
            div.className = "flex justify-between items-center bg-white p-1.5 rounded border border-slate-200 text-[10px]";
            div.innerHTML = `<span>${s.w}x${s.h} cm</span> <button onclick="removeSurface(${idx})" class="text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button>`;
            listEl.appendChild(div);
        });
        totalEl.innerText = totalAreaM2.toFixed(3); lucide.createIcons();
    }
    function readImg(i){if(i.files&&i.files[0]){const r=new FileReader();r.onload=e=>{currImg=e.target.result;document.getElementById('prevImg').src=currImg;document.getElementById('prevImg').classList.remove('hidden');};r.readAsDataURL(i.files[0]);}}
    
    // SAFELY GET FX
    async function getFxSafe(){ 
        try{
            const r=await fetch('https://api.frankfurter.app/latest?from=USD&to=TRY'); const d=await r.json(); 
            if(d.rates.TRY) FX.USD=d.rates.TRY; 
            const r2=await fetch('https://api.frankfurter.app/latest?from=EUR&to=TRY'); const d2=await r2.json(); 
            if(d2.rates.TRY) FX.EUR=d2.rates.TRY;
            document.getElementById('fxVal').innerText=FX.USD.toFixed(2);
        }catch(e){ console.log("FX Fetch Failed, using default."); } 
    }
    function fmt(n){ return n.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

    function calc(){
        const type = document.getElementById('type').value;
        const qty = parseFloat(document.getElementById('qty').value) || 1;
        const tAmb = parseFloat(document.getElementById('tAmb').value) || 30;
        const tProc = parseFloat(document.getElementById('tProc').value) || 7;
        const vWindInput = document.getElementById('vWind').value;
        const vWind = (vWindInput === "" || isNaN(parseFloat(vWindInput))) ? 1 : parseFloat(vWindInput);
        const cop = parseFloat(document.getElementById('cop').value) || 3.5;
        const hours = parseFloat(document.getElementById('hours').value) || 5000;
        const priceVal = parseFloat(document.getElementById('price').value) || 0;
        const priceCurr = document.getElementById('energyCurr').value;
        const invUnit = parseFloat(document.getElementById('inv').value) || 0;
        const invCurr = document.getElementById('invCurr').value;
        const thk = parseFloat(document.getElementById('thk').value) || 19;
        const matKey = document.getElementById('matSelect').value;
        const location = document.getElementById('location').value;

        // Base Calculation always in TL
        let pRate = FX[priceCurr] || 1; 
        if(priceCurr === 'USD' && pRate === 1) pRate = 34.5; // Force fallback if 1
        if(priceCurr === 'EUR' && pRate === 1) pRate = 36.5;

        let iRate = FX[invCurr] || 1;
        if(invCurr === 'USD' && iRate === 1) iRate = 34.5;
        if(invCurr === 'EUR' && iRate === 1) iRate = 36.5;

        const priceTL = priceVal * pRate; 
        const invUnitTL = invUnit * iRate; 

        let surfaceArea = 0, name = "", dPipe = 0, unitLabel = "Adet", multiplier = 1, totalSurfM2 = 0;
        if(type === 'tank'){
            if(currentSurfaces.length === 0) { multiplier = 1; name = LANG_DATA[CUR_LANG].flat; unitLabel = "Set"; surfaceArea = 1; totalSurfM2 = 1; } 
            else { 
                currentSurfaces.forEach(s => totalSurfM2 += (s.w * s.h) / 10000); 
                surfaceArea = totalSurfM2; 
                name = LANG_DATA[CUR_LANG].flat; unitLabel = "Set"; 
            }
            dPipe = 1.0; 
        } else {
            const dnKey = (type==='valve') ? document.getElementById('vDN').value : document.getElementById('pDN').value;
            const mm = PIPES[dnKey] || 50; dPipe = mm / 1000; const perimeter = Math.PI * dPipe;
            if(type === 'pipe'){
                const len = parseFloat(document.getElementById('pLen').value) || 1;
                surfaceArea = perimeter * len; name = `${LANG_DATA[CUR_LANG].pipe} (DN ${dnKey})`; multiplier = len; unitLabel = "m";
            } else {
                const sel = document.getElementById('valveType');
                const vTypeName = LANG_DATA[CUR_LANG].valves[sel.value] || sel.value;
                name = `${vTypeName} (DN ${dnKey})`;
                let factor = VALVE_FACTORS[sel.value] || 1;
                surfaceArea = perimeter * (dPipe * 5 * factor); 
            }
        }
        
        const dT = Math.abs(tAmb - tProc);
        const U_bare = 25 + (2 * vWind); 
        const Q_watts_bare = U_bare * surfaceArea * dT * qty;
        let Q_watts_ins = 0;
        if(matKey === 'bare'){ Q_watts_ins = Q_watts_bare; } else {
            const k = MAT_DATA[matKey].k; const thkM = thk / 1000;
            if(type === 'tank') { const R_ins = thkM / k; Q_watts_ins = (surfaceArea * dT * qty) / (R_ins + (1/U_bare)); } 
            else {
                const totalLen = (type==='pipe' ? multiplier : (dPipe * 5 * (VALVE_FACTORS[document.getElementById('valveType').value]||1))) * qty;
                const D_in = dPipe; const D_out = dPipe + 2*thkM;
                Q_watts_ins = (2 * Math.PI * k * totalLen * dT) / Math.log(D_out/D_in);
            }
        }

        const kwh_bare = (Q_watts_bare * hours / 1000) / cop;
        const kwh_ins = (Q_watts_ins * hours / 1000) / cop;
        const kwh_save = Math.max(0, kwh_bare - kwh_ins);
        const money_save_tl = kwh_save * priceTL;
        let invTotal_tl = (type === 'pipe') ? invUnitTL * multiplier : invUnitTL * qty;
        let roiCalc = (money_save_tl > 0.01) ? (invTotal_tl / money_save_tl * 12) : 0;

        const rawData = { 
            type, qty, tAmb, tProc, vWind, cop, hours, priceVal, priceCurr, invUnit, invCurr, thk, matKey, location,
            vDN: document.getElementById('vDN').value, valveType: document.getElementById('valveType').value, 
            pDN: document.getElementById('pDN').value, pLen: document.getElementById('pLen').value, 
            surfaces: JSON.parse(JSON.stringify(currentSurfaces)), totalSurfM2
        };
        const matName = LANG_DATA[CUR_LANG].mats[matKey];
        const resultObj = {
            name, desc: matKey==='bare' ? LANG_DATA[CUR_LANG].uninsulated : `${matName} (${thk}mm)`,
            qty, unit: unitLabel, kwhBare: kwh_bare, kwhIns: kwh_ins, kwhSave: kwh_save, invTL: invTotal_tl, saveTL: money_save_tl, roi: roiCalc, img: currImg, raw: rawData
        };

        if(editingIndex !== null){
            LIST[editingIndex] = resultObj; editingIndex = null;
            document.getElementById('btnAdd').classList.remove('hidden'); document.getElementById('btnUpdate').classList.add('hidden');
        } else { LIST.push(resultObj); }
        resetForm(); render();
    }
    
    function finishUpdate(){ calc(); }
    function edit(idx){
        editingIndex = idx; const item = LIST[idx].raw;
        setType(item.type);
        document.getElementById('qty').value = item.qty; document.getElementById('tAmb').value = item.tAmb;
        document.getElementById('vWind').value = item.vWind; document.getElementById('cop').value = item.cop;
        document.getElementById('hours').value = item.hours; document.getElementById('price').value = item.priceVal;
        document.getElementById('energyCurr').value = item.priceCurr; document.getElementById('inv').value = item.invUnit;
        document.getElementById('invCurr').value = item.invCurr; document.getElementById('thk').value = item.thk;
        document.getElementById('matSelect').value = item.matKey;
        document.getElementById('location').value = item.location || "";
        if(item.type==='valve'){ document.getElementById('valveType').value=item.valveType; document.getElementById('vDN').value=item.vDN; }
        else if(item.type==='pipe'){ document.getElementById('pDN').value=item.pDN; document.getElementById('pLen').value=item.pLen; }
        else if(item.type==='tank'){ currentSurfaces = item.surfaces || []; renderSurfaces(); }
        document.getElementById('btnAdd').classList.add('hidden'); document.getElementById('btnUpdate').classList.remove('hidden');
    }
    function del(i){ if(confirm('Delete?')){ LIST.splice(i,1); render(); } }
    function clearAll(){ if(confirm('Clear All?')){ LIST=[]; render(); } }
    function resetForm(){ currImg=null; document.getElementById('prevImg').classList.add('hidden'); document.getElementById('inv').value=''; document.getElementById('location').value=''; currentSurfaces = []; renderSurfaces(); } 

    function render(){
        const tb = document.getElementById('gridBody'); tb.innerHTML = '';
        let totalInv=0, totalSave=0, totalCo2=0;
        
        const reportCurr = document.getElementById('curr').value;
        let reportRate = FX[reportCurr];
        if(!reportRate || (reportCurr !== 'TL' && reportRate <= 1.1)) {
            if(reportCurr === 'USD') reportRate = 34.50; else if(reportCurr === 'EUR') reportRate = 36.50; else reportRate = 1;
        }

        const currSymMap = {'USD':'$','EUR':'€','TL':'₺'};
        const currSym = currSymMap[reportCurr]||'';

        LIST.forEach((item, idx) => {
            const matNameRaw = item.raw.matKey; const matLabel = LANG_DATA[CUR_LANG].mats[matNameRaw];
            const desc = matNameRaw==='bare' ? LANG_DATA[CUR_LANG].uninsulated : `${matLabel} (${item.raw.thk}mm)`;
            let name = item.name;
            if(item.raw.type === 'tank') name = LANG_DATA[CUR_LANG].flat;
            if(item.raw.type === 'pipe') name = `${LANG_DATA[CUR_LANG].pipe} (DN ${item.raw.pDN})`;
            if(item.raw.type === 'valve') name = `${LANG_DATA[CUR_LANG].valves[item.raw.valveType]} (DN ${item.raw.vDN})`;

            // Mahal check
            const locText = item.raw.location ? `<div class="mt-0.5 text-[9px] font-medium text-slate-500 italic"><i class="w-2 h-2 inline mr-0.5" data-lucide="map-pin"></i>${item.raw.location}</div>` : '';

            const invDisp = item.invTL / reportRate;
            const saveDisp = item.saveTL / reportRate;
            totalInv += invDisp; totalSave += saveDisp; totalCo2 += (item.kwhSave * 0.44 / 1000); 
            const roiText = item.roi > 0 ? item.roi.toFixed(1) : "-";
            const imgHtml = item.img ? `<img src="${item.img}" class="w-8 h-8 object-cover rounded">` : `<div class="w-8 h-8 bg-slate-100 rounded flex items-center justify-center text-[8px] text-slate-400">-</div>`;
            
            tb.innerHTML += `
                <tr class="border-b border-slate-200 hover:bg-slate-50 transition ${idx===editingIndex ? 'bg-cyan-50' : ''}">
                    <td class="px-3 py-2 text-center">${imgHtml}</td>
                    <td class="px-3 py-2 font-medium text-slate-800">${name} ${locText}<div class="text-[9px] text-slate-400 mt-0.5">${desc}</div></td>
                    <td class="px-3 py-2 text-center text-slate-500">${item.qty} ${item.unit}</td>
                    <td class="px-3 py-2 text-center text-[10px] text-red-400 font-mono">${Math.round(item.kwhBare).toLocaleString()}</td>
                    <td class="px-3 py-2 text-center text-[10px] text-cyan-600 font-mono">${Math.round(item.kwhIns).toLocaleString()}</td>
                    <td class="px-3 py-2 text-right text-[10px] text-slate-600 font-mono">${currSym}${fmt(invDisp)}</td>
                    <td class="px-3 py-2 text-right text-[10px] text-green-600 font-bold font-mono">+${currSym}${fmt(saveDisp)}</td>
                    <td class="px-3 py-2 text-right text-[10px] font-bold text-cyan-600">${roiText}</td>
                    <td class="px-3 py-2 text-right flex gap-1 justify-end">
                        <button onclick="edit(${idx})" class="text-blue-500 hover:text-blue-700 p-1"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                        <button onclick="del(${idx})" class="text-red-500 hover:text-red-700 p-1"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                    </td>
                </tr>
            `;
        });
        if(LIST.length===0) tb.innerHTML = `<tr><td colspan="10" class="px-6 py-20 text-center text-slate-500 opacity-50">${t('msg_empty')}</td></tr>`;
        document.getElementById('dashInv').innerText = currSym + fmt(totalInv);
        document.getElementById('dashSave').innerText = currSym + fmt(totalSave);
        document.getElementById('dashCo2').innerHTML = totalCo2.toFixed(1) + ' <span class="text-sm font-normal text-slate-500">Ton</span>';
        const totalRoi = totalSave > 0 ? (totalInv / totalSave * 12) : 0;
        document.getElementById('dashRoi').innerText = totalRoi > 0 ? totalRoi.toFixed(1) : "---";
        lucide.createIcons();
    }

    let printTemplateCache = null;
    function printRep(){
        const printArea = document.getElementById('print-area');
        if(!printTemplateCache){ printTemplateCache = printArea.innerHTML; }
        printArea.innerHTML = printTemplateCache;
        applyLang();
        
        const reportCurr = document.getElementById('curr').value;
        let reportRate = FX[reportCurr];
        if(!reportRate || (reportCurr !== 'TL' && reportRate <= 1.1)) {
            if(reportCurr === 'USD') reportRate = 34.50; else if(reportCurr === 'EUR') reportRate = 36.50; else reportRate = 1;
        }

        const currSymMap = {'USD':'$','EUR':'€','TL':'₺'};
        const currSym = currSymMap[reportCurr]||'';
        const d = new Date().toLocaleDateString(CUR_LANG==='tr'?'tr-TR':'en-US');

        // QR LOGIC
        const isQr = document.getElementById('toggleQrInput').checked;
        const qrContainer = document.getElementById('cover-qr-container');
        if(isQr){
            qrContainer.classList.remove('hidden');
            // Mock dynamic URL for "Live Tracking"
            const uniqueUrl = `https://optimizi.app/live-tracker?id=${Date.now()}`;
            // Generate QR into hidden div first
            const qrGenDiv = document.getElementById('qrcode-gen');
            qrGenDiv.innerHTML = '';
            new QRCode(qrGenDiv, { text: uniqueUrl, width: 100, height: 100 });
            // Extract and set
            setTimeout(() => {
                const qrCanvas = qrGenDiv.querySelector('canvas');
                if(qrCanvas) {
                     document.getElementById('repQrImage').src = qrCanvas.toDataURL();
                }
            }, 100);
        } else {
            qrContainer.classList.add('hidden');
        }

        let gInv=0, gSave=0, gCo2=0;
        const computedList = LIST.map(i => {
            const iInv = i.invTL / reportRate; const iSave = i.saveTL / reportRate;
            gInv += iInv; gSave += iSave; gCo2 += (i.kwhSave * 0.44 / 1000);
            let name = i.name;
            if(i.raw.type === 'tank') name = LANG_DATA[CUR_LANG].flat;
            if(i.raw.type === 'pipe') name = `${LANG_DATA[CUR_LANG].pipe} (DN ${i.raw.pDN})`;
            if(i.raw.type === 'valve') name = `${LANG_DATA[CUR_LANG].valves[i.raw.valveType]} (DN ${i.raw.vDN})`;
            const matNameRaw = i.raw.matKey; const matLabel = LANG_DATA[CUR_LANG].mats[matNameRaw];
            const desc = matNameRaw==='bare' ? LANG_DATA[CUR_LANG].uninsulated : `${matLabel} (${i.raw.thk}mm)`;
            return { ...i, dispInv: iInv, dispSave: iSave, printName: name, printDesc: desc };
        });

        const ROWS_PER_PAGE = 12;
        const chunks = []; for (let i = 0; i < computedList.length; i += ROWS_PER_PAGE) { chunks.push(computedList.slice(i, i + ROWS_PER_PAGE)); } if(chunks.length === 0) chunks.push([]);
        
        const tablePageTemplate = document.getElementById('p-table');
        const summaryPage = document.getElementById('p-summary');
        tablePageTemplate.remove();
        summaryPage.classList.remove('hidden');

        const headers = LANG_DATA[CUR_LANG];
        const tableHeaderHTML = `
            <th class="w-10 text-center">#</th><th class="w-16 text-center">${headers.th_img}</th><th>${headers.th_eq}</th>
            <th class="text-center w-16">${headers.th_qty}</th><th class="text-center w-24 text-red-500">${headers.th_bare} (kWh)</th>
            <th class="text-center w-24 text-cyan-600">${headers.th_ins} (kWh)</th><th class="text-right font-black">${headers.th_inv}</th>
            <th class="text-right text-green-600 font-bold">${headers.th_save}</th><th class="text-right w-16">${headers.th_roi}</th>`;

        chunks.forEach((chunk, index) => {
            const newPage = tablePageTemplate ? tablePageTemplate.cloneNode(true) : document.createElement('div');
            newPage.id = ''; newPage.classList.remove('hidden');
            const titleEl = newPage.querySelector('h2'); if(titleEl) { titleEl.innerText = headers.print_detail_title; if(index > 0) titleEl.innerHTML += ` (${index+1})`; }
            const theadTr = newPage.querySelector('thead tr'); if(theadTr) theadTr.innerHTML = tableHeaderHTML;
            const tbody = newPage.querySelector('tbody');
            if(tbody){
                tbody.innerHTML = '';
                chunk.forEach((i, subIndex) => {
                    const roi = i.dispSave > 0 ? (i.dispInv/i.dispSave*12).toFixed(1) : "-";
                    const imgTag = i.img ? `<img src="${i.img}" class="w-10 h-10 object-cover border border-slate-200">` : `-`;
                    let surfaceDetails = "";
                    if(i.raw.type === 'tank') {
                        // Display TOTAL M2 instead of dimensions
                        surfaceDetails = `<div class="text-[9px] text-slate-400 font-mono mt-0.5">Total: ${i.raw.totalSurfM2.toFixed(3)} m²</div>`;
                    }
                    // Location in print
                    const locPrint = i.raw.location ? `<div class="text-[8px] text-slate-500 italic mt-0.5">${i.raw.location}</div>` : '';

                    tbody.innerHTML += `<tr>
                        <td class="text-center text-slate-400 font-bold">${(index*ROWS_PER_PAGE)+subIndex+1}</td>
                        <td class="text-center p-1">${imgTag}</td>
                        <td class="font-bold text-slate-800 text-[9px]">${i.printName} ${locPrint} ${surfaceDetails}<div class="font-normal text-slate-500">${i.printDesc}</div></td>
                        <td class="text-center text-[9px]">${i.qty} ${i.unit}</td>
                        <td class="text-center text-[9px] font-mono text-red-500">${Math.round(i.kwhBare).toLocaleString()}</td>
                        <td class="text-center text-[9px] font-mono text-cyan-600">${Math.round(i.kwhIns).toLocaleString()}</td>
                        <td class="text-right text-[10px] font-mono">${currSym}${fmt(i.dispInv)}</td>
                        <td class="text-right text-[10px] font-bold text-green-600 font-mono">+${currSym}${fmt(i.dispSave)}</td>
                        <td class="text-right text-[10px] font-bold text-blue-600">${roi}</td>
                    </tr>`;
                });
            }
            document.getElementById('print-area').insertBefore(newPage, summaryPage);
        });

        document.getElementById('covClient').innerText = document.getElementById('cName').value || "CLIENT";
        document.getElementById('covContact').innerText = document.getElementById('cEng').value || "";
        document.getElementById('covProv').innerText = document.getElementById('pName').value || "OPTIMIZI";
        document.getElementById('covDate').innerText = d;
        const totalRoi = gSave > 0 ? (gInv/gSave*12) : 0;
        document.getElementById('covRoi').innerText = totalRoi > 0 ? totalRoi.toFixed(1) : "---";
        document.getElementById('covSave').innerText = currSym + fmt(gSave);
        document.getElementById('covTemp').innerText = document.getElementById('tAmb').value;
        document.getElementById('covWind').innerText = document.getElementById('vWind').value; 
        document.getElementById('covCop').innerText = document.getElementById('cop').value;
        document.getElementById('covPrice').innerText = document.getElementById('price').value + " " + document.getElementById('energyCurr').value;
        document.getElementById('sumSave').innerText = currSym + fmt(gSave);
        document.getElementById('tabInv').innerText = currSym + fmt(gInv);
        document.getElementById('sumCo2').innerText = gCo2.toFixed(1);
        document.getElementById('dispTreeCount').innerText = Math.round(gCo2 / 0.02).toLocaleString();

        let totalBareCostTL = 0;
        const price = parseFloat(document.getElementById('price').value) || 0;
        let pRate = FX[document.getElementById('energyCurr').value] || 1;
        if(document.getElementById('energyCurr').value !== 'TL' && pRate === 1) pRate = 34.5;
        const priceTL = price * pRate;
        LIST.forEach(i => { totalBareCostTL += (i.kwhBare * priceTL); });
        document.getElementById('sumLoss').innerText = currSym + fmt(totalBareCostTL / reportRate);

        const totalProj = gSave * 5; 
        let chartHTML = `<div class="flex items-end justify-between h-full w-full gap-4">`;
        let currentCum = 0; const maxVal = totalProj > 0 ? totalProj : 1; 
        for(let y=1; y<=5; y++){
            currentCum += gSave; const hPct = (currentCum / maxVal) * 100;
            chartHTML += `
            <div class="flex flex-col items-center w-full h-full justify-end">
                <div class="w-full bg-cyan-${(y+1)*100} transition-all relative border border-white" style="height:${Math.max(hPct, 1)}%"> 
                    <div class="absolute -top-6 w-full text-center text-[10px] font-bold text-slate-600">${currSym}${Math.round(currentCum/1000)}k</div>
                </div>
                <div class="mt-2 text-[10px] font-bold text-slate-400 uppercase">${y}. ${CUR_LANG==='tr'?'YIL':'YR'}</div>
            </div>`;
        }
        chartHTML += `</div>`;
        document.getElementById('rep_proj_section').innerHTML = chartHTML;

        setTimeout(()=>{ window.print(); }, 500);
    }
</script>
  <script src="guard.js?v=2"></script>
</body>
</html>




