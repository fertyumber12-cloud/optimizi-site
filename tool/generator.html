<!doctype html>
<html lang="tr" class="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kazanç Takibi & Etiket | Optimizi.App</title>
<meta name="robots" content="noindex">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
<link rel="icon" href="../favicon.png" type="image/png">

<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'], mono: ['"JetBrains Mono"', 'monospace'] },
      extend: { colors: { slate: { 850: '#151e2e', 900: '#0f172a', 950: '#020617' } } }
    }
  }
</script>
<style>
    /* CSS Değişkenleri ile Tema Yönetimi */
    :root {
        --bg-body: #f1f5f9;
        --bg-glass: rgba(255, 255, 255, 0.8);
        --border-glass: rgba(0, 0, 0, 0.1);
        --input-bg: rgba(255, 255, 255, 0.7);
        --text-main: #0f172a;
        --text-muted: #64748b;
    }
    .dark {
        --bg-body: radial-gradient(ellipse at top, #1e1b4b 0%, #0f172a 40%, #020617 100%);
        --bg-glass: rgba(30, 41, 59, 0.6);
        --border-glass: rgba(255, 255, 255, 0.08);
        --input-bg: rgba(15, 23, 42, 0.6);
        --text-main: #f1f5f9;
        --text-muted: #94a3b8;
    }

    body { background: var(--bg-body); color: var(--text-main); min-height: 100vh; overflow-x: hidden; transition: background 0.3s ease; }
    
    .glass-card { background-color: var(--bg-glass); backdrop-filter: blur(16px); border: 1px solid var(--border-glass); transition: all 0.3s; }
    
    .glass-input { 
        border-radius: 0.75rem; padding: 0.75rem; width: 100%; 
        background-color: var(--input-bg); 
        border: 1px solid var(--border-glass); 
        color: var(--text-main); font-size: 0.75rem; transition: all 0.2s; 
    }
    .glass-input:focus { outline: none; border-color: #6366f1; background-color: rgba(99, 102, 241, 0.1); }
    
    /* GÜNCELLEME: Dark Modda Dropdown Seçeneklerinin Okunabilirliği İçin Fix */
    .dark option {
        background-color: #0f172a; /* Koyu Lacivert Arkaplan */
        color: #f1f5f9; /* Beyaz Yazı */
    }
    
    select.glass-input { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.75rem center; background-repeat: no-repeat; background-size: 1.2em 1.2em; padding-right: 2.5rem; }
    
    @media print {
        @page { size: A4; margin: 0; }
        body * { visibility: hidden; }
        #print-root, #print-root * { visibility: visible !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        #print-root { position: absolute; left: 0; top: 0; width: 210mm; margin: 0; padding: 0; display: block !important; background: white; }
        #app-container { display: none !important; }
        body { background: white !important; height: auto !important; }
        
        .a4-page { width: 210mm; height: 297mm; page-break-after: always; display: grid; grid-template-columns: repeat(5, 40mm); grid-template-rows: repeat(5, 49.5mm); align-content: start; justify-content: center; padding-top: 10mm; }
        
        .sticker { width: 40mm; height: 49.5mm; border: 1px dashed #ccc; box-sizing: border-box; padding: 3mm; display: flex; flex-direction: column; align-items: center; justify-content: space-between; background: white; color: black; overflow: hidden; }
        img { max-width: 100% !important; display: block !important; visibility: visible !important; }
    }

    #print-root { display: none; }
    #preview-wrapper { transform: scale(0.65); transform-origin: top center; width: 100%; display: flex; flex-direction: column; alignItems: center; }
    .a4-page { width: 210mm; height: 297mm; background: white; display: grid; grid-template-columns: repeat(5, 40mm); grid-template-rows: repeat(5, 49.5mm); box-shadow: 0 0 50px rgba(0,0,0,0.2); margin-bottom: 20px; }
    .sticker { width: 40mm; height: 49.5mm; border: 1px solid #e2e8f0; padding: 3mm; display: flex; flex-direction: column; align-items: center; justify-content: space-between; background: white; color: black; }
</style>
</head>
<body class="custom-scroll" onload="updateUI()">

    <div id="qr-engine" style="position:fixed; left:-9999px; top:0;"></div>

    <div id="app-container" class="max-w-7xl mx-auto flex flex-col gap-8 pb-20 p-6 no-print">
        
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="../index.html" class="flex items-center gap-1 group">
                    <h1 class="text-2xl font-bold text-slate-800 dark:text-white tracking-wide">Optimizi<span class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 to-blue-500 dark:from-cyan-400 dark:to-blue-400">.App</span></h1>
                </a>
                <div class="h-6 w-px bg-slate-300 dark:bg-white/10"></div>
                <div class="text-lg font-bold text-indigo-600 dark:text-indigo-400 tracking-wide uppercase">Kazanç Takibi</div>
            </div>
            
            <div class="flex items-center gap-4">
                <button onclick="toggleTheme()" class="p-2 rounded-lg bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-yellow-400 hover:scale-110 transition shadow-sm">
                    <i data-lucide="sun-moon" class="w-5 h-5"></i>
                </button>

                <div class="inline-flex items-center gap-2 px-4 py-2 bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-white/5 shadow-sm">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <span class="text-xs font-bold text-slate-600 dark:text-slate-300">SİSTEM AKTİF</span>
                </div>
            </div>
        </div>

        <div class="glass-card p-6 rounded-2xl">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                
                <div class="lg:col-span-1 space-y-4 border-r border-slate-200 dark:border-white/5 pr-6">
                    <h3 class="text-indigo-600 dark:text-indigo-400 text-xs font-bold uppercase mb-4 flex items-center gap-2"><i data-lucide="folder-open" class="w-4 h-4"></i> Proje Bilgileri</h3>
                    <div>
                        <label class="text-[10px] text-slate-500 dark:text-slate-500 font-bold uppercase mb-1 block">Müşteri / Firma Adı</label>
                        <input type="text" id="cName" class="glass-input text-xs" placeholder="Firma Adı Giriniz...">
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-500 dark:text-slate-500 font-bold uppercase mb-1 block">Lokasyon / Mahal</label>
                        <input type="text" id="locName" class="glass-input text-xs font-bold text-yellow-600 dark:text-yellow-400" placeholder="Örn: Kazan Dairesi">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-[10px] text-slate-500 dark:text-slate-500 font-bold uppercase mb-1 block">Tarih</label>
                            <input type="date" id="iDate" class="glass-input text-xs">
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 dark:text-slate-500 font-bold uppercase mb-1 block text-indigo-500 dark:text-indigo-300">Sipariş / İş No</label>
                            <input type="text" id="orderNo" class="glass-input text-xs font-bold text-slate-800 dark:text-white border-indigo-500/50" value="943">
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-3">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-indigo-600 dark:text-indigo-400 text-xs font-bold uppercase flex items-center gap-2"><i data-lucide="calculator" class="w-4 h-4"></i> Enerji & ROI Hesabı (ISO 12241)</h3>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="space-y-3">
                            <div>
                                <label id="lblQty" class="text-[10px] text-slate-500 font-bold uppercase mb-1 block text-green-600 dark:text-green-400">Adet</label>
                                <input type="number" id="qty" class="glass-input text-xs font-bold text-slate-800 dark:text-white border-green-500/30" value="1" min="1" oninput="updateLiveCalc()">
                            </div>
                            
                            <div>
                                <label class="text-[10px] text-slate-500 font-bold uppercase mb-1 block">Ekipman Tipi</label>
                                <select id="equipType" onchange="updateUI()" class="glass-input text-xs">
                                    <option value="valve">Vana / Armatür</option>
                                    <option value="pipe">Boru Hattı</option>
                                    <option value="flat">Düz Yüzey / Tank</option>
                                </select>
                            </div>

                            <div id="rowValveType" class="hidden">
                                <label class="text-[10px] text-slate-500 font-bold uppercase mb-1 block">Armatür Tipi</label>
                                <select id="valveType" class="glass-input text-xs" onchange="updateLiveCalc()">
                                    <optgroup label="Vanalar">
                                        <option value="gate">Sürgülü Vana</option>
                                        <option value="globe">Globe Vana</option>
                                        <option value="butterfly">Kelebek Vana</option>
                                        <option value="ball">Küresel Vana</option>
                                        <option value="strainer">Pislik Tutucu</option>
                                        <option value="check">Çekvalf</option>
                                        <option value="separator">Buhar Seperatörü</option>
                                    </optgroup>
                                    <optgroup label="Bağlantı Elemanları">
                                        <option value="flange">Flanş Çifti (Takım)</option>
                                        <option value="elbow">Dirsek (90°)</option>
                                    </optgroup>
                                    <optgroup label="Kondenstoplar">
                                        <option value="trap_float">Şamandıralı</option>
                                        <option value="trap_thermo">Termodinamik</option>
                                        <option value="trap_bimetal">Bimetalik</option>
                                        <option value="trap_bucket">Ters Kovalı</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <div id="rowDn">
                                <label class="text-[10px] text-slate-500 font-bold uppercase mb-1 block">Çap (DN)</label>
                                <select id="dn" class="glass-input text-xs font-mono">
                                    <option value="15">DN15</option><option value="20">DN20</option>
                                    <option value="25">DN25</option><option value="32">DN32</option>
                                    <option value="40">DN40</option><option value="50">DN50</option>
                                    <option value="65">DN65</option><option value="80">DN80</option>
                                    <option value="100" selected>DN100</option><option value="125">DN125</option>
                                    <option value="150">DN150</option><option value="200">DN200</option>
                                    <option value="250">DN250</option><option value="300">DN300</option>
                                    <option value="350">DN350</option><option value="400">DN400</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-500 font-bold uppercase mb-1 block">Yalıtım Tipi</label>
                                <select id="mat" class="glass-input text-xs">
                                    <option value="needlemat" selected>İğnelenmiş Cam Elyaf</option>
                                    <option value="rockwool">Taşyünü (Sanayi)</option>
                                    <option value="ceramic">Seramik Yünü</option>
                                    <option value="aerogel">Aerogel</option>
                                    <option value="rubber">Elastomerik Kauçuk</option>
                                </select>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <div>
                                <label class="text-[10px] text-slate-500 font-bold uppercase mb-1 block">Yalıtım (mm)</label>
                                <input type="number" id="thk" class="glass-input text-xs" value="50">
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-500 font-bold uppercase mb-1 block">Yüzey Sıc. (°C)</label>
                                <div class="relative">
                                    <input type="number" id="temp" class="glass-input text-xs pl-8 text-red-600 dark:text-red-400 font-bold" value="160">
                                    <i data-lucide="thermometer" class="w-3 h-3 text-red-600 dark:text-red-400 absolute left-2.5 top-2.5"></i>
                                </div>
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-500 font-bold uppercase mb-1 block text-blue-500 dark:text-blue-300">Ortam Sıc. (°C)</label>
                                <div class="relative">
                                    <input type="number" id="tAmb" class="glass-input text-xs pl-8 text-blue-600 dark:text-blue-300 font-bold border-blue-500/30" value="25">
                                    <i data-lucide="sun" class="w-3 h-3 text-blue-600 dark:text-blue-300 absolute left-2.5 top-2.5"></i>
                                </div>
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-500 font-bold uppercase mb-1 block text-cyan-600 dark:text-cyan-400">Rüzgar (m/s)</label>
                                <div class="relative">
                                    <input type="number" id="wind" class="glass-input text-xs pl-8 text-cyan-600 dark:text-cyan-400 font-bold border-cyan-500/30" value="0" min="0" step="0.5">
                                    <i data-lucide="wind" class="w-3 h-3 text-cyan-600 dark:text-cyan-400 absolute left-2.5 top-2.5"></i>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-3">
                             <div>
                                <label class="text-[10px] text-slate-500 font-bold uppercase mb-1 block">Yakıt Tipi</label>
                                <select id="fuel" class="glass-input text-xs" onchange="updateFuelUnit()">
                                    <option value="gas">Doğalgaz</option>
                                    <option value="elec">Elektrik</option>
                                    <option value="lng">LNG</option>
                                    <option value="fueloil">Fuel Oil</option>
                                    <option value="coal_imp">İthal Kömür</option>
                                    <option value="coal_loc">Yerli Kömür</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-500 font-bold uppercase mb-1 block">Birim Fiyat <span id="uUnit" class="text-slate-500 font-normal ml-1 normal-case">(TL)</span></label>
                                <input type="number" id="price" class="glass-input text-xs" value="10">
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-500 font-bold uppercase mb-1 block">Saat/Yıl</label>
                                <input type="number" id="hours" class="glass-input text-xs" value="8000">
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-500 font-bold uppercase mb-1 block text-orange-600 dark:text-orange-400">Kazan Verimi (%)</label>
                                <input type="number" id="eff" class="glass-input text-xs font-bold text-orange-600 dark:text-orange-400 border-orange-500/30" value="85" max="100" min="10">
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-4 bg-white/50 dark:bg-slate-900/50 p-4 rounded-xl border border-slate-200 dark:border-white/5 transition-colors">
                        <div class="flex-1">
                            <div class="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1">Hesaplanan Toplam Yıllık Kazanç</div>
                            <div class="text-3xl font-black text-indigo-600 dark:text-indigo-400 tracking-tight"><span id="liveSave">0</span> <span class="text-sm font-medium text-slate-500">TL / Yıl</span></div>
                        </div>
                        <button onclick="addToQueue()" id="btnAdd" class="bg-gradient-to-r from-indigo-600 to-indigo-500 hover:from-indigo-500 hover:to-indigo-400 text-white font-bold py-4 px-10 rounded-xl transition shadow-lg shadow-indigo-600/20 flex items-center gap-2 active:scale-95 cursor-pointer">
                            <i data-lucide="plus-circle" class="w-5 h-5"></i>
                            <div class="text-left leading-none">
                                <div class="text-[10px] opacity-80 font-normal">ONAYLA</div>
                                <div class="text-sm">Listeye Ekle (Tek Etiket)</div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1">
                <div class="glass-card rounded-xl overflow-hidden flex flex-col h-[600px] border-t-4 border-t-slate-500">
                    <div class="p-4 border-b border-slate-200 dark:border-white/10 bg-slate-100 dark:bg-slate-800/80 flex justify-between items-center">
                        <h3 class="text-xs font-bold text-slate-700 dark:text-white uppercase flex items-center gap-2"><i data-lucide="list"></i> Liste</h3>
                        <button onclick="clearList()" class="text-[10px] text-red-500 dark:text-red-400 hover:text-red-700 dark:hover:text-white transition">Temizle</button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-2 space-y-2 custom-scroll bg-slate-50 dark:bg-slate-900/50" id="queueList">
                        <div class="flex flex-col items-center justify-center h-full text-slate-500 opacity-50">
                            <i data-lucide="box" class="w-12 h-12 mb-2"></i>
                            <span class="text-xs">Liste Boş</span>
                        </div>
                    </div>

                    <div class="p-4 border-t border-slate-200 dark:border-white/10 bg-white dark:bg-slate-900 space-y-2">
                        <button onclick="addProjectTotalSticker()" class="w-full bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-white font-bold py-3 rounded-lg text-xs transition border border-transparent dark:border-white/10 flex items-center justify-center gap-2 cursor-pointer">
                            <i data-lucide="sigma" class="w-4 h-4 text-yellow-600 dark:text-yellow-400"></i> LİSTE TOPLAMI İÇİN ETİKET EKLE
                        </button>

                        <button onclick="printLabels()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-xl text-sm transition shadow-lg shadow-green-500/20 flex items-center justify-center gap-2 cursor-pointer">
                            <i data-lucide="printer" class="w-5 h-5"></i> ETİKETLERİ YAZDIR
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="glass-card rounded-xl overflow-hidden h-[600px] border-t-4 border-t-slate-500 flex flex-col">
                    <div class="p-4 border-b border-slate-200 dark:border-white/10 bg-slate-100 dark:bg-slate-800/80">
                        <h3 class="text-xs font-bold text-slate-700 dark:text-white uppercase flex items-center gap-2"><i data-lucide="eye"></i> Baskı Önizleme (A4)</h3>
                    </div>
                    <div class="flex-1 overflow-auto bg-slate-200 dark:bg-slate-700/50 p-8 flex justify-center items-start custom-scroll">
                        <div id="preview-wrapper">
                            <div class="text-slate-400 text-sm mt-20 text-center opacity-50">
                                Listeye ürün eklediğinizde<br>etiketler burada görünecek.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="print-root"></div>

<script>
    lucide.createIcons();
    document.getElementById('iDate').valueAsDate = new Date();

    let STICKER_QUEUE = [];
    
    // --- SABİTLER ---
    const PIPES = { 15:21.3, 20:26.7, 25:33.4, 32:42.2, 40:48.3, 50:60.3, 65:73.0, 80:88.9, 100:114.3, 125:141.3, 150:168.3, 200:219.1, 250:273.0, 300:323.9, 350:355.6, 400:406.4 };
    
    const SEPARATORS = {15:0.15, 20:0.18, 25:0.22, 32:0.28, 40:0.35, 50:0.45, 65:0.60, 80:0.75, 100:1.10, 125:1.45, 150:1.90, 200:2.80};

    const VALVE_FACTORS = {
        gate: 1.2, globe: 1.4, butterfly: 0.6, ball: 1.0, strainer: 1.5, check: 0.9,
        trap_float: 1.6, trap_thermo: 0.8, trap_bimetal: 1.0, trap_bucket: 1.5,
        flange: 0.35
    };

    const MATS = { 
        needlemat: {a:0.033, b:0.00018}, 
        rockwool: {a:0.035, b:0.00017}, 
        glasswool: {a:0.032, b:0.00015}, 
        ceramic: {a:0.06, b:0.0002}, 
        aerogel: {a:0.018, b:0.00005},
        // GÜNCELLEME: Elastomerik Kauçuk Katsayıları
        rubber: {a:0.034, b:0.00010}
    };
    
    const FUELS = {
        gas: 9.59, elec: 1.0, lng: 13.37, fueloil: 11.16, coal_imp: 6.98, coal_loc: 4.07
    };

    document.querySelectorAll('#dn, #mat, #temp, #tAmb, #thk, #price, #hours, #fuel, #eff, #qty, #wind').forEach(el => {
        el.addEventListener('input', updateLiveCalc);
    });

    function toggleTheme() {
        const html = document.documentElement;
        html.classList.toggle('dark');
    }

    function updateUI() {
        const type = document.getElementById('equipType').value;
        const rowValve = document.getElementById('rowValveType');
        const rowDn = document.getElementById('rowDn');
        const lblQty = document.getElementById('lblQty');

        rowValve.classList.add('hidden');
        rowDn.classList.remove('hidden');

        if(type === 'valve') {
            rowValve.classList.remove('hidden');
            lblQty.innerText = "Adet";
            lblQty.className = "text-[10px] text-slate-500 font-bold uppercase mb-1 block text-green-600 dark:text-green-400";
        } else if (type === 'pipe') {
            lblQty.innerText = "Uzunluk (Metre)";
            lblQty.className = "text-[10px] text-slate-500 font-bold uppercase mb-1 block text-blue-600 dark:text-blue-400";
        } else if (type === 'flat') {
            rowDn.classList.add('hidden');
            lblQty.innerText = "Alan (m²)";
            lblQty.className = "text-[10px] text-slate-500 font-bold uppercase mb-1 block text-yellow-600 dark:text-yellow-400";
        }
        
        updateLiveCalc();
    }

    function updateFuelUnit() {
        const f = document.getElementById('fuel').value;
        const uMap = {
            gas:'TL/m³', elec:'TL/kWh', lng:'TL/kg', fueloil:'TL/kg', 
            coal_imp:'TL/kg', coal_loc:'TL/kg'
        };
        document.getElementById('uUnit').innerText = `(${uMap[f] || 'TL'})`;
        updateLiveCalc();
    }

    function getK(matKey, T) {
        const m = MATS[matKey] || MATS.needlemat;
        return m.a + (m.b * T);
    }

    function calculateSavingsUnit() {
        const equipType = document.getElementById('equipType').value;
        const dn = document.getElementById('dn').value;
        const mm = PIPES[dn] || 114.3;
        const dPipe = mm / 1000;
        const tProc = parseFloat(document.getElementById('temp').value) || 0;
        const tAmb = parseFloat(document.getElementById('tAmb').value) || 25; 
        const thk = parseFloat(document.getElementById('thk').value) / 1000 || 0.05;
        const mat = document.getElementById('mat').value;
        const price = parseFloat(document.getElementById('price').value) || 0;
        const hours = parseFloat(document.getElementById('hours').value) || 0;
        const fuelType = document.getElementById('fuel').value;
        const eff = parseFloat(document.getElementById('eff').value) / 100 || 0.85; 
        const LHV = FUELS[fuelType] || 10;
        
        const wind = parseFloat(document.getElementById('wind').value) || 0;
        const h_base_static = 10;
        const h_wind_effect = wind * 3.5; 
        const h_total_coeff = h_base_static + h_wind_effect;

        const h_bare = h_total_coeff + (tProc - tAmb) * 0.05; 
        const A_bare = Math.PI * dPipe; 
        const Q_bare = h_bare * A_bare * (tProc - tAmb);

        const T_mean = (tProc + tAmb) / 2;
        const k = getK(mat, T_mean);
        const dOut = dPipe + 2*thk;
        const R_ins = Math.log(dOut / dPipe) / (2 * Math.PI * k);
        const h_out = h_total_coeff; 
        const R_surf = 1 / (h_out * Math.PI * dOut);
        const Q_ins = (tProc - tAmb) / (R_ins + R_surf);

        const Q_save_meter = Q_bare - Q_ins;
        
        let multiplier = 1.0;
        
        if (equipType === 'valve') {
            const vType = document.getElementById('valveType').value;
            if(vType === 'separator') {
                const sepArea = SEPARATORS[dn] || 0.5;
                const pipeAreaPerMeter = Math.PI * dPipe;
                multiplier = sepArea / pipeAreaPerMeter;
            } else if(vType === 'elbow') {
                multiplier = 2.36 * dPipe; 
            } else {
                multiplier = VALVE_FACTORS[vType] || 1.2;
            }
        } else if (equipType === 'pipe') {
            multiplier = 1.0; 
        } else if (equipType === 'flat') {
            const Q_flat_bare = h_bare * (tProc - tAmb); 
            const R_flat_ins = thk / k;
            const Q_flat_ins = (tProc - tAmb) / (R_flat_ins + (1/h_out));
            const Q_save_m2 = Q_flat_bare - Q_flat_ins;
            const Energy_Saved_kWh_Flat = (Q_save_m2 * hours) / 1000;
            const Fuel_Saved_Amount = Energy_Saved_kWh_Flat / (LHV * eff);
            return Math.max(0, Fuel_Saved_Amount * price);
        }

        const Energy_Saved_kWh = (Q_save_meter * multiplier * hours) / 1000;
        const Fuel_Saved_Amount = Energy_Saved_kWh / (LHV * eff);
        const Money_Saved = Fuel_Saved_Amount * price;

        return Math.max(0, Money_Saved);
    }

    function updateLiveCalc() {
        const unitVal = calculateSavingsUnit();
        const qty = parseFloat(document.getElementById('qty').value) || 1;
        const totalVal = unitVal * qty;
        document.getElementById('liveSave').innerText = Math.round(totalVal).toLocaleString();
    }

    function generateQRImage(text) {
        return new Promise((resolve) => {
            const engine = document.getElementById('qr-engine');
            engine.innerHTML = '';
            
            new QRCode(engine, {
                text: text, width: 200, height: 200,
                colorDark : "#000000", colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.M
            });

            setTimeout(() => {
                const canvas = engine.querySelector('canvas');
                const img = engine.querySelector('img');
                if(canvas) resolve(canvas.toDataURL("image/png"));
                else if(img) resolve(img.src);
                else resolve(''); 
            }, 100); 
        });
    }

    async function addToQueue() {
        const locName = document.getElementById('locName').value || "";
        const cName = document.getElementById('cName').value || "Müşteri";
        const dateStr = document.getElementById('iDate').value;
        const orderNo = document.getElementById('orderNo').value || "1001";
        
        const qty = parseFloat(document.getElementById('qty').value) || 1;
        const type = document.getElementById('equipType').value;
        const dn = document.getElementById('dn').value;
        
        let autoProductName = "";
        
        if(type === 'valve') {
            const vTypeEl = document.getElementById('valveType');
            const vTypeText = vTypeEl.options[vTypeEl.selectedIndex].text;
            autoProductName = `DN${dn} ${vTypeText}`;
        } else if (type === 'pipe') {
            autoProductName = `DN${dn} Boru Hattı`;
        } else if (type === 'flat') {
            autoProductName = `Düz Yüzey / Tank`;
        }

        const finalPName = locName ? `${locName} - ${autoProductName}` : autoProductName;

        let qtyText = "";
        if(type === 'valve') qtyText = `(${qty} Adet)`;
        else if(type === 'pipe') qtyText = `(${qty} m)`;
        else qtyText = `(${qty} m²)`;

        const savingUnit = calculateSavingsUnit();
        const totalSaving = savingUnit * qty; 
        
        const subIndex = STICKER_QUEUE.length + 1;
        const uniqueID = `${orderNo}-${subIndex}`;

        const fType = document.getElementById('fuel').value; 
        const uPrice = document.getElementById('price').value;

        const trackUrl = `https://www.optimizi.app/track.html?p=${encodeURIComponent(finalPName)}&s=${uniqueID}&d=${dateStr}&v=${totalSaving.toFixed(2)}&c=${encodeURIComponent(cName)}&f=${fType}&up=${uPrice}`;

        const btn = document.getElementById('btnAdd');
        const oldText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `<div class="animate-spin mr-2">⏳</div> QR Oluşuyor...`;

        const qrBase64 = await generateQRImage(trackUrl);

        STICKER_QUEUE.push({
            id: uniqueID, name: finalPName, client: cName, date: dateStr,
            saving: totalSaving, qtyLabel: qtyText, qrImg: qrBase64
        });

        renderAll();
        btn.disabled = false;
        btn.innerHTML = oldText;
    }

    async function addProjectTotalSticker() {
        if(STICKER_QUEUE.length === 0) { alert("Liste boş!"); return; }

        let grandTotal = 0;
        STICKER_QUEUE.forEach(item => { if(!item.isSpecial) grandTotal += item.saving; });

        const cName = document.getElementById('cName').value || "GENEL";
        const orderNo = document.getElementById('orderNo').value || "GENEL";
        const dateStr = document.getElementById('iDate').value;
        const uniqueID = `${orderNo}-TOTAL`;
        const pName = "SİPARİŞ GENEL TOPLAM";
        
        const fType = document.getElementById('fuel').value; 
        const uPrice = document.getElementById('price').value;

        const trackUrl = `https://www.optimizi.app/track.html?p=${encodeURIComponent(pName)}&s=${uniqueID}&d=${dateStr}&v=${grandTotal.toFixed(2)}&c=${encodeURIComponent(cName)}&f=${fType}&up=${uPrice}`;
        
        const qrBase64 = await generateQRImage(trackUrl);

        STICKER_QUEUE.push({
            id: uniqueID, name: pName, client: cName, date: dateStr,
            saving: grandTotal, qtyLabel: "(TÜM LİSTE)", qrImg: qrBase64, isSpecial: true 
        });

        renderAll();
        const listEl = document.getElementById('queueList');
        listEl.scrollTop = listEl.scrollHeight;
    }

    function renderAll() {
        renderQueueList();
        renderStickers('print-root'); 
        const printRootHTML = document.getElementById('print-root').innerHTML;
        document.getElementById('preview-wrapper').innerHTML = printRootHTML || '<div class="text-slate-400 text-sm mt-20 opacity-50">Liste boş.</div>';
    }

    function renderQueueList() {
        const el = document.getElementById('queueList');
        el.innerHTML = '';
        if(STICKER_QUEUE.length === 0) {
            el.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-slate-500 opacity-50"><i data-lucide="box" class="w-12 h-12 mb-2"></i><span class="text-xs">Liste Boş</span></div>';
            lucide.createIcons(); return;
        }

        STICKER_QUEUE.slice().reverse().forEach((item, index) => {
            const originalIndex = STICKER_QUEUE.length - 1 - index;
            const bgClass = item.isSpecial 
                ? "bg-indigo-100 dark:bg-indigo-900/40 border-indigo-500/30" 
                : "bg-white dark:bg-slate-700/50 border-slate-200 dark:border-white/5";
            
            const textClass = "text-slate-800 dark:text-white";

            el.innerHTML += `
                <div class="flex justify-between items-center ${bgClass} p-2 rounded border text-[10px] group hover:bg-slate-50 dark:hover:bg-slate-700 transition shadow-sm">
                    <div>
                        <div class="text-indigo-600 dark:text-indigo-400 font-mono font-bold">${item.id}</div>
                        <div class="${textClass} font-bold truncate w-32">${item.name} <span class="text-slate-500 dark:text-slate-400 font-normal">${item.qtyLabel}</span></div>
                    </div>
                    <div class="text-right">
                        <div class="text-green-600 dark:text-green-400 font-bold">${Math.round(item.saving).toLocaleString()} TL</div>
                        <button onclick="removeItem(${originalIndex})" class="text-red-500 dark:text-red-400 hover:text-red-700 dark:hover:text-white text-[9px] underline mt-1 cursor-pointer">Sil</button>
                    </div>
                </div>
            `;
        });
        lucide.createIcons();
    }

    function removeItem(idx) { STICKER_QUEUE.splice(idx, 1); renderAll(); }
    function clearList() { if(confirm("Temizle?")) { STICKER_QUEUE = []; renderAll(); } }

    function renderStickers(targetId) {
        const container = document.getElementById(targetId);
        container.innerHTML = ''; 
        if (STICKER_QUEUE.length === 0) return;

        let page = document.createElement('div');
        page.className = 'a4-page';
        let count = 0;

        STICKER_QUEUE.forEach((item) => {
            if (count > 0 && count % 25 === 0) {
                container.appendChild(page);
                page = document.createElement('div');
                page.className = 'a4-page';
            }
            const sticker = document.createElement('div');
            sticker.className = 'sticker';
            sticker.innerHTML = `
                <div style="width:100%; text-align:center; border-bottom:1px solid #000; padding-bottom:2px; margin-bottom:2px; display:flex; justify-content:space-between; align-items:flex-end;">
                    <div style="font-weight:900; font-size:11px; letter-spacing:0.5px;">INSPRO</div>
                    <div style="font-size:7px; font-weight:bold;">${item.id}</div>
                </div>
                <div style="margin:2px 0;"><img src="${item.qrImg}" style="width:90px; height:90px; display:block;"></div>
                <div style="width:100%; text-align:left; font-size:7px; line-height:1.2;">
                    <div style="font-weight:bold; font-size:8px; overflow:hidden; white-space:nowrap; margin-bottom:1px;">${item.name} <span style="font-weight:normal;">${item.qtyLabel}</span></div>
                    <div style="border-top:1px solid #ccc; padding-top:2px; display:flex; justify-content:space-between;">
                        <span>Ref: ${item.client.substring(0,10)}</span>
                        <span>Date: ${item.date}</span>
                    </div>
                    <div style="margin-top:2px; font-weight:bold; text-align:center; background:#eee; padding:1px;">SCAN FOR SAVINGS</div>
                </div>
            `;
            page.appendChild(sticker);
            count++;
        });
        container.appendChild(page);
    }

    function printLabels() { if(STICKER_QUEUE.length === 0) { alert("Liste boş!"); return; } window.print(); }

    updateFuelUnit();
    updateUI();
</script>
</body>
</html>
