<!doctype html>
<html lang="tr" class="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kazanç Takibi & Etiket | Optimizi.App</title>
<meta name="robots" content="noindex">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
<link rel="icon" href="../favicon.png" type="image/png">

<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'], mono: ['"JetBrains Mono"', 'monospace'] },
      extend: { colors: { slate: { 850: '#151e2e', 900: '#0f172a', 950: '#020617' } } }
    }
  }
</script>
<style>
  body { background: radial-gradient(ellipse at top, #1e1b4b 0%, #0f172a 40%, #020617 100%); color: #f1f5f9; min-height: 100vh; overflow-x: hidden; }
  .glass-card { background-color: rgba(30, 41, 59, 0.6); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); }
  .glass-input { border-radius: 0.5rem; padding: 0.75rem; width: 100%; background-color: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.1); color: white; font-size: 0.9rem; transition: all 0.2s; }
  .glass-input:focus { border-color: #6366f1; outline: none; background-color: rgba(15, 23, 42, 1); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
  
  select.glass-input { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.75rem center; background-repeat: no-repeat; background-size: 1.2em 1.2em; padding-right: 2.5rem; }

  /* --- BASKI STİLLERİ (ZORUNLU) --- */
  @media print {
    @page { size: A4; margin: 0; }
    
    /* Her şeyi gizle */
    body * { visibility: hidden; }
    
    /* Sadece Print Root'u göster */
    #print-root, #print-root * { 
        visibility: visible !important;
        -webkit-print-color-adjust: exact; 
        print-color-adjust: exact;
    }
    
    #print-root {
        position: absolute;
        left: 0;
        top: 0;
        width: 210mm;
        margin: 0;
        padding: 0;
        display: block !important;
        background: white;
    }

    /* Gereksizleri uçur */
    #app-container, .glass-card, nav, header { display: none !important; }
    
    body { background: white !important; overflow: visible !important; height: auto !important; }
    
    .a4-page {
        width: 210mm;
        height: 297mm;
        page-break-after: always;
        display: grid;
        grid-template-columns: repeat(5, 40mm);
        grid-template-rows: repeat(6, 49.5mm);
        align-content: start;
        justify-content: center;
        padding-top: 10mm;
    }

    .sticker {
        width: 40mm;
        height: 49.5mm;
        border: 1px dashed #ccc;
        box-sizing: border-box;
        padding: 3mm;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        background: white;
        color: black;
        overflow: hidden;
    }
    
    /* Resimlerin (QR Kodların) görünürlüğünü zorla */
    img { max-width: 100% !important; display: block !important; visibility: visible !important; }
  }

  /* Ekranda Gizli */
  #print-root { display: none; }
  
  /* Önizleme */
  #preview-wrapper { transform: scale(0.65); transform-origin: top center; width: 100%; display: flex; flex-direction: column; alignItems: center; }
  .a4-page { width: 210mm; height: 297mm; background: white; display: grid; grid-template-columns: repeat(5, 40mm); grid-template-rows: repeat(6, 49.5mm); box-shadow: 0 0 50px rgba(0,0,0,0.5); margin-bottom: 20px; }
  .sticker { width: 40mm; height: 49.5mm; border: 1px solid #e2e8f0; padding: 3mm; display: flex; flex-direction: column; align-items: center; justify-content: space-between; background: white; color: black; }

</style>
</head>
<body class="custom-scroll">

    <div id="qr-engine" style="position:fixed; left:-9999px; top:0;"></div>

    <div id="app-container" class="max-w-7xl mx-auto flex flex-col gap-8 pb-20 p-6 no-print">
        
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="../index.html" class="flex items-center gap-1 group">
                    <h1 class="text-2xl font-bold text-white tracking-wide">Optimizi<span class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-400">.App</span></h1>
                </a>
                <div class="h-6 w-px bg-white/10"></div>
                <div class="text-lg font-bold text-indigo-400 tracking-wide uppercase">Kazanç Takibi</div>
            </div>
            
            <div class="inline-flex items-center gap-2 px-4 py-2 bg-slate-800 rounded-lg border border-white/5">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <span class="text-xs font-bold text-slate-300">SİSTEM AKTİF</span>
            </div>
        </div>

        <div class="glass-card p-6 rounded-2xl border-t-4 border-t-indigo-500">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                
                <div class="lg:col-span-1 space-y-4 border-r border-white/5 pr-6">
                    <h3 class="text-xs font-bold text-indigo-400 uppercase mb-2 flex items-center gap-2"><i data-lucide="folder-open"></i> Proje Bilgileri</h3>
                    <div>
                        <label class="text-[10px] text-slate-400 block mb-1 font-bold">Müşteri / Firma Adı</label>
                        <input type="text" id="cName" class="glass-input" placeholder="Firma Adı Giriniz...">
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-400 block mb-1 font-bold">Ürün Etiketi (Lokasyon)</label>
                        <input type="text" id="pName" class="glass-input font-bold text-yellow-400" placeholder="Örn: Kazan Vana-1">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-[10px] text-slate-400 block mb-1 font-bold">Tarih</label>
                            <input type="date" id="iDate" class="glass-input">
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-400 block mb-1 font-bold">Seri No</label>
                            <input type="text" id="startSerial" class="glass-input" value="1001">
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-3">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xs font-bold text-orange-400 uppercase flex items-center gap-2"><i data-lucide="calculator"></i> Enerji & ROI Hesabı (ISO 12241)</h3>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] text-slate-400 block mb-1 font-bold">Çap (DN)</label>
                                <select id="dn" class="glass-input font-mono">
                                    <option value="15">DN15</option><option value="20">DN20</option>
                                    <option value="25">DN25</option><option value="32">DN32</option>
                                    <option value="40">DN40</option><option value="50">DN50</option>
                                    <option value="65">DN65</option><option value="80">DN80</option>
                                    <option value="100" selected>DN100</option><option value="125">DN125</option>
                                    <option value="150">DN150</option><option value="200">DN200</option>
                                    <option value="250">DN250</option><option value="300">DN300</option>
                                    <option value="350">DN350</option><option value="400">DN400</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-400 block mb-1 font-bold">Yalıtım (mm)</label>
                                <input type="number" id="thk" class="glass-input" value="50">
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] text-slate-400 block mb-1 font-bold">Yalıtım Tipi</label>
                                <select id="mat" class="glass-input text-xs">
                                    <option value="needlemat" selected>İğnelenmiş Cam Elyaf</option>
                                    <option value="rockwool">Taşyünü (Sanayi)</option>
                                    <option value="ceramic">Seramik Yünü</option>
                                    <option value="aerogel">Aerogel</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-400 block mb-1 font-bold">Yüzey Sıc. (°C)</label>
                                <input type="number" id="temp" class="glass-input text-red-400 font-bold" value="160">
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] text-slate-400 block mb-1 font-bold">Yakıt Tipi</label>
                                <select id="fuel" class="glass-input text-xs" onchange="updateFuelUnit()">
                                    <option value="gas">Doğalgaz</option>
                                    <option value="elec">Elektrik</option>
                                    <option value="lng">LNG</option>
                                    <option value="fueloil">Fuel Oil</option>
                                    <option value="coal">Kömür</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-400 block mb-1 font-bold">Birim Fiyat <span id="uUnit" class="text-slate-500 font-normal">(TL)</span></label>
                                <input type="number" id="price" class="glass-input" value="10">
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] text-slate-400 block mb-1 font-bold">Kazan Verim (%)</label>
                                <input type="number" id="eff" class="glass-input" value="85">
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-400 block mb-1 font-bold">Saat/Yıl</label>
                                <input type="number" id="hours" class="glass-input" value="8000">
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-4 bg-slate-800/50 p-4 rounded-xl border border-white/5">
                        <div class="flex-1">
                            <div class="text-[10px] text-slate-400 uppercase tracking-wider mb-1">Hesaplanan Yıllık Kazanç</div>
                            <div class="text-3xl font-black text-green-400 tracking-tight"><span id="liveSave">0</span> <span class="text-sm font-medium text-slate-500">TL / Yıl</span></div>
                        </div>
                        <button onclick="addToQueue()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 px-10 rounded-xl transition shadow-lg shadow-indigo-500/30 flex items-center gap-2 active:scale-95 cursor-pointer">
                            <i data-lucide="plus-circle" class="w-6 h-6"></i>
                            <div class="text-left leading-none">
                                <div class="text-[10px] opacity-80 font-normal">ONAYLA</div>
                                <div class="text-base">Listeye Ekle</div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-1">
                <div class="glass-card rounded-xl overflow-hidden flex flex-col h-[600px] border-t-4 border-t-slate-500">
                    <div class="p-4 border-b border-white/10 bg-slate-800/80 flex justify-between items-center">
                        <h3 class="text-xs font-bold text-white uppercase flex items-center gap-2"><i data-lucide="list"></i> Liste</h3>
                        <button onclick="clearList()" class="text-[10px] text-red-400 hover:text-white transition">Temizle</button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-2 space-y-2 custom-scroll bg-slate-900/50" id="queueList">
                        <div class="flex flex-col items-center justify-center h-full text-slate-500 opacity-50">
                            <i data-lucide="box" class="w-12 h-12 mb-2"></i>
                            <span class="text-xs">Liste Boş</span>
                        </div>
                    </div>
                    <div class="p-4 border-t border-white/10 bg-slate-900">
                        <button onclick="printLabels()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-xl text-sm transition shadow-lg shadow-green-500/20 flex items-center justify-center gap-2 cursor-pointer">
                            <i data-lucide="printer" class="w-5 h-5"></i> ETİKETLERİ YAZDIR
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="glass-card rounded-xl overflow-hidden h-[600px] border-t-4 border-t-slate-500 flex flex-col">
                    <div class="p-4 border-b border-white/10 bg-slate-800/80">
                        <h3 class="text-xs font-bold text-white uppercase flex items-center gap-2"><i data-lucide="eye"></i> Baskı Önizleme (A4)</h3>
                    </div>
                    <div class="flex-1 overflow-auto bg-slate-700/50 p-8 flex justify-center items-start custom-scroll">
                        
                        <div id="preview-wrapper">
                            <div class="text-slate-400 text-sm mt-20 text-center opacity-50">
                                Listeye ürün eklediğinizde<br>etiketler burada görünecek.
                            </div>
                        </div>

                    </div>
                </div>
            </div>

        </div>

    </div>

    <div id="print-root"></div>

<script>
    lucide.createIcons();
    document.getElementById('iDate').valueAsDate = new Date();

    let STICKER_QUEUE = [];
    
    // Vana dış çapları (ISO/DIN)
    const PIPES = {
        15:21.3, 20:26.7, 25:33.4, 32:42.2, 40:48.3, 
        50:60.3, 65:73.0, 80:88.9, 100:114.3, 125:141.3, 
        150:168.3, 200:219.1, 250:273.0, 
        300:323.9, 350:355.6, 400:406.4 
    };

    const MATS = {
        needlemat: {a:0.033, b:0.00018}, 
        rockwool: {a:0.035, b:0.00017}, 
        glasswool: {a:0.032, b:0.00015}, 
        ceramic: {a:0.06, b:0.0002},
        aerogel: {a:0.018, b:0.00005}
    };

    const FUELS = {
        gas: 10.64, elec: 1.0, lng: 13.8, fueloil: 11.8, coal: 7.5
    };

    // Live Calc Trigger
    document.querySelectorAll('#dn, #mat, #temp, #thk, #price, #hours, #fuel, #eff').forEach(el => {
        el.addEventListener('input', updateLiveCalc);
    });

    function updateFuelUnit() {
        const f = document.getElementById('fuel').value;
        const uMap = {gas:'TL/m³', elec:'TL/kWh', lng:'TL/kg', fueloil:'TL/kg', coal:'TL/kg'};
        document.getElementById('uUnit').innerText = `(${uMap[f] || 'TL'})`;
        updateLiveCalc();
    }

    function getK(matKey, T) {
        const m = MATS[matKey] || MATS.needlemat;
        return m.a + (m.b * T);
    }

    function calculateSavings() {
        const dn = document.getElementById('dn').value;
        const mm = PIPES[dn] || 114.3;
        const dPipe = mm / 1000;
        const tProc = parseFloat(document.getElementById('temp').value) || 0;
        const tAmb = 25; 
        const thk = parseFloat(document.getElementById('thk').value) / 1000 || 0.05;
        const mat = document.getElementById('mat').value;
        const price = parseFloat(document.getElementById('price').value) || 0;
        const hours = parseFloat(document.getElementById('hours').value) || 0;
        const fuelType = document.getElementById('fuel').value;
        const eff = parseFloat(document.getElementById('eff').value) / 100 || 0.85; 
        const LHV = FUELS[fuelType] || 10;

        const h_bare = 10 + (tProc - tAmb) * 0.05; 
        const A_bare = Math.PI * dPipe; 
        const Q_bare = h_bare * A_bare * (tProc - tAmb);

        const T_mean = (tProc + tAmb) / 2;
        const k = getK(mat, T_mean);
        const dOut = dPipe + 2*thk;
        const R_ins = Math.log(dOut / dPipe) / (2 * Math.PI * k);
        const h_out = 10; 
        const R_surf = 1 / (h_out * Math.PI * dOut);
        const Q_ins = (tProc - tAmb) / (R_ins + R_surf);

        const Q_save_meter = Q_bare - Q_ins;
        const valveFactor = 1.5; 
        
        const Energy_Saved_kWh = (Q_save_meter * valveFactor * hours) / 1000;
        const Fuel_Saved_Amount = Energy_Saved_kWh / (LHV * eff);
        const Money_Saved = Fuel_Saved_Amount * price;

        return Math.max(0, Money_Saved);
    }

    function updateLiveCalc() {
        const val = calculateSavings();
        document.getElementById('liveSave').innerText = Math.round(val).toLocaleString();
    }

    // --- SİHİRLİ QR OLUŞTURUCU (Resme Çeviren Fonksiyon) ---
    function generateQRImage(text) {
        return new Promise((resolve) => {
            // Gizli alanı temizle
            const engine = document.getElementById('qr-engine');
            engine.innerHTML = '';
            
            // 1. QR'ı Çiz
            new QRCode(engine, {
                text: text,
                width: 200, // Yüksek kalite
                height: 200,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.M
            });

            // 2. Çizimin bitmesini bekle ve resme çevir
            setTimeout(() => {
                const canvas = engine.querySelector('canvas');
                const img = engine.querySelector('img');
                
                if(canvas) {
                    resolve(canvas.toDataURL("image/png"));
                } else if(img) {
                    resolve(img.src);
                } else {
                    resolve(''); // Hata durumu
                }
            }, 100); 
        });
    }

    async function addToQueue() {
        const pName = document.getElementById('pName').value || "Vana Ceketi";
        const cName = document.getElementById('cName').value || "Müşteri";
        const dateStr = document.getElementById('iDate').value;
        const saving = calculateSavings();
        const startSerial = parseInt(document.getElementById('startSerial').value) || 1001;
        
        const year = new Date().getFullYear();
        const serialNo = startSerial + STICKER_QUEUE.length;
        const uniqueID = `INS-${year}-${serialNo}`;

        const trackUrl = `https://www.optimizi.app/track.html?p=${encodeURIComponent(pName)}&s=${uniqueID}&d=${dateStr}&v=${saving.toFixed(2)}&c=${encodeURIComponent(cName)}`;

        // ÖNCE QR FOTOĞRAFINI OLUŞTUR (Bekle)
        const qrBase64 = await generateQRImage(trackUrl);

        STICKER_QUEUE.push({
            id: uniqueID,
            name: pName,
            client: cName,
            date: dateStr,
            saving: saving,
            qrImg: qrBase64 // Resmi listeye kaydet
        });

        renderAll();
    }

    function renderAll() {
        renderQueueList();
        renderStickers('print-root'); // Baskı alanı
        
        // Önizlemeyi kopyala (HTML olarak)
        const printRootHTML = document.getElementById('print-root').innerHTML;
        document.getElementById('preview-wrapper').innerHTML = printRootHTML || '<div class="text-slate-400 text-sm mt-20 opacity-50">Liste boş.</div>';
    }

    function renderQueueList() {
        const el = document.getElementById('queueList');
        el.innerHTML = '';
        if(STICKER_QUEUE.length === 0) {
            el.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-slate-500 opacity-50"><i data-lucide="box" class="w-12 h-12 mb-2"></i><span class="text-xs">Liste Boş</span></div>';
            lucide.createIcons();
            return;
        }

        STICKER_QUEUE.slice().reverse().forEach((item, index) => {
            el.innerHTML += `
                <div class="flex justify-between items-center bg-slate-700/50 p-2 rounded border border-white/5 text-[10px] group hover:bg-slate-700 transition">
                    <div>
                        <div class="text-indigo-400 font-mono font-bold">${item.id}</div>
                        <div class="text-white font-bold truncate w-32">${item.name}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-green-400 font-bold">${Math.round(item.saving).toLocaleString()} TL</div>
                        <button onclick="removeItem(${STICKER_QUEUE.length - 1 - index})" class="text-red-400 hover:text-white text-[9px] underline mt-1 cursor-pointer">Sil</button>
                    </div>
                </div>
            `;
        });
        lucide.createIcons();
    }

    function removeItem(idx) {
        STICKER_QUEUE.splice(idx, 1);
        renderAll();
    }

    function clearList() {
        if(confirm("Liste temizlensin mi?")) {
            STICKER_QUEUE = [];
            renderAll();
        }
    }

    function renderStickers(targetId) {
        const container = document.getElementById(targetId);
        container.innerHTML = ''; 

        if (STICKER_QUEUE.length === 0) return;

        let page = document.createElement('div');
        page.className = 'a4-page';
        let count = 0;

        STICKER_QUEUE.forEach((item) => {
            
            if (count > 0 && count % 30 === 0) {
                container.appendChild(page);
                page = document.createElement('div');
                page.className = 'a4-page';
            }

            const sticker = document.createElement('div');
            sticker.className = 'sticker';
            
            // DİKKAT: Artık doğrudan oluşturduğumuz resmi (img src=base64) kullanıyoruz.
            sticker.innerHTML = `
                <div style="width:100%; text-align:center; border-bottom:1px solid #000; padding-bottom:2px; margin-bottom:2px; display:flex; justify-content:space-between; align-items:flex-end;">
                    <div style="font-weight:900; font-size:11px; letter-spacing:0.5px;">INSPRO</div>
                    <div style="font-size:7px; font-weight:bold;">${item.id}</div>
                </div>
                
                <div style="margin:2px 0;">
                    <img src="${item.qrImg}" style="width:90px; height:90px; display:block;">
                </div>
                
                <div style="width:100%; text-align:left; font-size:7px; line-height:1.2;">
                    <div style="font-weight:bold; font-size:8px; overflow:hidden; white-space:nowrap; margin-bottom:1px;">${item.name}</div>
                    <div style="border-top:1px solid #ccc; padding-top:2px; display:flex; justify-content:space-between;">
                        <span>Ref: ${item.client.substring(0,10)}</span>
                        <span>Date: ${item.date}</span>
                    </div>
                    <div style="margin-top:2px; font-weight:bold; text-align:center; background:#eee; padding:1px;">SCAN FOR SAVINGS</div>
                </div>
            `;

            page.appendChild(sticker);
            count++;
        });

        container.appendChild(page);
    }

    function printLabels() {
        if(STICKER_QUEUE.length === 0) { alert("Liste boş!"); return; }
        window.print();
    }

    // Başlangıç Ayarları
    updateFuelUnit();
    updateLiveCalc();
</script>
</body>
</html>