<!doctype html>
<html lang="tr" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teklif Yönetimi</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="auth.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon.png">
  <style>
    body:not(.auth-checked){opacity:0;pointer-events:none}
    body.auth-checked{opacity:1;transition:opacity .3s ease}
  </style>
  <script>
    tailwind.config={darkMode:'class',theme:{fontFamily:{sans:['"Plus Jakarta Sans"','sans-serif']},extend:{colors:{slate:{850:'#151e2e',900:'#0f172a',950:'#020617'},primary:{500:'#6366f1',600:'#4f46e5'}},animation:{'pop-in':'popIn .3s cubic-bezier(.16,1,.3,1)','success-bounce':'successBounce .5s cubic-bezier(.16,1,.3,1)'},keyframes:{popIn:{'0%':{transform:'scale(.9)',opacity:'0'},'100%':{transform:'scale(1)',opacity:'1'}},successBounce:{'0%':{transform:'scale(.8)',opacity:'0'},'50%':{transform:'scale(1.1)'},'100%':{transform:'scale(1)',opacity:'1'}}}}}}
  </script>
  <style>
    :root{--bg-grad:radial-gradient(ellipse at top,#f8fafc 0%,#e2e8f0 40%,#cbd5e1 100%);--glass-panel:rgba(255,255,255,.8);--glass-border:rgba(0,0,0,.05);--glass-card-bg:linear-gradient(145deg,rgba(255,255,255,.9) 0%,rgba(241,245,249,.95) 100%);--scroll-thumb:#cbd5e1;--sidebar-active-bg:rgba(99,102,241,.1);--sidebar-text:#64748b;--sidebar-text-hover:#0f172a}
    .dark{--bg-grad:radial-gradient(ellipse at top,#1e1b4b 0%,#0f172a 40%,#020617 100%);--glass-panel:rgba(30,41,59,.4);--glass-border:rgba(255,255,255,.05);--glass-card-bg:linear-gradient(145deg,rgba(30,41,59,.6) 0%,rgba(15,23,42,.8) 100%);--scroll-thumb:#334155;--sidebar-active-bg:rgba(99,102,241,.2);--sidebar-text:#94a3b8;--sidebar-text-hover:#fff}
    body{background:var(--bg-grad);background-attachment:fixed;color:#0f172a;overflow:hidden;transition:color .3s,background .3s}
    .dark body{color:#f1f5f9}
    .glass-panel{background:var(--glass-panel);backdrop-filter:blur(12px);border:1px solid var(--glass-border);transition:background .3s,border-color .3s,width .3s}
    .glass-card{background:var(--glass-card-bg);border:1px solid var(--glass-border);transition:all .3s}
    .glass-card:hover{border-color:rgba(99,102,241,.3)}
    ::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--scroll-thumb);border-radius:3px}::-webkit-scrollbar-thumb:hover{background:#6366f1}
    .sidebar-link{display:flex;align-items:center;gap:12px;padding:12px 16px;margin-bottom:4px;border-radius:12px;color:var(--sidebar-text);transition:all .2s;font-weight:500;font-size:.9rem;cursor:pointer;width:100%;text-align:left;white-space:nowrap;overflow:hidden}
    .sidebar-link:hover,.sidebar-link.active{background:var(--sidebar-active-bg);color:var(--sidebar-text-hover)}
    .sidebar-link.active{border-left:3px solid #6366f1}
    .sidebar-link i{width:20px;height:20px;min-width:20px}
    .submenu{overflow:hidden;transition:max-height .3s ease-out;max-height:0}.submenu.open{max-height:800px}
    .submenu-item{display:flex;align-items:center;justify-content:space-between;padding-right:12px;margin-bottom:2px;border-radius:8px;transition:background .2s}
    .submenu-item:hover{background:rgba(0,0,0,.03)}.dark .submenu-item:hover{background:rgba(255,255,255,.03)}
    .submenu-link{flex:1;display:flex;align-items:center;gap:10px;padding:8px 0 8px 48px;color:var(--sidebar-text);font-size:.85rem;transition:color .2s;text-decoration:none;position:relative;white-space:nowrap}
    .submenu-link:before{content:'';position:absolute;left:30px;top:50%;width:4px;height:4px;border-radius:50%;background:var(--sidebar-text);transform:translateY(-50%);opacity:.5}
    .submenu-link:hover{color:#6366f1}.submenu-link:hover:before{background:#6366f1;opacity:1}
    .quick-action-btn{opacity:0;transform:translateX(-5px);transition:all .2s;padding:4px;border-radius:6px;color:var(--sidebar-text)}
    .submenu-item:hover .quick-action-btn{opacity:1;transform:translateX(0)}
    .quick-action-btn:hover{background:#6366f1;color:#fff;box-shadow:0 2px 5px rgba(99,102,241,.3)}
    aside.collapsed{width:80px}aside.collapsed .sidebar-link{justify-content:center;padding:12px}
    aside.collapsed .sidebar-link span,aside.collapsed .sidebar-link i.chevron,aside.collapsed .submenu,aside.collapsed .logo-text,aside.collapsed .sidebar-title,aside.collapsed .user-info{display:none!important}
    aside.collapsed .sidebar-link{border-left:none}aside.collapsed .sidebar-link.active{background:var(--sidebar-active-bg);color:#6366f1}
    .modal-enter{animation:slideInRight .3s ease-out forwards}@keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    .animate-bounce-in{animation:successBounce .5s cubic-bezier(.16,1,.3,1)}@keyframes successBounce{0%{transform:scale(.8);opacity:0}50%{transform:scale(1.1)}100%{transform:scale(1);opacity:1}}
    .animate-pop{animation:popIn .3s cubic-bezier(.16,1,.3,1)}@keyframes popIn{0%{transform:scale(.9);opacity:0}100%{transform:scale(1);opacity:1}}
    .tab-btn{position:relative;padding:12px 20px;font-size:.875rem;font-weight:600;color:var(--sidebar-text);transition:all .2s;border-radius:12px 12px 0 0}
    .tab-btn:hover{color:var(--sidebar-text-hover)}
    .tab-btn.active{color:#6366f1;background:var(--glass-card-bg);border:1px solid var(--glass-border);border-bottom:none}
    .tab-btn.active::after{content:'';position:absolute;bottom:-1px;left:0;right:0;height:2px;background:#6366f1}
    .tab-content{display:none}.tab-content.active{display:block;animation:popIn .3s ease}
    .autocomplete-dropdown{position:absolute;top:100%;left:0;right:0;z-index:50;max-height:200px;overflow-y:auto;border-radius:0 0 12px 12px}
    .autocomplete-item{padding:10px 16px;cursor:pointer;transition:all .15s}.autocomplete-item:hover{background:rgba(99,102,241,.1)}
    .status-beklemede{background:rgba(234,179,8,.1);color:#ca8a04;border:1px solid rgba(234,179,8,.2)}
    .status-onaylandi{background:rgba(34,197,94,.1);color:#16a34a;border:1px solid rgba(34,197,94,.2)}
    .status-reddedildi{background:rgba(239,68,68,.1);color:#dc2626;border:1px solid rgba(239,68,68,.2)}
    .status-taslak{background:rgba(148,163,184,.1);color:#64748b;border:1px solid rgba(148,163,184,.2)}
    .proposal-item-row{transition:all .2s}.proposal-item-row:hover{background:rgba(99,102,241,.03)}.dark .proposal-item-row:hover{background:rgba(255,255,255,.03)}
    @media print{body{background:#fff!important;overflow:visible!important}aside,header,.no-print{display:none!important}main{margin:0;padding:0}.glass-card{border:1px solid #e2e8f0;box-shadow:none}}
  </style>
</head>
<body class="flex h-screen w-full text-slate-800 dark:text-slate-100 transition-colors duration-300">
  <div class="fixed inset-0 z-0 pointer-events-none opacity-50 dark:opacity-100 transition-opacity duration-500">
    <div class="absolute top-0 left-0 w-[500px] h-[500px] bg-indigo-500/20 dark:bg-indigo-600/10 rounded-full blur-[100px]"></div>
    <div class="absolute bottom-0 right-0 w-[500px] h-[500px] bg-blue-500/20 dark:bg-blue-600/10 rounded-full blur-[100px]"></div>
  </div>

  <!-- SIDEBAR -->
    <aside id="mainSidebar"></aside>
  <script src="sidebar.js"></script>

  <!-- MAIN CONTENT -->
  <main class="flex-1 flex flex-col h-full relative z-10 overflow-hidden bg-slate-50/50 dark:bg-transparent transition-all duration-300">
    <header class="h-20 flex items-center justify-between px-6 md:px-8 border-b border-slate-200 dark:border-white/5 glass-panel md:bg-transparent md:backdrop-filter-none md:border-none">
      <div class="flex items-center gap-4">
        <button class="md:hidden p-2 text-slate-500 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-white"><i data-lucide="menu"></i></button>
        <h1 class="text-xl font-bold text-slate-800 dark:text-white hidden md:block">Teklif Yönetimi</h1>
      </div>
      <div class="flex items-center gap-4">
        <div class="relative hidden md:block">
          <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>
          <input type="text" id="globalSearch" onkeyup="handleGlobalSearch()" placeholder="Müşteri veya teklif ara..." class="bg-white dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-full pl-10 pr-4 py-2 text-sm text-slate-700 dark:text-slate-300 focus:outline-none focus:border-indigo-500 w-72 transition shadow-sm">
        </div>
      </div>
    </header>
    <div class="flex-1 overflow-y-auto p-6 md:p-8 custom-scroll">
      <!-- Title & Actions -->
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
        <div>
          <h2 class="text-2xl font-black text-slate-900 dark:text-white mb-1">Teklif & Müşteri Yönetimi</h2>
          <p class="text-slate-500 dark:text-slate-400 text-sm">Müşterilerini yönet, teklif oluştur ve takip et.</p>
        </div>
        <div class="flex items-center gap-3">
          <button onclick="openNewProposalModal()" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white px-5 py-2.5 rounded-xl text-sm font-bold transition shadow-lg shadow-indigo-600/20"><i data-lucide="plus" class="w-4 h-4"></i> Yeni Teklif</button>
          <button onclick="switchTab('quick')" class="flex items-center gap-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 px-5 py-2.5 rounded-xl text-sm font-bold hover:border-indigo-500 transition"><i data-lucide="zap" class="w-4 h-4 text-amber-500"></i> Hızlı Teklif</button>
        </div>
      </div>
      <!-- Stats -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="glass-card p-4 rounded-2xl"><div class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Toplam Müşteri</div><div class="text-2xl font-black text-slate-800 dark:text-white" id="statTotalClients">0</div></div>
        <div class="glass-card p-4 rounded-2xl"><div class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Toplam Teklif</div><div class="text-2xl font-black text-slate-800 dark:text-white" id="statTotalProposals">0</div></div>
        <div class="glass-card p-4 rounded-2xl"><div class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Onaylanan</div><div class="text-2xl font-black text-green-600 dark:text-green-400" id="statApproved">0</div></div>
        <div class="glass-card p-4 rounded-2xl"><div class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Bekleyen</div><div class="text-2xl font-black text-amber-600 dark:text-amber-400" id="statPending">0</div></div>
      </div>
      <!-- Tabs -->
      <div class="flex gap-1 mb-0 border-b border-slate-200 dark:border-slate-700 no-print overflow-x-auto">
        <button onclick="switchTab('customers')" class="tab-btn active" data-tab="customers"><i data-lucide="users" class="w-4 h-4 inline mr-1.5"></i>Müşteriler</button>
        <button onclick="switchTab('proposals')" class="tab-btn" data-tab="proposals"><i data-lucide="file-text" class="w-4 h-4 inline mr-1.5"></i>Teklifler</button>
        <button onclick="switchTab('quick')" class="tab-btn" data-tab="quick"><i data-lucide="zap" class="w-4 h-4 inline mr-1.5"></i>Hızlı Teklif</button>
        <button onclick="switchTab('templates')" class="tab-btn" data-tab="templates"><i data-lucide="layout-template" class="w-4 h-4 inline mr-1.5"></i>Şablonlar</button>
      </div>

      <!-- TAB: CUSTOMERS -->
      <div id="tab-customers" class="tab-content active">
        <div class="glass-card rounded-b-2xl rounded-tr-2xl overflow-hidden bg-white dark:bg-transparent">
          <div class="p-5 border-b border-slate-200 dark:border-white/5 flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
            <div class="flex items-center gap-3">
              <div class="p-2 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg text-indigo-600 dark:text-indigo-400"><i data-lucide="users" class="w-5 h-5"></i></div>
              <div><h3 class="font-bold text-slate-800 dark:text-white">Kayıtlı Müşteriler</h3><p class="text-xs text-slate-500" id="clientCountLabel">Toplam 0 müşteri</p></div>
            </div>
            <button onclick="openNewClientModal()" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-xl text-sm font-bold transition shadow-lg shadow-indigo-600/20"><i data-lucide="user-plus" class="w-4 h-4"></i> Yeni Müşteri</button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-slate-600 dark:text-slate-400">
              <thead class="bg-slate-50 dark:bg-slate-800/50 text-xs uppercase text-slate-500 font-bold"><tr><th class="px-6 py-3">Müşteri</th><th class="px-6 py-3">İletişim</th><th class="px-6 py-3">Şehir</th><th class="px-6 py-3">Teklif</th><th class="px-6 py-3 text-right">İşlem</th></tr></thead>
              <tbody id="clientsTableBody"><tr><td colspan="5" class="px-6 py-12 text-center"><div class="inline-flex items-center justify-center w-12 h-12 bg-slate-100 dark:bg-slate-800/50 rounded-full mb-3 text-indigo-500 animate-pulse"><i data-lucide="loader-2" class="w-6 h-6 animate-spin"></i></div><p class="text-slate-500 font-medium">Yükleniyor...</p></td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TAB: PROPOSALS -->
      <div id="tab-proposals" class="tab-content">
        <div class="glass-card rounded-b-2xl rounded-tr-2xl overflow-hidden bg-white dark:bg-transparent">
          <div class="p-5 border-b border-slate-200 dark:border-white/5 flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
            <div class="flex items-center gap-3">
              <div class="p-2 bg-emerald-100 dark:bg-emerald-900/30 rounded-lg text-emerald-600 dark:text-emerald-400"><i data-lucide="file-text" class="w-5 h-5"></i></div>
              <div><h3 class="font-bold text-slate-800 dark:text-white">Teklif Geçmişi</h3><p class="text-xs text-slate-500" id="proposalCountLabel">Toplam 0 teklif</p></div>
            </div>
            <div class="flex items-center gap-2">
              <select id="proposalStatusFilter" onchange="filterProposals()" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500"><option value="all">Tüm Durumlar</option><option value="taslak">Taslak</option><option value="beklemede">Beklemede</option><option value="onaylandi">Onaylandı</option><option value="reddedildi">Reddedildi</option></select>
              <button onclick="openNewProposalModal()" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-xl text-sm font-bold transition shadow-lg shadow-indigo-600/20"><i data-lucide="plus" class="w-4 h-4"></i> Yeni Teklif</button>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-slate-600 dark:text-slate-400">
              <thead class="bg-slate-50 dark:bg-slate-800/50 text-xs uppercase text-slate-500 font-bold"><tr><th class="px-6 py-3">Teklif No</th><th class="px-6 py-3">Müşteri</th><th class="px-6 py-3">Konu</th><th class="px-6 py-3">Tutar</th><th class="px-6 py-3">Durum</th><th class="px-6 py-3">Tarih</th><th class="px-6 py-3 text-right">İşlem</th></tr></thead>
              <tbody id="proposalsTableBody"><tr><td colspan="7" class="px-6 py-12 text-center"><p class="text-slate-500 font-medium">Yükleniyor...</p></td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TAB: QUICK PROPOSAL -->
      <div id="tab-quick" class="tab-content">
        <div class="glass-card rounded-b-2xl rounded-tr-2xl bg-white dark:bg-transparent p-6 md:p-8">
          <div class="flex items-center gap-3 mb-6">
            <div class="p-2 bg-amber-100 dark:bg-amber-900/30 rounded-lg text-amber-600 dark:text-amber-400"><i data-lucide="zap" class="w-5 h-5"></i></div>
            <div><h3 class="font-bold text-slate-800 dark:text-white">Hızlı Teklif Oluştur</h3><p class="text-xs text-slate-500">Kayıtlı müşteri gerekmez. Kayıtlı müşteri adı yazarsanız otomatik tamamlanır.</p></div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="space-y-5">
              <div class="relative">
                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Müşteri Adı</label>
                <input type="text" id="quickClientName" oninput="handleQuickClientAutocomplete()" onblur="setTimeout(()=>document.getElementById('quickClientDropdown').classList.add('hidden'),200)" placeholder="Müşteri adı yazın veya seçin..." class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-indigo-500 transition">
                <div id="quickClientDropdown" class="hidden autocomplete-dropdown bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-b-xl shadow-xl"></div>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Yetkili Kişi</label><input type="text" id="quickContactPerson" placeholder="İletişim kişisi" class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-indigo-500 transition"></div>
                <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Telefon</label><input type="text" id="quickPhone" placeholder="05XX XXX XX XX" class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-indigo-500 transition"></div>
              </div>
              <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Teklif Konusu</label><input type="text" id="quickSubject" placeholder="Ör: Boru hattı yalıtım teklifi" class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-indigo-500 transition"></div>
              <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Şablon Seç</label><select id="quickTemplate" onchange="loadTemplateToQuick()" class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-indigo-500 transition"><option value="">Şablon kullanma (Boş)</option></select></div>
              <div>
                <div class="flex items-center justify-between mb-3"><label class="text-sm font-bold text-slate-700 dark:text-slate-300">Teklif Kalemleri</label><button onclick="addQuickItem()" class="text-xs text-indigo-600 hover:text-indigo-500 font-bold flex items-center gap-1"><i data-lucide="plus" class="w-3 h-3"></i> Kalem Ekle</button></div>
                <div id="quickItemsContainer" class="space-y-3"></div>
              </div>
              <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Notlar</label><textarea id="quickNotes" rows="3" placeholder="Teklif ile ilgili ek notlar..." class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-indigo-500 transition resize-none"></textarea></div>
              <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Geçerlilik</label><select id="quickValidity" class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-indigo-500"><option value="15">15 Gün</option><option value="30" selected>30 Gün</option><option value="60">60 Gün</option><option value="90">90 Gün</option></select></div>
                <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Para Birimi</label><select id="quickCurrency" class="w-full bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-indigo-500"><option value="TRY">₺ TRY</option><option value="USD">$ USD</option><option value="EUR">€ EUR</option></select></div>
              </div>
              <div class="flex gap-3 pt-2">
                <button onclick="saveQuickProposal('taslak')" class="flex-1 py-3 rounded-xl border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 text-sm font-bold hover:bg-slate-50 dark:hover:bg-slate-800 transition"><i data-lucide="save" class="w-4 h-4 inline mr-1"></i> Taslak</button>
                <button onclick="saveQuickProposal('beklemede')" class="flex-1 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-bold shadow-lg shadow-indigo-600/20 transition"><i data-lucide="send" class="w-4 h-4 inline mr-1"></i> Teklif Oluştur</button>
              </div>
            </div>
            <div><div class="sticky top-0"><div class="text-sm font-bold text-slate-500 dark:text-slate-400 mb-3 flex items-center gap-2"><i data-lucide="eye" class="w-4 h-4"></i> Canlı Önizleme</div><div id="quickPreview" class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-2xl p-6 shadow-lg min-h-[400px]"><div class="text-center text-slate-400 text-sm py-12">Bilgileri doldurmaya başlayın...</div></div></div></div>
          </div>
        </div>
      </div>

      <!-- TAB: TEMPLATES -->
      <div id="tab-templates" class="tab-content">
        <div class="glass-card rounded-b-2xl rounded-tr-2xl bg-white dark:bg-transparent p-6">
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 mb-6">
            <div class="flex items-center gap-3">
              <div class="p-2 bg-purple-100 dark:bg-purple-900/30 rounded-lg text-purple-600 dark:text-purple-400"><i data-lucide="layout-template" class="w-5 h-5"></i></div>
              <div><h3 class="font-bold text-slate-800 dark:text-white">Teklif Şablonları</h3><p class="text-xs text-slate-500">Tekrar eden teklifler için şablon oluşturun.</p></div>
            </div>
            <button onclick="openNewTemplateModal()" class="flex items-center gap-2 bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-xl text-sm font-bold transition shadow-lg shadow-purple-600/20"><i data-lucide="plus" class="w-4 h-4"></i> Yeni Şablon</button>
          </div>
          <div id="templatesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- MODALS -->
  <!-- New Client Modal -->
  <div id="newClientModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeModal('newClientModal')"></div>
    <div class="absolute right-0 top-0 h-full w-full max-w-md bg-white dark:bg-slate-900 border-l border-slate-200 dark:border-slate-800 shadow-2xl modal-enter flex flex-col">
      <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-800">
        <div class="flex items-center gap-3"><div class="p-2 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg text-indigo-600"><i data-lucide="user-plus" class="w-5 h-5"></i></div><h2 class="text-lg font-bold text-slate-900 dark:text-white" id="clientModalTitle">Yeni Müşteri</h2></div>
        <button onclick="closeModal('newClientModal')" class="text-slate-500 hover:text-red-500 transition"><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <div class="flex-1 overflow-y-auto p-6 space-y-4">
        <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1.5">Firma / Müşteri Adı *</label><input type="text" id="clientName" placeholder="Firma veya kişi adı" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500"></div>
        <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1.5">Yetkili Kişi</label><input type="text" id="clientContact" placeholder="İletişim kişisi" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500"></div>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1.5">Telefon</label><input type="text" id="clientPhone" placeholder="05XX XXX XX XX" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500"></div>
          <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1.5">E-posta</label><input type="email" id="clientEmail" placeholder="ornek@firma.com" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500"></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1.5">Şehir</label><input type="text" id="clientCity" placeholder="İstanbul" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500"></div>
          <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1.5">Sektör</label><input type="text" id="clientSector" placeholder="Enerji, İnşaat..." class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500"></div>
        </div>
        <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1.5">Vergi No</label><input type="text" id="clientTaxNo" placeholder="Vergi numarası" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500"></div>
        <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1.5">Adres</label><textarea id="clientAddress" rows="2" placeholder="Açık adres..." class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500 resize-none"></textarea></div>
        <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1.5">Notlar</label><textarea id="clientNotes" rows="2" placeholder="Müşteri hakkında notlar..." class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500 resize-none"></textarea></div>
      </div>
      <div class="p-6 border-t border-slate-200 dark:border-slate-800 flex gap-3">
        <button onclick="closeModal('newClientModal')" class="flex-1 py-2.5 rounded-xl border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 text-sm font-bold hover:bg-slate-50 dark:hover:bg-slate-800 transition">İptal</button>
        <button onclick="saveClient()" class="flex-1 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-bold shadow-lg shadow-indigo-600/20 transition">Kaydet</button>
      </div>
    </div>
  </div>

  <!-- New Proposal Modal -->
  <div id="newProposalModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeModal('newProposalModal')"></div>
    <div class="absolute right-0 top-0 h-full w-full max-w-lg bg-white dark:bg-slate-900 border-l border-slate-200 dark:border-slate-800 shadow-2xl modal-enter flex flex-col">
      <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-800">
        <div class="flex items-center gap-3"><div class="p-2 bg-emerald-100 dark:bg-emerald-900/30 rounded-lg text-emerald-600"><i data-lucide="file-plus" class="w-5 h-5"></i></div><h2 class="text-lg font-bold text-slate-900 dark:text-white">Yeni Teklif Oluştur</h2></div>
        <button onclick="closeModal('newProposalModal')" class="text-slate-500 hover:text-red-500 transition"><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <div class="flex-1 overflow-y-auto p-6 space-y-4">
        <div class="relative"><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1.5">Müşteri *</label><input type="text" id="proposalClientInput" oninput="handleProposalClientAutocomplete()" onblur="setTimeout(()=>document.getElementById('proposalClientDropdown').classList.add('hidden'),200)" placeholder="Müşteri adı yazın..." class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500"><div id="proposalClientDropdown" class="hidden autocomplete-dropdown bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-b-xl shadow-xl"></div><input type="hidden" id="proposalClientId" value=""></div>
        <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1.5">Teklif Konusu *</label><input type="text" id="proposalSubject" placeholder="Teklif konusu..." class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500"></div>
        <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1.5">Şablon</label><select id="proposalTemplate" onchange="loadTemplateToProposal()" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500"><option value="">Şablon kullanma</option></select></div>
        <div>
          <div class="flex items-center justify-between mb-2"><label class="text-sm font-bold text-slate-700 dark:text-slate-300">Teklif Kalemleri</label><button onclick="addProposalItem()" class="text-xs text-indigo-600 hover:text-indigo-500 font-bold flex items-center gap-1"><i data-lucide="plus" class="w-3 h-3"></i> Ekle</button></div>
          <div id="proposalItemsContainer" class="space-y-2"></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1.5">Geçerlilik</label><select id="proposalValidity" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500"><option value="15">15 Gün</option><option value="30" selected>30 Gün</option><option value="60">60 Gün</option></select></div>
          <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1.5">Para Birimi</label><select id="proposalCurrency" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500"><option value="TRY">₺ TRY</option><option value="USD">$ USD</option><option value="EUR">€ EUR</option></select></div>
        </div>
        <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1.5">Notlar</label><textarea id="proposalNotes" rows="2" placeholder="Ek notlar..." class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500 resize-none"></textarea></div>
        <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700"><div class="flex justify-between items-center"><span class="text-sm font-bold text-slate-700 dark:text-slate-300">Toplam:</span><span class="text-xl font-black text-indigo-600 dark:text-indigo-400" id="proposalTotalDisplay">0,00 ₺</span></div></div>
      </div>
      <div class="p-6 border-t border-slate-200 dark:border-slate-800 flex gap-3">
        <button onclick="closeModal('newProposalModal')" class="flex-1 py-2.5 rounded-xl border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 text-sm font-bold transition">İptal</button>
        <button onclick="saveProposal('taslak')" class="py-2.5 px-4 rounded-xl border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 text-sm font-bold transition">Taslak</button>
        <button onclick="saveProposal('beklemede')" class="flex-1 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-bold shadow-lg shadow-indigo-600/20 transition">Oluştur</button>
      </div>
    </div>
  </div>

  <!-- New Template Modal -->
  <div id="newTemplateModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal('newTemplateModal')"></div>
    <div class="relative bg-white dark:bg-slate-900 w-full max-w-lg rounded-2xl shadow-2xl animate-pop border border-slate-200 dark:border-slate-800 flex flex-col max-h-[85vh]">
      <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-800"><h2 class="text-lg font-bold text-slate-900 dark:text-white">Yeni Teklif Şablonu</h2><button onclick="closeModal('newTemplateModal')" class="text-slate-500 hover:text-red-500 transition"><i data-lucide="x" class="w-5 h-5"></i></button></div>
      <div class="flex-1 overflow-y-auto p-6 space-y-4">
        <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1.5">Şablon Adı *</label><input type="text" id="templateName" placeholder="Ör: Standart Yalıtım Teklifi" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500"></div>
        <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1.5">Açıklama</label><input type="text" id="templateDesc" placeholder="Şablon açıklaması..." class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500"></div>
        <div><div class="flex items-center justify-between mb-2"><label class="text-sm font-bold text-slate-700 dark:text-slate-300">Şablon Kalemleri</label><button onclick="addTemplateItem()" class="text-xs text-indigo-600 font-bold flex items-center gap-1"><i data-lucide="plus" class="w-3 h-3"></i> Ekle</button></div><div id="templateItemsContainer" class="space-y-2"></div></div>
        <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1.5">Varsayılan Not</label><textarea id="templateNotes" rows="2" placeholder="Tekliflerde görünecek not..." class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500 resize-none"></textarea></div>
      </div>
      <div class="p-6 border-t border-slate-200 dark:border-slate-800 flex gap-3">
        <button onclick="closeModal('newTemplateModal')" class="flex-1 py-2.5 rounded-xl border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 text-sm font-bold transition">İptal</button>
        <button onclick="saveTemplate()" class="flex-1 py-2.5 rounded-xl bg-purple-600 hover:bg-purple-500 text-white text-sm font-bold shadow-lg shadow-purple-600/20 transition">Kaydet</button>
      </div>
    </div>
  </div>

  <!-- Proposal Detail Modal -->
  <div id="proposalDetailModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeModal('proposalDetailModal')"></div>
    <div class="absolute right-0 top-0 h-full w-full max-w-2xl bg-white dark:bg-slate-900 border-l border-slate-200 dark:border-slate-800 shadow-2xl modal-enter flex flex-col">
      <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-800">
        <h2 class="text-lg font-bold text-slate-900 dark:text-white">Teklif Detayı</h2>
        <div class="flex items-center gap-2"><button onclick="window.print()" class="p-2 rounded-lg text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition" title="Yazdır"><i data-lucide="printer" class="w-5 h-5"></i></button><button onclick="closeModal('proposalDetailModal')" class="text-slate-500 hover:text-red-500 transition"><i data-lucide="x" class="w-5 h-5"></i></button></div>
      </div>
      <div class="flex-1 overflow-y-auto p-6" id="proposalDetailContent"></div>
      <div class="p-6 border-t border-slate-200 dark:border-slate-800 flex gap-3" id="proposalDetailActions"></div>
    </div>
  </div>

  <!-- Notification Modal -->
  <div id="notifModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeNotification()"></div>
    <div class="relative bg-white dark:bg-slate-900 w-full max-w-sm rounded-2xl shadow-2xl animate-pop border border-slate-200 dark:border-slate-800 overflow-hidden">
      <div class="p-6 text-center">
        <div id="notifIcon" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce-in"></div>
        <h3 id="notifTitle" class="text-xl font-bold text-slate-900 dark:text-white mb-2"></h3>
        <p id="notifMsg" class="text-sm text-slate-500 dark:text-slate-400 mb-6 leading-relaxed"></p>
        <button id="notifBtn" onclick="closeNotification()" class="w-full py-3 rounded-xl font-bold transition shadow-lg text-white">Tamam</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeSettings()"></div>
    <div class="absolute right-0 top-0 h-full w-full max-w-md bg-white dark:bg-slate-900 border-l border-slate-200 dark:border-slate-800 shadow-2xl modal-enter flex flex-col">
      <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-800"><h2 class="text-xl font-bold text-slate-900 dark:text-white">Ayarlar</h2><button onclick="closeSettings()" class="text-slate-500 hover:text-red-500 transition"><i data-lucide="x" class="w-6 h-6"></i></button></div>
      <div class="flex-1 overflow-y-auto p-6 space-y-8">
        <section><h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Profil</h3><div class="flex items-center gap-4 mb-4"><div class="w-16 h-16 rounded-full bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center text-2xl font-bold text-indigo-600 dark:text-indigo-400" id="modalAvatar">U</div><div><p class="font-bold text-slate-900 dark:text-white text-lg" id="modalName">...</p><p class="text-sm text-slate-500" id="modalEmail">...</p></div></div></section>
        <section><h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Görünüm</h3><div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 flex items-center justify-between"><div class="flex items-center gap-3"><div class="p-2 rounded-lg bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400"><i data-lucide="moon" class="w-5 h-5"></i></div><p class="text-sm font-bold text-slate-800 dark:text-white">Karanlık Mod</p></div><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="themeToggle" class="sr-only peer" onchange="toggleTheme()"><div class="w-11 h-6 bg-slate-200 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div></label></div></section>
        <section><button onclick="handleLogout()" class="w-full py-3 rounded-xl border border-red-200 text-red-600 hover:bg-red-50 font-bold transition flex items-center justify-center gap-2"><i data-lucide="log-out" class="w-4 h-4"></i> Çıkış Yap</button></section>
      </div>
    </div>
  </div>

  <script>
    let currentUser=null,allClients=[],allProposals=[],allTemplates=[];
    let editingClientId=null,proposalItemCounter=0,quickItemCounter=0,templateItemCounter=0;
    const CLIENTS_TABLE='clients',PROPOSALS_TABLE='proposals',TEMPLATES_TABLE='proposal_templates';

    function escapeHtml(t){if(!t)return'';return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}
    function formatMoney(n,c='TRY'){const s={TRY:'₺',USD:'$',EUR:'€'};return parseFloat(n||0).toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2})+' '+(s[c]||'₺')}
    function generateProposalNo(){const d=new Date();return'TKL-'+d.getFullYear()+String(d.getMonth()+1).padStart(2,'0')+'-'+String(Math.floor(Math.random()*9000)+1000)}

    // UI Helpers
    // toggleSidebar from sidebar.js
    // toggleSubmenu from sidebar.jselse{m.classList.add('open');if(ic)ic.style.transform='rotate(180deg)'}}
    function toggleNotifDropdown(){document.getElementById('notifDropdown').classList.toggle('hidden')}
    function openSettings(){document.getElementById('settingsModal').classList.remove('hidden');lucide.createIcons()}
    function closeSettings(){document.getElementById('settingsModal').classList.add('hidden')}
    function closeModal(id){document.getElementById(id).classList.add('hidden')}
    function closeNotification(){document.getElementById('notifModal').classList.add('hidden')}

    function showNotification(title,msg,type='success'){
      const m=document.getElementById('notifModal'),ic=document.getElementById('notifIcon'),btn=document.getElementById('notifBtn');
      document.getElementById('notifTitle').innerText=title;document.getElementById('notifMsg').innerText=msg;
      ic.className='w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce-in';
      btn.className='w-full py-3 rounded-xl font-bold transition shadow-lg text-white';
      if(type==='success'){ic.classList.add('bg-green-100','text-green-600');ic.innerHTML='<i data-lucide="check" class="w-8 h-8"></i>';btn.classList.add('bg-green-600','hover:bg-green-500')}
      else if(type==='info'){ic.classList.add('bg-indigo-100','text-indigo-600');ic.innerHTML='<i data-lucide="info" class="w-8 h-8"></i>';btn.classList.add('bg-indigo-600','hover:bg-indigo-500')}
      else{ic.classList.add('bg-red-100','text-red-600');ic.innerHTML='<i data-lucide="alert-triangle" class="w-8 h-8"></i>';btn.classList.add('bg-red-600','hover:bg-red-500')}
      m.classList.remove('hidden');lucide.createIcons()
    }

    async function toggleTheme(){const d=document.getElementById('themeToggle').checked;if(d)document.documentElement.classList.add('dark');else document.documentElement.classList.remove('dark');if(currentUser)await supabaseClient.from('profiles').update({theme:d?'dark':'light'}).eq('id',currentUser.id)}
    async function loadUserProfile(){if(!currentUser)return;let{data}=await supabaseClient.from('profiles').select('*').eq('id',currentUser.id).single();if(data){if(data.theme==='dark'){document.documentElement.classList.add('dark');document.getElementById('themeToggle').checked=true}else{document.documentElement.classList.remove('dark');document.getElementById('themeToggle').checked=false}}}
    async function handleLogout(){const{error}=await supabaseClient.auth.signOut();if(!error)window.location.href='login.html'}

    // TABS
    function switchTab(name){
      document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
      document.getElementById('tab-'+name).classList.add('active');
      const btn=document.querySelector('.tab-btn[data-tab="'+name+'"]');if(btn)btn.classList.add('active');
      if(name==='quick'){initQuickForm();updateQuickPreview()}
    }

    function handleGlobalSearch(){
      const q=document.getElementById('globalSearch').value.toLowerCase();
      const active=document.querySelector('.tab-content.active').id.replace('tab-','');
      if(active==='customers'){renderClients(allClients.filter(c=>(c.name||'').toLowerCase().includes(q)||(c.contact_person||'').toLowerCase().includes(q)))}
      else if(active==='proposals'){renderProposals(allProposals.filter(p=>(p.client_name||'').toLowerCase().includes(q)||(p.subject||'').toLowerCase().includes(q)||(p.proposal_no||'').toLowerCase().includes(q)))}
    }

    // ===== CLIENTS =====
    function openNewClientModal(){
      editingClientId=null;document.getElementById('clientModalTitle').textContent='Yeni Müşteri';
      ['clientName','clientContact','clientPhone','clientEmail','clientCity','clientSector','clientTaxNo','clientAddress','clientNotes'].forEach(id=>document.getElementById(id).value='');
      document.getElementById('newClientModal').classList.remove('hidden');lucide.createIcons()
    }
    function openEditClientModal(id){
      const c=allClients.find(x=>x.id===id);if(!c)return;editingClientId=id;
      document.getElementById('clientModalTitle').textContent='Müşteri Düzenle';
      document.getElementById('clientName').value=c.name||'';document.getElementById('clientContact').value=c.contact_person||'';
      document.getElementById('clientPhone').value=c.phone||'';document.getElementById('clientEmail').value=c.email||'';
      document.getElementById('clientCity').value=c.city||'';document.getElementById('clientSector').value=c.sector||'';
      document.getElementById('clientTaxNo').value=c.tax_no||'';document.getElementById('clientAddress').value=c.address||'';
      document.getElementById('clientNotes').value=c.notes||'';
      document.getElementById('newClientModal').classList.remove('hidden');lucide.createIcons()
    }
    async function saveClient(){
      const name=document.getElementById('clientName').value.trim();
      if(!name){showNotification('Uyarı','Müşteri adı zorunludur.','error');return}
      const d={name,contact_person:document.getElementById('clientContact').value.trim(),phone:document.getElementById('clientPhone').value.trim(),email:document.getElementById('clientEmail').value.trim(),city:document.getElementById('clientCity').value.trim(),sector:document.getElementById('clientSector').value.trim(),tax_no:document.getElementById('clientTaxNo').value.trim(),address:document.getElementById('clientAddress').value.trim(),notes:document.getElementById('clientNotes').value.trim(),user_id:currentUser.id};
      let error;
      if(editingClientId)({error}=await supabaseClient.from(CLIENTS_TABLE).update(d).eq('id',editingClientId));
      else({error}=await supabaseClient.from(CLIENTS_TABLE).insert([d]));
      if(error){console.error(error);showNotification('Hata','Kayıt başarısız: '+error.message,'error');return}
      showNotification('Başarılı',editingClientId?'Müşteri güncellendi.':'Yeni müşteri eklendi.');
      closeModal('newClientModal');editingClientId=null;await fetchClients()
    }
    async function deleteClient(id){if(!confirm('Bu müşteriyi silmek istediğinize emin misiniz?'))return;const{error}=await supabaseClient.from(CLIENTS_TABLE).delete().eq('id',id);if(error){showNotification('Hata','Silinemedi.','error');return}showNotification('Bilgi','Müşteri silindi.','info');await fetchClients()}

    async function fetchClients(){
      const{data,error}=await supabaseClient.from(CLIENTS_TABLE).select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false});
      if(error){console.error(error);allClients=[]}else allClients=data||[];
      document.getElementById('statTotalClients').textContent=allClients.length;
      document.getElementById('clientCountLabel').textContent='Toplam '+allClients.length+' müşteri';
      renderClients(allClients);populateTemplateDropdowns()
    }

    function renderClients(clients){
      const tb=document.getElementById('clientsTableBody');
      if(!clients.length){tb.innerHTML='<tr><td colspan="5" class="px-6 py-12 text-center"><div class="inline-flex items-center justify-center w-12 h-12 bg-slate-100 dark:bg-slate-800 rounded-full mb-3 text-slate-400"><i data-lucide="users" class="w-6 h-6"></i></div><p class="text-slate-500 font-medium">Henüz müşteri yok.</p><p class="text-xs text-slate-400 mt-1">İlk müşterinizi ekleyin.</p></td></tr>';lucide.createIcons();return}
      const pc={};allProposals.forEach(p=>{const cid=p.client_id||'x';pc[cid]=(pc[cid]||0)+1});
      tb.innerHTML=clients.map(c=>{const cnt=pc[c.id]||0;return`<tr class="proposal-item-row border-b border-slate-100 dark:border-white/5"><td class="px-6 py-4"><div class="flex items-center gap-3"><div class="w-9 h-9 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center text-indigo-600 dark:text-indigo-400 font-bold text-sm shrink-0">${escapeHtml((c.name||'?')[0].toUpperCase())}</div><div><div class="font-bold text-slate-700 dark:text-white">${escapeHtml(c.name)}</div>${c.contact_person?'<div class="text-xs text-slate-500">'+escapeHtml(c.contact_person)+'</div>':''}</div></div></td><td class="px-6 py-4"><div class="text-xs">${escapeHtml(c.phone||'-')}</div><div class="text-xs text-slate-500">${escapeHtml(c.email||'')}</div></td><td class="px-6 py-4 text-sm">${escapeHtml(c.city||'-')}</td><td class="px-6 py-4"><span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-bold ${cnt>0?'bg-indigo-100 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400':'bg-slate-100 dark:bg-slate-800 text-slate-500'}">${cnt} teklif</span></td><td class="px-6 py-4 text-right"><div class="flex items-center justify-end gap-1"><button onclick="createProposalForClient('${c.id}','${escapeHtml(c.name)}')" class="p-2 rounded-lg text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition" title="Teklif Ver"><i data-lucide="file-plus" class="w-4 h-4"></i></button><button onclick="openEditClientModal('${c.id}')" class="p-2 rounded-lg text-slate-400 hover:text-amber-600 hover:bg-amber-50 dark:hover:bg-amber-900/20 transition" title="Düzenle"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="deleteClient('${c.id}')" class="p-2 rounded-lg text-slate-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 transition" title="Sil"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></td></tr>`}).join('');lucide.createIcons()
    }

    function createProposalForClient(cid,cname){
      document.getElementById('proposalClientInput').value=cname;document.getElementById('proposalClientId').value=cid;
      proposalItemCounter=0;document.getElementById('proposalItemsContainer').innerHTML='';addProposalItem();
      document.getElementById('newProposalModal').classList.remove('hidden');lucide.createIcons()
    }

    // ===== PROPOSALS =====
    function openNewProposalModal(){
      document.getElementById('proposalClientInput').value='';document.getElementById('proposalClientId').value='';
      document.getElementById('proposalSubject').value='';document.getElementById('proposalNotes').value='';document.getElementById('proposalTemplate').value='';
      proposalItemCounter=0;document.getElementById('proposalItemsContainer').innerHTML='';addProposalItem();updateProposalTotal();
      document.getElementById('newProposalModal').classList.remove('hidden');lucide.createIcons()
    }

    function addProposalItem(){
      proposalItemCounter++;const id=proposalItemCounter;
      document.getElementById('proposalItemsContainer').insertAdjacentHTML('beforeend',
        '<div class="flex items-center gap-2 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-700" id="pItem'+id+'">'+
        '<input type="text" placeholder="Kalem adı" class="flex-1 bg-transparent text-sm focus:outline-none min-w-0" id="pItemName'+id+'">'+
        '<input type="number" placeholder="Adet" class="w-16 bg-transparent text-sm text-center focus:outline-none" value="1" onchange="updateProposalTotal()" id="pItemQty'+id+'">'+
        '<input type="text" placeholder="Birim" class="w-14 bg-transparent text-sm text-center focus:outline-none" value="Adet" id="pItemUnit'+id+'">'+
        '<input type="number" placeholder="Fiyat" class="w-24 bg-transparent text-sm text-right focus:outline-none" onchange="updateProposalTotal()" id="pItemPrice'+id+'">'+
        '<button onclick="document.getElementById(\'pItem'+id+'\').remove();updateProposalTotal()" class="p-1 text-slate-400 hover:text-red-500 transition shrink-0"><i data-lucide="x" class="w-3.5 h-3.5"></i></button></div>');
      lucide.createIcons()
    }

    function updateProposalTotal(){
      let t=0;document.querySelectorAll('#proposalItemsContainer > div').forEach(d=>{
        const id=d.id.replace('pItem','');const q=parseFloat(document.getElementById('pItemQty'+id)?.value)||0;const p=parseFloat(document.getElementById('pItemPrice'+id)?.value)||0;t+=q*p});
      document.getElementById('proposalTotalDisplay').textContent=formatMoney(t,document.getElementById('proposalCurrency').value)
    }

    async function saveProposal(status){
      const cn=document.getElementById('proposalClientInput').value.trim(),subj=document.getElementById('proposalSubject').value.trim();
      if(!cn){showNotification('Uyarı','Müşteri adı zorunludur.','error');return}
      if(!subj){showNotification('Uyarı','Teklif konusu zorunludur.','error');return}
      const items=[];let total=0;
      document.querySelectorAll('#proposalItemsContainer > div').forEach(d=>{
        const id=d.id.replace('pItem',''),nm=document.getElementById('pItemName'+id)?.value?.trim()||'',
        q=parseFloat(document.getElementById('pItemQty'+id)?.value)||0,u=document.getElementById('pItemUnit'+id)?.value?.trim()||'Adet',
        p=parseFloat(document.getElementById('pItemPrice'+id)?.value)||0;if(nm){items.push({name:nm,qty:q,unit:u,price:p});total+=q*p}});
      const pd={user_id:currentUser.id,client_id:document.getElementById('proposalClientId').value||null,client_name:cn,subject:subj,
        proposal_no:generateProposalNo(),items:JSON.stringify(items),total_amount:total,currency:document.getElementById('proposalCurrency').value,
        validity_days:parseInt(document.getElementById('proposalValidity').value),notes:document.getElementById('proposalNotes').value.trim(),status};
      const{error}=await supabaseClient.from(PROPOSALS_TABLE).insert([pd]);
      if(error){console.error(error);showNotification('Hata','Teklif kaydedilemedi: '+error.message,'error');return}
      showNotification('Başarılı',status==='taslak'?'Taslak kaydedildi.':'Teklif oluşturuldu.');
      closeModal('newProposalModal');await fetchProposals()
    }

    async function fetchProposals(){
      const{data,error}=await supabaseClient.from(PROPOSALS_TABLE).select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false});
      if(error){console.error(error);allProposals=[]}else allProposals=data||[];
      document.getElementById('statTotalProposals').textContent=allProposals.length;
      document.getElementById('statApproved').textContent=allProposals.filter(p=>p.status==='onaylandi').length;
      document.getElementById('statPending').textContent=allProposals.filter(p=>p.status==='beklemede').length;
      document.getElementById('proposalCountLabel').textContent='Toplam '+allProposals.length+' teklif';
      renderProposals(allProposals)
    }

    function filterProposals(){const s=document.getElementById('proposalStatusFilter').value;renderProposals(s==='all'?allProposals:allProposals.filter(p=>p.status===s))}

    function renderProposals(proposals){
      const tb=document.getElementById('proposalsTableBody');
      if(!proposals.length){tb.innerHTML='<tr><td colspan="7" class="px-6 py-12 text-center"><div class="inline-flex items-center justify-center w-12 h-12 bg-slate-100 dark:bg-slate-800 rounded-full mb-3 text-slate-400"><i data-lucide="file-text" class="w-6 h-6"></i></div><p class="text-slate-500 font-medium">Teklif bulunamadı.</p></td></tr>';lucide.createIcons();return}
      const sl={taslak:'Taslak',beklemede:'Beklemede',onaylandi:'Onaylandı',reddedildi:'Reddedildi'};
      tb.innerHTML=proposals.map(p=>{const dt=new Date(p.created_at).toLocaleDateString('tr-TR');
        return'<tr class="proposal-item-row border-b border-slate-100 dark:border-white/5"><td class="px-6 py-4 font-mono text-xs font-bold text-indigo-600 dark:text-indigo-400">'+escapeHtml(p.proposal_no)+'</td><td class="px-6 py-4 font-bold text-slate-700 dark:text-white text-sm">'+escapeHtml(p.client_name)+'</td><td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-400">'+escapeHtml(p.subject||'-')+'</td><td class="px-6 py-4 font-bold text-sm">'+formatMoney(p.total_amount,p.currency)+'</td><td class="px-6 py-4"><span class="px-2.5 py-1 rounded-lg text-xs font-bold status-'+p.status+'">'+(sl[p.status]||p.status)+'</span></td><td class="px-6 py-4 text-xs text-slate-500">'+dt+'</td><td class="px-6 py-4 text-right"><div class="flex items-center justify-end gap-1"><button onclick="viewProposalDetail(\''+p.id+'\')" class="p-2 rounded-lg text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition" title="Detay"><i data-lucide="eye" class="w-4 h-4"></i></button><button onclick="updateProposalStatus(\''+p.id+'\',\'onaylandi\')" class="p-2 rounded-lg text-slate-400 hover:text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 transition" title="Onayla"><i data-lucide="check-circle" class="w-4 h-4"></i></button><button onclick="deleteProposal(\''+p.id+'\')" class="p-2 rounded-lg text-slate-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 transition" title="Sil"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></td></tr>'}).join('');lucide.createIcons()
    }

    async function updateProposalStatus(id,status){const{error}=await supabaseClient.from(PROPOSALS_TABLE).update({status}).eq('id',id);if(error){showNotification('Hata','Güncellenemedi.','error');return}const lb={onaylandi:'Onaylandı',reddedildi:'Reddedildi'};showNotification('Başarılı','Durum: '+(lb[status]||status));await fetchProposals()}
    async function deleteProposal(id){if(!confirm('Bu teklifi silmek istediğinize emin misiniz?'))return;const{error}=await supabaseClient.from(PROPOSALS_TABLE).delete().eq('id',id);if(error){showNotification('Hata','Silinemedi.','error');return}showNotification('Bilgi','Teklif silindi.','info');await fetchProposals()}

    function viewProposalDetail(id){
      const p=allProposals.find(x=>x.id===id);if(!p)return;
      const items=JSON.parse(p.items||'[]'),sl={taslak:'Taslak',beklemede:'Beklemede',onaylandi:'Onaylandı',reddedildi:'Reddedildi'};
      const dt=new Date(p.created_at).toLocaleDateString('tr-TR',{year:'numeric',month:'long',day:'numeric'});
      const vu=new Date(new Date(p.created_at).getTime()+(p.validity_days||30)*86400000).toLocaleDateString('tr-TR',{year:'numeric',month:'long',day:'numeric'});
      let ih=items.map((it,i)=>'<tr class="border-b border-slate-100 dark:border-white/5"><td class="py-2 text-sm">'+(i+1)+'</td><td class="py-2 text-sm font-medium">'+escapeHtml(it.name)+'</td><td class="py-2 text-sm text-center">'+it.qty+' '+escapeHtml(it.unit)+'</td><td class="py-2 text-sm text-right">'+formatMoney(it.price,p.currency)+'</td><td class="py-2 text-sm text-right font-bold">'+formatMoney(it.qty*it.price,p.currency)+'</td></tr>').join('');
      document.getElementById('proposalDetailContent').innerHTML='<div class="space-y-6"><div class="flex items-center justify-between"><div><span class="font-mono text-sm text-indigo-600 dark:text-indigo-400 font-bold">'+escapeHtml(p.proposal_no)+'</span><h3 class="text-xl font-black text-slate-900 dark:text-white mt-1">'+escapeHtml(p.subject||'Teklif')+'</h3></div><span class="px-3 py-1.5 rounded-lg text-xs font-bold status-'+p.status+'">'+(sl[p.status]||p.status)+'</span></div><div class="grid grid-cols-2 gap-4 p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl"><div><div class="text-xs text-slate-500 mb-1">Müşteri</div><div class="font-bold text-slate-800 dark:text-white">'+escapeHtml(p.client_name)+'</div></div><div><div class="text-xs text-slate-500 mb-1">Tarih</div><div class="font-bold text-slate-800 dark:text-white">'+dt+'</div></div><div><div class="text-xs text-slate-500 mb-1">Geçerlilik</div><div class="font-bold text-slate-800 dark:text-white">'+(p.validity_days||30)+' Gün ('+vu+')</div></div><div><div class="text-xs text-slate-500 mb-1">Para Birimi</div><div class="font-bold text-slate-800 dark:text-white">'+(p.currency||'TRY')+'</div></div></div>'+(items.length>0?'<div><h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-3">Teklif Kalemleri</h4><table class="w-full text-left"><thead><tr class="text-xs text-slate-500 uppercase"><th class="py-2 w-8">#</th><th class="py-2">Kalem</th><th class="py-2 text-center">Miktar</th><th class="py-2 text-right">Birim Fiyat</th><th class="py-2 text-right">Toplam</th></tr></thead><tbody>'+ih+'</tbody></table><div class="flex justify-end mt-4 pt-4 border-t border-slate-200 dark:border-slate-700"><div class="text-right"><div class="text-xs text-slate-500">Genel Toplam</div><div class="text-2xl font-black text-indigo-600 dark:text-indigo-400">'+formatMoney(p.total_amount,p.currency)+'</div></div></div></div>':'')+(p.notes?'<div><h4 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Notlar</h4><p class="text-sm text-slate-600 dark:text-slate-400 bg-slate-50 dark:bg-slate-800/50 rounded-xl p-4">'+escapeHtml(p.notes)+'</p></div>':'')+'</div>';
      document.getElementById('proposalDetailActions').innerHTML=(p.status!=='onaylandi'?'<button onclick="updateProposalStatus(\''+p.id+'\',\'onaylandi\');closeModal(\'proposalDetailModal\')" class="flex-1 py-2.5 rounded-xl bg-green-600 hover:bg-green-500 text-white text-sm font-bold transition">Onayla</button>':'')+(p.status!=='reddedildi'?'<button onclick="updateProposalStatus(\''+p.id+'\',\'reddedildi\');closeModal(\'proposalDetailModal\')" class="flex-1 py-2.5 rounded-xl bg-red-600 hover:bg-red-500 text-white text-sm font-bold transition">Reddet</button>':'')+'<button onclick="closeModal(\'proposalDetailModal\')" class="flex-1 py-2.5 rounded-xl border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 text-sm font-bold transition">Kapat</button>';
      document.getElementById('proposalDetailModal').classList.remove('hidden');lucide.createIcons()
    }

    // ===== AUTOCOMPLETE =====
    function handleProposalClientAutocomplete(){
      const inp=document.getElementById('proposalClientInput'),dd=document.getElementById('proposalClientDropdown'),v=inp.value.toLowerCase().trim();
      document.getElementById('proposalClientId').value='';if(v.length<1){dd.classList.add('hidden');return}
      const m=allClients.filter(c=>(c.name||'').toLowerCase().includes(v));if(!m.length){dd.classList.add('hidden');return}
      dd.innerHTML=m.slice(0,5).map(c=>'<div class="autocomplete-item text-sm text-slate-700 dark:text-slate-300" onclick="selectProposalClient(\''+c.id+'\',\''+escapeHtml(c.name)+'\')"><span class="font-bold">'+escapeHtml(c.name)+'</span>'+(c.city?' <span class="text-xs text-slate-400 ml-2">'+escapeHtml(c.city)+'</span>':'')+'</div>').join('');dd.classList.remove('hidden')
    }
    function selectProposalClient(id,name){document.getElementById('proposalClientInput').value=name;document.getElementById('proposalClientId').value=id;document.getElementById('proposalClientDropdown').classList.add('hidden')}

    function handleQuickClientAutocomplete(){
      const inp=document.getElementById('quickClientName'),dd=document.getElementById('quickClientDropdown'),v=inp.value.toLowerCase().trim();
      if(v.length<1){dd.classList.add('hidden');updateQuickPreview();return}
      const m=allClients.filter(c=>(c.name||'').toLowerCase().includes(v));if(!m.length){dd.classList.add('hidden');updateQuickPreview();return}
      dd.innerHTML=m.slice(0,5).map(c=>'<div class="autocomplete-item text-sm text-slate-700 dark:text-slate-300" onclick="selectQuickClient(\''+c.id+'\')"><span class="font-bold">'+escapeHtml(c.name)+'</span>'+(c.city?' <span class="text-xs text-slate-400 ml-2">'+escapeHtml(c.city)+'</span>':'')+'</div>').join('');dd.classList.remove('hidden');updateQuickPreview()
    }
    function selectQuickClient(id){const c=allClients.find(x=>x.id===id);if(!c)return;document.getElementById('quickClientName').value=c.name||'';document.getElementById('quickContactPerson').value=c.contact_person||'';document.getElementById('quickPhone').value=c.phone||'';document.getElementById('quickClientDropdown').classList.add('hidden');updateQuickPreview()}

    // ===== QUICK PROPOSAL =====
    function initQuickForm(){if(document.getElementById('quickItemsContainer').children.length===0){quickItemCounter=0;addQuickItem()}}
    function addQuickItem(){
      quickItemCounter++;const id=quickItemCounter;
      document.getElementById('quickItemsContainer').insertAdjacentHTML('beforeend',
        '<div class="flex items-center gap-2 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-700" id="qItem'+id+'">'+
        '<input type="text" placeholder="Kalem adı" class="flex-1 bg-transparent text-sm focus:outline-none min-w-0" oninput="updateQuickPreview()" id="qItemName'+id+'">'+
        '<input type="number" placeholder="Adet" class="w-16 bg-transparent text-sm text-center focus:outline-none" value="1" onchange="updateQuickPreview()" id="qItemQty'+id+'">'+
        '<input type="text" placeholder="Birim" class="w-14 bg-transparent text-sm text-center focus:outline-none" value="Adet" id="qItemUnit'+id+'">'+
        '<input type="number" placeholder="Fiyat" class="w-24 bg-transparent text-sm text-right focus:outline-none" onchange="updateQuickPreview()" id="qItemPrice'+id+'">'+
        '<button onclick="document.getElementById(\'qItem'+id+'\').remove();updateQuickPreview()" class="p-1 text-slate-400 hover:text-red-500 transition shrink-0"><i data-lucide="x" class="w-3.5 h-3.5"></i></button></div>');
      lucide.createIcons()
    }

    function updateQuickPreview(){
      const cn=document.getElementById('quickClientName')?.value||'',ct=document.getElementById('quickContactPerson')?.value||'',
        subj=document.getElementById('quickSubject')?.value||'',notes=document.getElementById('quickNotes')?.value||'',
        cur=document.getElementById('quickCurrency')?.value||'TRY',val=document.getElementById('quickValidity')?.value||'30';
      const items=[];let total=0;
      document.querySelectorAll('#quickItemsContainer > div').forEach(d=>{
        const id=d.id.replace('qItem',''),nm=document.getElementById('qItemName'+id)?.value?.trim()||'',
        q=parseFloat(document.getElementById('qItemQty'+id)?.value)||0,u=document.getElementById('qItemUnit'+id)?.value?.trim()||'',
        p=parseFloat(document.getElementById('qItemPrice'+id)?.value)||0;if(nm){items.push({name:nm,qty:q,unit:u,price:p});total+=q*p}});
      const today=new Date().toLocaleDateString('tr-TR',{year:'numeric',month:'long',day:'numeric'});
      const vd=new Date(Date.now()+parseInt(val)*86400000).toLocaleDateString('tr-TR',{year:'numeric',month:'long',day:'numeric'});
      const pv=document.getElementById('quickPreview');
      if(!cn&&items.length===0){pv.innerHTML='<div class="text-center text-slate-400 text-sm py-12">Bilgileri doldurmaya başlayın...</div>';return}
      let ih=items.map((it,i)=>'<tr class="border-b border-slate-100 dark:border-white/5 text-xs"><td class="py-1.5">'+(i+1)+'</td><td class="py-1.5">'+escapeHtml(it.name)+'</td><td class="py-1.5 text-center">'+it.qty+' '+escapeHtml(it.unit)+'</td><td class="py-1.5 text-right">'+formatMoney(it.price,cur)+'</td><td class="py-1.5 text-right font-bold">'+formatMoney(it.qty*it.price,cur)+'</td></tr>').join('');
      pv.innerHTML='<div class="space-y-4"><div class="flex items-center justify-between border-b border-slate-200 dark:border-slate-700 pb-4"><div><div class="text-lg font-black text-slate-900 dark:text-white">TEKLİF</div><div class="text-xs text-slate-500">'+today+'</div></div><div class="text-right"><div class="text-xs text-slate-500">Optimizi.App</div></div></div><div class="grid grid-cols-2 gap-3 text-xs"><div class="p-3 bg-slate-50 dark:bg-slate-800/30 rounded-lg"><div class="text-slate-400 mb-1">Müşteri</div><div class="font-bold text-slate-800 dark:text-white">'+(escapeHtml(cn)||'-')+'</div>'+(ct?'<div class="text-slate-500 mt-0.5">'+escapeHtml(ct)+'</div>':'')+'</div><div class="p-3 bg-slate-50 dark:bg-slate-800/30 rounded-lg"><div class="text-slate-400 mb-1">Geçerlilik</div><div class="font-bold text-slate-800 dark:text-white">'+val+' Gün</div><div class="text-slate-500 mt-0.5">'+vd+'</div></div></div>'+(subj?'<div class="text-sm font-bold text-slate-700 dark:text-slate-300">Konu: '+escapeHtml(subj)+'</div>':'')+(items.length>0?'<table class="w-full text-left"><thead><tr class="text-[10px] text-slate-500 uppercase border-b border-slate-200 dark:border-slate-700"><th class="py-1.5 w-6">#</th><th class="py-1.5">Kalem</th><th class="py-1.5 text-center">Miktar</th><th class="py-1.5 text-right">Birim</th><th class="py-1.5 text-right">Toplam</th></tr></thead><tbody>'+ih+'</tbody></table><div class="flex justify-end pt-2 border-t border-slate-200 dark:border-slate-700"><div class="text-right"><div class="text-xs text-slate-500">Genel Toplam</div><div class="text-xl font-black text-indigo-600 dark:text-indigo-400">'+formatMoney(total,cur)+'</div></div></div>':'')+(notes?'<div class="text-xs text-slate-500 p-3 bg-slate-50 dark:bg-slate-800/30 rounded-lg"><strong>Not:</strong> '+escapeHtml(notes)+'</div>':'')+'</div>'
    }

    async function saveQuickProposal(status){
      const cn=document.getElementById('quickClientName').value.trim(),subj=document.getElementById('quickSubject').value.trim();
      if(!cn){showNotification('Uyarı','Müşteri adı zorunludur.','error');return}
      const items=[];let total=0;
      document.querySelectorAll('#quickItemsContainer > div').forEach(d=>{
        const id=d.id.replace('qItem',''),nm=document.getElementById('qItemName'+id)?.value?.trim()||'',
        q=parseFloat(document.getElementById('qItemQty'+id)?.value)||0,u=document.getElementById('qItemUnit'+id)?.value?.trim()||'Adet',
        p=parseFloat(document.getElementById('qItemPrice'+id)?.value)||0;if(nm){items.push({name:nm,qty:q,unit:u,price:p});total+=q*p}});
      const mc=allClients.find(c=>c.name.toLowerCase()===cn.toLowerCase());
      const pd={user_id:currentUser.id,client_id:mc?mc.id:null,client_name:cn,subject:subj||'Hızlı Teklif',proposal_no:generateProposalNo(),
        items:JSON.stringify(items),total_amount:total,currency:document.getElementById('quickCurrency').value,
        validity_days:parseInt(document.getElementById('quickValidity').value),notes:document.getElementById('quickNotes').value.trim(),status};
      const{error}=await supabaseClient.from(PROPOSALS_TABLE).insert([pd]);
      if(error){console.error(error);showNotification('Hata','Teklif kaydedilemedi: '+error.message,'error');return}
      showNotification('Başarılı',status==='taslak'?'Taslak kaydedildi.':'Hızlı teklif oluşturuldu.');
      ['quickClientName','quickContactPerson','quickPhone','quickSubject','quickNotes'].forEach(id=>document.getElementById(id).value='');
      quickItemCounter=0;document.getElementById('quickItemsContainer').innerHTML='';addQuickItem();updateQuickPreview();await fetchProposals()
    }

    // ===== TEMPLATES =====
    function openNewTemplateModal(){
      document.getElementById('templateName').value='';document.getElementById('templateDesc').value='';document.getElementById('templateNotes').value='';
      templateItemCounter=0;document.getElementById('templateItemsContainer').innerHTML='';addTemplateItem();
      document.getElementById('newTemplateModal').classList.remove('hidden');lucide.createIcons()
    }
    function addTemplateItem(){
      templateItemCounter++;const id=templateItemCounter;
      document.getElementById('templateItemsContainer').insertAdjacentHTML('beforeend',
        '<div class="flex items-center gap-2 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-700" id="tItem'+id+'">'+
        '<input type="text" placeholder="Kalem adı" class="flex-1 bg-transparent text-sm focus:outline-none min-w-0" id="tItemName'+id+'">'+
        '<input type="text" placeholder="Birim" class="w-16 bg-transparent text-sm text-center focus:outline-none" value="Adet" id="tItemUnit'+id+'">'+
        '<input type="number" placeholder="Fiyat" class="w-24 bg-transparent text-sm text-right focus:outline-none" id="tItemPrice'+id+'">'+
        '<button onclick="document.getElementById(\'tItem'+id+'\').remove()" class="p-1 text-slate-400 hover:text-red-500 transition shrink-0"><i data-lucide="x" class="w-3.5 h-3.5"></i></button></div>');
      lucide.createIcons()
    }
    async function saveTemplate(){
      const name=document.getElementById('templateName').value.trim();if(!name){showNotification('Uyarı','Şablon adı zorunludur.','error');return}
      const items=[];document.querySelectorAll('#templateItemsContainer > div').forEach(d=>{
        const id=d.id.replace('tItem',''),nm=document.getElementById('tItemName'+id)?.value?.trim()||'',
        u=document.getElementById('tItemUnit'+id)?.value?.trim()||'Adet',p=parseFloat(document.getElementById('tItemPrice'+id)?.value)||0;
        if(nm)items.push({name:nm,unit:u,price:p})});
      const td={user_id:currentUser.id,name,description:document.getElementById('templateDesc').value.trim(),items:JSON.stringify(items),notes:document.getElementById('templateNotes').value.trim()};
      const{error}=await supabaseClient.from(TEMPLATES_TABLE).insert([td]);
      if(error){console.error(error);showNotification('Hata','Şablon kaydedilemedi: '+error.message,'error');return}
      showNotification('Başarılı','Şablon oluşturuldu.');closeModal('newTemplateModal');await fetchTemplates()
    }
    async function deleteTemplate(id){if(!confirm('Bu şablonu silmek istediğinize emin misiniz?'))return;const{error}=await supabaseClient.from(TEMPLATES_TABLE).delete().eq('id',id);if(error){showNotification('Hata','Silinemedi.','error');return}showNotification('Bilgi','Şablon silindi.','info');await fetchTemplates()}

    async function fetchTemplates(){
      const{data,error}=await supabaseClient.from(TEMPLATES_TABLE).select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false});
      if(error){console.error(error);allTemplates=[]}else allTemplates=data||[];renderTemplates(allTemplates);populateTemplateDropdowns()
    }
    function renderTemplates(templates){
      const g=document.getElementById('templatesGrid');
      if(!templates.length){g.innerHTML='<div class="col-span-full text-center py-12"><div class="inline-flex items-center justify-center w-12 h-12 bg-slate-100 dark:bg-slate-800 rounded-full mb-3 text-slate-400"><i data-lucide="layout-template" class="w-6 h-6"></i></div><p class="text-slate-500 font-medium">Henüz şablon yok.</p><p class="text-xs text-slate-400 mt-1">Tekliflerinizi hızlandırın.</p></div>';lucide.createIcons();return}
      g.innerHTML=templates.map(t=>{const items=JSON.parse(t.items||'[]');return'<div class="glass-card rounded-xl p-5 hover:shadow-lg transition group"><div class="flex items-start justify-between mb-3"><div class="p-2 bg-purple-100 dark:bg-purple-900/30 rounded-lg text-purple-600 dark:text-purple-400"><i data-lucide="file-check" class="w-5 h-5"></i></div><div class="flex gap-1"><button onclick="useTemplate(\''+t.id+'\')" class="p-1.5 rounded-lg text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition" title="Kullan"><i data-lucide="copy" class="w-3.5 h-3.5"></i></button><button onclick="deleteTemplate(\''+t.id+'\')" class="p-1.5 rounded-lg text-slate-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 transition" title="Sil"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button></div></div><h4 class="font-bold text-slate-800 dark:text-white mb-1">'+escapeHtml(t.name)+'</h4><p class="text-xs text-slate-500 mb-3">'+escapeHtml(t.description||'Açıklama yok')+'</p><div class="text-xs text-slate-400">'+items.length+' kalem</div></div>'}).join('');lucide.createIcons()
    }

    function populateTemplateDropdowns(){
      const opts=allTemplates.map(t=>'<option value="'+t.id+'">'+escapeHtml(t.name)+'</option>').join('');
      const base='<option value="">Şablon kullanma</option>'+opts;
      const qs=document.getElementById('quickTemplate'),ps=document.getElementById('proposalTemplate');
      if(qs)qs.innerHTML=base;if(ps)ps.innerHTML=base
    }

    function loadTemplateToQuick(){
      const tId=document.getElementById('quickTemplate').value;if(!tId)return;
      const t=allTemplates.find(x=>x.id===tId);if(!t)return;const items=JSON.parse(t.items||'[]');
      quickItemCounter=0;document.getElementById('quickItemsContainer').innerHTML='';
      items.forEach(it=>{quickItemCounter++;const id=quickItemCounter;
        document.getElementById('quickItemsContainer').insertAdjacentHTML('beforeend',
          '<div class="flex items-center gap-2 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-700" id="qItem'+id+'">'+
          '<input type="text" value="'+escapeHtml(it.name)+'" class="flex-1 bg-transparent text-sm focus:outline-none min-w-0" oninput="updateQuickPreview()" id="qItemName'+id+'">'+
          '<input type="number" value="1" class="w-16 bg-transparent text-sm text-center focus:outline-none" onchange="updateQuickPreview()" id="qItemQty'+id+'">'+
          '<input type="text" value="'+escapeHtml(it.unit)+'" class="w-14 bg-transparent text-sm text-center focus:outline-none" id="qItemUnit'+id+'">'+
          '<input type="number" value="'+(it.price||'')+'" class="w-24 bg-transparent text-sm text-right focus:outline-none" onchange="updateQuickPreview()" id="qItemPrice'+id+'">'+
          '<button onclick="document.getElementById(\'qItem'+id+'\').remove();updateQuickPreview()" class="p-1 text-slate-400 hover:text-red-500 transition shrink-0"><i data-lucide="x" class="w-3.5 h-3.5"></i></button></div>')});
      if(t.notes)document.getElementById('quickNotes').value=t.notes;lucide.createIcons();updateQuickPreview()
    }

    function loadTemplateToProposal(){
      const tId=document.getElementById('proposalTemplate').value;if(!tId)return;
      const t=allTemplates.find(x=>x.id===tId);if(!t)return;const items=JSON.parse(t.items||'[]');
      proposalItemCounter=0;document.getElementById('proposalItemsContainer').innerHTML='';
      items.forEach(it=>{proposalItemCounter++;const id=proposalItemCounter;
        document.getElementById('proposalItemsContainer').insertAdjacentHTML('beforeend',
          '<div class="flex items-center gap-2 p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-700" id="pItem'+id+'">'+
          '<input type="text" value="'+escapeHtml(it.name)+'" class="flex-1 bg-transparent text-sm focus:outline-none min-w-0" id="pItemName'+id+'">'+
          '<input type="number" value="1" class="w-16 bg-transparent text-sm text-center focus:outline-none" onchange="updateProposalTotal()" id="pItemQty'+id+'">'+
          '<input type="text" value="'+escapeHtml(it.unit)+'" class="w-14 bg-transparent text-sm text-center focus:outline-none" id="pItemUnit'+id+'">'+
          '<input type="number" value="'+(it.price||'')+'" class="w-24 bg-transparent text-sm text-right focus:outline-none" onchange="updateProposalTotal()" id="pItemPrice'+id+'">'+
          '<button onclick="document.getElementById(\'pItem'+id+'\').remove();updateProposalTotal()" class="p-1 text-slate-400 hover:text-red-500 transition shrink-0"><i data-lucide="x" class="w-3.5 h-3.5"></i></button></div>')});
      if(t.notes)document.getElementById('proposalNotes').value=t.notes;lucide.createIcons();updateProposalTotal()
    }

    function useTemplate(tId){switchTab('quick');setTimeout(()=>{document.getElementById('quickTemplate').value=tId;loadTemplateToQuick()},100)}

    // ===== INIT =====
    async function initPage(){
      if(!window.currentUser){const{data:{session}}=await supabaseClient.auth.getSession();if(!session){window.location.href='login.html';return}currentUser=session.user}
      else currentUser=window.currentUser;
      const fn=currentUser.user_metadata?.full_name||currentUser.email.split('@')[0],fi=fn.split(' ')[0];
      if(typeof updateSidebarUser==='function')updateSidebarUser(fn);
      const mn=document.getElementById('modalName');if(mn)mn.textContent=fn;
      const me=document.getElementById('modalEmail');if(me)me.textContent=currentUser.email;
      const ma=document.getElementById('modalAvatar');if(ma)ma.textContent=fi.charAt(0).toUpperCase();
      await loadUserProfile();await Promise.all([fetchClients(),fetchProposals(),fetchTemplates()])
    }
    initPage();lucide.createIcons();
  </script>
</body>
</html>
