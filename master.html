<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Fiyat Teklif Aracı | Optimizi.App</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap');

:root {
    /* DARK THEME */
    --bg-grad: radial-gradient(circle at top right, #1e1b4b, #0f172a, #020617);
    --bg-nav: rgba(15, 23, 42, 0.75);
    --bg-card: rgba(30, 41, 59, 0.6);
    --bg-card-hov: rgba(30, 41, 59, 0.9);
    --bg-th: rgba(15, 23, 42, 0.95);
    --bg-inp: rgba(0, 0, 0, 0.3);
    
    --brd: rgba(255, 255, 255, 0.08);
    --brd-td: rgba(255, 255, 255, 0.04);
    
    --tx: #f8fafc;
    --tx-mut: #94a3b8;
    
    --ac: #6366f1;
    --cy: #06b6d4;
    --gn: #10b981;
    --rd: #f43f5e;
    --am: #f59e0b;
    
    --sW: 260px;
}

[data-theme="light"] {
    /* LIGHT THEME */
    --bg-grad: radial-gradient(circle at top right, #e0e7ff, #f8fafc, #f1f5f9);
    --bg-nav: rgba(255, 255, 255, 0.8);
    --bg-card: rgba(255, 255, 255, 0.6);
    --bg-card-hov: rgba(255, 255, 255, 0.95);
    --bg-th: rgba(241, 245, 249, 0.95);
    --bg-inp: rgba(0, 0, 0, 0.04);
    
    --brd: rgba(0, 0, 0, 0.1);
    --brd-td: rgba(0, 0, 0, 0.05);
    
    --tx: #0f172a;
    --tx-mut: #64748b;
}

* { margin:0; padding:0; box-sizing:border-box; font-family:'Inter', sans-serif !important; }
.font-mono { font-family:'JetBrains Mono', monospace !important; }

body { background:var(--bg-grad); color:var(--tx); height:100vh; overflow:hidden; display:flex; transition: background 0.3s ease, color 0.3s ease; }

::-webkit-scrollbar { width:6px; height:6px; }
::-webkit-scrollbar-thumb { background:var(--brd); border-radius:4px; }

/* LAYOUT & SIDEBARS */
.snav { width:var(--sW); min-width:var(--sW); height:100vh; background:var(--bg-nav); backdrop-filter:blur(16px); border-right:1px solid var(--brd); display:flex; flex-direction:column; overflow:hidden; z-index:20; transition:width 0.3s ease; }
.snav.collapsed { width: 80px; min-width: 80px; }
.snav.collapsed .logo span, .snav.collapsed .slink span, .snav.collapsed .nav-title { display: none; }
.snav.collapsed .slink { justify-content: center; padding: 12px 0; }

.snav .logo { padding:24px; display:flex; align-items:center; gap:12px; border-bottom:1px solid var(--brd); }
.snav .logo .ic { width:40px; height:40px; border-radius:10px; background:linear-gradient(135deg,var(--cy),var(--ac)); display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 15px rgba(99,102,241,.2); flex-shrink: 0; }
.snav .links { flex:1; padding:16px; display:flex; flex-direction:column; gap:4px; overflow-y:auto; }

.slink { display:flex; align-items:center; gap:12px; padding:12px 16px; border-radius:10px; cursor:pointer; font-size:.85rem; font-weight:600; color:var(--tx-mut); transition:.2s; border:1px solid transparent; background:none; width:100%; text-align:left; white-space: nowrap; overflow: hidden; }
.slink:hover { color:var(--tx); background:var(--bg-card); }
.slink.on { background:rgba(99,102,241,.15); color:var(--ac); border-color:rgba(99,102,241,.3); box-shadow:0 4px 12px rgba(0,0,0,.05); }

.rsnav { position: fixed; right: 0; top: 0; bottom: 0; width: 340px; background: var(--bg-nav); border-left: 1px solid var(--brd); transform: translateX(100%); transition: transform 0.3s ease; z-index: 50; padding: 24px; backdrop-filter: blur(20px); box-shadow: -10px 0 30px rgba(0,0,0,0.1); }
.rsnav.open { transform: translateX(0); }

.mn { flex:1; display:flex; flex-direction:column; overflow:hidden; position:relative; }
.tbar { height:64px; display:flex; align-items:center; justify-content:space-between; padding:0 32px; border-bottom:1px solid var(--brd); background:var(--bg-nav); backdrop-filter:blur(16px); flex-shrink:0; z-index:10; transition:0.3s; }
.pane { display:none; flex:1; overflow:auto; padding:24px; }
.pane.on { display:flex; flex-direction:column; animation:fadeIn 0.3s ease; }
@keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }

/* SPREADSHEET */
.ss { width:100%; border-collapse:separate; border-spacing:0; font-size:.76rem; }
.ss th { background:var(--bg-th); color:var(--ac); font-size:.68rem; font-weight:800; text-transform:uppercase; letter-spacing:.5px; padding:10px 12px; text-align:center; border-bottom:1px solid var(--brd); position:sticky; top:0; z-index:2; white-space:nowrap; transition:0.3s; backdrop-filter:blur(8px); }
.resizable-th { resize: horizontal; overflow: auto; min-width: 100px; }
.ss td { padding:0; border-bottom:1px solid var(--brd-td); height:36px; min-width:50px; transition:.2s; }
.ss tr:hover td { background:var(--bg-inp); }

.ss input, .ss select { width:100%; height:100%; border:none; background:transparent; color:var(--tx); font-family:inherit; font-size:.76rem; padding:4px 8px; outline:none; transition:0.2s; font-weight:500; }
.ss input:focus, .ss select:focus { background:rgba(99,102,241,.1); box-shadow:inset 0 0 0 1px var(--ac); }
.ss input[type=number] { text-align:right; -moz-appearance:textfield; }

.ss .c { font-weight:600; text-align:right; padding:4px 10px; }
.ss .o { background:rgba(245,158,11,.1)!important; color:var(--am)!important; cursor:pointer; }
.ss .o:hover { background:rgba(245,158,11,.2)!important; }
.ss .lb { font-weight:700; padding:4px 12px; color:var(--tx-mut); white-space:nowrap; }
.ss .hd { background:rgba(99,102,241,.07); font-weight:800; color:var(--ac); padding:8px 12px; font-size:.76rem; text-transform:uppercase; letter-spacing:.3px; }
.ss .hd2 { background:rgba(6,182,212,.07); font-weight:700; color:var(--cy); padding:6px 12px; }
.ss .g { color:var(--gn); font-weight:700; text-align:right; padding:4px 10px; }
.ss .r { color:var(--rd); font-weight:700; text-align:right; padding:4px 10px; }

/* Cards & UI */
.cd { background:var(--bg-card); border:1px solid var(--brd); border-radius:12px; padding:16px; backdrop-filter:blur(10px); transition:0.2s; }
.cd:hover { border-color:rgba(99,102,241,.3); }
.st { display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:8px; font-weight:800; font-size:.85rem; margin-bottom:12px; }
.st.i { background:rgba(99,102,241,.1); color:var(--ac); }
.st.c { background:rgba(6,182,212,.1); color:var(--cy); }
.st.a { background:rgba(245,158,11,.1); color:var(--am); }
.st.e { background:rgba(16,185,129,.1); color:var(--gn); }

.kpi { text-align:center; padding:20px; display:flex; flex-direction:column; justify-content:center; }
.kpi .v { font-size:1.6rem; font-weight:800; letter-spacing:-0.5px; }
.kpi .k { font-size:.65rem; font-weight:700; color:var(--tx-mut); text-transform:uppercase; letter-spacing:1px; margin-top:6px; }

.bt { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:8px 16px; border-radius:8px; font-weight:700; font-size:.8rem; cursor:pointer; border:none; transition:.2s; }
.bt1 { background:var(--ac); color:#fff; box-shadow:0 4px 15px rgba(99,102,241,.25); } .bt1:hover { filter:brightness(1.1); transform:translateY(-1px); }
.bt2 { background:rgba(244,63,94,.15); color:var(--rd); } .bt2:hover { background:rgba(244,63,94,.25); }
.bt3 { background:rgba(16,185,129,.15); color:var(--gn); } .bt3:hover { background:rgba(16,185,129,.25); }
.bt4 { background:transparent; color:var(--tx-mut); border:1px solid var(--brd); } .bt4:hover { color:var(--tx); border-color:var(--tx); }
.bt4.on { background:var(--ac); color:#fff; border-color:var(--ac); box-shadow:0 4px 12px rgba(99,102,241,.2); }

.pr { display:flex; align-items:center; padding:4px 0; }
.pr .l { flex:1; font-size:.8rem; font-weight:600; color:var(--tx-mut); padding-left:4px; }
.pr input, .pr select { width:100px; background:var(--bg-inp); border:1px solid var(--brd); padding:6px 10px; border-radius:6px; color:var(--tx); font-family:'JetBrains Mono',monospace; font-size:.8rem; text-align:right; outline:none; transition:.2s; }
.pr input:focus, .pr select:focus { border-color:var(--ac); }
.pr input:disabled { opacity: 0.5; cursor: not-allowed; }
.pr .u { font-size:.7rem; color:var(--tx-mut); width:35px; text-align:left; padding-left:8px; }
.ps { background:var(--bg-inp); border:1px solid var(--brd); padding:6px 10px; border-radius:6px; color:var(--tx); font-size:.8rem; outline:none; width:100%; transition:.2s; }
.ps:focus { border-color:var(--ac); }

.tg { display:inline-flex; gap:2px; background:var(--bg-inp); border-radius:8px; padding:3px; }
.tg button { padding:6px 14px; border-radius:6px; font-size:.75rem; font-weight:700; border:none; cursor:pointer; color:var(--tx-mut); background:transparent; transition:0.2s; }
.tg button.on { background:var(--ac); color:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.2); }

/* Modals */
.opt-modal-bg { position:fixed; inset:0; z-index:1000; background:rgba(0,0,0,0.6); backdrop-filter:blur(8px); display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:0.2s; }
.opt-modal-bg.show { opacity:1; pointer-events:auto; }
.opt-modal { background:var(--bg-nav); border:1px solid var(--brd); border-radius:16px; padding:28px; width:480px; max-width:95vw; max-height:90vh; overflow-y:auto; box-shadow:0 25px 50px -12px rgba(0,0,0,0.5); transform:scale(0.95); transition:0.2s; color:var(--tx); }
.opt-modal-bg.show .opt-modal { transform:scale(1); }
.opt-modal h3 { font-size:1.1rem; font-weight:800; margin-bottom:16px; display:flex; align-items:center; gap:8px; }
.opt-modal label { display:block; font-size:.75rem; font-weight:700; color:var(--tx-mut); text-transform:uppercase; margin:12px 0 4px; }

/* Custom Checkbox */
.custom-chk { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 0.75rem; color: var(--tx-mut); font-weight: 600; }
.custom-chk input { accent-color: var(--ac); width: 14px; height: 14px; cursor: pointer; }

details > summary { list-style: none; cursor: pointer; }
details > summary::-webkit-details-marker { display: none; }

/* Toast */
.toast-container { position:fixed; bottom:24px; right:24px; z-index:2000; display:flex; flex-direction:column; gap:10px; }
.toast { background:var(--bg-nav); border:1px solid var(--brd); padding:12px 16px; border-radius:10px; display:flex; align-items:center; gap:12px; font-size:.85rem; font-weight:600; box-shadow:0 10px 25px rgba(0,0,0,0.3); animation:slideIn 0.3s cubic-bezier(0.175,0.885,0.32,1.275) forwards; }
@keyframes slideIn { from{transform:translateX(100%);opacity:0} to{transform:translateX(0);opacity:1} }
.toast.ok i { color:var(--gn); } .toast.er i { color:var(--rd); } .toast.in i { color:var(--cy); }
</style>
</head>
<body>

<nav class="snav" id="snav">
 <div class="logo">
  <div class="ic"><i data-lucide="shield-check" class="text-white"></i></div>
  <div>
    <div class="text-sm font-extrabold tracking-tight">Optimizi.App</div>
    <div class="text-[9px] text-gray-400 font-bold uppercase tracking-widest">Fiyat Teklif Aracı</div>
  </div>
 </div>
 <div class="links">
  <button class="bt bt4 w-full mb-4 flex items-center justify-center gap-2" id="toggleSidebarBtn"><i data-lucide="menu" class="w-4 h-4"></i> <span class="text-xs">Menüyü Daralt</span></button>
  
  <button class="slink on" onclick="go('pl',this)"><i data-lucide="file-spreadsheet"></i><span>Fiyat Listesi</span></button>
  <button class="slink" onclick="go('pd',this)"><i data-lucide="layout-grid"></i><span>Ürün Detay</span></button>
  <button class="slink" onclick="go('ms',this)"><i data-lucide="pie-chart"></i><span>Genel Özet</span></button>
  <button class="slink" onclick="go('pm',this)"><i data-lucide="users"></i><span>Personel Maliyetleri</span></button>
  <div class="nav-title px-4 py-3 mt-2 text-[9px] font-bold text-[var(--tx-mut)] uppercase tracking-widest">Veritabanı</div>
  <button class="slink" onclick="go('mf',this)"><i data-lucide="database"></i><span>Malzeme Fiyatları</span></button>
  <button class="slink" onclick="go('pr',this)"><i data-lucide="sliders-horizontal"></i><span>Parametreler</span></button>
 </div>
 <div class="nav-title p-4 border-t border-[var(--brd)] text-[10px] text-[var(--tx-mut)] font-mono text-center">v2.7 Pro | O.G.</div>
</nav>

<div class="rsnav" id="rightSidebar">
  <div class="flex items-center justify-between mb-6 border-b border-[var(--brd)] pb-4">
    <h2 class="font-bold text-lg flex items-center gap-2"><i data-lucide="settings-2" class="text-indigo-400"></i> Genel Ayarlar</h2>
    <button onclick="document.getElementById('rightSidebar').classList.remove('open')" class="text-red-400 hover:text-red-500"><i data-lucide="x"></i></button>
  </div>
  <div class="mb-4">
    <label class="block text-xs font-bold text-[var(--tx-mut)] uppercase mb-2">Ürün Kodu Ön Eki (Prefix)</label>
    <input type="text" id="prefInput" class="ps" placeholder="Örn: INSJACK" onchange="updatePrefix(this.value)">
    <p class="text-[10px] text-[var(--tx-mut)] mt-2 leading-relaxed">Kullanıcının tekelindedir. Varsayılan olarak eklenen bu ibareyi silebilir veya dilediğiniz gibi değiştirebilirsiniz.</p>
  </div>
  <div class="mt-8">
    <label class="block text-xs font-bold text-[var(--tx-mut)] uppercase mb-2">Döviz API Durumu (TCMB)</label>
    <div id="apiStatusBadge" class="bg-emerald-500/20 text-emerald-400 px-3 py-2 rounded font-bold text-xs flex items-center gap-2">
      <i data-lucide="check-circle" class="w-4 h-4"></i> Senkronize Edildi
    </div>
  </div>
</div>

<div class="mn">
<div class="tbar">
 <div class="flex gap-4 text-xs font-bold items-center">
  <div class="cd py-1.5 px-4 flex items-center gap-2" style="padding:6px 16px"><span class="text-[10px] text-[var(--tx-mut)] uppercase">Kalem</span><span id="sI" class="text-cyan-400 font-mono text-sm">0</span></div>
  <div class="cd py-1.5 px-4 flex items-center gap-2" style="padding:6px 16px"><span class="text-[10px] text-[var(--tx-mut)] uppercase">Ceket</span><span id="sJ" class="text-indigo-400 font-mono text-sm">0</span></div>
  <div class="cd py-1.5 px-4 flex items-center gap-2" style="padding:6px 16px"><span class="text-[10px] text-[var(--tx-mut)] uppercase">Adam×Sa</span><span id="sH" class="text-amber-400 font-mono text-sm">0</span></div>
 </div>
 <div class="flex gap-3 items-center">
  <button onclick="toggleTheme()" class="bt bt4 px-2" id="themeBtn" title="Tema Değiştir"><i data-lucide="sun" class="w-4 h-4"></i></button>
  <button onclick="document.getElementById('rightSidebar').classList.add('open')" class="bt bt4 px-2" title="Genel Ayarlar"><i data-lucide="settings" class="w-4 h-4"></i></button>
  <button onclick="saveData()" class="bt bt1"><i data-lucide="save" class="w-4 h-4"></i>Kaydet</button>
  <button onclick="openPdfModal()" class="bt bt4 hover:bg-indigo-500/20"><i data-lucide="file-down" class="w-4 h-4"></i>PDF İndir</button>
 </div>
</div>

<div id="p-pl" class="pane on">
 <div class="flex flex-col h-full">
  <div class="flex items-center justify-between mb-4">
   <div class="tg" id="curToggle"></div>
   <div class="text-xs text-blue-400 font-semibold bg-blue-500/10 px-4 py-2 rounded-lg border border-blue-500/20"><i data-lucide="info" class="w-3 h-3 inline relative -top-0.5 mr-1"></i> Malzeme ve Ayarlar tablosu "Ürün Detay" sayfasına taşınmıştır. Listede miktar değiştirmek için adete çift tıkla. Sütun genişliklerini tablodan tutup çekebilirsiniz.</div>
  </div>
  <div class="flex-1 overflow-auto rounded-xl border border-[var(--brd)]">
   <table class="ss" id="tPL"><thead id="plHead"></thead><tbody id="plBody"></tbody>
   <tfoot><tr id="plFoot"></tr></tfoot></table>
  </div>
 </div>
</div>

<div id="p-pd" class="pane">

 <details class="mb-6 border border-[var(--brd)] rounded-xl bg-[var(--bg-card)] overflow-hidden shadow-sm" open>
   <summary class="p-4 font-bold flex justify-between items-center text-[var(--tx)] bg-[rgba(0,0,0,0.1)] border-b border-[var(--brd)]">
      <div class="flex items-center gap-2"><i data-lucide="settings-2" class="text-cyan-400"></i> Global Malzeme & Üretim Ayarları (Aç/Kapat)</div>
      <i data-lucide="chevron-down" class="w-4 h-4 text-[var(--tx-mut)]"></i>
   </summary>
   <div class="p-6">
     <div id="plGlobal"></div>
   </div>
 </details>

<div class="flex items-center gap-3 mb-4 flex-wrap bg-[var(--bg-card)] p-4 rounded-xl border border-[var(--brd)] shadow-sm">
 <select id="aType" class="ps" style="width:170px" onchange="updDN()">
  <option value="">Ekipman Tipi...</option>
  <option value="piston">Pistonlu Vana</option>
  <option value="globe">Glob Vana</option>
  <option value="bellow">Körüklü Vana</option>
  <option value="gate">Sürgülü Vana</option>
  <option value="butterfly">Kelebek Vana</option>
  <option value="3way">Üç Yollu Vana</option>
  <option value="yfilter">Pislik Tutucu (Y)</option>
  <option value="check_clv">Lift Çekvalf</option>
  <option value="ball_2">2 Parçalı Küresel</option>
  <option value="ball_3">3 Parçalı Küresel</option>
  <option value="trap">Kondenstop</option>
  <option value="flange">Flanş</option>
  <option value="elbow">Dirsek</option>
 </select>
 <select id="aDN" class="ps" style="width:90px"><option value="">DN</option></select>
 <select id="aCls" class="ps" style="width:100px"><option value="150">PN16/150</option><option value="300">PN25/300</option><option value="400">PN40/400</option></select>
 <input type="number" id="aQty" class="ps font-mono" style="width:70px;text-align:center" value="1" min="1" title="Adet">
 <button onclick="addItem()" class="bt bt1 px-4"><i data-lucide="plus" class="w-4 h-4"></i>Ekle</button>
 
 <div class="ml-auto flex items-center gap-4 border-l border-[var(--brd)] pl-4">
  <div class="flex items-center gap-3 bg-[var(--bg-inp)] px-3 py-1.5 rounded-lg border border-[var(--brd)]">
     <span class="text-[10px] font-bold text-[var(--tx-mut)] uppercase">Sütunlar:</span>
     <label class="custom-chk"><input type="checkbox" id="cKumas" checked onchange="toggleCols()"> Kumaş</label>
     <label class="custom-chk"><input type="checkbox" id="cDolgu" checked onchange="toggleCols()"> Dolgu</label>
     <label class="custom-chk"><input type="checkbox" id="cDikis" checked onchange="toggleCols()"> Dikiş</label>
     <label class="custom-chk"><input type="checkbox" id="cPul" checked onchange="toggleCols()"> Agraf/Pul</label>
  </div>
  <select id="pdCur" class="ps font-bold" style="width:80px" onchange="recalcAll()"><option value="TL">TL</option><option value="USD">USD</option><option value="EUR">EUR</option></select>
  <button onclick="optConfirm('Tüm listeyi temizlemek istediğinize emin misiniz?', ()=>{IT=[];RN=1;recalcAll()})" class="bt bt2 px-3"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
 </div>
</div>
<div class="flex-1 overflow-auto rounded-xl border border-[var(--brd)] shadow-sm">
 <table class="ss" id="tPD">
 <thead><tr>
  <th class="resizable-th">REF</th><th class="resizable-th" style="min-width:110px">Tip</th><th class="resizable-th">Parça</th><th class="resizable-th">DN</th><th class="resizable-th">Cls</th><th class="resizable-th" style="width:55px">Adet</th><th class="resizable-th" style="width:55px" class="text-indigo-400">Zorluk</th>
  <th class="resizable-th">Alt Kumaş</th><th class="resizable-th">Üst Kumaş</th><th class="resizable-th">Dolgu</th>
  <th class="resizable-th" style="background:rgba(245,158,11,.1); color:var(--am)">İzol</th><th class="resizable-th">F.Çap</th>
  <th class="resizable-th" title="Sıcaklık (°C)">Sıcaklık(°C)</th><th class="resizable-th" title="Yalıtım Kalınlığı (mm)">Yalıtım(mm)</th>
  
  <th class="col-kumas resizable-th" style="background:rgba(6,182,212,.08); color:var(--cy)">Kumaş(m²)</th>
  <th class="col-dolgu resizable-th" style="background:rgba(6,182,212,.08); color:var(--cy)">Dolgu(m²)</th>
  <th class="col-dikis resizable-th" style="background:rgba(6,182,212,.08); color:var(--cy)">Dikiş(m)</th>
  <th class="col-dikis resizable-th" style="background:rgba(6,182,212,.08); color:var(--cy)">Boğma(m)</th>
  <th class="col-dikis resizable-th" style="background:rgba(6,182,212,.08); color:var(--cy)">Cırt(m)</th>
  <th class="col-pul resizable-th" style="background:rgba(6,182,212,.08); color:var(--cy)">Agf(Ad)</th>
  <th class="col-pul resizable-th" style="background:rgba(6,182,212,.08); color:var(--cy)">Pul(Ad)</th>
  
  <th class="resizable-th" style="background:rgba(99,102,241,.1)">Mlz Fyt</th><th class="resizable-th" style="background:rgba(99,102,241,.1)">İşç Fyt</th><th class="resizable-th" style="background:rgba(16,185,129,.1)">B.Mly</th><th class="resizable-th" style="background:rgba(16,185,129,.1)">B.Satış</th><th class="resizable-th" style="background:rgba(16,185,129,.15)">Toplam</th><th></th>
 </tr></thead><tbody id="pdBody"></tbody><tfoot id="pdFoot"></tfoot></table>
</div>
</div>

<div id="p-ms" class="pane">
<div class="grid grid-cols-2 lg:grid-cols-5 gap-5 mb-6">
 <div class="cd kpi border-b-4 border-cyan-500"><div class="v text-cyan-400" id="kC">₺0</div><div class="k">Toplam Maliyet</div></div>
 <div class="cd kpi border-b-4 border-emerald-500"><div class="v text-emerald-400" id="kS">₺0</div><div class="k">Satış Bedeli</div></div>
 <div class="cd kpi border-b-4 border-amber-500"><div class="v text-amber-400" id="kP">₺0</div><div class="k">Kâr</div></div>
 <div class="cd kpi border-b-4 border-indigo-500"><div class="v text-indigo-400" id="kM">%0</div><div class="k">Kâr Marjı</div></div>
 <div class="cd kpi bg-purple-500/10 border-b-4 border-purple-500">
    <div class="flex items-center justify-center gap-2">
       <span class="text-xl font-bold text-[var(--tx-mut)]">x</span>
       <input type="number" id="msMul" class="font-mono text-[1.6rem] font-bold text-purple-400 bg-transparent outline-none w-20 text-center border-b-2 border-purple-500/50 focus:border-purple-400" step="0.1" value="2.5" onchange="P.mul=parseFloat(this.value)||2.5;recalcAll()">
    </div>
    <div class="k text-purple-300">Satış Çarpanı</div>
 </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
 <div class="cd flex flex-col">
  <div class="flex items-center justify-between mb-4 border-b border-[var(--brd)] pb-3">
     <div class="st e mb-0 bg-transparent p-0"><i data-lucide="calculator" class="w-4 h-4"></i>Maliyet Kırılımı</div>
     <div class="flex items-center gap-2 bg-[var(--bg-inp)] px-2 py-1 rounded">
        <span class="text-[10px] font-bold text-[var(--tx-mut)] uppercase">Overhead %</span>
        <input type="number" id="msOh" class="ps p-1 w-12 text-center font-bold text-cyan-400" onchange="P.oh=parseFloat(this.value)/100||0;recalcAll()">
     </div>
  </div>
  <div class="flex-1 overflow-auto rounded-xl border border-[var(--brd)]"><table class="ss" id="tMC"></table></div>
 </div>
 
 <div class="cd flex flex-col">
  <div class="st c mb-4 border-b border-[var(--brd)] pb-3 bg-transparent p-0"><i data-lucide="package" class="w-4 h-4"></i>Malzeme Toplamları</div>
  <div class="flex-1 overflow-auto rounded-xl border border-[var(--brd)]"><table class="ss" id="tMM"></table></div>
 </div>
 
 <div class="cd flex flex-col">
  <div class="st a mb-4 border-b border-[var(--brd)] pb-3 bg-transparent p-0"><i data-lucide="briefcase" class="w-4 h-4"></i>Hizmet Bedelleri</div>
  <div class="space-y-3 flex-1" id="msServices"></div>
  <div class="mt-4 pt-4 border-t border-[var(--brd)] flex justify-between items-center bg-[var(--bg-inp)] p-3 rounded-lg"><span class="font-extrabold text-sm uppercase text-[var(--tx-mut)]">Toplam Hizmet</span><span class="font-extrabold text-amber-400 font-mono text-lg" id="msSvcTotal">₺0</span></div>
 </div>
</div>

<div class="cd mt-6 w-full">
 <div class="st i mb-4"><i data-lucide="globe" class="w-4 h-4"></i>Döviz & Kâr Analizi</div>
 <div class="rounded-xl overflow-hidden border border-[var(--brd)]"><table class="ss" id="tMS"></table></div>
 <div class="mt-4 grid grid-cols-3 gap-4">
  <div class="cd kpi bg-[var(--bg-inp)] p-4"><div class="v text-[1.2rem] text-[var(--tx)] font-mono" id="msAH">0</div><div class="k">Adam×Saat (Toplam)</div></div>
  <div class="cd kpi bg-[var(--bg-inp)] p-4"><div class="v text-[1.2rem] text-[var(--tx)] font-mono" id="msAD">0</div><div class="k">Adam Gün (Toplam)</div></div>
  <div class="cd kpi bg-[var(--bg-inp)] p-4"><div class="v text-[1.2rem] text-[var(--tx)] font-mono" id="msJC">0</div><div class="k">Toplam Üretilecek Ceket</div></div>
 </div>
</div>
</div>

<div id="p-mf" class="pane">
<div class="flex items-center justify-between mb-4">
  <div class="tg" id="mfBtns"></div>
  <button onclick="openMatModal()" class="bt bt3 px-6 shadow-lg"><i data-lucide="plus" class="w-4 h-4"></i>Yeni Malzeme Ekle</button>
</div>
<div class="flex-1 overflow-auto rounded-xl border border-[var(--brd)]"><table class="ss"><thead><tr><th>#</th><th>Tür</th><th>Alt Tip</th><th style="min-width:180px">Malzeme Cinsi</th><th>Birim</th><th>Fiyat</th><th>Döviz</th><th style="background:rgba(16,185,129,.1); color:var(--gn)">TL Fiyat</th><th>Kalınlık(mm)</th><th></th></tr></thead><tbody id="mBody"></tbody></table></div>
</div>

<div id="p-pm" class="pane">
<div class="grid grid-cols-1 lg:grid-cols-4 gap-5 mb-5">
 <div class="cd kpi"><div class="v text-cyan-400" id="pmAvg">₺0</div><div class="k">Ort. Saat Maliyeti</div></div>
 <div class="cd kpi"><div class="v text-indigo-400" id="pmCnt">0</div><div class="k">Personel Sayısı</div></div>
 <div class="cd kpi"><div class="v text-emerald-400" id="pmTot">₺0</div><div class="k">Yıllık Toplam Maliyet</div></div>
 <div class="cd kpi"><div class="v text-amber-400" id="pmDay">₺0</div><div class="k">Günlük Toplam</div></div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-4 gap-5 mb-5">
 <div class="cd"><div class="st a"><i data-lucide="settings" class="w-4 h-4"></i>Ortak Parametreler</div>
  <div id="pmParams"></div>
 </div>
 <div class="lg:col-span-3 flex flex-col">
  <div class="flex items-center justify-between mb-3">
   <div class="text-xs text-[var(--tx-mut)] font-bold"><i data-lucide="info" class="w-3 h-3 inline relative -top-0.5"></i> Hesaplanan saat maliyeti sistemin ana işçilik gideri olarak kullanılır (Otomatik Senkronize).</div>
   <button onclick="openPersModal()" class="bt bt3"><i data-lucide="user-plus" class="w-4 h-4"></i>Personel Ekle</button>
  </div>
  <div class="flex-1 overflow-auto rounded-xl border border-[var(--brd)]"><table class="ss"><thead><tr>
   <th>#</th><th>Görev</th><th style="min-width:140px">Ad Soyad</th><th>Aylık Net</th>
   <th style="background:rgba(6,182,212,.08)">Yıllık Brüt</th><th style="background:rgba(6,182,212,.08)">Kıdem</th><th style="background:rgba(6,182,212,.08)">İzin</th>
   <th>Servis</th><th>Yemek</th><th>KKD</th>
   <th style="background:rgba(245,158,11,.1); color:var(--am)">Fazla Ç.</th><th style="background:rgba(99,102,241,.1); color:var(--ac)">Yıllık Top.</th><th style="background:rgba(16,185,129,.15); color:var(--gn)">Saat Mly</th><th></th>
  </tr></thead><tbody id="pmBody"></tbody>
  <tfoot><tr><td colspan="10" class="lb text-right font-extrabold">ORTALAMA / TOPLAM</td><td class="c font-mono text-amber-400" id="pmFcTot"></td><td class="c font-mono text-indigo-400 font-bold" id="pmNTot"></td><td class="c font-mono text-emerald-400 font-black text-[1rem]" id="pmOTot"></td><td></td></tr></tfoot></table></div>
 </div>
</div>
</div>

<div id="p-pr" class="pane">
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
 <div class="cd"><div class="st c"><i data-lucide="coins" class="w-4 h-4"></i>Döviz & İşçilik</div><div id="pDov" class="space-y-1"></div></div>
 <div class="cd"><div class="st a"><i data-lucide="ruler" class="w-4 h-4"></i>Fire & Geometri (Dolgu Payları Dahil)</div><div id="pFir" class="space-y-1"></div></div>
 <div class="cd"><div class="st e"><i data-lucide="hard-hat" class="w-4 h-4"></i>İşçilik Sabitleri</div><div id="pLab" class="space-y-1"></div></div>
</div>

<div class="bg-indigo-500/10 border border-indigo-500/20 p-4 rounded-xl mt-6">
  <h3 class="font-bold text-indigo-400 flex items-center gap-2 mb-2"><i data-lucide="cpu"></i> Yapay Zeka Extrapolasyon Aktif</h3>
  <p class="text-xs text-[var(--tx-mut)]">Sisteme girilen PDF referans tablolarındaki eksik (büyük) çaplar DN15-1000 bandında tam kapsayıcılık sağlamak adına DN300 baz alınarak doğrusal oranlama ile otomatik olarak doldurulmuştur.</p>
</div>

<div class="cd mt-4"><div class="st i"><i data-lucide="circle" class="w-4 h-4"></i>Flanş Çap Tablosu (mm) [Dolduruldu]</div><div class="overflow-auto max-h-[42vh] rounded-lg border border-[var(--brd)]"><table class="ss" id="tFl"></table></div></div>
<div class="cd mt-6"><div class="st c"><i data-lucide="move-horizontal" class="w-4 h-4"></i>Gövde Uzunluk L1/L2 (mm) [Dolduruldu]</div>
 <div class="flex gap-2 mb-3"><button onclick="slt('gate')" class="bt bt4 on" id="bl-gate">Sürgülü (Gate)</button><button onclick="slt('globe')" class="bt bt4" id="bl-globe">Glob/Körüklü</button></div>
 <div class="overflow-auto max-h-[42vh] rounded-lg border border-[var(--brd)]"><table class="ss" id="tLn"></table></div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
 <div class="cd"><div class="st c"><i data-lucide="gauge" class="w-4 h-4"></i>Vana Referans Ölçüleri (PDF Kaynak)</div>
  <div class="flex gap-2 mb-3">
    <select id="vRefSel" class="ps font-semibold" style="width:260px" onchange="rVRef()">
       <option value="PV-16">Pistonlu Vana PN16</option>
       <option value="GV-16K">Glob Vana PN16 (Pik)</option>
       <option value="GV-25Z">Glob Vana PN25 (Sfero)</option>
       <option value="GV-40K">Glob Vana PN40 (Çelik)</option>
       <option value="MK-16">Körüklü Vana PN16</option>
       <option value="MK-40">Körüklü Vana PN40</option>
       <option value="GTK-18">Sürgülü Vana PN16</option>
    </select>
  </div>
  <div class="overflow-auto max-h-[35vh] rounded-lg border border-[var(--brd)]"><table class="ss" id="tVRef"></table></div>
 </div>
 <div class="cd"><div class="st a"><i data-lucide="circle-dot" class="w-4 h-4"></i>Agraf & Pul (Çap'a Göre)</div><div class="overflow-auto max-h-[35vh] rounded-lg border border-[var(--brd)]"><table class="ss" id="tAg"></table></div></div>
</div>
</div>
</div>

<div class="opt-modal-bg" id="modalMat"><div class="opt-modal">
 <h3><i data-lucide="plus-circle" class="w-5 h-5 text-emerald-400"></i>Yeni Malzeme Ekle</h3>
 <label>Tür</label><select id="nmType" class="ps"><option>Kumaş</option><option>Dolgu</option><option>Yardımcı</option><option>Isıtıcı</option></select>
 <label>Alt Tip</label><input id="nmSub" class="ps" placeholder="örn: Cam Elyaf, Taş Yünü...">
 <label>Malzeme Cinsi</label><input id="nmName" class="ps" placeholder="örn: 1 Sİ - 0.5 mm - Gri">
 <label>Birim</label><input id="nmUnit" class="ps" value="M²">
 <div class="grid grid-cols-2 gap-3 mt-1">
  <div><label>Fiyat</label><input type="number" id="nmPrice" class="ps" step=".001" value="0"></div>
  <div><label>Döviz</label><select id="nmCur" class="ps"><option>TL</option><option>USD</option><option>EUR</option></select></div>
 </div>
 <label>Kalınlık Sabiti (mm) [Dolgu Payı İçin]</label><input type="number" id="nmThick" class="ps" placeholder="opsiyonel">
 <div class="flex gap-3 mt-6"><button onclick="submitMat()" class="bt bt1 flex-1 py-3">Kaydet & Ekle</button><button onclick="document.getElementById('modalMat').classList.remove('show')" class="bt bt4 flex-1 py-3">İptal</button></div>
</div></div>

<div class="opt-modal-bg" id="qtyModal"><div class="opt-modal" style="width:400px">
 <h3><i data-lucide="alert-triangle" class="w-5 h-5 text-amber-400"></i>Adet Uyarısı</h3>
 <p class="text-sm text-[var(--tx-mut)] mb-4 leading-relaxed">Fiyat Listesi'ndeki adet ile Ürün Detay'daki adet <strong class="text-amber-400">birbiriyle çarpılır</strong>.</p>
 <p class="text-sm mb-4 font-bold">Mevcut Çarpan: <span id="qmCur" class="text-indigo-400 font-mono text-lg ml-2">1</span></p>
 <label>Yeni Adet</label><input type="number" id="qmVal" class="ps font-mono text-lg" min="1" value="1">
 <div class="flex gap-3 mt-6"><button onclick="submitQty()" class="bt bt1 flex-1 py-3">Uygula</button><button onclick="document.getElementById('qtyModal').classList.remove('show')" class="bt bt4 flex-1 py-3">İptal</button></div>
</div></div>

<div class="opt-modal-bg" id="persModal"><div class="opt-modal">
 <h3><i data-lucide="user-plus" class="w-5 h-5 text-cyan-400"></i>Personel Ekle</h3>
 <label>Görev</label><select id="npGorev" class="ps"><option>USTABAŞI</option><option>ORTACI</option><option selected>DİKİŞÇİ</option><option>DOLUMCU</option><option>KALİTE</option><option>DİĞER</option></select>
 <label>Ad Soyad</label><input id="npAd" class="ps" placeholder="Ad Soyad">
 <label>Aylık Net Ücret (₺)</label><input type="number" id="npNet" class="ps font-mono text-lg" step="100" value="48000">
 <div class="grid grid-cols-2 gap-3 mt-1">
  <div><label>Kıdem Birikimi Var mı?</label><select id="npKidem" class="ps"><option value="1">Evet (formülle)</option><option value="0">Hayır</option></select></div>
  <div><label>Servis Gideri (₺/ay)</label><input type="number" id="npServis" class="ps font-mono" value="2750"></div>
 </div>
 <div class="flex gap-3 mt-6"><button onclick="submitPers()" class="bt bt1 flex-1 py-3">Ekle</button><button onclick="document.getElementById('persModal').classList.remove('show')" class="bt bt4 flex-1 py-3">İptal</button></div>
</div></div>

<div class="opt-modal-bg" id="pdfModal"><div class="opt-modal" style="width:800px; max-width:90vw; height:80vh; display:flex; flex-direction:column;">
 <div class="flex justify-between items-center mb-4">
    <h3><i data-lucide="file-text" class="text-indigo-400"></i> Fiyat Listesi Önizleme (PDF)</h3>
    <button onclick="document.getElementById('pdfModal').classList.remove('show')" class="text-[var(--tx-mut)] hover:text-red-400"><i data-lucide="x"></i></button>
 </div>
 <div class="flex-1 bg-white overflow-auto p-8 rounded text-gray-800 relative" id="pdfContentToPrint">
    <div class="text-center mb-8 border-b-2 border-gray-800 pb-4">
       <h1 class="text-3xl font-black tracking-widest text-gray-900">TEKLİF LİSTESİ</h1>
       <p class="text-sm font-bold mt-2" id="pdfPrefixTitle"></p>
    </div>
    <table class="w-full text-left border-collapse text-sm">
      <thead>
        <tr class="bg-gray-200 border-b-2 border-gray-800 text-gray-900">
          <th class="p-2">Kod</th>
          <th class="p-2">Açıklama</th>
          <th class="p-2 text-center">Çap (DN)</th>
          <th class="p-2 text-center">Miktar</th>
          <th class="p-2 text-right">Birim Fiyat</th>
          <th class="p-2 text-right">Toplam Fiyat</th>
        </tr>
      </thead>
      <tbody id="pdfTableBody"></tbody>
      <tfoot id="pdfTableFoot"></tfoot>
    </table>
 </div>
 <div class="mt-4 flex gap-4 justify-end">
    <button onclick="document.getElementById('pdfModal').classList.remove('show')" class="bt bt4 px-6">Vazgeç</button>
    <button onclick="downloadPDF()" class="bt bt1 px-6"><i data-lucide="download"></i> Onayla ve İndir</button>
 </div>
</div></div>

<div class="opt-modal-bg" id="optConfirmBg"><div class="opt-modal" style="width:400px">
 <h3 class="text-amber-400"><i data-lucide="alert-circle"></i> Onay Gerekli</h3>
 <p class="text-sm text-[var(--tx-mut)] mb-6 mt-2" id="optConfirmMsg"></p>
 <div class="flex gap-3"><button id="optConfirmYes" class="bt bt2 flex-1 py-3">Evet</button><button onclick="document.getElementById('optConfirmBg').classList.remove('show')" class="bt bt4 flex-1 py-3">İptal</button></div>
</div></div>

<div class="toast-container" id="toastBox"></div>

<script>
// THEME MANAGER
let currentTheme = localStorage.getItem('insjack_theme') || 'dark';
document.documentElement.setAttribute('data-theme', currentTheme);
function toggleTheme() {
    currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', currentTheme);
    localStorage.setItem('insjack_theme', currentTheme);
    document.getElementById('themeBtn').innerHTML = `<i data-lucide="${currentTheme === 'dark' ? 'sun' : 'moon'}" class="w-4 h-4"></i>`;
    lucide.createIcons();
}

document.getElementById('toggleSidebarBtn').onclick = () => {
    document.getElementById('snav').classList.toggle('collapsed');
};

const VALVE_DATA={"PV-16":{"desc":"Pistonlu Vana PN16","pn":16,"dims":{"15":{"D":95,"L":130,"H":0,"Dk":100},"20":{"D":105,"L":150,"H":0,"Dk":100},"25":{"D":115,"L":160,"H":0,"Dk":120},"32":{"D":135,"L":180,"H":0,"Dk":140},"40":{"D":145,"L":200,"H":0,"Dk":140},"50":{"D":160,"L":230,"H":0,"Dk":200},"65":{"D":180,"L":290,"H":0,"Dk":200},"80":{"D":195,"L":310,"H":0,"Dk":240},"100":{"D":215,"L":350,"H":0,"Dk":280},"125":{"D":245,"L":400,"H":0,"Dk":360},"150":{"D":280,"L":480,"H":0,"Dk":360},"200":{"D":335,"L":600,"H":0,"Dk":400}}},"GV-16K":{"desc":"Glob Vana PN16 (Pik Döküm)","pn":16,"dims":{"15":{"D":95,"L":130,"H":210,"Dk":100},"20":{"D":105,"L":150,"H":210,"Dk":100},"25":{"D":115,"L":160,"H":210,"Dk":120},"32":{"D":140,"L":180,"H":210,"Dk":140},"40":{"D":150,"L":200,"H":245,"Dk":140},"50":{"D":165,"L":230,"H":255,"Dk":200},"65":{"D":185,"L":290,"H":310,"Dk":200},"80":{"D":200,"L":310,"H":325,"Dk":240},"100":{"D":220,"L":350,"H":385,"Dk":280},"125":{"D":250,"L":400,"H":435,"Dk":360},"150":{"D":285,"L":480,"H":475,"Dk":360},"200":{"D":340,"L":600,"H":620,"Dk":400},"250":{"D":405,"L":730,"H":740,"Dk":450},"300":{"D":460,"L":850,"H":853,"Dk":600}}},"GV-25Z":{"desc":"Glob Vana PN25 (Sfero Döküm)","pn":25,"dims":{"15":{"D":95,"L":130,"H":167,"Dk":100},"20":{"D":105,"L":150,"H":167,"Dk":100},"25":{"D":115,"L":160,"H":175,"Dk":120},"32":{"D":140,"L":180,"H":186,"Dk":120},"40":{"D":150,"L":200,"H":235,"Dk":160},"50":{"D":165,"L":230,"H":248,"Dk":160},"65":{"D":185,"L":290,"H":260,"Dk":180},"80":{"D":200,"L":310,"H":291,"Dk":200},"100":{"D":235,"L":350,"H":338,"Dk":250},"125":{"D":270,"L":400,"H":373,"Dk":250},"150":{"D":300,"L":480,"H":429,"Dk":320},"200":{"D":360,"L":600,"H":529,"Dk":360}}},"GV-40K":{"desc":"Glob Vana PN40 (Çelik Döküm)","pn":40,"dims":{"15":{"D":95,"L":130,"H":190,"Dk":140},"20":{"D":105,"L":150,"H":190,"Dk":140},"25":{"D":115,"L":160,"H":195,"Dk":160},"32":{"D":140,"L":180,"H":210,"Dk":180},"40":{"D":150,"L":200,"H":220,"Dk":180},"50":{"D":165,"L":230,"H":230,"Dk":200},"65":{"D":185,"L":290,"H":280,"Dk":200},"80":{"D":200,"L":310,"H":290,"Dk":250},"100":{"D":235,"L":350,"H":365,"Dk":280},"125":{"D":270,"L":400,"H":390,"Dk":300},"150":{"D":300,"L":480,"H":545,"Dk":315},"200":{"D":375,"L":600,"H":680,"Dk":400}}},"MK-16":{"desc":"Körüklü Vana PN16 (Pik Döküm)","pn":16,"dims":{"15":{"D":95,"L":130,"H":178,"Dk":125},"20":{"D":105,"L":150,"H":178,"Dk":125},"25":{"D":115,"L":160,"H":193,"Dk":125},"32":{"D":140,"L":180,"H":201,"Dk":125},"40":{"D":150,"L":200,"H":224,"Dk":150},"50":{"D":165,"L":230,"H":228,"Dk":150},"65":{"D":185,"L":290,"H":270,"Dk":175},"80":{"D":200,"L":310,"H":295,"Dk":200},"100":{"D":220,"L":350,"H":325,"Dk":250},"125":{"D":250,"L":400,"H":380,"Dk":300},"150":{"D":285,"L":480,"H":427,"Dk":400},"200":{"D":340,"L":600,"H":569,"Dk":500},"250":{"D":405,"L":730,"H":645,"Dk":500}}},"MK-40":{"desc":"Körüklü Vana PN40 (Çelik Döküm)","pn":40,"dims":{"15":{"D":95,"L":130,"H":189,"Dk":125},"20":{"D":105,"L":150,"H":189,"Dk":125},"25":{"D":115,"L":160,"H":189,"Dk":125},"32":{"D":140,"L":180,"H":220,"Dk":150},"40":{"D":150,"L":200,"H":220,"Dk":150},"50":{"D":165,"L":230,"H":295,"Dk":200},"65":{"D":185,"L":290,"H":295,"Dk":200},"80":{"D":200,"L":310,"H":368,"Dk":300},"100":{"D":235,"L":350,"H":368,"Dk":300},"125":{"D":270,"L":400,"H":523,"Dk":400},"150":{"D":300,"L":480,"H":523,"Dk":400}}},"GTK-18":{"desc":"Sürgülü Vana PN16 (GGG-50)","pn":16,"dims":{"50":{"D":165,"L":150,"H":215,"Dk":200},"65":{"D":185,"L":170,"H":250,"Dk":200},"80":{"D":200,"L":180,"H":275,"Dk":254},"100":{"D":220,"L":190,"H":320,"Dk":254},"125":{"D":250,"L":200,"H":355,"Dk":315},"150":{"D":285,"L":210,"H":398,"Dk":315},"200":{"D":340,"L":230,"H":495,"Dk":315},"250":{"D":405,"L":250,"H":590,"Dk":406},"300":{"D":460,"L":270,"H":670,"Dk":406}}}};
const EXCEL_DATA={"fx":{"USD":32.1,"EUR":35.2},"hc":250,"mat":[{"t":"Kumaş","s":"Cam Elyaf","n":"1 Sİ - 0.5 mm - Gri","u":"M²","p":2.49,"c":"USD","k":null},{"t":"Kumaş","s":"Cam Elyaf","n":"2 Sİ - 0.5 mm - Gri","u":"M²","p":2.95,"c":"USD","k":null},{"t":"Dolgu","s":"Taş Yünü","n":"TY-50mm","u":"M²","p":285,"c":"TL","k":45},{"t":"Dolgu","s":"İğnelenmiş Cam Elyaf","n":"İCE - 20mm","u":"M²","p":6.3,"c":"EUR","k":20},{"t":"Yardımcı","s":"Dikiş İpi","n":"SS - 3","u":"MT","p":0.013,"c":"USD","k":null},{"t":"Yardımcı","s":"Cırtbant","n":"40 mm - Gri","u":"MT","p":0.5,"c":"EUR","k":null},{"t":"Yardımcı","s":"Boğma İpi","n":"CamElyf-4mm","u":"MT","p":0.25,"c":"USD","k":null},{"t":"Yardımcı","s":"Zımba Set","n":"SS Z+A+P","u":"SET","p":0.06,"c":"USD","k":null},{"t":"Yardımcı","s":"Ç.Pul Set","n":"SS Ç.Pul Set","u":"ADET","p":0.15,"c":"USD","k":null},{"t":"Yardımcı","s":"Toka","n":"D-Toka","u":"ADET","p":0.25,"c":"USD","k":null},{"t":"Yardımcı","s":"Etiket","n":"30*60","u":"ADET","p":3.2,"c":"TL","k":null}],"fd":{"15":{"150":89,"300":95,"400":95},"50":{"150":152,"300":165,"400":165},"100":{"150":229,"300":254,"400":254},"300":{"150":483,"300":521,"400":521}},"bl":{"gate":{"15":{"150":{"L1":140}},"50":{"150":{"L1":191}},"100":{"150":{"L1":242}},"300":{"150":{"L1":369}}},"globe":{"15":{"150":{"L1":140}},"50":{"150":{"L1":216}},"100":{"150":{"L1":305}},"300":{"150":{"L1":711}}}},"ap":{"1":{"a":0,"p":0},"2":{"a":0,"p":0},"4":{"a":4,"p":2},"12":{"a":6,"p":4}}};

const DN_LIST=[15,20,25,32,40,50,65,80,100,125,150,200,250,300,350,400,450,500,600,700,800,900,1000];
const DN_INCH={15:.5,20:.75,25:1,32:1.25,40:1.5,50:2,65:2.5,80:3,100:4,125:5,150:6,200:8,250:10,300:12,350:14,400:16,450:18,500:20,600:24,700:28,800:32,900:36,1000:40};
const CLS=[150,300,400];

// EKİPMAN TÜRLERİ VE EŞLEŞTİRMELERİ GÜNCELLENDİ (Madde: Kelebek Vana, Kondenstop, Flanş, Dirsek Eklendi)
const TN = {piston:'Pistonlu Vana', globe:'Glob Vana', bellow:'Körüklü Vana', gate:'Sürgülü Vana', '3way':'Üç Yollu Vana', yfilter:'Pislik Tutucu (Y)', check_clv:'Lift Çekvalf', ball_2:'2 Parçalı Küresel', ball_3:'3 Parçalı Küresel', butterfly:'Kelebek Vana', trap:'Kondenstop', flange:'Flanş', elbow:'Dirsek'};
const TT = {piston:'globe', globe:'globe', bellow:'globe', gate:'gate', '3way':'globe', yfilter:'globe', check_clv:'globe', ball_2:'gate', ball_3:'gate', butterfly:'gate', trap:'globe', flange:'gate', elbow:'gate'};
const TP = {piston:['Gövde','Flanş'], globe:['Gövde','Flanş','Kapak'], bellow:['Gövde','Flanş','Kapak'], gate:['Gövde','Flanş'], '3way':['Gövde','Flanş','Kapak'], yfilter:['Gövde'], check_clv:['Gövde'], ball_2:['Gövde','Flanş'], ball_3:['Gövde','Flanş'], butterfly:['Gövde','Flanş'], trap:['Gövde'], flange:['Flanş'], elbow:['Gövde']};

let P={usd:32.1, eur:35.2, hc:250, oh:.15, mul:2.5, pd:60, ir:.03, sr:.00948, fw:.15, iw:.10, sw:.3, fr:50, fl:50, sm:15, re:150, lbw:.01, lbx:.3, lby:.3, lbyf:.2, gFB:'1 Sİ - 0.5 mm - Gri', gFT:'1 Sİ - 0.5 mm - Gri', gFL:'TY-50mm', gST:'SS - 3', gDS:'CamElyf-4mm', gVL:'40 mm - Gri', gSP:'SS Z+A+P', gND:'SS Ç.Pul Set', gBK:'D-Toka', gLB:'30*60', gDF:1, prefix:'INSJACK'};
let M=[], FD={}, BL={}, AP={}, TK={}, IT=[], RN=1, plQty={}, curShow={TL:true,USD:false,EUR:true};
let colVis={kumas:true, dolgu:true, dikis:true, pul:true};
let SVC={cad:0, montajGun:0, montajGunMly:0, nakliye:0};
let PP={gun:22, servis:2750, yemek:220, kkd:31200, saat:9, fcRate:0.05, ekKat:0};
let PERS=[];

const fm=(v,d=2)=>Number(v).toLocaleString('tr-TR',{minimumFractionDigits:d,maximumFractionDigits:d});
const ftl=v=>'₺'+fm(v); const feu=v=>'€'+fm(v); const fus=v=>'$'+fm(v);
function mn2(n){return M.find(m=>m.n===n)}
function mp(m){if(!m)return 0; return m.c==='USD'?m.p*P.usd:m.c==='EUR'?m.p*P.eur:m.p}
function tk2(n){return TK[n]||20}
function gfd(dn,cl){return (FD[dn]&&FD[dn][cl])||0}
function gbl(ty,dn,cl){
    const t=TT[ty]; if(!t||!BL[t]||!BL[t][dn])return{L1:0,L1p:0,L2:0};
    if(BL[t][dn][cl])return BL[t][dn][cl];
    const a=Object.keys(BL[t][dn]).map(Number).sort((x,y)=>x-y);
    const c=a.reduce((p,c2)=>Math.abs(c2-cl)<Math.abs(p-cl)?c2:p,a[0]);
    return BL[t][dn][c]||{L1:0,L1p:0,L2:0}
}
function gap(inch){return AP[String(inch)]||{a:0,p:0}}
function curConv(tl,cur){return cur==='USD'?tl/P.usd:cur==='EUR'?tl/P.eur:tl}

async function fetchRates() {
    try {
        const res = await fetch('https://api.genelpara.com/embed/doviz.json');
        const data = await res.json();
        if(data && data.EUR && data.USD) {
            P.eur = parseFloat(data.EUR.satis) || P.eur;
            P.usd = parseFloat(data.USD.satis) || P.usd;
            document.getElementById('apiStatusBadge').innerHTML = `<i data-lucide="check-circle" class="w-4 h-4"></i> Güncel: ${P.usd}₺ / ${P.eur}₺`;
            lucide.createIcons();
            recalcAll();
        }
    } catch(err) {
        document.getElementById('apiStatusBadge').innerHTML = `<i data-lucide="alert-triangle" class="w-4 h-4 text-amber-400"></i> API Hatası (Varsayılan)`;
    }
}

function calcAllPers(){
 let tN=0,tO=0,tM=0,cnt=PERS.length;
 PERS.forEach(p=>{
   const E=p.net*1.4*12, F=p.kidem?E/12:0, G=p.kidem?F/2:0;
   const base=E+F+G+(p.servis||0)*12+PP.yemek*PP.gun*12+PP.kkd;
   const M=base*PP.fcRate*1.5, N=base+M, O=N/12/PP.gun/PP.saat/(1+PP.fcRate);
   p._c={E,F,G,M,N,O}; tN+=N; tO+=O; tM+=M;
 });
 const avg=cnt>0?tO/cnt*(1+PP.ekKat):0;
 P.hc=avg > 0 ? avg : P.hc;
 return{tN,avg,cnt,tM};
}

function rPers(){
 const res=calcAllPers();
 document.getElementById('pmAvg').textContent=ftl(res.avg);
 document.getElementById('pmCnt').textContent=res.cnt;
 document.getElementById('pmTot').textContent=ftl(res.tN);
 document.getElementById('pmDay').textContent=ftl(res.tN/12/PP.gun);
 
 document.getElementById('pmParams').innerHTML=
  `<div class="pr"><span class="l">Aylık Gün</span><input type="number" value="${PP.gun}" onchange="PP.gun=parseInt(this.value)||22;rPers();recalcAll()"><span class="u">g</span></div>`+
  `<div class="pr"><span class="l">Günlük Saat</span><input type="number" value="${PP.saat}" onchange="PP.saat=parseInt(this.value)||9;rPers();recalcAll()"><span class="u">sa</span></div>`+
  `<div class="pr"><span class="l">Yemek</span><input type="number" value="${PP.yemek}" onchange="PP.yemek=parseFloat(this.value)||0;rPers();recalcAll()"><span class="u">₺</span></div>`+
  `<div class="pr"><span class="l">Yıllık KKD</span><input type="number" value="${PP.kkd}" onchange="PP.kkd=parseFloat(this.value)||0;rPers();recalcAll()"><span class="u">₺</span></div>`+
  `<div class="pr"><span class="l">Fazla Çal. %</span><input type="number" value="${PP.fcRate*100}" onchange="PP.fcRate=parseFloat(this.value)/100||0;rPers();recalcAll()"><span class="u">%</span></div>`;
 
 const b=document.getElementById('pmBody');b.innerHTML='';
 PERS.forEach((p,i)=>{
  const c=p._c;
  const tr=document.createElement('tr');
  tr.innerHTML=`<td class="lb text-center">${i+1}</td>`+
   `<td>${p.g}</td><td>${p.a}</td><td class="c">${fm(p.net)}</td>`+
   `<td class="c">${fm(c.E)}</td><td class="c">${fm(c.F)}</td><td class="c">${fm(c.G)}</td>`+
   `<td class="c">${fm(p.servis)}</td><td class="c">${PP.yemek}</td><td class="c">${fm(PP.kkd,0)}</td>`+
   `<td class="c text-amber-400 font-bold">${fm(c.M)}</td>`+
   `<td class="c text-indigo-400 font-bold">${fm(c.N)}</td>`+
   `<td class="g font-mono font-black text-[0.85rem]">${fm(c.O)}</td>`+
   `<td class="text-center"><button onclick="PERS.splice(${i},1);rPers();recalcAll()" class="text-red-400"><i data-lucide="x" class="w-4 h-4"></i></button></td>`;
  b.appendChild(tr)});
  lucide.createIcons();
}

function openPersModal(){document.getElementById('persModal').classList.add('show')}
function submitPers(){
 const g=document.getElementById('npGorev').value, a=document.getElementById('npAd').value;
 const net=parseFloat(document.getElementById('npNet').value)||0, kidem=parseInt(document.getElementById('npKidem').value), servis=parseFloat(document.getElementById('npServis').value)||0;
 if(!a){toast('Ad girin','er');return}
 PERS.push({g,a,net,kidem,servis});
 document.getElementById('persModal').classList.remove('show');
 rPers(); recalcAll(); toast(a+' eklendi');
}

function calcItem(it){
 const gFM=mn2(P.gFL), I=gFM?tk2(gFM.n):20, N=gfd(it.dn,it.cl), lens=gbl(it.ty,it.dn,it.cl), inch=DN_INCH[it.dn]||0, apv=gap(inch);
 let tMC=0, tLC=0, tLH=0;
 it.parts.forEach((pt,pi)=>{
  const mFB=mn2(pt.matOv.fb||P.gFB), mFT=mn2(pt.matOv.ft||P.gFT), mFL=mn2(pt.matOv.fl||P.gFL);
  const localI=mFL?tk2(mFL.n):I;
  const fbP=mp(mFB), ftP=mp(mFT), flP=mp(mFL), stP=mp(mn2(P.gST)), dsP=mp(mn2(P.gDS)), vlP=mp(mn2(P.gVL)), spP=mp(mn2(P.gSP)), ndP=mp(mn2(P.gND));
  let S,T;
  if(pt.nm==='Gövde'||pt.nm==='Tek Parça'){const K=(lens.L1||0)+P.fr+P.fl; S=it.qt===0?0:(((N+2*localI)*Math.PI)+P.sm); T=it.qt===0?0:(K+localI+P.sm)}
  else if(pt.nm==='Flanş'){const fL=lens.L1p||lens.L2||(lens.L1||0); const K=fL-N/2; S=it.qt===0?0:(((N+2*localI)*Math.PI)+P.sm); T=it.qt===0?0:(K+localI+P.sm)}
  else if(pt.nm==='Kapak'){S=it.qt===0?0:((N+2*localI)+P.sm); T=S}
  else{S=pt.ov.S||0;T=pt.ov.T||0}
  if(pt.ov.S!=null)S=pt.ov.S; if(pt.ov.T!=null)T=pt.ov.T;
  if(it.qt===0||!S||!T){pt.calc={S:0,T:0,I:localI,N,fab:0,fil:0,sew:0,drw:0,vlc:0,ag:0,pl:0,mc:0,lc:0,lh:0};return}
  
  const fB2=S*T*2*(1+P.fw)/1e6, fE=90*T*(1+P.fw)/1e6, fR=(50*2*S)*(1+P.fw)/1e6;
  let fab=pt.ov.fab!=null?pt.ov.fab:(fB2+fE+fR);
  let fil=pt.ov.fil!=null?pt.ov.fil:((S-P.sm)*(T-localI-P.sm)*(1+P.iw)/1e6); 
  
  let sew=pt.ov.sew!=null?pt.ov.sew:(((2*(S+T))+(2*S)+(7.5*T))*((1+P.sw)*2.4/1000));
  let drw=pt.ov.drw!=null?pt.ov.drw:(((S+P.re)*2)/1000);
  let vlc=pt.ov.vlc!=null?pt.ov.vlc:((lens.L1||T)/1000);
  let ag=pt.ov.ag!=null?pt.ov.ag:apv.a, pl=pt.ov.pl!=null?pt.ov.pl:apv.p;
  let mc=pt.ov.mc!=null?pt.ov.mc:((fab/2*fbP)+(fab/2*ftP)+(fil*flP)+(sew*stP)+(drw*dsP)+(vlc*vlP)+(ag*spP)+(pl*ndP));
  const lh=(pt.bw*sew+pt.bx*fil+pt.by)*it.df;
  let lc=pt.ov.lc!=null?pt.ov.lc:(lh*P.hc); 
  pt.calc={S,T,I:localI,N,fab,fil,sew,drw,vlc,ag,pl,mc,lc,lh}; tMC+=mc; tLC+=lc; tLH+=lh;
 });
 it.calc={tMC,tLC,tLH,uc:tMC+tLC,us:(tMC+tLC)*P.mul,tMA:tMC*it.qt,tLA:tLC*it.qt,tS:(tMC+tLC)*P.mul*it.qt}
}

function recalcAll(){
 IT.forEach(calcItem); rProd();
 const ap2=document.querySelector('.pane.on'); if(ap2){if(ap2.id==='p-pl')rPL(); if(ap2.id==='p-ms')rMas(); if(ap2.id==='p-pr')rPar();}
 const tI=IT.length, tJ=IT.reduce((s,i)=>s+i.qt,0), tH=IT.reduce((s,i)=>s+((i.calc.tLH||0)*i.qt),0);
 document.getElementById('sI').textContent=tI; document.getElementById('sJ').textContent=tJ; document.getElementById('sH').textContent=fm(tH,1);
}

function toggleCols() {
  colVis.kumas = document.getElementById('cKumas').checked;
  colVis.dolgu = document.getElementById('cDolgu').checked;
  colVis.dikis = document.getElementById('cDikis').checked;
  colVis.pul = document.getElementById('cPul').checked;
  localStorage.setItem('colVis', JSON.stringify(colVis));
  
  document.querySelectorAll('.col-kumas').forEach(el => el.style.display = colVis.kumas ? '' : 'none');
  document.querySelectorAll('.col-dolgu').forEach(el => el.style.display = colVis.dolgu ? '' : 'none');
  document.querySelectorAll('.col-dikis').forEach(el => el.style.display = colVis.dikis ? '' : 'none');
  document.querySelectorAll('.col-pul').forEach(el => el.style.display = colVis.pul ? '' : 'none');
}

function rProd(){
 const b=document.getElementById('pdBody'); b.innerHTML=''; const cur=document.getElementById('pdCur').value;
 const fab=M.filter(m=>m.t==='Kumaş'), fil=M.filter(m=>m.t==='Dolgu');
 IT.forEach((it,ii)=>{ const ic=it.calc;
  it.parts.forEach((pt,pi)=>{ const pc=pt.calc||{}, f0=pi===0, np=it.parts.length;
   const oc=k=>pt.ov[k]!=null?' o':'';
   const matSel=(k,list)=>`<select style="font-size:.68rem;max-width:100px" onchange="IT[${ii}].parts[${pi}].matOv.${k}=this.value||null;recalcAll()"><option value="">Global</option>${list.map(m=>`<option value="${m.n}"${(pt.matOv[k]||'')==m.n?' selected':''}>${m.n}</option>`).join('')}</select>`;
   const tr=document.createElement('tr');
   tr.innerHTML=(f0?`<td class="lb text-indigo-400 font-bold" rowspan="${np}">${P.prefix?P.prefix+'-':''}${it.ref}</td><td class="lb text-[var(--tx)]" rowspan="${np}">${TN[it.ty]}</td>`:'')+
    `<td class="text-xs font-semibold text-[var(--tx-mut)] px-2">${pt.nm}</td>`+
    (f0?`<td style="text-align:center; font-weight:700" rowspan="${np}">DN${it.dn}</td><td style="text-align:center" rowspan="${np}">${it.cl}</td><td rowspan="${np}"><input type="number" value="${it.qt}" min="0" style="width:48px;text-align:center; font-weight:700; color:var(--tx)" onchange="IT[${ii}].qt=parseInt(this.value)||0;recalcAll()"></td><td rowspan="${np}"><input type="number" value="${it.df}" min=".5" max="5" step=".1" style="width:48px;text-align:center" class="text-indigo-400 font-bold bg-[rgba(99,102,241,0.1)] rounded" onchange="IT[${ii}].df=parseFloat(this.value)||1;recalcAll()"></td>`:'')+
    `<td>${matSel('fb',fab)}</td><td>${matSel('ft',fab)}</td><td>${matSel('fl',fil)}</td>`+
    `<td class="c text-amber-400" style="text-align:center">${pc.I||'—'}</td><td class="c">${pc.N?fm(pc.N,0):'—'}</td>`+
    `<td class="c text-cyan-400${oc('S')}" ondblclick="ovr(${ii},${pi},'S',this)">${pc.S?fm(pc.S,1):'—'}</td><td class="c text-cyan-400${oc('T')}" ondblclick="ovr(${ii},${pi},'T',this)">${pc.T?fm(pc.T,1):'—'}</td>`+
    `<td class="col-kumas c${oc('fab')}" ondblclick="ovr(${ii},${pi},'fab',this)">${pc.fab?fm(pc.fab,2):'—'}</td><td class="col-dolgu c${oc('fil')}" ondblclick="ovr(${ii},${pi},'fil',this)">${pc.fil?fm(pc.fil,2):'—'}</td><td class="col-dikis c${oc('sew')}" ondblclick="ovr(${ii},${pi},'sew',this)">${pc.sew?fm(pc.sew,1):'—'}</td><td class="col-dikis c${oc('drw')}" ondblclick="ovr(${ii},${pi},'drw',this)">${pc.drw?fm(pc.drw,1):'—'}</td><td class="col-dikis c${oc('vlc')}" ondblclick="ovr(${ii},${pi},'vlc',this)">${pc.vlc?fm(pc.vlc,1):'—'}</td><td class="col-pul c${oc('ag')}" ondblclick="ovr(${ii},${pi},'ag',this)">${pc.ag||0}</td><td class="col-pul c${oc('pl')}" ondblclick="ovr(${ii},${pi},'pl',this)">${pc.pl||0}</td>`+
    `<td class="c text-[var(--tx-mut)] font-mono${oc('mc')}" ondblclick="ovr(${ii},${pi},'mc',this)">${fm(curConv(pc.mc||0,cur))}</td><td class="c text-[var(--tx-mut)] font-mono${oc('lc')}" ondblclick="ovr(${ii},${pi},'lc',this)">${fm(curConv(pc.lc||0,cur))}</td>`+
    (f0?`<td class="c text-[var(--gn)] font-mono" style="font-weight:900; font-size:.85rem" rowspan="${np}">${fm(curConv(ic.uc||0,cur))}</td><td class="g text-[var(--gn)] font-mono" rowspan="${np}">${fm(curConv(ic.us||0,cur))}</td><td class="g text-[var(--gn)] font-mono" style="font-weight:900; font-size:1rem" rowspan="${np}">${fm(curConv(ic.tS||0,cur))}</td><td style="text-align:center" rowspan="${np}"><button onclick="optConfirm('Sil?', ()=>{IT.splice(${ii},1);recalcAll()})" class="bt bt2 px-2 py-1"><i data-lucide="x" class="w-3 h-3"></i></button></td>`:'');
   b.appendChild(tr);
  });
 });
 const tS=IT.reduce((s,i)=>s+(i.calc.tS||0),0);
 document.getElementById('pdFoot').innerHTML=IT.length?`<tr><td colspan="21" class="lb" style="text-align:right;font-weight:900">TOPLAM SATIŞ BEDELİ: </td><td class="g font-mono text-[var(--gn)]" style="font-weight:900;font-size:1.1rem" colspan="3">${cur} ${fm(curConv(tS,cur))}</td></tr>`:'';
 toggleCols(); lucide.createIcons();
}

function ovr(ii,pi,k,td){
 const pt=IT[ii].parts[pi], cv=pt.calc[k]||0;
 const inp=document.createElement('input'); inp.type='number'; inp.value=cv; inp.step='any';
 inp.style.cssText='width:100%;height:100%;background:rgba(245,158,11,.2);color:var(--am);font-weight:800;border:2px solid var(--am);font-size:.76rem;padding:2px 4px;text-align:right;font-family:inherit;border-radius:4px;outline:none;';
 td.textContent=''; td.appendChild(inp); inp.focus(); inp.select();
 function ok(){const nv=parseFloat(inp.value); if(!isNaN(nv)&&nv!==cv){pt.ov[k]=nv; toast(k+' overide edildi','in')} recalcAll()}
 inp.onblur=ok; inp.onkeydown=e=>{if(e.key==='Enter')ok(); if(e.key==='Escape'){delete pt.ov[k]; recalcAll()}}
}

function rGlobal(){
 const fab=M.filter(m=>m.t==='Kumaş'), fil=M.filter(m=>m.t==='Dolgu'), hlp=M.filter(m=>m.t==='Yardımcı');
 function gs(lb,k,list,cur){return`<div class="mb-3"><label class="text-[10px] font-bold text-[var(--tx-mut)] uppercase">${lb}</label><select class="ps mt-1" data-k="${k}" onchange="P[this.dataset.k]=this.value;recalcAll()">${list.map(m=>`<option value="${m.n}"${m.n===cur?' selected':''}>${m.n}</option>`).join('')}</select></div>`}
 document.getElementById('plGlobal').innerHTML=
  `<div class="grid grid-cols-2 md:grid-cols-4 gap-4">` +
  gs('Alt Kumaş','gFB',fab,P.gFB)+gs('Üst Kumaş','gFT',fab,P.gFT)+gs('Dolgu Malzemesi','gFL',fil,P.gFL)+
  gs('Dikiş İpi','gST',hlp.filter(m=>m.s==='Dikiş İpi'),P.gST)+
  `</div><div class="grid grid-cols-2 md:grid-cols-5 gap-4 mt-2">` +
  gs('Boğma İpi','gDS',hlp.filter(m=>m.s==='Boğma İpi'),P.gDS)+gs('Cırt Bant','gVL',hlp.filter(m=>m.s==='Cırtbant'),P.gVL)+
  gs('Agraf','gSP',hlp.filter(m=>m.s==='Zımba Set'),P.gSP)+gs('Ç.Pul','gND',hlp.filter(m=>m.s==='Ç.Pul Set'),P.gND)+
  gs('Etiket','gLB',hlp.filter(m=>m.s==='Etiket'),P.gLB)+`</div>`;
}

function rMas(){
 const tM=IT.reduce((s,i)=>s+(i.calc.tMA||0),0), tL=IT.reduce((s,i)=>s+(i.calc.tLA||0),0), tLH=IT.reduce((s,i)=>s+((i.calc.tLH||0)*i.qt),0), tS0=IT.reduce((s,i)=>s+(i.calc.tS||0),0), tJ=IT.reduce((s,i)=>s+i.qt,0);
 const svcMontaj=SVC.montajGun*SVC.montajGunMly; const svcTotal=SVC.cad+svcMontaj+SVC.nakliye;
 const tS=tS0+svcTotal; const dir=tM+tL, ind=dir*P.oh, raw=dir+ind, stmp=raw*P.sr, fin=raw*(P.pd/365)*P.ir, tc=raw+stmp+fin+svcTotal, pr=tS-tc, mg=tS>0?(pr/tS*100):0;
 
 document.getElementById('kC').textContent=ftl(tc); document.getElementById('kS').textContent=ftl(tS);
 document.getElementById('kP').textContent=ftl(pr); document.getElementById('kP').style.color=pr>=0?'var(--gn)':'var(--rd)';
 document.getElementById('kM').textContent='%'+fm(mg,1); document.getElementById('msMul').value=P.mul;
 document.getElementById('msOh').value = P.oh * 100;
 
 document.getElementById('msServices').innerHTML=
  `<div class="pr"><span class="l">CAD/CAM Hizmet</span><input type="number" value="${SVC.cad}" step="100" onchange="SVC.cad=parseFloat(this.value)||0;rMas()"><span class="u">₺</span></div>`+
  `<div class="pr"><span class="l">Montaj (adam gün)</span><input type="number" value="${SVC.montajGun}" step="1" onchange="SVC.montajGun=parseFloat(this.value)||0;rMas()"><span class="u">g</span></div>`+
  `<div class="pr"><span class="l">Gün maliyeti</span><input type="number" value="${SVC.montajGunMly}" step="100" onchange="SVC.montajGunMly=parseFloat(this.value)||0;rMas()"><span class="u">₺</span></div>`+
  `<div class="pr"><span class="l">Nakliye</span><input type="number" value="${SVC.nakliye}" step="100" onchange="SVC.nakliye=parseFloat(this.value)||0;rMas()"><span class="u">₺</span></div>`;
 document.getElementById('msSvcTotal').textContent=ftl(svcTotal);
 
 const mr=(l,d,v)=>`<tr><td class="lb text-left">${l}</td><td style="text-align:center;color:var(--tx-mut);font-size:.68rem">${d}</td><td class="c font-mono text-[var(--tx)]">${v}</td></tr>`;
 document.getElementById('tMC').innerHTML=`<tr><td class="hd" colspan="3">DOĞRUDAN</td></tr>${mr('Malzeme','',ftl(tM))}${mr('İşçilik (Oto)',fm(P.hc)+' ₺/sa',ftl(tL))}<tr><td class="hd2 font-bold" colspan="2">DİREKT (NET)</td><td class="c font-bold font-mono text-cyan-400">${ftl(dir)}</td></tr><tr><td class="hd" colspan="3">DOLAYLI</td></tr>${mr('Overhead',fm(P.oh*100,0)+'%',ftl(ind))}<tr><td class="hd2 font-bold" colspan="2">HAM MALİYET</td><td class="c font-bold font-mono text-amber-400">${ftl(raw)}</td></tr>${mr('Damga V.',fm(P.sr*100,3)+'%',ftl(stmp))}${mr('Finansal',P.pd+'g',ftl(fin))}${mr('Hizmet Bedeli','',ftl(svcTotal))}<tr><td class="hd2 font-bold" colspan="2">TOPLAM MALİYET</td><td class="c font-bold font-mono text-emerald-400" style="font-size:1rem">${ftl(tc)}</td></tr>`;
 
 let tots={fab:0,fil:0,sew:0,drw:0,vlc:0,ag:0,pl:0};
 IT.forEach(it=>it.parts.forEach(pt=>{const pc=pt.calc||{};tots.fab+=(pc.fab||0)*it.qt;tots.fil+=(pc.fil||0)*it.qt;tots.sew+=(pc.sew||0)*it.qt;tots.drw+=(pc.drw||0)*it.qt;tots.vlc+=(pc.vlc||0)*it.qt;tots.ag+=(pc.ag||0)*it.qt;tots.pl+=(pc.pl||0)*it.qt}));
 const mm=(l,s,q,u)=>{const m=mn2(s),p=mp(m);return`<tr><td class="lb">${l}</td><td class="c font-mono text-cyan-400">${fm(q,2)} ${u}</td></tr>`};
 document.getElementById('tMM').innerHTML=`<thead><tr><th>Kategori</th><th class="text-right">Toplam İhtiyaç</th></tr></thead><tbody>${mm('Kumaş Toplam',P.gFB,tots.fab/2,'M²')}${mm('Dolgu Toplam',P.gFL,tots.fil,'M²')}${mm('Dikiş İpi',P.gST,tots.sew,'MT')}${mm('Boğma İpi',P.gDS,tots.drw,'MT')}${mm('Cırt Bant',P.gVL,tots.vlc,'MT')}${mm('Agraf Seti',P.gSP,tots.ag,'SET')}${mm('Çelik Pul',P.gND,tots.pl,'AD')}<tr><td class="hd2 font-bold">Toplam Net:</td><td class="c font-mono font-bold text-emerald-400">${ftl(tM)}</td></tr></tbody>`;
 
 document.getElementById('tMS').innerHTML=`<thead><tr><th>Döviz</th><th>Kur</th><th>Satış</th><th>Maliyet</th><th>Kâr</th></tr></thead><tbody><tr><td class="lb">TL</td><td class="c">1</td><td class="g font-mono">${ftl(tS)}</td><td class="c font-mono">${ftl(tc)}</td><td class="font-mono ${pr>=0?'g':'r'}">${ftl(pr)}</td></tr><tr><td class="lb">USD</td><td class="c font-mono">${fm(P.usd)}</td><td class="g font-mono">${fus(tS/P.usd)}</td><td class="c font-mono">${fus(tc/P.usd)}</td><td class="font-mono ${pr>=0?'g':'r'}">${fus(pr/P.usd)}</td></tr><tr><td class="lb">EUR</td><td class="c font-mono">${fm(P.eur)}</td><td class="g font-mono">${feu(tS/P.eur)}</td><td class="c font-mono">${feu(tc/P.eur)}</td><td class="font-mono ${pr>=0?'g':'r'}">${feu(pr/P.eur)}</td></tr></tbody>`;
 
 document.getElementById('msAH').textContent=fm(tLH,1); document.getElementById('msAD').textContent=fm(tLH/9,1); document.getElementById('msJC').textContent=tJ;
}

function rPar(){
 document.getElementById('pDov').innerHTML=pi('USD/TL','usd',P.usd,'',2)+pi('EUR/TL','eur',P.eur,'',2)+'<hr class="border-[var(--brd)] my-2">'+
 `<div class="pr"><span class="l flex items-center gap-2">Saat Ücreti <i data-lucide="lock" class="w-3.5 h-3.5 text-[var(--tx-mut)]" title="Oto"></i></span><input type="number" value="${P.hc}" disabled class="opacity-50 font-mono"><span class="u">₺</span></div>`+
 pi('Ödeme Vadesi','pd',P.pd,'g',0)+pi('Yıllık Faiz','ir',P.ir*100,'%',1)+pi('Damga V.','sr',P.sr*100,'%',3);
 document.getElementById('pFir').innerHTML=pi('Kumaş Fire','fw',P.fw*100,'%',0)+pi('İzolasyon Fire','iw',P.iw*100,'%',0)+pi('Dikiş İpi Fire','sw',P.sw*100,'%',0)+'<hr class="border-[var(--brd)] my-2">'+pi('Bindirme SAĞ','fr',P.fr,'mm',0)+pi('Bindirme SOL','fl',P.fl,'mm',0)+pi('Dikiş Payı','sm',P.sm,'mm',0)+pi('Boğma Fazlalık','re',P.re,'mm',0);
 document.getElementById('pLab').innerHTML=pi('Dikiş (sa/mt)','lbw',P.lbw,'',3)+pi('Metraj (sa/m²)','lbx',P.lbx,'',2)+pi('Parça Gövde','lby',P.lby,'',2)+pi('Parça Flanş','lbyf',P.lbyf,'',2);
 rFT(); rLT('gate'); rAT();
}
function pi(lb,k,v,u='',d=2){return`<div class="pr"><span class="l">${lb}</span><input type="number" value="${v}" step="${d>0?Math.pow(10,-d):1}" data-k="${k}" class="font-mono" onchange="up(this)"><span class="u">${u}</span></div>`}
function up(el){const k=el.dataset.k; let v=parseFloat(el.value)||0; if(['oh','fw','iw','sw','ir','sr'].includes(k))v/=100; P[k]=v; recalcAll()}

function rFT(){const t=document.getElementById('tFl');let h='<thead><tr><th>DN</th>';CLS.forEach(c=>h+=`<th>${c}</th>`);h+='</tr></thead><tbody>';DN_LIST.forEach(dn=>{h+=`<tr><td class="lb text-indigo-400 font-bold">DN${dn}</td>`;CLS.forEach(cl=>{const v=(FD[dn]&&FD[dn][cl])||'';h+=`<td class="c font-mono text-cyan-400">${v||'—'}</td>`});h+='</tr>'});t.innerHTML=h+'</tbody>'}
function rLT(ty){const t=document.getElementById('tLn'), d=BL[ty]||{}; let h='<thead><tr><th>DN</th>';CLS.forEach(c=>h+=`<th colspan="3">${c}</th>`);h+="</tr><tr><th></th>";CLS.forEach(()=>h+="<th class='text-amber-400'>L1</th><th class='text-cyan-400'>L1'</th><th class='text-emerald-400'>L2</th>");h+='</tr></thead><tbody>';DN_LIST.forEach(dn=>{h+=`<tr><td class="lb text-indigo-400 font-bold">DN${dn}</td>`;CLS.forEach(cl=>{const e=(d[dn]&&d[dn][cl])||{};['L1','L1p','L2'].forEach(k=>{h+=`<td class="c font-mono">${e[k]||'—'}</td>`})});h+='</tr>'});t.innerHTML=h+'</tbody>'}
function slt(ty){['gate','globe'].forEach(t=>document.getElementById('bl-'+t).className=t===ty?'bt bt4 on':'bt bt4');rLT(ty)}
function rAT(){const t=document.getElementById('tAg'),ks=Object.keys(AP).sort((a,b)=>parseFloat(a)-parseFloat(b));let h='<thead><tr><th>Çap"</th><th>Agraf</th><th>Pul</th></tr></thead><tbody>';ks.forEach(k=>{const d=AP[k];h+=`<tr><td class="lb text-indigo-400 font-bold">${k}"</td><td class="c">${d.a}</td><td class="c">${d.p}</td></tr>`});t.innerHTML=h+'</tbody>'}
function rVRef(){const sel=document.getElementById('vRefSel').value;const vd=VALVE_DATA[sel];if(!vd)return;const dims=vd.dims;const dns=Object.keys(dims).map(Number).sort((a,b)=>a-b);let h='<thead><tr><th>DN</th><th>D (Flanş Çap)</th><th>L (Gövde Boy)</th><th>H (Yükseklik)</th><th>Dk (Kapak Çap)</th></tr></thead><tbody>';dns.forEach(dn=>{const d=dims[dn];h+=`<tr><td class="lb text-indigo-400 font-bold">DN${dn}</td><td class="c font-mono text-[var(--tx)]">${d.D}</td><td class="c font-mono text-cyan-400">${d.L}</td><td class="c font-mono text-[var(--tx-mut)]">${d.H||'—'}</td><td class="c font-mono text-[var(--tx-mut)]">${d.Dk||'—'}</td></tr>`});document.getElementById('tVRef').innerHTML=h+'</tbody>'}

let mfl='all';
function rMat(){const b=document.getElementById('mBody');b.innerHTML='';M.forEach((m,i)=>{if(mfl!=='all'&&m.t!==mfl)return;const tr=document.createElement('tr');tr.innerHTML=`<td class="lb text-xs text-center">${i+1}</td><td><select onchange="M[${i}].t=this.value;rGlobal()">${['Kumaş','Dolgu','Yardımcı','Isıtıcı'].map(t=>`<option${m.t===t?' selected':''}>${t}</option>`).join('')}</select></td><td><input value="${m.s}" onchange="M[${i}].s=this.value"></td><td><input value="${m.n}" onchange="M[${i}].n=this.value;rGlobal()" style="font-weight:700" class="text-[var(--tx)]"></td><td><input value="${m.u}" onchange="M[${i}].u=this.value" style="width:50px;text-align:center"></td><td><input type="number" value="${m.p}" step=".001" class="font-mono" onchange="M[${i}].p=parseFloat(this.value)||0;rMat();recalcAll()"></td><td><select onchange="M[${i}].c=this.value;rMat();recalcAll()" style="width:60px">${['TL','USD','EUR'].map(c=>`<option${m.c===c?' selected':''}>${c}</option>`).join('')}</select></td><td class="c font-mono font-bold text-[var(--gn)]">${fm(mp(m))}</td><td><input type="number" value="${m.k||''}" onchange="M[${i}].k=parseFloat(this.value)||null;TK[M[${i}].n]=M[${i}].k;recalcAll()" style="width:70px;text-align:center" placeholder="—"></td><td style="text-align:center"><button onclick="M.splice(${i},1);rMat();rGlobal()" class="bt bt2 px-2 py-1"><i data-lucide="trash-2" class="w-3 h-3"></i></button></td>`;b.appendChild(tr)});document.getElementById('mfBtns').innerHTML=['all','Kumaş','Dolgu','Yardımcı','Isıtıcı'].map(t=>`<button class="${mfl===t?'on':''}" onclick="mfl='${t}';rMat()">${t==='all'?'Tümü':t}</button>`).join('');lucide.createIcons();}
function openMatModal() { document.getElementById('modalMat').classList.add('show'); }
function submitMat() {
    const t = document.getElementById('nmType').value, s = document.getElementById('nmSub').value, n = document.getElementById('nmName').value;
    const u = document.getElementById('nmUnit').value, p = parseFloat(document.getElementById('nmPrice').value)||0, c = document.getElementById('nmCur').value;
    const k = parseFloat(document.getElementById('nmThick').value) || null;
    if(!n) { toast('Lütfen malzeme cinsi girin.', 'er'); return; }
    M.push({t, s, n, u, p, c, k});
    if(k) TK[n] = k;
    rMat(); rGlobal(); recalcAll();
    document.getElementById('modalMat').classList.remove('show');
    toast('Yeni malzeme sisteme eklendi', 'in');
}

function rPL(){
 const ct=document.getElementById('curToggle'); ct.innerHTML=['TL','USD','EUR'].map(c=>`<button class="${curShow[c]?'on':''}" onclick="curShow['${c}']=!curShow['${c}'];rPL()">${c}</button>`).join('');
 const hd=document.getElementById('plHead'); let hh='<tr><th class="resizable-th">REF KODU</th><th class="resizable-th">DN</th><th class="resizable-th" style="min-width:150px">Mahal/Not</th><th class="resizable-th" style="min-width:250px">Ekipman Tanımı</th><th class="resizable-th">Adet</th>';
 if(curShow.TL)hh+='<th class="resizable-th" style="background:rgba(99,102,241,.1)">Birim TL</th><th class="resizable-th" style="background:rgba(99,102,241,.13)">Toplam TL</th>';
 if(curShow.USD)hh+='<th class="resizable-th" style="background:rgba(16,185,129,.1)">Birim USD</th><th class="resizable-th" style="background:rgba(16,185,129,.15)">Toplam USD</th>';
 if(curShow.EUR)hh+='<th class="resizable-th" style="background:rgba(6,182,212,.1)">Birim EUR</th><th class="resizable-th" style="background:rgba(6,182,212,.15)">Toplam EUR</th>';
 hh+='</tr>'; hd.innerHTML=hh;
 const b=document.getElementById('plBody'); b.innerHTML=''; let totTL=0;
 IT.forEach(it=>{const ic=it.calc, q=plQty[it.ref]||1, aq=it.qt*q, uTL=ic.us||0, tTL=uTL*aq; totTL+=tTL;
  const pref = P.prefix ? `${P.prefix}-` : '';
  const tr=document.createElement('tr');
  let h=`<td class="lb font-bold text-indigo-400 text-center">${pref}${it.ref}</td><td class="text-center font-bold">DN${it.dn}</td><td><input value="${it.mh}" onchange="IT.find(x=>x.ref===${it.ref}).mh=this.value" placeholder="Mahal..."></td><td class="lb text-left">${TN[it.ty]} Ceketi - DN${it.dn} PN${it.cl}</td><td class="o text-center font-bold" ondblclick="openQtyModal(${it.ref})" title="Değiştirmek için çift tıkla">${aq}</td>`;
  if(curShow.TL)h+=`<td class="c font-mono">${fm(uTL)}</td><td class="c font-mono font-bold text-indigo-400">${fm(tTL)}</td>`;
  if(curShow.USD)h+=`<td class="c font-mono">${fm(uTL/P.usd)}</td><td class="c font-mono font-bold text-[var(--gn)]">${fm(tTL/P.usd)}</td>`;
  if(curShow.EUR)h+=`<td class="c font-mono">${fm(uTL/P.eur)}</td><td class="c font-mono font-bold text-cyan-400">${fm(tTL/P.eur)}</td>`;
  tr.innerHTML=h; b.appendChild(tr)
 });
 const ft=document.getElementById('plFoot'); let fh='<td colspan="5" class="lb text-right font-extrabold text-[1rem]">GENEL TOPLAM</td>';
 if(curShow.TL)fh+=`<td class="c"></td><td class="c font-mono font-black text-[1.1rem] text-indigo-400">${ftl(totTL)}</td>`;
 if(curShow.USD)fh+=`<td class="c"></td><td class="c font-mono font-black text-[1.1rem] text-[var(--gn)]">${fus(totTL/P.usd)}</td>`;
 if(curShow.EUR)fh+=`<td class="c"></td><td class="c font-mono font-black text-[1.1rem] text-cyan-400">${feu(totTL/P.eur)}</td>`;
 ft.innerHTML=fh;
}

function go(id,el){document.querySelectorAll('.pane').forEach(p=>p.classList.remove('on'));document.querySelectorAll('.slink').forEach(s=>s.classList.remove('on'));document.getElementById('p-'+id).classList.add('on');el.classList.add('on');if(id==='pl')rPL();if(id==='ms')rMas();lucide.createIcons();}
function updDN(){const ty=document.getElementById('aType').value; const s=document.getElementById('aDN'); s.innerHTML='<option value="">DN</option>'; DN_LIST.forEach(dn=>{s.innerHTML+=`<option value="${dn}">DN${dn}</option>`});}

// ÜRÜN EKLEME ALANI: Dirsek eklendiğinde zorluk otomatik 1.5 ataması
function addItem(){
 const ty=document.getElementById('aType').value, dn=parseInt(document.getElementById('aDN').value), cl=parseInt(document.getElementById('aCls').value), qt=parseInt(document.getElementById('aQty').value);
 if(!ty||isNaN(dn)) return toast('Lütfen Tip ve DN seçin.', 'er');
 let df=P.gDF;
 
 // Madde: Dirsekler eklendiğinde zorluk (df) otomatik olarak 1.5 atanacak
 if (ty === 'elbow') { 
     df = 1.5; 
     toast('Dirsek kuralı: Zorluk (df) 1.5 atandı', 'in'); 
 }
 
 const parts=(TP[ty]||['Tek Parça']).map((nm,i)=>({nm,ov:{},bw:P.lbw,bx:P.lbx,by:i===0?P.lby:P.lbyf,calc:{},matOv:{}}));
 IT.push({ref:RN++, ty, dn:dn||0, cl, qt:qt||1, df, parts, mh:'', calc:{}}); recalcAll(); toast(`${TN[ty]} eklendi`);
}

function toast(m,t='ok'){const bx=document.getElementById('toastBox'), d=document.createElement('div'); d.className=`toast ${t}`; d.innerHTML=`<i data-lucide="${t==='ok'?'check-circle':t==='er'?'alert-octagon':'info'}"></i><span>${m}</span>`; bx.appendChild(d); lucide.createIcons(); setTimeout(()=>{d.style.opacity='0';d.style.transform='translateX(100%)';setTimeout(()=>d.remove(),300)},3000)}
function optConfirm(m,cb){document.getElementById('optConfirmMsg').textContent=m;document.getElementById('optConfirmBg').classList.add('show');document.getElementById('optConfirmYes').onclick=()=>{cb();document.getElementById('optConfirmBg').classList.remove('show')}}

function openQtyModal(ref){qtyRef=ref;const it=IT.find(i=>i.ref===ref);if(!it)return;document.getElementById('qmCur').textContent=it.qt;document.getElementById('qmVal').value=plQty[ref]||1;document.getElementById('qtyModal').classList.add('show')}
function submitQty(){if(qtyRef)plQty[qtyRef]=parseInt(document.getElementById('qmVal').value)||1;document.getElementById('qtyModal').classList.remove('show');rPL()}

function updatePrefix(val) { P.prefix = val; rPL(); rProd(); toast('Ön ek güncellendi'); }

function openPdfModal() {
    document.getElementById('pdfPrefixTitle').textContent = `Proje: ${P.prefix ? P.prefix : 'Genel'} İzolasyon Ceketleri`;
    const tbody = document.getElementById('pdfTableBody');
    const tfoot = document.getElementById('pdfTableFoot');
    tbody.innerHTML = '';
    let total = 0;
    
    if (IT.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Listedede ürün bulunmamaktadır.</td></tr>';
    } else {
        IT.forEach(it => {
            const aq = it.qt * (plQty[it.ref] || 1);
            const uPrice = it.calc.us || 0;
            const tPrice = uPrice * aq;
            total += tPrice;
            const pref = P.prefix ? `${P.prefix}-` : '';
            tbody.innerHTML += `
                <tr class="border-b border-gray-300">
                    <td class="p-2 font-bold">${pref}${it.ref}</td>
                    <td class="p-2">${TN[it.ty]} Ceketi</td>
                    <td class="p-2 text-center">DN${it.dn}</td>
                    <td class="p-2 text-center font-bold">${aq}</td>
                    <td class="p-2 text-right">₺ ${fm(uPrice)}</td>
                    <td class="p-2 text-right font-bold text-indigo-700">₺ ${fm(tPrice)}</td>
                </tr>
            `;
        });
    }
    
    tfoot.innerHTML = `
        <tr class="bg-gray-100 border-t-2 border-gray-800 font-bold text-lg">
            <td colspan="5" class="p-4 text-right">TOPLAM TUTAR (TL):</td>
            <td class="p-4 text-right text-indigo-800">₺ ${fm(total)}</td>
        </tr>
    `;
    
    document.getElementById('pdfModal').classList.add('show');
}

function downloadPDF() {
    const element = document.getElementById('pdfContentToPrint');
    const opt = {
      margin:       10,
      filename:     `Fiyat_Teklifi_${P.prefix||'Liste'}.pdf`,
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2 },
      jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    toast('PDF Hazırlanıyor, lütfen bekleyin...', 'in');
    html2pdf().set(opt).from(element).save().then(() => {
        document.getElementById('pdfModal').classList.remove('show');
        toast('PDF Başarıyla İndirildi');
    });
}

function saveData(){localStorage.setItem('insjack_pro_v2_1',JSON.stringify({P,M,IT,FD,BL,AP,TK,SVC,plQty,curShow,PERS,PP,RN,colVis}));toast('Sistem kaydedildi')}

window.onload=()=>{
 document.getElementById('themeBtn').innerHTML = `<i data-lucide="${currentTheme === 'dark' ? 'sun' : 'moon'}" class="w-4 h-4"></i>`;
 const D=EXCEL_DATA; P.usd=D.fx.USD; P.eur=D.fx.EUR;
 M=D.mat.map(m=>({...m})); M.forEach(m=>{if(m.k)TK[m.n]=m.k});
 FD={};for(const[dn,cls] of Object.entries(D.fd)){FD[parseInt(dn)]={};for(const[c,v] of Object.entries(cls))FD[parseInt(dn)][parseInt(c)]=v}
 BL={};for(const[ty,tbl] of Object.entries(D.bl)){BL[ty]={};for(const[dn,cls] of Object.entries(tbl)){BL[ty][parseInt(dn)]={};for(const[c,v] of Object.entries(cls))BL[ty][parseInt(dn)][parseInt(c)]=v}}
 AP=D.ap;
 
 try{const sv=JSON.parse(localStorage.getItem('insjack_pro_v2_1'));if(sv&&sv.IT){Object.assign(P,sv.P||{});M=sv.M||M;IT=sv.IT||[];FD=sv.FD||FD;BL=sv.BL||BL;AP=sv.AP||AP;TK=sv.TK||TK;SVC=sv.SVC||SVC;plQty=sv.plQty||{};curShow=sv.curShow||curShow;if(sv.PERS)PERS=sv.PERS;if(sv.PP)PP=sv.PP;RN=sv.RN||(Math.max(...IT.map(i=>i.ref),0)+1);if(sv.colVis)colVis=sv.colVis;}}catch(e){}

 DN_LIST.forEach(dn => {
    if(dn > 300) {
        const ratio = dn / 300;
        if(!FD[dn]) FD[dn] = {};
        CLS.forEach(cl => {
            if(!FD[dn][cl] && FD[300] && FD[300][cl]) {
                FD[dn][cl] = Math.round(FD[300][cl] * ratio);
            }
        });
        Object.keys(BL).forEach(ty => {
            if(!BL[ty][dn]) BL[ty][dn] = {};
            CLS.forEach(cl => {
                if(!BL[ty][dn][cl] && BL[ty][300] && BL[ty][300][cl]) {
                    let obj = {};
                    ['L1', 'L1p', 'L2'].forEach(k => {
                        if(BL[ty][300][cl][k]) obj[k] = Math.round(BL[ty][300][cl][k] * ratio);
                    });
                    BL[ty][dn][cl] = obj;
                }
            });
        });
    }
 });

 document.getElementById('cKumas').checked = colVis.kumas;
 document.getElementById('cDolgu').checked = colVis.dolgu;
 document.getElementById('cDikis').checked = colVis.dikis;
 document.getElementById('cPul').checked = colVis.pul;
 document.getElementById('prefInput').value = P.prefix || '';

 fetchRates();
 rPers(); 
 rPar(); rMat(); rGlobal(); updDN(); recalcAll(); rVRef(); lucide.createIcons();
}
</script></body></html>
