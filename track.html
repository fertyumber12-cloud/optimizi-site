<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>CanlÄ± Tasarruf | Optimizi</title>
<meta name="robots" content="noindex">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
<script>tailwind.config = { theme: { fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'], mono: ['"JetBrains Mono"', 'monospace'] } } }</script>
<style>
  body { 
      background-color: #0f172a; 
      background-image: 
          radial-gradient(at 0% 0%, rgba(34, 197, 94, 0.15) 0px, transparent 50%),
          radial-gradient(at 100% 100%, rgba(30, 41, 59, 1) 0px, transparent 50%);
      height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow-x: hidden;
      color: #f8fafc;
  }
  .grid-bg {
      position: absolute; inset: 0; pointer-events: none; z-index: 0;
      background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
      background-size: 30px 30px;
  }
  .spotlight {
      position: absolute; top: -20%; left: 50%; transform: translateX(-50%);
      width: 120%; height: 60vh;
      background: radial-gradient(circle, rgba(74, 222, 128, 0.2) 0%, rgba(34, 197, 94, 0) 60%);
      filter: blur(40px); z-index: 1; pointer-events: none;
  }
  .glass-card { 
      background: rgba(255, 255, 255, 0.05); 
      backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.1); 
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); 
      z-index: 10; 
  }
  .counter-text { font-variant-numeric: tabular-nums; }
  .price-input {
      background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2);
      color: white; padding: 2px 6px; border-radius: 4px; width: 70px; text-align: center; font-family: monospace;
  }
</style>
</head>
<body class="antialiased font-sans">

<div class="grid-bg"></div>
<div class="spotlight"></div>

<button onclick="shareLink()" class="absolute top-4 right-4 z-50 bg-white/10 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white p-2 rounded-full transition shadow-lg group">
    <i data-lucide="share-2" class="w-5 h-5"></i>
    <span class="absolute right-full mr-2 bg-black/80 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap">GÃ¼ncel Linki Kopyala</span>
</button>

<div id="toast" class="fixed top-16 left-1/2 -translate-x-1/2 bg-green-500 text-white text-xs font-bold px-4 py-2 rounded-full shadow-xl z-50 opacity-0 transition duration-300 pointer-events-none transform -translate-y-4">
    Link KopyalandÄ±! ðŸ“‹
</div>

<main class="relative z-10 w-full max-w-md p-4 flex flex-col items-center justify-center min-h-[90vh]">
    
    <div class="mb-8 scale-100 flex flex-col items-center animate-[fadeIn_0.5s_ease-out]">
        <h1 class="text-3xl font-black text-white tracking-tight">Optimizi<span class="text-green-400">.App</span></h1>
        <p class="text-[10px] text-slate-400 uppercase font-bold tracking-[0.3em] mt-1">Energy Intelligence</p>
    </div>

    <div class="glass-card p-6 rounded-[2rem] w-full border-t-2 border-t-green-500/50">
        
        <div class="flex flex-col gap-4 mb-6">
            <div class="flex justify-between items-start">
                <div class="flex items-center gap-1.5 px-2 py-1 rounded-full bg-green-500/10 border border-green-500/20 text-[10px] text-green-400 font-bold uppercase tracking-wider">
                    <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> CanlÄ± Ä°zleme
                </div>
                <div class="text-[10px] text-slate-400 font-mono mt-1 opacity-50" id="prdSerial">ID: ---</div>
            </div>
            <div class="text-left pl-1">
                <div id="clientDisplay" class="text-sm font-extrabold text-white uppercase tracking-tight mb-1"></div>
                <h2 class="text-lg font-bold text-slate-300 leading-tight" id="prdName">...</h2>
            </div>
        </div>
        
        <div class="text-center py-8 rounded-3xl bg-white/5 border border-white/10 mb-6 relative overflow-hidden group">
            <div class="absolute inset-0 bg-green-500/5 group-hover:bg-green-500/10 transition duration-500"></div>
            
            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1 relative z-10">Toplam KazanÃ§</div>
            <div class="flex items-baseline justify-center gap-1 flex-wrap px-2 relative z-10">
                <span id="liveMoney" class="font-black text-white counter-text tracking-tighter text-5xl drop-shadow-lg">0,00</span>
                <span class="text-2xl font-bold text-green-400">â‚º</span>
            </div>

            <div class="mt-4 flex justify-center relative z-10">
                <div onclick="toggleEdit()" class="cursor-pointer group/btn flex items-center gap-2 text-[10px] bg-black/20 hover:bg-black/40 border border-white/10 px-3 py-1.5 rounded-full transition">
                    <i data-lucide="settings-2" class="w-3 h-3 text-slate-400 group-hover/btn:text-green-400"></i>
                    <span class="text-slate-400">Birim Fiyat:</span>
                    <span id="priceDisplay" class="font-bold text-green-400">...</span>
                    <span class="text-slate-500">TL (DÃ¼zenle)</span>
                </div>
            </div>
            
            <div id="editContainer" class="hidden mt-2 flex items-center justify-center gap-2 animate-[fadeIn_0.2s]">
                <input type="number" id="newPriceInput" class="price-input" step="0.01">
                <button onclick="saveNewPrice()" class="bg-green-600 hover:bg-green-500 text-white text-[10px] font-bold px-2 py-1 rounded">Kaydet</button>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-6">
            <div class="p-3 rounded-2xl bg-white/5 border border-white/5 text-center">
                <div class="text-[10px] font-bold text-slate-500 uppercase mb-1"><i data-lucide="leaf" class="w-3 h-3 inline text-green-500 mr-1"></i>Karbon</div>
                <div class="text-lg font-bold text-slate-200"><span id="liveCarbon">0</span> <span class="text-[9px] text-slate-500">Ton</span></div>
            </div>
            <div class="p-3 rounded-2xl bg-white/5 border border-white/5 text-center">
                <div class="text-[10px] font-bold text-slate-500 uppercase mb-1"><i data-lucide="flame" class="w-3 h-3 inline text-orange-500 mr-1"></i>YakÄ±t</div>
                <div class="text-lg font-bold text-slate-200"><span id="liveFuel">0</span> <span id="fuelUnit" class="text-[9px] text-slate-500">...</span></div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 border-t border-white/10 pt-4 text-slate-400">
            <div>
                <div class="text-[10px] font-bold uppercase mb-1 flex items-center gap-1"><i data-lucide="calendar" class="w-3 h-3"></i> Montaj</div>
                <div id="installDate" class="text-xs font-bold text-slate-200">...</div>
                <div id="installTime" class="text-[10px] opacity-60">...</div>
            </div>
            <div class="text-right">
                <div class="text-[10px] font-bold uppercase mb-1 flex items-center justify-end gap-1">SÃ¼re <i data-lucide="clock" class="w-3 h-3"></i></div>
                <div id="runTime" class="text-xs font-bold text-slate-200">...</div>
            </div>
        </div>
    </div>
</main>

<script>
    lucide.createIcons();
    const params = new URLSearchParams(window.location.search);

    const BASE_PRICES = {
        gas: 18.5, elec: 4.5, lng: 22.0, fueloil: 25.0, coal_imp: 8.5, coal_loc: 4.5
    };

    const config = {
        client: decodeURIComponent(params.get('c') || ''),
        sn: decodeURIComponent(params.get('s') || 'DEMO'),
        start: params.get('d') || new Date().toISOString(),
        saveTL: parseFloat(params.get('v')) || 0,
        fuel: params.get('f') || 'gas',
        // URL'den gelen "State" parametreleri (PaylaÅŸÄ±lan linkler iÃ§in)
        urlBanked: parseFloat(params.get('b')), // URL'de kayÄ±tlÄ± geÃ§miÅŸ para
        urlTime: parseFloat(params.get('t')),   // URL'de kayÄ±tlÄ± son deÄŸiÅŸim zamanÄ±
        urlPrice: parseFloat(params.get('p'))   // URL'de kayÄ±tlÄ± gÃ¼ncel fiyat
    };

    const fData = {
        gas: { unit: 'mÂ³', co2: 0.0019 }, elec: { unit: 'kWh', co2: 0.00045 }, lng: { unit: 'kg', co2: 0.0028 },
        fueloil: { unit: 'kg', co2: 0.0031 }, coal_imp: { unit: 'kg', co2: 0.0025 }, coal_loc: { unit: 'kg', co2: 0.0015 }
    }[config.fuel] || { unit: 'br', co2: 0 };

    // UI Doldur
    document.getElementById('prdSerial').innerText = `ID: ${config.sn}`;
    document.getElementById('clientDisplay').innerText = config.client || 'YalÄ±tÄ±m Projesi';
    document.getElementById('fuelUnit').innerText = fData.unit;
    document.getElementById('prdName').innerText = (config.client ? "Enerji Takip Sistemi" : "EndÃ¼striyel YalÄ±tÄ±m");

    const p = config.start.split('-');
    const initialInstallTime = new Date(p[0], p[1]-1, p[2], p[3]||0, p[4]||0).getTime();
    document.getElementById('installDate').innerText = new Date(initialInstallTime).toLocaleDateString('tr-TR');
    document.getElementById('installTime').innerText = `Saat: ${String(p[3]||0).padStart(2,'0')}:${String(p[4]||0).padStart(2,'0')}`;

    // --- BANKING SYSTEM (URL + LOCALSTORAGE Ã–NCELÄ°KLÄ°) ---
    const basePrice = BASE_PRICES[config.fuel] || 1.0;
    const impliedQuantity = config.saveTL / basePrice; 

    const keyPrice = `opt_price_${config.sn}`;
    const keyBanked = `opt_banked_${config.sn}`;
    const keyLastDate = `opt_lastdate_${config.sn}`;

    // Ã–NCELÄ°K SIRASI:
    // 1. URL Parametreleri (PaylaÅŸÄ±lan Link) - En gÃ¼Ã§lÃ¼sÃ¼
    // 2. LocalStorage (KullanÄ±cÄ±nÄ±n kendi cihazÄ±)
    // 3. VarsayÄ±lan (Ä°lk QR)

    let currentPrice, bankedMoney, lastChangeTime;

    if (!isNaN(config.urlPrice) && !isNaN(config.urlBanked)) {
        // EÄŸer linkte veri varsa, LocalStorage'Ä± EZER ve bunu kullanÄ±rÄ±z.
        currentPrice = config.urlPrice;
        bankedMoney = config.urlBanked;
        lastChangeTime = config.urlTime || initialInstallTime;
        
        // Bu paylaÅŸÄ±lan veriyi hafÄ±zaya da alalÄ±m ki yenileyince gitmesin
        localStorage.setItem(keyPrice, currentPrice);
        localStorage.setItem(keyBanked, bankedMoney);
        localStorage.setItem(keyLastDate, lastChangeTime);
    } else {
        // Link boÅŸsa hafÄ±zaya bak
        currentPrice = parseFloat(localStorage.getItem(keyPrice)) || basePrice;
        bankedMoney = parseFloat(localStorage.getItem(keyBanked)) || 0;
        lastChangeTime = parseFloat(localStorage.getItem(keyLastDate)) || initialInstallTime;
    }

    let currentTotalMoney = 0; 

    function updateCounter() {
        document.getElementById('priceDisplay').innerText = currentPrice.toFixed(2);
        const now = new Date().getTime();
        const diffSinceLastChange = now - lastChangeTime;
        const totalDiff = now - initialInstallTime;

        if (diffSinceLastChange > 0) {
            const newYearlySave = impliedQuantity * currentPrice;
            const newSavePerMs = newYearlySave / 31536000000;
            const moneySinceChange = diffSinceLastChange * newSavePerMs;
            currentTotalMoney = bankedMoney + moneySinceChange;
            
            const totalFuelAmount = (impliedQuantity / 31536000000) * totalDiff;

            document.getElementById('liveMoney').innerText = currentTotalMoney.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('liveFuel').innerText = totalFuelAmount.toLocaleString('tr-TR', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
            document.getElementById('liveCarbon').innerText = (totalFuelAmount * fData.co2).toLocaleString('tr-TR', { minimumFractionDigits: 3 });

            const d = Math.floor(totalDiff/86400000);
            const h = Math.floor((totalDiff/3600000)%24);
            document.getElementById('runTime').innerText = d>0 ? `${d} GÃ¼n ${h} Sa` : `${h} Sa ${Math.floor((totalDiff/60000)%60)} Dk`;
        }
        requestAnimationFrame(updateCounter);
    }

    function toggleEdit() {
        const el = document.getElementById('editContainer');
        const inp = document.getElementById('newPriceInput');
        if(el.classList.contains('hidden')) {
            el.classList.remove('hidden');
            inp.value = currentPrice;
            inp.focus();
        } else { el.classList.add('hidden'); }
    }

    function saveNewPrice() {
        const newPrice = parseFloat(document.getElementById('newPriceInput').value);
        if(newPrice > 0 && newPrice !== currentPrice) {
            bankedMoney = currentTotalMoney;
            lastChangeTime = new Date().getTime();
            currentPrice = newPrice;

            localStorage.setItem(keyBanked, bankedMoney);
            localStorage.setItem(keyLastDate, lastChangeTime);
            localStorage.setItem(keyPrice, currentPrice);

            toggleEdit();
            updateURL(); // URL'i gÃ¼ncelle
        }
    }

    // --- SÄ°HÄ°RLÄ° KISIM: URL GÃœNCELLEME ---
    function updateURL() {
        // Mevcut URL parametrelerini al
        const url = new URL(window.location);
        
        // Yeni durum verilerini ekle
        url.searchParams.set('p', currentPrice);
        url.searchParams.set('b', bankedMoney.toFixed(2));
        url.searchParams.set('t', lastChangeTime);

        // TarayÄ±cÄ± adres Ã§ubuÄŸunu yenilemeden gÃ¼ncelle (Sessizce)
        window.history.replaceState({}, '', url);
    }

    function shareLink() {
        updateURL(); // Garantilemek iÃ§in gÃ¼ncelle
        const fullLink = window.location.href;
        
        navigator.clipboard.writeText(fullLink).then(() => {
            const toast = document.getElementById('toast');
            toast.classList.remove('opacity-0', '-translate-y-4');
            setTimeout(() => {
                toast.classList.add('opacity-0', '-translate-y-4');
            }, 2000);
        });
    }

    updateCounter();
</script>
</body>
</html>
