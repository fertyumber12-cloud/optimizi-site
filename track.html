<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Canlı Kayıp Takibi</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script>tailwind.config = { theme: { fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'], mono: ['"JetBrains Mono"', 'monospace'] } } }</script>
    <style>
        body { background-color: #0f172a; color: white; overflow: hidden; }
        .counter-shadow { text-shadow: 0 0 20px rgba(220, 38, 38, 0.6); }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-fast { animation: pulse-red 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-between p-6 relative">

    <div class="absolute inset-0 z-0 overflow-hidden pointer-events-none">
        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-[500px] h-[500px] bg-red-600 rounded-full blur-[120px] opacity-20"></div>
    </div>

    <div class="z-10 w-full max-w-md flex justify-between items-center opacity-80">
        <div>
            <h1 class="text-xl font-black tracking-tight text-white">Optimizi<span class="text-red-500">.Track</span></h1>
            <p id="clientName" class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-0.5">Yükleniyor...</p>
        </div>
        <div class="bg-slate-800/50 p-2 rounded-xl border border-white/10">
            <div class="flex items-center gap-2">
                <span class="relative flex h-2 w-2">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-500 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                </span>
                <span class="text-[10px] font-bold text-red-400 uppercase">CANLI BAĞLANTI</span>
            </div>
        </div>
    </div>

    <div class="z-10 w-full max-w-md flex-1 flex flex-col justify-center items-center text-center">
        
        <div class="mb-8 relative">
            <div class="absolute inset-0 bg-red-500 blur-[40px] opacity-10 rounded-full"></div>
            <i data-lucide="flame" class="w-16 h-16 text-red-500 mx-auto animate-pulse-fast relative z-10"></i>
        </div>

        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">TOPLAM OPERASYONEL KAYIP</p>
        
        <div class="relative">
            <div class="text-5xl sm:text-7xl font-mono font-bold text-white tracking-tighter counter-shadow tabular-nums" id="counter">
                0,0000
            </div>
            <div class="text-sm font-bold text-red-500 mt-2">TL</div>
        </div>

        <div class="mt-8 glass-panel py-3 px-6 rounded-full inline-flex items-center gap-3">
            <i data-lucide="gauge" class="w-4 h-4 text-slate-400"></i>
            <span id="speedDisplay" class="text-xs font-bold text-slate-300">Hesaplanıyor...</span>
        </div>

    </div>

    <div class="z-10 w-full max-w-md pb-6">
        <div class="glass-panel rounded-2xl p-4 flex items-center justify-between">
            <div>
                <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Başlangıç Tarihi</p>
                <p id="startDate" class="text-xs font-bold text-white">...</p>
            </div>
            <div class="text-right">
                <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Geçen Süre</p>
                <p id="elapsedTime" class="text-xs font-bold text-red-400 font-mono">00:00:00</p>
            </div>
        </div>
        
        <div class="mt-4 text-center">
            <p class="text-[10px] text-slate-600 font-medium">Bu veri Optimizi.App üzerinden ISO 12241 standardına göre anlık simüle edilmektedir.</p>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // URL Parametrelerini Çöz
        const params = new URLSearchParams(window.location.search);
        
        // 1. Temel Veriler
        const client = params.get('c') || 'Bilinmeyen Müşteri';
        const totalValue = parseFloat(params.get('v')) || 0; // Yıllık Toplam Tutar
        const workHours = parseFloat(params.get('wh')) || 8760; // Yıllık Çalışma Saati (Varsayılan: 7/24)
        const dateStr = params.get('d'); // Başlangıç Tarihi (YYYY-MM-DD-HH-MM)
        
        // 2. Kritik Hız Hesabı
        // Eğer QR kodun içinde hazır hesaplanmış 'bps' (saniyelik kayıp) varsa onu kullan.
        // Yoksa kendimiz hesaplayalım.
        let burnPerSecond = parseFloat(params.get('bps'));

        if (!burnPerSecond) {
            // bps parametresi yoksa eski usül hesapla ama WH parametresini dikkate al!
            // Formül: Toplam Yıllık Tutar / (Yıllık Çalışma Saati * 3600)
            const secondsInYear = workHours * 3600;
            burnPerSecond = totalValue / secondsInYear;
        }

        // Arayüzü Doldur
        document.getElementById('clientName').innerText = client;
        
        // Hız Göstergesi (Dakikalık Zarar)
        const burnPerMinute = burnPerSecond * 60;
        document.getElementById('speedDisplay').innerHTML = `Anlık Kayıp Hızı: <span class="text-white">${burnPerMinute.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} TL/dk</span>`;

        // Başlangıç Tarihini Ayarla
        let startMoment = new Date();
        if (dateStr) {
            const parts = dateStr.split('-'); // 2026-01-22-14-30
            if (parts.length >= 5) {
                startMoment = new Date(parts[0], parts[1]-1, parts[2], parts[3], parts[4]);
            }
        }
        
        document.getElementById('startDate').innerText = startMoment.toLocaleDateString('tr-TR', { 
            day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' 
        });

        // SAYAÇ MOTORU
        const counterEl = document.getElementById('counter');
        const elapsedEl = document.getElementById('elapsedTime');

        function updateCounter() {
            const now = new Date();
            const diffSeconds = (now - startMoment) / 1000;
            
            // Eğer tarih gelecekteyse (henüz başlamadıysa) 0 göster
            if (diffSeconds < 0) {
                counterEl.innerText = "0,0000";
                elapsedEl.innerText = "Başlamadı";
                requestAnimationFrame(updateCounter);
                return;
            }

            // Şu anki toplam zarar = Geçen Saniye * Saniyelik Zarar
            // NOT: Bu "Gerçek Zamanlı" simülasyondur. Tesis kapalıyken bile sayaç işler,
            // ama "Operasyonel Hız" ile işler. Müşteriye "Tesisin açık olduğu her saniye bu kadar kaybediyorsun" hissi verir.
            const currentLoss = diffSeconds * burnPerSecond;

            // Sayacı formatla
            counterEl.innerText = currentLoss.toLocaleString('tr-TR', {
                minimumFractionDigits: 4,
                maximumFractionDigits: 4
            });

            // Geçen süreyi formatla
            const d = Math.floor(diffSeconds / (3600*24));
            const h = Math.floor((diffSeconds % (3600*24)) / 3600);
            const m = Math.floor((diffSeconds % 3600) / 60);
            const s = Math.floor(diffSeconds % 60);
            
            elapsedEl.innerText = `${d}g ${h}sa ${m}dk ${s}sn`;

            requestAnimationFrame(updateCounter);
        }

        // Başlat
        requestAnimationFrame(updateCounter);

    </script>
</body>
</html>
