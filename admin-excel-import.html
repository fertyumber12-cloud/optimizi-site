<!doctype html>
<html lang="tr" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Import Paneli</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
        extend: { colors: { slate: { 850: '#151e2e', 900: '#0f172a' } } }
      }
    }
  </script>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen p-6">

  <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8 h-[90vh]">
      
      <div class="bg-slate-800/50 backdrop-blur-xl border border-slate-700/50 rounded-2xl p-8 flex flex-col">
          
          <div class="mb-6 pb-6 border-b border-slate-700 flex justify-between items-center">
              <div>
                  <h1 class="text-2xl font-bold text-white">Veri AktarÄ±m Merkezi</h1>
                  <p class="text-slate-400 text-sm">Master 2026.xlsx dosyasÄ±nÄ± veritabanÄ±na iÅŸler.</p>
              </div>
              <a href="dashboard.html" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded-lg transition">Ã‡Ä±kÄ±ÅŸ</a>
          </div>

          <div class="mb-6">
              <label class="block text-sm font-bold text-indigo-400 mb-2">1. AdÄ±m: Master Excel DosyasÄ±nÄ± SeÃ§</label>
              <input type="file" id="fileInput" accept=".xlsx, .xls" class="block w-full text-sm text-slate-400
                file:mr-4 file:py-2 file:px-4
                file:rounded-full file:border-0
                file:text-sm file:font-semibold
                file:bg-indigo-600 file:text-white
                hover:file:bg-indigo-500
                cursor-pointer bg-slate-900/50 rounded-lg border border-slate-600
              "/>
          </div>

          <div id="actionButtons" class="space-y-4 opacity-50 pointer-events-none transition-all">
              <p class="text-sm font-bold text-indigo-400 mb-2">2. AdÄ±m: Verileri Ä°Ã§eri Al</p>
              
              <div class="grid grid-cols-1 gap-3">
                  <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 flex justify-between items-center">
                      <div>
                          <h3 class="font-bold text-white text-sm">Parametreler & Malzemeler</h3>
                          <p class="text-xs text-slate-500">'PARAMETRELER' sekmesini okur.</p>
                      </div>
                      <button onclick="processParameters()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded-lg transition">Aktar</button>
                  </div>

                  <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 flex justify-between items-center">
                      <div>
                          <h3 class="font-bold text-white text-sm">ÃœrÃ¼n ReÃ§eteleri</h3>
                          <p class="text-xs text-slate-500">'ÃœRÃœN DETAY' sekmesini okur.</p>
                      </div>
                      <button onclick="processRecipes()" class="px-4 py-2 bg-green-600 hover:bg-green-500 text-white text-xs font-bold rounded-lg transition">Aktar</button>
                  </div>
              </div>
          </div>

          <div class="mt-auto pt-6">
              <div class="text-xs text-slate-500 mb-1">Ä°ÅŸlem Durumu</div>
              <div class="w-full bg-slate-900 rounded-full h-2.5">
                  <div id="progressBar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
              </div>
          </div>
      </div>

      <div class="bg-black/80 border border-slate-700/50 rounded-2xl p-6 font-mono text-xs overflow-hidden flex flex-col shadow-2xl">
          <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-2">
              <span class="text-green-400 font-bold">TERMINAL > SYSTEM LOG</span>
              <button onclick="clearLog()" class="text-slate-500 hover:text-white">Temizle</button>
          </div>
          <div id="consoleOutput" class="flex-1 overflow-y-auto space-y-2 text-slate-300 pr-2">
              <div class="text-indigo-400">> Sistem hazÄ±r. Dosya bekleniyor...</div>
          </div>
      </div>

  </div>

  <script>
    // --- SUPABASE AYARLARI ---
    // NOT: Buraya kendi URL ve KEY'ini yazmalÄ±sÄ±n. EÄŸer SQL'i Ã§alÄ±ÅŸtÄ±rmadÄ±ysan hata alÄ±rsÄ±n.
    const SUPABASE_URL = 'https://gktvludkrsxnpigydqml.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdHZsdWRrcnN4bnBpZ3lkcW1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTI5OTQsImV4cCI6MjA4NjEyODk5NH0.GE9KbO7dx_W7BYihAzvJl744R317xEA8Ars98UW-VWo';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let WORKBOOK = null;

    // --- DOSYA SEÃ‡ME OLAYI ---
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        log(`Dosya seÃ§ildi: ${file.name} (${(file.size/1024).toFixed(1)} KB)`, 'info');
        log("Dosya okunuyor...", 'warn');

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                WORKBOOK = XLSX.read(data, {type: 'array'});
                
                log("âœ… Dosya baÅŸarÄ±yla okundu!", 'success');
                log(`Bulunan Sekmeler: ${WORKBOOK.SheetNames.join(', ')}`, 'info');
                
                // ButonlarÄ± Aktif Et
                const actionArea = document.getElementById('actionButtons');
                actionArea.classList.remove('opacity-50', 'pointer-events-none');
                
            } catch (err) {
                log("âŒ Dosya okuma hatasÄ±: " + err.message, 'error');
            }
        };
        reader.readAsArrayBuffer(file);
    });

    // --- Ä°ÅLEM 1: PARAMETRELER VE MALZEMELER ---
    async function processParameters() {
        if (!WORKBOOK) return log("Ã–nce dosya yÃ¼kleyin!", 'error');
        
        const sheetName = WORKBOOK.SheetNames.find(s => s.toUpperCase().includes('PARAM'));
        if (!sheetName) return log("âŒ 'PARAMETRELER' sekmesi bulunamadÄ±!", 'error');

        log(`'${sheetName}' sekmesi analiz ediliyor...`, 'warn');
        const sheet = WORKBOOK.Sheets[sheetName];
        const data = XLSX.utils.sheet_to_json(sheet, {header: 1}); // SatÄ±r satÄ±r oku

        // 1. Malzeme Listesini Bul
        let startRow = -1;
        for (let i = 0; i < data.length; i++) {
            // Excel'deki baÅŸlÄ±ÄŸÄ± arÄ±yoruz: "MALZEME LÄ°STESÄ°"
            if (data[i] && data[i].some(cell => cell && cell.toString().includes('MALZEME LÄ°STESÄ°'))) {
                startRow = i + 2; // BaÅŸlÄ±k + Header satÄ±rÄ±nÄ± atla
                log(`ğŸ“ 'MALZEME LÄ°STESÄ°' satÄ±r ${i+1}'de bulundu. Okuma baÅŸlÄ±yor...`, 'success');
                break;
            }
        }

        if (startRow === -1) return log("âŒ 'MALZEME LÄ°STESÄ°' baÅŸlÄ±ÄŸÄ± bulunamadÄ±. Excel formatÄ±nÄ± kontrol edin.", 'error');

        let materials = [];
        // SatÄ±rlarÄ± dÃ¶nmeye baÅŸla
        for (let i = startRow; i < data.length; i++) {
            const row = data[i];
            if (!row || !row[2]) continue; // 3. SÃ¼tun (C) Malzeme AdÄ± boÅŸsa geÃ§

            // Excel'deki SÃ¼tun YapÄ±na GÃ¶re (A=0, B=1, C=2...)
            // A: TÃ¼r, C: Malzeme AdÄ±, D: Birim, E: Fiyat, F: DÃ¶viz
            materials.push({
                category: row[0] || 'Genel',
                name: row[2],
                unit: row[3] || 'ad',
                price: parseFloat(row[4]) || 0,
                currency: row[5] || 'EUR'
            });
        }

        log(`ğŸ“¦ ${materials.length} adet malzeme tespit edildi. VeritabanÄ±na yazÄ±lÄ±yor...`, 'info');
        updateProgress(50);

        // Supabase'e Yaz (Toplu)
        const { error } = await supabase.from('materials').insert(materials); // Varsa ekler

        if (error) {
            log("âŒ VeritabanÄ± HatasÄ±: " + error.message, 'error');
            log("Ä°PUCU: 'materials' tablosunu Supabase'de oluÅŸturdun mu?", 'warn');
        } else {
            log("âœ… TÃ¼m malzemeler veritabanÄ±na baÅŸarÄ±yla yÃ¼klendi!", 'success');
            updateProgress(100);
        }
    }

    // --- Ä°ÅLEM 2: ÃœRÃœN REÃ‡ETELERÄ° ---
    async function processRecipes() {
        if (!WORKBOOK) return log("Ã–nce dosya yÃ¼kleyin!", 'error');
        
        const sheetName = WORKBOOK.SheetNames.find(s => s.toUpperCase().includes('ÃœRÃœN') || s.toUpperCase().includes('DETAY'));
        if (!sheetName) return log("âŒ 'ÃœRÃœN DETAY' sekmesi bulunamadÄ±!", 'error');

        log(`'${sheetName}' sekmesi analiz ediliyor...`, 'warn');
        const sheet = WORKBOOK.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(sheet); // HeaderlarÄ± otomatik al

        log(`ğŸ“„ ${jsonData.length} satÄ±r veri okundu.`, 'info');

        let recipes = [];
        let skipped = 0;

        jsonData.forEach(row => {
            // Excel baÅŸlÄ±klarÄ±na gÃ¶re eÅŸleÅŸtirme (Excelindeki baÅŸlÄ±klar tam bÃ¶yle olmalÄ±)
            // 'AÃ§Ä±klama', 'DN', 'GÃ¶vde KumaÅŸ', vb.
            if (row['AÃ§Ä±klama'] && row['DN']) {
                recipes.push({
                    valve_type: row['AÃ§Ä±klama'],
                    dn_size: parseInt(row['DN']),
                    insulation_thickness: parseInt(row['Ä°zolasyon KalÄ±nlÄ±ÄŸÄ±']) || 50,
                    surface_area_body: parseFloat(row['GÃ¶vde KumaÅŸ']) || 0,
                    difficulty_factor: parseFloat(row['Zorluk KatsayÄ±sÄ± (STD)']) || 1
                });
            } else {
                skipped++;
            }
        });

        log(`âš™ï¸ ${recipes.length} geÃ§erli reÃ§ete oluÅŸturuldu. (${skipped} boÅŸ satÄ±r atlandÄ±)`, 'info');
        updateProgress(50);

        // Supabase'e Yaz
        // onConflict: aynÄ± vana/dn varsa gÃ¼ncelle demek iÃ§in
        const { error } = await supabase.from('product_recipes').upsert(recipes, { onConflict: 'valve_type, dn_size, insulation_thickness' });

        if (error) {
            log("âŒ VeritabanÄ± HatasÄ±: " + error.message, 'error');
        } else {
            log("âœ… ÃœrÃ¼n reÃ§eteleri sisteme yÃ¼klendi!", 'success');
            updateProgress(100);
        }
    }

    // --- YARDIMCI FONKSÄ°YONLAR ---
    function log(msg, type='default') {
        const output = document.getElementById('consoleOutput');
        const div = document.createElement('div');
        div.className = "border-l-2 pl-2 text-[11px] font-mono mb-1 " + 
            (type === 'error' ? 'border-red-500 text-red-400' : 
             type === 'success' ? 'border-green-500 text-green-400' : 
             type === 'warn' ? 'border-yellow-500 text-yellow-300' : 'border-slate-600 text-slate-300');
        
        const time = new Date().toLocaleTimeString();
        div.innerHTML = `<span class="opacity-50">[${time}]</span> ${msg}`;
        output.appendChild(div);
        output.scrollTop = output.scrollHeight;
    }

    function updateProgress(percent) {
        document.getElementById('progressBar').style.width = percent + '%';
    }

    function clearLog() {
        document.getElementById('consoleOutput').innerHTML = '<div class="text-indigo-400">> Temizlendi.</div>';
    }

    lucide.createIcons();
  </script>
</body>
</html>
