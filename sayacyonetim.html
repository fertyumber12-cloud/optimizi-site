<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimizi Sayaç Yönetim Paneli</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="icon" type="image/png" sizes="192x192" href="/favicon.png">
    <script>
        tailwind.config = {
            theme: {
                fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                extend: {
                    colors: {
                        soft: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 800: '#1e293b' },
                        brand: { 500: '#ef4444', 600: '#dc2626' } // Optimizi Kırmızısı
                    },
                    boxShadow: { 'soft': '0 20px 40px -15px rgba(0, 0, 0, 0.05)' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; color: #334155; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); border-radius: 24px; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.05); border: 1px solid #fff; }
        .input-soft { background: #fff; border: 1px solid #e2e8f0; transition: all 0.2s; border-radius: 12px; }
        .input-soft:focus { border-color: #ef4444; outline: none; box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.05); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-6">

    <div class="glass-panel w-full max-w-2xl p-8 relative overflow-hidden">
        
        <div class="flex items-center justify-between mb-8 pb-6 border-b border-slate-100">
            <div>
                <h1 class="text-2xl font-black text-slate-800 tracking-tight">Optimizi<span class="text-brand-600">.Yönetim</span></h1>
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1">Sayaç Yönetim Paneli</p>
            </div>
            <div class="bg-red-50 p-3 rounded-2xl"><i data-lucide="settings-2" class="w-6 h-6 text-brand-600"></i></div>
        </div>

        <div class="space-y-5">
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Müşteri</label>
                    <input type="text" id="client" class="input-soft w-full p-3 text-sm font-bold text-slate-800" placeholder="Örn: ABC Tesisleri">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Rapor No</label>
                    <input type="text" id="reportNo" value="LSS-001" class="input-soft w-full p-3 text-sm font-bold text-slate-800">
                </div>
            </div>

            <div class="bg-gradient-to-br from-slate-50 to-white rounded-2xl p-6 border border-slate-100 relative group focus-within:border-brand-500/30 transition-all">
                <div class="absolute right-0 top-0 p-5 opacity-5"><i data-lucide="coins" class="w-16 h-16 text-brand-600"></i></div>
                
                <label class="text-[10px] font-bold text-brand-600 uppercase flex items-center gap-1 mb-1">
                    <i data-lucide="trending-down" class="w-3 h-3"></i> Toplam Yıllık Kayıp (TL)
                </label>
                
                <div class="relative z-10">
                    <input type="text" id="totalValue" oninput="calculate()" class="w-full text-3xl font-black text-slate-800 bg-transparent border-none p-0 outline-none placeholder-slate-300" placeholder="0">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-3 rounded-xl border border-slate-200">
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Yıllık Çalışma (Saat)</label>
                    <input type="number" id="workHours" oninput="calculate()" value="4800" class="w-full font-bold text-slate-700 outline-none border-none p-0 bg-transparent text-lg">
                    <p class="text-[9px] text-slate-400 mt-1">*Kota dolunca sayaç durur</p>
                </div>
                <div class="bg-white p-3 rounded-xl border border-slate-200">
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Enerji Birim Fiyat</label>
                    <input type="number" id="unitPrice" placeholder="0.00" step="0.01" class="w-full font-bold text-slate-700 outline-none border-none p-0 bg-transparent text-lg">
                </div>
            </div>

            <div id="previewBox" class="hidden flex items-center justify-between p-4 bg-brand-600/5 rounded-xl border border-brand-600/10 transition-all">
                <div>
                    <p class="text-[10px] font-bold text-brand-600 uppercase">ANLIK KAYIP HIZI</p>
                    <p class="text-lg font-black text-brand-600"><span id="minLoss">0.00</span> TL / Dakika</p>
                </div>
                <i data-lucide="activity" class="w-5 h-5 text-brand-600"></i>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Yakıt Tipi</label>
                    <select id="fuel" onchange="toggleManual()" class="input-soft w-full p-3 text-sm font-bold text-slate-700">
                        <option value="gas">Doğalgaz (m³)</option>
                        <option value="elec">Elektrik (kWh)</option>
                        <option value="lng">LNG (kg)</option>
                        <option value="fueloil">Fuel Oil (kg)</option>
                        <option value="coal_imp">İthal Kömür</option>
                        <option value="coal_loc">Yerli Kömür</option>
                        <option value="manual">Özel / Manuel</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Başlangıç Tarihi</label>
                    <input type="datetime-local" id="startDate" class="input-soft w-full p-2.5 text-xs font-bold text-slate-700">
                </div>
            </div>

            <div id="manualArea" class="hidden bg-slate-50 p-4 rounded-xl border border-slate-200">
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Özel Yakıt Adı</label>
                <input type="text" id="customFuel" class="input-soft w-full p-2 text-sm font-bold" placeholder="Örn: Paçal Kömür">
            </div>

            <button onclick="createSimulation()" id="createBtn" class="w-full bg-slate-900 hover:bg-brand-600 text-white p-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-brand-600/30 transition-all transform active:scale-[0.98] flex items-center justify-center gap-2 mt-4">
                <i data-lucide="qr-code"></i> Simülasyonu Başlat
            </button>

            <div id="resultCard" class="hidden bg-white p-6 rounded-2xl border border-slate-100 text-center shadow-soft mt-6">
                <p class="text-xs font-bold text-slate-400 uppercase mb-4">Takip Sistemi Hazır</p>
                
                <div id="qrcode" class="flex justify-center mb-4 p-2"></div>
                
                <p class="text-[10px] text-slate-400 mb-2">Bu kod, yıllık çalışma kotası dolana kadar çalışacak sayacı açar.</p>
                <code id="linkText" class="text-[9px] bg-slate-50 p-2 rounded block mb-4 break-all font-mono text-slate-500 select-all">...</code>
                
                <a id="dlBtn" href="#" download="optimizi_qr.png" class="inline-flex items-center gap-2 bg-slate-100 text-slate-700 px-5 py-2.5 rounded-full text-xs font-bold hover:bg-slate-200 transition">
                    <i data-lucide="download" class="w-4 h-4"></i> QR İndir
                </a>
            </div>

        </div>
    </div>

    <script>
        lucide.createIcons();

        // SUPABASE BAĞLANTISI
        const SUPABASE_URL = 'https://gktvludkrsxnpigydqml.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdHZsdWRrcnN4bnBpZ3lkcW1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTI5OTQsImV4cCI6MjA4NjEyODk5NH0.GE9KbO7dx_W7BYihAzvJl744R317xEA8Ars98UW-VWo';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Başlangıç Ayarları
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('startDate').value = now.toISOString().slice(0,16);

        function toggleManual() {
            const val = document.getElementById('fuel').value;
            const area = document.getElementById('manualArea');
            if(val === 'manual') area.classList.remove('hidden');
            else area.classList.add('hidden');
        }

        // Dakikalık Kayıp Hesapla (Otomatik)
        function calculate() {
            let val = document.getElementById('totalValue').value.replace(/\./g, '').replace(',', '.');
            let hours = document.getElementById('workHours').value;
            
            if(val > 0 && hours > 0) {
                let minVal = val / (hours * 60);
                document.getElementById('minLoss').innerText = minVal.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                document.getElementById('previewBox').classList.remove('hidden');
            }
        }

        async function createSimulation() {
            const btn = document.getElementById('createBtn');
            const client = document.getElementById('client').value.trim();
            const reportNo = document.getElementById('reportNo').value.trim();
            let totalVal = document.getElementById('totalValue').value.replace(/\./g, '').replace(',', '.');
            const workHours = document.getElementById('workHours').value;
            const unitPrice = document.getElementById('unitPrice').value;
            const fuel = document.getElementById('fuel').value;
            const customFuel = document.getElementById('customFuel').value;
            const startDate = document.getElementById('startDate').value;

            if(!client || !totalVal || !workHours) { alert("Lütfen ana bilgileri eksiksiz girin."); return; }

            // Buton Animasyonu
            const oldText = btn.innerHTML;
            btn.innerHTML = '⏳ Kaydediliyor...';
            btn.disabled = true;

            try {
                // 1. Veritabanına Yaz
                const { data, error } = await supabase
                    .from('simulations')
                    .insert([{
                        client_name: client,
                        report_no: reportNo,
                        total_annual_loss: parseFloat(totalVal),
                        work_hours: parseFloat(workHours),
                        unit_price: unitPrice ? parseFloat(unitPrice) : 0,
                        fuel_type: fuel,
                        fuel_label: (fuel === 'manual') ? customFuel : null,
                        start_date: new Date(startDate).toISOString()
                    }])
                    .select()
                    .single();

                if (error) throw error;

                // 2. QR Kod Üret (Görünürlüğü Açtıktan Sonra)
                const finalUrl = `https://optimizi.app/anliksayac.html?id=${data.id}`;
                
                const resultCard = document.getElementById('resultCard');
                resultCard.classList.remove('hidden'); // Önce görünür yap!
                
                const qrContainer = document.getElementById('qrcode');
                qrContainer.innerHTML = ''; // Temizle

                new QRCode(qrContainer, {
                    text: finalUrl,
                    width: 180,
                    height: 180,
                    colorDark : "#0f172a",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.M
                });

                document.getElementById('linkText').innerText = finalUrl;
                
                setTimeout(() => {
                    const img = qrContainer.querySelector("img");
                    if(img) document.getElementById('dlBtn').href = img.src;
                }, 300);

                btn.innerHTML = '✅ Oluşturuldu';
                
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = oldText;
                }, 2000);

            } catch(err) {
                alert('Hata: ' + err.message);
                btn.disabled = false;
                btn.innerHTML = oldText;
            }
        }
    </script>
</body>
</html>
