<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sayaç Yönetim Paneli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        tailwind.config = {
            theme: {
                fontFamily: { sans: ['"Inter"', 'sans-serif'] },
                extend: { colors: { brand: { 500: '#3b82f6', 600: '#2563eb', 900: '#1e3a8a' } } }
            }
        }
    </script>
    <style>
        body { 
            background-color: #f8fafc;
            background-image: linear-gradient(#e2e8f0 1px, transparent 1px), linear-gradient(90deg, #e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 text-slate-700">

    <div class="glass w-full max-w-4xl rounded-3xl p-8 relative shadow-2xl">
        
        <div class="flex justify-between items-center mb-6 border-b border-slate-200 pb-4">
            <div>
                <h1 class="text-2xl font-bold text-slate-900">Sayaç Kurulumu</h1>
                <p class="text-sm text-slate-500">Otomatik Hafta Hizalamalı Sistem</p>
            </div>
            <div class="bg-blue-50 p-2 rounded-lg"><i data-lucide="calendar-clock" class="text-blue-600"></i></div>
        </div>

        <div id="errorBox" class="hidden bg-red-50 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-r" role="alert">
            <p class="font-bold">Hata Oluştu</p>
            <p id="errorText" class="text-sm">...</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase">Müşteri Adı</label>
                    <input type="text" id="client" class="w-full p-3 bg-white border border-slate-200 rounded-xl font-bold focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Firma Adı">
                </div>
                
                <div class="bg-slate-900 p-4 rounded-xl text-white">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Yıllık Toplam Kayıp (TL)</label>
                    <input type="text" id="totalValue" class="w-full bg-transparent text-3xl font-black outline-none placeholder-slate-600" placeholder="0">
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Yakıt</label>
                        <select id="fuel" class="w-full p-2 bg-white border border-slate-200 rounded-lg text-sm font-bold">
                            <option value="gas">Doğalgaz</option>
                            <option value="elec">Elektrik</option>
                            <option value="lng">LNG</option>
                            <option value="manual">Diğer</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Yıllık İş Saati</label>
                        <input type="number" id="annualHoursDisplay" readonly class="w-full p-2 bg-slate-100 border border-slate-200 rounded-lg text-sm font-bold text-slate-500 cursor-not-allowed" value="0">
                    </div>
                </div>
            </div>

            <div class="space-y-4 bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
                
                <div class="flex items-center gap-2 mb-2">
                    <span class="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded">1</span>
                    <h3 class="font-bold text-sm">Çalışma Düzeni</h3>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Haftalık Toplam Saat</label>
                        <input type="number" id="weeklyHours" value="45" oninput="calculatePlan()" class="w-full p-2 border-2 border-blue-100 rounded-lg font-bold text-blue-900 focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Mesai Başlangıcı</label>
                        <input type="time" id="startTime" value="08:00" onchange="calculatePlan()" class="w-full p-2 border border-slate-200 rounded-lg font-bold text-slate-700">
                    </div>
                </div>

                <div class="mt-2">
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-2">Aktif Günler</label>
                    <div class="flex justify-between gap-1">
                        <label class="cursor-pointer flex flex-col items-center gap-1"><input type="checkbox" id="d1" checked onchange="calculatePlan()" class="w-4 h-4 accent-blue-600"><span class="text-[10px] font-bold">Pzt</span></label>
                        <label class="cursor-pointer flex flex-col items-center gap-1"><input type="checkbox" id="d2" checked onchange="calculatePlan()" class="w-4 h-4 accent-blue-600"><span class="text-[10px] font-bold">Sal</span></label>
                        <label class="cursor-pointer flex flex-col items-center gap-1"><input type="checkbox" id="d3" checked onchange="calculatePlan()" class="w-4 h-4 accent-blue-600"><span class="text-[10px] font-bold">Çar</span></label>
                        <label class="cursor-pointer flex flex-col items-center gap-1"><input type="checkbox" id="d4" checked onchange="calculatePlan()" class="w-4 h-4 accent-blue-600"><span class="text-[10px] font-bold">Per</span></label>
                        <label class="cursor-pointer flex flex-col items-center gap-1"><input type="checkbox" id="d5" checked onchange="calculatePlan()" class="w-4 h-4 accent-blue-600"><span class="text-[10px] font-bold">Cum</span></label>
                        <label class="cursor-pointer flex flex-col items-center gap-1"><input type="checkbox" id="d6" checked onchange="calculatePlan()" class="w-4 h-4 accent-blue-600"><span class="text-[10px] font-bold">Cmt</span></label>
                        <label class="cursor-pointer flex flex-col items-center gap-1"><input type="checkbox" id="d7" onchange="calculatePlan()" class="w-4 h-4 accent-red-500"><span class="text-[10px] font-bold text-red-500">Paz</span></label>
                    </div>
                </div>

                <div class="bg-blue-50 p-3 rounded-lg mt-2 text-xs text-blue-800">
                    <p class="font-bold flex items-center gap-1"><i data-lucide="info" class="w-3 h-3"></i> Otomatik Hesaplama:</p>
                    <p id="calcResult" class="mt-1">Haftada 5 gün x 9 saat = 08:00 - 17:00 arası</p>
                    <p class="mt-1 text-[10px] text-blue-600">*Sayaç bu Pazartesi 00:00'dan itibaren başlatılacak.</p>
                </div>

            </div>
        </div>

        <div class="mt-8">
            <button onclick="createSimulation()" id="mainBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-xl font-bold shadow-lg shadow-blue-200 transition-all flex items-center justify-center gap-2">
                <i data-lucide="qr-code"></i> Simülasyonu Başlat
            </button>

            <div id="resultArea" class="hidden mt-6 bg-white p-6 rounded-2xl border border-slate-200 text-center animate-fade-in">
                <div id="qrcode" class="flex justify-center mb-4"></div>
                <p class="text-xs text-slate-500 mb-2 font-mono" id="linkText"></p>
                <a id="dlBtn" href="#" download="qr.png" class="text-blue-600 text-xs font-bold underline">QR İndir</a>
            </div>
        </div>

    </div>

    <script>
        lucide.createIcons();

        // --- SUPABASE AYARLARI ---
        const SUPABASE_URL = 'https://gktvludkrsxnpigydqml.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdHZsdWRrcnN4bnBpZ3lkcW1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTI5OTQsImV4cCI6MjA4NjEyODk5NH0.GE9KbO7dx_W7BYihAzvJl744R317xEA8Ars98UW-VWo';
        let supabase;

        try {
            supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch(e) {
            showError("Supabase bağlantısı kurulamadı. Lütfen internet bağlantınızı kontrol edin.");
        }

        // --- MANTIK FONKSİYONLARI ---

        // 1. Bu haftanın Pazartesi gününü bul (Saat 00:00)
        function getMonday(d) {
            d = new Date(d);
            var day = d.getDay(),
                diff = d.getDate() - day + (day == 0 ? -6 : 1); // Pazar günü için düzeltme
            var monday = new Date(d.setDate(diff));
            monday.setHours(0,0,0,0);
            return monday;
        }

        // 2. Planı Hesapla ve Arayüzü Güncelle
        function calculatePlan() {
            // Seçili gün sayısı
            let activeDays = 0;
            for(let i=1; i<=7; i++) {
                if(document.getElementById('d'+i).checked) activeDays++;
            }

            const weeklyHours = parseFloat(document.getElementById('weeklyHours').value) || 0;
            const startTime = document.getElementById('startTime').value;

            if (activeDays === 0 || weeklyHours === 0) {
                document.getElementById('calcResult').innerText = "Lütfen gün ve saat giriniz.";
                return null;
            }

            // Günlük ortalama saat
            const dailyHours = weeklyHours / activeDays; // Örn: 45 / 5 = 9
            
            // Bitiş saatini bul: Start + DailyHours
            const [sh, sm] = startTime.split(':').map(Number);
            const totalStartMin = sh * 60 + sm;
            const totalEndMin = totalStartMin + (dailyHours * 60);
            
            const eh = Math.floor(totalEndMin / 60) % 24;
            const em = Math.floor(totalEndMin % 60);
            const endTimeStr = `${String(eh).padStart(2,'0')}:${String(em).padStart(2,'0')}`;

            // Yıllık Tahmini
            const annual = Math.round(weeklyHours * 52);
            document.getElementById('annualHoursDisplay').value = annual;

            document.getElementById('calcResult').innerHTML = `
                <span class="text-blue-600 font-bold">${activeDays} Gün</span> çalışılıyor. 
                Günlük <span class="text-blue-600 font-bold">${dailyHours.toFixed(1)} Saat</span>.<br>
                Mesai: <span class="font-mono bg-white px-1 rounded">${startTime}</span> - 
                <span class="font-mono bg-white px-1 rounded">${endTimeStr}</span>
            `;

            return { activeDays, dailyHours, startTime, endTimeStr, annual };
        }

        // 3. Simülasyon Oluştur (Kayıt + QR)
        async function createSimulation() {
            const btn = document.getElementById('mainBtn');
            const errorBox = document.getElementById('errorBox');
            errorBox.classList.add('hidden'); // Hatayı temizle

            const plan = calculatePlan();
            const client = document.getElementById('client').value;
            let totalVal = document.getElementById('totalValue').value.replace(/\./g, '').replace(',', '.');
            totalVal = parseFloat(totalVal);

            if (!plan || !client || !totalVal) {
                showError("Lütfen Müşteri Adı, Tutar ve Çalışma Saatlerini eksiksiz girin.");
                return;
            }

            btn.innerText = "⏳ Kaydediliyor...";
            btn.disabled = true;

            try {
                // A. Vardiya JSON'unu oluştur (Otomatik dağıtılmış)
                const shifts = [];
                for(let i=1; i<=7; i++) {
                    if(document.getElementById('d'+i).checked) {
                        shifts.push({
                            dayIndex: i, // 1=Pzt...
                            start: plan.startTime,
                            end: plan.endTimeStr
                        });
                    }
                }

                // B. Başlangıç Tarihini PAZARTESİ'ye sabitle
                const startDate = getMonday(new Date());

                // C. Veritabanına Yaz
                const { data, error } = await supabase
                    .from('simulations')
                    .insert([{
                        client_name: client,
                        total_annual_loss: totalVal,
                        work_hours: plan.annual, // 45 * 52
                        unit_price: 1.0, // Varsayılan
                        fuel_type: document.getElementById('fuel').value,
                        start_date: startDate.toISOString(),
                        shift_config: shifts
                    }])
                    .select()
                    .single();

                if (error) throw error;

                // D. QR Kod Üret
                const finalUrl = `https://optimizi.app/anliksayac.html?id=${data.id}`;
                
                const qrContainer = document.getElementById('qrcode');
                qrContainer.innerHTML = ''; // Temizle
                
                new QRCode(qrContainer, {
                    text: finalUrl,
                    width: 200,
                    height: 200,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.M
                });

                document.getElementById('linkText').innerText = finalUrl;
                document.getElementById('resultArea').classList.remove('hidden');
                
                // İndirme linkini güncelle
                setTimeout(() => {
                    const img = qrContainer.querySelector("img");
                    if (img) document.getElementById('dlBtn').href = img.src;
                }, 500);

                btn.innerText = "✅ Başarılı! Yeni Oluştur";
                setTimeout(() => { 
                    btn.disabled = false; 
                    btn.innerHTML = '<i data-lucide="qr-code"></i> Simülasyonu Başlat';
                    lucide.createIcons();
                }, 3000);

            } catch (err) {
                console.error(err);
                showError(err.message || "Bilinmeyen bir hata oluştu.");
                btn.innerText = "Tekrar Dene";
                btn.disabled = false;
            }
        }

        function showError(msg) {
            const box = document.getElementById('errorBox');
            document.getElementById('errorText').innerText = msg;
            box.classList.remove('hidden');
        }

        // Başlangıçta hesapla
        calculatePlan();
    </script>
</body>
</html>
