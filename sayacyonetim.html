<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Sayaç Yönetimi</title>
<link rel="icon" href="favicon.png" type="image/png">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" sizes="192x192" href="/favicon.png">
<script>
    tailwind.config = { 
        theme: { 
            fontFamily: { sans: ['"Inter"', 'sans-serif'], mono: ['"JetBrains Mono"', 'monospace'] },
            extend: {
                colors: {
                    slate: { 850: '#1e293b', 900: '#0f172a', 950: '#020617' },
                    brand: { 400: '#34d399', 500: '#10b981', 600: '#059669' } // Optimizi Yeşili
                }
            }
        } 
    }
</script>

<style>
    body { 
        background-color: #020617; 
        color: #e2e8f0;
        background-image: 
            radial-gradient(circle at 50% 0%, #1e293b 0%, transparent 70%),
            linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px), 
            linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
        background-size: 100% 100%, 40px 40px, 40px 40px;
        min-height: 100vh;
    }
    
    /* Modern Glass Card */
    .glass-panel {
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    /* Input Stilleri */
    .input-dark {
        background: rgba(30, 41, 59, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.2s ease;
        color: white;
    }
    .input-dark:focus {
        background: rgba(30, 41, 59, 0.8);
        border-color: #10b981;
        outline: none;
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
    }
    
    /* Animasyonlar */
    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-slide-up { animation: slideUp 0.4s ease-out forwards; }
</style>
</head>
<body class="flex items-center justify-center p-4 sm:p-8">

    <div class="w-full max-w-2xl animate-slide-up">
        
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center p-3 mb-3 bg-slate-800/50 rounded-2xl border border-slate-700 shadow-lg">
                <i data-lucide="activity" class="w-6 h-6 text-brand-500"></i>
            </div>
            <h1 class="text-2xl font-bold tracking-tight text-white">Optimizi<span class="text-brand-500">.Yönetim</span></h1>
            <p class="text-xs font-medium text-slate-500 uppercase tracking-widest mt-1">Kayıp Simülasyonu Oluşturucu</p>
        </div>

        <div class="glass-panel rounded-3xl p-6 sm:p-8 relative overflow-hidden">
            
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-brand-500 to-transparent opacity-50"></div>

            <form id="simulationForm" class="space-y-5">
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 block ml-1">Müşteri Ünvanı</label>
                        <input type="text" id="clientName" required placeholder="Örn: ABC Tekstil A.Ş." 
                            class="input-dark w-full rounded-xl px-4 py-2.5 text-sm font-bold placeholder-slate-600">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 block ml-1">Rapor No</label>
                        <input type="text" id="reportNo" required placeholder="RPT-001" 
                            class="input-dark w-full rounded-xl px-4 py-2.5 text-sm font-bold placeholder-slate-600">
                    </div>
                </div>

                <div class="bg-slate-800/40 rounded-2xl p-5 border border-slate-700/50 group focus-within:border-brand-500/50 transition-colors">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="trending-down" class="w-4 h-4 text-brand-500"></i>
                        <label class="text-[10px] font-bold text-brand-400 uppercase tracking-wider">Toplam Yıllık Kayıp (TL)</label>
                    </div>
                    <div class="relative">
                        <input type="number" id="totalAnnualLoss" required step="0.01" min="0" placeholder="0"
                            class="w-full bg-transparent border-none p-0 text-3xl font-mono font-bold text-white placeholder-slate-700 focus:ring-0 outline-none">
                        <span class="absolute right-0 top-1/2 -translate-y-1/2 text-xs font-bold text-slate-500 bg-slate-800 px-2 py-1 rounded">TL/Yıl</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 block ml-1">Yıllık Kota (Saat)</label>
                        <div class="relative">
                            <i data-lucide="clock" class="absolute left-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-500"></i>
                            <input type="number" id="workHours" required placeholder="4800"
                                class="input-dark w-full rounded-xl pl-9 pr-3 py-2.5 text-sm font-bold">
                        </div>
                        <p class="text-[9px] text-slate-500 mt-1 ml-1">*Süre dolunca durur</p>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 block ml-1">Birim Fiyat</label>
                        <div class="relative">
                            <i data-lucide="coins" class="absolute left-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-500"></i>
                            <input type="number" id="unitPrice" required step="0.0001" placeholder="0.00"
                                class="input-dark w-full rounded-xl pl-9 pr-3 py-2.5 text-sm font-bold">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 block ml-1">Yakıt Tipi</label>
                        <select id="fuelType" required onchange="toggleManualFuel()" 
                            class="input-dark w-full rounded-xl px-3 py-2.5 text-xs font-bold cursor-pointer appearance-none">
                            <option value="gas">Doğalgaz</option>
                            <option value="elec">Elektrik</option>
                            <option value="lng">LNG</option>
                            <option value="fueloil">Fuel Oil</option>
                            <option value="coal">Kömür</option>
                            <option value="manual" class="text-brand-400">⚡ Manuel Giriş</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 block ml-1">Başlangıç</label>
                        <input type="datetime-local" id="startDate" required
                            class="input-dark w-full rounded-xl px-2 py-2.5 text-xs font-bold text-center">
                    </div>
                </div>

                <div id="manualFuelBox" class="hidden bg-slate-800/30 p-3 rounded-xl border border-dashed border-slate-600">
                    <label class="text-[9px] font-bold text-brand-400 uppercase mb-1 block">Özel Yakıt Adı</label>
                    <input type="text" id="fuelLabel" placeholder="Örn: Biyokütle" 
                        class="input-dark w-full rounded-lg px-3 py-1.5 text-xs font-bold">
                </div>

                <button type="submit" 
                    class="w-full bg-brand-600 hover:bg-brand-500 text-white p-4 rounded-xl font-bold text-sm shadow-lg shadow-brand-900/20 transition-all transform active:scale-[0.98] flex items-center justify-center gap-2 mt-2 group">
                    <i data-lucide="zap" class="w-4 h-4 fill-current group-hover:scale-110 transition"></i>
                    Simülasyonu Başlat
                </button>

            </form>
        </div>

        <div id="qrContainer" class="hidden mt-6 glass-panel rounded-3xl p-6 text-center animate-slide-up border-t-2 border-brand-500/50">
            <div class="inline-flex items-center justify-center w-12 h-12 bg-brand-500/10 rounded-full mb-3">
                <i data-lucide="check" class="w-6 h-6 text-brand-500"></i>
            </div>
            <h3 class="text-lg font-bold text-white mb-1">Hazır!</h3>
            <p class="text-xs text-slate-400 mb-4">Sayaç oluşturuldu ve çalışmaya başladı.</p>
            
            <div class="bg-white p-3 rounded-xl inline-block shadow-xl mb-4">
                <div id="qrcode"></div>
            </div>
            
            <div class="flex gap-2 justify-center">
                <a id="directLink" href="#" target="_blank" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white text-xs font-bold rounded-lg transition border border-slate-700">
                    Sayacı Aç
                </a>
                <button onclick="window.location.reload()" class="px-4 py-2 bg-transparent hover:bg-slate-800 text-slate-400 text-xs font-bold rounded-lg transition">
                    Yeni Oluştur
                </button>
            </div>
        </div>

    </div>

<script>
    // İkonları Yükle
    lucide.createIcons();

    // Supabase Ayarları
    const SUPABASE_URL = 'https://gktvludkrsxnpigydqml.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrdHZsdWRrcnN4bnBpZ3lkcW1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTI5OTQsImV4cCI6MjA4NjEyODk5NH0.GE9KbO7dx_W7BYihAzvJl744R317xEA8Ars98UW-VWo';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Tarih Ayarı (Bugün)
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('startDate').value = now.toISOString().slice(0, 16);
    
    function toggleManualFuel() {
        const fuelType = document.getElementById('fuelType').value;
        const manualBox = document.getElementById('manualFuelBox');
        if(fuelType === 'manual') manualBox.classList.remove('hidden');
        else manualBox.classList.add('hidden');
    }
    
    document.getElementById('simulationForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const btn = this.querySelector('button[type="submit"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="animate-spin" data-lucide="loader-2"></i> Kaydediliyor...';
        lucide.createIcons();
        btn.disabled = true;

        try {
            // Verileri Al
            const clientName = document.getElementById('clientName').value;
            const reportNo = document.getElementById('reportNo').value;
            const totalAnnualLoss = parseFloat(document.getElementById('totalAnnualLoss').value);
            const workHours = parseFloat(document.getElementById('workHours').value);
            const unitPrice = parseFloat(document.getElementById('unitPrice').value);
            const fuelType = document.getElementById('fuelType').value;
            const fuelLabel = document.getElementById('fuelLabel').value || null;
            const startDate = document.getElementById('startDate').value;
            
            // Supabase Kayıt
            const { data, error } = await supabase
                .from('simulations')
                .insert({
                    client_name: clientName,
                    report_no: reportNo,
                    total_annual_loss: totalAnnualLoss,
                    work_hours: workHours,
                    unit_price: unitPrice,
                    fuel_type: fuelType,
                    fuel_label: fuelLabel,
                    start_date: new Date(startDate).toISOString()
                })
                .select();
            
            if(error) throw error;
            
            // Başarılı
            const simulationId = data[0].id;
            const qrUrl = `https://optimizi.app/anliksayac.html?id=${simulationId}`;
            
            // QR Oluştur
            const qrDiv = document.getElementById('qrcode');
            qrDiv.innerHTML = '';
            
            // Konteynerı aç (Görünürlük önemli!)
            const container = document.getElementById('qrContainer');
            container.classList.remove('hidden');
            
            new QRCode(qrDiv, {
                text: qrUrl,
                width: 128,
                height: 128,
                colorDark: '#0f172a',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.M
            });
            
            document.getElementById('directLink').href = qrUrl;
            
            // Kaydır
            container.scrollIntoView({ behavior: 'smooth' });
            
            btn.innerHTML = '<i data-lucide="check"></i> Başarılı';
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
                lucide.createIcons();
            }, 2000);

        } catch(err) {
            console.error(err);
            alert('Hata: ' + err.message);
            btn.disabled = false;
            btn.innerHTML = originalText;
            lucide.createIcons();
        }
    });
</script>

</body>
</html>
